<?php
/*ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);*/
class Students_model extends CI_Model
{

    function __construct()
    {
        parent::__construct();
    }

    function get_state_details($state_id = '')
    {
        $where = " WHERE 1=1 ";

        if ($state_id != "") {
            $where .= " AND id='" . $state_id . "'";
        }

        $sql = "select id,name From states $where ";
        $query = $this->db->query($sql);

        return $query->result_array();
    }

    public function getExamStats()
    {
        $query = $this->db->query("
            SELECT 
                COUNT(sj.student_id) AS total_students,
                SUM(CASE WHEN sj.is_payment_done = 'Y' THEN 1 ELSE 0 END) AS payment_done_count,
                em.exam_name
            FROM su_jee_registration sj
			join student_meet_details as sm on sj.student_id=sm.id
            JOIN exam_master AS em ON sj.exam_no = em.exam_id
            WHERE sj.academic_year = '" . ACADEMIC_YEAR . "' 
            AND sj.exam_no IN (73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,104,105,106,107)
            GROUP BY em.exam_name
        ");

        return $query->result_array();
    }


    public function fetch_sujee_applications()
    {

        $query = $this->db->query("
			SELECT reg_no,sr.password,student_name,mobile1,em.exam_name,sr.exam_date,icr.ic_name,sm.event_code,um.roles_id,st.name AS statename,ct.name AS city,sm.utm_source,sm.email,sr.login_status,sr.is_payment_done as payment_status,sr.inserted_at as leadcreateddate,
			CASE 
        WHEN um.roles_id IN (4, 8) THEN 'IC'
        WHEN um.roles_id = 17 THEN 'CONSULTANT/FOU/COUNSELLING'
        WHEN um.roles_id = 33 THEN 'STAFF'
        WHEN um.roles_id = 2 THEN 'CC'
        ELSE 'others'
    END AS added_by_role
			FROM su_jee_registration sr
			JOIN
			student_meet_details AS sm ON sr.student_id=sm.id
			LEFT JOIN states AS st ON sm.state_id=st.id
			LEFT JOIN cities AS ct ON sm.city_id=ct.id
			JOIN exam_master AS em ON sr.exam_no=em.exam_id
			LEFT JOIN user_master AS um ON sr.inserted_by=um.um_id
			LEFT JOIN ic_registration AS icr ON um.ic_code=icr.ic_code
			WHERE sm.academic_year='" . ACADEMIC_YEAR . "'
			");

        return $query->result_array();
    }

    public function fetch_sujee_applications_source_wise()
    {
        $cdate = date('Y-m-d');
        $sql = "SELECT COUNT(utm_source) as tc,utm_source,SUM(CASE WHEN sr.is_payment_done = 'Y' THEN 1 ELSE 0 END) AS paid_count,
    SUM(CASE WHEN sr.is_payment_done IS NULL THEN 1 ELSE 0 END) AS not_paid_count,
	 SUM(CASE WHEN STR_TO_DATE(sr.inserted_at,'%Y-%m-%d') = '" . $cdate . "' THEN 1 ELSE 0 END) AS today_count,
	 SUM(CASE WHEN STR_TO_DATE(sr.inserted_at,'%Y-%m-%d') = '" . $cdate . "' and sr.is_payment_done='Y'  THEN 1 ELSE 0 END) AS today_paid		
			FROM su_jee_registration sr
			JOIN
			student_meet_details AS sm ON sr.student_id=sm.id
			LEFT JOIN states AS st ON sm.state_id=st.id
			LEFT JOIN cities AS ct ON sm.city_id=ct.id
			JOIN exam_master AS em ON sr.exam_no=em.exam_id
			LEFT JOIN user_master AS um ON sr.inserted_by=um.um_id
			LEFT JOIN ic_registration AS icr ON um.ic_code=icr.ic_code
			WHERE sm.academic_year='" . ACADEMIC_YEAR . "' AND sm.utm_source !=''
			GROUP BY utm_source";

        $query = $this->db->query($sql);

        return $query->result_array();
    }


    public function fetch_sujee_applications_role_wise()
    {
        $cdate = date('Y-m-d');
        $sql = "
			SELECT COUNT(sr.sujee_id) as tc,icr.ic_name,SUM(CASE WHEN sr.is_payment_done = 'Y' THEN 1 ELSE 0 END) AS paid_count,
          SUM(CASE WHEN sr.is_payment_done IS NULL THEN 1 ELSE 0 END) AS not_paid_count,
		 SUM(CASE WHEN STR_TO_DATE(sr.inserted_at,'%Y-%m-%d') = '" . $cdate . "' THEN 1 ELSE 0 END) AS today_count,
	      SUM(CASE WHEN STR_TO_DATE(sr.inserted_at,'%Y-%m-%d') = '" . $cdate . "' and sr.is_payment_done='Y'  THEN 1 ELSE 0 END) AS today_paid			
			FROM su_jee_registration sr
			JOIN
			student_meet_details AS sm ON sr.student_id=sm.id
			LEFT JOIN states AS st ON sm.state_id=st.id
			LEFT JOIN cities AS ct ON sm.city_id=ct.id
			JOIN exam_master AS em ON sr.exam_no=em.exam_id
			LEFT JOIN user_master AS um ON sr.inserted_by=um.um_id
			LEFT JOIN ic_registration AS icr ON um.ic_code=icr.ic_code
			WHERE sm.academic_year='" . ACADEMIC_YEAR . "' AND sm.utm_source ='' and sr.inserted_by!=''  and sr.inserted_by!=0
			GROUP BY icr.ic_name
			";

        $query = $this->db->query($sql);

        return $query->result_array();
    }




    // Get City Code for eventcode
    public function getCityCode($cityid)
    {


        $this->db->select('state_code');
        $this->db->from('cities');
        $this->db->where('id', $cityid);
        $this->db->where('status', 'Y');
        $result = $this->db->get();
        $st = $result->result_array();

        return $st[0]['city_code'];
    }

    function checkEventAvailable($id)
    {

        $this->db->select('*');
        $this->db->from('event_details');
        $this->db->where('event_code', $id);
        $result = $this->db->get();

        return $result->result_array();
    }

    // Add Event Details
    function addEventDetails($data)
    {
        //print_r($data);exit;
        $data['status'] = '0';
        $data['created_date'] = date('Y-m-d');
        $this->db->insert('event_details', $data);
        $insert_id = $this->db->insert_id();

        return $insert_id;
    }

    // add Inclusion
    function addSpeakerDetails($data, $event_id)
    {
        $count = count($data['spk_name']);

        for ($i = 0; $i < $count; $i++) {
            $spk_name = $data['spk_name'][$i];
            $contact_no = $data['contact_no'][$i];
            $cdate = date('Y-m-d');
            $c_by = $this->session->userdata('uid');
            $sql = "insert into event_spaker_details (event_id,spk_name,contact_no,status, created_by, created_date)values('$event_id','$spk_name','$contact_no','0', '$c_by', '$cdate')";
            //echo $sql;exit;
            $query = $this->db->query($sql);
        }
        $insert_id = $this->db->insert_id();
    }

    // add Inclusion
    function addInclisionDetails($data, $event_id)
    {
        $count = count($data['inc_name']);

        for ($i = 0; $i < $count; $i++) {
            $inc_name = $data['inc_name'][$i];
            $quantity = $data['quantity'][$i];
            $cdate = date('Y-m-d');
            $c_by = $this->session->userdata('uid');
            $sql = "insert into event_inclusion_details (event_id,name,quantity,status, created_by, created_date)values('$event_id','$inc_name','$quantity','0', '$c_by', '$cdate')";
            //echo $sql;
            $query = $this->db->query($sql);
        }
        $insert_id = $this->db->insert_id();

        return $insert_id;
    }

    // add Attendent
    //    function addAttendentDetails($data, $event_id) {
    //        $count = count($data['user_id']);
    //        //echo $count;
    //        for ($i = 0; $i < $count; $i++) {
    //            $user_id = $data['user_id'][$i];
    //            $cdate = date('Y-m-d');
    //            $c_by = $this->session->userdata('uid');
    //            $sql = "insert into event_attendent_details (event_id,user_id,status, created_by, created_date)values('$event_id','$user_id','0', '$c_by', '$cdate')";
    //            //echo $sql;
    //            $query = $this->db->query($sql);
    //        }
    //        $insert_id = $this->db->insert_id();
    //        return $insert_id;
    //    }
    function addAttendentDetails($data, $event_id)
    {

        $user_id = $data;
        $cdate = date('Y-m-d H:i:s');
        $c_by = $this->session->userdata('uid');
        $sql = "insert into event_attendent_details (event_id,user_id,status, created_by, created_date)values('$event_id','$user_id','0', '$c_by', '$cdate')";
        //echo $sql;
        $query = $this->db->query($sql);

        $insert_id = $this->db->insert_id();

        return $insert_id;
    }

    function addParticipantDetails($data, $event_id, $part_type_id)
    {

        $participant_id = $data;
        $cdate = date('Y-m-d H:i:s');
        $c_by = $this->session->userdata('uid');
        $sql = "insert into event_participant_details (event_id,part_type_id, participant_id, status, created_by, created_date)values('$event_id','$part_type_id', '$participant_id', '0', '$c_by', '$cdate')";
        //echo $sql;
        $query = $this->db->query($sql);

        $insert_id = $this->db->insert_id();

        return $insert_id;
    }

    function addParticipantDetails_old($data, $event_id, $part_type_id)
    {

        $count = count($data['participant_id']);
        //echo $count;
        for ($i = 0; $i < $count; $i++) {
            $participant_id = $data['participant_id'][$i];
            $cdate = date('Y-m-d');
            $c_by = $this->session->userdata('uid');
            $sql = "insert into event_participant_details (event_id,part_type_id, participant_id, status, created_by, created_date)values('$event_id','$part_type_id', '$participant_id', '0', '$c_by', '$cdate')";
            //echo $sql;
            $query = $this->db->query($sql);
        }
        $insert_id = $this->db->insert_id();

        return $insert_id;
    }

    //All IC 
    function get_ic_bytype($type = '', $ic_code = '')
    {

        $role_id = $this->session->userdata('role_id');
        $c_by = $this->session->userdata('uid');
        $this->db->select('*');
        $this->db->from('ic_registration');
        if ($type != '') {
            $this->db->where('center_type', $type);
        }



        if (!empty($ic_code) && $role_id != 1 && $c_by != 3414 && $c_by != 3964) {
            $this->db->where('ic_code', $ic_code);
        } elseif ($c_by == 3414) {
            //$this->db->where_in('ic_code', [$ic_code,'SU_MH_122']);
        } elseif ($c_by == 3964) {
            $this->db->where_in('ic_code', [$ic_code, 'SU_BR_124']);
        }

        $this->db->where('status', 'Y');
        $query = $this->db->get();

        return $query->result_array();
    }


    function get_ic_bytype_for_ch($type = '')
    {

        $userID = $this->session->userdata('uid');
        $this->db->select('*');
        $this->db->from('ic_registration');
        $this->db->join('ic_mapping', 'ic_registration.ic_code=ic_mapping.ic_code');
        $this->db->where('ic_registration.status', 'Y');
        $this->db->where('ic_mapping.consultant_head', $userID);
        $this->db->where('ic_mapping.status', 'Y');
        $query = $this->db->get();

        return $query->result_array();
    }



    function get_ic_bytype1($type = '', $ic_code)
    {

        $this->db->select('*');
        $this->db->from('ic_registration');
        if ($type != '') {
            $this->db->where('center_type', $type);
        }
        if ($ic_code != '') {
            $this->db->where('ic_code', $ic_code);
        }
        $this->db->where('status', 'Y');
        $query = $this->db->get();

        return $query->result_array();
    }

    function get_ic_details($iccode)
    {

        $ex = explode("_", $iccode);
        $cnt = count($ex);
        if ($cnt > 1) {
            $this->db->select('ic_name,ic_id,ic_code');
            $this->db->from('ic_registration');
            $this->db->where('ic_code', $iccode);
            $query = $this->db->get();
            $stff = $query->result_array();
        } else {
            if (is_numeric($iccode)) {

                $sql = "SELECT CONCAT(ium.fname,' ',ium.lname) AS ic_name FROM user_master um JOIN ic_user_master ium ON um.employee_code=ium.employee_code 
    WHERE um.um_id = '" . $iccode . "' ";

                $query = $this->db->query($sql);

                // $this->db->select('username as ic_name');
                //    $this->db->from('user_master um');
                //$this->db->join('ic_user_master ium','um.employee_code=ium.employee_code');
                //    $this->db->where('um_id', $iccode);
                //    $query = $this->db->get();

                $stff = $query->result_array();
            } else {

                $this->db->select('cd.contact_person as ic_name');
                $this->db->from('user_master um');
                $this->db->join('consultants_call_details cd', 'cd.id=um.con_id');
                $this->db->where('um_id', $iccode);
                $query = $this->db->get();

                $stff = $query->result_array();
            }
        }
        //echo $this->db->last_query();
        return  $stff;
    }



    function get_addAttendentDetails($event_id)
    {

        $this->db->select('*');
        $this->db->from('event_attendent_details');
        $this->db->where('event_id', $event_id);
        $query = $this->db->get();

        return $query->result_array();
    }

    function get_ParticipantDetails($event_id, $part_type_id)
    {

        $this->db->select('*');
        $this->db->from('event_participant_details');
        $this->db->where('event_id', $event_id);
        $this->db->where('part_type_id', $part_type_id);
        $query = $this->db->get();

        return $query->result_array();
    }

    function get_InclisionDetails($event_id)
    {

        $this->db->select('*');
        $this->db->from('event_inclusion_details');
        $this->db->where('event_id', $event_id);
        $query = $this->db->get();

        return $query->result_array();
    }

    function get_SpeakearDetails($event_id)
    {

        $this->db->select('*');
        $this->db->from('event_spaker_details');
        $this->db->where('event_id', $event_id);
        $query = $this->db->get();

        return $query->result_array();
    }

    function fetch_cnt_student_meetdetails($var)
    {

        $userID = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');

        if ($role_id == '1') {

            if ($var['icfilter'] != '') {
                $chekuser = " and s.ic_code='" . $var['icfilter'] . "' ";
            } else {
                // $chekuser ="1";
            }
        } elseif ($role_id == '4' || $role_id == '8' || $role_id == '7') {
            $ic_code = $this->session->userdata('ic_code');
            $chekuser = " and s.ic_code='$ic_code' ";
        } else {
            $chekuser = " and s.created_by = '$userID'";
        }
        if ($var['evtfilter'] != '') {
            $ev = " and s.event_code='" . $var['evtfilter'] . "'";
        }

        if ($var['stdfilter'] != '') {
            $sd = " and s.standard='" . $var['stdfilter'] . "'";
        }
        if ($var['strmfilter'] != '') {
            $st = " and s.stream='" . $var['strmfilter'] . "'";
        }

        $academic_year = NEXTACADEMIC_YEAR;

        if ($var['acd_year'] != '') {
            $academic_year = $var['acd_year'];
        }




        //$sql = "SELECT * FROM student_meet_details WHERE created_by='" . $userID . "' and status='0' and markForDelete = 0";
        $sql = "SELECT  count(s.id) as totPages FROM student_meet_details s 
        left join event_details e on e.event_code = s.event_code 
        left join standard_master sm on s.standard=sm.standard_id
         LEFT JOIN stream_master st ON s.stream=st.stream_id            
        left join institute_master i on i.institue_id = e.institue_id WHERE s.academic_year='" . $academic_year . "' $chekuser $ev $sd $st   ";

        $query = $this->db->query($sql);
        $result = $query->result_array();

        return $result[0]['totPages'];
    }

    function fetch_student_meetdetails($var = array(), $start = '', $limit = '')
    {


        $userID = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');

        if ($role_id == '1') {

            if ($var['icfilter'] != '') {
                $chekuser = " and s.ic_code='" . $var['icfilter'] . "' ";
            } else {
                // $chekuser ="1";
            }
        } elseif ($role_id == '4' || $role_id == '8' || $role_id == '7') {
            $ic_code = $this->session->userdata('ic_code');
            $chekuser = " and s.ic_code='$ic_code' ";
        } elseif ($role_id == 27) {
            $ic_code = $this->session->userdata('ic_code');
            $chekuser = " and s.ic_code IN (
		select ic_code
		from ic_mapping where consultant_head='$userID' and status='Y' 
		) ";
        } else {
            $chekuser = " and s.created_by = '$userID'";
        }
        if ($var['evtfilter'] != '') {
            $ev = " and s.event_code='" . $var['evtfilter'] . "'";
        }

        if ($var['stdfilter'] != '') {
            $sd = " and s.standard='" . $var['stdfilter'] . "'";
        }
        if ($var['strmfilter'] != '') {
            $st = " and s.stream='" . $var['strmfilter'] . "'";
        }

        $academic_year = NEXTACADEMIC_YEAR;

        if ($var['acd_year'] != '') {
            $academic_year = $var['acd_year'];
        }
        $bd1 = '';
        $bd2 = '';
        if ($ic_code == 'SU_BR_102') {
            $bd1 = "bd.obt_marks,bd.tot_marks,bd.academic_year,";
            //$bd2="left JOIN bd_marks_updation bd on s.id=bd.student_id"; 
            $bd2 = "left JOIN bd_marks_updation bd on s.id=bd.student_id and s.academic_year=bd.academic_year";
        }
        //$sql = "SELECT * FROM student_meet_details WHERE created_by='" . $userID . "' and status='0' and markForDelete = 0";
        $sql = "SELECT $bd1 s.id,s.cast_category,s.event_code,s.created_by,s.ic_code,s.student_name,s.mobile1,s.whatsappno,s.email,s.state_name,s.city_name,s.standard,s.stream,s.sujee_interested,s.jee_interested,s.mock_interested,i.institute_name,sm.standard_name,st.stream_name,ir.ic_name,s.mobile1_valid,CONCAT(iu.fname,' ',iu.lname) as added_by FROM student_meet_details s 
        left join event_details e on e.event_code = s.event_code 
		left join ic_users as iu on s.created_by = iu.um_id 
        left join standard_master sm on s.standard=sm.standard_id
         LEFT JOIN stream_master st ON s.stream=st.stream_id
         left join ic_registration ir on s.ic_code=ir.ic_code           
         left join institute_master i on i.institue_id = e.institue_id 
		 $bd2
		 
		 WHERE s.academic_year='" . $academic_year . "' $chekuser $ev $sd $st ";
        $sql .= " ORDER BY i.institute_name, s.id DESC ";
        //$sql .= " LIMIT $start, $limit";
        $query = $this->db->query($sql);
        $result = $query->result_array();

        return $result;
    }

    function search_student_details($row)
    {

        $userID = $this->session->userdata('uid');
        $sql = "SELECT i.institute_name,ic.ic_name,e.event_code, e.tot_application_count,s.student_name,s.mobile1,s.mobile2,st.stream_name,sm.standard_name ,s.created_by
                FROM student_meet_details  s LEFT JOIN event_details e  ON s.event_code=e.event_code 
                LEFT JOIN institute_master i ON i.institue_id=e.institue_id
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN stream_master st ON st.stream_id=s.stream
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard 
                WHERE s.mobile1 like'%" . $row . "%' OR s.student_name LIKE'%" . $row . "%'";
        $query = $this->db->query($sql);

        $res = $query->result_array();

        return $res;
    }

    function get_student_details($student_id = "")
    {

        $userID = $this->session->userdata('uid');
        $academic_year = ACADEMIC_YEAR;
        $sql = "SELECT s.*,s.id,ep.part_type_id,s.id as sid FROM student_meet_details as s 
                left join event_details as e on s.event_code =e.event_code             
                left join event_participant_details as ep on e.event_id=ep.event_id
                WHERE  s.id = '" . $student_id . "' and s.academic_year='$academic_year' ";
        $query = $this->db->query($sql);
        $res = $query->result_array();

        /* if($res[0]['part_type_id']==1){ //for school
            $sql2="select s.school_name from school_master as s 
                   left join event_participant_details as ep on ep.participant_id=s.school_id where ep.event_id='".$res[0]['event_id']."'";
             $query2 = $this->db->query($sql2);
             $res2=$query2->result_array();
            // echo $sql2;//exit;            
             $res[0]['source']='school';
             $res[0]['conducted_at']=$res2[0]['school_name'];
        }elseif($res[0]['part_type_id']==2){//for college
          $sql2="select c.college_name from college_master as c 
                   left join event_participant_details as ep on ep.participant_id=c.college_id where ep.event_id='".$res[0]['event_id']."'";
             $query2 = $this->db->query($sql2);
             $res2=$query2->result_array();
             //echo $sql2;//exit;
             $res[0]['source']='college';            
             $res[0]['conducted_at']=$res2[0]['college_name'];
        }elseif($res[0]['part_type_id']==3){ //for class
            $res[0]['source']='class';
        }elseif($res[0]['part_type_id']==4){  //for other
            $res[0]['source']='other';
        }*/

        return $res;
    }

    function checkDuplicateState($finState)
    {

        $this->db->where('state_name', trim($finState));
        $num_rows = $this->db->count_all_results('state_master');

        return $num_rows;
    }

    function get_city_data($state_id)
    {

        $a = $this->db->get_where('cities', array('state_id' => $state_id))->result();

        return $a;
        //return $this->db->get_where('cities',array('state_id'=>$state_id))->result();
    }


    function get_state_data($country_id)
    {

        $a = $this->db->get_where('states', array('country_id' => $country_id))->result_array();

        return $a;
        //return $this->db->get_where('cities',array('state_id'=>$state_id))->result();
    }



    function checkDuplicateCity($finCity)
    {

        $this->db->where('city_name', trim($finCity));
        $num_rows = $this->db->count_all_results('city_master');

        return $num_rows;
    }

    function get_eventcode_byIcdd($ic_code = '', $ac_year = '')
    {

        $ic_code = $this->session->userdata('ic_code');
        //$ic_code = $this->db->escape_str($ic_code);
        $m = '';


        $academic_year = ACADEMIC_YEAR;

        //if(!empty($ac_year)){
        // $academic_year = $this->db->escape_str($ac_year);
        //}

        if ($ic_code == 'SU_BR_102') {
            $m = " left ";
        }
        $userID = $this->session->userdata('uid');
        $rid = $this->session->userdata('role_id');
        if (isset($ic_code) && $ic_code != " ") {
            if ($rid == 27) {
                $s = " where EV.academic_year='" . $academic_year . "' and  EV.`status` = '0' AND EV.event_organizer_id  in  (
		select ic_code
		from ic_mapping where consultant_head='" . $this->db->escape($userID) . "'  and status='Y'
		) ";
            } else {


                $s = " where EV.academic_year='" . $academic_year . "' and  EV.`status` = '0' AND EV.event_organizer_id = '" . $ic_code . "'";
            }
            // $this->db->where('EV.event_orgniz_type', $ic_code);
        } else {
            $s = '';
        }
        $sql = "select EV.*, IR.ic_name, IR.ic_code, i.institute_name from  event_details EV       
       $m join bd_reportingnew  as br on br.institute_id  = EV.institue_id and (br.seminar='Y' OR br.data_received='Y')
         join ic_registration IR on EV.event_organizer_id = IR.ic_code
         join institute_master i on i.institue_id = EV.institue_id 
        $s group by EV.event_code
        ";


        $query = $this->db->query($sql);


        $data = $query->result_array();

        return $data;
    }

    public function get_eventcode_byIc($ic_code = '', $ac_year = '')
    {

        $ic_code = $this->session->userdata('ic_code');
        $m = '';
        $academic_year = ACADEMIC_YEAR;

        // Set academic year if provided
        if (!empty($ac_year)) {
            $academic_year = $this->db->escape_str($ac_year);
        }

        // Set join type based on ic_code
        //if ($ic_code == 'SU_BR_102') {
        $m = " LEFT ";
        //}

        // Get user ID and role ID from session
        $userID = $this->session->userdata('uid');
        $rid = $this->session->userdata('role_id');

        // Build the where clause based on conditions
        $s = '';
        if (isset($ic_code) && $ic_code != " ") {
            $ic_code = $this->db->escape_str($ic_code);

            if ($rid == 27) {
                $s = " WHERE EV.academic_year='" . $academic_year . "' AND EV.`status` = '0' AND EV.event_organizer_id IN (
                    SELECT ic_code
                    FROM ic_mapping
                    WHERE consultant_head=" . $this->db->escape($userID) . " AND status='Y'
                )";
            } else {
                $s = " WHERE EV.academic_year='" . $academic_year . "' AND EV.`status` = '0' AND EV.event_organizer_id = '" . $ic_code . "'";
            }
        }

        // Build the SQL query AND (br.seminar='Y' OR br.data_received='Y')
        $sql = "SELECT EV.*, IR.ic_name, IR.ic_code, i.institute_name 
                FROM event_details EV
                $m JOIN bd_reportingnew AS br ON br.institute_id = EV.institue_id 
                JOIN ic_registration IR ON EV.event_organizer_id = IR.ic_code
                JOIN institute_master i ON i.institue_id = EV.institue_id
                $s
                GROUP BY EV.event_code";

        // Execute the query
        $query = $this->db->query($sql);

        // Fetch the results
        $data = $query->result_array();

        // Close the database connection


        // Return the results
        return $data;
    }

    //City
    function get_city_details($state_id = '')
    {

        $this->db->select('DISTINCT(city)');
        $this->db->from('student_meet_details');
        if ($state_id != "") {
            $this->db->where("state ='" . $state_id . "'");
        }
        $this->db->order_by('city', 'ASC');
        $query = $this->db->get();

        $query = $query->result_array();
        return $query;
    }
    function get_eventdetail_byCode($event_id)
    {

        $userID = $this->session->userdata('uid');
        $sql1 = "SELECT EV.*,im.institute_name,s.name as state_name,c.name as city_name FROM event_details as EV
                left join states as s on s.id=EV.state_id 
                left join cities as c on c.id=EV.city_id 
                left join institute_master as im on im.institue_id=EV.institue_id
                where EV.`event_code`='$event_id'";

        $query = $this->db->query($sql1);
        //  echo $sql;//exit;
        $res = $query->result_array();

        return $res;
    }


    function fetchCityDetails()
    {


        $this->db->select('id, name');
        $this->db->from('cities');
        $this->db->order_by('name', 'ASC');
        $query = $this->db->get();
        $query = $query->result_array();

        return $query;
    }

    public function get_user_count($row)
    {



        $date = $this->db->escape_str($row['date']);
        $created_by = $this->db->escape_str($row['created_by']);
        $academic_year = $this->db->escape_str($row['academic_year']);

        // Build the query using the query builder
        $this->db->select("SUM(CASE WHEN DATE(created_date) = '$date' THEN 1 ELSE 0 END) AS today_count, COUNT(*) AS total_count");
        $this->db->from('student_meet_details');
        $this->db->where('created_by', $created_by);
        $this->db->where('academic_year', $academic_year);

        // Execute the query
        $query = $this->db->get();

        // Fetch the result as an associative array
        $result = $query->row_array();

        // Return the result
        return $result;
    }


    function get_ksou_data($row)
    {

        if (!empty($row['event_code'])) {
            $wr = " and s.event_code='" . $row['event_code'] . "' ";
        }
        if ($row['led'] == '2') {
            $mob = ' and s.mobile1_status is null and s.lead_assign is not null';
        }
        $sql = "SELECT DISTINCT s.id,s.is_ind,s.utm_source,s.student_name,s.mobile1,s.mobile1_valid,s.mobile2,s.mobile1_status,st.stream_name,sm.standard_name ,s.created_by,s.created_date,s.programme_id,s.programme_status,ct.city_name,s.landmark,s.lead_assign,s.provisional_admission,s.walkin_status 
        FROM student_meet_details s  LEFT JOIN stream_master st ON st.stream_id=s.stream 
        LEFT JOIN standard_master sm ON sm.standard_id=s.standard 
        LEFT JOIN city_master ct ON s.city_id=ct.city_id 
        WHERE s.ic_code='KSOU' $wr $mob order by s.id DESC ";
        $query = $this->db->query($sql);

        $res = $query->result_array();

        return $res;
    }

    function get_student_by_event($row)
    {

        $userID = $this->session->userdata('uid');
        $academic_year = ACADEMIC_YEAR;
        if ($row['ic_code'] == "digital") {
            // $cond="  s.utm_source='".$row['event_code']."' and s.utm_campaign='".$row['utm_campaign']."' ";
            if (!empty($row['event_code'])) {
                $utm = "and s.utm_source='" . $row['event_code'] . "' ";
            }
            $l = 'LEFT';
            /*if(!empty($row['sel_c_typ'])){
    if($row['sel_c_typ']=='P'){
$cty = " and s.is_ind = 'P'";
    }else{
$cty = " and s.is_ind != 'P'";
    }
}*/
            if (!empty($row['digi_date'])) {
                $cond = " and s.ic_code = 'digital' $utm $cty and date(s.created_date) = '" . date('Y-m-d', strtotime($row['digi_date'])) . "'  ";
            } else {
                $cond = " and s.ic_code = 'digital' $utm  $cty and s.academic_year='$academic_year' ";
            }
            if ($row['led'] == '2') {
                $mob = " and s.mobile1_status is null and s.lead_assign is not null ";
            }
        } else {
            $y = " and s.academic_year = '" . $this->config->item('ic_year') . "' and ic.status='Y' ";
            if (isset($row['event_code']) && $row['event_code'] != 'null' && !empty($row['event_code'])) {
                $cond = " and e.event_code='" . $row['event_code'] . "'";
            }
            if (!empty($row['ic_code'])) {
                $condic = " and s.ic_code='" . $row['ic_code'] . "'";
            }
            $ic = $this->session->userdata('ic_code');
            if (!empty($ic)) {
                $condic = " and s.ic_code='" . $ic . "'";
            }
        }


        /* $sql = "SELECT distinct s.id,i.institute_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.mobile2,s.mobile1_status,st.stream_name,sm.standard_name ,s.created_by,s.created_date,s.programme_id,s.programme_status
                FROM student_meet_details  s 
                LEFT JOIN event_details e  ON s.event_code=e.event_code 
                LEFT JOIN institute_master i ON i.institue_id=e.institue_id
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN stream_master st ON st.stream_id=s.stream
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard                
                WHERE   ".$cond." order by s.created_date desc , s.id desc"; */
        $sql = "SELECT DISTINCT s.id,s.utm_source,i.institute_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,
st.stream_name,sm.standard_name ,s.created_by,s.created_date,s.programme_id,s.programme_status,ct.name AS city_name,
l.lead_assign,s.provisional_admission,s.walkin_status
                FROM student_meet_details  s  " . $l . " JOIN event_details e  ON e.event_code=s.event_code AND s.academic_year=e.academic_year
                 " . $l . " JOIN institute_master i ON i.institue_id=e.institue_id AND i.academic_year=e.academic_year
				 LEFT JOIN lead_assign_details l ON l.stud_id=s.id  AND s.academic_year=l.academic_year
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN stream_master st ON st.stream_id=s.stream
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard 
                LEFT JOIN cities ct ON s.city_id=ct.id
                WHERE 1 " . $y . " " . $cond . " " . $condic . " " . $mob . " order by s.created_date DESC";
        $query = $this->db->query($sql);

        $res = $query->result_array();

        return $res;
    }
    function get_student_by_event_cnt($row)
    {


        $userID = $this->session->userdata('uid');
        $academic_year = ACADEMIC_YEAR;
        if ($row['ic_code'] == "digital") {
            // $cond="  s.utm_source='".$row['event_code']."' and s.utm_campaign='".$row['utm_campaign']."' ";
            $l = 'LEFT';
            if (!empty($row['event_code'])) {
                $utm = "and s.utm_source='" . $row['event_code'] . "' ";
            }
            if (!empty($row['sel_c_typ'])) {
                if ($row['sel_c_typ'] == 'P') {
                    $cty = " and s.is_ind = 'P'";
                } else {
                    $cty = " and s.is_ind != 'P'";
                }
            }
            if (!empty($row['digi_date'])) {
                $cond = " and s.ic_code = 'digital' $utm $cty and date(s.created_date) = '" . date('Y-m-d', strtotime($row['digi_date'])) . "'  ";
            } else {
                $cond = " and s.ic_code = 'digital' $utm $cty AND s.academic_year='$academic_year' ";
            }
        } else {
            $e = "count(distinct s.event_code) as ecnt,";
            $y = " and s.academic_year = '" . $this->config->item('ic_year') . "' and ic.status='Y'";
            $ic = $this->session->userdata('ic_code');
            if (!empty($row['event_code'])) {
                $cond = " and e.event_code='" . $row['event_code'] . "'";
            }
            if (!empty($row['ic_code'])) {
                $condic = " and s.ic_code='" . $row['ic_code'] . "'";
            }

            if (!empty($ic)) {
                $condic = " and s.ic_code='" . $ic . "'";
            }
        }


        $sql = "SELECT $e count(*) as cnt
                FROM student_meet_details  s  
                " . $l . " JOIN event_details e  ON e.event_code=s.event_code and s.academic_year=e.academic_year                
                " . $l . " JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                 " . $l . " JOIN institute_master i ON i.institue_id=e.institue_id and i.academic_year=e.academic_year  
                LEFT JOIN stream_master st ON st.stream_id=s.stream
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard 
                LEFT JOIN `cities` ct ON s.city_id=ct.id
                WHERE  1 " . $y . " " . $cond . " " . $condic . " ";
        $query = $this->db->query($sql);
        //echo $this->db->last_query();exit;
        $res = $query->result_array();

        return $res;
    }
    function get_student_by_mobile_name($row)
    {
        $userID = $this->session->userdata('uid');
        $academic_year = ACADEMIC_YEAR;
        if ($row['mobile'] != '') {
            $cond = " and (s.mobile1='" . $row['mobile'] . "' OR s.mobile2='" . $row['mobile'] . "' ) ";
        }
        if ($row['sname'] != '') {
            $cond1 = " and s.student_name like '%" . $row['sname'] . "%'";
        }
        if ($row['email'] != '') {
            $cond2 = " and s.email='" . $row['email'] . "'";
        }
        if ($row['datepic'] != '') {
            $cond3 = " and s.dob='" . $row['datepic'] . "'";
        }

        $sql = "SELECT distinct s.id,s.event_code as ecode,i.institute_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.mobile2,'' as mobile1_status,st.stream_name,sm.standard_name ,s.created_by,s.ic_code as code
                FROM student_meet_details  s LEFT JOIN event_details e  ON s.event_code=e.event_code 
                LEFT JOIN institute_master i ON i.institue_id=e.institue_id
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN stream_master st ON st.stream_id=s.stream
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard                
                WHERE  1 " . $cond . $cond1 . $cond2 . $cond3 . " and s.academic_year='$academic_year'";

        $query = $this->db->query($sql);
        //echo $this->db->last_query();//exit;
        $res = $query->result_array();

        return $res;
    }

    function get_student_by_mobile($row)
    {
        $userID = $this->session->userdata('uid');

        $cond = "s.mobile1='" . $row['mobile'] . "'";

        $sql = "SELECT distinct s.id,i.institute_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.mobile2,s.mobile1_status,st.stream_name,sm.standard_name ,s.created_by,s.ic_code as code
                FROM student_meet_details  s LEFT JOIN event_details e  ON s.event_code=e.event_code 
                LEFT JOIN institute_master i ON i.institue_id=e.institue_id
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN stream_master st ON st.stream_id=s.stream
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard
                
                WHERE   " . $cond;
        $query = $this->db->query($sql);
        // echo $this->db->last_query();exit;
        $res = $query->result_array();

        return $res;
    }

    function save_call_log($data)
    {
        $data['called_by'] = $this->session->userdata('uid');
        $data['called_on'] = date('Y-m-d H:i:s');
        $this->db->insert('calling_log_details', $data);
        $insert_id = $this->db->insert_id();
        return $insert_id;
    }
    function save_call_log_incoming($data)
    {
        if (empty($this->session->userdata('name'))) {
            $this->session->set_flashdata('flash_data', 'Login Again ');
            redirect('login');
        } else {
            $data['updated_by'] = $this->session->userdata('name');
            $data['updated_on'] = date('Y-m-d H:i:s');
            $this->db->insert('calling_log_details', $data);
            $insert_id = $this->db->insert_id();
            return $insert_id;
        }
    }

    function get_mobile_call_details($mobile)
    {
        if ($this->session->userdata('role_id') == '11') {
            $query = $this->db->query("SELECT distinct  c.mobile_no,c.c_id,c.called_on,c.calling_status,c.Course_Interested,c.remark,c.called_by,i.staff_name,c.seminar_feedback,c.sujee_feedback,c.sujee_exam,c.visite_date,c.visite_ic_code,c.conve_time,c.sujee_exam_date  FROM calling_log_details as  c
left join inhouse_staff_details as i ON i.staff_id=c.called_by WHERE c.mobile_no='" . $mobile . "' order by c.called_on DESC ");
        } else {
            $query = $this->db->query(
                "SELECT distinct  c.mobile_no,c.called_on,c.calling_status,c.Course_Interested,c.remark,c.called_by,CONCAT(i.fname,' ',i.lname) as staff_name,c.seminar_feedback,c.sujee_feedback,c.sujee_exam,c.visite_date,c.visite_ic_code,c.conve_time,c.sujee_exam_date,sur.is_term_confirmed,sur.pref_location,sur.perf_location_name FROM calling_log_details as  c
 left join ic_users as i ON i.username=c.called_by left join su_jee_registration as sur ON sur.reg_id=c.student_id  left join exam_center_master as excm ON excm.id=sur.pref_location  WHERE c.mobile_no='" . $mobile . "'  order by c.called_on DESC "
            );
        }
        $query = $query->result_array();
        //print_r($query);exit;
        return $query;
    }
    function get_mobile_call_details_new($sid)
    {
        if ($this->session->userdata('role_id') == '11') {
            $query = $this->db->query("SELECT distinct  c.mobile_no,c.called_on,c.calling_status,c.Course_Interested,c.remark,c.called_by,i.staff_name,c.seminar_feedback,c.sujee_feedback,c.sujee_exam,c.visite_date,c.visite_ic_code,c.conve_time,l.calling_event,lt.subtypes   FROM calling_log_details as  c
left join inhouse_staff_details as i ON i.staff_id=c.called_by 
left join interested_leads_subtypes lt on c.sub_status=lt.id

WHERE c.student_id='" . $sid . "' and c.student_id !='' order by c.called_on DESC ");
        } else {
            $query = $this->db->query(
                "SELECT distinct  c.mobile_no,l.calling_event,c.called_on,c.calling_status,c.Course_Interested,c.remark,c.called_by,CONCAT(i.fname,' ',i.lname) as staff_name,c.visite_date,c.visite_ic_code,c.conve_time,l.calling_event,lt.subtypes  FROM calling_log_details as  c
	  left join interested_leads_subtypes lt on c.sub_status=lt.id
 left join ic_users as i ON i.um_id=c.called_by left join lead_assign_details as l on c.ld_id =l.id  WHERE c.student_id='" . $sid . "'  and c.student_id !='' order by c.called_on DESC "
            );
        }
        //  echo $query;
        $query = $query->result_array();
        //print_r($query);exit;
        return $query;
    }
    function update_student_call_log($id, $data)
    {
        $this->db->where('id', $id);
        $this->db->update('student_meet_details', $data);
        // echo  $this->db->last_query();exit();

    }

    function event_call_list($row)
    {

        $cond = " and e.event_code='" . $row . "'";

        $sql = "SELECT distinct s.id,i.institute_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.mobile2,s.mobile1_status,st.stream_name,sm.standard_name ,s.created_by,v.*
                FROM student_meet_details  s LEFT JOIN event_details e  ON s.event_code=e.event_code 
                LEFT JOIN institute_master i ON i.institue_id=e.institue_id
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN stream_master st ON st.stream_id=s.stream
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard
                left join calling_log_details ca on ca.mobile_no=s.mobile1
                LEFT JOIN  vw_ic_user v ON v.um_id=ca.called_by
                WHERE  s.mobile1_status!=''  " . $cond . "order by ca.called_by ";
        $query = $this->db->query($sql);
        //echo $this->db->last_query();exit;
        $res = $query->result_array();

        return $res;
    }
    function user_call_list()
    {
        $user_id = $this->session->userdata('name');
        if ($user_id == "superadmin" || $user_id == "admin" || $user_id == "1158") {
            $cond = " ";
        } else {
            $cond = "and c.called_by='" . $user_id . "'";
        }

        /* $sql = "SELECT distinct s.id,i.institute_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.mobile2,s.mobile1_status,st.stream_name,sm.standard_name ,s.created_by,v.*,DATE(ca.called_on) AS call_date
                FROM student_meet_details  s LEFT JOIN event_details e  ON s.event_code=e.event_code 
                LEFT JOIN institute_master i ON i.institue_id=e.institue_id
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN stream_master st ON st.stream_id=s.stream
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard
                left join calling_log_details ca on ca.mobile_no=s.mobile1
                LEFT JOIN  vw_ic_user v ON v.um_id=ca.called_by
                WHERE  s.mobile1_status!=''   ".$cond."order by ca.called_by ";
                */
        $sql = "SELECT s.provisional_admission,s.id,c.student_id,s.student_name,s.mobile1_valid,c.mobile_no as mobile1,c.called_by,c.called_on,DATE(c.called_on) AS call_date, c.calling_status,c.Course_Interested , s.mobile1_status,c.remark,
CASE WHEN i.ic_name IS NULL THEN s.utm_source ELSE i.ic_name END AS ic_name,
CASE WHEN p.sprogramm_acro IS NULL THEN s.programme_status ELSE p.sprogramm_acro  END AS course,
st.stream_name,sm.standard_name,case when ct.city_name is null then s.landmark else ct.city_name end as city
 FROM  calling_log_details c
 JOIN (SELECT MAX(c_id) AS c_id FROM calling_log_details GROUP BY mobile_no) max ON c.c_id = max.c_id
LEFT JOIN student_meet_details s ON c.student_id=s.id AND s.lead_assign=c.called_by
LEFT JOIN ic_registration i ON i.ic_code=s.ic_code
LEFT JOIN sandipun_univerdb.school_programs_new p ON p.sp_id=s.programme_id
LEFT JOIN stream_master st ON st.stream_id=s.stream
LEFT JOIN standard_master sm ON sm.standard_id=s.standard
left join city_master ct on ct.city_id=s.city_id
  WHERE  c.calling_status!=''  " . $cond . " AND s.student_name IS NOT NULL
GROUP BY c.student_id,c.mobile_no,c.called_by order by c.called_on desc";
        $query = $this->db->query($sql);
        // echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }

    function get_caller_count()
    {
        $user_id = $this->session->userdata('uid');
        if ($user_id == "1" || $user_id == "2" || $user_id == "12") {
            $cond = " ";
        } else {
            $cond = "and ca.called_by='" . $user_id . "'";
        }
        $sql = "SELECT a.ic_name,a.fname,a.lname,a.mname,COUNT(DISTINCT a.mobile1)AS total_call,SUM(CASE WHEN a.call_date=CURDATE() THEN 1 ELSE 0 END) AS todaycall
FROM (
SELECT DISTINCT ic.ic_name,v.fname,v.lname,v.mname,s.mobile1 ,DATE(ca.called_on) AS call_date
                FROM student_meet_details  s LEFT JOIN event_details e  ON s.event_code=e.event_code 
                LEFT JOIN institute_master i ON i.institue_id=e.institue_id
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN stream_master st ON st.stream_id=s.stream
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard
                LEFT JOIN calling_log_details ca ON ca.mobile_no=s.mobile1
                LEFT JOIN  vw_ic_user v ON v.um_id=ca.called_by
                WHERE  s.mobile1_status!=''   $cond
                ) a 
                GROUP BY a.ic_name,a.fname,a.lname,a.mname ORDER BY todaycall DESC";
        $query = $this->db->query($sql);
        // echo $this->db->last_query();exit;
        $res = $query->result_array();
        return $res;
    }
    function get_caller_inst_count()
    {
        $user_id = $this->session->userdata('uid');
        if ($user_id == "1" || $user_id == "2" || $user_id == "12") {
            $cond = " ";
        } else {
            $cond = "and ca.called_by='" . $user_id . "'";
        }
        $sql = "SELECT a.ic_name,a.fname,a.lname,a.mname,a.institute_name,COUNT(DISTINCT a.mobile1)AS total_call,SUM(CASE WHEN a.call_date=CURDATE() THEN 1 ELSE 0 END) AS todaycall
            FROM (
            SELECT DISTINCT ic.ic_name,v.fname,v.lname,v.mname,s.mobile1 ,i.institute_name,DATE(ca.called_on) AS call_date
                            FROM student_meet_details  s LEFT JOIN event_details e  ON s.event_code=e.event_code 
                            LEFT JOIN institute_master i ON i.institue_id=e.institue_id
                            LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                            LEFT JOIN stream_master st ON st.stream_id=s.stream
                            LEFT JOIN standard_master sm ON sm.standard_id=s.standard
                            LEFT JOIN calling_log_details ca ON ca.mobile_no=s.mobile1
                            LEFT JOIN  vw_ic_user v ON v.um_id=ca.called_by
                            WHERE  s.mobile1_status!=''   $cond
                            ) a 
                            GROUP BY a.ic_name,a.fname,a.lname,a.mname,a.institute_name ORDER BY todaycall DESC";
        $query = $this->db->query($sql);
        // echo $this->db->last_query();exit;
        $res = $query->result_array();
        return $res;
    }

    function get_call_later_count($row)
    {



        $sql = "SELECT i.fname,i.lname,i.ic_name,i.mobile_official,c.called_by,COUNT(c.c_id) as call_count
                 FROM calling_log_details c
                  LEFT JOIN ic_users i ON i.um_id=c.called_by WHERE  c.calling_status='CALL-LATER' 
                GROUP BY called_by 
                 ";
        $query = $this->db->query($sql);
        //echo $this->db->last_query();exit;
        $res = $query->result_array();

        return $res;
    }
    function chek_mob_exist($mobile_no)
    {
        $academic_year = ACADEMIC_YEAR;
        //OR whatsappno = '".$mobile_no."' OR pmobile_no = '".$mobile_no."' OR pwhatsapp_no = '".$mobile_no."'
        $sql = "SELECT * FROM student_meet_details
    where academic_year='$academic_year' and (mobile1 = '" . $mobile_no . "' 
	OR mobile2='" . $mobile_no . "'
	
	) ";

        $query = $this->db->query($sql);
        $result = $query->result_array();
        ///echo $this->db->last_query();//exit;
        return $result;
    }


    function chek_citizen_exist($citisenshipno = '', $student = '')
    {
        $academic_year = ACADEMIC_YEAR;
        $c = '';
        if (!empty($student)) {
            $c = " and id not in ($student) ";
        }
        //OR whatsappno = '".$mobile_no."' OR pmobile_no = '".$mobile_no."' OR pwhatsapp_no = '".$mobile_no."'
        $sql = "SELECT id FROM student_meet_details
            where academic_year='$academic_year' and citisenshipno = '" . $citisenshipno . "' $c
           UNION 
		    select id from citizenshipdetails where citizenship_no= '" . $citisenshipno . "' $c

			";

        $query = $this->db->query($sql);
        $result = $query->result_array();
        ///echo $this->db->last_query();//exit;
        return $result;
    }


    function chek_email_exist($mobile_no)
    {
        $academic_year = ACADEMIC_YEAR;
        $sql = "SELECT * FROM student_meet_details
         where academic_year='$academic_year' and (email = '" . $mobile_no . "') ";
        //exit;
        // $this->db->select('*'); 
        //  $this->db->from('student_meet_details');
        //$this->db->where('mobile1', $mobile_no);
        // $this->db->or_where('mobile2', $mobile_no);
        //  $query = $this->db->get();
        $query = $this->db->query($sql);
        $result = $query->result_array();
        ///echo $this->db->last_query();//exit;
        return $result;
    }

    function chek_email_exist_up($mobile_no, $student_id = '', $ac = '')
    {
        $academic_year = ACADEMIC_YEAR;
        if (!empty($ac)) {
            $academic_year = $ac;
        }

        $sql = "SELECT * FROM student_meet_details
         where academic_year='$academic_year' and (email = '" . $mobile_no . "') and id !=$student_id ";
        //exit;
        // $this->db->select('*'); 
        //  $this->db->from('student_meet_details');
        //$this->db->where('mobile1', $mobile_no);
        // $this->db->or_where('mobile2', $mobile_no);
        //  $query = $this->db->get();
        $query = $this->db->query($sql);
        $result = $query->result_array();
        ///echo $this->db->last_query();//exit;
        return $result;
    }





    function chek_admission_taken($mobile_no, $mail = '', $ac = '')
    {


        $academic_year = ACADEMIC_YEAR;
        if (!empty($ac)) {
            $academic_year = $ac;
        }
        $c = explode('-', $academic_year);
        $c = $c[0];
        $condition = '';
        if ($mail != '') {
            $condition = " or s.email='$mail' ";
        }
        $sql = "SELECT distinct(s.stud_id) as student_id,'Nashik' as admission_center
                FROM sandipun_ums.student_master  s                     
                WHERE s.admission_session='$c' and (s.mobile = '" . $mobile_no . "' OR s.contact_no = '" . $mobile_no . "' $condition) and s.enrollment_no !='' and s.cancelled_admission='N'
				UNION 
				SELECT distinct(s.stud_id) as student_id,'Sijoul' as admission_center
                FROM sandipun_ums_sijoul.student_master  s                     
                WHERE s.admission_session='$c'  and (s.mobile = '" . $mobile_no . "' OR s.contact_no = '" . $mobile_no . "' $condition) and s.enrollment_no !=''  and s.cancelled_admission='N' ";

        $query = $this->db->query($sql);
        //echo $sql;
        //exit;


        $res = $query->result_array();
        $count = sizeof($res);
        return $count;
    }

    function chek_admission_taken_by_email($email)
    {


        $academic_year = ACADEMIC_YEAR;
        $c = explode('-', $academic_year);
        $c = $c[0];
        $sql = "SELECT distinct(s.stud_id) as student_id
                FROM sandipun_ums.student_master  s                     
                WHERE s.admission_session='$c' and (s.email = '" . $email . "') and s.enrollment_no !='' and s.cancelled_admission='N'
				UNION 
				SELECT distinct(s.stud_id) as student_id
                FROM sandipun_ums_sijoul.student_master  s                     
                WHERE s.admission_session='$c'  and (s.email = '" . $email . "') and s.enrollment_no !='' and s.cancelled_admission='N'";

        $query = $this->db->query($sql);
        //echo $sql;
        //exit;


        $res = $query->result_array();
        $count = sizeof($res);
        return $count;
    }

    function get_interested_exams($student_id)
    {
        return $this->db->query("select em.exam_name,exam_date,phase from su_jee_registration s join exam_master as em on
	s.exam_no=em.exam_id where s.student_id=$student_id")->result();
    }

    function chek_mob_exist_up($mobile_no, $id = '', $ac = '')
    {
        $academic_year = ACADEMIC_YEAR;

        $academic_year = ACADEMIC_YEAR;
        if (!empty($ac)) {
            $academic_year = $ac;
        }

        //OR pmobile_no = '".$mobile_no."' OR pwhatsapp_no = '".$mobile_no."'OR  whatsappno = '".$mobile_no."' 
        $sql = "SELECT * FROM student_meet_details
    where academic_year='$academic_year' and (mobile1 = '" . $mobile_no . "'
    OR mobile2 = '" . $mobile_no . "'
	 ) and id != '" . $id . "' ";
        // echo $sql;exit();
        $query = $this->db->query($sql);
        return $query->result_array();
    }
    function chek_mob_exist_for_update($mobile_no, $studentId)
    {
        $academic_year = ACADEMIC_YEAR;
        $this->db->select('*');
        $this->db->from('student_meet_details');
        $this->db->where('mobile1', $mobile_no);
        $this->db->where('id !=', $studentId);
        $this->db->where('academic_year =', $academic_year);
        $query = $this->db->get();
        $result = $query->result_array();
        //echo $this->db->last_query();exit;
        return $result;
    }
    function get_stream_std($std = '')
    {
        //echo $std;
        if (!empty($std)) {
            if ($std == '1' || $std == '2' || $std == '3' || $std == '4' || $std == '5') {
                $degt = 'HSC';
            } elseif ($std == '6') {
                $degt = 'SSC';
            } elseif ($std == '8' || $std == '9') {
                $degt = 'UG';
            }
            $sql = " where sp.min_qualification = '" . $degt . "'";
        }
        $sql = "SELECT sp.school_id,sm.school_name,sp.min_qualification FROM sandipun_univerdb.school_programs_new as sp
    left join sandipun_univerdb.school_master sm on sm.school_id = sp.school_id 
    $sql group by sp.school_id";
        //echo $sql;exit();
        $query = $this->db->query($sql);
        return $query->result_array();
    }
    function get_course($sch, $std)
    {

        if (!empty($std)) {
            if ($std == '1' || $std == '2' || $std == '3' || $std == '4' || $std == '5') {
                $degt = 'HSC';
            } elseif ($std == '6') {
                $degt = 'SSC';
            } elseif ($std == '8' || $std == '9') {
                $degt = 'UG';
            }
            $sql = "and min_qualification = '" . $degt . "'";
        }
        $sql = "SELECT sp_id,school_id,sprogramm_name FROM sandipun_univerdb.school_programs_new 
        where school_id = '" . $sch . "' $sql ";
        $query = $this->db->query($sql);
        return $query->result_array();
    }
    function get_programme_byid($pid)
    {
        $sql = "SELECT sp.sprogramm_name,sp.sp_id,sp.school_id,sm.school_name FROM sandipun_univerdb.school_programs_new as sp left join sandipun_univerdb.school_master as sm on sp.school_id=sm.school_id
        where sp_id ='" . $pid . "' ";
        $query = $this->db->query($sql);
        $sp = $query->result_array();
        return $sp;
    }
    function get_student_by_city($row)
    {
        if (!empty($row['ic'])) {
            $cond = " and s.ic_code='" . $row['ic'] . "' ";
        }
        if (!empty($row['state']) && $row['state'] != 0) {
            $st = " and s.state_id = '" . $row['state'] . "' ";
        }
        if (!empty($row['ccity']) && $row['ccity'] != '') {
            $cond1 = " and s.city_id = '" . $row['ccity'] . "' ";
        }
        $sql = "SELECT distinct s.is_ind,s.id,s.city_id,s.provisional_admission,s.state_id,stm.state_name,cm.city_name,ic.ic_name,ic.ic_code,s.student_name,s.mobile1,s.mobile1_valid,s.mobile2,s.mobile1_status,st.stream_name,sm.standard_name ,s.created_by,s.created_date,s.lead_assign
                FROM student_meet_details  s                 
             JOIN ic_registration ic ON ic.ic_code=s.ic_code
             JOIN stream_master st ON st.stream_id=s.stream
             JOIN standard_master sm ON sm.standard_id=s.standard
            JOIN state_master stm ON stm.state_id=s.state_id
                JOIN city_master cm ON cm.city_id=s.city_id                
                WHERE  s.academic_year='" . $this->config->item('ic_year') . "' and s.city_id is not null and s.provisional_admission !='Y' " . $st . " " . $cond . " " . $cond1 . " ";
        $query = $this->db->query($sql);
        // echo $this->db->last_query();exit;
        $res = $query->result_array();

        return $res;
    }
    function get_student_by_inbound($row)
    {
        if (!empty($row['ic_code'])) {
            $cond = " and s.ic_code='" . $row['ic_code'] . "' ";
        }
        $sql = "SELECT distinct s.is_ind,s.id,s.city_id,s.provisional_admission,s.state_id,cm.city_name,ic.ic_name,ic.ic_code,s.student_name,s.mobile1,s.mobile1_valid,s.mobile2,s.mobile1_status,s.created_by,s.created_date,s.lead_assign
                FROM student_meet_details  s                 
             JOIN ic_registration ic ON ic.ic_code=s.ic_code                      
                JOIN city_master cm ON cm.city_id=s.city_id                
                WHERE  s.academic_year='" . $this->config->item('ic_year') . "' and s.event_code='INBOUND' and s.provisional_admission !='Y'  " . $cond . "  ";
        $query = $this->db->query($sql);
        // echo $this->db->last_query();
        //exit;
        $res = $query->result_array();

        return $res;
    }
    function get_student_by_city_cnt($row)
    {
        if (!empty($row['ic'])) {
            $cond = " and s.ic_code='" . $row['ic'] . "' ";
        }
        if (!empty($row['state']) && $row['state'] != 0) {
            $st = " and s.state_id = '" . $row['state'] . "' ";
        }
        if (!empty($row['ccity']) && $row['ccity'] != '') {
            $cond1 = " and s.city_id = '" . $row['ccity'] . "' ";
        }
        $sql = "SELECT count(*) as cnt
                FROM student_meet_details  s                
                left JOIN ic_registration ic ON ic.ic_code=s.ic_code
                left JOIN stream_master st ON st.stream_id=s.stream
                left JOIN standard_master sm ON sm.standard_id=s.standard
                left JOIN state_master stm ON stm.state_id=s.state_id
                left JOIN city_master cm ON cm.city_id=s.city_id               
                WHERE s.academic_year='" . $this->config->item('ic_year') . "' and s.city_id is not null and s.provisional_admission !='Y'  " . $st . " " . $cond . " " . $cond1 . " ";
        $query = $this->db->query($sql);
        // echo $this->db->last_query();
        $res = $query->result_array();

        return $res;
    }
    function get_student_by_suexam($data)
    {
        $cond = "s.ic_code='" . $data['ic'] . "' and ser.exam_name = '" . $data['suexam'] . "' ";

        $sql = "SELECT distinct s.id,s.state_id,s.provisional_admission,s.landmark,cm.city_name,ser.exam_name,i.institute_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.mobile2,s.mobile1_status,st.stream_name,sm.standard_name ,s.created_by,s.created_date,s.lead_assign
                FROM student_meet_details  s 
                LEFT JOIN event_details e  ON s.event_code=e.event_code 
                LEFT JOIN institute_master i ON i.institue_id=e.institue_id
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN stream_master st ON st.stream_id=s.stream
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard
            LEFT JOIN su_jee_registration sr ON sr.reg_id=s.id
            LEFT JOIN su_jee_exam_result ser ON ser.reg_no=sr.reg_no
                left join calling_log_details ca on ca.mobile_no=s.mobile1
                LEFT JOIN city_master cm ON cm.city_id=s.city_id
                WHERE   s.provisional_admission !='Y' and " . $cond . "  ";
        $query = $this->db->query($sql);
        //  echo $this->db->last_query();exit;
        $res = $query->result_array();
        return $res;
    }
    function get_student_by_standard($data)
    {
        $cond = "s.ic_code='" . $data['ic'] . "' and s.standard = '" . $data['stand'] . "' ";
        if (!empty($data['stream']) && $data['stream'] != '') {
            $cond1 = " and s.stream = '" . $data['stream'] . "'  ";
        }
        $sql = "SELECT distinct s.id,st.stream_id,s.provisional_admission,s.landmark,cm.city_name,sm.standard_id,i.institute_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.mobile2,s.mobile1_status,st.stream_name,sm.standard_name ,s.created_by,s.created_date,s.lead_assign
                FROM student_meet_details  s 
                LEFT JOIN event_details e  ON s.event_code=e.event_code 
                LEFT JOIN institute_master i ON i.institue_id=e.institue_id
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN stream_master st ON st.stream_id=s.stream
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard                
                LEFT JOIN city_master cm ON cm.city_id=s.city_id
                WHERE  s.academic_year='" . $this->config->item('ic_year') . "' and s.provisional_admission !='N'  and s.mobile1_status is null and " . $cond . " " . $cond1 . "  ";
        $query = $this->db->query($sql);
        // echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }
    function get_student_by_standard_cnt($data)
    {
        $cond = "s.ic_code='" . $data['ic'] . "' ";
        if (!empty($data['stand']) && $data['stand'] != '') {
            $stdc = " and s.standard = '" . $data['stand'] . "' ";
        }
        if (!empty($data['stream']) && $data['stream'] != '') {
            $cond1 = " and s.stream = '" . $data['stream'] . "'  ";
        }
        $sql = "SELECT count(*) as cnt
                FROM student_meet_details  s 
                LEFT JOIN event_details e  ON s.event_code=e.event_code 
                LEFT JOIN institute_master i ON i.institue_id=e.institue_id
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN stream_master st ON st.stream_id=s.stream
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard                
                LEFT JOIN city_master cm ON cm.city_id=s.city_id
                WHERE  s.academic_year='" . $this->config->item('ic_year') . "' and s.provisional_admission !='Y' and  " . $cond . " " . $stdc . " " . $cond1 . " ";
        $query = $this->db->query($sql);
        //  echo $this->db->last_query();exit;
        $res = $query->result_array();
        return $res;
    }
    function get_student_by_staffreff($row)
    {
        $cond = "s.executive_id='" . $row['reff'] . "' and ih.institute = '" . $row['institute'] . "' ";

        $sql = "SELECT distinct s.id,s.landmark,s.provisional_admission,s.city_name,s.state_id,sm.standard_id,s.event_code,ih.institute,s.student_name,s.mobile1,s.stream_name,sm.standard_name ,s.created_by,s.created_date,s.lead_assign
                FROM student_meet_details  s
                
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard
            LEFT JOIN inhouse_staff_details ih ON ih.staff_id=s.executive_id
                left join calling_log_details ca on ca.student_id=s.id               
                WHERE s.provisional_admission!='Y' and  " . $cond . "  ";
        $query = $this->db->query($sql);
        //echo $this->db->last_query();exit;
        $res = $query->result_array();
        return $res;
    }
    function get_stud_details($std)
    {
        $sql = "SELECT id,mobile1,email from student_meet_details where id= '" . $std . "' ";
        $query = $this->db->query($sql);
        return $query->result_array();
    }
    function insert_sms_log($row)
    {
        $data['mobile_no'] = $row['smob'];
        $data['message'] = (stripcslashes($row['message']));
        $data['sent_on'] = date('Y-m-d H:i:s');
        $data['status'] = $row['st'];
        $data['message_by'] = 'SMS';
        $data['sent_by'] = $this->session->userdata('name');
        $this->db->insert('promotional_activity_status', $data);
        $insert_id = $this->db->insert_id();
        return $insert_id;
    }
    function check_staff_reff($nam)
    {
        $this->db->select("*");
        $this->db->from('inhouse_staff_details');
        $this->db->where('staff_id', $nam);

        $query = $this->db->get();
        $res = $query->result_array();
        //echo $this->db->last_query();  exit();
        return $res;
    }
    function check_staff_reff_count($nam)
    {
        $this->db->select("id");
        $this->db->from('inhouse_staff_details');
        $this->db->where('staff_id', $nam);

        $query = $this->db->get();
        $res = $query->result_array();
        //echo $this->db->last_query();  exit();
        return $res;
    }
    // fetching latest calling remark by student id
    function get_calling_remark1($lid)
    {
        $sql = "SELECT seminar_feedback,c_id,student_id,mobile_no,called_by,called_on,calling_status,remark,ld_id from calling_log_details where ld_id = '" . $lid . "' ";
        //exit;max(c_id) as
        $query = $this->db->query($sql);
        return $query->result_array();
    }

    function get_ic_members($ic = '')
    {

        $ic_c = '';


        if (!empty($ic)) {
            $ic_c = " and iu.ic_code = '" . $ic . "'";
        }
        $sql = "SELECT iu.*,rm.roles_type,um.um_id from ic_user_master iu  join user_master um on um.employee_code=iu.employee_code  join roles_master rm on iu.user_type_id=rm.roles_id where iu.status='Y' $ic_c and um.status='Y'

		 and iu.status='Y'  group by  um.um_id ";

        $query = $this->db->query($sql);

        return $query->result_array();
    }

    function get_ic_members_consultant_head($ic)
    {
        $sql = "SELECT iu.*,rm.roles_type,um.um_id from ic_user_master iu left join user_master um on um.employee_code=iu.employee_code 
		 left join roles_master rm on iu.user_type_id=rm.roles_id where iu.status='Y' and um.ic_code = '" . $ic . "' and um.status='Y'  ";
        $query = $this->db->query($sql);

        return $query->result_array();
    }



    function get_ic_members1($ic)
    {
        $sql = "SELECT iu.*,rm.roles_type,um.um_id from ic_user_master iu left join user_master um on um.employee_code=iu.employee_code left join roles_master rm on iu.user_type_id=rm.roles_id where iu.status='Y' and iu.ic_code = '" . $ic . "' and rm.roles_id IN (4,8)  ";

        $query = $this->db->query($sql);
        return $query->result_array();
    }

    function get_ic_calling_user_members()
    {
        $ic = $this->session->userdata('ic_code');
        if (empty($ic)) {
            $con = '';
        } else {
            $con = "and ic_code = '" . $ic . "'";
        }
        $sql = "SELECT * from ic_user_master where status='Y' and user_type_id = '2' $con  ";
        $query = $this->db->query($sql);
        return $query->result_array();
    }
    function get_ic_members_byid($un)
    {
        $sql = "SELECT * from ic_user_master where status='Y' and username = '" . $un . "'  ";
        $query = $this->db->query($sql);
        return $query->result_array();
    }
    function get_ic_members_byid_for_calling($un)
    {
        $sql = "SELECT * from ic_user_master i join user_master u on i.username=u.username where i.status='Y' and u.um_id = '" . $un . "'  ";
        $query = $this->db->query($sql);
        return $query->result_array();
    }
    function get_ic_members_byumid($un)
    {
        $sql = "SELECT * from ic_users where status='Y' and um_id = '" . $un . "'  ";
        $query = $this->db->query($sql);
        return $query->result_array();
    }
    function assign_lead_to_members_new($data)
    {
        // print_r($data);exit;

        $esid = explode(',', $data['sid']);
        foreach ($esid as $sid) {
            $arr['academic_year'] = $this->config->item('ic_year');
            $arr['calling_event'] = $data['calling_event'];
            $arr['stud_id'] = $sid;
            $arr['lead_assign'] = $data['memid'];
            $arr['lead_assign_on'] = date('Y-m-d H:i:s');
            $arr['lead_assign_by'] = $this->session->userdata('uid');
            $get_bdm_ids = "lead_assign Not IN (select distinct user_id from citymappingwitusers )  ";
            $get_tcaller_ids = "lead_assign Not IN (3414 )  ";
            $this->db->select('*');
            $this->db->from('lead_assign_details');
            $this->db->where('stud_id', $arr['stud_id']);
            $this->db->where('active', 'Y');
            $this->db->where($get_bdm_ids);
            $this->db->where($get_tcaller_ids);
            $is_already_assign = $this->db->get()->row();
            //$this->db->where('');

            /* $is_already_assign= $this->db->get_where('lead_assign_details',
		  array('stud_id'=>$arr['stud_id'],'lead_assign !='=>3414,'active'=>'Y'
		  
		  
		  ))->row();*/



            if (empty($is_already_assign)) {
                $ins = $this->db->insert('lead_assign_details', $arr);
                $arrs['lead_assign_status'] = 'Y';
                $this->db->where('id', $sid);
                $upd = $this->db->update('student_meet_details', $arrs);
            }
        }

        return $ins;
    }
    function assign_lead_to_members($data)
    {
        //print_r($data);exit;
        $esid = explode(',', $data['sid']);
        foreach ($esid as $sid) {
            $arr['lead_assign'] = $data['memid'];
            $arr['lead_assign_on'] = date('Y-m-d H:i:s');
            $arr['lead_assign_by'] = $this->session->userdata('name');
            $this->db->where('id', $sid);
            $upd = $this->db->update('student_meet_details', $arr);
        }
        return $upd;
    }
    function user_assign_call_list()
    {
        $user_id = $this->session->userdata('name');
        $ic = $this->session->userdata('ic_code');
        $sql = "SELECT s.id,s.student_name,s.mobile1,s.mobile1_valid,s.mobile1_status,s.lead_assign,s.landmark,cm.city_name,
CASE WHEN i.ic_name IS NULL THEN s.utm_source ELSE i.ic_name END AS ic_name,
CASE WHEN p.sprogramm_acro IS NULL THEN s.programme_status ELSE p.sprogramm_acro  END AS course,
st.stream_name,sm.standard_name
 FROM  student_meet_details as s 
LEFT JOIN ic_registration i ON i.ic_code=s.ic_code
LEFT JOIN sandipun_univerdb.school_programs_new p ON p.sp_id=s.programme_id
LEFT JOIN stream_master st ON st.stream_id=s.stream
LEFT JOIN standard_master sm ON sm.standard_id=s.standard
LEFT JOIN city_master cm ON cm.city_id=s.city_id
  WHERE  s.mobile1_status IS NULL and   s.lead_assign = '" . $user_id . "'   
";
        $query = $this->db->query($sql);
        // echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }

    function get_user_call_cnt($data)
    {
        $user_id = $this->session->userdata('name');

        if (!empty($data['fdate']) && !empty($data['tdate'])) {
            $dt = "  DATE(c.called_on) >= '" . date('Y-m-d', strtotime($data['fdate'])) . "'  AND DATE(c.called_on) <= '" . date('Y-m-d', strtotime($data['tdate'])) . "' ";
        } else {
            $dt = " DATE(c.called_on) = '" . date('Y-m-d') . "' ";
        }



        //             $sql="SELECT s.id,s.utm_source,s.provisional_admission,
        // CASE WHEN i.ic_name IS NULL THEN s.utm_source ELSE i.ic_name END AS ic_name,
        // SUM(CASE WHEN (s.mobile1_status = 'ADMISSION-TAKEN' OR s.provisional_admission='Y') THEN 1 ELSE 0 END) AS ADDTAKEN , 
        // SUM(CASE WHEN s.mobile1_status = 'SUCCESS' THEN 1 ELSE 0 END) AS SUCCESS , 
        // SUM(CASE WHEN s.mobile1_status = 'INTERESTED' THEN 1 ELSE 0 END) AS INTRT , 
        // SUM(CASE WHEN s.mobile1_status = 'NOT-INTERESTED' THEN 1 ELSE 0 END) AS NINTRT, 
        // SUM(CASE WHEN s.mobile1_status = 'CALL-LATER' THEN 1 ELSE 0 END) AS CALLLATER, 
        // SUM(CASE WHEN s.mobile1_status is NOT NULL THEN 1 ELSE 0 END) AS TCALL,
        // SUM(CASE WHEN s.mobile1_status is NULL THEN 1 ELSE 0 END) AS UNCALL,
        // SUM(CASE WHEN s.lead_assign = '".$user_id."' THEN 1 ELSE 0 END) AS LASSIGN ,s.ic_code   
        // FROM student_meet_details as s LEFT JOIN ic_registration i ON i.ic_code=s.ic_code 
        // LEFT JOIN calling_log_details c ON c.student_id=s.id AND c.called_by=s.lead_assign
        // where s.lead_assign = '".$user_id."' and c.called_by = '".$user_id."' and $dt group by s.ic_code,s.utm_source";


        $sql = "SELECT s.id,s.utm_source,s.provisional_admission,
    CASE WHEN i.ic_name IS NULL THEN s.utm_source ELSE i.ic_name END AS ic_name,
    SUM(CASE WHEN (s.mobile1_status = 'ADMISSION-TAKEN' OR s.provisional_admission='Y') THEN 1 ELSE 0 END) AS ADDTAKEN , 
    SUM(CASE WHEN s.mobile1_status = 'SUCCESS' THEN 1 ELSE 0 END) AS SUCCESS , 
    SUM(CASE WHEN s.mobile1_status = 'INTERESTED' THEN 1 ELSE 0 END) AS INTRT , 
    SUM(CASE WHEN s.mobile1_status = 'NOT-INTERESTED' THEN 1 ELSE 0 END) AS NINTRT, 
    SUM(CASE WHEN s.mobile1_status = 'CALL-LATER' THEN 1 ELSE 0 END) AS CALLLATER, 
    SUM(CASE WHEN s.mobile1_status is NOT NULL THEN 1 ELSE 0 END) AS TCALL,
    SUM(CASE WHEN s.mobile1_status is NULL THEN 1 ELSE 0 END) AS UNCALL,
    SUM(CASE WHEN s.lead_assign = '" . $user_id . "' THEN 1 ELSE 0 END) AS LASSIGN ,s.ic_code   
    FROM student_meet_details as s LEFT JOIN ic_registration i ON i.ic_code=s.ic_code 
    LEFT JOIN (SELECT  MAX(c_id),student_id,mobile_no,called_by,called_on,calling_status,remark,seminar_feedback,sujee_feedback FROM calling_log_details GROUP BY student_id)c ON c.student_id=s.id
 AND c.called_by=s.lead_assign
    where s.lead_assign = '" . $user_id . "' and c.called_by = '" . $user_id . "' and $dt group by s.ic_code,s.utm_source";

        $query = $this->db->query($sql);
        //echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }
    function user_today_call_list()
    {
        $user_id = $this->session->userdata('name');
        if ($user_id == "superadmin" || $user_id == "admin" || $user_id == "1158") {
            $cond = " ";
        } else {
            $cond = "and c.called_by='" . $user_id . "'";
        }


        $sql = "SELECT  s.id ,c.student_id,s.student_name,s.mobile1_valid,c.mobile_no AS mobile1,c.called_by,c.called_on,DATE(c.called_on) AS call_date, c.calling_status,c.Course_Interested , s.mobile1_status,c.remark,
CASE WHEN i.ic_name IS NULL THEN s.utm_source ELSE i.ic_name END AS ic_name,
CASE WHEN p.sprogramm_acro IS NULL THEN s.programme_status ELSE p.sprogramm_acro  END AS course,
st.stream_name,sm.standard_name,CASE WHEN ct.city_name IS NULL THEN s.landmark ELSE ct.city_name END AS city
FROM  calling_log_details c 
LEFT JOIN student_meet_details s ON s.id=c.student_id 
LEFT JOIN ic_registration i ON i.ic_code=s.ic_code
LEFT JOIN sandipun_univerdb.school_programs_new p ON p.sp_id=s.programme_id
LEFT JOIN stream_master st ON st.stream_id=s.stream
LEFT JOIN standard_master sm ON sm.standard_id=s.standard
LEFT JOIN city_master ct ON ct.city_id=s.city_id
  WHERE  DATE(c.called_on) = '" . date('Y-m-d') . "' " . $cond . " 
order by c.called_on desc";
        $query = $this->db->query($sql);
        // echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }
    function user_today_call_list_new($evt)
    {
        $user_id = $this->session->userdata('name');
        if ($user_id == "superadmin" || $user_id == "admin" || $user_id == "1158") {
            $cond = " ";
        } else {
            $cond = "and c.called_by='" . $user_id . "'";
        }


        $sql = "SELECT  ld.id,s.id as std_id,c.student_id,s.student_name,s.mobile1_valid,c.mobile_no AS mobile1,c.called_by as call_callby,c.called_on ,DATE(c.called_on) AS call_date, c.calling_status as call_status ,c.Course_Interested, s.mobile1_status,c.remark as call_remark,ld.calling_event,
CASE WHEN i.ic_name IS NULL THEN s.utm_source ELSE i.ic_name END AS ic_name,
p.course,
st.stream_name,sm.standard_name,CASE WHEN ct.city_name IS NULL THEN s.landmark ELSE ct.city_name END AS city
FROM  calling_log_details c 
left join lead_assign_details as ld On ld.id = c.ld_id
LEFT JOIN student_meet_details s ON s.id=c.student_id 
LEFT JOIN ic_registration i ON i.ic_code=s.ic_code
LEFT JOIN school_course p ON s.course_walkin=p.course_id
LEFT JOIN stream_master st ON st.stream_id=s.stream
LEFT JOIN standard_master sm ON sm.standard_id=s.standard
LEFT JOIN city_master ct ON ct.city_id=s.city_id
  WHERE ld.calling_event='" . $evt . "' and DATE(c.called_on) = '" . date('Y-m-d') . "' " . $cond . " 
order by c.called_on desc";
        $query = $this->db->query($sql);
        // echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }

    function user_today_call_list_all($evt)
    {
        $user_id = $this->session->userdata('uid');
        $academic_year = ACADEMIC_YEAR;
        if ($user_id == "superadmin" || $user_id == "admin" || $user_id == "1158") {
            $cond = " ";
        } else {
            $cond = "and c.called_by='" . $user_id . "'";
        }
        $nts = " and (nts IS NULL oR nts =0) ";

        $sql = "SELECT  ld.id,s.id as std_id,c.student_id,s.student_name,s.mobile1_valid,s.whatsappno,s.pmobile_no,s.pwhatsapp_no,c.mobile_no AS mobile1,c.called_by as call_callby,c.called_on ,DATE(c.called_on) AS call_date, s.latest_calling_status as call_status ,c.Course_Interested, c.remark as call_remark,ld.calling_event,
CASE WHEN i.ic_name IS NULL THEN s.utm_source ELSE i.ic_name END AS ic_name,
s.stream_name,sm.standard_name, s.city_name AS city
FROM  calling_log_details c 
left join lead_assign_details as ld On ld.id = c.ld_id
LEFT JOIN student_meet_details s ON s.id=c.student_id 
LEFT JOIN ic_registration i ON i.ic_code=s.ic_code
LEFT JOIN standard_master sm ON sm.standard_id=s.standard
  WHERE  DATE(c.called_on) = '" . date('Y-m-d') . "' " . $cond . "  $nts and s.academic_year='$academic_year'
order by c.called_on desc";
        $query = $this->db->query($sql);
        // echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }

    function user_today_call_list_all_unique($evt)
    {
        $user_id = $this->session->userdata('uid');
        $academic_year = ACADEMIC_YEAR;
        if ($user_id == "superadmin" || $user_id == "admin" || $user_id == "1158") {
            $cond = " ";
        } else {
            $cond = "and c.called_by='" . $user_id . "'";
        }

        $nts = " and (nts IS NULL oR nts =0) ";
        $sql = "SELECT  ld.id,s.id as std_id,c.student_id,s.student_name,s.mobile1_valid,s.whatsappno,s.pmobile_no,s.pwhatsapp_no,c.mobile_no AS mobile1,c.called_by as call_callby,c.called_on ,DATE(c.called_on) AS call_date, s.latest_calling_status as call_status ,c.Course_Interested, c.remark as call_remark,ld.calling_event,
CASE WHEN i.ic_name IS NULL THEN s.utm_source ELSE i.ic_name END AS ic_name,
s.stream_name,sm.standard_name, s.city_name AS city
FROM  calling_log_details c 
left join lead_assign_details as ld On ld.id = c.ld_id
LEFT JOIN student_meet_details s ON s.id=c.student_id 
LEFT JOIN ic_registration i ON i.ic_code=s.ic_code
LEFT JOIN standard_master sm ON sm.standard_id=s.standard
  WHERE  DATE(c.called_on) = '" . date('Y-m-d') . "' " . $cond . " $nts and s.academic_year='$academic_year'  group by s.id
order by c.called_on desc";
        $query = $this->db->query($sql);
        // echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }




    function get_followup()
    {
        $user_id = $this->session->userdata('uid');
        $current_date = date('Y-m-d', strtotime('-5 days'));
        $academic_year = ACADEMIC_YEAR;


        $query = "SELECT c.conve_time,s.admission_form_taken,ld.calling_status AS lcalling_status,ld.lead_assign,
        ld.calling_event,
s.provisional_admission,ld.id, s.id AS std_id,s.exam_id,s.student_name,s.mobile1_valid,s.mobile1,
 CASE WHEN i.ic_name IS NULL THEN s.utm_source ELSE i.ic_name END AS ic_name FROM lead_assign_details AS ld 
INNER JOIN student_meet_details s ON ld.stud_id=s.id 
LEFT JOIN calling_log_details c ON ld.stud_id = c.student_id AND UNIX_TIMESTAMP(c.conve_time) !=0
LEFT JOIN ic_registration i ON s.ic_code=i.ic_code 
JOIN (SELECT MAX(c.c_id) AS c_id FROM calling_log_details AS c,lead_assign_details AS lds 
WHERE c.student_id=lds.stud_id AND UNIX_TIMESTAMP(c.conve_time) !=0 AND lds.lead_assign = '$user_id' 
GROUP BY c.student_id) maxx ON c.c_id = maxx.c_id WHERE ld.calling_status IS NOT NULL 
AND  DATE(c.conve_time) > '$current_date' AND ld.active='Y' AND ld.lead_assign='$user_id'
 AND s.student_name IS NOT NULL 
 and s.academic_year='$academic_year'
 
 GROUP BY ld.stud_id ORDER BY ld.called_on DESC";

        $result = $this->db->query($query);
        // echo $this->db->last_query();exit;
        $res = $result->result_array();
        return $res;
    }

    function get_followupunique()
    {
        $user_id = $this->session->userdata('uid');
        $current_date = date('Y-m-d', strtotime('-5 days'));



        $query = "SELECT c.conve_time,s.admission_form_taken,ld.calling_status AS lcalling_status,ld.lead_assign,
        ld.calling_event,
s.provisional_admission,ld.id, s.id AS std_id,s.exam_id,s.student_name,s.mobile1_valid,s.mobile1,
 CASE WHEN i.ic_name IS NULL THEN s.utm_source ELSE i.ic_name END AS ic_name FROM lead_assign_details AS ld 
INNER JOIN student_meet_details s ON ld.stud_id=s.id 
LEFT JOIN calling_log_details c ON ld.stud_id = c.student_id AND UNIX_TIMESTAMP(c.conve_time) !=0
LEFT JOIN ic_registration i ON s.ic_code=i.ic_code 
JOIN (SELECT MAX(c.c_id) AS c_id FROM calling_log_details AS c,lead_assign_details AS lds 
WHERE c.ld_id=lds.id AND UNIX_TIMESTAMP(c.conve_time) !=0 AND lds.lead_assign = '$user_id' 
GROUP BY c.student_id) maxx ON c.c_id = maxx.c_id WHERE ld.calling_status IS NOT NULL 
AND  DATE(c.conve_time) > '$current_date' AND ld.active='Y' AND ld.lead_assign='$user_id'
 AND s.student_name IS NOT NULL GROUP BY s.id ORDER BY ld.called_on DESC";
        //exit;
        $result = $this->db->query($query);
        // echo $this->db->last_query();exit;
        $res = $result->result_array();
        return $res;
    }

    //modified
    function get_interested_call_list()
    {
        $user_id = $this->session->userdata('name');
        if ($user_id == "superadmin" || $user_id == "admin" || $user_id == "1158") {
            $cond = " ";
        } else {
            // $cond="and c.called_by='". $user_id ."'";
            $cond = "and s.lead_assign='" . $user_id . "'";
        }
        $sql = "SELECT s.admission_form_taken,s.provisional_admission,s.id,c.student_id,s.exam_id,s.student_name,s.mobile1_valid,c.mobile_no as mobile1,c.conve_time,c.called_by,c.called_on,DATE(c.called_on) AS call_date, c.calling_status ,c.Course_Interested, s.mobile1_status,c.remark,c.visite_ic_code,c.visite_date,c.conve_time,
        CASE WHEN i.ic_name IS NULL THEN s.utm_source ELSE i.ic_name END AS ic_name,
        CASE WHEN p.sprogramm_acro IS NULL THEN s.programme_status ELSE p.sprogramm_acro  END AS course,
        st.stream_name,sm.standard_name,case when ct.city_name is null then s.landmark else ct.city_name end as city FROM `student_meet_details` s 
        left join calling_log_details c on c.student_id =s.id
        JOIN (SELECT MAX(c_id) AS c_id FROM calling_log_details GROUP BY mobile_no) max ON c.c_id = max.c_id 
        LEFT JOIN ic_registration i ON i.ic_code=s.ic_code
        LEFT JOIN sandipun_univerdb.school_programs_new p ON p.sp_id=s.programme_id
        LEFT JOIN stream_master st ON st.stream_id=s.stream
        LEFT JOIN standard_master sm ON sm.standard_id=s.standard
        left join city_master ct on ct.city_id=s.city_id
        where c.calling_status!=''  " . $cond . " AND s.student_name IS NOT NULL group by c.student_id,c.mobile_no,c.called_by order by c.called_on desc";
        $query = $this->db->query($sql);
        // echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }
    function get_cap_student_data($id = '')
    {
        if ($id != '') {
            $wh = 'and cap_id = "' . $id . '"';
        }
        $sql = "select * from cap_student_data where mobile is null " . $wh;
        $query = $this->db->query($sql);
        // echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }
    function get_search_data($sdata)
    {
        $sql = "SELECT s.mobile1,s.student_name,ct.city_name FROM student_meet_details s 
LEFT JOIN city_master ct ON ct.city_id=s.city_id WHERE s.student_name LIKE  '%" . $sdata . "%'
UNION 
SELECT mobile AS mobile1,student_name,'' AS city_name FROM other_source_data WHERE student_name LIKE '%" . $sdata . "%'
";
        $query = $this->db->query($sql);
        // echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }
    function update_data($data)
    {
        $arr['mobile'] = $data['mob'];

        $this->db->where('cap_id', $data['cid']);
        return $upd = $this->db->update('cap_student_data', $arr);
    }
    function add_mock_registration($data)
    {
        //print_r($data);exit;
        $sdata['ic_code'] = $data['ic_code'];
        $sdata['event_code'] = 'EV/MOCK-19';
        $sdata['student_name'] = $data['student_name'];
        $sdata['dob'] = date('Y-m-d', strtotime($data['dob']));
        $sdata['email'] = $data['email'];
        $sdata['gender'] = $data['gender'];
        $sdata['mobile1'] = $data['mobile1'];
        $sdata['landmark'] = $data['landmark'];
        $sdata['state_id'] = $data['state'];
        $sdata['city_id'] = $data['city'];
        $sdata['institute_id'] = $data['institute'];
        $sdata['exam_per_date'] = date('Y-m-d', strtotime($data['exam_date']));

        $sdata['exam_id'] = $data['exam_name'];
        $sdata['exam_id_org'] = $data['exam_name'];
        $sdata['academic_year'] = '2019-20';
        $sdata['created_by'] = $this->session->userdata('uid');
        $sdata['created_date'] = date('Y-m-d H:i:s');
        $this->db->insert('student_meet_details', $sdata);
        return  $insert_id = $this->db->insert_id();
    }
    function get_mock_studentlist()
    {
        $user_id = $this->session->userdata('name');
        $uid = $this->session->userdata('uid');
        if ($user_id == "superadmin" || $user_id == "admin") {
            $cond = " ";
        } else {
            $cond = "and created_by='" . $uid . "'";
        }
        $sql = "SELECT student_name,email,mobile1,mobile2,id FROM student_meet_details 
       WHERE  academic_year='" . $this->config->item('ic_year') . "' and event_code= 'EV/MOCK-19'  $cond";
        $query = $this->db->query($sql);
        // echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }
    function get_mock_student_details($sid)
    {
        $sql = "SELECT id,ic_code,student_name,gender,dob,mobile1,email,landmark,state_id,exam_id FROM student_meet_details 
       WHERE  id = '" . $sid . "' ";
        $query = $this->db->query($sql);
        // echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }


    function update_mock_student($data)
    {
        //print_r($data);exit;
        $sdata['ic_code'] = $data['ic_code'];
        // $sdata['event_code'] = 'EV/MOCK-19'; 
        $sdata['student_name'] = $data['student_name'];
        $sdata['dob'] = date('Y-m-d', strtotime($data['dob']));
        $sdata['email'] = $data['email'];
        $sdata['gender'] = $data['gender'];
        $sdata['mobile1'] = $data['mobile1'];
        $sdata['exam_id'] = $data['exam_name'];
        $sdata['exam_id_org'] = $data['exam_name'];

        $sdata['updated_by'] = $this->session->userdata('uid');
        $sdata['updated_date'] = date('Y-m-d H:i:s');
        $this->db->where('id', $data['studentId']);
        $uid = $this->db->update('student_meet_details', $sdata);
        return  $uid;
    }


    function meet_to_reg()
    {
        exit;
        $sql = "SELECT * FROM `student_meet_details` where ic_code='SU_MH_001' and exam_id in(6,7,8,2,10) and academic_year='2019-20' ORDER BY id ";
        $query = $this->db->query($sql);
        // echo $this->db->last_query();
        $res = $query->result_array();
        foreach ($res as $data) {

            $incr_no1 = $this->get_max_regno();

            $str = $incr_no1[0]['reg_no'];
            if ($str != '') {
                $str = substr($str, 4);
            } else {
                $str = '00000';
            }
            //echo "<br>";
            $reg = $str + 1;
            //echo "<br>";
            $jexam = str_pad($data['exam_id'], 2, "0", STR_PAD_LEFT);

            $incr_no = str_pad($reg, 5, "0", STR_PAD_LEFT);
            $reg_no = '19' . $jexam . '' . $incr_no; //

            $sdata['reg_id'] = $data['id'];
            // $sdata['event_code'] = 'EV/MOCK-19'; 
            $sdata['reg_no'] = $reg_no;
            $sdata['exam_no'] = $data['exam_id'];
            $sdata['exam_type'] = "OF";
            $sdata['academic_year'] = "2019-20";
            $sdata['exam_date'] = "2018-12-22";
            echo $incr_no . "<br>";
            // exit();
            // $this->db->insert('su_jee_registration', $sdata);       


        }

        return $res;
    }

    function get_max_regno()
    {

        $sql = "select reg_no from su_jee_registration where sujee_id = (select max(sujee_id) FROM su_jee_registration) ";
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        //echo $this->db->last_query();exit;
        return $result;
    }

    function get_all_countries()
    {
        $sql = "select * from countries where 1 ";
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        //echo $this->db->last_query();exit;
        return $result;
    }

    function get_state_bycountry($cid)
    {
        $sql = "select * from states where country_id = '" . $cid . "' ";
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        //echo $this->db->last_query();exit;
        return $result;
    }
    function get_city_bystate($sid)
    {
        $sql = "select * from cities where state_id = '" . $sid . "' ";
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        //echo $this->db->last_query();exit;
        return $result;
    }
    function get_exam_byid($cid)
    {
        $sql = "select * from exam_master where exam_id = '" . $cid . "' ";
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        //echo $this->db->last_query();exit;
        return $result;
    }

    function insert_cons_call_center_details($data, $pic, $docic, $bank_name)
    {


        $role_id = $this->session->userdata("role_id");
        $carr['ic_code'] = $_SESSION['ic_code'];
        $carr['counselor_type'] = $data['counselor_type'];
        $carr['dob'] = $data['sdate'];
        $carr['gender'] = $data['gender'];
        $wano = $data['whatsapp_no'];
        if ($wano == 1) {
            $carr['whatsapp_no'] = $data['mob_no'];
        } else if ($wano == 2) {
            $carr['whatsapp_no'] = $data['official_no'];
        }
        //$carr['whatsapp_no'] = $data['whatsapp_no'];
        $carr['prefered_loc'] = (stripcslashes($data['paddress']));
        $carr['photo'] = $pic;
        $carr['scan_copy'] = $bank_name;
        $carr['employee_code'] = $data['employee_code'];
        $carr['bkname'] = $data['bkname'];
        $carr['ifsc'] = $data['ifsc'];
        $carr['branch'] = $data['branch'];
        $carr['co_reff_by'] = (($data['co_reff_ic']));
        $carr['institute_name'] = (stripcslashes($data['institute_name']));
        $carr['contact_person'] = $data['contact_person'] . ' ' . $data['Middle_Name'] . ' ' . $data['Last_Name'];
        $carr['address'] = (stripcslashes($data['address']));
        $carr['isdno'] = (stripcslashes($data['isdno']));
        $carr['mobile_no'] = $data['mob_no'];
        $carr['adharcard'] = $data['Adharcard'];
        $carr['pancard'] = $data['Pancard'];
        $carr['consultant_head'] = $data['consultant_head'];
        $carr['preferablecampus'] = $data['preferablecampus'];
        $carr['official_no'] = $data['official_no'];
        $carr['country_id'] = $data['country_id'];
        $carr['state_id'] = $data['state'];
        $carr['city_id'] = $data['city'];
        $carr['email'] = (($data['email']));
        $carr['official_email'] = (($data['official_email']));
        $carr['website'] = (($data['website']));
        $carr['remark'] = (($data['remark'])); //(stripcslashes($data['remark']));
        $carr['inserted_by'] = $this->session->userdata('uid');
        $carr['inserted_date'] = date('Y-m-d H:i:s');
        $carr['transf_con_id'] = $data['transf_con_id'];
        $carr['adm_regular'] = $data['ranod'];
        $carr['adm_part'] = $data['panod'];
        $carr['inserted_iccode'] = $_SESSION['ic_code'];
        $carr['acname'] = $data['acname'];
        $carr['acno'] = $data['acno'];
        $carr['is_fou'] = $data['is_fou'];
        $carr['academic_year'] =  $data['academic_year'];
        $carr['passport'] = $data['passport'];
        $carr['organisation_type'] = $data['type'];
        $carr['co_reff_by'] =  $data['co_reff_ic'];
        $this->db->insert('consultants_call_details', $carr);
        $insert_id = $this->db->insert_id();

        if (!empty($docic)) {
            foreach ($docic as $key => $value) {
                $darr['cid'] = $insert_id;
                $darr['document_name'] = $value['file_name'];
                $darr['inserted_by'] = $this->session->userdata('uid');
                $darr['inserted_date'] = date('Y-m-d h:i:s');
                $this->db->insert('consultants_document_list', $darr);
            }
        }
        $arr['con_id'] = $insert_id;
        $arr['adm_type'] = 'f';
        $arr['fixed_amt'] = $data['other_per'];
        $arr['fixed_remark'] = $data['other_remark'];
        /*if($data['adm_rem']=='f'){
$arr['fixed_amt'] = $data['other_per'];
$arr['fixed_remark'] = $data['other_remark'];
}else{
$arr['first_amt']= $data['first_per'];
$arr['second_amt'] = $data['second_per'];
$arr['thired_amt'] = $data['third_per'];
}*/
        $arr['inserted_by'] = $this->session->userdata('uid');
        $arr['inserted_date'] = date('Y-m-d h:i:s');
        $this->db->insert('consultant_admission_remuneration', $arr);

        if (!empty($data['preferrable_location'])) {

            foreach ($data['preferrable_location'] as $row) {
                $city_array = $row['city'];
                foreach ($city_array as $row1) {
                    $arrs['consultant_id'] = $insert_id;
                    $arrs['country'] = $row['country'];
                    $arrs['state'] =  $row['state'];
                    $arrs['city'] =  $row1;
                    $arrs['inserted_by'] = $this->session->userdata('uid');
                    $arrs['inserted_date'] = date('Y-m-d h:i:s');
                    $this->db->insert('consultant_preferrable_location', $arrs);
                }
            }
        }



        return $insert_id;
    }
    public  function getUserRegsIDcul($data)
    {
        $regid = 'CO_CL';
        $random_id_length = 4;
        $this->db->select_max('id', 'max_no');
        $query = $this->db->get('consultants_call_details');
        $ret = $query->row();
        $max_id = ($ret->max_no) + 1;
        $rnd_id = str_pad($max_id, $random_id_length, '0', STR_PAD_LEFT);
        //$current_yr=date("Y");
        return $regid . '_' . $rnd_id;
    }
    public function get_all_consultants_call_details()
    {
        $role_id = $this->session->userdata("role_id");
        //echo $role_id; 
        //echo "dssd";
        //exit;
        if ($role_id != '1' && $role_id != '16') {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "' ";
        }
        if ($role_id != '1' && $role_id == '7') {
            $wh = " and c.ic_code='" . $this->session->userdata("ic_code") . "' ";
        } else if ($role_id == 16) {
            $wh = " and ( c.consultant_head='" . $this->session->userdata('uid') . "')  ";
        } else {
            $wh = '';
        }
        $sql = "select c.*,u.um_id,s.name as state_name,ct.name as city_name,rm.roles_name from consultants_call_details as c
LEFT join states as s on c.state_id=s.id
left join cities as ct on c.city_id=ct.id
join user_master u on c.id=u.con_id
inner join user_master as um ON um.con_id = c.id
inner join roles_master as rm ON rm.roles_id=um.roles_id
          where c.status='Y' $wh order by c.contact_person ";
        $query  = $this->db->query($sql);
        $result = $query->result_array();

        return $result;
    }


    public function get_all_consultants_fou_list($data, $cid = "")
    {

        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        if (!empty($data['coid']) && $data['coid'] != '') {
            $wco = ' and c.country_id = "' . $data['coid'] . '"';
        }
        if (!empty($data['sid']) && $data['sid'] != '') {
            $ws = ' and c.state_id = "' . $data['sid'] . '"';
        }
        if (!empty($data['cid']) && $data['cid'] != '') {
            $wc = ' and c.city_id = "' . $data['cid'] . '"';
        }
        if (!empty($data['rid']) && $data['rid'] != '') {
            $rd = ' and um.roles_id = "' . $data['rid'] . '"';
        }
        if (!empty($data['rfid']) && $data['rfid'] != '') {

            $rfd1 = ' and c.co_reff_by = "' . $data['rfid'] . '"';
        }

        if (!empty($data['consultant']) && $data['consultant'] != '') {

            $rfd11 = ' and um.um_id = "' . $data['consultant'] . '"';
        }
        $c = "";
        if (!empty($data['academic_year']) && $data['academic_year'] != '') {
            $rfd = ' and c.academic_year = "' . $data['academic_year'] . '"';
            $c = $data['academic_year'];
        } elseif ($cid != '') {
            $cyear = $this->config->item('current_year');
            $rfd = " and c.academic_year = '$cyear' and sm.remark='Consultant Upload'";
            $c = $cyear;
        } else {
            $cyear = $this->config->item('current_year');
            $rfd = ' and c.academic_year = "$cyear"';
            $c = $cyear;
        }
        $c = explode('-', $c);
        $c = $c[0];
        $ci = 'sandipun_ums.enquiry_student_master.academic_year="' . $c . '"';
        $rfd = '';




        if ($role_id == '1' || $role_id == '30') {

            $wh = "and (c.counselor_type='FOU' or c.counselor_type='CL')";

            if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != 'undefined') {
                $wh1 = " and c.ic_code='" . $data['icfilter'] . "'";
            }
        }
        //|| ($role_id =='7') 
        else if (($role_id == '8' || $role_id == 7) && $uid != 429) {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if (($role_id == '8' || $role_id == 7)  && $uid == 429) {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and (c.ic_code='" . $this->session->userdata('ic_code') . "')";
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;

            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";

            $referred_by = $this->db->query("select COALESCE(group_concat(cordinator_id),0) as cordinator_id
         from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;



            $wh =  " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by) ) ";
        } else if ($role_id == 16) {
            $wh = " and ( c.consultant_head='" . $this->session->userdata('uid') . "' )  ";
        } else {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "'";
        }
        $cii = '';
        if ($cid != '') {
            $cii = " and um.um_id = $cid ";
        }
        if ($data['academic_year'] = '2019-20') {
            $sql = ("select consultants_call_details.contact_person,user_master.um_id from consultants_call_details join user_master on consultants_call_details.id=user_master.con_id
join student_meet_details on student_meet_details.created_by=user_master.um_id where student_meet_details.remark='Consultant Upload'
and student_meet_details.academic_year='2019-20'
 group by user_master.um_id order by consultants_call_details.contact_person asc ");
        } else {
            $counseler_id_in = " and  um.um_id in (select group_concat(DISTINCT(sandipun_ums.enquiry_student_master.created_by)) from sandipun_ums.enquiry_student_master where is_from_consultant=1 and $ci)";
            $sql = "select c.*,um.roles_id,rm.roles_name,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id from
        

		 consultants_call_details as c 
		 
		 
inner join user_master as um ON um.con_id = c.id and c.status='Y'
  inner join roles_master as rm ON rm.roles_id=um.roles_id
left join states as s on c.state_id = s.id
left join cities as ci ON ci.id=c.city_id


          where c.status='Y' and  c.counselor_type != 'NULL'  $wco $ws $wc $rd $rfd $rfd1 $wh $wh1 $rfd11 $cii  group by c.id order by c.contact_person";
        }

        $query  = $this->db->query($sql);
        $result = $query->result_array();

        return $result;
    }




    public function get_all_consultants_fou_list_new_for_erp($data, $cid = "")
    {

        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $cs = " c.status='Y'";
        if (!empty($data['coid']) && $data['coid'] != '' && $data['coid'] != undefined) {
            $wco = ' and c.country_id = "' . $data['coid'] . '"';
        }
        if (!empty($data['sid']) && $data['sid'] != ''  && $data['sid'] != undefined) {
            $ws = ' and c.state_id = "' . $data['sid'] . '"';
        }
        if (!empty($data['cid']) && $data['cid'] != ''  && $data['cid'] != undefined) {
            $wc = ' and c.city_id = "' . $data['cid'] . '"';
        }
        if (!empty($data['rid']) && $data['rid'] != ''  && $data['rid'] != undefined) {
            $rd = ' and um.roles_id = "' . $data['rid'] . '"';
        }
        if (!empty($data['rfid']) && $data['rfid'] != ''  && $data['rfid'] != undefined) {

            $rfd1 = ' and c.co_reff_by = "' . $data['rfid'] . '"';
        }
        $ac = '';
        if (!empty($data['ac']) && $data['ac'] != ''  && $data['ac'] != undefined) {

            $ac = ' and (c.inserted_by = "' . $data['ac'] . '" or c.co_reff_by=' . $data['ac'] . ') ';
        }

        if (!empty($data['consultant']) && $data['consultant'] != ''  && $data['consultant'] != undefined) {

            $rfd11 = ' and um.um_id = "' . $data['consultant'] . '"';
        }


        if (!empty($data['consultant_status']) && $data['consultant_status'] != ''  && $data['consultant_status'] != undefined) {
            $st = $data['consultant_status'];
            $cs = ' c.status="' . $st . '"';
        }
        $vs = '';
        if (!empty($data['consultant_vstatus']) && $data['consultant_vstatus'] != ''  && $data['consultant_vstatus'] != undefined) {
            if ($data['consultant_vstatus'] == 1) {
                $vs = ' and c.is_verified=1';
            } elseif ($data['consultant_vstatus'] == 2) {
                $vs = ' and (c.is_verified IS NULL or c.is_verified=0) ';
            }
            //$st=$data['consultant_status'];
            // $cs = ' c.status="'.$st.'"';
        }
        $c = "";
        if (!empty($data['academic_year']) && $data['academic_year'] != ''  && $data['academic_year'] != undefined) {
            $rfd = ' and c.academic_year = "' . $data['academic_year'] . '"';
            $c = $data['academic_year'];
        } elseif ($cid != '') {
            $rfd = ' and c.academic_year = "2019-20"';
            $c = '2019-20';
        } else {
            $cyear = $this->config->item('current_year');
            $rfd = ' and c.academic_year = "$cyear"';
            $c = $cyear;
        }
        $c = explode('-', $c);
        $c = $c[0];
        $ci = 'sandipun_ums.enquiry_student_master.academic_year="' . $c . '"';
        if ($role_id == '1' || $role_id == '30') {


            if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != undefined) {

                $wh1 = " and c.ic_code='" . $data['icfilter'] . "'";
            }
        } else if (($role_id == '8' || $role_id == 7)) {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;

            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";

            //$referred_by=$this->db->query("")->row()->cordinator_id;



            $wh =  " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.inserted_by IN (select (cordinator_id) as cordinator_id
         from consultant_cordinator_mapping where consultant_id=$uid and status='Y' ) OR c.consultant_head=$uid ) ";
            if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != undefined) {

                $wh1 = " and c.ic_code='" . $data['icfilter'] . "'";
            }
        } else if ($role_id == 16) {
            $wh = " and ( c.consultant_head='" . $this->session->userdata('uid') . "')  ";
        } else {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "'";
        }
        $cii = '';
        if ($cid != '') {

            $cii = " and um.um_id = $cid ";
        }
        /*$ac='';
if(!empty($data['ac']) && $data['ac'] != ''  && $data['ac'] != undefined){
	
    $ac = ' and c.inserted_by = "'.$data['ac'].'"';
}*/

        if (!empty($data['consultant_head']) && $data['consultant_head'] != ''  && $data['consultant_head'] != undefined) {
            $wh = '';
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=" . $data['consultant_head'] . " and status='Y'")->row()->ic_code;

            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";

            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
         from consultant_cordinator_mapping where consultant_id=" . $data['consultant_head'] . " and status='Y'")->row()->cordinator_id;



            $wh =  " and (c.ic_code IN ($ss) OR c.inserted_by='" . $data['consultant_head'] . "' OR c.inserted_by IN ($referred_by ) OR c.consultant_head=$uid ) ";
        }

        $cn = '';
        $ic_code = $this->session->userdata('ic_code');
        if ($ic_code == 'SU_BR_102' && $role_id != 7) {

            $cn = " and (c.is_fou=1 or c.is_fou=2) ";
        }

        $counseler_id_in = " and  um.um_id in (select group_concat(sandipun_ums.enquiry_student_master.created_by) from sandipun_ums.enquiry_student_master where is_from_consultant=1 and $ci)";

        $sql = "select c.*,um.roles_id,rm.roles_name,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id from
        

		 consultants_call_details as c 
		 
		 
inner join user_master as um ON um.con_id = c.id 
  
inner join roles_master as rm ON rm.roles_id=um.roles_id
left join states as s on c.state_id = s.id
left join cities as ci ON ci.id=c.city_id
          where  $cs  $wco $ws $wc $ac  $rd  $rfd1 $wh $wh1 $rfd11 $cii  $vs $cn group by c.id order by c.contact_person";

        $query  = $this->db->query($sql);
        $result = $query->result_array();

        return $result;
    }




    public function get_consultant_call($id)
    {
        $sql = "select * from consultant_log_details 
                             where  con_id = '" . $id . "' order by cid DESC";
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        //echo $this->db->last_query();exit;
        return $result;
    }
    public function get_consultant_doc_list($id)
    {
        $sql = "select * from consultants_document_list where  cid = '" . $id . "'";
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        //echo $this->db->last_query();exit;
        return $result;
    }
    public function get_consultants_call_details_byid($id)
    {
        $sql = "select consultants_call_details.*,ar.*,user_master.username,user_master.password,rm.roles_type from consultants_call_details 
                    left join user_master on consultants_call_details.id=user_master.con_id                    
                    left join roles_master as rm on user_master.roles_id=rm.roles_id 
                    left join consultant_admission_remuneration as ar on consultants_call_details.id = ar.con_id
          where  consultants_call_details.id = '" . $id . "' ";
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        //echo $this->db->last_query();exit;
        return $result;
    }
    public function get_consultant_school_list($cid)
    {
        $sql = "select * from consultant_school_count_list                    
          where status='Y' and con_id = '" . $cid . "' ";
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        //echo $this->db->last_query();exit;
        return $result;
    }
    //   function update_cons_call_center_details($data,$pic,$docic){
    //      //ini_set('error_reporting', E_ALL);
    //      //print_r($data);exit;
    // $role_id=$this->session->userdata("role_id");


    //  $carr['dob'] = $data['sdate'];
    //  $carr['gender'] = $data['gender'];
    //   $carr['whatsapp_no'] = $data['mob_no1'];
    //    $carr['prefered_loc'] = (stripcslashes($data['paddress']));
    //  if($pic != '')
    //  {$carr['photo'] = $pic;}
    //  $carr['co_reff_by'] = (stripcslashes($data['co_reff_by']));
    //      $carr['institute_name'] = (stripcslashes($data['institute_name']));
    //      $carr['contact_person'] = (stripcslashes($data['contact_person']));
    //      $carr['address'] = (stripcslashes($data['address']));
    //      $carr['isdno']= (stripcslashes($data['isdno']));
    //      $carr['mobile_no'] = (stripcslashes($data['mob_no']));
    //      $carr['official_no'] = (stripcslashes($data['official_no']));
    //      $carr['country_id'] = $data['country_id'];
    //      $carr['state_id'] = $data['state'];
    //      $carr['city_id'] = $data['city'];
    //      $carr['email'] = (stripcslashes($data['email']));
    //      $carr['official_email']= (stripcslashes($data['official_email']));
    //      $carr['website'] = (stripcslashes($data['website']));
    //      $carr['remark'] = (stripcslashes($data['remark']));
    //       $carr['updated_by']=$this->session->userdata('uid');
    //        $carr['updated_date']= date('Y-m-d H:i:s');
    //        $this->db->where('id', $data['cid']);
    //       $up = $this->db->update('consultants_call_details', $carr);
    //      // echo $this->db->last_query();exit;
    //       if(!empty($docic)){
    //       foreach ($docic as $key => $value) {
    //           $darr['cid'] = $data['cid'];
    //          $darr['document_name'] = $value['file_name'];
    //          $darr['inserted_by'] = $this->session->userdata('uid');
    //          $darr['inserted_date'] = date('Y-m-d h:i:s');
    //          $this->db->insert('consultants_document_list', $darr);
    //       }

    //      }
    //     return  $up;
    //  }
    function update_cons_call_center_details1($data, $pic, $docic, $bank_name)
    {
        //print_r($data['schcnt']);
        //print_r($data['schlist']);
        //    $result = array_diff($data['schcnt'], $data['schlist']);
        //print_r($result);
        //exit;
        //ini_set('error_reporting', E_ALL);
        //print_r($data);exit;
        $role_id = $this->session->userdata("role_id");
        //if($role_id =='1'){
        //$carr['counselor_type'] = $data['counselor_type'];
        //}

        $carr['dob'] = $data['sdate'];
        $carr['gender'] = $data['gender'];
        $carr['whatsapp_no'] = $data['mob_no1'];
        $carr['prefered_loc'] = (stripcslashes($data['paddress']));
        if ($pic != '') {
            $carr['photo'] = $pic;
        }
        $carr['co_reff_by'] = (stripcslashes($data['co_reff_by']));
        $carr['institute_name'] = (stripcslashes($data['institute_name']));
        $carr['contact_person'] = (stripcslashes($data['contact_person']));
        $carr['address'] = (stripcslashes($data['address']));
        $carr['isdno'] = (stripcslashes($data['isdno']));
        $carr['mobile_no'] = (stripcslashes($data['mob_no']));
        $carr['official_no'] = (stripcslashes($data['official_no']));
        $carr['country_id'] = $data['country_id'];
        $carr['state_id'] = $data['state'];
        $carr['city_id'] = $data['city'];
        $carr['adharcard'] = $data['Adharcard'];
        $carr['pancard'] = $data['Pancard'];
        $carr['scan_copy'] = $bank_name;
        $carr['bkname'] = $data['bkname'];
        $carr['is_fou'] = $data['is_fou'];
        $carr['ifsc'] = $data['ifsc'];
        $carr['branch'] = $data['branch'];
        $carr['email'] = (stripcslashes($data['email']));
        $carr['official_email'] = (stripcslashes($data['official_email']));
        $carr['website'] = (stripcslashes($data['website']));
        $carr['remark'] = (stripcslashes($data['remark']));
        $carr['updated_by'] = $this->session->userdata('uid');
        $carr['updated_date'] = date('Y-m-d H:i:s');
        $carr['adm_regular'] = $data['ranod'];
        $carr['adm_part'] = $data['panod'];
        $carr['inserted_iccode'] = $_SESSION['ic_code'];
        $this->db->where('id', $data['cid']);
        $up = $this->db->update('consultants_call_details', $carr);
        // echo $this->db->last_query();exit;
        if (!empty($docic)) {
            foreach ($docic as $key => $value) {

                $darr['cid'] = $data['cid'];
                $darr['document_name'] = $value['file_name'];
                $darr['inserted_by'] = $this->session->userdata('uid');
                $darr['inserted_date'] = date('Y-m-d h:i:s');
                $this->db->insert('consultants_document_list', $darr);
            }
        }
        $cra = $this->get_consultant_remuneration_details($data['cid']);
        $cn = count($cra);
        if ($cn > 0) {

            $carr1['status'] = 'N';
            $carr1['updated_by'] = $this->session->userdata('uid');
            $carr1['updated_date'] = date('Y-m-d H:i:s');
            $this->db->where('rid', $cra[0]['rid']);
            $up = $this->db->update('consultant_admission_remuneration', $carr1);

            $arr['con_id'] = $data['cid'];
            $arr['adm_type'] = $data['adm_rem'];
            if ($data['adm_rem'] == 'f') {
                $arr['fixed_amt'] = $data['other_per'];
                $arr['fixed_remark'] = $data['other_remark'];
            } else {
                $arr['first_amt'] = $data['first_per'];
                $arr['second_amt'] = $data['second_per'];
                $arr['thired_amt'] = $data['third_per'];
            }
            $arr['inserted_by'] = $this->session->userdata('uid');
            $arr['inserted_date'] = date('Y-m-d h:i:s');
            $this->db->insert('consultant_admission_remuneration', $arr);
        } else {
            $arr['con_id'] = $data['cid'];
            $arr['adm_type'] = $data['adm_rem'];
            if ($data['adm_rem'] == 'f') {
                $arr['fixed_amt'] = $data['other_per'];
            } else {
                $arr['first_amt'] = $data['first_per'];
                $arr['second_amt'] = $data['second_per'];
                $arr['thired_amt'] = $data['third_per'];
            }
            $arr['inserted_by'] = $this->session->userdata('uid');
            $arr['inserted_date'] = date('Y-m-d h:i:s');
            $this->db->insert('consultant_admission_remuneration', $arr);
        }
        if (!empty($data['schlist'])) {


            foreach ($data['schlist'] as $key => $value) {
                $sl = "select * from consultant_school_count_list where school_id='" . $value . "' and con_id='" . $data['cid'] . "' ";
                $query = $this->db->query($sl);
                $cntd = $query->result_array();
                $cnt = $query->num_rows();
                if ($cnt > 0) {
                    $ctarr1['sch_cnt'] = $data[$value];
                    $ctarr1['updated_by'] = $this->session->userdata('uid');
                    $ctarr1['updated_date'] = date('Y-m-d H:i:s');
                    $this->db->where('id', $cntd[0]['id']);
                    $up = $this->db->update('consultant_school_count_list', $ctarr1);
                } else {

                    $arrs['con_id'] = $data['cid'];
                    $arrs['school_id'] = $value;
                    $arrs['sch_cnt'] = $data[$value];
                    $arrs['inserted_by'] = $this->session->userdata('uid');
                    $arrs['inserted_date'] = date('Y-m-d h:i:s');
                    $this->db->insert('consultant_school_count_list', $arrs);
                }
            }

            $result = array_diff($data['schcnt'], $data['schlist']);
            //print_r($result);
            if (!empty($result)) {
                foreach ($result as $key => $value) {
                    $sl = "select * from consultant_school_count_list where school_id='" . $value . "' and con_id='" . $data['cid'] . "' ";
                    $query = $this->db->query($sl);
                    $cntd1 = $query->result_array();

                    $ctarrd['status'] = 'N';
                    $ctarrd['updated_by'] = $this->session->userdata('uid');
                    $ctarrd['updated_date'] = date('Y-m-d H:i:s');
                    $this->db->where('id', $cntd1[0]['id']);
                    $up = $this->db->update('consultant_school_count_list', $ctarrd);
                }
            }
        }

        return  $up;
    }
    function get_consultant_remuneration_details($cid)
    {
        $sql = "SELECT * FROM consultant_admission_remuneration where con_id='" . $cid . "' and status='Y' ";
        //echo $sql;exit();
        $query = $this->db->query($sql);
        return $query->result_array();
    }

    function get_student_by_mock($data)
    {
        //print_r($data);exit;
        //$cond="s.ic_code='".$data['ic']."' and s.standard = '".$data['stand']."' "; 
        if (!empty($data['exmid']) && $data['exmid'] != '') {
            $cond1 = " and sr.exam_no = '" . $data['exmid'] . "'  ";
        } else {
            $cond1 = " and sr.exam_no IN(2,6,7,8,10) ";
        }
        $sql = "SELECT distinct s.id,sr.exam_no,st.stream_id,s.provisional_admission,s.landmark,cm.city_name,sm.standard_id,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.mobile2,s.mobile1_status,st.stream_name,sm.standard_name ,s.created_by,s.created_date,s.lead_assign,s.programme_id
                FROM student_meet_details  s 
                inner join su_jee_registration as sr on sr.reg_id = s.id
                 JOIN event_details e  ON s.event_code=e.event_code                         
                LEFT JOIN stream_master st ON st.stream_id=s.stream
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard                
                LEFT JOIN city_master cm ON cm.city_id=s.city_id
                WHERE  s.academic_year='" . $this->config->item('ic_year') . "' and s.provisional_admission !='Y'  " . $cond1 . " ";
        $query = $this->db->query($sql);
        // echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }
    function get_student_by_mock_cnt($data)
    {
        if (!empty($data['exmid']) && $data['exmid'] != '') {
            $cond1 = " and sr.exam_no = '" . $data['exmid'] . "'  ";
        } else {
            $cond1 = " and sr.exam_no IN(2,6,7,8,10) ";
        }
        $sql = "SELECT count(*) as cnt
                FROM student_meet_details  s 
                inner join su_jee_registration as sr on sr.reg_id = s.id
                 JOIN event_details e  ON s.event_code=e.event_code                         
                LEFT JOIN stream_master st ON st.stream_id=s.stream
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard                
                LEFT JOIN city_master cm ON cm.city_id=s.city_id
                WHERE  s.academic_year='" . $this->config->item('ic_year') . "' and s.provisional_admission !='Y'  " . $cond1 . " ";
        $query = $this->db->query($sql);
        //  echo $this->db->last_query();exit;
        $res = $query->result_array();
        return $res;
    }
    function get_program_list($ct)
    {
        if ($ct == 'P') {
            $st = " sp.is_ind = 'Y'";
        } else {
            $st = " sp.sp_status='Y'";
        }
        $sql = "SELECT * FROM sandipun_univerdb.school_programs_new as sp where $st group by sp.sprogramm_acro";
        //echo $sql;exit();
        $query = $this->db->query($sql);
        return $query->result_array();
    }
    function add_inbound_data($data)
    {
        //print_r($data);
        $ic = $this->session->userdata('ic_code');
        $carr['ic_code'] = $ic;
        $carr['event_code'] = 'INBOUND';




        $carr['student_name'] = (stripcslashes($data['student_name']));
        $carr['gender'] = $data['gender'];
        $carr['dob'] = date('Y-m-d', strtotime($data['dob']));
        $carr['mobile1'] = (stripcslashes($data['mobile1']));
        $carr['whatsappno'] = (stripcslashes($data['whats_app']));
        $carr['pmobile_no'] = $data['parent_no'];
        $carr['pwhatsapp_no'] = $data['parent_now'];
        $carr['standard'] = $data['standard'];
        $carr['stream'] = $data['stream'];
        $carr['stream_name'] = $data['stream_name'];
        $carr['address'] = (stripcslashes($data['saddress']));

        $carr['country_id'] = $data['country'];
        $carr['country_name'] = (stripcslashes($data['country_name']));
        $carr['state_id'] = $data['state'];
        $carr['state_name'] = (stripcslashes($data['state_name']));
        $carr['city_id'] = $data['city'];
        $carr['city_name'] = (stripcslashes($data['city_name']));
        $carr['pincode'] = $data['pincode'];
        $carr['email'] = $data['email'];
        $carr['adhar_no'] = $data['adhar_no'];
        $carr['mock_interested'] = $data['int_mock'];
        // $carr['jee_interested'] = $data['jee_int'];
        $carr['sujee_interested'] = $data['int_sujee'];
        $carr['cast_category'] = $data['category_cast'];
        // $arr['course_interested'] = $data['courseInterested'];
        // $arr['exbhi_source_name'] = $data['exbhi_source_name'];
        $carr['created_by'] = $this->session->userdata('uid');
        $carr['created_date'] = date('Y-m-d H:i:s');
        $carr['academic_year'] = $data['academic_year'];
        $carr['status'] = 'Y';
        //$arr['remark'] = $data['remark'];

        if (isset($data['datepick']) && $data['datepick'] != '') {

            $wdata['visite_date'] = date('Y-m-d', strtotime($data['datepick']));
            $callvisit = date('Y-m-d', strtotime($data['datepick']));
        } else {
            $wdata['visite_date'] = date('Y-m-d', strtotime($data['selectdate']));
            $callvisit = date('Y-m-d', strtotime($data['selectdate']));
        }


        $ReferenceBy = $data['ReferenceBy'];
        if ($ReferenceBy == 'Other') {
            $othreff = $data['othreffname'] . "-" . $data['othermobile'];
        }
        /* else if(($ReferenceBy=='consultant' || $ReferenceBy=='staff' || $ReferenceBy=='fou'|| $ReferenceBy=='digital'  ) && $_REQUEST['newsname']=='other')
            {
                $othreff= $_REQUEST['othrefname']."-".$_REQUEST['otherreffmobile']; 
            }*/ else if ($ReferenceBy == 'consultant' || $ReferenceBy == 'staff' || $ReferenceBy == 'fou' || $ReferenceBy == 'digital' || $ReferenceBy == 'NewspaperAdvt') {
            $othreff = $data['newsname'];
        } else if ($ReferenceBy == 'TvAdvt' || $ReferenceBy == 'RadioAdvt' || $ReferenceBy == 'Hording') {
            $othreff = $data['advername'];
        } else {
            $othreff = '';
        }
        $carr['contact_source'] = $ReferenceBy;
        $carr['othr_ref'] = $othreff;

        // $programme_id=$data['Courses'];
        // $schoolname=$data['school_name'];
        // $campus_inst=$data['Campus'];
        // $course_type =$data['CoursesType'];
        // $course_walkin=$data['Courses'];
        // $last_que=$data['last_que'];
        // $lstream=$data['lstream'];
        //  $CourseYear=$data['CourseYear'];

        // $carr['standard']=$last_que;
        // $carr['school_name']=$schoolname;

        // $carr['stream']=$lstream;
        // $carr['last_qualification']=$last_que;
        // $carr['programme_id']=$programme_id;
        // $carr['campus_inst']= $campus_inst;
        // $carr['course_type']=$course_type;
        // $carr['course_walkin']=$course_walkin;
        // $carr['Course_Year']=$CourseYear;
        // $carr['course_interested']=$course_walkin;

        if ($data['status'] == 'INT') {
            $insertsatus = 'INTERESTED';
        } else if ($data['status'] == 'NINT') {
            $insertsatus = 'NOT-INTERESTED';
        } else if ($data['status'] == 'LCALL') {
            $insertsatus = 'CALL-LATER';
        } else {
            $insertsatus = $data['status'];
        }
        //   $carr['walkin_status']=$insertsatus;

        $carr['academic_year'] = $this->config->item('ic_year');
        //$carr['lead_assign']=$this->session->userdata('name');
        //$carr['lead_assign_on']=date('Y-m-d h:i:s');
        //$carr['lead_assign_by']=$this->session->userdata('name');
        $carr['created_by'] = $this->session->userdata('uid');
        $carr['created_date'] = date('Y-m-d H:i:s');
        // print_r($carr);exit;
        $in = $this->db->insert('student_meet_details', $carr);
        //echo $this->db->last_query(); exit;
        $insert_id = $this->db->insert_id();
        if (isset($data['adhar_no']) && !empty($data['adhar_no']) && $data['adhar_no'] != '000000000000') {
            $academic_year = ACADEMIC_YEAR;
            $user_id = $this->session->userdata('uid');
            $adhaar = $data['adhar_no'];
            $c = explode('-', $academic_year);
            $c = $c[0];
            $sql = "SELECT distinct(s.stud_id) as student_id
			FROM sandipun_ums.student_master  s                     
			WHERE s.admission_session='$c' and (s.adhar_card_no = '" . $adhaar . "') and s.enrollment_no !=''
			UNION 
			SELECT distinct(s.stud_id) as student_id
			FROM sandipun_ums_sijoul.student_master  s                     
			WHERE s.admission_session='$c'  and (s.adhar_card_no = '" . $adhaar . "') and s.enrollment_no !=''";
            $query_data = $this->db->query($sql)->row();
            if (empty($query_data)) {
                $ad_no = $data['adhar_no'];
                $check_entry_in_aadhar = $this->db->query("select * from aadhar_car_updation where add_no='$ad_no' and academic_year='$academic_year'")->row();

                if (empty($check_entry_in_aadhar)) {
                    $adhar_card['add_no'] = $data['adhar_no'];
                    $adhar_card['student_id'] = $insert_id;
                    $adhar_card['is_insert'] = 1;
                    $adhar_card['created_by'] =  $this->session->userdata('uid');
                    $adhar_card['date_time'] = date('Y-m-d H:i:s');
                    $this->db->insert('aadhar_car_updation', $adhar_card);
                    //if($get_student_details->ic_code_consultant==$user_id){
                    if (empty($query_data)) {
                        $ld111['adhar_no'] = $data['adhar_no'];
                        $ld111['ic_code_consultant'] = $this->session->userdata('uid');
                        $this->db->where('id', $insert_id);
                        $this->db->update('student_meet_details', $ld111);
                    }
                }
            }
        }
        /*	 
$adhar_card['student_id']= $insert_id ;
$adhar_card['is_insert']= 1 ;
$adhar_card['created_by']=  $this->session->userdata('uid');
$adhar_card['date_time']= date('Y-m-d H:i:s');
$this->db->insert('aadhar_car_updation', $adhar_card);
*/
        //if($data['courseInterested']!=''){


        $arr1['student_id'] = $insert_id;
        $arr1['course_id'] = $data['scor'];
        //$arr1['course_name']=$exp[1];
        $arr1['inserted_by'] = $this->session->userdata('uid');
        $arr1['inserted_at'] = date('Y-m-d H:i:s');
        $ins = $this->db->insert('smd_interested_course', $arr1);


        if ($data['int_mock'] == 'Y') {
            foreach ($data['mock_exm'] as $key => $value) {
                $exm1['student_id'] = $insert_id;
                $exm1['exam_id'] = $value;
                $exm1['exam_typ'] = 'OF';
                $exm1['exam_name'] = 'MOCK';

                $this->insert_student_exam($exm1);
            }
        }
        if ($data['int_sujee'] == 'Y') {
            foreach ($data['sujee_exm'] as $key => $value) {
                $exm2['student_id'] = $insert_id;
                $exm2['exam_id'] = $value;
                $exm2['exam_typ'] = 'OF';
                $exm2['exam_name'] = 'SUJEE';

                $this->insert_student_exam($exm2);
            }
        }
        //}
        $arr['academic_year'] = $this->config->item('ic_year');
        $arr['calling_event'] = 'INCOMING_LEAD';
        $arr['stud_id'] = $insert_id;
        $arr['lead_assign'] = $this->session->userdata('uid');
        $arr['lead_assign_on'] = date('Y-m-d H:i:s');
        $arr['lead_assign_by'] = $this->session->userdata('uid');
        //$this->db->where('id', $sid);
        // $upd = $this->db->update('student_meet_details', $arr);
        $ins = $this->db->insert('lead_assign_details', $arr);
        if ($ins) {
            $row1 = array(
                'student_id' => $insert_id,
                'source_of_contact' => $ReferenceBy,
                'other_reference' => $othreff,
                'mobile_no' => $data['mobile1'],
                'calling_status' => $insertsatus,
                'visite_ic_code' => $data['status_select'],
                'visite_date' => $callvisit,
                'called_by' => $this->session->userdata('uid'),
                'called_on' => date('Y-m-d H:i:s'),
                'remark' => $data['remark'],
                'is_inbound' => 'Y',
                'ld_id' => $this->db->insert_id()
            );

            $this->db->insert('calling_log_details', $row1);
        }
        return $in;
    }

    function count_inbound_list()
    {
        $user_id = $this->session->userdata('name');
        if ($user_id == "superadmin" || $user_id == "admin") {
            $cond = " ";
        } else {
            $uid = $this->session->userdata('uid');
            $cond = "AND sd.created_by='" . $uid . "'";
        }

        $ac = ACADEMIC_YEAR;
        $sql = "SELECT COUNT(*) AS total FROM student_meet_details AS sd WHERE sd.id != '' $cond AND sd.academic_year='$ac'";

        $query = $this->db->query($sql);
        // print_r($this->db->last_query()); exit;
        return $query->row()->total;
    }

    function get_inbound_list($limit, $start)
    {
        $user_id = $this->session->userdata('name');
        if ($user_id == "superadmin" || $user_id == "admin") {
            $cond = " ";
        } else {
            $uid = $this->session->userdata('uid');
            $cond = "AND sd.created_by='" . $uid . "'";
        }

        $ac = ACADEMIC_YEAR;
        $sql = "SELECT sd.lead_type, vw.stream_name, vw.school_short_name, sd.id, sd.student_name, 
                   sd.mobile1, sd.email, sd.standard, sm.standard_name, latest_calling_status AS calling_status 
            FROM student_meet_details AS sd 
            LEFT JOIN standard_master sm ON sd.standard=sm.standard_id
            LEFT JOIN su_sf_sijoul_stream_details AS vw ON sd.programme_id=vw.stream_id AND sd.campus_id=vw.belongtocampus    
            WHERE sd.id != '' $cond AND sd.academic_year='$ac' 
            GROUP BY sd.id 
            ORDER BY sd.created_date DESC 
            LIMIT $start, $limit";  // Added LIMIT for pagination

        $query = $this->db->query($sql);
        return $query->result_array();
    }


    function get_inbound_listdd()
    {
        $user_id = $this->session->userdata('name');
        if ($user_id == "superadmin" || $user_id == "admin") {
            $cond = " ";
        } else {
            $uid = $this->session->userdata('uid');
            $cond = "and sd.created_by='" . $uid . "'";
        }
        //LEFT JOIN lead_assign_details l ON sd.id=l.stud_id // LEFT JOIN calling_log_details c ON sd.id=c.student_id
        $ac = ACADEMIC_YEAR;
        $sql = "SELECT sd.lead_type,vw.stream_name,vw.school_short_name,sd.id,sd.student_name,sd.mobile1,sd.email,sd.standard,sm.standard_name,
  latest_calling_status as calling_status FROM student_meet_details as sd 
  
 
 LEFT JOIN standard_master sm ON sd.standard=sm.standard_id
  left join su_sf_sijoul_stream_details as vw on sd.programme_id=vw.stream_id and sd.campus_id=vw.belongtocampus    
  where sd.id!='' $cond and sd.academic_year='$ac' group by sd.id order by sd.created_date DESC ";
        //echo $sql;exit();
        $query = $this->db->query($sql);
        return $query->result_array();
    }


    function get_event_list()
    {
        $uid = $this->session->userdata('uid');
        $ac = ACADEMIC_YEAR;
        if ($uid == 3964) {

            $sql = " SELECT * FROM ((SELECT id,student_name,mobile1,exbhi_source_name,latest_calling_status,created_date FROM student_meet_details WHERE academic_year='$ac'
		and  exbhi_source_name IN ('Madhubani','Darbhanga','Samastipur','Nawada','Bhagalpur'))
		UNION
		(SELECT st.id,student_name,mobile1,g.event_type as exbhi_source_name,latest_calling_status,g.created_date FROM student_meet_details st 
		join get_secondary_sources as g on st.id=g.student_id
		WHERE st.academic_year='$ac' and  g.event_type IN ('Madhubani','Darbhanga','Samastipur','Nawada','Bhagalpur')
		group by st.id)) data GROUP BY id ORDER BY created_date DESC";
        } else {
            $sql = " SELECT * FROM ((SELECT id,student_name,mobile1,exbhi_source_name,latest_calling_status,created_date FROM student_meet_details WHERE academic_year='$ac'
		and  exbhi_source_name IN ('Edufesta-Nashik'))
		UNION
		(SELECT st.id,student_name,mobile1,g.event_type as exbhi_source_name,latest_calling_status,g.created_date FROM student_meet_details st 
		join get_secondary_sources as g on st.id=g.student_id
		WHERE st.academic_year='$ac' and  g.event_type IN ('Edufesta-Nashik')
		group by st.id)
		UNION
		(SELECT st.id,student_name,mobile1,'Edufesta-Nashik' as exbhi_source_name,latest_calling_status,g.created_date FROM student_meet_details st 
		join edufesta_leads as g on st.id=g.student_id
		WHERE st.academic_year='$ac' 
		group by st.id)
		
		) data GROUP BY id ORDER BY created_date DESC";
        }
        $query = $this->db->query($sql);
        return $query->result_array();
    }



    function get_cam_visits_list()
    {
        $academic_year = ACADEMIC_YEAR;
        if ($user_id == "superadmin" || $user_id == "admin") {
            $cond = " ";
        } else {
            $ic_code = $this->session->userdata('ic_code');
            $cond = "and cl.visite_ic_code='" . $ic_code . "'";
            $cond1 = "and visite_ic_code='" . $ic_code . "'";
        }
        $sql = "SELECT sd.student_name,sd.mobile1,sd.email,sd.last_qualification,p.sprogramm_acro,MAX(cl.c_id) as clid,cl.mobile_no,cl.visite_ic_code,cl.visite_date ,cl.remark FROM calling_log_details as cl 
  join (select MAX(c_id) as clid from calling_log_details where 1 group by student_id) as a on a.clid = cl.c_id
  JOIN student_meet_details as sd ON cl.student_id = sd.id and sd.academic_year='$academic_year'
 LEFT JOIN sandipun_univerdb.school_programs_new p ON p.sp_id=sd.programme_id
 where (cl.calling_status='CAMPUS-VISIT' OR cl.calling_status='IC_VISIT' OR cl.calling_status='CAMPUS-REVISIT' OR cl.calling_status='IC_REVISIT') $cond group by cl.student_id order by date(cl.visite_date) DESC ";
        // echo $sql;//exit();
        $query = $this->db->query($sql);
        return $query->result_array();
    }
    function add_consultant_event($data)
    {
        $carr['name'] = (stripcslashes($data['event_name']));
        $carr['event_date'] = date('Y-m-d', strtotime($data['event_date']));
        $carr['event_type'] = (stripcslashes($data['event_type']));
        $carr['application_cnt'] = (stripcslashes($data['tot_app_count']));
        $carr['address'] = (stripcslashes($data['paddress']));
        $carr['country_id'] = (stripcslashes($data['country']));
        $carr['state'] = (stripcslashes($data['state']));
        $carr['city'] = (stripcslashes($data['city']));
        $carr['inserted_by'] = $this->session->userdata('uid');
        $carr['inserted_date'] = date('Y-m-d h:i:s');
        $in = $this->db->insert('consultants_events', $carr);
        //echo $this->db->last_query(); exit;
        $count = count($data['spk_name']);
        //echo $count;
        $eins = $this->db->insert_id();
        for ($i = 0; $i < $count; $i++) {
            $fins['con_event_id'] = $eins;
            $fins['atten_name'] = $data['spk_name'][$i];
            $fins['contact_no'] = $data['contact_no'][$i];
            $fins['inserted_by'] = $this->session->userdata('uid');
            $fins['inserted_date'] = date('Y-m-d');

            $ins = $this->db->insert('consultants_events_speakers', $fins);
        }
        //$insert_id = $this->db->insert_id();


        return $in;
    }
    function get_consultant_event_list($id = '')
    {
        if ($id != '') {
            $wh = ' and ce.id="' . $id . '"';
        }
        $sql = "select ce.*,s.name as state_name,c.name as city_name from consultants_events as ce
left join states as s on ce.state = s.id
left join cities as c on ce.city=c.id
           where status='Y' $wh ";

        $query  = $this->db->query($sql);
        $result = $query->result_array();
        //echo $this->db->last_query();exit;
        return $result;
    }
    function get_SpeakearDetails1($eventid)
    {
        $sql = "select * from consultants_events_speakers

           where status='Y' and con_event_id = '" . $eventid . "' ";

        $query  = $this->db->query($sql);
        $result = $query->result_array();
        //echo $this->db->last_query();exit;
        return $result;
    }
    function update_consultant_event($data)
    {
        // print_r($data);
        $carr['name'] = (stripcslashes($data['event_name']));
        $carr['event_date'] = date('Y-m-d', strtotime($data['event_date']));
        $carr['event_type'] = (stripcslashes($data['event_type']));
        $carr['application_cnt'] = (stripcslashes($data['tot_app_count']));
        $carr['address'] = (stripcslashes($data['paddress']));
        $carr['country_id'] = (stripcslashes($data['country']));
        $carr['state'] = (stripcslashes($data['state']));
        $carr['city'] = (stripcslashes($data['city']));
        $carr['updated_by'] = $this->session->userdata('uid');
        $carr['updated_date'] = date('Y-m-d h:i:s');
        $this->db->where('id', $data['eventid']);
        $up = $this->db->update('consultants_events', $carr);
        //echo $this->db->last_query();exit;
        return $up;
    }
    function updateConsultantSpeakerDetails($data, $eventId)
    {
        $count = count($data['spk_name']);
        //echo $count;
        for ($i = 0; $i < $count; $i++) {
            $spk['atten_name'] = $data['spk_name'][$i];
            $spk['contact_no'] = $data['contact_no'][$i];
            $spk['sid'] = $data['spakr_id'][$i];

            $name = $spk['atten_name'];
            $contactno = $spk['contact_no'];
            $event_spk_id = $spk['sid'];

            $sql = "select * from consultants_events_speakers where sid='$event_spk_id' and con_event_id ='$eventId'";
            //echo $sql;
            $query = $this->db->query($sql);
            $available = $query->result_array();
            //print_r($available);exit;

            if (!empty($available)) {
                //echo"in update";
                $spk['updated_by'] = $this->session->userdata("uid");
                $spk['updated_date'] = date('Y-m-d H:i:s');
                $this->db->where('con_event_id', $eventId);
                $this->db->where('sid', $spk['event_spk_id']);
                $this->db->update('consultants_events_speakers', $spk);
                // echo $this->db->last_query();
            } elseif (empty($available)) {
                //echo"in insert";
                $spk['inserted_by'] = $this->session->userdata("uid");
                $spk['con_event_id'] = $eventId;
                $spk['inserted_date'] = date('Y-m-d H:i:s');
                $insertedid = $this->db->insert('consultants_events_speakers', $spk);
            }
        }
        if ($this->db->affected_rows() != 1)
            echo $temp = false;
        else
            $temp = true;
        if ($temp == false) {
            return $insertedid;
        } else {
            return true;
        }
    }
    //vikas below code get consultant enquiry form data
    function get_consultant_event_enquiry_list($id = '')
    {
        if ($id != '') {
            $wh = ' where ci.consultant_id="' . $id . '"';
        } else {
            $wh = '';
        }
        $sql = "select ci.*,ce.name as eventname from consultant_enquiry_form_details as ci
                
        left join consultants_events as ce on ce.id =ci.event $wh ";
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        //echo $this->db->last_query();exit;
        return $result;
    }
    function get_consultant_enquiry_list_byevent($evt)
    {
        if ($evt != '') {
            $wh = ' where ci.event="' . $evt . '"';
        } else {
            $wh = '';
        }
        $sql = "select ci.*,c.name as country_name,s.name as state_name,cis.name as city_name,ce.name as eventname from consultant_enquiry_form_details as ci                
        left join consultants_events as ce on ce.id =ci.event 
left join countries as c on ci.country = c.id
left join states as s on ci.state = s.id
left join cities as cis on ci.city = cis.id
        $wh ";
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        //echo $this->db->last_query();exit;
        return $result;
    }
    public function add_consultant_event_enquiry($data)
    {
        $insert_array['name'] = (stripcslashes($data['student_name']));
        $insert_array['ic_code'] = (stripcslashes($this->session->userdata("ic_code")));
        $insert_array['event'] = (stripcslashes($data['event']));
        $insert_array['institute_name'] = (stripcslashes($data['institute_name']));
        $insert_array['date_of_birth'] = (stripcslashes($data['dob']));
        $insert_array['gender'] = (stripcslashes($data['gender']));
        $insert_array['email'] = (stripcslashes($data['email']));
        $insert_array['official_email'] = (stripcslashes($data['official_email']));
        $insert_array['mobile'] = (stripcslashes($data['mob_no']));
        $insert_array['whatsup_no'] = (stripcslashes($data['whatapp_no']));
        $insert_array['address'] = (stripcslashes($data['address']));
        $insert_array['country'] = (stripcslashes($data['country_id']));
        $insert_array['state'] = (stripcslashes($data['state']));
        $insert_array['city'] = (stripcslashes($data['city']));
        $insert_array['preff_loca_admission'] = (stripcslashes($data['paddress']));
        $insert_array['created_by'] = $this->session->userdata("uid");
        $insert_array['created_date'] = date("Y-m-d H:i:s");
        $this->db->insert('consultant_enquiry_form_details', $insert_array);
        $insert_id = $this->db->insert_id();
        return  $insert_id;
    }

    function update_consultant_enquiry_event($data)
    {
        $updated_array['name'] = (stripcslashes($data['student_name']));
        $updated_array['ic_code'] = (stripcslashes($this->session->userdata("ic_code")));
        $updated_array['event'] = (stripcslashes($data['event']));
        $updated_array['institute_name'] = (stripcslashes($data['institute_name']));
        $updated_array['date_of_birth'] = (stripcslashes($data['dob']));
        $updated_array['gender'] = (stripcslashes($data['gender']));
        $updated_array['email'] = (stripcslashes($data['email']));
        $updated_array['official_email'] = (stripcslashes($data['official_email']));
        $updated_array['mobile'] = (stripcslashes($data['mob_no']));
        $updated_array['whatsup_no'] = (stripcslashes($data['whatapp_no']));
        $updated_array['address'] = (stripcslashes($data['address']));
        $updated_array['country'] = (stripcslashes($data['country_id']));
        $updated_array['state'] = (stripcslashes($data['state']));
        $updated_array['city'] = (stripcslashes($data['city']));
        $updated_array['preff_loca_admission'] = (stripcslashes($data['paddress']));
        $updated_array['updated_by'] = $this->session->userdata("uid");
        $updated_array['updated_date'] = date("Y-m-d H:i:s");
        $this->db->where('consultant_id', $data['eventid']);
        $updated = $this->db->update('consultant_enquiry_form_details', $updated_array);
        return $updated;
    }
    public function update_profile_password($data)
    {
        $sdata['password'] = (stripcslashes($data['password']));
        $sdata['updated_by'] = $this->session->userdata('uid');
        $sdata['updated_datetime'] = date('Y-m-d H:i:s');
        $this->db->where('um_id', $this->session->userdata('uid'));
        $this->db->where('username', (stripcslashes($data['userid'])));
        $GT = $this->db->update('user_master', $sdata);
        if ($GT) {
            if (($this->session->userdata('role_id') == '17') || ($this->session->userdata('role_id') == '18')) {
                $udata['password'] = (stripcslashes($data['password']));
                $udata['updated_by'] = $this->session->userdata('uid');
                $udata['updated_date'] = date('Y-m-d H:i:s');
                $this->db->where('ic_code', $this->session->userdata('ic_code'));
                $this->db->where('username', (stripcslashes($data['userid'])));
                $this->db->update('ic_user_master', $udata);
            }
        }
        return $GT;
    }
    function get_student_lead_allocate_by_standard($data)
    {
        $cond = "s.ic_code='" . $data['ic'] . "' and s.standard = '" . $data['stand'] . "' ";
        if (!empty($data['stream']) && $data['stream'] != '') {
            $cond1 = " and s.stream = '" . $data['stream'] . "'  ";
        }
        $sql = "SELECT distinct s.id,st.stream_id,s.provisional_admission,s.landmark,cm.city_name,sm.standard_id,i.institute_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.mobile2,s.mobile1_status,st.stream_name,sm.standard_name ,s.created_by,s.created_date,s.lead_assign
                FROM student_meet_details  s 
                LEFT JOIN event_details e  ON s.event_code=e.event_code 
                LEFT JOIN institute_master i ON i.institue_id=e.institue_id
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN stream_master st ON st.stream_id=s.stream
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard                
                LEFT JOIN city_master cm ON cm.city_id=s.city_id
              
                WHERE s.id NOT IN (  select stud_id from lead_assign_details where  academic_year='" . $this->config->item('ic_year') . "' and (calling_event = '" . $data['cevt'] . "' OR calling_event ='INCOMING_LEAD') and active = 'Y') and s.academic_year='" . $this->config->item('ic_year') . "' and s.provisional_admission !='Y' and " . $cond . " " . $cond1 . "  limit 0,100";
        $query = $this->db->query($sql);
        //echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }
    function get_student_lead_allocate_by_standard1($data)
    {
        if (!empty($data['stand']) && $data['stand'] != '') {
            $wstd = "and s.standard = '" . $data['stand'] . "'";
        } else {
            $wstd = '';
        }

        $cond = " and s.ic_code='" . $data['ic'] . "' $wstd  ";
        if (!empty($data['stream']) && $data['stream'] != '') {
            $cond1 = " and s.stream = '" . $data['stream'] . "'  ";
        }
        //   echo $sql = "SELECT distinct s.id,st.stream_id,s.provisional_admission,s.landmark,
        //      s.student_name,s.mobile1,s.mobile1_valid,s.mobile2,s.mobile1_status,st.stream_name,s.standard as standard_name ,s.created_by,s.created_date,s.lead_assign
        //             FROM student_meet_details  s                
        //             LEFT JOIN stream_master st ON s.stream = st.stream_id                              
        //             WHERE s.id NOT IN (  SELECT stud_id FROM lead_assign_details WHERE  academic_year='".$this->config->item('ic_year')."' AND (calling_event = '".$data['cevt']."' OR calling_event ='INCOMING_LEAD') AND active = 'Y') 
        // AND s.academic_year='".$this->config->item('ic_year')."' AND s.provisional_admission !='Y' AND ".$cond." ".$cond1."
        //             limit 100"; 
        //      $sql="SELECT DISTINCT s.id,l.stud_id,s.stream,s.student_name,s.mobile1,s.mobile2,s.standard AS standard_name
        // FROM student_meet_details s 
        // LEFT JOIN (SELECT stud_id FROM lead_assign_details WHERE academic_year='".$this->config->item('ic_year')."' AND (calling_event = '".$data['cevt']."' OR calling_event ='INCOMING_LEAD') AND active = 'Y' ) l
        //   ON  s.id = l.stud_id
        // WHERE l.stud_id IS NULL  AND s.academic_year='".$this->config->item('ic_year')."'  AND s.provisional_admission !='Y' 
        // ".$cond." ".$cond1." LIMIT 200 "; 
        //$sql = "CALL calling_lead_assign('SU_BR_016','admission_2019')";
        //print_r($sql);
        $sql = "SELECT DISTINCT s.id,s.state_name,s.stream,s.stream_name,s.student_name,s.mobile1,s.pmobile_no,s.country_name,s.standard,sm.standard_name,sc.course,sc.school_code,s.city_name
 FROM student_meet_details s
 left JOIN lead_assign_details ld ON s.id =  ld.stud_id  AND ld.calling_event='" . $data['cevt'] . "'
LEFT JOIN standard_master sm ON s.standard =sm.standard_id
left join school_course sc ON s.programme_id=sc.course_id
 WHERE ld.stud_id IS NULL and s.academic_year='" . $this->config->item('ic_year') . "' and s.data_collection='P' and s.mobile1_valid !='N' and s.event_code !='Consultant'  
 " . $cond . " " . $cond1 . " LIMIT 200 ";
        /*$sql="SELECT distinct s.id,st.stream_id,s.provisional_admission,s.landmark,sm.standard_id,
       s.student_name,s.mobile1,s.mobile1_valid,s.mobile2,s.mobile1_status,
       st.stream_name,sm.standard_name ,s.created_by,s.created_date,s.lead_assign
FROM student_meet_details  s                
    LEFT JOIN stream_master st ON s.stream = st.stream_id
    LEFT JOIN standard_master sm ON s.standard =sm.standard_id
    NATURAL LEFT JOIN lead_assign_details lad
    WHERE lad.stud_id IS NULL
    AND s.academic_year='".$this->config->item('ic_year')."' 
    AND s.provisional_admission !='Y' AND ".$cond." ".$cond1."
    limit 100";*/
        $query = $this->db->query($sql);
        //echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }
    function get_interested_call_list_new_status_count($evt, $status)
    {
        $academic_year = ACADEMIC_YEAR;
        $user_id = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');
        $ic_code = $this->session->userdata('ic_code');
        $ic_con = '';
        if ($ic_code != 'SU_MH_080') {
            $ic_con = " and s.id NOT in (select stud_id  from lead_assign_details where lead_assign_by=$user_id
		  and lead_assign !='$user_id' and lead_assign_details.active='Y')
		  
		  
		 ";
        }
        if ($user_id == "superadmin" || $user_id == "admin") {
            $cond = " ";
        } else {
            // $cond="and c.called_by='". $user_id ."'";
            $cond = "and ld.lead_assign='" . $user_id . "'";
        }
        $stconsd = " and s.latest_calling_status ='$status' ";
        if ($status == "CAMPUS-VISIT") {
            $stconsd = " and s.latest_calling_status IN ('CAMPUS-VISIT','IC_VISIT','IC_REVISIT','CAMPUS-REVISIT') ";
        } else if ($status == "CALL-DISCONNECTED") {
            $stconsd = " and s.latest_calling_status IN ('CALL DISCONNECTED','MOBILE SERVICE DISCONNECTED','NO OUT OF SERVICE','ROUTE BUSY/ ENGAGED','WRONG_NUMBER') ";
        } else if ($status == "IN-VALID") {
            $stconsd = " and s.latest_calling_status IN ('IN-VALID','INVALID OPTION') ";
        }

        $nts = " and (nts IS NULL oR nts =0) ";

        //ld.calling_status IS NOT NULL and ld.active='Y' and ld.calling_status='".$status."' and ld.academic_year='$academic_year'
        $sql = "SELECT count(distinct s.id) as cnt
		FROM lead_assign_details as ld
        inner JOIN student_meet_details s on ld.stud_id=s.id     
        left join event_details ed on s.event_code=ed.event_code
        left join institute_master im on ed.institue_id=im.institue_id
        LEFT JOIN standard_master sm ON s.standard=sm.standard_id        
       inner join ic_users iu on iu.um_id=ld.lead_assign
        where s.academic_year='$academic_year' $stconsd $nts
		
        and ld.calling_event='" . $evt . "'  " . $cond . "

and ld.active='Y' $ic_con
		AND s.student_name IS NOT NULL 
         order by ld.called_on desc $lm";
        // echo $sql;
        //exit;
        $query = $this->db->query($sql);

        // echo $this->db->last_query(); 
        $res = $query->result_array();
        return $res[0]['cnt'];
    }



    function get_interested_call_list_new_status_countf($evt, $status, $sub = '')
    {
        $academic_year = ACADEMIC_YEAR;
        $user_id = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');
        $ic_code = $this->session->userdata('ic_code');
        $ic_con = '';
        if ($ic_code != 'SU_MH_080') {
            $ic_con = " and s.id NOT in (select stud_id  from lead_assign_details where lead_assign_by=$user_id
		  and lead_assign !='$user_id' and lead_assign_details.active='Y')
		  
		  
		 ";
        }
        if ($user_id == "superadmin" || $user_id == "admin") {
            $cond = " ";
        } else {
            // $cond="and c.called_by='". $user_id ."'";
            $cond = "and ld.lead_assign='" . $user_id . "'";
        }
        $stconsd = " and s.latest_calling_status ='$status' ";

        $nts = ' and (nts IS NULL OR nts =0) ';
        if ($status == "CAMPUS-VISIT") {
            $stconsd = " and s.latest_calling_status IN ('CAMPUS-VISIT','IC_VISIT','IC_REVISIT','CAMPUS-REVISIT') ";
        } else if ($status == "CALL-DISCONNECTED") {
            $stconsd = " and s.latest_calling_status IN ('CALL DISCONNECTED','MOBILE SERVICE DISCONNECTED','NO OUT OF SERVICE','ROUTE BUSY/ ENGAGED','WRONG_NUMBER') ";
        } else if ($status == "IN-VALID") {
            $stconsd = " and s.latest_calling_status IN ('IN-VALID','INVALID OPTION') ";
        }
        $m = '';
        if (!empty($sub)) {
            if ($sub == 'INHOUSE') {
                $m = " and s.utm_source IN (select utm_source from inhouse_digital_source where academic_year='$academic_year' and status='Y') ";
            } else if ($sub == 'AFFILIATES') {
                $m = " and s.utm_source  NOT IN (select utm_source from inhouse_digital_source where academic_year='$academic_year' and status='Y') ";
            } else {
                $m = " and s.utm_source='$sub' ";
            }
        }



        //ld.calling_status IS NOT NULL and ld.active='Y' and ld.calling_status='".$status."' and ld.academic_year='$academic_year'
        $sql = "SELECT count(distinct s.id) as cnt
		FROM lead_assign_details as ld
        inner JOIN student_meet_details s on ld.stud_id=s.id     
        left join event_details ed on s.event_code=ed.event_code
        left join institute_master im on ed.institue_id=im.institue_id
        LEFT JOIN standard_master sm ON s.standard=sm.standard_id        
       inner join ic_users iu on iu.um_id=ld.lead_assign
        where s.academic_year='$academic_year' $stconsd
		
        and ld.calling_event='" . $evt . "'  " . $cond . "

and ld.active='Y' $ic_con $nts $m
		AND s.student_name IS NOT NULL 
         order by ld.called_on desc $lm";

        if ($user_id == 3600) {
            // echo $sql;
            // exit;
        }
        // 
        //
        $query = $this->db->query($sql);

        // echo $this->db->last_query(); 
        $res = $query->result_array();
        return $res[0]['cnt'];
    }




    function user_assign_call_list_newcount($evt, $rowno = '', $rowperpage = '', $sub = '')
    {
        $user_id = $this->session->userdata('uid');
        $academic_year = ACADEMIC_YEAR;
        $ic_code = $ic = $this->session->userdata('ic_code');


        if ($rowno != '' && $rowperpage != '') {
            $lm = 'limit ' . $rowno . ',' . $rowperpage;
        } else {
            $lm = '';
        }

        $nts = " and (s.nts IS NULL OR s.nts =0) ";

        // and s.id NOT In (select student_id from calling_log_details)
        //and ld.stud_id NOT IN(select Distinct(lead_assign_details.stud_id) from lead_assign_details where lead_assign_details.calling_status !='NA' AND lead_assign_details.lead_assign ='".$user_id."')
        $ic_con = '';
        if ($ic_code != 'SU_MH_080') {
            $ic_con = " and s.id NOT in (select stud_id  from lead_assign_details where lead_assign_by=$user_id
		  and lead_assign !='$user_id' and lead_assign_details.active='Y' and ld.calling_event !='DIGITAL' )
		  
		 
		  ";
        }
        $ic_con = '';

        $m = '';
        if ($sub == 'INHOUSE') {
            $m = " and s.utm_source IN (select utm_source from inhouse_digital_source where academic_year='$academic_year' and status='Y') ";
        } else if ($sub == 'AFFILIATES') {
            $m = " and s.utm_source  NOT IN (select utm_source from inhouse_digital_source where academic_year='$academic_year' and status='Y') ";
        } else {
            $m = " and s.utm_source='$sub' ";
        }
        $sql = "SELECT s.created_date as lead_date
 FROM  lead_assign_details as ld
 inner JOIN student_meet_details as s ON ld.stud_id = s.id and ld.academic_year=s.academic_year
LEFT JOIN ic_registration i ON i.ic_code=s.ic_code
  left join event_details ed on s.event_code=ed.event_code
left join institute_master im on ed.institue_id=im.institue_id
LEFT JOIN school_course p ON s.programme_id = p.course_id
  WHERE (ld.calling_status IS NULL OR ld.calling_status='NA') and ld.active='Y' and (ld.calling_event='" . $evt . "' or ld.calling_event='')  and ld.active = 'Y' and ld.academic_year='" . $this->config->item('ic_year') . "' and ld.lead_assign = '" . $user_id . "' and s.latest_calling_status=''  $ic_con  $nts $m
group by ld.stud_id order by DATE(ld.called_on) ASC ,s.student_name ASC  $lm";
        //echo $sql;
        //exit;

        $query = $this->db->query($sql);
        if ($user_id == 1986) {
            //echo $this->db->last_query(); exit; 
        }
        $res = $query->num_rows();
        return $res;
    }




    function user_assign_call_list_new($evt, $rowno = '', $rowperpage = '', $sub = '')
    {
        $user_id = $this->session->userdata('uid');
        $academic_year = ACADEMIC_YEAR;
        $ic_code = $ic = $this->session->userdata('ic_code');

        /*$sql="SELECT ld.calling_status as lcalling_status,ld.id,s.id as std_id,ld.calling_event,s.student_name,s.mobile1,s.mobile1_valid,ld.calling_status,s.lead_assign,s.landmark,cm.city_name,
CASE WHEN i.ic_name IS NULL THEN s.utm_source ELSE i.ic_name END AS ic_name,
CASE WHEN p.sprogramm_acro IS NULL THEN s.programme_status ELSE p.sprogramm_acro  END AS course,
st.stream_name,sm.standard_name
 FROM  lead_assign_details as ld
 LEFT JOIN student_meet_details as s ON ld.stud_id = s.id
LEFT JOIN ic_registration i ON i.ic_code=s.ic_code
LEFT JOIN sandipun_univerdb.school_programs_new p ON p.sp_id=s.programme_id
LEFT JOIN stream_master st ON st.stream_id=s.stream
LEFT JOIN standard_master sm ON sm.standard_id=s.standard
LEFT JOIN city_master cm ON cm.city_id=s.city_id
  WHERE ld.calling_status IS NULL and ld.active='Y' and ld.calling_event='".$evt."' and ld.active = 'Y' and ld.academic_year='".$this->config->item('ic_year')."' and ld.lead_assign = '".$user_id."'   ";
                   */
        if ($rowno != '' && $rowperpage != '') {
            $lm = 'limit ' . $rowno . ',' . $rowperpage;
        } else {
            $lm = 'limit 0,50';
        }



        // and s.id NOT In (select student_id from calling_log_details)
        $m = '';
        if (!empty($sub)) {
            if ($sub == 'INHOUSE') {
                $m = " and s.utm_source IN (select utm_source from inhouse_digital_source where academic_year='$academic_year' and status='Y') ";
            } else if ($sub == 'AFFILIATES') {
                $m = " and s.utm_source  NOT IN (select utm_source from inhouse_digital_source where academic_year='$academic_year' and status='Y') ";
            } else {
                $m = " and s.utm_source='$sub' ";
            }

            //$m=" and s.utm_source='$sub' ";	
        }

        $nts = ' and (s.nts IS NULL OR s.nts =0) ';
        $ic_con = '';
        if ($ic_code != 'SU_MH_080') {
            $ic_con = " and s.id NOT in (select stud_id  from lead_assign_details where lead_assign_by=$user_id
		  and lead_assign !='$user_id' and lead_assign_details.active='Y' and ld.calling_event !='DIGITAL' )
		  $m
		 
		  ";
        }

        //and ld.stud_id NOT IN(select Distinct(lead_assign_details.stud_id) from lead_assign_details where lead_assign_details.calling_status !='NA' AND lead_assign_details.lead_assign ='".$user_id."')
        $ic_con = '';

        $sql = "SELECT s.created_date as lead_date,
				   0 as total_callcount,
				   ld.lead_assign_by, ld.lead_assign_on,
				   s.multiplecourses,ld.calling_status as lcalling_status,im.institute_name,ed.event_date,ld.id,s.id as std_id,ld.calling_event,s.student_name,s.programme_id,s.mobile1,s.pmobile_no,s.whatsappno,s.pwhatsapp_no,ld.calling_status,s.city_name,s.state_name,s.mobile1_valid,s.country_name,s.mock_testseries_sms_status,s.campus_id,s.programme_id,
CASE WHEN i.ic_name IS NULL THEN CONCAT(s.utm_source,' - ',s.utm_campaign) ELSE i.ic_name END AS ic_name,
strm.stream_name,'' as standard_name,s.mock_interested,s.sujee_interested,p.course as course_name
 FROM  lead_assign_details as ld
 inner JOIN student_meet_details as s ON ld.stud_id = s.id and ld.academic_year=s.academic_year
LEFT JOIN ic_registration i ON i.ic_code=s.ic_code
  left join event_details ed on s.event_code=ed.event_code
left join institute_master im on ed.institue_id=im.institue_id
LEFT JOIN school_course p ON s.programme_id = p.course_id

left join su_sf_sijoul_stream_details strm on s.programme_id=strm.stream_id and s.campus_id=strm.belongtocampus
  WHERE  ld.active='Y' and (ld.calling_event='" . $evt . "'  or ld.calling_event='') and ld.active = 'Y' and ld.academic_year='" . $this->config->item('ic_year') . "' and ld.lead_assign = '" . $user_id . "' and s.latest_calling_status =''  $ic_con $nts   $m
group by ld.stud_id order by DATE(ld.called_on) ASC ,s.student_name ASC  $lm";


        $query = $this->db->query($sql);
        if ($user_id == 478440) {
            // echo $this->db->last_query(); exit; 
        }
        $res = $query->result_array();
        return $res;
    }




    function user_assign_call_list_new_count($evt)
    {
        $user_id = $this->session->userdata('uid');
        $academic_year = ACADEMIC_YEAR;
        $ic = $this->session->userdata('ic_code');
        $nts = ' and (s.nts IS NULL OR s.nts=0)';
        $sql = "SELECT count(distinct s.id) as cnt
 FROM  lead_assign_details as ld 
 inner JOIN student_meet_details as s ON ld.stud_id = s.id and ld.academic_year=s.academic_year
LEFT JOIN ic_registration i ON i.ic_code=s.ic_code
  left join event_details ed on s.event_code=ed.event_code and ld.academic_year=ed.academic_year
        left join institute_master im on ed.institue_id=im.institue_id
 #LEFT JOIN school_course p ON s.programme_id = p.course_id
#LEFT JOIN stream_master st ON st.stream_id=s.stream
LEFT JOIN standard_master sm ON sm.standard_id=s.standard

  WHERE (s.latest_calling_status='') and ld.active='Y' and ld.calling_event='" . $evt . "'  and ld.active = 'Y' and ld.academic_year='" . $academic_year . "' and ld.lead_assign = '" . $user_id . "' $nts   
";
        $query = $this->db->query($sql);
        //echo $this->db->last_query();
        // exit;
        $res = $query->result_array();
        return $res[0]['cnt'];
    }
    function get_interested_call_list_new($evt)
    {
        $user_id = $this->session->userdata('name');
        if ($user_id == "superadmin" || $user_id == "admin" || $user_id == "1158") {
            $cond = " ";
        } else {
            // $cond="and c.called_by='". $user_id ."'";
            $cond = "and ld.lead_assign='" . $user_id . "'";
        }
        $sql = "SELECT s.admission_form_taken,ld.calling_status as lcalling_status,ld.calling_event,s.provisional_admission,ld.id,
        s.id as std_id,c.student_id,s.exam_id,s.student_name,s.mobile1_valid,c.mobile_no as mobile1,c.conve_time,c.called_by as call_callby,c.called_on,DATE(c.called_on) AS call_date, c.calling_status as call_status ,c.Course_Interested, s.mobile1_status,c.remark as call_remark,c.visite_ic_code,c.visite_date,c.conve_time,
        CASE WHEN i.ic_name IS NULL THEN s.utm_source ELSE i.ic_name END AS ic_name,
        CASE WHEN p.sprogramm_acro IS NULL THEN s.programme_status ELSE p.sprogramm_acro  END AS course,
        st.stream_name,sm.standard_name,case when ct.city_name is null then s.landmark else ct.city_name end as city 
        FROM lead_assign_details as ld
        left JOIN student_meet_details s on s.id = ld.stud_id
        left join calling_log_details c on ld.stud_id = c.student_id and ld.id = c.ld_id
        JOIN (SELECT MAX(c.c_id) AS c_id FROM calling_log_details AS c,lead_assign_details AS lds WHERE c.ld_id=lds.id and lds.calling_event= '" . $evt . "' and lds.lead_assign = '" . $user_id . "' GROUP BY c.student_id) max ON c.c_id = max.c_id 
        LEFT JOIN ic_registration i ON i.ic_code=s.ic_code
        LEFT JOIN sandipun_univerdb.school_programs_new p ON p.sp_id=s.programme_id
        LEFT JOIN stream_master st ON st.stream_id=s.stream
        LEFT JOIN standard_master sm ON sm.standard_id=s.standard
        left join city_master ct on ct.city_id=s.city_id
        where ld.calling_status IS NOT NULL and ld.active='Y' and ld.calling_event='" . $evt . "'  " . $cond . " AND s.student_name IS NOT NULL group by ld.stud_id,c.mobile_no,c.called_by order by c.called_on desc";
        $query = $this->db->query($sql);
        //echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }
    function get_interested_call_list_new1($evt)
    {
        $user_id = $this->session->userdata('uid');
        if ($user_id == "superadmin" || $user_id == "admin") {
            $cond = " ";
        } else {
            // $cond="and c.called_by='". $user_id ."'";
            $cond = "and ld.lead_assign='" . $user_id . "'";
        }
        $sql = "SELECT s.admission_form_taken,im.institute_name,ed.event_date,ld.calling_status as lcalling_status,ld.lead_assign,ld.calling_event,s.provisional_admission,ld.id,s.mobile1_valid,
        s.id as std_id,s.student_name,s.mobile1,s.pmobile_no,s.whatsappno,s.pwhatsapp_no,
        CASE WHEN iu.ic_name IS NULL THEN s.utm_source ELSE iu.ic_name END AS ic_name, 
        s.stream_name,sm.standard_name,s.city_name as city,s.state_name as state_name,s.mock_interested,s.sujee_interested,CONCAT(iu.fname,' ',iu.lname) as caller_name  
        FROM lead_assign_details as ld
        inner JOIN student_meet_details s on ld.stud_id=s.id      
        left join event_details ed on s.event_code=ed.event_code
        left join institute_master im on ed.institue_id=im.institue_id
        LEFT JOIN standard_master sm ON s.standard=sm.standard_id        
       inner join ic_users iu on iu.um_id=ld.lead_assign
        where ld.calling_status IS NOT NULL and ld.active='Y' 
        and ld.calling_event='" . $evt . "'  " . $cond . " AND s.student_name IS NOT NULL 
        group by ld.stud_id order by ld.called_on desc";
        $query = $this->db->query($sql);

        // echo $this->db->last_query(); 
        $res = $query->result_array();
        return $res;
    }

    function get_interested_call_list_new_status($evt, $status, $rowno = '', $rowperpage = '', $sub = '')
    {
        $user_id = $this->session->userdata('uid');
        $academic_year = ACADEMIC_YEAR;
        if ($user_id == "superadmin" || $user_id == "admin") {
            $cond = " ";
        } else {
            // $cond="and c.called_by='". $user_id ."'";
            $cond = "and ld.lead_assign='" . $user_id . "'";
        }
        if ($rowno != '' && $rowperpage != '') {
            $lm = 'limit ' . $rowno . ',' . $rowperpage;
        } else {
            $lm = '';
        }

        if ($status == "CALL-DISCONNECTED") {
            $statuscon = " and s.latest_calling_status IN ('CALL DISCONNECTED','MOBILE SERVICE DISCONNECTED','NO OUT OF SERVICE','ROUTE BUSY/ ENGAGED','WRONG_NUMBER') ";
        } else {
            $statuscon = " and s.latest_calling_status IN ('$status')";
        }
        ////LEFT JOIN standard_master sm ON s.standard=sm.standard_idLEFT JOIN school_course p ON s.programme_id = p.course_id (select count(student_id) from calling_log_details as crd where student_id=s.id and crd.called_by=ld.lead_assign)

        $m = '';
        if (!empty($sub)) {
            if ($sub == 'INHOUSE') {
                $m = " and s.utm_source IN (select utm_source from inhouse_digital_source where academic_year='$academic_year' and status='Y') ";
            } else if ($sub == 'AFFILIATES') {
                $m = " and s.utm_source NOT IN (select utm_source from inhouse_digital_source where academic_year='$academic_year' and status='Y') ";
            } else {
                $m = " and s.utm_source='$sub' ";
            }

            //$m=" and s.utm_source='$sub' ";	
        }
        $ns = " and (s.nts IS NULL OR s.nts=0)";
        $sql = "SELECT 
		
 '' as total_callcount,
		ld.lead_assign_by,ld.lead_assign_on,
		s.created_date as lead_date,s.admission_form_taken,im.institute_name,ed.event_date,s.programme_id,s.latest_calling_status as lcalling_status,ld.lead_assign,ld.calling_event,s.provisional_admission,ld.id,s.mobile1_valid,s.country_name,
        s.id as std_id,s.student_name,s.mobile1,s.pmobile_no,s.whatsappno,s.pwhatsapp_no,s.multiplecourses,s.campus_id,
        CASE WHEN s.ic_code ='digital' THEN CONCAT(s.utm_source,' - ',s.utm_campaign) ELSE ir.ic_name END AS ic_name,
        strm.stream_name,DATE_FORMAT(ld.called_on, '%r') AS date_added,'' as standard_name,s.city_name,s.state_name as state_name,s.mock_interested,s.sujee_interested,s.mock_testseries_sms_status,CONCAT(iu.fname,' ',iu.lname) as caller_name ,'' as course_name
        FROM lead_assign_details as ld
        inner JOIN student_meet_details s on ld.stud_id=s.id 
        left join event_details ed on s.event_code=ed.event_code
        left join institute_master im on ed.institue_id=im.institue_id
        left join su_sf_sijoul_stream_details as strm on s.programme_id=strm.stream_id and s.campus_id=strm.belongtocampus
                
       inner join ic_users iu on iu.um_id=ld.lead_assign
       left join ic_registration ir ON s.ic_code=ir.ic_code
        where ld.calling_status IS NOT NULL and ld.active='Y' $statuscon and s.academic_year='$academic_year'
        and ld.calling_event='" . $evt . "'  " . $cond . " AND s.student_name IS NOT NULL $ns $m
        group by ld.stud_id order by DATE(ld.called_on) ASC ,date_added DESC $lm";


        //exit;	   
        $query = $this->db->query($sql);


        $res = $query->result_array();
        return $res;
    }


    function get_sujee_registration($evt, $status, $rowno = '', $rowperpage = '')
    {

        $user_id = $this->session->userdata('uid');
        if ($user_id == "superadmin" || $user_id == "admin") {
            $cond = " ";
        } else {
            // $cond="and c.called_by='". $user_id ."'";
            $cond = "and ld.lead_assign='" . $user_id . "'";
        }
        if ($rowno != '' && $rowperpage != '') {
            $lm = 'limit ' . $rowno . ',' . $rowperpage;
        } else {
            $lm = '';
        }
        $sql = "SELECT s.admission_form_taken,im.institute_name,ed.event_date,ld.calling_status as lcalling_status,ld.lead_assign,ld.calling_event,s.provisional_admission,ld.id,s.mobile1_valid,s.country_name,
        s.id as std_id,s.student_name,s.mobile1,s.pmobile_no,s.whatsappno,s.pwhatsapp_no,s.mock_testseries_sms_status,
        CASE WHEN s.ic_code ='digital' THEN CONCAT(s.utm_source,' - ',s.utm_campaign) ELSE ir.ic_name END AS ic_name,
        s.stream_name,DATE_FORMAT(ld.called_on, '%r') AS date_added,sm.standard_name,s.city_name,s.state_name as state_name,s.mock_interested,s.sujee_interested,CONCAT(iu.fname,' ',iu.lname) as caller_name ,p.course as course_name
        FROM su_jee_registration rg
        inner JOIN student_meet_details s on rg.student_id=s.id  
        inner join lead_assign_details as ld  ON rg.student_id=ld.stud_id    
        left join event_details ed on s.event_code=ed.event_code
        left join institute_master im on ed.institue_id=im.institue_id
        LEFT JOIN standard_master sm ON s.standard=sm.standard_id
        LEFT JOIN school_course p ON s.programme_id = p.course_id        
       inner join ic_users iu on iu.um_id=ld.lead_assign
       left join ic_registration ir ON s.ic_code=ir.ic_code
        where ld.calling_status IS NOT NULL and ld.active='Y' and rg.is_active='Y' and rg.inserted_by='" . $user_id . "'
        and ld.calling_event='" . $evt . "'  " . $cond . " AND s.student_name IS NOT NULL AND rg.exam_no IN('21','22','11','3') and rg.is_active='Y' and ld.calling_status='INTERESTED'
        group by ld.stud_id order by DATE(ld.called_on) ASC ,date_added ASC $lm";
        $query = $this->db->query($sql);


        $res = $query->result_array();
        return $res;
    }
    function get_sujee_registration_count($evt)
    {
        $user_id = $this->session->userdata('uid');
        if ($user_id == "superadmin" || $user_id == "admin") {
            $cond = " ";
        } else {
            // $cond="and c.called_by='". $user_id ."'";
            $cond = "and ld.lead_assign='" . $user_id . "'";
        }
        $sql = "SELECT count(distinct rg.student_id) as cnt
        FROM su_jee_registration rg
        inner JOIN student_meet_details s on rg.student_id=s.id  
        inner join lead_assign_details as ld  ON rg.student_id=ld.stud_id    
        left join event_details ed on s.event_code=ed.event_code
        left join institute_master im on ed.institue_id=im.institue_id
        LEFT JOIN standard_master sm ON s.standard=sm.standard_id
        LEFT JOIN school_course p ON s.programme_id = p.course_id        
       inner join ic_users iu on iu.um_id=ld.lead_assign
       left join ic_registration ir ON s.ic_code=ir.ic_code
        where ld.calling_status IS NOT NULL and ld.calling_status='INTERESTED' and ld.active='Y' AND rg.exam_no IN('21','22','11','3') and  rg.is_active='Y' and rg.inserted_by='" . $user_id . "'
        and ld.calling_event='" . $evt . "'  " . $cond . " AND s.student_name IS NOT NULL 
         ";


        $query = $this->db->query($sql);

        // echo $this->db->last_query(); 
        $res = $query->result_array();
        return $res[0]['cnt'];
    }
    function get_My_byevent1($evt)
    {
        $user_id = $this->session->userdata('name');
        if ($user_id == "superadmin" || $user_id == "admin" || $user_id == "1158") {
            $cond = " ";
        } else {
            // $cond="and c.called_by='". $user_id ."'";
            $cond = "and ld.lead_assign='" . $user_id . "'";
        }
        $sql = "SELECT newd.conve_time,newd.visite_ic_code,newd.visite_date,s.admission_form_taken,ld.calling_status as lcalling_status,ld.lead_assign,ld.calling_event,s.provisional_admission,ld.id,
        s.id as std_id,s.exam_id,s.student_name,s.mobile1_valid,s.mobile1,s.mobile1_status,
        CASE WHEN i.ic_name IS NULL THEN s.utm_source ELSE i.ic_name END AS ic_name, p.course,     
        st.stream_name,sm.standard_name,case when ct.city_name is null then s.landmark else ct.city_name end as city 
        FROM lead_assign_details as ld
        inner JOIN student_meet_details s on ld.stud_id=s.id       
        LEFT JOIN ic_registration i ON s.ic_code=i.ic_code
        LEFT JOIN school_course p ON s.course_interested = p.course_id
        LEFT JOIN stream_master st ON s.stream=st.stream_id
        LEFT JOIN standard_master sm ON sm.standard_id=s.standard
         INNER JOIN (SELECT conve_time,student_id,visite_ic_code,visite_date FROM calling_log_details c INNER JOIN lead_assign_details ll ON ll.stud_id=c.student_id WHERE ll.calling_event='DIGITAL_LEAD'  AND ll.lead_assign='" . $user_id . "' AND DATE(c.conve_time)!='' AND DATE(c.conve_time)!='0000-00-00 00:00:00' GROUP BY student_id  ORDER BY student_id DESC) AS newd ON
        newd.student_id= ld.stud_id
        left join city_master ct on ct.city_id=s.city_id
        where ld.calling_status IS NOT NULL and ld.active='Y' 
        and ld.calling_event='" . $evt . "'  " . $cond . " AND s.student_name IS NOT NULL 
        group by ld.stud_id order by ld.called_on desc";
        $query = $this->db->query($sql);

        // echo $this->db->last_query(); 
        $res = $query->result_array();
        return $res;
    }



    function get_calling_remark($std)
    {
        $sql = "SELECT  c_id,calling_status,remark,called_by,called_on,conve_time,visite_date,visite_ic_code from calling_log_details where student_id= '" . $std . "' order by called_on DESC LIMIT 0,1";
        //exit;max(c_id) as
        $query = $this->db->query($sql);
        return $query->result_array();
    }

    function get_interested_call_list_new1_ajax($evt, $hit)
    {

        if ($hit == "demo-all") {
            $new = '';
        }


        if ($hit == "INTERESTED") {
            $new = " AND ld.calling_status='INTERESTED' AND s.provisional_admission!='Y' AND s.admission_form_taken!='Y' ";
        }
        if ($hit == "CALL_LATER") {
            //$row['lcalling_status'])=="CALL-LATER" && $row['provisional_admission']=="N" && $row['admission_form_taken'] !='Y'
            $new = " AND ld.calling_status='CALL-LATER' AND s.provisional_admission='N' AND s.admission_form_taken!='Y' ";
        }
        if ($hit == "NOT-INTERESTED") {
            //if(trim($row['lcalling_status'])=="NOT-INTERESTED" && $row['provisional_admission']!="Y" && $row['admission_form_taken'] !='Y')
            $new = " AND ld.calling_status='NOT-INTERESTED' AND s.provisional_admission='N' AND s.admission_form_taken!='Y' ";
        }
        if ($hit == "IN-VALID") {
            //if(trim($row['lcalling_status'])=="IN-VALID" && $row['provisional_admission']=="N" && $row['admission_form_taken'] !='Y'
            $new = " AND ld.calling_status='IN-VALID' AND s.provisional_admission='N' AND s.admission_form_taken!='Y' ";
        }

        if ($hit == "NOT-ELIGIBLE") {
            //if(trim($row['lcalling_status'])=="IN-VALID" && $row['provisional_admission']=="N" && $row['admission_form_taken'] !='Y'
            $new = " AND ld.calling_status='NOT-ELIGIBLE' AND s.provisional_admission='N' AND s.admission_form_taken!='Y' ";
        }




        if ($hit == "RINGING") {
            //if(trim($row['lcalling_status'])=="IN-VALID" && $row['provisional_admission']=="N" && $row['admission_form_taken'] !='Y'
            $new = " AND ld.calling_status='RINGING' AND s.provisional_admission='N' AND s.admission_form_taken!='Y' ";
        }



        if ($hit == "Walk-Inn") {
            //if(trim($row['lcalling_status'])=="IN-VALID" && $row['provisional_admission']=="N" && $row['admission_form_taken'] !='Y'
            $new = " AND ld.calling_status='CAMPUS-VISIT' OR ld.calling_status='IC_VISIT'  AND s.provisional_admission!='Y' AND s.admission_form_taken!='Y' ";
        }

        if ($hit == "Registration") {
            //if(trim($row['lcalling_status'])=="IN-VALID" && $row['provisional_admission']=="N" && $row['admission_form_taken'] !='Y'
            $new = " AND s.admission_form_taken='Y' ";
        }

        if ($hit == "AdmissionTaken") {
            //if(trim($row['lcalling_status'])=="IN-VALID" && $row['provisional_admission']=="N" && $row['admission_form_taken'] !='Y'
            $new = " AND s.provisional_admission='Y' ";
        }

        if ($hit == "TODAYCALL") {
            //if(trim($row['lcalling_status'])=="IN-VALID" && $row['provisional_admission']=="N" && $row['admission_form_taken'] !='Y'
            $new = " AND ld.calling_status='RINGING' AND s.provisional_admission='N' AND s.admission_form_taken!='Y' ";
        }

        if ($hit == "Followup") {
            //if(trim($row['lcalling_status'])=="IN-VALID" && $row['provisional_admission']=="N" && $row['admission_form_taken'] !='Y'
            $new = " AND ld.calling_status='RINGING' AND s.provisional_admission='N' AND s.admission_form_taken!='Y' ";
        }




        //////////////////////////////////////////////////
        $user_id = $this->session->userdata('name');
        if ($user_id == "superadmin" || $user_id == "admin" || $user_id == "1158") {
            $cond = " ";
        } else {
            // $cond="and c.called_by='". $user_id ."'";
            $cond = "and ld.lead_assign='" . $user_id . "'";
        }
        $sql = "SELECT s.admission_form_taken,ld.calling_status as lcalling_status,ld.lead_assign,ld.calling_event,s.provisional_admission,ld.id,
        s.id as std_id,s.exam_id,s.student_name,s.mobile1_valid,s.mobile1,s.mobile1_status,
        CASE WHEN i.ic_name IS NULL THEN s.utm_source ELSE i.ic_name END AS ic_name, p.course,     
        st.stream_name,sm.standard_name,case when ct.city_name is null then s.landmark else ct.city_name end as city 
        FROM lead_assign_details as ld
        inner JOIN student_meet_details s on ld.stud_id=s.id       
        LEFT JOIN ic_registration i ON s.ic_code=i.ic_code
        LEFT JOIN school_course p ON s.course_interested = p.course_id
        LEFT JOIN stream_master st ON s.stream=st.stream_id
        LEFT JOIN standard_master sm ON sm.standard_id=s.standard
        left join city_master ct on ct.city_id=s.city_id
        where ld.calling_status IS NOT NULL and ld.active='Y' and ld.calling_event='" . $evt . "'  " . $cond . $new . " AND s.student_name IS NOT NULL group by ld.stud_id order by ld.called_on desc";
        $query = $this->db->query($sql);

        // echo $this->db->last_query(); 
        $res = $query->result_array();
        return $res;
    }



    function update_lead_call_log($sid, $row)
    {

        $this->db->where('id', $sid);
        $this->db->update('lead_assign_details', $row);
        // echo  $this->db->last_query();exit();


    }
    function get_lead_assign_event()
    {
        $academic_year = ACADEMIC_YEAR;
        $sql = "SELECT DISTINCT calling_event  FROM lead_assign_details WHERE academic_year='$academic_year' 
and calling_event !='' 		and lead_assign='" . $this->session->userdata('uid') . "'";
        //ECHO $sql;
        //exit;
        $query = $this->db->query($sql);

        $res = $query->result_array();
        return $res;
    }
    function get_all_lead_assign_event()
    {
        $academic_year = ACADEMIC_YEAR;
        $sql = "SELECT DISTINCT calling_event  FROM lead_assign_details WHERE academic_year='$academic_year'";
        $query = $this->db->query($sql);
        //echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }
    function get_lead_assign_details_byid($id)
    {
        $sql = "SELECT * FROM lead_assign_details WHERE id='" . $id . "'";
        $query = $this->db->query($sql);
        //echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }


    function get_student_info($id)
    {
        $sql = "SELECT utm_source,ic_code FROM student_meet_details WHERE id='" . $id . "'";
        $query = $this->db->query($sql);
        $res = $query->row();
        return $res;
    }

    function get_student_by_event_new($row, $rowno = '', $rowperpage = '')
    {

        $rcc = '';
        $userID = $this->session->userdata('uid');
        $username = $this->session->userdata('name');
        $ic = $this->session->userdata('ic_code');
        $role_id = $this->session->userdata('role_id');
        $sujee_condition = " and s.event_code NOT IN ('EV/SUJEE-MBA/23','EV/SUJEE/23') ";
        $newc = '';
        $no_data = " and (s.created_by=0 OR s.created_by IS NULL)  ";
        $sms = '';
        $dc = '';
        $mcn = '';
        $bdm_co = '';
        if ($userID == '3414') {
            //and  utm_source Not LIKE "%JHA%"
            $sms = '  and   (campus_id!=2 OR campus_id IS NULL OR s.ic_code="SU_MH_01")   and  coalesce(vw.school_id,0) NOT IN (9,4,2) and s.utm_source !="Sandip University Sijoul" and utm_campaign Not LIKE "%MBA%"   and (s.created_by IS NULL or s.created_by=0 or s.created_by=' . $userID . ')  and  utm_source Not LIKE "%Nepal%" ';
            $sms1 = ' ';
        }
        if ($userID == '4172') {
            $sms = ' and  coalesce(vw.school_id,0) IN (9,4,2) and s.utm_source !="Sandip University Sijoul"  and   (campus_id!=2 OR campus_id IS NULL) ';
            $sms1 = ' and   (campus_id!=2 OR campus_id IS NULL) and  utm_source Not LIKE "%JHA%"  and  utm_source Not LIKE "%Nepal%"';
        }
        if ($userID == '3964') {
            $sms = ' and   (campus_id=2 or utm_source="Sandip University Sijoul") and utm_campaign Not LIKE "%MBA%"  ';
            $sms1 = 'and   (campus_id=2 OR campus_id IS NULL) and  utm_source Not LIKE "%JHA%" ';
            //$sms1='';
        }

        if ($userID == '2016') {
            $sms = ' and   utm_source="google-noida" ';
            $sms1 = 'and utm_source="google-noida"  ';
            //$sms1='';
        }
        if ($userID == '4117') {
            $sms = "  and  utm_source LIKE '%JHA%'  ";
            $sms1 = "  and  utm_source LIKE '%JHA%'  ";
            //$sms1='';
        }
        $is_condition = '';
        $mc = '';
        $mc1 = "select um_id from user_master where ic_code='$ic'";

        if ($username == '73767') {
            $utmsourse = "and s.utm_source not in('college Duniya','reviewadda','college_search')";
        } elseif ($userID == '3414') {
            //and  utm_source Not LIKE "%JHA%" 
            $sms = '   and  utm_source Not LIKE "%Nepal%" ';

            //$utmsourse= "and s.utm_source not in('College Duniya','Reviewadda','college_search','College Dunia','Siksha','Shiksha') and   NOT  campus_id<=>2 ";
            //$mc=' or s.created_by = NULL or s.created_by =0';
            // $mc1='select um_id from user_master where um_id=3414';
            // $mcn=' and utm_campaign NOT LIKE "%Sijoul%"';
        } elseif ($userID == '4375') {
            $utmsourse = "and s.utm_source not in('College Duniya','Reviewadda','college_search','College Dunia','Siksha','Shiksha')
			and  campus_id=2  and  utm_source Not LIKE '%JHA%' ";
        } elseif ($userID == '3877') {
            $utmsourse = "and s.utm_source in('College Duniya','College Dunia')";
            $is_condition = " and STR_TO_DATE(s.created_date,'%Y-%m-%d')>='2021-10-28' and  utm_source Not LIKE '%JHA%'";
        } elseif ($userID == '3885') {
            $utmsourse = " and s.campus_id=5 and  utm_source Not LIKE '%JHA%' ";
            $is_condition = " and STR_TO_DATE(s.created_date,'%Y-%m-%d')>='2021-10-30'";
        } else {
            $utmsourse = '';
        }
        $utm = '';
        $nts = " ";
        if ($row['ic_code'] == "digital") {

            if (!empty($row['event_code'])) {
                $utm = "and s.utm_source='" . $row['event_code'] . "' ";
            }
            $l = 'LEFT';
            if (!empty($row['sel_c_typ'])) {
                if ($row['sel_c_typ'] == 'P') {
                    $cty = " and s.is_ind = 'P'";
                } else {
                    $cty = " and s.is_ind != 'P'";
                }
            }
            if (!empty($row['digi_date']) && empty($row['digi_date_to'])) {

                $cond = " and s.ic_code = 'digital' $utm $cty and date(s.created_date) = '" . date('Y-m-d', strtotime($row['digi_date'])) . "'  $utmsourse";
                $dc = " and date(s.created_date) = '" . date('Y-m-d', strtotime($row['digi_date'])) . "'  ";
            } else if (!empty($row['digi_date']) && !empty($row['digi_date_to'])) {
                $cond = " and s.ic_code = 'digital' $utm $cty and date(s.created_date) between '" . date('Y-m-d', strtotime($row['digi_date'])) . "'  and '" . date('Y-m-d', strtotime($row['digi_date_to'])) . "' $utmsourse";
                $dc = " and date(s.created_date) between '" . date('Y-m-d', strtotime($row['digi_date'])) . "'  and '" . date('Y-m-d', strtotime($row['digi_date_to'])) . "' ";
            } else {
                $cond = " and s.ic_code = 'digital' $utm  $cty  $utmsourse ";
            }
            if ($row['led'] == '2') {
                $mob = " and s.mobile1_status is null and s.lead_assign is not null ";
            }


            //$sujee_condition=" and  ";

            if ($userID == '3414') {
                //and  utm_source Not LIKE "%JHA%"
                $mcn = ' and utm_campaign NOT LIKE "%Sijoul%"  and (s.created_by IS NULL or s.created_by=0 or s.created_by=' . $userID . ') and  utm_source Not LIKE "%sijoul_website_sujee%"  and  utm_source Not LIKE "%Nepal%"';
            }

            $rcc = "UNION
	   (SELECT DISTINCT s.id,
			CASE
			WHEN s.updated_date IS NULL THEN s.created_date
			ELSE s.updated_date
			END as consider_date,s.event_code as ecode,vw.school_short_name,vw.stream_short_name,s.campus_id,s.multiplecourses,
			s.created_date as created_date,s.utm_source,s.utm_campaign, '' as institute_name,s.country_name,
			'' as ic_name,'' as  ic_code,s.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.stream_name,'' as standard_name ,s.created_by,s.programme_id,s.programme_status,s.city_name,s.state_name,s.provisional_admission,s.walkin_status,s.stream_name as sttream
			FROM student_meet_details  s  " . $l . "
           join su_sf_sijoul_stream_details as vw on s.programme_id=vw.stream_id and s.campus_id=vw.belongtocampus
			join lead_assign_details as l on s.id=l.stud_id
			
			WHERE (s.event_code='EV/DG/1')   AND s.academic_year='" . $this->config->item('ic_year') . "' $dc    
			and  l.lead_assign_by= $userID  $utm $mcn and NOT  campus_id!=2  $sms $nts
            and s.latest_calling_status='' $no_data $sujee_condition
			AND l.stud_id NOT IN (select stud_id from lead_assign_details where lead_assign!=$userID )
			and l.stud_id NOt In (select student_id from calling_log_details)
			
			order by 
			consider_date 
			DESC )  
	   
	   ";

            if ($userID == '3964') {
                $sms1 = 'and   (campus_id=2) ';
            }
        } else {
            $mbg = '';
            if ($userID == '3964') {
                $y = " and s.academic_year = '" . $this->config->item('ic_year') . "'  ";
                $l = 'LEFT';
            } else {
                $y = " and s.academic_year = '" . $this->config->item('ic_year') . "' and ic.status='Y' ";
            }

            if (isset($row['event_code']) && $row['event_code'] != 'null' && !empty($row['event_code'])) {
                $cond = " and e.event_code='" . $row['event_code'] . "'";
                $sms1 = '';
            }
            if (!empty($row['ic_code'])) {
                $condic = " and s.ic_code='" . $row['ic_code'] . "'";
            }
            if (!empty($row['um_id'])) {
                $bdm_co = " and s.created_by='" . $row['um_id'] . "'";
            }


            // $ic = $this->session->userdata('ic_code');
            // if(!empty($ic)){
            // $condic=" and s.ic_code='".$ic."'";
            //}
        }
        //if(!empty($row['evt'])){

        $ld = " and s.lead_assign_status !='Y' ";
        // $ld = " and s.id NOT IN (  select stud_id from lead_assign_details where academic_year='".$this->config->item('ic_year')."' and ( calling_event = '".$row['evt']."' OR calling_event ='INCOMING_LEAD') and active = 'Y')";
        //}
        /* $sql = "SELECT distinct s.id,i.institute_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.mobile2,s.mobile1_status,st.stream_name,sm.standard_name ,s.created_by,s.created_date,s.programme_id,s.programme_status
                FROM student_meet_details  s 
                LEFT JOIN event_details e  ON s.event_code=e.event_code 
                LEFT JOIN institute_master i ON i.institue_id=e.institue_id
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN stream_master st ON st.stream_id=s.stream
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard                
                WHERE   ".$cond." order by s.created_date desc , s.id desc"; */
        if ($rowno != '' && $rowperpage != '') {
            $lm = 'limit ' . $rowno . ',' . $rowperpage;
        } else {
            $lm = 'limit 0,2000';
        }
        $mcc = '';
        $newc = "UNION 
			(SELECT DISTINCT s.id,
			CASE
    WHEN s.updated_date IS NULL THEN s.created_date
	ELSE s.updated_date
		END as consider_date,s.event_code as ecode,vw.school_short_name,vw.stream_short_name,s.campus_id,s.multiplecourses,
			s.created_date as created_date,s.utm_source,s.utm_campaign,i.institute_name,s.country_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.stream_name,sm.standard_name ,s.created_by,s.programme_id,s.programme_status,s.city_name,s.state_name,s.provisional_admission,s.walkin_status,s.stream_name as sttream
                FROM student_meet_details  s  " . $l . "
                JOIN event_details e  ON e.event_code=s.event_code AND s.academic_year=e.academic_year
                 " . $l . " JOIN institute_master i ON i.institue_id=e.institue_id AND s.academic_year=i.academic_year
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard 
                   left join su_sf_sijoul_stream_details as vw on s.programme_id=vw.stream_id and s.campus_id=vw.belongtocampus
            
                WHERE (s.event_code!='Consultant' ) and s.mobile1_valid !='N' and s.is_display='N' and s.event_code !='EV/SUJEE/23' 
                
				AND s.academic_year='" . $this->config->item('ic_year') . "' " . $ld . " " . $y . " " . $cond . " " . $condic . " " . $mob . "  $nts $is_condition $utmsourse $sms1 $mcn $sujee_condition $bdm_co order by 
			     consider_date 
				DESC )";

        if ($role_id == 1 || $userID == '3414') {

            $mcc = "UNION
	   (SELECT DISTINCT s.id,
			CASE
			WHEN s.updated_date IS NULL THEN s.created_date
			ELSE s.updated_date
			END as consider_date,s.event_code as ecode,vw.school_short_name,vw.stream_short_name,s.campus_id,s.multiplecourses,
			s.created_date as created_date,s.utm_source,s.utm_campaign,i.institute_name,s.country_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.stream_name,sm.standard_name ,s.created_by,s.programme_id,s.programme_status,s.city_name,s.state_name,s.provisional_admission,s.walkin_status,s.stream_name as sttream
			FROM student_meet_details  s  " . $l . "
			JOIN event_details e  ON e.event_code=s.event_code AND s.academic_year=e.academic_year
			" . $l . " JOIN institute_master i ON i.institue_id=e.institue_id AND s.academic_year=i.academic_year
			LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
			LEFT JOIN standard_master sm ON sm.standard_id=s.standard 
			left join su_sf_sijoul_stream_details as vw on s.programme_id=vw.stream_id and s.campus_id=vw.belongtocampus
			join lead_assign_details as l on s.id=l.stud_id
			WHERE (s.event_code!='Consultant')  and s.mobile1_valid !='N' and s.is_display='N' AND s.academic_year='" . $this->config->item('ic_year') . "'  " . $y . "  " . $mob . " $dc   and s.event_code !='EV/SUJEE/23'   $no_data
			and  l.lead_assign= $userID  $utm $mcn $sujee_condition and campus_id !=2  $sms $nts $bdm_co
            
			AND l.stud_id NOT IN (select stud_id from lead_assign_details where lead_assign_by!=4027)
			
			
			order by 
			consider_date 
			DESC )  
	   
	   ";
        }
        $ggg = '';
        if ($userID == '4172') {
            $ggg = "
	   UNION 
				(SELECT DISTINCT s.id,
			CASE
    WHEN s.updated_date IS NULL THEN s.created_date
	ELSE s.updated_date
		END as consider_date,s.event_code as ecode,vw.school_short_name,vw.stream_short_name,s.campus_id,s.multiplecourses,
			s.created_date as created_date,s.utm_source,s.utm_campaign,i.institute_name,s.country_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,em.exam_name as stream_name,sm.standard_name ,s.created_by,s.programme_id,s.programme_status,s.city_name,s.state_name,s.provisional_admission,s.walkin_status,s.stream_name as sttream
                FROM student_meet_details  s  " . $l . "
                JOIN event_details e  ON e.event_code=s.event_code AND s.academic_year=e.academic_year
                 " . $l . " JOIN institute_master i ON i.institue_id=e.institue_id AND s.academic_year=i.academic_year
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard 
                left join su_sf_sijoul_stream_details as vw on s.programme_id=vw.stream_id and s.campus_id=vw.belongtocampus
                join su_jee_registration as srt on s.id=srt.student_id
				join exam_master as em on srt.exam_no=em.exam_id
                WHERE s.event_code  LIKE '%EV/SUJEE%' and ( s.created_by IS NULL or s.created_by=0 or s.created_by='' ) and s.mobile1_valid !='N' and s.is_display='N'
                
				AND s.academic_year='" . $this->config->item('ic_year') . "' " . $ld . " " . $y . " " . $cond . " " . $condic . " " . $mob . "  $nts $is_condition  $mcn $no_data $bdm_co
				and srt.exam_no IN (12,47,48,5,49,50,51,3) group by s.id
				
				order by 
			     consider_date 
				DESC )
	  
	  
	  ";
        }
        if ($userID == '3414' || $userID == '1' || $userID == 4027) {
            $ggg = "
	   UNION 
				(SELECT DISTINCT s.id,
			CASE
    WHEN s.updated_date IS NULL THEN s.created_date
	ELSE s.updated_date
		END as consider_date,s.event_code as ecode,vw.school_short_name,vw.stream_short_name,s.campus_id,s.multiplecourses,
			s.created_date as created_date,s.utm_source,s.utm_campaign,i.institute_name,s.country_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,em.exam_name as stream_name,sm.standard_name ,s.created_by,s.programme_id,s.programme_status,s.city_name,s.state_name,s.provisional_admission,s.walkin_status,s.stream_name as sttream
                FROM student_meet_details  s  " . $l . "
                JOIN event_details e  ON e.event_code=s.event_code AND s.academic_year=e.academic_year
                 " . $l . " JOIN institute_master i ON i.institue_id=e.institue_id AND s.academic_year=i.academic_year
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard 
                left join su_sf_sijoul_stream_details as vw on s.programme_id=vw.stream_id and s.campus_id=vw.belongtocampus
                join su_jee_registration as srt on s.id=srt.student_id
				join exam_master as em on srt.exam_no=em.exam_id
                WHERE s.event_code  LIKE '%EV/SUJEE%' and ( s.created_by IS NULL or s.created_by=0 or s.created_by='' or s.created_by='.$userID.' ) and s.mobile1_valid !='N' and s.is_display='N'
                
				AND s.academic_year='" . $this->config->item('ic_year') . "' " . $ld . " " . $y . " " . $cond . " " . $condic . " " . $mob . "  $nts $is_condition  $mcn $no_data  $bdm_co
				 group by s.id
				
				order by 
			     consider_date 
				DESC )
	  
	  
	  ";
        }
        $sql = "select * from ((SELECT DISTINCT s.id,
			CASE
			WHEN s.updated_date IS NULL THEN s.created_date
			ELSE s.updated_date
			END as consider_date,s.event_code as ecode,vw.school_short_name,vw.stream_short_name,s.campus_id,s.multiplecourses,
			s.created_date as created_date,s.utm_source,s.utm_campaign,i.institute_name,s.country_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.stream_name,sm.standard_name ,s.created_by,s.programme_id,s.programme_status,s.city_name,s.state_name,s.provisional_admission,s.walkin_status,s.stream_name as sttream
			FROM student_meet_details  s  " . $l . "
			JOIN event_details e  ON e.event_code=s.event_code AND s.academic_year=e.academic_year
			" . $l . " JOIN institute_master i ON i.institue_id=e.institue_id AND s.academic_year=i.academic_year
			LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
			LEFT JOIN standard_master sm ON sm.standard_id=s.standard 
			left join su_sf_sijoul_stream_details as vw on s.programme_id=vw.stream_id and s.campus_id=vw.belongtocampus
			join lead_assign_details as l on s.id=l.stud_id
			
			WHERE (s.event_code!='Consultant')  and s.mobile1_valid !='N' and s.is_display='N' AND s.academic_year='" . $this->config->item('ic_year') . "'  " . $y . "  " . $mob . "  $nts and s.event_code !='EV/SUJEE/23' $bdm_co   $cond $sms $mcn $no_data
			and  l.lead_assign= $userID  $utm $sujee_condition  AND l.stud_id NOT IN (select stud_id from lead_assign_details where lead_assign_by=$userID)
			
			
			order by 
			consider_date 
			DESC )  
			$newc $mcc
				 UNION 
				(SELECT DISTINCT s.id,
			CASE
    WHEN s.updated_date IS NULL THEN s.created_date
	ELSE s.updated_date
		END as consider_date,s.event_code as ecode,vw.school_short_name,vw.stream_short_name,s.campus_id,s.multiplecourses,
			s.created_date as created_date,s.utm_source,s.utm_campaign,i.institute_name,s.country_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.stream_name,sm.standard_name ,s.created_by,s.programme_id,s.programme_status,s.city_name,s.state_name,s.provisional_admission,s.walkin_status,s.stream_name as sttream
                FROM student_meet_details  s  " . $l . "
                JOIN event_details e  ON e.event_code=s.event_code AND s.academic_year=e.academic_year
                 " . $l . " JOIN institute_master i ON i.institue_id=e.institue_id AND s.academic_year=i.academic_year
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard 
                   left join su_sf_sijoul_stream_details as vw on s.programme_id=vw.stream_id and s.campus_id=vw.belongtocampus
              
                WHERE (s.event_code ='EV/SUJEE/23' and ( s.created_by in ($mc1)  $mc )) and s.mobile1_valid !='N' and s.is_display='N'
                
				AND s.academic_year='" . $this->config->item('ic_year') . "' " . $ld . " " . $y . " " . $cond . " " . $condic . " " . $mob . " $sujee_condition $nts $is_condition $sms $mcn $no_data $bdm_co order by 
			     consider_date 
				DESC )
				
				$rcc
				$ggg
				) a group by a.id
				$lm";




        //echo $sql;
        //echo $sql;

        //exit;



        //#s.created_date,s.updated_date   
        $query = $this->db->query($sql);
        //echo $this->db->last_query();exit;
        $res = $query->result_array();

        return $res;
    }









    function get_student_by_event_new_test($row, $rowno = '', $rowperpage = '')
    {

        $rcc = '';
        $userID = $this->session->userdata('uid');
        $username = $this->session->userdata('name');
        $ic = $this->session->userdata('ic_code');
        $role_id = $this->session->userdata('role_id');
        $sujee_condition = " and s.event_code NOT IN ('EV/SUJEE-MBA/23','EV/SUJEE/23') ";
        $newc = '';
        $no_data = " and (s.created_by=0 OR s.created_by IS NULL)  ";
        $sms = '';
        $dc = '';
        $mcn = '';
        if ($userID == '3414') {
            $sms = '  and   (campus_id!=2 OR campus_id IS NULL)   and  coalesce(vw.school_id,0) NOT IN (9,4,2) and s.utm_source !="Sandip University Sijoul" and utm_campaign Not LIKE "%MBA%"  ';
            $sms1 = ' and   (campus_id!=2 OR campus_id IS NULL) ';
        }
        if ($userID == '4172') {
            $sms = ' and  coalesce(vw.school_id,0) IN (9,4,2) and s.utm_source !="Sandip University Sijoul"  and   (campus_id!=2 OR campus_id IS NULL) ';
            $sms1 = ' and   (campus_id!=2 OR campus_id IS NULL) ';
        }
        if ($userID == '3964') {
            $sms = ' and   (campus_id=2 or utm_source="Sandip University Sijoul") and utm_campaign Not LIKE "%MBA%"  ';
            $sms1 = 'and   (campus_id!=1) ';
            //$sms1='';
        }
        $is_condition = '';
        $mc = '';
        $mc1 = "select um_id from user_master where ic_code='$ic'";

        if ($username == '73767') {
            $utmsourse = "and s.utm_source not in('college Duniya','reviewadda','college_search')";
        } elseif ($userID == '3414') {
            //$utmsourse= "and s.utm_source not in('College Duniya','Reviewadda','college_search','College Dunia','Siksha','Shiksha') and   NOT  campus_id<=>2 ";
            //$mc=' or s.created_by = NULL or s.created_by =0';
            // $mc1='select um_id from user_master where um_id=3414';
            // $mcn=' and utm_campaign NOT LIKE "%Sijoul%"';
        } elseif ($userID == '4375') {
            $utmsourse = "and s.utm_source not in('College Duniya','Reviewadda','college_search','College Dunia','Siksha','Shiksha')
			and  campus_id=2  ";
        } elseif ($userID == '3877') {
            $utmsourse = "and s.utm_source in('College Duniya','College Dunia')";
            $is_condition = " and STR_TO_DATE(s.created_date,'%Y-%m-%d')>='2021-10-28'";
        } elseif ($userID == '3885') {
            $utmsourse = " and s.campus_id=5 ";
            $is_condition = " and STR_TO_DATE(s.created_date,'%Y-%m-%d')>='2021-10-30'";
        } else {
            $utmsourse = '';
        }
        $utm = '';
        $nts = " ";
        if ($row['ic_code'] == "digital") {

            if (!empty($row['event_code'])) {
                $utm = "and s.utm_source='" . $row['event_code'] . "' ";
            }
            $l = 'LEFT';
            if (!empty($row['sel_c_typ'])) {
                if ($row['sel_c_typ'] == 'P') {
                    $cty = " and s.is_ind = 'P'";
                } else {
                    $cty = " and s.is_ind != 'P'";
                }
            }
            if (!empty($row['digi_date']) && empty($row['digi_date_to'])) {

                $cond = " and s.ic_code = 'digital' $utm $cty and date(s.created_date) = '" . date('Y-m-d', strtotime($row['digi_date'])) . "'  $utmsourse";
                $dc = " and date(s.created_date) = '" . date('Y-m-d', strtotime($row['digi_date'])) . "'  ";
            } else if (!empty($row['digi_date']) && !empty($row['digi_date_to'])) {
                $cond = " and s.ic_code = 'digital' $utm $cty and date(s.created_date) between '" . date('Y-m-d', strtotime($row['digi_date'])) . "'  and '" . date('Y-m-d', strtotime($row['digi_date_to'])) . "' $utmsourse";
                $dc = " and date(s.created_date) between '" . date('Y-m-d', strtotime($row['digi_date'])) . "'  and '" . date('Y-m-d', strtotime($row['digi_date_to'])) . "' ";
            } else {
                $cond = " and s.ic_code = 'digital' $utm  $cty  $utmsourse ";
            }
            if ($row['led'] == '2') {
                $mob = " and s.mobile1_status is null and s.lead_assign is not null ";
            }


            //$sujee_condition=" and  ";

            if ($userID == '3414') {
                $mcn = ' and utm_campaign NOT LIKE "%Sijoul%"';
            }

            $rcc = "UNION
	   (SELECT DISTINCT s.id,
			CASE
			WHEN s.updated_date IS NULL THEN s.created_date
			ELSE s.updated_date
			END as consider_date,s.event_code as ecode,vw.school_short_name,vw.stream_short_name,s.campus_id,s.multiplecourses,
			s.created_date as created_date,s.utm_source,s.utm_campaign, '' as institute_name,s.country_name,
			'' as ic_name,'' as  ic_code,s.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.stream_name,'' as standard_name ,s.created_by,s.programme_id,s.programme_status,s.city_name,s.state_name,s.provisional_admission,s.walkin_status
			FROM student_meet_details  s  " . $l . "
           join su_sf_sijoul_stream_details as vw on s.programme_id=vw.stream_id and s.campus_id=vw.belongtocampus
			join lead_assign_details as l on s.id=l.stud_id
			
			WHERE (s.event_code='EV/DG/1')   AND s.academic_year='" . $this->config->item('ic_year') . "' $dc    
			and  l.lead_assign_by= $userID  $utm $mcn and NOT  campus_id<=>2  $sms $nts
            and s.latest_calling_status='' $no_data $sujee_condition
			AND l.stud_id NOT IN (select stud_id from lead_assign_details where lead_assign!=$userID )
			and l.stud_id NOt In (select student_id from calling_log_details)
			
			order by 
			consider_date 
			DESC )  
	   
	   ";
        } else {
            $y = " and s.academic_year = '" . $this->config->item('ic_year') . "' and ic.status='Y' ";
            if (isset($row['event_code']) && $row['event_code'] != 'null' && !empty($row['event_code'])) {
                $cond = " and e.event_code='" . $row['event_code'] . "'";
            }
            if (!empty($row['ic_code'])) {
                $condic = " and s.ic_code='" . $row['ic_code'] . "'";
            }


            // $ic = $this->session->userdata('ic_code');
            // if(!empty($ic)){
            // $condic=" and s.ic_code='".$ic."'";
            //}
        }
        //if(!empty($row['evt'])){

        $ld = " and s.lead_assign_status !='Y' ";
        // $ld = " and s.id NOT IN (  select stud_id from lead_assign_details where academic_year='".$this->config->item('ic_year')."' and ( calling_event = '".$row['evt']."' OR calling_event ='INCOMING_LEAD') and active = 'Y')";
        //}
        /* $sql = "SELECT distinct s.id,i.institute_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.mobile2,s.mobile1_status,st.stream_name,sm.standard_name ,s.created_by,s.created_date,s.programme_id,s.programme_status
                FROM student_meet_details  s 
                LEFT JOIN event_details e  ON s.event_code=e.event_code 
                LEFT JOIN institute_master i ON i.institue_id=e.institue_id
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN stream_master st ON st.stream_id=s.stream
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard                
                WHERE   ".$cond." order by s.created_date desc , s.id desc"; */
        if ($rowno != '' && $rowperpage != '') {
            $lm = 'limit ' . $rowno . ',' . $rowperpage;
        } else {
            $lm = 'limit 0,2000';
        }
        $mcc = '';
        $newc = "UNION 
			(SELECT DISTINCT s.id,
			CASE
    WHEN s.updated_date IS NULL THEN s.created_date
	ELSE s.updated_date
		END as consider_date,s.event_code as ecode,vw.school_short_name,vw.stream_short_name,s.campus_id,s.multiplecourses,
			s.created_date as created_date,s.utm_source,s.utm_campaign,i.institute_name,s.country_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.stream_name,sm.standard_name ,s.created_by,s.programme_id,s.programme_status,s.city_name,s.state_name,s.provisional_admission,s.walkin_status
                FROM student_meet_details  s  " . $l . "
                JOIN event_details e  ON e.event_code=s.event_code AND s.academic_year=e.academic_year
                 " . $l . " JOIN institute_master i ON i.institue_id=e.institue_id AND s.academic_year=i.academic_year
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard 
                   left join su_sf_sijoul_stream_details as vw on s.programme_id=vw.stream_id and s.campus_id=vw.belongtocampus
            
                WHERE (s.event_code!='Consultant' ) and s.mobile1_valid !='N' and s.is_display='N' and s.event_code !='EV/SUJEE/23' 
                
				AND s.academic_year='" . $this->config->item('ic_year') . "' " . $ld . " " . $y . " " . $cond . " " . $condic . " " . $mob . "  $nts $is_condition $utmsourse $sms1 $mcn $sujee_condition order by 
			     consider_date 
				DESC )";

        if ($role_id == 1 || $userID == '3414') {

            $mcc = "UNION
	   (SELECT DISTINCT s.id,
			CASE
			WHEN s.updated_date IS NULL THEN s.created_date
			ELSE s.updated_date
			END as consider_date,s.event_code as ecode,vw.school_short_name,vw.stream_short_name,s.campus_id,s.multiplecourses,
			s.created_date as created_date,s.utm_source,s.utm_campaign,i.institute_name,s.country_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.stream_name,sm.standard_name ,s.created_by,s.programme_id,s.programme_status,s.city_name,s.state_name,s.provisional_admission,s.walkin_status
			FROM student_meet_details  s  " . $l . "
			JOIN event_details e  ON e.event_code=s.event_code AND s.academic_year=e.academic_year
			" . $l . " JOIN institute_master i ON i.institue_id=e.institue_id AND s.academic_year=i.academic_year
			LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
			LEFT JOIN standard_master sm ON sm.standard_id=s.standard 
			left join su_sf_sijoul_stream_details as vw on s.programme_id=vw.stream_id and s.campus_id=vw.belongtocampus
			join lead_assign_details as l on s.id=l.stud_id
			WHERE (s.event_code!='Consultant')  and s.mobile1_valid !='N' and s.is_display='N' AND s.academic_year='" . $this->config->item('ic_year') . "'  " . $y . "  " . $mob . " $dc   and s.event_code !='EV/SUJEE/23'   $no_data
			and  l.lead_assign= $userID  $utm $mcn $sujee_condition and NOT  campus_id<=>2  $sms $nts
            
			AND l.stud_id NOT IN (select stud_id from lead_assign_details where lead_assign_by!=4027)
			
			
			order by 
			consider_date 
			DESC )  
	   
	   ";
        }
        $ggg = '';
        if ($userID == '4172') {
            $ggg = "
	   UNION 
				(SELECT DISTINCT s.id,
			CASE
    WHEN s.updated_date IS NULL THEN s.created_date
	ELSE s.updated_date
		END as consider_date,s.event_code as ecode,vw.school_short_name,vw.stream_short_name,s.campus_id,s.multiplecourses,
			s.created_date as created_date,s.utm_source,s.utm_campaign,i.institute_name,s.country_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,em.exam_name as stream_name,sm.standard_name ,s.created_by,s.programme_id,s.programme_status,s.city_name,s.state_name,s.provisional_admission,s.walkin_status
                FROM student_meet_details  s  " . $l . "
                JOIN event_details e  ON e.event_code=s.event_code AND s.academic_year=e.academic_year
                 " . $l . " JOIN institute_master i ON i.institue_id=e.institue_id AND s.academic_year=i.academic_year
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard 
                left join su_sf_sijoul_stream_details as vw on s.programme_id=vw.stream_id and s.campus_id=vw.belongtocampus
                join su_jee_registration as srt on s.id=srt.student_id
				join exam_master as em on srt.exam_no=em.exam_id
                WHERE s.event_code  LIKE '%EV/SUJEE%' and ( s.created_by IS NULL or s.created_by=0 or s.created_by='' ) and s.mobile1_valid !='N' and s.is_display='N'
                
				AND s.academic_year='" . $this->config->item('ic_year') . "' " . $ld . " " . $y . " " . $cond . " " . $condic . " " . $mob . "  $nts $is_condition  $mcn $no_data 
				and srt.exam_no IN (12,47,48,5,49,50,51,3) group by s.id
				
				order by 
			     consider_date 
				DESC )
	  
	  
	  ";
        }
        if ($userID == '3414' || $userID == '1' || $userID == 4027) {
            $ggg = "
	   UNION 
				(SELECT DISTINCT s.id,
			CASE
    WHEN s.updated_date IS NULL THEN s.created_date
	ELSE s.updated_date
		END as consider_date,s.event_code as ecode,vw.school_short_name,vw.stream_short_name,s.campus_id,s.multiplecourses,
			s.created_date as created_date,s.utm_source,s.utm_campaign,i.institute_name,s.country_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,em.exam_name as stream_name,sm.standard_name ,s.created_by,s.programme_id,s.programme_status,s.city_name,s.state_name,s.provisional_admission,s.walkin_status
                FROM student_meet_details  s  " . $l . "
                JOIN event_details e  ON e.event_code=s.event_code AND s.academic_year=e.academic_year
                 " . $l . " JOIN institute_master i ON i.institue_id=e.institue_id AND s.academic_year=i.academic_year
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard 
                left join su_sf_sijoul_stream_details as vw on s.programme_id=vw.stream_id and s.campus_id=vw.belongtocampus
                join su_jee_registration as srt on s.id=srt.student_id
				join exam_master as em on srt.exam_no=em.exam_id
                WHERE s.event_code  LIKE '%EV/SUJEE%' and ( s.created_by IS NULL or s.created_by=0 or s.created_by='' ) and s.mobile1_valid !='N' and s.is_display='N'
                
				AND s.academic_year='" . $this->config->item('ic_year') . "' " . $ld . " " . $y . " " . $cond . " " . $condic . " " . $mob . "  $nts $is_condition  $mcn $no_data 
				and srt.exam_no  nOT IN (12,47,48,5,49,50,51,3) group by s.id
				
				order by 
			     consider_date 
				DESC )
	  
	  
	  ";
        }
        $sql = "select * from ((SELECT DISTINCT s.id,
			CASE
			WHEN s.updated_date IS NULL THEN s.created_date
			ELSE s.updated_date
			END as consider_date,s.event_code as ecode,vw.school_short_name,vw.stream_short_name,s.campus_id,s.multiplecourses,
			s.created_date as created_date,s.utm_source,s.utm_campaign,i.institute_name,s.country_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.stream_name,sm.standard_name ,s.created_by,s.programme_id,s.programme_status,s.city_name,s.state_name,s.provisional_admission,s.walkin_status
			FROM student_meet_details  s  " . $l . "
			JOIN event_details e  ON e.event_code=s.event_code AND s.academic_year=e.academic_year
			" . $l . " JOIN institute_master i ON i.institue_id=e.institue_id AND s.academic_year=i.academic_year
			LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
			LEFT JOIN standard_master sm ON sm.standard_id=s.standard 
			left join su_sf_sijoul_stream_details as vw on s.programme_id=vw.stream_id and s.campus_id=vw.belongtocampus
			join lead_assign_details as l on s.id=l.stud_id
			
			WHERE (s.event_code!='Consultant')  and s.mobile1_valid !='N' and s.is_display='N' AND s.academic_year='" . $this->config->item('ic_year') . "'  " . $y . "  " . $mob . "  $nts and s.event_code !='EV/SUJEE/23'   $cond $sms $mcn $no_data
			and  l.lead_assign= $userID  $utm $sujee_condition  AND l.stud_id NOT IN (select stud_id from lead_assign_details where lead_assign_by=$userID)
			
			
			order by 
			consider_date 
			DESC )  
			$newc $mcc
				 UNION 
				(SELECT DISTINCT s.id,
			CASE
    WHEN s.updated_date IS NULL THEN s.created_date
	ELSE s.updated_date
		END as consider_date,s.event_code as ecode,vw.school_short_name,vw.stream_short_name,s.campus_id,s.multiplecourses,
			s.created_date as created_date,s.utm_source,s.utm_campaign,i.institute_name,s.country_name,ic.ic_name,ic.ic_code,e.event_code,s.student_name,s.mobile1,s.mobile1_valid,s.stream_name,sm.standard_name ,s.created_by,s.programme_id,s.programme_status,s.city_name,s.state_name,s.provisional_admission,s.walkin_status
                FROM student_meet_details  s  " . $l . "
                JOIN event_details e  ON e.event_code=s.event_code AND s.academic_year=e.academic_year
                 " . $l . " JOIN institute_master i ON i.institue_id=e.institue_id AND s.academic_year=i.academic_year
                LEFT JOIN ic_registration ic ON ic.ic_code=e.event_organizer_id
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard 
                   left join su_sf_sijoul_stream_details as vw on s.programme_id=vw.stream_id and s.campus_id=vw.belongtocampus
              
                WHERE (s.event_code ='EV/SUJEE/23' and ( s.created_by in ($mc1)  $mc )) and s.mobile1_valid !='N' and s.is_display='N'
                
				AND s.academic_year='" . $this->config->item('ic_year') . "' " . $ld . " " . $y . " " . $cond . " " . $condic . " " . $mob . " $sujee_condition $nts $is_condition $sms $mcn $no_data order by 
			     consider_date 
				DESC )
				
				$rcc
				$ggg
				) a
				$lm";




        //echo $sql;
        //echo $sql;

        //exit;



        //#s.created_date,s.updated_date   
        $query = $this->db->query($sql);
        //echo $this->db->last_query();exit;
        $res = $query->result_array();

        return $res;
    }
    function get_leads_by_event_new($row)
    {

        $userID = $this->session->userdata('uid');

        if ($row['ic_code'] == "digital") {
            // $cond="  s.utm_source='".$row['event_code']."' and s.utm_campaign='".$row['utm_campaign']."' ";
            $src = '';
            if ($userID == 3877) {
                $src = " and   s.utm_source IN ('College Duniya','College Dunia') and STR_TO_DATE(s.created_date,'%Y-%m-%d')>='2021-10-28'";
            } elseif ($userID == 3885) {
                $src = " and   s.campus_id=5 and STR_TO_DATE(s.created_date,'%Y-%m-%d')>='2021-10-30'";
            } elseif ($userID == 3414) {
                $src = "   ";
            } elseif ($userID == 4375) {
                $src = "  and  campus_id=2 ";
            }

            if (!empty($row['event_code'])) {




                $utm = "and s.utm_source='" . $row['event_code'] . "' ";
            }
            $l = 'LEFT';
            if (!empty($row['sel_c_typ'])) {
                if ($row['sel_c_typ'] == 'P') {
                    $cty = " and s.is_ind = 'P'";
                } else {
                    $cty = " and s.is_ind != 'P'";
                }
            }
            if (!empty($row['digi_date']) && empty($row['digi_date_to'])) {

                $cond = " and s.ic_code = 'digital' $utm $cty and date(s.created_date) = '" . date('Y-m-d', strtotime($row['digi_date'])) . "'  ";
            } else if (!empty($row['digi_date']) && !empty($row['digi_date_to'])) {
                $cond = " and s.ic_code = 'digital' $utm $cty and date(s.created_date) between '" . date('Y-m-d', strtotime($row['digi_date'])) . "'  and '" . date('Y-m-d', strtotime($row['digi_date_to'])) . "' ";
            } else {
                $cond = " and s.ic_code = 'digital' $utm  $cty  ";
            }
            if ($row['led'] == '2') {
                $mob = " and s.mobile1_status is null and s.lead_assign is not null ";
            }
        } else {
            $y = " and s.academic_year = '" . $this->config->item('ic_year') . "'";
            if (isset($row['event_code']) && $row['event_code'] != 'null' && !empty($row['event_code'])) {
                $cond = " and s.event_code='" . $row['event_code'] . "'";
            }
            if (!empty($row['ic_code'])) {
                $condic = " and s.ic_code='" . $row['ic_code'] . "'";
            }
            // $ic = $this->session->userdata('ic_code');
            // if(!empty($ic)){
            // $condic=" and s.ic_code='".$ic."'";
            //}
        }
        //if(!empty($row['evt'])){



        $sql = "SELECT DISTINCT s.lead_assign_status,s.id,s.created_date AS created_date,s.utm_source,s.utm_campaign,country_name,
s.student_name,s.mobile1,s.mobile1_valid,s.stream_name,s.created_by,s.created_date,s.programme_id,s.programme_status,
s.city_name,s.state_name,s.provisional_admission,s.walkin_status,CASE
    WHEN s.lead_assign_status = 'N' THEN 1 ELSE 0
END AS lead_not_assigned
                FROM student_meet_details  s 
                WHERE s.event_code!='Consultant' and s.mobile1_valid !='N' and s.is_display='N' AND s.academic_year='" . $this->config->item('ic_year') . "' " . $y . " " . $cond . " " . $condic . " " . $mob . " $src order by s.created_date ";
        //echo $sql;
        //exit;


        $query = $this->db->query($sql);
        //echo $this->db->last_query();exit;
        $res = $query->result_array();

        return $res;
        // }	
    }
    function get_allocated_student_list($row)
    {
        if (!empty($row['smem'])) {
            if ($row['smem'] == 1482) {
                $sic = " and ld.lead_assign IN ('" . $row['smem'] . "','1694')";
            } elseif ($row['smem'] == 4317) {
                $sic = " and ld.lead_assign IN ('" . $row['smem'] . "','3414')";
            } else {
                $sic = " and ld.lead_assign = '" . $row['smem'] . "'";
            }
        }
        $sic_con = '';
        if (!empty($row['sic'])) {
            $ic_code = $row['sic'];
            $sic_con = " and ld.lead_assign IN (select um_id from user_master where ic_code='$ic_code')";
        }


        $con = " and ld.calling_event='" . $row['sevt'] . "'";
        $userID = $this->session->userdata('uid');
        if ($userID == 3414) {
            $con = "";
        }

        $AC = ACADEMIC_YEAR;
        $sql = "select vw.school_short_name,vw.stream_short_name,sp.sprogramm_acro as coursename,s.latest_calling_status as lcalling_status,ld.id as ldid,s.id as std_id,ld.calling_event,s.student_name,s.mobile1,ld.lead_assign as lead_assign_ld,ld.lead_assign_on as lead_assign_on_ld ,
CASE WHEN i.ic_name IS NULL THEN s.utm_source ELSE i.ic_name END AS ic_name,s.state_name,s.city_name,

s.stream_name,sm.standard_name,s.utm_campaign,s.utm_source from lead_assign_details as ld 
        join student_meet_details as s on ld.stud_id=s.id 
LEFT  join  sandipun_univerdb.school_programs_new as sp on s.programme_id=sp.sp_id
 LEFT JOIN ic_registration i ON i.ic_code=s.ic_code
                LEFT JOIN standard_master sm ON sm.standard_id=s.standard 
 left join su_sf_sijoul_stream_details as vw on s.programme_id=vw.stream_id and s.campus_id=vw.belongtocampus                
        where ld.active = 'Y'  $sic $sic_con  $con and s.academic_year='$AC' order by ld.calling_status ASC";

        $query = $this->db->query($sql);

        $res = $query->result_array();
        return $res;
    }
    function transfer_data_inbound()
    {
        $sql = "SELECT id,lead_assign,lead_assign_on,lead_assign_by FROM student_meet_details WHERE ic_code='digital' AND lead_assign IS NULL and id NOT IN (  select stud_id from lead_assign_details where academic_year='" . $this->config->item('ic_year') . "' and calling_event = 'DIGITAL_LEAD' and active = 'Y') ";
        $query = $this->db->query($sql);
        //echo $this->db->last_query();
        $res = $query->result_array();
        $i = 1;
        foreach ($res as $key => $value) {
            $sql1 = "SELECT * FROM calling_log_details WHERE student_id='" . $value['id'] . "' order by c_id DESC limit 0,1";
            $query1 = $this->db->query($sql1);
            //echo $this->db->last_query();
            $res1 = $query1->result_array();
            // print_r($res1);
            $arr['academic_year'] = $this->config->item('ic_year');
            $arr['calling_event'] = 'DIGITAL_LEAD';
            $arr['stud_id'] = $value['id'];
            $arr['lead_assign'] = '14584';
            $arr['lead_assign_on'] = date('Y-m-d H:i:s');
            $arr['lead_assign_by'] = '14584';
            // $arr['called_on'] = $res1[0]['called_on'];
            // $arr['calling_status'] = $res1[0]['calling_status'];
            $ins = $this->db->insert('lead_assign_details', $arr);
            $ins_id = $this->db->insert_id();
            //    $uparr['ld_id'] = $ins_id;
            //     $this->db->where('c_id',$res1[0]['c_id']);
            //$up=   $this->db->update('calling_log_details',$uparr);
            $i++;
        }
        return $i;
    }

    function get_client_ip()
    {
        $ipaddress = '';
        if (getenv('HTTP_CLIENT_IP'))
            $ipaddress = getenv('HTTP_CLIENT_IP');
        else if (getenv('HTTP_X_FORWARDED_FOR'))
            $ipaddress = getenv('HTTP_X_FORWARDED_FOR');
        else if (getenv('HTTP_X_FORWARDED'))
            $ipaddress = getenv('HTTP_X_FORWARDED');
        else if (getenv('HTTP_FORWARDED_FOR'))
            $ipaddress = getenv('HTTP_FORWARDED_FOR');
        else if (getenv('HTTP_FORWARDED'))
            $ipaddress = getenv('HTTP_FORWARDED');
        else if (getenv('REMOTE_ADDR'))
            $ipaddress = getenv('REMOTE_ADDR');
        else
            $ipaddress = 'UNKNOWN';
        return $ipaddress;
    }


    function reassign_lead_to_members_new($data)
    {
        $esid = explode(',', $data['sid']);

        $userID = $this->session->userdata('uid');
        $dt1['studentlist'] = $data['sid'];
        $dt1['remark'] = $data['sid'];
        $dt1['assignee'] = $data['membersd'];
        $dt1['created_by'] = $userID;
        $dt1['created_on'] = date('Y-m-d H:i:s');
        $dt1['ipaddress'] = $this->get_client_ip();
        $ins = $this->db->insert('leadreassign_details', $dt1);

        if (!empty($ins)) {
            foreach ($esid as $sid) {

                $arr['lead_assign'] = $dt1['assignee'];

                $this->db->where('id', $sid);
                $upd = $this->db->update('lead_assign_details', $arr);
            }

            return $upd;
        } else {
            return 0;
        }
    }




    function deassign_lead_to_members_new($data)
    {
        $esid = explode(',', $data['sid']);
        foreach ($esid as $sid) {
            $arr['remark'] = $data['remark'];
            $arr['lead_cancle_on'] = date('Y-m-d H:i:s');
            $arr['lead_cancle_by'] = $this->session->userdata('uid');
            $arr['active'] = 'N';
            $this->db->where('id', $sid);
            $upd = $this->db->update('lead_assign_details', $arr);
            $sql = "select stud_id from lead_assign_details where id='" . $sid . "'";
            $query = $this->db->query($sql);
            $res = $query->result_array();
            $arr1['mobile1_valid'] = 'NC';
            $arr1['updated_date'] = date('Y-m-d H:i:s');
            $arr1['lead_assign_status'] = 'N';
            $this->db->where('id', $res[0]['stud_id']);
            $upd1 = $this->db->update('student_meet_details', $arr1);
        }
        return $upd;
    }
    function get_interested_call_list_nic()
    {
        $user_id = $this->session->userdata('name');

        $cond = "and c.called_by='" . $user_id . "'";

        $sql = "SELECT s.admission_form_taken,s.provisional_admission,s.id,c.student_id,s.exam_id,s.student_name,s.mobile1_valid,c.mobile_no as mobile1,c.conve_time,c.called_by,c.called_on,DATE(c.called_on) AS call_date, c.calling_status,c.Course_Interested , s.mobile1_status,c.remark,c.visite_ic_code,c.visite_date,c.conve_time,
        CASE WHEN i.ic_name IS NULL THEN s.utm_source ELSE i.ic_name END AS ic_name,
        CASE WHEN p.sprogramm_acro IS NULL THEN s.programme_status ELSE p.sprogramm_acro  END AS course,
        st.stream_name,sm.standard_name,case when ct.name is null then s.landmark else ct.name end as city 
        FROM calling_log_details c 
        left join student_meet_details s  on s.id = c.student_id 
        JOIN (SELECT MAX(c_id) AS c_id FROM calling_log_details GROUP BY mobile_no) max ON c.c_id = max.c_id 
        LEFT JOIN ic_registration i ON i.ic_code=s.ic_code
        LEFT JOIN sandipun_univerdb.school_programs_new p ON p.sp_id=s.programme_id
        LEFT JOIN stream_master st ON st.stream_id=s.stream
        LEFT JOIN standard_master sm ON sm.standard_id=s.standard
        left join cities ct on ct.id=s.city_id
        where c.calling_status!=''  " . $cond . " AND s.student_name IS NOT NULL group by c.student_id,c.mobile_no,c.called_by order by c.called_on desc";
        $query = $this->db->query($sql);
        // echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }
    function save_consultant_log($data)
    {
        $insert_array['con_id'] = $data['cid'];
        $insert_array['remark'] = $data['remark'];
        $insert_array['inserted_by'] = $this->session->userdata("uid");
        $insert_array['inserted_date'] = date("Y-m-d H:i:s");
        return   $this->db->insert('consultant_log_details', $insert_array);
    }
    function get_consultants_log($cid)
    {
        $sql = "SELECT * FROM consultant_log_details WHERE con_id = '" . $cid . "' order by inserted_date DESC";
        $query = $this->db->query($sql);
        //echo $this->db->last_query();
        return   $res = $query->result_array();
    }
    function get_all_school_list()
    {
        $sql = "SELECT *  FROM  sandipun_univerdb.school_master WHERE active='Y' order by school_id ASC ";
        $query = $this->db->query($sql);
        //echo $this->db->last_query();
        $res = $query->result_array();
        return $res;
    }
    function selectsujeeusercount($id)
    {
        //echo $id;exit;

        $sql = "select * from su_jee_registration where reg_id='" . $id . "' and (exam_date='2019-04-20' or  exam_date='2019-04-21') ";

        $query = $this->db->query($sql);
        /* echo $this->db->last_query();*/

        return $query->num_rows();
    }

    function select_exam_center($iccode)
    {
        $this->db->select('id,center_name,institute_master.city as city_name,exam_center_master.ceneter_code as centercode');
        $this->db->from('exam_center_master');
        $this->db->join('institute_master', 'institute_master.institue_id=exam_center_master.institute_id');
        $this->db->where('exam_center_master.ic_code', $iccode);
        $this->db->where('exam_center_master.status', '0');
        $this->db->order_by("center_name", "ASC");
        $query = $this->db->get();
        $result = $query->result_array();
        ///echo $this->db->last_query();//exit;
        return $result;
    }
    function get_consultant_refferedby()
    {
        $uid = $this->session->userdata("uid");
        $this->db->select('DISTINCT(co_reff_by) as co_reff_by');
        $this->db->from('consultants_call_details');
        $this->db->where('status', "Y");
        $this->db->where('co_reff_by !=', '');
        if ($this->session->userdata('role_id') == '1') {
        } else if ($this->session->userdata('role_id') == '16') {

            /// 
            //  $c="consultants_call_details.ic_code='$ic_code'";
            //  $this->db->where($c); 

            $this->db->where('consultant_head', $uid);
        } else if ($this->session->userdata('role_id') == '7') {
            $ic_code = $this->session->userdata("ic_code");
            $c = "consultants_call_details.ic_code='$ic_code'";
            $this->db->where($c);
        } else if ($this->session->userdata('role_id') == '27') {

            $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;

            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select (cordinator_id) as cordinator_id
         from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh = "(consultants_call_details.ic_code IN ($ss) OR consultants_call_details.inserted_by='" . $this->session->userdata('uid') . "' OR consultants_call_details.inserted_by IN ($referred_by) OR consultants_call_details.consultant_head='" . $this->session->userdata('uid') . "' )";
            $this->db->where($wh);
        } else {
            $this->db->where('inserted_by', $uid);
        }

        $query = $this->db->get();
        $result = $query->result_array();
        //echo $this->db->last_query();
        //exit;
        return $result;
    }



    function get_consultant()
    {
        $academic_year = ACADEMIC_YEAR;
        //and consultants_call_details.academic_year='$academic_year';
        $c = "";
        $uid = $this->session->userdata("uid");

        if ($this->session->userdata('role_id') != '1') {

            if ($this->session->userdata('role_id') == '7' && $uid == 429) {

                $ic_code = $this->session->userdata("ic_code");
                $c = " where consultants_call_details.ic_code='$ic_code'  or consultants_call_details.ic_code='SU_BR_003' ";
            } else if ($this->session->userdata('role_id') == '7' && $uid != 429) {

                $ic_code = $this->session->userdata("ic_code");
                $c = " where consultants_call_details.ic_code='$ic_code'";
            }
        }
        if ($academic_year == '2019-20') {
            $query = $this->db->query("select consultants_call_details.contact_person,user_master.um_id from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id

join student_meet_details on student_meet_details.created_by=user_master.um_id where student_meet_details.remark='Consultant Upload' group by user_master.um_id order by consultants_call_details.contact_person asc  ");
        } else {
            $query = $this->db->query("select consultants_call_details.contact_person,user_master.um_id from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id 

join sandipun_ums.enquiry_student_master on sandipun_ums.enquiry_student_master.created_by=user_master.um_id   $c group by user_master.um_id order by consultants_call_details.contact_person asc  ");
        }
        $result = $query->result_array();
        //echo $this->db->last_query();exit;
        return $result;
    }

    function get_campus_list()
    {
        $this->db->select('campus_code,campus_name');
        $this->db->from('campus_master');
        // $this->db->where('status', "Y");       
        $query = $this->db->get();
        $result = $query->result_array();
        ///echo $this->db->last_query();//exit;
        return $result;
    }
    function get_newspapaerdetails()
    {
        $this->db->select('paper_id,paper_name');
        $this->db->from('newspaper_master');
        $this->db->where('is_active', 'Y');
        $this->db->order_by('paper_name', desc);
        $result = $this->db->get();
        $rr = $result->result_array();
        return $rr;
    }
    function get_Digitaldetails()
    {
        $this->db->select('name as utm_source');
        $this->db->from('digital_source_master');
        $this->db->where('digital_status', 'Y');

        $result = $this->db->get();
        $rr = $result->result_array();
        return $rr;
    }

    function get_consultantdetails()
    {
        $this->db->select('user_master.ic_code,cpfname,cplname');
        $this->db->from('ic_registration');
        $this->db->join('user_master', 'ic_registration.ic_code=user_master.ic_code');
        $this->db->where('user_master.roles_id', '17');
        $this->db->where('user_master.status', 'Y');
        $this->db->group_by('cpfname,cplname');
        $result = $this->db->get();
        $rr = $result->result_array();
        return $rr;
    }
    function get_consultantdetailsc()
    {


        $sql = "select distinct(ic_code),ic_name from ic_registration where status='Y' and ic_code IN('SU_MH_001','SU_MH_002','SU_BR_003','SU_MH_004','SU_MH_006','SU_MH_007','SU_GJ_008','SU_MH_009','SU_MH_010','SU_BR_014','SU_BR_016','SU_MH_018','SU_MH_019','SU_GJ_020','CO_UP_048','CO_UP_049','CO_AP_050','CO_MH_051','CO_MP_052','CO_MH_053','CO_MP_054','CO_MH_055','CO_MH_057','CO_MH_060','SU_MP_069','SU_UP_077') ";
        $query = $this->db->query($sql);
        $result = $query->result_array();
        $res = $query->result_array();
        //echo $this->db->last_query();
        return $res;
    }
    function get_foudetails()
    {
        $this->db->select('contact_person,id');
        $this->db->from('consultants_call_details');
        $this->db->where('counselor_type', 'FOU');
        //$this->db->where('user_master.status','Y');
        $result = $this->db->get();
        $rr = $result->result_array();
        return $rr;
    }

    function get_staffdetails()
    {
        $this->db->select('staff_id,staff_name');
        $this->db->from('inhouse_staff_details');
        $this->db->where('status', 'Y');
        $result = $this->db->get();
        $rr = $result->result_array();
        return $rr;
    }

    function Doa_Request($student_mobile)
    {

        $sql = "select * FROM doa_approval_request WHERE student_mobile='$student_mobile'";
        $query = $this->db->query($sql);
        $result = $query->result_array();
        //echo $this->db->last_query();
        return $result;
    }
    function  get_campus_details($campus_id = '')
    {
        $where = " WHERE status='Y' ";

        if ($campus_id != "") {
            $where .= " AND campus_id='" . $campus_id . "'";
        }

        $sql = "select campus_id,campus_code,campus_name,status From campus_master $where ";
        $query = $this->db->query($sql);
        return $query->result_array();
    }

    function get_ic_by_code($iccenter)
    {

        $sql = "Select * FROM ic_registration WHERE ic_code='" . $iccenter . "'";

        $query = $this->db->query($sql);
        $result = $query->result_array();
        // $this->db->last_query();
        return $result;
    }
    function get_student_by_sujee_app($row)
    {
        $sql = "SELECT  s.event_code,DISTINCT(s.id),s.admission_form_taken,s.is_ind,s.utm_source,ic.ic_name,ic.ic_code,s.student_name,s.mobile1,s.mobile1_valid,s.mobile2,s.mobile1_status,st.stream_name,sm.standard_name ,s.created_by,s.created_date,s.programme_id,s.programme_status,ct.city_name,s.landmark,s.lead_assign,s.provisional_admission,s.walkin_status,sc.course,sc.school_code
                FROM su_jee_exam_result  se  
                INNER JOIN student_meet_details AS s ON se.reg_id=s.id 
                 LEFT JOIN ic_registration ic ON s.ic_code=ic.ic_code
                LEFT JOIN stream_master st ON s.stream=st.stream_id
                LEFT JOIN standard_master sm ON s.standard =sm.standard_id
                LEFT JOIN city_master ct ON s.city_id=ct.city_id
                LEFT JOIN school_course sc ON s.programme_id = sc.course_id              
                WHERE  s.lead_assign_status !='N'   AND s.event_code !='Consultant' limit 200 ";
        $query = $this->db->query($sql);
        //   echo $this->db->last_query();
        $res = $query->result_array();

        return $res;
    }

    function insert_student_data($data)
    {
        //print_r($data);exit;



        $arr['ic_code'] = $data['ic_code'];
        $arr['event_code'] = $data['event_code'];
        $arr['student_name'] = $data['student_name'];
        $arr['gender'] = $data['gender'];
        $arr['dob'] = $data['dob'];
        $arr['mobile1'] = $data['mobile1'];
        $arr['whatsappno'] = $data['whatappno'];
        $arr['pmobile_no'] = $data['pmobile_no'];
        $arr['pwhatsapp_no'] = $data['pwhatsapp_no'];
        $arr['standard'] = $data['standard'];
        $arr['stream'] = $data['stream'];
        $arr['stream_name'] = $data['stream_name'];
        $arr['address'] = $data['saddress'];
        $arr['adhar_no'] = $data['adhar_no'];
        $arr['country_id'] = $data['country_id'];
        $arr['country_name'] = $data['country_name'];
        $arr['state_id'] = $data['state'];
        $arr['state_name'] = $data['state_name'];
        $arr['city_id'] = $data['city'];
        $arr['city_name'] = $data['city_name'];

        $arr['pincode'] = $data['pincode'];
        $arr['email'] = $data['email'];
        $arr['mock_interested'] = $data['mock_int'];
        $arr['jee_interested'] = $data['jee_int'];
        $arr['sujee_interested'] = $data['sujee_int'];
        $arr['cast_category'] = $data['category_cast'];
        // $arr['course_interested'] = $data['courseInterested'];
        $arr['exbhi_source_name'] = $data['exbhi_source_name'];
        $arr['created_by'] = $this->session->userdata('uid');
        $arr['created_date'] = date('Y-m-d H:i:s');
        $arr['academic_year'] = $data['academic_year'];
        $arr['status'] = 'Y';
        $arr['remark'] = $data['remark'];
        // print_r($arr);
        $ety = array('Campus', 'Other', 'Exhibition');
        //echo "www".$arr['evt_typ'];
        if (in_array(trim($data['evt_typ']), $ety)) {
            $arr['data_collection'] = 'S';
        } else {
            $arr['data_collection'] = 'P';
        }
        // print_r($arr);exit;
        $ins = $this->db->insert('student_meet_details', $arr);
        $ins_id = $this->db->insert_id();
        if ($data['courseInterested'] != '') {
            foreach ($data['courseInterested'] as $key => $value) {
                $exp = explode("|", $value);

                $arr1['student_id'] = $ins_id;
                $arr1['course_id'] = $exp[0];
                $arr1['course_name'] = $exp[1];
                $arr1['inserted_by'] = $this->session->userdata('uid');
                $arr1['inserted_at'] = date('Y-m-d H:i:s');
                $ins = $this->db->insert('smd_interested_course', $arr1);
            }
        }
        // if($data['mock_int']=='Y'){
        // foreach ($data['mock_exm'] as $key => $value) {
        // $exm1['student_id']=$ins_id;
        // $exm1['exam_id']=$value;
        // $exm1['exam_typ']='OF';
        // $exm1['exam_name']='MOCK';

        //     $this->insert_student_exam($exm1);
        // }
        // }
        // if($data['sujee_int']=='Y'){
        // foreach ($data['sujee_exm'] as $key => $value) {
        // $exm2['student_id']=$ins_id;
        // $exm2['exam_id']=$value;
        // $exm2['exam_typ']='OF';
        // $exm2['exam_name']='SUJEE';

        //     $this->insert_student_exam($exm2);
        // }
        // }



        return   $ins_id;
    }
    function insert_student_exam($data)
    {
        $arr1['student_id'] = $data['student_id'];
        $arr1['exam_no'] = $data['exam_id'];
        $arr1['exam_type'] = $data['exam_typ'];
        $arr1['academic_year'] = $this->config->item('current_year');
        $arr1['exam_name'] = $data['exam_name'];
        // if($data['exam_date']!=''){
        $arr1['exam_date'] = $data['exam_date'];
        //}
        $arr1['inserted_by'] = $this->session->userdata('uid');
        $arr1['inserted_at'] = date('Y-m-d H:i:s');
        $ins = $this->db->insert('su_jee_registration', $arr1);
    }
    function update_student_details($data, $studentId)
    {
        // print_r($data);exit;
        $arr['student_name'] = $data['student_name'];
        $arr['gender'] = $data['gender'];
        $arr['dob'] = $data['dob'];
        $arr['mobile1'] = $data['mobile1'];
        $arr['whatsappno'] = $data['whatappno'];

        $arr['pmobile_no'] = $data['pmobile_no'];
        $arr['pwhatsapp_no'] = $data['pwhatsapp_no'];
        $arr['standard'] = $data['standard'];
        $arr['stream'] = $data['stream'];
        $arr['stream_name'] = $data['stream_name'];
        $arr['address'] = $data['saddress'];
        $arr['country_id'] = $data['country_id'];
        $arr['country_name'] = $data['country_name'];
        $arr['state_id'] = $data['state'];
        $arr['state_name'] = $data['state_name'];
        $arr['city_id'] = $data['city'];
        $arr['city_name'] = $data['city_name'];
        $arr['pincode'] = $data['pincode'];
        $arr['email'] = $data['email'];
        $arr['mock_interested'] = $data['mock_int'];
        $arr['jee_interested'] = $data['jee_int'];
        $arr['sujee_interested'] = $data['sujee_int'];
        $arr['cast_category'] = $data['category_cast'];
        // $arr['course_interested'] = $data['courseInterested'];
        $arr['exbhi_source_name'] = $data['exbhi_source_name'];
        //$arr['created_by'] = $this->session->userdata('uid');
        //$arr['created_date'] = date('Y-m-d H:i:s');
        $arr['academic_year'] = $data['academic_year'];
        $arr['status'] = 'Y';
        $arr['remark'] = $data['remark'];

        $arr['updated_by'] = $this->session->userdata('uid');
        $arr['updated_date'] = date('Y-m-d H:i:s');
        $ety = array('Campus', 'Other', 'Exhibition');
        if (in_array($arr['evt_typ'], $ety)) {
            $arr['data_collection'] = 'S';
        } else {
            $arr['data_collection'] = 'P';
        }
        $this->db->where('id', $studentId);
        $uid = $this->db->update('student_meet_details', $arr);

        $parr = array();
        $uparr = array();
        $cri = $this->get_student_interested_courses($studentId);
        foreach ($cri as $key => $value) {
            $parr[$value['id']] = $value['course_id'];
        }
        foreach ($data['courseInterested'] as $key => $value) {
            $exp = explode("|", $value);
            $uparr[$exp[1]] = $exp[0];
        }


        $adiff = array_merge($parr, $uparr);
        $farr = array_unique($adiff);
        //print_r($farr);

        foreach ($farr as $key => $value) {
            if (!in_array($value, $parr) && in_array($value, $uparr)) {
                $arr1['student_id'] = $studentId;
                $arr1['course_id'] = $value;
                $arr1['course_name'] = $key;
                $arr1['inserted_by'] = $this->session->userdata('uid');
                $arr1['inserted_at'] = date('Y-m-d H:i:s');
                $ins1 = $this->db->insert('smd_interested_course', $arr1);
            } elseif (in_array($value, $parr) && !in_array($value, $uparr)) {
                $cid = array_search($value, $parr);
                $r['status'] = 'N';
                $r['modified_by'] = $this->session->userdata('uid');
                $r['modified_at'] = date('Y-m-d H:i:s');
                $this->db->where('id', $cid);
                $uid1 = $this->db->update('smd_interested_course', $r);
                //echo $this->db->last_query();exit;
            }
        }
        //exit;
        // if(!empty($data['exm_pre'])){
        // $pexmarr=$data['exm_pre'];
        // }else{
        //     $pexmarr=array();
        // }

        // foreach ($data['mock_exm'] as $key => $value) {
        //      $ex_typ[$value]='MOCK';
        //  $up_exmarr[]=$value;

        // }
        // foreach ($data['sujee_exm'] as $key => $value) {
        //       $ex_typ[$value]='SUJEE';
        //     $up_exmarr[]=$value;
        // }
        // $final_exam=array_merge($pexmarr,$up_exmarr);
        // $final_examu = array_unique($final_exam);
        //print_r($data['mock_exm']);
        //print_r($data['sujee_exm']);
        //print_r($pexmarr);
        //print_r($ex_typ);
        //print_r($up_exmarr);
        //print_r($final_exam);
        //print_r($final_examu);
        //exit;
        // foreach ($final_examu as $key => $value) {
        //    if(!in_array($value,$pexmarr) && in_array($value, $up_exmarr)){


        //     $exm2['student_id']=$studentId;
        // $exm2['exam_no']=$value;
        // $exm2['exam_type']=$data['exam_type_'.$value];
        // $exm2['exam_name']=$ex_typ[$value];
        // $exm2['exam_date']=$data['exam_date_'.$value];
        //   // $i= $this->insert_student_exam($exm2);

        //    }elseif(in_array($value,$pexmarr) && !in_array($value, $up_exmarr)){
        //     $cid= array_search($value, $pexmarr);

        //     $r['is_active']='N';
        //      $r['updated_by']=$this->session->userdata('uid');
        //           $r['updated_at']= date('Y-m-d H:i:s');
        //     $this->db->where('sujee_id', $cid);
        //      // $uid12= $this->db->update('su_jee_registration', $r);
        //        //echo $this->db->last_query();exit;
        //    }


        //}

        return  $uid;
    }
    function update_exam_student_callling($data)
    {
        // print_r($data);exit;
        if (!empty($data['exm_pre'])) {
            $pexmarr = $data['exm_pre'];
        } else {
            $pexmarr = array();
        }

        if ($data['mock_exm'] != '') {
            $ex_typ[$data['mock_exm']] = 'MOCK';
            $up_exmarr[] = $data['mock_exm'];
        }
        if ($data['sujee_exm'] != '') {
            $ex_typ[$data['sujee_exm']] = 'SUJEE';
            $up_exmarr[] = $data['sujee_exm'];
        }
        //print_r($pexmarr);
        //print_r($up_exmarr);
        $final_exam = array_merge($pexmarr, $up_exmarr);
        //print_r($final_exam);
        $final_examu = array_unique($final_exam);
        //print_r($final_exam);
        //print_r($final_examu);exit;
        foreach ($final_examu as $key => $value) {
            if (!in_array($value, $pexmarr) && in_array($value, $up_exmarr)) {
                $exm2['student_id'] = $data['studentId'];
                $exm2['exam_id'] = $value;
                $exm2['exam_typ'] = 'OF';
                $exm2['exam_name'] = $ex_typ[$value];

                $i = $this->insert_student_exam($exm2);
            } elseif (in_array($value, $pexmarr) && !in_array($value, $up_exmarr)) {
                $cid = array_search($value, $pexmarr);
                $r['is_active'] = 'N';
                $r['updated_by'] = $this->session->userdata('uid');
                $r['updated_at'] = date('Y-m-d H:i:s');
                $this->db->where('sujee_id', $cid);
                $uid12 = $this->db->update('su_jee_registration', $r);
                //echo $this->db->last_query();exit;
            }
        }
    }
    function get_student_interested_courses($std)
    {
        $sql = "select id,course_id,course_name from smd_interested_course where student_id='" . $std . "' and status='Y' ";
        // exit;
        $query = $this->db->query($sql);
        //   echo $this->db->last_query();
        $res = $query->result_array();

        return $res;
    }

    function get_student_interested_courses_new($std)
    {

        $sql = "select * from school_programs_new where sp_id='" . $std . "'";
        $DB1 = $this->load->database('univerdb', TRUE);



        $query = $DB1->query($sql)->result_array();
        //echo "dsds";
        //echo $DB1->last_query();
        //$res = $DB1;

        return $query;
    }




    ///////////student_add_by_consultant/////////////

    function insert_student_data_by_consultant($data)
    {
        //print_r($data);exit;
        $arr['ic_code_consultant'] = $data['ic_code'];
        $arr['ic_code'] = $this->session->userdata('emp_code');
        $arr['event_code'] = $data['event_code'];
        $arr['student_name'] = $data['student_name'];
        $arr['gender'] = $data['gender'];
        //$arr['dob'] = $data['dob'];
        $arr['mobile1'] = $data['mobile1'];
        $arr['whatsappno'] = $data['whatappno'];
        //$arr['standard'] = $data['standard'];
        //$arr['stream'] = $data['stream'];
        //$arr['stream_name']=$data['stream_name'];
        //$arr['address'] = $data['saddress'];
        $arr['country_id'] = $data['country_id'];
        $arr['country_name'] = $data['country_name'];
        $arr['state_id'] = $data['state'];
        $arr['state_name'] = $data['state_name'];
        $arr['city_id'] = $data['city'];
        $arr['city_name'] = $data['city_name'];
        //$arr['pincode'] = $data['pincode'];
        $arr['email'] = $data['email'];
        //$arr['cast_category']=$data['category_cast'];
        $arr['created_by'] = $this->session->userdata('uid');
        $arr['created_date'] = date('Y-m-d H:i:s');
        $arr['status'] = 'Y';
        $arr['academic_year'] = $data['academic_year'];
        $arr['remuneration'] = $data['remuneration'];
        $arr['campus_id'] = $data['campus_id'];
        $arr['organization'] = $data['organization'];
        $arr['school_name'] = $data['school_name'];
        $arr['course_type'] = $data['course_type'];
        $arr['course_walkin'] = $data['course_walkin'];
        $arr['programme_id'] = $data['programme_id'];
        $arr['Course_Year'] = $data['Course_Year'];
        $ins = $this->db->insert('student_meet_details', $arr);
        $ins_id = $this->db->insert_id();
        return   $ins_id;
    }
    ////////end of student_add_by_consultant/////

    /// edit student details


    function update_student_data_by_consultant($data)
    {
        //print_r($data);exit;
        $arr['ic_code_consultant'] = $data['ic_code'];

        $arr['event_code'] = $data['event_code'];
        $arr['student_name'] = $data['student_name'];
        $arr['gender'] = $data['gender'];
        //$arr['dob'] = $data['dob'];
        $arr['mobile1'] = $data['mobile1'];
        $arr['whatsappno'] = $data['whatappno'];
        //$arr['standard'] = $data['standard'];
        //$arr['stream'] = $data['stream'];
        //$arr['stream_name']=$data['stream_name'];
        //$arr['address']=$data['saddress'];
        $arr['country_id'] = $data['country_id'];
        $arr['country_name'] = $data['country_name'];
        $arr['state_id'] = $data['state'];
        $arr['state_name'] = $data['state_name'];
        $arr['city_id'] = $data['city'];
        $arr['city_name'] = $data['city_name'];
        //$arr['pincode'] = $data['pincode'];
        $arr['email'] = $data['email'];
        //$arr['cast_category']=$data['category_cast'];
        $arr['updated_by'] = $this->session->userdata('uid');
        $arr['created_date'] = date('Y-m-d H:i:s');
        $arr['status'] = 'Y';
        $arr['academic_year'] = $data['academic_year'];
        $arr['remuneration'] = $data['remuneration'];
        $arr['campus_id'] = $data['campus_id'];
        $arr['organization'] = $data['organization'];
        $arr['school_name'] = $data['school_name'];
        $arr['course_type'] = $data['course_type'];
        $arr['course_walkin'] = $data['course_walkin'];
        $arr['programme_id'] = $data['programme_id'];
        $arr['Course_Year'] = $data['Course_Year'];

        $this->db->where('id', $data['id']);
        $upd_id = $this->db->update('student_meet_details', $arr);
        return   $upd_id;
    }

    //end of of edit submit



    ////show list only for ic head
    public function fetch_student_meetdetails_consultant_ichead($iccode)
    {

        $role_id = $this->session->userdata('role_id');



        $wh = "ic_code='$iccode' AND roles_id='17'";

        $sql = "SELECT COUNT(smd.id) AS no_of_admission, smd.`campus_id`,psmd.`verifiedamount`, ccd.`contact_person`, smd.created_by AS consultantid ,SUM(smd.`remuneration`) AS total_renumuration
        
                FROM student_meet_details AS smd
                JOIN user_master AS um ON um.`um_id`=smd.created_by 
                LEFT JOIN (SELECT created_by, ic_code_consultant ,SUM(CASE WHEN  remuneration_status='V' THEN remuneration ELSE 0 END ) AS verifiedamount 
                FROM student_meet_details WHERE ic_code_consultant='$iccode' group by created_by) AS psmd ON psmd.created_by=smd.created_by
                left JOIN consultants_call_details AS ccd ON ccd.employee_code=um.`employee_code` 
                WHERE smd.created_by IN (SELECT um_id FROM user_master WHERE $wh) 
                AND smd.event_code='consultant' GROUP BY ccd.`employee_code`";
        /*$sql="SELECT  COUNT(smd.id) AS no_of_admission, smd.remuneration_status, smd.`campus_id`, ccd.`contact_person`, smd.created_by AS consultantid ,SUM(smd.`remuneration`) AS total_renumuration,case(WHEN smd.remuneration_status='V' then smd.remuneration else 0 ) as verifiedamount
            FROM student_meet_details AS smd 
            JOIN user_master AS um ON um.`um_id`=smd.created_by 
            JOIN consultants_call_details AS ccd ON ccd.employee_code=um.`employee_code`
            WHERE smd.created_by IN (SELECT um_id FROM user_master WHERE ic_code='CD_MH_024' AND roles_id='17' ) 
            AND smd.event_code='consultant' 
            GROUP BY ccd.`employee_code`";*/
        $query = $this->db->query($sql);
        /*  echo $this->db->last_query();
            die;*/
        $result = $query->result_array();
        return  $result;
    }

    ////////////////end///////

    ///show all student of related consultant
    function show_all_student_of_related_consultant($var, $start = 0, $limit, $created)
    {

        $userID = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');
        $sql = "SELECT s.id,s.organization,s.event_code,s.created_by,s.ic_code_consultant,s.student_name, s.remuneration_status,s.remuneration,s.remuneration_remark,s.mobile1,s.whatsappno,s.email,s.state_name,s.city_name,ir.ic_name,sc.school_code,sc.course,ccd.contact_person,ir.ic_name,ccd.pancard FROM student_meet_details s 

            left join school_course sc on sc.course_id=s.programme_id and sc.campus_city=s.campus_id
           
            left join ic_registration ir on s.ic_code_consultant=ir.ic_code 
        
            left JOIN user_master AS um ON um.`um_id`=s.created_by 
            left JOIN consultants_call_details AS ccd ON ccd.employee_code=um.`employee_code`
            WHERE s.academic_year='" . $this->config->item('ic_year') . "' and s.created_by='" . $created . "'  ";
        $sql .= " ORDER BY s.id DESC";

        $query = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }

    public function get_student_details_byid($studentid)
    {
        $academic_year = ACADEMIC_YEAR;
        $sql = "SELECT * FROM student_meet_details s         
            WHERE s.id='" . $studentid . "' and academic_year='$academic_year'";
        $query = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }

    public function verify_bycentral_head($studentid, $status, $year = "")
    {

        if ($year != '' && $year != '2019-20') {

            if ($status == "P") {
                $status    = "N";
            } else {
                $status    = "Y";
            }
            $DB1 = $this->load->database('umsdb', TRUE);
            $arr['status'] = $status;
            $DB1->where('enquiry_id', $studentid);
            $upd_id = $DB1->update('enquiry_student_master', $arr);

            return  $upd_id;
        } else {

            $arr['remuneration_status'] = $status;
            $this->db->where('id', $studentid);
            $upd_id = $this->db->update('student_meet_details', $arr);
            return  $upd_id;
        }
    }

    function update_Remark_of_student_bycentralhead($data)
    {

        if ($data['academic_year'] == '2019-20') {
            $uda['remuneration_remark'] = $data['remark'];
            $this->db->where('id', $data['getstuid']);
            $upd_id = $this->db->update('student_meet_details', $uda);
            return  $upd_id;
        } else {
            $DB1 = $this->load->database('umsdb', TRUE);
            $uda['remark'] = $data['remark'];
            $DB1->where('enquiry_id', $data['getstuid']);
            $upd_id = $DB1->update('enquiry_student_master', $uda);
            return  $upd_id;
        }


        // echo  $this->db->last_query();exit();

    }

    function fetch_student_meetdetails_consultant_report($var, $start = 0, $limit)
    {
        //ini_set('error_reporting', E_ALL);
        //     print_r($data);exit;

        $userID = $this->session->userdata('uid');
        $ic_code = $this->session->userdata('ic_code');
        $role_id = $this->session->userdata('role_id');
        if ($role_id == '17' || $role_id == '18') {
            $whe1 = " and s.created_by='" . $userID . "' ";
        } else if ($role_id == '4') {

            $sql = "SELECT um_id FROM user_master  where inserted_by='$userID'  and status='Y' and roles_id='17'";
            $query = $this->db->query($sql);
            /*echo $this->db->last_query();
             exit;*/
            $result = $query->result_array();
            foreach ($result as $resu) {
                $sava[] = "'" . $resu['um_id'] . "'";
            }

            $dsdd = implode(',', $sava);
            if (!empty($dsdd)) {
                $whe1 = " and s.created_by  in (" . $dsdd . ")";
            } else {
                $whe1 = "and s.created_by='" . $userID . "'";
            }
        } else if ($role_id == '8') {


            $sql = "SELECT um_id  FROM user_master  where inserted_by='$userID' and roles_id='4' and status='Y'";
            $query = $this->db->query($sql);
            /*echo $this->db->last_query();
             exit;*/
            $result = $query->result_array();
            foreach ($result as $resu) {
                $sava[] = "'" . $resu['um_id'] . "'";
            }
            $dsdd = implode(',', $sava);
            if (!empty($dsdd)) {
                $whe = "inserted_by  in (" . $dsdd . ") and";
            } else {
                $whe = '';
            }


            $sql1 = "SELECT um_id  FROM user_master  where $whe   status='Y' and  roles_id='17' ";

            $query1 = $this->db->query($sql1);

            $result2 = $query1->result_array();

            foreach ($result2 as $resu1) {
                $savabdm[] = "'" . $resu1['um_id'] . "'";
            }

            $savabdm_data = implode(',', $savabdm);

            $sql2 = "SELECT um_id  FROM user_master  where inserted_by='$userID'   and status='Y' and roles_id='17'";

            $query1 = $this->db->query($sql2);

            $result3 = $query1->result_array();
            foreach ($result3 as $resu3) {
                $savabdm3[] = "'" . $resu3['um_id'] . "'";
            }

            $merg_with_bdn_bde_consu = array_merge($savabdm, $savabdm3);
            $merg_with_bdn_bde_consultant = implode(',', $merg_with_bdn_bde_consu);

            if (!empty($merg_with_bdn_bde_consultant)) {
                $whe1 = "and s.created_by  in (" . $merg_with_bdn_bde_consultant . ") and s.ic_code_consultant='" . $ic_code . "'";
            } else {
                $whe1 = "and s.event_code='Consultant' and s.ic_code_consultant='" . $ic_code . "'"; //"and s.created_by='".$userID."'";
            }
        } else if ($role_id == '1') {

            $whe1 = "and s.ic_code_consultant='Consultant'";
        } else {
            $whe1 = '';
        }

        if ($role_id == '1') {

            if ($var['icfilter'] != '') {
                $chekuser = " and s.ic_code_consultant='" . $var['icfilter'] . "' ";
            }
        } else {
            $chekuser = '';
        }


        /* if($var['evtfilter']!=''){
        $ev = " and s.event_code='".$var['evtfilter']."'";
        }*/

        if ($var['consultantfilter'] != '') {
            $cd = " and s.created_by='" . $var['consultantfilter'] . "' ";
        } else {
            $cd = ' ';
        }
        if ($var['campusfilter'] != '') {
            $camput = " and s.campus_id='" . $var['campusfilter'] . "'";
        } else {
            $camput = '';
        }

        if ($var['statusfilter'] != '') {
            $statusfilter = " and s.remuneration_status='" . $var['statusfilter'] . "'";
        } else {
            $statusfilter = '';
        }

        //$sql = "SELECT * FROM student_meet_details WHERE created_by='" . $userID . "' and status='0' and markForDelete = 0";
        $sql = "SELECT s.id,s.event_code,s.organization ,s.created_by,s.ic_code_consultant,s.student_name,s.mobile1,s.whatsappno,s.email,s.state_name,s.city_name,ir.ic_name,sc.school_code,sc.course,s.remuneration,s.remuneration_status,s.remuneration_remark,ccd.contact_person,ir.ic_name,ccd.pancard,s.campus_id FROM student_meet_details s 
            left join school_course sc on sc.course_id=s.programme_id and sc.campus_city=s.campus_id
            left join ic_registration ir on s.ic_code_consultant=ir.ic_code 
            left JOIN user_master AS um ON um.`um_id`=s.created_by 
            left JOIN consultants_call_details AS ccd ON ccd.employee_code=um.`employee_code`         
            WHERE s.academic_year='" . $this->config->item('ic_year') . "' $chekuser  $cd $camput $statusfilter  $whe1 ";
        $sql .= " ORDER BY  s.id DESC";

        //$sql .= " LIMIT $start, $limit";

        $query = $this->db->query($sql);
        /*  echo $this->db->last_query();
            die;*/
        $result = $query->result_array();
        return $result;
    }


    function get_cities_list_bystateCountry()
    {
        $sql = "select c.name as city_name,s.name as state_name,co.name as country_name from cities as c 
inner join states as s on s.id=c.state_id
inner join countries as co on co.id=c.country_id
    where c.state_id='" . $_REQUEST['state_id'] . "' and c.country_id='" . $_REQUEST['country_id'] . "' ";
        $query = $this->db->query($sql);
        /*  echo $this->db->last_query();
            die;*/
        $result = $query->result_array();
        return $result;
    }
    function insert_student_data_import($data)
    {
        //print_r($data);exit;

        $arr['ic_code'] = $data['ic_code'];
        $arr['event_code'] = $data['event_code'];
        $arr['student_name'] = $data['student_name'];
        $arr['gender'] = $data['gender'];

        $arr['mobile1'] = $data['mobile1'];

        $arr['standard'] = $data['standard'];
        $arr['stream'] = $data['stream'];
        $arr['stream_name'] = $data['stream_name'];


        $arr['country_id'] = $data['country_id'];
        $arr['country_name'] = $data['country_name'];
        $arr['state_id'] = $data['state_id'];
        $arr['state_name'] = $data['state_name'];
        $arr['city_id'] = $data['city_id'];
        $arr['city_name'] = $data['city_name'];

        $arr['cast_category'] = $data['category_cast'];

        $arr['created_by'] = $this->session->userdata('uid');
        $arr['created_date'] = date('Y-m-d H:i:s');
        $arr['academic_year'] = $data['academic_year'];
        $arr['status'] = 'Y';

        $arr['data_collection'] = $data['data_collection'];
        $arr['is_excel'] = 'Y';

        // print_r($arr);exit;
        $ins = $this->db->insert('student_meet_details', $arr);
        $ins_id = $this->db->insert_id();
        return   $ins_id;
    }
    public function brochure_enquiry_details()
    {
        $sql = "SELECT s.name as state_name,c.name as city_name,b.* FROM brochure_download_details b 
			left  join states s on s.id=b.state
			left join cities c on c.id=b.city
			order by id desc ";
        $query = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }
    function get_ic_consultant_head()
    {
        $ic_code = $this->session->userdata('ic_code');
        $uid = $this->session->userdata("uid");
        $sql = "select * from (SELECT iu.*,um.um_id,roles_master.roles_type from ic_user_master iu left join user_master um on um.employee_code=iu.employee_code join roles_master on roles_master.roles_id=um.roles_id  where iu.status='Y' and um.status='Y' and (um.roles_id =27) ) t";

        $query = $this->db->query($sql);
        //and um.username not in ('04519','4519','SureshM')
        return $query->result_array();
    }


    function get_ic_consultant_head_admin()
    {

        $sql = " SELECT iu.*,um.um_id,roles_master.roles_type from 
ic_mapping join user_master um on ic_mapping.consultant_head=um.um_id
left join ic_user_master iu  on um.employee_code=iu.employee_code join roles_master on roles_master.roles_id=um.roles_id  group by ic_mapping.consultant_head";

        $query = $this->db->query($sql);
        //and um.username not in ('04519','4519','SureshM')
        return $query->result_array();
    }


    function fetch_student_meetdetails_consultant($var, $start = 0, $limit, $id = "")
    {
        $ICDB = $this->load->database('icdb', TRUE);

        $userID = $this->session->userdata('uid');
        $ic_code = $this->session->userdata('ic_code');
        $role_id = $this->session->userdata('role_id');
        $uid = $this->session->userdata("uid");
        //echo $var['academic_year'];exit;
        if ($id != '') {
            $var['academic_year'] = $this->config->item('current_year');
        } {
            $y = $var['academic_year'];

            if (isset(
                $var['academic_year']
            )) {
                $acd1 = $acd = substr($var['academic_year'], 0, 4);
            } else {
                //$acd='2020';
                $y = $acd1 = $this->config->item('current_year');
                $current_year = explode('-', $acd1);
                $acd = $current_year[0];
            }
            $DB1 = $this->load->database('umsdb', TRUE);
            $DB2 = $this->load->database('ums_sijoul', TRUE);
            if ($role_id != '1') {
            }
            if ($role_id == '1') {

                if ($var['icfilter'] != '') {
                    $chekuser = " and c.ic_code='" . $var['icfilter'] . "' ";
                }
            } else {
                $chekuser = '';
            }


            if ($var['consultantfilter'] != '') {
                $cd = " and enquiry_student_master.created_by='" . $var['consultantfilter'] . "' ";
            } else {
                $cd = ' ';
            }
            if ($var['campusfilter'] != '') {
                $var['campusfilter'] = $var['campusfilter'] + 1;
                $camput = " and enquiry_student_master.Campus_City='" . $var['campusfilter'] . "'";
            } else {
                $camput = '';
            }

            if ($var['statusfilter'] != '') {
                if ($var['statusfilter'] == "V") {
                    $var['statusfilter'] = "Y";
                } else {
                    $var['statusfilter'] = "N";
                }
                $statusfilter = " and enquiry_student_master.status='" . $var['statusfilter'] . "'";
            } else {
                $statusfilter = '';
            }


            $sql1 = '';
            $sql2 = '';
            $condss = '';
            $jc = "";
            if ($role_id == 7) {
                $jc = "left";
                $sql2 = " and  (c.ic_code='" . $this->session->userdata('ic_code') . "'  or enquiry_student_master.created_by='" . $userID . "')  ";
                //$condss=" ( e) ";
                //$sql2=" or  "
            } else if ($role_id == 27) {
                $ss = $ICDB->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;

                $ss = explode(",", $ss);
                $ss = "'" . implode("', '", $ss) . "'";
                $referred_by = $ICDB->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
         from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
                $sql2 = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by) OR c.consultant_head='" . $this->session->userdata('uid') . "' )";
            }
            //if()	
            //$DB1->database
            //$this->db->database;
            $sql = "select CONCAT(iuh.fname,' ',iuh.lname) as leader_name,c1.contact_person as leader_name1,enquiry_student_master.aadhar_card,enquiry_student_master.stream_id,states.state_name,district_name.district_name,taluka_master.taluka_name,enquiry_student_master.nationality, enquiry_student_master.email_id,
c.contact_person,enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
as remuneration,enquiry_student_master.remark 
as remark,enquiry_student_master.status 
as status,enquiry_student_master.Campus_City,
enquiry_student_master.Campus,enquiry_student_master.enquiry_no,enquiry_student_master.created_by as creator,enquiry_student_master.citizenship_id, 
sm.first_name as nashikname,sm1.first_name as sijoulname,sm2.student_name as sfname,sm.enrollment_no as nenrollment_no,sm1.enrollment_no as snrollment_no,sm2.enrollment_no as sfnrollment_no
,sm.cancelled_admission as ncancelled_admission,sm1.cancelled_admission as scancelled_admission,sm2.is_cancelled as sfcancelled_admission
,sm.admission_confirm as nconfirm_admission,sm1.admission_confirm as sconfirm_admission,sm2.isconfirmed as sfconfirm_admission
from " . $DB1->database . ".enquiry_student_master  as enquiry_student_master
join " . $ICDB->database . ".user_master u on u.um_id=enquiry_student_master.created_by
$jc join " . $ICDB->database . ".consultants_call_details c on c.id=u.con_id 
$jc join " . $ICDB->database . ".user_master  uh on c.inserted_by=uh.um_id
left join " . $ICDB->database . ".ic_user_master  iuh on uh.employee_code=iuh.employee_code
left join " . $ICDB->database . ".user_master  uhm on c.inserted_by=uhm.um_id
left  join " . $ICDB->database . ".consultants_call_details c1 on uhm.con_id=c1.id 
left join " . $DB1->database . ".states as states on enquiry_student_master.state_id=states.state_id
left join " . $DB1->database . ".district_name  as district_name on enquiry_student_master.district_id=district_name.district_id
left join " . $DB1->database . ".taluka_master as taluka_master on enquiry_student_master.city_id=taluka_master.taluka_id

left join  " . $DB1->database . ".student_master as sm  on

 ((sm.adhar_card_no=enquiry_student_master.aadhar_card AND sm.adhar_card_no !='') OR (sm.citizenship=enquiry_student_master.citizenship_id))
 
 
 
 
 
 
 and sm.admission_session='$acd'  and sm.enrollment_no !=''



left join  " . $DB2->database . ".student_master as sm1  on ((sm1.adhar_card_no=enquiry_student_master.aadhar_card  AND sm1.adhar_card_no !='')

OR (sm1.citizenship=enquiry_student_master.citizenship_id))



and sm1.admission_session='$acd'  and sm1.enrollment_no !=''
left join  " . $ICDB->database . ".sf_admission_data as sm2  on (( sm2.aadhar_card=enquiry_student_master.aadhar_card  AND sm2.aadhar_card !='') OR (sm2.citizenship=enquiry_student_master.citizenship_id))



and sm2.admission_session='$acd' and sm2.admission_session=''

where enquiry_student_master.admission_session='$acd'
 $sql2 and enquiry_student_master.is_from_consultant=1 $condss $statusfilter $camput $cd";


            if ($role_id != 1 && $id == "") {
                if ($role_id == 7 || $role_id == 27) {
                } elseif ($role_id == 17) {

                    $get_consultant_is_cordinator = $ICDB->query("select is_cordinator from consultants_call_details as cd
		join user_master as um on cd.id=um.con_id where um.um_id=$userID")->row();
                    if (!empty($get_consultant_is_cordinator)) {
                        if ($get_consultant_is_cordinator->is_cordinator == 1) {

                            $get_details_of_underconsultantsql = " SELECT um_id FROM consultants_call_details  csrm
JOIN user_master usrmss ON csrm.id=usrmss.con_id
 WHERE 
csrm.inserted_by IN (
				(SELECT um_id FROM consultants_call_details AS crm JOIN user_master AS urm 
				ON crm.id=urm.con_id WHERE ( crm.inserted_by=$userID OR crm.co_reff_by=$userID) AND is_cordinator=1) ) ";

                            $sql .= " and (enquiry_student_master.created_by='" . $userID . "' or enquiry_student_master.created_by IN  (select um_id
				from " . $ICDB->database . ".consultants_call_details as c join " . $ICDB->database . ".user_master as um on c.id=um.con_id where c.inserted_by=$userID or c.co_reff_by=$userID) or enquiry_student_master.created_by IN ($get_details_of_underconsultantsql)  ) ";
                        } else {
                            $sql .= " and (enquiry_student_master.created_by='" . $userID . "')";
                        }
                    } else {
                        $sql .= " and (enquiry_student_master.created_by='" . $userID . "')";
                    }
                } elseif ($role_id == 35) {
                    if ($userID == 2105) {
                        $sql .= " and enquiry_student_master.created_by
                      IN (select um_id from  " . $ICDB->database . ".consultants_call_details c join  " . $ICDB->database . ".user_master as u on c.id=u.con_id
		where c.inserted_by=$userID or c.co_reff_by=$userID or c.inserted_by=4004 or c.inserted_by=3379  
		or c.inserted_by IN (select um_id from consultants_call_details cr join user_master ur on cr.id=ur.con_id where cr.inserted_by=$userID or cr.co_reff_by=$userID
		
		
		
		))
					";
                    } else {
                        $sql .= " and  (enquiry_student_master.created_by
                      IN (select um_id from  " . $ICDB->database . ".consultants_call_details c join  " . $ICDB->database . ".user_master as u on c.id=u.con_id
		where c.inserted_by=$userID or c.co_reff_by=$userID or c.inserted_by IN (select um_id from consultants_call_details cr join user_master ur on cr.id=ur.con_id where cr.inserted_by=$userID or cr.co_reff_by=$userID
		
		
		
		))  or enquiry_student_master.created_by=$userID)
					";
                    }
                } else {

                    $sql .= " and (enquiry_student_master.created_by='" . $userID . "' or enquiry_student_master.created_by IN (select um_id from consultants_call_details c join user_master as um on c.id=um.con_id where c.inserted_by='$userID' or c.co_reff_by='$userID')) ";
                }
            } else if ($role_id != 1 && $id != "") {
                $sql .= " and enquiry_student_master.created_by='" . $id . "' ";
            }
            $sql .= " group by enquiry_student_master.enquiry_id  ORDER BY enquiry_student_master.enquiry_id DESC";

            $sql = str_replace("sandipun_ic_erp22.", "", $sql);


            //exit;


            $sql = str_replace("sandipun_ic_erp22.", $ICDB->database . ".", $sql);

            $query = $ICDB->query($sql);


            // echo  $ICDB->last_query();
            // exit;




            $result = $query->result();
            $array = array();
            /* 	if(!empty($result)){
		foreach($result as $row){
			$campus=$row->Campus;
            $Campus_City=$row->Campus_City;
			$row->school_code='';
            $row->course='';
			if(!empty($row->stream_id)){
			if($campus=='SUN'){
if($Campus_City==1){
	
$course_details=$DB1->query('select vw_stream_details.school_short_name,vw_stream_details.stream_name
from vw_stream_details where stream_id=
'.$row->stream_id)->row();

if(!empty($course_details)){
$row->school_code=$course_details->school_short_name;
$row->course=$course_details->stream_name;
}
}
else{
$course_details=$DB1->query('select vw_stream_details.school_short_name,vw_stream_details.stream_name
from sandipun_ums_sijoul.vw_stream_details as vw_stream_details where stream_id=
'.$row->stream_id)->row();
if(!empty($course_details)){
$row->school_code=$course_details->school_short_name;
$row->course=$course_details->stream_name;
}	

}				
}
			
else{
$course_details =$this->db->query("SELECT * FROM `sandipun_ic_erp22`.`vw_stream_details` WHERE stream_id=".$row->stream_id)->row();
if(!empty($course_details)){
$row->school_code=$course_details->school_short_name;
$row->course=$course_details->stream_name;
}
							
}	
		}		
	$array[]=$row;		
			
			
			
		}
	} */
            return $result;
        }
    }






    function update_renumeration_amount($val, $id)
    {


        $data = $this->db->query("select * from student_meet_details where id=" . $id . " and remark='Consultant Upload'")->row();
        if (!empty($data)) {
            $uda = array('remuneration' => $val);
            $this->db->where('id', $id);
            $this->db->update('student_meet_details', $uda);
            echo $this->db->affected_rows();
        } else {
            $DB1 = $this->load->database('umsdb', TRUE);
            $uda = array('renumeration_amount' => $val);
            $DB1->where('enquiry_id', $id);
            $DB1->update('enquiry_student_master', $uda);
            echo $DB1->affected_rows();
        }
    }

    function upload_data($data = array())
    {
        //echo "<br>";

        //echo "dd";
        // echo "<pre>";
        $prn = trim($data['prn']);
        $consultant_name = $data['consultant_name'];
        $consultant_no = $data['consultant_no'];
        if ($consultant_name != '' &&  $consultant_no != '' && $prn != '' && $consultant_no != '#N/A') {
            //echo "jgjg";
            $DB1 = $this->load->database('ums_sijoul', TRUE);
            $dta = $DB1->get_where('student_master', array('enrollment_no_new' => $data['prn']))->row();

            $get_consultant_data = $this->db->query("select consultants_call_details.id as consultant_id,user_master.um_id,consultants_call_details.ic_code,user_master.employee_code from consultants_call_details join user_master
		on consultants_call_details.employee_code=user_master.employee_code where /*consultants_call_details.contact_person='$consultant_name' and*/ mobile_no='$consultant_no'")->row();

            // "select consultants_call_details.id as //consultant_id,user_master.um_id,consultants_call_details.ic_code,user_master.employee_code from consultants_call_details join //user_master
            //on consultants_call_details.employee_code=user_master.employee_code where /*consultants_call_details.contact_person='$consultant_name' and*/ and mobile_no=$consultant_no";
            if (!empty($get_consultant_data)) {
                //echo "ee";
                //exit;
                $created_by_id = $get_consultant_data->um_id;
                $dta = $DB1->query("select sandipun_ums_sijoul.address_details.city,sandipun_ums_sijoul.states.state_name,sandipun_ums_sijoul.district_name.district_name,
sandipun_ums_sijoul.student_master.gender,sandipun_ums_sijoul.student_master.mobile,
sandipun_ums_sijoul.student_master.first_name,sandipun_ums_sijoul.student_master.stud_id
 from sandipun_ums_sijoul.student_master 
join 
sandipun_ums_sijoul.address_details on 
sandipun_ums_sijoul.student_master.stud_id=  sandipun_ums_sijoul.address_details.student_id and sandipun_ums_sijoul.address_details.address_type='CORS'
join sandipun_ums_sijoul.states on sandipun_ums_sijoul.address_details.state_id=sandipun_ums_sijoul.states.state_id
join sandipun_ums_sijoul.district_name on sandipun_ums_sijoul.address_details.district_id=sandipun_ums_sijoul.district_name.district_id
where sandipun_ums_sijoul.student_master.enrollment_no_new='$prn'
 LIMIT 1")->row();
                //echo $DB1->last_query();
                $state_id = '';
                $city_id = '';
                $state_data = $this->db->get_where('states', array('name' => $dta->state_name))->row();
                if (!empty($state_data)) {
                    //echo "ss";
                    $state_id = $state_data->id;
                }
                //echo "<pre>";
                $city_data = $this->db->get_where('cities', array('name' => $dta->district_name))->row();
                //echo $this->db->last_query();
                if (!empty($city_data)) {
                    // echo "asdad";
                    $city_id = $city_data->id;
                }

                if (!empty($dta)) {
                    $insert_array = array();
                    $insert_array['ic_code'] = $get_consultant_data->employee_code;
                    $insert_array['event_code'] = 'Consultant';
                    $insert_array['student_name'] = $dta->first_name;
                    $insert_array['gender'] = $dta->gender;
                    $insert_array['country_id'] = 101;
                    $insert_array['country_name'] = 'India';
                    $insert_array['state_name'] = $dta->state_name;
                    $insert_array['city_name'] = $dta->district_name;
                    $insert_array['mobile1'] = $dta->mobile;
                    $insert_array['created_by'] = $created_by_id;
                    $insert_array['academic_year'] = '2019-20';
                    $insert_array['programme_id'] = $dta->sc_id;
                    $insert_array['state_id'] = $state_id;
                    $insert_array['city_id'] = $city_id;
                    $insert_array['remark'] = 'Consultant Upload';
                    $insert_array['remuneration'] = $data['renumeration'];
                    $insert_array['remuneration_remark'] = $data['renumeration_remark'];
                    $insert_array['remuneration_status'] = ($data['renumeration_status'] == 'Verified') ? "V" : "P";


                    $this->db->insert('student_meet_details', $insert_array);
                    $smd_id = $this->db->insert_id();
                    if (!empty($smd_id)) {
                        $array['smd_id'] = $smd_id;
                        $array['ums_id'] = $dta->stud_id;
                        $this->db->insert('student_mapping', $array);

                        //print_r($array);
                        echo    $prn . ": GENERATED";
                    } else {


                        echo    $prn . ": NOT GENERATED,mapping issue";
                    }
                    //print_r($insert_array);

                } else {
                    echo    $prn . ": NOT GENERATED,data problem";
                }
            } else {
                $prn . ": NOT GENERATED,consultant problem";
            }
        } else {

            echo    $prn . ": NOT GENERATED,data missing";
        }
    }


    function get_count_of_admission_done_yet($um_id)
    {

        return $this->db->query("select sum(count) as tc from(
select count(sandipun_ums.enquiry_student_master.enquiry_id) as count from sandipun_ums.enquiry_student_master where sandipun_ums.enquiry_student_master.created_by='$um_id' and sandipun_ums.enquiry_student_master.admission_session='2019' and sandipun_ums.enquiry_student_master.is_from_consultant='1'
UNION ALL
select count(" . currentdb . ".student_meet_details.id) as count from " . currentdb . ".student_meet_details 
where " . currentdb . ".student_meet_details.created_by='$um_id' and " . currentdb . ".student_meet_details.remark='Consultant Upload' and " . currentdb . ".student_meet_details.remuneration_status='V' and " . currentdb . ".student_meet_details.remuneration !=0 and " . currentdb . ".student_meet_details.remuneration!=''
) t")->row()->tc;
    }

    function get_renumeration_amount($um_id)
    {
        return $this->db->query("select sum(renumeration) as renumeration_amout from(

select sum(sandipun_ums.enquiry_student_master.renumeration_amount) as renumeration from sandipun_ums.enquiry_student_master where sandipun_ums.enquiry_student_master.created_by='$um_id'  and sandipun_ums.enquiry_student_master.is_from_consultant='1' and sandipun_ums.enquiry_student_master.admission_session='2020'
UNION ALL
select sum(" . currentdb . ".student_meet_details.remuneration) as renumeration from " . currentdb . ".student_meet_details 
where " . currentdb . ".student_meet_details.created_by='$um_id' and " . currentdb . ".student_meet_details.remark='Consultant Upload' and " . currentdb . ".student_meet_details.remuneration_status='V' and remuneration !=0 and " . currentdb . ".student_meet_details.remuneration!=''
) t")->row()->renumeration_amout;
    }


    function get_payment_done($um_id)
    {
        return $this->db->query("select sum(amount) as amount from " . currentdb . ".consultant_payment_details 
where " . currentdb . ".consultant_payment_details.consultant_id='$um_id' and " . currentdb . ".consultant_payment_details.academic_year='2019-20'
")->row()->amount;
    }

    function fetch_student_meetdetails_consultant_new1($var, $start = 0, $limit, $id = "", $year = "")
    {

        $userID = $this->session->userdata('uid');
        $ic_code = $this->session->userdata('ic_code');
        $role_id = $this->session->userdata('role_id');
        $uid = $this->session->userdata("uid");
        if ($year == "") {
            $var['academic_year'] = $this->config->item('current_year');
        } else {
            $var['academic_year'] = base64_decode($year);
        }
        $stf = '';
        if ($var['statusfilter'] != '' &&  $var['statusfilter'] != undefined) {
            $statusfilter = " and s.remuneration_status='" . $var['statusfilter'] . "'";
            if ($var['statusfilter'] == "P") {
                $st = 'N';
            } else {
                $st = 'Y';
            }
            $stf = " and enquiry_student_master.status ='$st' ";
        } else {
            $statusfilter = '';
        }

        $campusfilter = "";
        if ($var['campusfilter'] != '' &&  $var['campusfilter'] != undefined) {
            $statusfilter1 = $var['campusfilter'];

            $campusfilter = " and enquiry_student_master.Campus_City ='$statusfilter1' ";
        } else {
            $campusfilter = '';
        }


        //  if($var['academic_year'] =='2019-20'){

        $whe1 = "  s.created_by  in (" . $id . ")";

        $sql = "SELECT s.id,s.event_code,s.organization ,s.created_by,s.ic_code_consultant,s.student_name,s.mobile1,s.whatsappno,s.email,s.state_name,s.city_name,ir.ic_name,vs.school_code,vs.course_short_name as course,s.remuneration ,s.remuneration_status,s.remuneration_remark,ccd.contact_person,ir.ic_name,ccd.pancard,s.campus_id,stdm.enrollment_no FROM student_meet_details s 
			left join student_mapping as sm  on s.id=sm.smd_id
			
			join sandipun_ums_sijoul.student_master as stdm on stdm.stud_id=sm.ums_id
			join sandipun_ums_sijoul.vw_stream_details as vs on vs.stream_id=stdm.admission_stream
           /* left join school_course sc on sc.course_id=s.programme_id and sc.campus_city=s.campus_id*/
            left join ic_registration ir on s.ic_code_consultant=ir.ic_code 
            left JOIN user_master AS um ON um.`um_id`=s.created_by 
            left JOIN consultants_call_details AS ccd ON ccd.employee_code=um.`employee_code`         
            WHERE /*s.academic_year='" . $var['academic_year'] . "'*/ $whe1 and s.remark='Consultant Upload' $statusfilter and s.remuneration !=0 and s.remuneration!=''";
        $sql .= " ORDER BY  s.id DESC";

        //echo $sql;
        //exit;
        $query = $this->db->query($sql);

        $result1 = $query->result_array();


        //return $result;
        //}
        //else{

        if (isset(
            $var['academic_year']
        )) {
            $academic_year = $var['academic_year'];
            $acd =  substr($var['academic_year'], 0, 4);
        } else {

            $academic_year = $this->config->item('current_year');
            $current_year = explode('-', $academic_year);
            $acd = $current_year[0];
            //$acd='2020';
        }
        $DB1 = $this->load->database('umsdb', TRUE);
        $cond = "";
        $cond = " and enquiry_student_master.created_by='" . $id . "'";

        $cond1 = " and a.benefit_to='" . $id . "'";



        $sql = "select ad.actual_fee,ad.applicable_fee,fees_paid,ccd.contact_person,
enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,
'Nashik' as Campusdata,vw_stream_details.stream_name as course,vw_stream_details.school_short_name as school_code,



enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,enquiry_student_master.created_on,
enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
as remuneration,enquiry_student_master.Campus_City,
enquiry_student_master.Campus,enquiry_student_master.provisional_no as enrollment_no,enquiry_student_master.status as rstatus,
enquiry_student_master.remark as remark from  enquiry_student_master join
student_master as msm on enquiry_student_master.enquiry_id=msm.enquiry_id 
left join 
(select sum(amount) as fees_paid,student_id from fees_details where type_id=2 and academic_year='$acd' 
and chq_cancelled='N' and is_deleted='N' group by student_id) as
fees_details on fees_details.student_id=msm.stud_id

left join admission_details ad on msm.stud_id=ad.student_id and ad.academic_year='$acd'
left join  vw_stream_details on msm.admission_stream=vw_stream_details.stream_id
 JOIN " . currentdb . ".user_master AS um ON um.um_id=enquiry_student_master.created_by 
 JOIN " . currentdb . ".consultants_call_details AS ccd ON ccd.employee_code=um.employee_code AND  ccd.status= um.status and ccd.status='Y'  
where enquiry_student_master.admission_session='$acd' $stf $campusfilter
and enquiry_student_master.is_from_consultant=1  $cond  and msm.cancelled_admission='N'
UNION
select ad.actual_fee,ad.applicable_fee,fees_paid,ccd.contact_person,
enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,
'Sijoul' as Campusdata,vw_stream_details.stream_name as course,vw_stream_details.school_short_name as school_code,

enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,enquiry_student_master.created_on,
enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
as remuneration,enquiry_student_master.Campus_City,
enquiry_student_master.Campus,enquiry_student_master.provisional_no as enrollment_no,enquiry_student_master.status as rstatus,
enquiry_student_master.remark as remark from  enquiry_student_master join
sandipun_ums_sijoul.
student_master as msm on enquiry_student_master.stude_id=msm.stud_id 
left join 
(select sum(sandipun_ums_sijoul.fees_details.amount) as fees_paid,sandipun_ums_sijoul.fees_details.student_id from sandipun_ums_sijoul.fees_details where sandipun_ums_sijoul.fees_details.type_id=2 and sandipun_ums_sijoul.fees_details.academic_year='$acd' and sandipun_ums_sijoul.fees_details.chq_cancelled='N' and sandipun_ums_sijoul.fees_details.is_deleted='N' group by sandipun_ums_sijoul.fees_details.student_id) as
fees_details on fees_details.student_id=msm.stud_id
left join sandipun_ums_sijoul.admission_details ad on msm.stud_id=ad.student_id and ad.academic_year='$acd'
left join  vw_stream_details on msm.admission_stream=vw_stream_details.stream_id
 JOIN " . currentdb . ".user_master AS um ON um.um_id=enquiry_student_master.created_by 
 JOIN " . currentdb . ".consultants_call_details AS ccd ON ccd.employee_code=um.employee_code AND  ccd.status= um.status and ccd.status='Y'  
where enquiry_student_master.admission_session='$acd' $stf $campusfilter
and enquiry_student_master.is_from_consultant=1  $cond and msm.cancelled_admission='N'

UNION 

select sf.actual_fees as actual_fee,sf.applicable_fees as applicable_fee,sf.paid_fees as fees_paid,ccd.contact_person,
sf.id as id,a.benefit_to as created_by,
'SF' as Campusdata,Course as course,College as school_code,

mobile as mobile1,Stream as course_id,'Indian' as nationality,sf.admission_date as created_on,
student_name as first_name,student_name as middle_name,Course as school_id,
student_name as last_name,a.amount as remuneration,'Nashik' as Campus_City,
'SF' as Campus,enrollment_no as enrollment_no,admission_status as rstatus,
'---' as remark
from 
" . currentdb . ".sf_admission_data as sf join " . currentdb . ".admission_benefits_and_source as a on sf.id=a.student_id and a.is_for=3 

JOIN " . currentdb . ".user_master AS um ON um.um_id=a.benefit_to
JOIN " . currentdb . ".consultants_call_details AS ccd

 ON ccd.employee_code=um.employee_code AND  ccd.status= um.status and ccd.status='Y'  

where  a.academic_year='$academic_year'
$cond1 ";


        //echo  $sql ;
        //exit;



        $sql = " Select * from ( $sql ) t ORDER BY  t.id DESC";


        $query = $DB1->query($sql);

        $result = $query->result();

        $array = array();
        if (!empty($result)) {

            foreach ($result as $row) {
                $row->event_code = 'Consultant';
                $row->student_name = $row->first_name . " " . $row->middle_name . " " . $row->last_name;
                $row->remuneration_status = $row->rstatus;
                $row->remuneration_remark = $row->remark;
                //$row->school_code='';
                //$row->course='';
                $row->state_name = '';
                $row->city_name = '';
                $row->Country = 'India';
                /*if($row->Campus_City==1 && $row->Campus=="SUN" ){
				$school_id=$row->school_id;
				$course_id=$row->course_id;
				 $get_course_details="SELECT sandipun_ums.vw_stream_details.* from sandipun_ums.vw_stream_details where sandipun_ums.vw_stream_details.school_id=".$school_id." and sandipun_ums.vw_stream_details.course_id=".$course_id;
				
				$query = $this->db->query($get_course_details);
				$get_course_detailsresult = $query->row();
				 if(!empty($get_course_detailsresult)){
					$row->school_code=$get_course_detailsresult->school_short_name;
					$row->course=$get_course_detailsresult->course_name;
			         
				}
			}else if($row->Campus_City==2 && $row->Campus=="SIJOUL" ){
				$school_id=$row->school_id;
				$course_id=$row->course_id;
				 $get_course_details="SELECT sandipun_ums_sijoul.vw_stream_details.* from sandipun_ums_sijoul.vw_stream_details where sandipun_ums_sijoul.vw_stream_details.school_id=".$school_id." and sandipun_ums_sijoul.vw_stream_details.course_id=".$course_id;
				
				$query = $this->db->query($get_course_details);
				$get_course_detailsresult = $query->row();
				 if(!empty($get_course_detailsresult)){
					$row->school_code=$get_course_detailsresult->school_short_name;
					$row->course=$get_course_detailsresult->course_name;
			         
				}
			}
			else{
				$course_id=$row->course_id;
				$Campus_City=$row->Campus_City;
				$get_course_details="select * from school_course sc where sc.course_id=$course_id and sc.campus_city=$Campus_City";
				$query = $this->db->query($get_course_details);
				$get_course_detailsresult = $query->row();
		        if(!empty($get_course_detailsresult)){
					$row->school_code=$get_course_detailsresult->school_code;
					$row->course=$get_course_detailsresult->course;
			         
				}
                
				
				
			}*/
                if ($row->nationality == 1) {

                    $get_add_details = "select states.state_name,taluka_master.taluka_name as city_name from enquiry_student_master join  states 
on enquiry_student_master.state_id=states.state_id join  taluka_master
on  enquiry_student_master.city_id=taluka_master.taluka_id where enquiry_student_master.enquiry_id=" . $row->id;
                    $get_add_details = $DB1->query($get_add_details);
                    $get_add_details = $get_add_details->row();
                    if (!empty($get_add_details)) {
                        $row->state_name = $get_add_details->state_name;
                        $row->city_name = $get_add_details->city_name;
                        $row->Country = 'India';
                    }
                } else if ($row->nationality == 2) {

                    $get_add_details = "select  " . currentdb . ".countries.name as country_name,  " . currentdb . ".states.name as state_name, " . currentdb . ".cities.name as city_name from sandipun_ums.enquiry_student_master join  states 
on sandipun_ums.enquiry_student_master.int_state= " . currentdb . ".states.id join   " . currentdb . ".cities
on  sandipun_ums.enquiry_student_master.int_city= " . currentdb . ".cities.id join   " . currentdb . ".countries
on  sandipun_ums.enquiry_student_master.int_country_id= " . currentdb . ".countries.id where sandipun_ums.enquiry_student_master.enquiry_id=" . $row->id;
                    $get_add_details = $this->db->query($get_add_details);
                    $get_add_details = $get_add_details->row();
                    if (!empty($get_add_details)) {
                        $row->state_name = $get_add_details->state_name;
                        $row->city_name = $get_add_details->city_name;
                        $row->Country = $get_add_details->country_name;
                    }
                }





                $array[] = $row;
            }
        }
        //echo "<pre>";
        $array = json_decode(json_encode($array), TRUE);
        return (array_merge($array, $result1));

        //print_r($array);
        //print_r($result1);
        //exit;
        //exit;
        //return $array;
        //}
        //

    }




    function fetch_student_meetdetails_consultant_new_for_view_to_consultant($var, $start = 0, $limit, $id = "", $year = "")
    {

        $userID = $this->session->userdata('uid');
        $ic_code = $this->session->userdata('ic_code');
        $role_id = $this->session->userdata('role_id');
        $uid = $this->session->userdata("uid");
        if ($year == "") {
            $var['academic_year'] = $this->config->item('current_year');
        } else {
            $var['academic_year'] = base64_decode($year);
        }
        $stf = '';
        if ($var['statusfilter'] != '' &&  $var['statusfilter'] != undefined) {
            $statusfilter = " and s.remuneration_status='" . $var['statusfilter'] . "'";
            if ($var['statusfilter'] == "P") {
                $st = 'N';
            } else {
                $st = 'Y';
            }
            $stf = " and enquiry_student_master.status ='$st' ";
        } else {
            $statusfilter = '';
        }


        $stff = '';

        if ($var['campusfilter'] != '' &&  $var['campusfilter'] != undefined) {

            $stff = " and enquiry_student_master.Campus_City ='" . $var['campusfilter'] . "' ";
        }


        //  if($var['academic_year'] =='2019-20'){

        $whe1 = "  s.created_by  in (" . $id . ")";

        $sql = "SELECT s.id,s.event_code,s.organization ,s.created_by,s.ic_code_consultant,s.student_name,s.mobile1,s.whatsappno,s.email,s.state_name,s.city_name,ir.ic_name,vs.school_code,vs.course_short_name as course,s.remuneration ,s.remuneration_status,s.remuneration_remark,ccd.contact_person,ir.ic_name,ccd.pancard,s.campus_id,stdm.enrollment_no FROM student_meet_details s 
			left join student_mapping as sm  on s.id=sm.smd_id
			
			join sandipun_ums_sijoul.student_master as stdm on stdm.stud_id=sm.ums_id
			join sandipun_ums_sijoul.vw_stream_details as vs on vs.stream_id=stdm.admission_stream
           /* left join school_course sc on sc.course_id=s.programme_id and sc.campus_city=s.campus_id*/
            left join ic_registration ir on s.ic_code_consultant=ir.ic_code 
            left JOIN user_master AS um ON um.`um_id`=s.created_by 
            left JOIN consultants_call_details AS ccd ON ccd.employee_code=um.`employee_code`         
            WHERE /*s.academic_year='" . $var['academic_year'] . "'*/ $whe1 and s.remark='Consultant Upload' $statusfilter and s.remuneration !=0 and s.remuneration!=''";
        $sql .= " ORDER BY  s.id DESC";

        //echo $sql;
        //exit;
        $query = $this->db->query($sql);

        $result1 = $query->result_array();


        //return $result;
        //}
        //else{

        if (isset(
            $var['academic_year']
        )) {
            $acd =  substr($var['academic_year'], 0, 4);
        } else {

            $academic_year = $this->config->item('current_year');
            $current_year = explode('-', $academic_year);
            $acd = $current_year[0];
            //$acd='2020';
        }
        $DB1 = $this->load->database('umsdb', TRUE);
        $cond = "";
        if ($role_id == '1') {
        } elseif ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
			from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;

            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $cond = " and (ccd.ic_code IN ($ss) OR ccd.inserted_by='" . $this->session->userdata('uid') . "' OR ccd.inserted_by IN ($referred_by) )";
        } else {
            $cond = " and enquiry_student_master.created_by='" . $id . "'";
        }


        $sql = "select ccd.contact_person,
enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
as remuneration,enquiry_student_master.Campus_City,
enquiry_student_master.Campus,enquiry_student_master.provisional_no as enrollment_no,enquiry_student_master.status as rstatus,
enquiry_student_master.remark as remark from  enquiry_student_master
 JOIN " . currentdb . ".user_master AS um ON um.um_id=enquiry_student_master.created_by 
 JOIN " . currentdb . ".consultants_call_details AS ccd ON ccd.employee_code=um.employee_code AND  ccd.status= um.status and ccd.status='Y'  
where enquiry_student_master.admission_session='$acd' $stf $stff
and enquiry_student_master.is_from_consultant=1  $cond
UNION
select ccd.contact_person,
enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
as remuneration,enquiry_student_master.Campus_City,
enquiry_student_master.Campus,enquiry_student_master.provisional_no as enrollment_no,enquiry_student_master.status as rstatus,
enquiry_student_master.remark as remark from  enquiry_student_master 
 JOIN " . currentdb . ".user_master AS um ON um.um_id=enquiry_student_master.created_by 
 JOIN " . currentdb . ".consultants_call_details AS ccd ON ccd.employee_code=um.employee_code AND  ccd.status= um.status and ccd.status='Y'  
where enquiry_student_master.admission_session='$acd' $stf $stff
and enquiry_student_master.is_from_consultant=1 and enquiry_student_master.Campus='SIJOUL' $cond
";






        $sql = " Select * from ( $sql ) t ORDER BY  t.id DESC";

        $query = $DB1->query($sql);

        $result = $query->result();

        $array = array();
        if (!empty($result)) {

            foreach ($result as $row) {
                $row->event_code = 'Consultant';
                $row->student_name = $row->first_name . " " . $row->middle_name . " " . $row->last_name;
                $row->remuneration_status = $row->rstatus;
                $row->remuneration_remark = $row->remark;
                $row->school_code = '';
                $row->course = '';
                $row->state_name = '';
                $row->city_name = '';
                $row->Country = 'India';
                if ($row->Campus_City == 1 && $row->Campus == "SUN") {
                    $school_id = $row->school_id;
                    $course_id = $row->course_id;
                    $get_course_details = "SELECT * from sandipun_ums.vw_stream_details where sandipun_ums.vw_stream_details.school_id=" . $school_id . " and sandipun_ums.vw_stream_details.course_id=" . $course_id;

                    $query = $this->db->query($get_course_details);
                    $get_course_detailsresult = $query->row();
                    if (!empty($get_course_detailsresult)) {
                        $row->school_code = $get_course_detailsresult->school_short_name;
                        $row->course = $get_course_detailsresult->course_name;
                    }
                } else if ($row->Campus_City == 2 && $row->Campus == "SIJOUL") {
                    $school_id = $row->school_id;
                    $course_id = $row->course_id;
                    $get_course_details = "SELECT * from sandipun_ums_sijoul.vw_stream_details where sandipun_ums_sijoul.vw_stream_details.school_id=" . $school_id . " and sandipun_ums_sijoul.vw_stream_details.course_id=" . $course_id;

                    $query = $this->db->query($get_course_details);
                    $get_course_detailsresult = $query->row();
                    if (!empty($get_course_detailsresult)) {
                        $row->school_code = $get_course_detailsresult->school_short_name;
                        $row->course = $get_course_detailsresult->course_name;
                    }
                } else {
                    if ($row->course_id != '') {
                        $course_id = $row->course_id;
                        $Campus_City = $row->Campus_City;
                        $get_course_details = "select * from school_course sc where sc.course_id=$course_id and sc.campus_city=$Campus_City";
                        $query = $this->db->query($get_course_details);
                        $get_course_detailsresult = $query->row();
                        if (!empty($get_course_detailsresult)) {
                            $row->school_code = $get_course_detailsresult->school_code;
                            $row->course = $get_course_detailsresult->course;
                        }
                    } else {
                        $row->school_code = '';
                        $row->course = '';
                    }
                }
                if ($row->nationality == 1) {

                    $get_add_details = "select states.state_name,taluka_master.taluka_name as city_name from enquiry_student_master join  states 
on enquiry_student_master.state_id=states.state_id join  taluka_master
on  enquiry_student_master.city_id=taluka_master.taluka_id where enquiry_student_master.enquiry_id=" . $row->id;
                    $get_add_details = $DB1->query($get_add_details);
                    $get_add_details = $get_add_details->row();
                    if (!empty($get_add_details)) {
                        $row->state_name = $get_add_details->state_name;
                        $row->city_name = $get_add_details->city_name;
                        $row->Country = 'India';
                    }
                } else if ($row->nationality == 2) {

                    $get_add_details = "select  " . currentdb . ".countries.name as country_name,  " . currentdb . ".states.name as state_name, " . currentdb . ".cities.name as city_name from sandipun_ums.enquiry_student_master join  states 
on sandipun_ums.enquiry_student_master.int_state= " . currentdb . ".states.id join   " . currentdb . ".cities
on  sandipun_ums.enquiry_student_master.int_city= " . currentdb . ".cities.id join   " . currentdb . ".countries
on  sandipun_ums.enquiry_student_master.int_country_id= " . currentdb . ".countries.id where sandipun_ums.enquiry_student_master.enquiry_id=" . $row->id;
                    $get_add_details = $this->db->query($get_add_details);
                    $get_add_details = $get_add_details->row();
                    if (!empty($get_add_details)) {
                        $row->state_name = $get_add_details->state_name;
                        $row->city_name = $get_add_details->city_name;
                        $row->Country = $get_add_details->country_name;
                    }
                }





                $array[] = $row;
            }
        }
        //echo "<pre>";
        $array = json_decode(json_encode($array), TRUE);
        return (array_merge($array, $result1));

        //print_r($array);
        //print_r($result1);
        //exit;
        //exit;
        //return $array;
        //}
        //

    }



    function fetch_student_meetdetails_consultant_new($var, $start = 0, $limit, $id = "", $year = "")
    {

        $userID = $this->session->userdata('uid');
        $ic_code = $this->session->userdata('ic_code');
        $role_id = $this->session->userdata('role_id');
        $uid = $this->session->userdata("uid");
        if ($year == "") {
            $var['academic_year'] = $this->config->item('current_year');
        } else {
            $var['academic_year'] = base64_decode($year);
        }
        $stf = '';
        if ($var['statusfilter'] != '' &&  $var['statusfilter'] != undefined) {
            $statusfilter = " and s.remuneration_status='" . $var['statusfilter'] . "'";
            if ($var['statusfilter'] == "P") {
                $st = 'N';
            } else {
                $st = 'Y';
            }
            $stf = " and enquiry_student_master.status ='$st' ";
        } else {
            $statusfilter = '';
        }
        //  if($var['academic_year'] =='2019-20'){

        $whe1 = "  s.created_by  in (" . $id . ")";

        $sql = "SELECT s.id,s.event_code,s.organization ,s.created_by,s.ic_code_consultant,s.student_name,s.mobile1,s.whatsappno,s.email,s.state_name,s.city_name,ir.ic_name,vs.school_code,vs.course_short_name as course,s.remuneration ,s.remuneration_status,s.remuneration_remark,ccd.contact_person,ir.ic_name,ccd.pancard,s.campus_id,stdm.enrollment_no FROM student_meet_details s 
			left join student_mapping as sm  on s.id=sm.smd_id
			
			join sandipun_ums_sijoul.student_master as stdm on stdm.stud_id=sm.ums_id
			join sandipun_ums_sijoul.vw_stream_details as vs on vs.stream_id=stdm.admission_stream
           /* left join school_course sc on sc.course_id=s.programme_id and sc.campus_city=s.campus_id*/
            left join ic_registration ir on s.ic_code_consultant=ir.ic_code 
            left JOIN user_master AS um ON um.`um_id`=s.created_by 
            left JOIN consultants_call_details AS ccd ON ccd.employee_code=um.`employee_code`         
            WHERE /*s.academic_year='" . $var['academic_year'] . "'*/ $whe1 and s.remark='Consultant Upload' $statusfilter and s.remuneration !=0 and s.remuneration!=''";
        $sql .= " ORDER BY  s.id DESC";


        $query = $this->db->query($sql);

        $result1 = $query->result_array();


        //return $result;
        //}
        //else{

        if (isset(
            $var['academic_year']
        )) {
            $acd =  substr($var['academic_year'], 0, 4);
        } else {

            $academic_year = $this->config->item('current_year');
            $current_year = explode('-', $academic_year);
            $acd = $current_year[0];
            //$acd='2020';
        }
        $DB1 = $this->load->database('umsdb', TRUE);
        $cond = "";
        if ($role_id == '1') {
        } elseif ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
			from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;

            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $cond = " and (ccd.ic_code IN ($ss) OR ccd.inserted_by='" . $this->session->userdata('uid') . "' OR ccd.inserted_by IN ($referred_by) )";
        } else {
            $cond = " and enquiry_student_master.created_by='" . $id . "'";
        }


        $sql = "select ccd.contact_person,'Nashik' as Campusdata,vw_stream_details.stream_name as course,vw_stream_details.school_short_name as school_code,enquiry_student_master.created_on,
enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
as remuneration,enquiry_student_master.Campus_City,
enquiry_student_master.Campus,enquiry_student_master.provisional_no as enrollment_no,enquiry_student_master.status as rstatus,msm.enrollment_no as prn,
enquiry_student_master.remark as remark from  enquiry_student_master join
student_master as msm on enquiry_student_master.enquiry_id=msm.enquiry_id 
join vw_stream_details on msm.admission_stream=vw_stream_details.stream_id
 JOIN " . currentdb . ".user_master AS um ON um.um_id=enquiry_student_master.created_by 
 JOIN " . currentdb . ".consultants_call_details AS ccd ON ccd.employee_code=um.employee_code AND  ccd.status= um.status and ccd.status='Y'  
where enquiry_student_master.admission_session='$acd' $stf
and enquiry_student_master.is_from_consultant=1  $cond
UNION
select ccd.contact_person,'Sijoul' as Campusdata,vw_stream_details.stream_name as course,vw_stream_details.school_short_name as school_code,enquiry_student_master.created_on,
enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
as remuneration,enquiry_student_master.Campus_City,
enquiry_student_master.Campus,enquiry_student_master.provisional_no as enrollment_no,enquiry_student_master.status as rstatus,msm.enrollment_no as prn,
enquiry_student_master.remark as remark from  enquiry_student_master join
sandipun_ums_sijoul.
student_master as msm on enquiry_student_master.stude_id=msm.stud_id 
join vw_stream_details on msm.admission_stream=vw_stream_details.stream_id
 JOIN " . currentdb . ".user_master AS um ON um.um_id=enquiry_student_master.created_by 
 JOIN " . currentdb . ".consultants_call_details AS ccd ON ccd.employee_code=um.employee_code AND  ccd.status= um.status and ccd.status='Y'  
where enquiry_student_master.admission_session='$acd' $stf
and enquiry_student_master.is_from_consultant=1  $cond 
";





        $sql = " Select * from ( $sql ) t ORDER BY  t.id DESC";
        //echo $sql;
        //	exit;

        $query = $DB1->query($sql);

        $result = $query->result();

        $array = array();
        if (!empty($result)) {

            foreach ($result as $row) {
                $row->event_code = 'Consultant';
                $row->student_name = $row->first_name . " " . $row->middle_name . " " . $row->last_name;
                $row->remuneration_status = $row->rstatus;
                $row->remuneration_remark = $row->remark;
                //$row->school_code='';
                //$row->course='';
                $row->state_name = '';
                $row->city_name = '';
                $row->Country = 'India';
                /*if($row->Campus_City==1 && $row->Campus=="SUN" ){
				$school_id=$row->school_id;
				$course_id=$row->course_id;
				 $get_course_details="SELECT sandipun_ums.vw_stream_details.* from sandipun_ums.vw_stream_details where sandipun_ums.vw_stream_details.school_id=".$school_id." and sandipun_ums.vw_stream_details.course_id=".$course_id;
				
				$query = $this->db->query($get_course_details);
				$get_course_detailsresult = $query->row();
				 if(!empty($get_course_detailsresult)){
					$row->school_code=$get_course_detailsresult->school_short_name;
					$row->course=$get_course_detailsresult->course_name;
			         
				}
			}else if($row->Campus_City==2 && $row->Campus=="SIJOUL" ){
				$school_id=$row->school_id;
				$course_id=$row->course_id;
				 $get_course_details="SELECT sandipun_ums_sijoul.vw_stream_details.* from sandipun_ums_sijoul.vw_stream_details where sandipun_ums_sijoul.vw_stream_details.school_id=".$school_id." and sandipun_ums_sijoul.vw_stream_details.course_id=".$course_id;
				
				$query = $this->db->query($get_course_details);
				$get_course_detailsresult = $query->row();
				 if(!empty($get_course_detailsresult)){
					$row->school_code=$get_course_detailsresult->school_short_name;
					$row->course=$get_course_detailsresult->course_name;
			         
				}
			}
			else{
				$course_id=$row->course_id;
				$Campus_City=$row->Campus_City;
				$get_course_details="select * from school_course sc where sc.course_id=$course_id and sc.campus_city=$Campus_City";
				$query = $this->db->query($get_course_details);
				$get_course_detailsresult = $query->row();
		        if(!empty($get_course_detailsresult)){
					$row->school_code=$get_course_detailsresult->school_code;
					$row->course=$get_course_detailsresult->course;
			         
				}
                
				
				
			}*/
                if ($row->nationality == 1) {

                    $get_add_details = "select states.state_name,taluka_master.taluka_name as city_name from enquiry_student_master join  states 
on enquiry_student_master.state_id=states.state_id join  taluka_master
on  enquiry_student_master.city_id=taluka_master.taluka_id where enquiry_student_master.enquiry_id=" . $row->id;
                    $get_add_details = $DB1->query($get_add_details);
                    $get_add_details = $get_add_details->row();
                    if (!empty($get_add_details)) {
                        $row->state_name = $get_add_details->state_name;
                        $row->city_name = $get_add_details->city_name;
                        $row->Country = 'India';
                    }
                } else if ($row->nationality == 2) {

                    $get_add_details = "select  " . currentdb . ".countries.name as country_name,  " . currentdb . ".states.name as state_name, " . currentdb . ".cities.name as city_name from sandipun_ums.enquiry_student_master join  states 
on sandipun_ums.enquiry_student_master.int_state= " . currentdb . ".states.id join   " . currentdb . ".cities
on  sandipun_ums.enquiry_student_master.int_city= " . currentdb . ".cities.id join   " . currentdb . ".countries
on  sandipun_ums.enquiry_student_master.int_country_id= " . currentdb . ".countries.id where sandipun_ums.enquiry_student_master.enquiry_id=" . $row->id;
                    $get_add_details = $this->db->query($get_add_details);
                    $get_add_details = $get_add_details->row();
                    if (!empty($get_add_details)) {
                        $row->state_name = $get_add_details->state_name;
                        $row->city_name = $get_add_details->city_name;
                        $row->Country = $get_add_details->country_name;
                    }
                }





                $array[] = $row;
            }
        }
        //echo "<pre>";
        $array = json_decode(json_encode($array), TRUE);
        return (array_merge($array, $result1));

        //print_r($array);
        //print_r($result1);
        //exit;
        //exit;
        //return $array;
        //}
        //

    }

    function fetch_student_meetdetails_consultant_new_for_consultant($var, $start = 0, $limit, $id = "", $year = "")
    {

        $userID = $this->session->userdata('uid');
        $ic_code = $this->session->userdata('ic_code');
        $role_id = $this->session->userdata('role_id');
        $uid = $this->session->userdata("uid");



        //if($id !=''){
        //$var['academic_year'] ='2019-20';
        //}
        if ($year == "") {
            $var['academic_year'] = $this->config->item('current_year');
        } else {
            $var['academic_year'] = base64_decode($year);
        }


        //  if($var['academic_year'] =='2019-20'){

        $whe1 = "  s.created_by  in (" . $id . ")";

        $sql = "SELECT s.id,s.event_code,s.organization ,s.created_by,s.ic_code_consultant,s.student_name,s.mobile1,s.whatsappno,s.email,s.state_name,s.city_name,ir.ic_name,vs.school_code,vs.course_short_name as course,s.remuneration ,s.remuneration_status,s.remuneration_remark,ccd.contact_person,ir.ic_name,ccd.pancard,s.campus_id FROM student_meet_details s 
			left join student_mapping as sm  on s.id=sm.smd_id
			
			join sandipun_ums_sijoul.student_master as stdm on stdm.stud_id=sm.ums_id
			join sandipun_ums_sijoul.vw_stream_details as vs on vs.stream_id=stdm.admission_stream
           /* left join school_course sc on sc.course_id=s.programme_id and sc.campus_city=s.campus_id*/
            left join ic_registration ir on s.ic_code_consultant=ir.ic_code 
            left JOIN user_master AS um ON um.`um_id`=s.created_by 
            left JOIN consultants_call_details AS ccd ON ccd.employee_code=um.`employee_code`         
            WHERE /*s.academic_year='" . $var['academic_year'] . "'*/ $whe1 and s.remark='Consultant Upload' ";
        $sql .= " ORDER BY  s.id DESC";
        //echo $sql;
        //exit;
        $query = $this->db->query($sql);

        $result1 = $query->result_array();


        //return $result;
        //}
        //else{
        $var['academic_year'] = base64_decode($year);
        if (isset(
            $var['academic_year']
        )) {
            $acd =  substr($var['academic_year'], 0, 4);
        } else {
            $y = $acd1 = $this->config->item('current_year');
            $current_year = explode('-', $acd1);
            $acd = $current_year[0];
        }
        $DB1 = $this->load->database('umsdb', TRUE);
        if ($role_id != '1') {
        }

        $sql = "select ccd.contact_person,
enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
as remuneration,enquiry_student_master.Campus_City,
enquiry_student_master.Campus,enquiry_student_master.provisional_no as enrollment_no,enquiry_student_master.status as rstatus,
enquiry_student_master.remark as remark from  enquiry_student_master 
 JOIN " . currentdb . ".user_master AS um ON um.um_id=enquiry_student_master.created_by 
 JOIN " . currentdb . ".consultants_call_details AS ccd ON ccd.employee_code=um.employee_code AND  ccd.status= um.status and ccd.status='Y'  
where enquiry_student_master.admission_session='$acd'
and enquiry_student_master.is_from_consultant=1 and enquiry_student_master.created_by='" . $id . "' 
";


        $sql = " Select * from ( $sql ) t ORDER BY  t.id DESC";



        $query = $DB1->query($sql);

        $result = $query->result();

        $array = array();
        if (!empty($result)) {

            foreach ($result as $row) {
                $row->event_code = 'Consultant';
                $row->student_name = $row->first_name . " " . $row->middle_name . " " . $row->last_name;
                $row->remuneration_status = $row->rstatus;
                $row->remuneration_remark = $row->remark;
                $row->school_code = '';
                $row->course = '';
                $row->state_name = '';
                $row->city_name = '';
                $row->Country = 'India';
                if ($row->Campus_City == 1 && $row->Campus == "SUN") {
                    $school_id = $row->school_id;
                    $course_id = $row->course_id;
                    $get_course_details = "SELECT sandipun_ums.vw_stream_details.* from sandipun_ums.vw_stream_details where sandipun_ums.vw_stream_details.school_id=" . $school_id . " and sandipun_ums.vw_stream_details.course_id=" . $course_id;

                    $query = $this->db->query($get_course_details);
                    $get_course_detailsresult = $query->row();
                    if (!empty($get_course_detailsresult)) {
                        $row->school_code = $get_course_detailsresult->school_short_name;
                        $row->course = $get_course_detailsresult->course_name;
                    }
                }
                if ($row->Campus_City == 2 && $row->Campus == "SIJOUL") {
                    $school_id = $row->school_id;
                    $course_id = $row->course_id;
                    $get_course_details = "SELECT sandipun_ums_sijoul.vw_stream_details.* from sandipun_ums_sijoul.vw_stream_details where sandipun_ums_sijoul.vw_stream_details.school_id=" . $school_id . " and sandipun_ums_sijoul.vw_stream_details.course_id=" . $course_id;

                    $query = $this->db->query($get_course_details);
                    $get_course_detailsresult = $query->row();
                    if (!empty($get_course_detailsresult)) {
                        $row->school_code = $get_course_detailsresult->school_short_name;
                        $row->course = $get_course_detailsresult->course_name;
                    }
                } else {
                    $course_id = $row->course_id;
                    $Campus_City = $row->Campus_City;
                    $get_course_details = "select * from school_course sc where sc.course_id=$course_id and sc.campus_city=$Campus_City";
                    $query = $this->db->query($get_course_details);
                    $get_course_detailsresult = $query->row();
                    if (!empty($get_course_detailsresult)) {
                        $row->school_code = $get_course_detailsresult->school_code;
                        $row->course = $get_course_detailsresult->course;
                    }
                }
                if ($row->nationality == 1) {

                    $get_add_details = "select states.state_name,taluka_master.taluka_name as city_name from enquiry_student_master join  states 
on enquiry_student_master.state_id=states.state_id join  taluka_master
on  enquiry_student_master.city_id=taluka_master.taluka_id where enquiry_student_master.enquiry_id=" . $row->id;
                    $get_add_details = $DB1->query($get_add_details);
                    $get_add_details = $get_add_details->row();
                    if (!empty($get_add_details)) {
                        $row->state_name = $get_add_details->state_name;
                        $row->city_name = $get_add_details->city_name;
                        $row->Country = 'India';
                    }
                } else if ($row->nationality == 2) {

                    $get_add_details = "select  " . currentdb . ".countries.name as country_name,  " . currentdb . ".states.name as state_name, " . currentdb . ".cities.name as city_name from sandipun_ums.enquiry_student_master join  states 
on sandipun_ums.enquiry_student_master.int_state= " . currentdb . ".states.id join   " . currentdb . ".cities
on  sandipun_ums.enquiry_student_master.int_city= " . currentdb . ".cities.id join   " . currentdb . ".countries
on  sandipun_ums.enquiry_student_master.int_country_id= " . currentdb . ".countries.id where sandipun_ums.enquiry_student_master.enquiry_id=" . $row->id;
                    $get_add_details = $this->db->query($get_add_details);
                    $get_add_details = $get_add_details->row();
                    if (!empty($get_add_details)) {
                        $row->state_name = $get_add_details->state_name;
                        $row->city_name = $get_add_details->city_name;
                        $row->Country = $get_add_details->country_name;
                    }
                }





                $array[] = $row;
            }
        }
        //echo "<pre>";
        $array = json_decode(json_encode($array), TRUE);
        return (array_merge($array, $result1));

        //print_r($array);
        //print_r($result1);
        //exit;
        //exit;
        //return $array;
        //}
        //

    }






    function get_details($consultant_id, $year = '')
    {

        $a = array('consultant_id' => $consultant_id);
        if ($year != '') {
            $a['academic_year'] = base64_decode($year);
        }
        return $this->db->get_where('consultant_payment_details', $a)->result_array();
    }


    function add_payment_details($array = array())
    {
        // return $this->db->get_where('consultant_payment_details',array('consultant_id'=>$consultant_id))->result_array();
        $array['date'] = date('Y-m-d');
        $array['created_on'] = date('Y-m-d h:i:s');
        $uid = $this->session->userdata("uid");
        $array['created_by'] = $uid;
        $this->db->insert('consultant_payment_details', $array);
        //echo $this->db->last_query();
        //exit;
        $id = $this->db->insert_id();

        return  $id;
    }


    function check_data($rr)
    {
        $array['status'] = 'Pending';

        $DB5 = $this->load->database('umsdb', TRUE);
        $data = $DB5->query("select * from enquiry_student_master where enquiry_id=$rr")->row();

        if (!empty($data)) {
            $ums_id = $data->stude_id;
            if ($data->Campus == 'SIJOUL') {



                $DB1 = $this->load->database('ums_sijoul', TRUE);

                $ums_data = $DB1->query("select * from fees_challan where student_id=$ums_id and (type_id=2)")->row();

                if (!empty($ums_data)) {

                    $array['status'] = 'Paid';
                    $array['payment_done'] = $data->payment_done;
                    $array['id'] = $ums_data->fees_id;
                    $array['mapping_id'] = $data->enquiry_id;
                } else {

                    $array['status'] = 'Pending';
                }
            } elseif ($data->Campus == 'SUN') {
                $DB1 = $this->load->database('umsdb', TRUE);

                $student_id_details = $DB1->query("select * from student_master where enquiry_id=$rr")->row();
                if (!empty($student_id_details)) {
                    $studnt_id = $student_id_details->stud_id;

                    $ums_data = $DB1->query("select * from fees_challan where student_id=$studnt_id and challan_status='VR'")->row();

                    if (!empty($ums_data)) {

                        $array['status'] = 'Paid';
                        $array['payment_done'] = $data->payment_done;
                        $array['id'] = $ums_data->fees_id;
                        $array['mapping_id'] = $data->enquiry_id;
                    } else {

                        $array['status'] = 'Pending';
                    }
                } else {
                    $array['status'] = '----';
                }
            } else {
                $array['status'] = '----';
            }
        }

        return  $array;
    }

    function check_amount_paid($rr)
    {
        $array['status'] = 'Pending';

        $DB5 = $this->load->database('umsdb', TRUE);
        $data = $DB5->query("select * from enquiry_student_master where enquiry_id=$rr")->row();

        if (!empty($data)) {
            $ums_id = $data->stude_id;
            if ($data->Campus == 'SIJOUL') {



                $DB1 = $this->load->database('ums_sijoul', TRUE);

                $ums_data = $DB1->query("select sum(amount) as amount from fees_details where student_id=$ums_id and is_deleted='N'")->row();

                if (!empty($ums_data)) {

                    $array['status'] = 'Paid';
                    $array['payment_done'] = $data->payment_done;
                    $array['amount'] = $ums_data->amount;
                    $array['mapping_id'] = $data->enquiry_id;
                } else {

                    $array['status'] = 'Pending';
                }
            } elseif ($data->Campus == 'SUN') {
                $DB1 = $this->load->database('umsdb', TRUE);

                $student_id_details = $DB1->query("select * from student_master where enquiry_id=$rr")->row();
                if (!empty($student_id_details)) {
                    $studnt_id = $student_id_details->stud_id;

                    $ums_data = $DB1->query("select sum(amount) as amount from fees_details where student_id=$studnt_id and is_deleted='N'")->row();

                    if (!empty($ums_data)) {

                        $array['status'] = 'Paid';
                        $array['payment_done'] = $data->payment_done;
                        $array['amount'] = $ums_data->amount;
                        $array['mapping_id'] = $data->enquiry_id;
                    } else {

                        $array['status'] = 'Pending';
                    }
                } else {
                    $array['status'] = '----';
                }
            } else {
                $array['status'] = '----';
            }
        }

        return  $array;
    }



    function upload_fbdata($data = array())
    {
        $this->db->insert('student_meet_details', $data);
        $insert_id = $this->db->insert_id();
        return  $insert_id;
    }

    function get_student_id($prn)
    {
        $DB1 = $this->load->database('ums_sijoul', TRUE);
        $id = $DB1->query("select * from student_master where enrollment_no_new=$prn and fees_paid_type='UTR'")->row();
    }

    public function fees_challan_list_byid($id)
    {

        //echo "sdddd";
        $DB1 = $this->load->database('ums_sijoul', TRUE);
        $DB1->select("fee.*,sm.current_year,sm.mobile,sm.first_name,sm.middle_name,sm.last_name,sm.academic_year as sacademic_year,sm.enrollment_no,sm.stud_id,
		sm.admission_stream,vw.stream_name as stream_name,vw.course_short_name as course_name, vw.school_short_name as school_name,
		sandipun_erp_sijoul.bank_master.bank_id, 
		sandipun_erp_sijoul.bank_master.bank_name, 
		sandipun_erp_sijoul.bank_master.account_name,
		sandipun_erp_sijoul.bank_master.bank_account_no as account_no,
		
		sandipun_erp_sijoul.bank_master.branch_name,
		sandipun_erp_sijoul.bank_master.bank_code,
		sandipun_ums_sijoul.bank_master.bank_id as ubank_id,
		sandipun_ums_sijoul.bank_master.bank_name as ubank_name
		");
        $DB1->from("sandipun_ums_sijoul.fees_challan fee");

        $DB1->join("sandipun_ums_sijoul.student_master sm", "sm.enrollment_no=fee.enrollment_no", 'INNER');
        $DB1->join("sandipun_ums_sijoul.vw_stream_details vw", "sm.admission_stream = vw.stream_id", 'INNER');
        $DB1->join("sandipun_erp_sijoul.bank_master", "sandipun_erp_sijoul.bank_master.bank_id = fee.bank_account_id", 'LEFT');
        $DB1->join("sandipun_ums_sijoul.bank_master", "sandipun_ums_sijoul.bank_master.bank_id = fee.bank_id", 'LEFT');
        //$this->db->join("sandipun_erp_sijoul.sf_bank_account_details","sandipun_erp_sijoul.sf_bank_account_details.bank_account_id = fee.bank_account_id");
        $DB1->where('fee.is_deleted', 'N');
        $DB1->where('fee.fees_id', $id);

        $query1 = $DB1->get();
        //echo $DB1->last_query();
        return $query1->row_array();
    }


    function get_data_of_consultant_date_wise($date = "", $tdate = "", $consultant_id = '')
    {

        $sql = "SELECT consultant_payment_details.*,(amount) as amount,
	  
	  consultants_call_details.is_fou,consultant_payment_details.consultant_id ,
	  
	  
	  CASE
    WHEN consultants_call_details.contact_person !='' THEN  consultants_call_details.contact_person
    WHEN iu.fname !='' THEN CONCAT(iu.fname,' ',iu.lname)
    WHEN ih.staff_name !='' THEN ih.staff_name
    
END as contact_person,  
	  CASE
    WHEN consultants_call_details.is_fou !='' THEN  consultants_call_details.is_fou
    ElSE 0
    
END as is_fou,
	  
	  
	  
	  consultant_payment_details.created_on
FROM consultant_payment_details 
join 
user_master on consultant_payment_details.consultant_id= user_master.um_id
left join
consultants_call_details on consultants_call_details .id=user_master.con_id 
left join 
ic_user_master as iu on user_master.employee_code=iu.employee_code
left join 
inhouse_staff_details as ih on user_master.username=ih.staff_id



";


        if ($date != '' && $tdate != "") {
            $sql .= " WHERE STR_TO_DATE(consultant_payment_details.created_on,'%Y-%m-%d')>='$date' AND STR_TO_DATE(consultant_payment_details.created_on,'%Y-%m-%d')<='$tdate' ";
        }
        if ($consultant_id != '') {

            $sql .= " and consultant_payment_details.consultant_id=$consultant_id ";
        }



        $sql .= " group by consultant_payment_details.fees_id";


        $query = $this->db->query($sql)->result();
        return  $query;
    }

    function get_admission_taken()
    {
        $user_id = $this->session->userdata('uid');
        if ($user_id == "superadmin" || $user_id == "admin") {
            $cond = " ";
        } else {
            // $cond="and c.called_by='". $user_id ."'";
            $cond = " and called_by='" . $user_id . "'";
        }
        $sql = "SELECT COUNT(DISTINCT((student_id))) as count_data FROM calling_log_details where calling_status='ADMISSION-TAKEN' $cond";



        $query = $this->db->query($sql)->row()->count_data;

        return  $query;
    }


    function get_all_admission_taken()
    {
        $user_id = $this->session->userdata('uid');
        if ($user_id == "superadmin" || $user_id == "admin") {
            $cond = " ";
        } else {
            // $cond="and c.called_by='". $user_id ."'";
            $cond = " and called_by='" . $user_id . "'";
        }


        $sql = "SELECT s.admission_form_taken,im.institute_name,s.mobile1_valid,s.country_name,
        s.id as std_id,s.student_name,s.mobile1,s.pmobile_no,s.whatsappno,s.pwhatsapp_no,
        CASE WHEN s.ic_code ='digital' THEN CONCAT(s.utm_source,' - ',s.utm_campaign) ELSE ir.ic_name END AS ic_name,
        s.stream_name,DATE_FORMAT(ld.called_on, '%r') AS date_added,sm.standard_name,s.city_name,s.state_name as state_name,s.mock_interested,s.sujee_interested,s.mock_testseries_sms_status,CONCAT(iu.fname,' ',iu.lname) as caller_name ,p.course as course_name
        FROM calling_log_details as ld
        inner JOIN student_meet_details s on ld.student_id=s.id      
        left join event_details ed on s.event_code=ed.event_code
        left join institute_master im on ed.institue_id=im.institue_id
        LEFT JOIN standard_master sm ON s.standard=sm.standard_id
        LEFT JOIN school_course p ON s.programme_id = p.course_id        
       inner join ic_users iu on iu.um_id=ld.called_by
       left join ic_registration ir ON s.ic_code=ir.ic_code
        where  ld.calling_status='ADMISSION-TAKEN'  $cond
        AND s.student_name IS NOT NULL 
        group by ld.student_id order by DATE(ld.called_on) ASC ,date_added DESC ";
        $query = $this->db->query($sql);

        // echo $this->db->last_query(); 
        $res = $query->result_array();
        return $res;
    }


    //new development for consultant by vighnesh


    public function get_all_consultants_fou_list_for_recent_year($data, $cid = "")
    {

        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        if (!empty($data['coid']) && $data['coid'] != '' && $data['coid'] != undefined) {
            $wco = ' and c.country_id = "' . $data['coid'] . '"';
        }
        if (!empty($data['sid']) && $data['sid'] != '' && $data['sid'] != undefined) {
            $ws = ' and c.state_id = "' . $data['sid'] . '"';
        }
        if (!empty($data['cid']) && $data['cid'] != '' && $data['cid'] != undefined) {
            $wc = ' and c.city_id = "' . $data['cid'] . '"';
        }
        if (!empty($data['rid']) && $data['rid'] != '' && $data['rid'] != undefined) {
            $rd = ' and um.roles_id = "' . $data['rid'] . '"';
        }
        if (!empty($data['rfid']) && $data['rfid'] != '' && $data['rfid'] != undefined) {

            $rfd1 = ' and c.co_reff_by = "' . $data['rfid'] . '"';
        }

        if (!empty($data['consultant']) && $data['consultant'] != '' && $data['consultant'] != undefined) {

            $rfd11 = ' and um.um_id = "' . $data['consultant'] . '"';
        }
        if (!empty($data['academic_year']) && $data['academic_year'] != '' && $role_id == '30') {
            $current_year = explode('-', $data['academic_year']);
            $acd = $current_year[0];
            //$rfd = ' and sm.admission_session = "'.$acd.'"';
        }
        /*elseif($cid !=''){
	 $rfd = ' and c.academic_year = "2019-20"';
}
else{
	 $rfd = ' and c.academic_year = "2020-21"';
}*/
        if ($role_id == '1' || $role_id == '30') {

            $wh = "and (c.counselor_type='FOU' or c.counselor_type='CL')";

            if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != 'undefined') {
                $wh1 = " and c.ic_code='" . $data['icfilter'] . "'";
            }
        } else if (($role_id == '8')  && $uid != 429) {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if (($role_id == '8')  && $uid == 429) {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and (c.ic_code='" . $this->session->userdata('ic_code') . "' or c.ic_code='SU_BR_003')";
        } else if ($role_id == 16 || $role_id == 7) {
            $wh = " and ( c.consultant_head='" . $this->session->userdata('uid') . "')  ";
        } else if ($role_id == 17) {
            $wh = " and um.um_id = " . $this->session->userdata('uid');
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;

            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
         from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by) )";
            if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != 'undefined') {
                $wh1 = " and c.ic_code='" . $data['icfilter'] . "'";
            }
        } else {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "'";
        }


        $cii = '';

        if ($cid != '' && $cid != null) {

            $cii = " and um.um_id = $cid ";
        }
        $ac = '';
        if (!empty($data['ac']) && $data['ac'] != ''  && $data['ac'] != undefined) {

            $ac = ' and c.inserted_by = "' . $data['ac'] . '"';
        }

        if (!empty($data['consultant_head']) && $data['consultant_head'] != ''  && $data['consultant_head'] != undefined) {
            $wh = '';
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=" . $data['consultant_head'] . " and status='Y'")->row()->ic_code;

            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";

            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
         from consultant_cordinator_mapping where consultant_id=" . $data['consultant_head'] . " and status='Y'")->row()->cordinator_id;

            $wh =  " and (c.ic_code IN ($ss) OR c.inserted_by='" . $data['consultant_head'] . "' OR c.inserted_by IN ($referred_by ) OR c.consultant_head=$uid ) ";
        }

        //
        $sql = "select c.*,um.roles_id,rm.roles_name,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id from
consultants_call_details as c 
inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
left join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 

inner join roles_master as rm ON rm.roles_id=um.roles_id
left join states as s on c.state_id = s.id
left join cities as ci ON ci.id=c.city_id
where c.status='Y' and  c.counselor_type != 'NULL'   $wco $ws $wc $rd $rfd $rfd1 $wh $wh1 $rfd11 $cii  $ac
group by c.id order by c.contact_person";


        $query  = $this->db->query($sql);


        $result = $query->result_array();


        $sql = str_replace("sandipun_ums.student_master", "sandipun_ums_sijoul.student_master", $sql);
        $sql = str_replace("sm.enquiry_id", "sm.stude_id", $sql);
        $sql = str_replace("msm.stude_id", "msm.stud_id", $sql);
        //echo $sql;

        //exit;
        $query  = $this->db->query($sql);

        $result1 = array();
        $result = array_unique(array_merge($result, $result1), SORT_REGULAR);


        //array_merge($result,$result1); 
        return $result;
    }



    function get_count_of_admission_done_yet_for_current_year($um_id, $current_year1 = '')
    {

        if ($current_year1 == '') {
            $current_year1 = $this->config->item('current_year');
        }

        $current_year = explode('-', $current_year1);
        $current_year = $current_year[0];

        return $this->db->query("select COALESCE(sum(count),0)  as tc from(
select count(sandipun_ums.enquiry_student_master.enquiry_id) as count from sandipun_ums.enquiry_student_master 
join sandipun_ums.
student_master as msm on enquiry_student_master.enquiry_id=msm.enquiry_id 
where sandipun_ums.enquiry_student_master.created_by='$um_id' and sandipun_ums.enquiry_student_master.is_from_consultant='1' and sandipun_ums.enquiry_student_master.admission_session='$current_year'

and msm.cancelled_admission='N'
UNION
select count(sandipun_ums.enquiry_student_master.enquiry_id) as count from sandipun_ums.enquiry_student_master 
join sandipun_ums_sijoul.
student_master as msm on enquiry_student_master.stude_id=msm.stud_id 
where sandipun_ums.enquiry_student_master.created_by='$um_id' and sandipun_ums.enquiry_student_master.is_from_consultant='1' and sandipun_ums.enquiry_student_master.admission_session='$current_year'
and msm.cancelled_admission='N'

UNION 
select count(a.student_id) as count 
from 
" . currentdb . ".sf_admission_data as sf join " . currentdb . ".admission_benefits_and_source as a on sf.id=a.student_id and a.is_for=3 
where  a.academic_year='$current_year1' and a.benefit_to='$um_id'


UNION ALL
select count(" . currentdb . ".student_meet_details.id) as count from " . currentdb . ".student_meet_details 
where " . currentdb . ".student_meet_details.created_by='$um_id' and " . currentdb . ".student_meet_details.remark='Consultant Upload' and " . currentdb . ".student_meet_details.remuneration_status='V' and " . currentdb . ".student_meet_details.remuneration !=0 and " . currentdb . ".student_meet_details.remuneration!='' and " . currentdb . ".student_meet_details.academic_year='$current_year1'


) t")->row()->tc;
    }


    function get_count_of_registration_done_yet_for_current_year($um_id, $current_year1 = '')
    {

        if ($current_year1 == '') {
            $current_year1 = $this->config->item('current_year');
        }

        $current_year = explode('-', $current_year1);
        $current_year = $current_year[0];

        return $this->db->query("select COALESCE(sum(count),0)  as tc from(
select count(sandipun_ums.enquiry_student_master.enquiry_id) as count from sandipun_ums.enquiry_student_master 
where sandipun_ums.enquiry_student_master.created_by='$um_id' and sandipun_ums.enquiry_student_master.is_from_consultant='1' and sandipun_ums.enquiry_student_master.admission_session='$current_year'
) t")->row()->tc;
    }

    function get_renumeration_amount_for_current_year($um_id, $current_year = '')
    {
        $current_year1 = $current_year;
        if ($current_year == '') {
            $current_year = $this->config->item('current_year');
        }
        $current_year = explode('-', $current_year);
        $current_year = $current_year[0];
        return $this->db->query("select
COALESCE(sum(renumeration),0)
		 as renumeration_amout from(

select sum(sandipun_ums.enquiry_student_master.renumeration_amount) as renumeration from sandipun_ums.enquiry_student_master 
join sandipun_ums.
student_master as msm on enquiry_student_master.enquiry_id=msm.enquiry_id 
where sandipun_ums.enquiry_student_master.created_by='$um_id'  and sandipun_ums.enquiry_student_master.is_from_consultant='1' and sandipun_ums.enquiry_student_master.admission_session='$current_year'

and msm.cancelled_admission='N'
UNION
select sum(sandipun_ums.enquiry_student_master.renumeration_amount) as renumeration from sandipun_ums.enquiry_student_master 
join sandipun_ums_sijoul.
student_master as msm on enquiry_student_master.stude_id=msm.stud_id 
where sandipun_ums.enquiry_student_master.created_by='$um_id' and sandipun_ums.enquiry_student_master.is_from_consultant='1' and sandipun_ums.enquiry_student_master.admission_session='$current_year' and msm.cancelled_admission='N'
UNION ALL
select sum(" . currentdb . ".student_meet_details.remuneration) as renumeration from " . currentdb . ".student_meet_details 
where " . currentdb . ".student_meet_details.created_by='$um_id' and " . currentdb . ".student_meet_details.remark='Consultant Upload' and " . currentdb . ".student_meet_details.remuneration_status='V' and remuneration !=0 and " . currentdb . ".student_meet_details.remuneration!='' and " . currentdb . ".student_meet_details.academic_year='$current_year1'
) t")->row()->renumeration_amout;
    }


    function get_payment_done_for_current_year($um_id, $current_year1 = '')
    {
        return $this->db->query("select COALESCE(sum(amount),0)  as amount from " . currentdb . ".consultant_payment_details 
where " . currentdb . ".consultant_payment_details.consultant_id='$um_id'  and academic_year='$current_year1'
")->row()->amount;
    }

    function get_tds_done_for_current_year_revised($um_id, $current_year1 = '')
    {
        return $this->db->query("select COALESCE(sum(tds),0)  as amount from " . currentdb . ".consultant_payment_details 
where " . currentdb . ".consultant_payment_details.consultant_id='$um_id'  and academic_year='$current_year1'
")->row()->amount;
    }

    function fetch_student_meetdetails_consultant_new_data($var, $start = 0, $limit, $id = "", $year = "")
    {

        $userID = $this->session->userdata('uid');
        $ic_code = $this->session->userdata('ic_code');
        $role_id = $this->session->userdata('role_id');
        $uid = $this->session->userdata("uid");

        if ($year != '') {
            $var['academic_year'] = base64_decode($year);
        }
        //  if($var['academic_year'] =='2019-20'){

        $whe1 = " and  s.created_by  in (" . $id . ")";

        $sql = "SELECT s.id,s.event_code,s.organization ,s.created_by,s.ic_code_consultant,s.student_name,s.mobile1,s.whatsappno,s.email,s.state_name,s.city_name,ir.ic_name,vs.school_code,vs.course_short_name as course,s.remuneration ,s.remuneration_status,s.remuneration_remark,ccd.contact_person,ir.ic_name,ccd.pancard,s.campus_id,stdm.enrollment_no,0 as stude_id FROM student_meet_details s 
			left join student_mapping as sm  on s.id=sm.smd_id
			
			join sandipun_ums_sijoul.student_master as stdm on stdm.stud_id=sm.ums_id
			join sandipun_ums_sijoul.vw_stream_details as vs on vs.stream_id=stdm.admission_stream
           /* left join school_course sc on sc.course_id=s.programme_id and sc.campus_city=s.campus_id*/
            left join ic_registration ir on s.ic_code_consultant=ir.ic_code 
            left JOIN user_master AS um ON um.`um_id`=s.created_by 
            left JOIN consultants_call_details AS ccd ON ccd.employee_code=um.`employee_code`         
            WHERE s.academic_year='" . $var['academic_year'] . "'  $whe1 and s.remark='Consultant Upload' and s.remuneration_status='V' and s.remuneration !=0 and s.remuneration!=''";
        $sql .= " ORDER BY  s.id DESC";

        $query = $this->db->query($sql);

        $result1 = $query->result_array();


        //return $result;
        //}
        //else{

        if (isset(
            $var['academic_year']
        )) {
            $acd =  substr($var['academic_year'], 0, 4);
        } else {
            $current_year = $this->config->item('current_year');
            $current_year = explode('-', $current_year);
            $acd = $current_year[0];
        }
        $DB1 = $this->load->database('umsdb', TRUE);
        $cond = "";
        if ($role_id == '1') {
        } else {
            $cond = " and enquiry_student_master.created_by='" . $id . "'";
        }


        $sql = "select ccd.contact_person,'Nashik' as Campusdata,vw_stream_details.stream_name as course,vw_stream_details.school_short_name as school_code,enquiry_student_master.created_on,
enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
as remuneration,enquiry_student_master.Campus_City,
enquiry_student_master.Campus,enquiry_student_master.provisional_no as enrollment_no,enquiry_student_master.status as rstatus,msm.enrollment_no as prn,
enquiry_student_master.remark as remark from  enquiry_student_master join
student_master as msm on enquiry_student_master.enquiry_id=msm.enquiry_id 
join vw_stream_details on msm.admission_stream=vw_stream_details.stream_id
 JOIN " . currentdb . ".user_master AS um ON um.um_id=enquiry_student_master.created_by 
 JOIN " . currentdb . ".consultants_call_details AS ccd ON ccd.employee_code=um.employee_code AND  ccd.status= um.status and ccd.status='Y'  
where enquiry_student_master.admission_session='$acd' $stf
and enquiry_student_master.is_from_consultant=1  $cond
UNION
select ccd.contact_person,'Sijoul' as Campusdata,vw_stream_details.stream_name as course,vw_stream_details.school_short_name as school_code,enquiry_student_master.created_on,
enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
as remuneration,enquiry_student_master.Campus_City,
enquiry_student_master.Campus,enquiry_student_master.provisional_no as enrollment_no,enquiry_student_master.status as rstatus,msm.enrollment_no as prn,
enquiry_student_master.remark as remark from  enquiry_student_master join
sandipun_ums_sijoul.
student_master as msm on enquiry_student_master.stude_id=msm.stud_id 
join vw_stream_details on msm.admission_stream=vw_stream_details.stream_id
 JOIN " . currentdb . ".user_master AS um ON um.um_id=enquiry_student_master.created_by 
 JOIN " . currentdb . ".consultants_call_details AS ccd ON ccd.employee_code=um.employee_code AND  ccd.status= um.status and ccd.status='Y'  
where enquiry_student_master.admission_session='$acd' $stf
and enquiry_student_master.is_from_consultant=1  $cond 
";







        $sql = " Select * from ( $sql ) t ORDER BY  t.id DESC";

        $query = $DB1->query($sql);

        $result = $query->result();

        $array = array();
        if (!empty($result)) {

            foreach ($result as $row) {
                $row->event_code = 'Consultant';
                $row->student_name = $row->first_name . " " . $row->middle_name . " " . $row->last_name;
                $row->remuneration_status = $row->rstatus;
                $row->remuneration_remark = $row->remark;
                //$row->school_code='';
                //$row->course='';
                $row->state_name = '';
                $row->city_name = '';
                $row->Country = 'India';
                /*if($row->Campus_City==1 && $row->Campus=="SUN" ){
				$school_id=$row->school_id;
				$course_id=$row->course_id;
				 $get_course_details="SELECT sandipun_ums.vw_stream_details.* from sandipun_ums.vw_stream_details where sandipun_ums.vw_stream_details.school_id=".$school_id." and sandipun_ums.vw_stream_details.course_id=".$course_id;
				
				$query = $this->db->query($get_course_details);
				$get_course_detailsresult = $query->row();
				 if(!empty($get_course_detailsresult)){
					$row->school_code=$get_course_detailsresult->school_short_name;
					$row->course=$get_course_detailsresult->course_name;
			         
				}
			}
			else if($row->Campus_City==2 && $row->Campus=="SIJOUL" ){
				$school_id=$row->school_id;
				$course_id=$row->course_id;
				 $get_course_details="SELECT sandipun_ums_sijoul.vw_stream_details.* from sandipun_ums_sijoul.vw_stream_details where sandipun_ums_sijoul.vw_stream_details.school_id=".$school_id." and sandipun_ums_sijoul.vw_stream_details.course_id=".$course_id;
				
				$query = $this->db->query($get_course_details);
				$get_course_detailsresult = $query->row();
				 if(!empty($get_course_detailsresult)){
					$row->school_code=$get_course_detailsresult->school_short_name;
					$row->course=$get_course_detailsresult->course_name;
			         
				}
			}
			else{
				$course_id=$row->course_id;
				$Campus_City=$row->Campus_City;
				$get_course_details="select * from school_course sc where sc.course_id=$course_id and sc.campus_city=$Campus_City";
				$query = $this->db->query($get_course_details);
				$get_course_detailsresult = $query->row();
		        if(!empty($get_course_detailsresult)){
					$row->school_code=$get_course_detailsresult->school_code;
					$row->course=$get_course_detailsresult->course;
			         
				}
                
				
				
			}*/
                if ($row->nationality == 1) {

                    $get_add_details = "select states.state_name,taluka_master.taluka_name as city_name from enquiry_student_master join  states 
on enquiry_student_master.state_id=states.state_id join  taluka_master
on  enquiry_student_master.city_id=taluka_master.taluka_id where enquiry_student_master.enquiry_id=" . $row->id;
                    $get_add_details = $DB1->query($get_add_details);
                    $get_add_details = $get_add_details->row();
                    if (!empty($get_add_details)) {
                        $row->state_name = $get_add_details->state_name;
                        $row->city_name = $get_add_details->city_name;
                        $row->Country = 'India';
                    }
                } else if ($row->nationality == 2) {

                    $get_add_details = "select  " . currentdb . ".countries.name as country_name,  " . currentdb . ".states.name as state_name, " . currentdb . ".cities.name as city_name from sandipun_ums.enquiry_student_master join  states 
on sandipun_ums.enquiry_student_master.int_state= " . currentdb . ".states.id join   " . currentdb . ".cities
on  sandipun_ums.enquiry_student_master.int_city= " . currentdb . ".cities.id join   " . currentdb . ".countries
on  sandipun_ums.enquiry_student_master.int_country_id= " . currentdb . ".countries.id where sandipun_ums.enquiry_student_master.enquiry_id=" . $row->id;
                    $get_add_details = $this->db->query($get_add_details);
                    $get_add_details = $get_add_details->row();
                    if (!empty($get_add_details)) {
                        $row->state_name = $get_add_details->state_name;
                        $row->city_name = $get_add_details->city_name;
                        $row->Country = $get_add_details->country_name;
                    }
                }





                $array[] = $row;
            }
        }
        //echo "<pre>";
        $array = json_decode(json_encode($array), TRUE);
        return (array_merge($array, $result1));

        //print_r($array);
        //print_r($result1);
        //exit;
        //exit;
        //return $array;
        //}
        //

    }


    function fetch_student_meetdetails_consultant_new_for_consultant1($var, $start = 0, $limit, $id = "", $year = "")
    {

        $userID = $this->session->userdata('uid');
        $ic_code = $this->session->userdata('ic_code');
        $role_id = $this->session->userdata('role_id');
        $uid = $this->session->userdata("uid");



        //if($id !=''){
        //$var['academic_year'] ='2019-20';
        //}
        if ($year == "") {
            $var['academic_year'] = $this->config->item('current_year');
        } else {
            $var['academic_year'] = base64_decode($year);
        }


        //  if($var['academic_year'] =='2019-20'){
        $whe1 = '';
        if ($role_id == 1) {
        } else if ($role_id == 7) {
            $ic_code = $this->session->userdata('ic_code');
            $whe1 = "  um.ic_code  ='$ic_code'";
        } else {
            $whe1 = "  s.created_by  in (" . $id . ")";
        }


        $sql = "SELECT s.id,s.event_code,s.organization ,s.created_by,s.ic_code_consultant,s.student_name,s.mobile1,s.whatsappno,s.email,s.state_name,s.city_name,ir.ic_name,vs.school_code,vs.course_short_name as course,s.remuneration ,s.remuneration_status,s.remuneration_remark,ccd.contact_person,ir.ic_name,ccd.pancard,s.campus_id FROM student_meet_details s 
			left join student_mapping as sm  on s.id=sm.smd_id
			
			join sandipun_ums_sijoul.student_master as stdm on stdm.stud_id=sm.ums_id
			join sandipun_ums_sijoul.vw_stream_details as vs on vs.stream_id=stdm.admission_stream
           /* left join school_course sc on sc.course_id=s.programme_id and sc.campus_city=s.campus_id*/
            left join ic_registration ir on s.ic_code_consultant=ir.ic_code 
            left JOIN user_master AS um ON um.`um_id`=s.created_by 
            left JOIN consultants_call_details AS ccd ON ccd.employee_code=um.`employee_code`         
            WHERE /*s.academic_year='" . $var['academic_year'] . "'*/ $whe1 and s.remark='Consultant Upload' ";
        $sql .= " ORDER BY  s.id DESC";
        //echo $sql;
        //exit;
        $query = $this->db->query($sql);

        $result1 = $query->result_array();


        //return $result;
        //}
        //else{
        $var['academic_year'] = base64_decode($year);
        if (isset(
            $var['academic_year']
        )) {
            $acd =  substr($var['academic_year'], 0, 4);
        } else {
            $y = $acd1 = $this->config->item('current_year');
            $current_year = explode('-', $acd1);
            $acd = $current_year[0];
        }
        $DB1 = $this->load->database('umsdb', TRUE);
        if ($role_id != '1') {
        }

        $ci = '';
        if ($role_id == 1) {
        } else if (($role_id == '7') && $uid != 429) {

            $ci = " and  um.ic_code  ='$ic_code'";
        } else if (($role_id == '7') && $uid == 429) {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";

            $ci = " and  (um.ic_code  ='$ic_code' or um.ic_code='SU_BR_003') ";
        } else {
            $ci = "  and enquiry_student_master.created_by='" . $id . "'  ";
        }
        $sql = "select ccd.contact_person,
enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
as remuneration,enquiry_student_master.Campus_City,
enquiry_student_master.Campus,enquiry_student_master.provisional_no as enrollment_no,enquiry_student_master.status as rstatus,
enquiry_student_master.remark as remark from  enquiry_student_master 
 JOIN " . currentdb . ".user_master AS um ON um.um_id=enquiry_student_master.created_by 
 JOIN " . currentdb . ".consultants_call_details AS ccd ON ccd.employee_code=um.employee_code AND  ccd.status= um.status and ccd.status='Y'  
where enquiry_student_master.admission_session='$acd'
and enquiry_student_master.is_from_consultant=1 $ci
";


        $sql = " Select * from ( $sql ) t ORDER BY  t.id DESC";

        $query = $DB1->query($sql);

        $result = $query->result();

        $array = array();
        if (!empty($result)) {

            foreach ($result as $row) {
                $row->event_code = 'Consultant';
                $row->student_name = $row->first_name . " " . $row->middle_name . " " . $row->last_name;
                $row->remuneration_status = $row->rstatus;
                $row->remuneration_remark = $row->remark;
                $row->school_code = '';
                $row->course = '';
                $row->state_name = '';
                $row->city_name = '';
                $row->Country = 'India';
                if ($row->Campus_City == 1 && $row->Campus == "SUN") {
                    $school_id = $row->school_id;
                    $course_id = $row->course_id;
                    $get_course_details = "SELECT sandipun_ums.vw_stream_details.* from sandipun_ums.vw_stream_details where sandipun_ums.vw_stream_details.school_id=" . $school_id . " and sandipun_ums.vw_stream_details.course_id=" . $course_id;

                    $query = $this->db->query($get_course_details);
                    $get_course_detailsresult = $query->row();
                    if (!empty($get_course_detailsresult)) {
                        $row->school_code = $get_course_detailsresult->school_short_name;
                        $row->course = $get_course_detailsresult->course_name;
                    }
                }
                if ($row->Campus_City == 2 && $row->Campus == "SIJOUL") {
                    $school_id = $row->school_id;
                    $course_id = $row->course_id;
                    $get_course_details = "SELECT sandipun_ums_sijoul.vw_stream_details.* from sandipun_ums_sijoul.vw_stream_details where sandipun_ums_sijoul.vw_stream_details.school_id=" . $school_id . " and sandipun_ums_sijoul.vw_stream_details.course_id=" . $course_id;

                    $query = $this->db->query($get_course_details);
                    $get_course_detailsresult = $query->row();
                    if (!empty($get_course_detailsresult)) {
                        $row->school_code = $get_course_detailsresult->school_short_name;
                        $row->course = $get_course_detailsresult->course_name;
                    }
                } else {
                    $course_id = $row->course_id;
                    $Campus_City = $row->Campus_City;
                    $get_course_details = "select * from school_course sc where sc.course_id=$course_id and sc.campus_city=$Campus_City";
                    $query = $this->db->query($get_course_details);
                    $get_course_detailsresult = $query->row();
                    if (!empty($get_course_detailsresult)) {
                        $row->school_code = $get_course_detailsresult->school_code;
                        $row->course = $get_course_detailsresult->course;
                    }
                }
                if ($row->nationality == 1) {

                    $get_add_details = "select states.state_name,taluka_master.taluka_name as city_name from enquiry_student_master join  states 
on enquiry_student_master.state_id=states.state_id join  taluka_master
on  enquiry_student_master.city_id=taluka_master.taluka_id where enquiry_student_master.enquiry_id=" . $row->id;
                    $get_add_details = $DB1->query($get_add_details);
                    $get_add_details = $get_add_details->row();
                    if (!empty($get_add_details)) {
                        $row->state_name = $get_add_details->state_name;
                        $row->city_name = $get_add_details->city_name;
                        $row->Country = 'India';
                    }
                } else if ($row->nationality == 2) {

                    $get_add_details = "select  " . currentdb . ".countries.name as country_name,  " . currentdb . ".states.name as state_name, " . currentdb . ".cities.name as city_name from sandipun_ums.enquiry_student_master join  states 
on sandipun_ums.enquiry_student_master.int_state= " . currentdb . ".states.id join   " . currentdb . ".cities
on  sandipun_ums.enquiry_student_master.int_city= " . currentdb . ".cities.id join   " . currentdb . ".countries
on  sandipun_ums.enquiry_student_master.int_country_id= " . currentdb . ".countries.id where sandipun_ums.enquiry_student_master.enquiry_id=" . $row->id;
                    $get_add_details = $this->db->query($get_add_details);
                    $get_add_details = $get_add_details->row();
                    if (!empty($get_add_details)) {
                        $row->state_name = $get_add_details->state_name;
                        $row->city_name = $get_add_details->city_name;
                        $row->Country = $get_add_details->country_name;
                    }
                }





                $array[] = $row;
            }
        }
        //echo "<pre>";
        $array = json_decode(json_encode($array), TRUE);
        return (array_merge($array, $result1));

        //print_r($array);
        //print_r($result1);
        //exit;
        //exit;
        //return $array;
        //}
        //

    }


    public function get_all_consultants_fou_list_for_recent_year_whose_payment_is_received($data)
    {
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        if (!empty($data['coid']) && $data['coid'] != '' && $data['coid'] != undefined) {
            $wco = ' and c.country_id = "' . $data['coid'] . '"';
        }
        if (!empty($data['sid']) && $data['sid'] != '' && $data['sid'] != undefined) {
            $ws = ' and c.state_id = "' . $data['sid'] . '"';
        }
        if (!empty($data['cid']) && $data['cid'] != '' && $data['cid'] != undefined) {
            $wc = ' and c.city_id = "' . $data['cid'] . '"';
        }
        if (!empty($data['rid']) && $data['rid'] != '' && $data['rid'] != undefined) {
            $rd = ' and um.roles_id = "' . $data['rid'] . '"';
        }
        if (!empty($data['rfid']) && $data['rfid'] != '' && $data['rfid'] != undefined) {

            $rfd1 = ' and c.co_reff_by = "' . $data['rfid'] . '"';
        }

        if (!empty($data['consultant']) && $data['consultant'] != '' && $data['consultant'] != undefined) {

            $rfd11 = ' and um.um_id = "' . $data['consultant'] . '"';
        }
        if (!empty($data['academic_year']) && $data['academic_year'] != '' && $role_id == '30') {
            $rfd = ' and c.academic_year = "' . $data['academic_year'] . '"';
        }
        /*elseif($cid !=''){
	 $rfd = ' and c.academic_year = "2019-20"';
}
else{
	 $rfd = ' and c.academic_year = "2020-21"';
}*/
        if ($role_id == '1' || $role_id == '30') {

            $wh = "and (c.counselor_type='FOU' or c.counselor_type='CL')";

            if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != 'undefined') {
                $wh1 = " and c.ic_code='" . $data['icfilter'] . "'";
            }
        } else if (($role_id == '8') || ($role_id == '7') && $uid != 429) {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if (($role_id == '8') || ($role_id == '7') && $uid == 429) {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and (c.ic_code='" . $this->session->userdata('ic_code') . "' or c.ic_code='SU_BR_003')";
        } else if ($role_id == 16) {
            $wh = " and ( c.consultant_head='" . $this->session->userdata('uid') . "' or c.inserted_by='" . $this->session->userdata('uid') . "')  ";
        } else if ($role_id == 17) {
            $wh = " and um.um_id = " . $this->session->userdata('uid');
        } else {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "'";
        }
        $cii = '';

        if ($cid != '' && $cid != null) {

            $cii = " and um.um_id = $cid ";
        }


        $fd = '';
        $td = '';
        if (!empty($data['from_date']) && $data['from_date'] != '' && $data['from_date'] != undefined) {

            $fd = ' and STR_TO_DATE(fc.TransactionDate,"%Y-%m-%d") >= "' . $data['from_date'] . '"';
        }
        if (!empty($data['to_date']) && $data['to_date'] != '' && $data['to_date'] != undefined) {

            $td = ' and STR_TO_DATE(fc.TransactionDate,"%Y-%m-%d") <= "' . $data['to_date'] . '"';
        }
        //
        $sql = "select c.*,um.roles_id,rm.roles_name,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id from
consultants_call_details as c 
inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
join sandipun_ums.student_master as msm on sm.enquiry_id=msm.enquiry_id 
inner join roles_master as rm ON rm.roles_id=um.roles_id
left join states as s on c.state_id = s.id
left join cities as ci ON ci.id=c.city_id
where c.status='Y' and  c.counselor_type != 'NULL'   $wco $ws $wc $rd  $rfd1 $wh $wh1 $rfd11 $cii  
group by c.id order by c.contact_person";

        $query  = $this->db->query($sql);


        $result = $query->result_array();
        $sql = "select c.*,um.roles_id,rm.roles_name,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id from
consultants_call_details as c 
inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
join sandipun_ums.student_master as msm on sm.enquiry_id=msm.enquiry_id 
join sandipun_ums_sijoul.fees_challan as fc on msm.stud_id=fc.student_id and (fc.type_id=2)
inner join roles_master as rm ON rm.roles_id=um.roles_id
left join states as s on c.state_id = s.id
left join cities as ci ON ci.id=c.city_id
where c.status='Y' and  c.counselor_type != 'NULL'   $wco $ws $wc $rd $rfd $rfd1 $wh $wh1 $rfd11 $cii $fd   $td
group by c.id order by c.contact_person";


        $sql = str_replace("sandipun_ums.student_master", "sandipun_ums_sijoul.student_master", $sql);
        $sql = str_replace("sm.enquiry_id", "sm.stude_id", $sql);
        $sql = str_replace("msm.stude_id", "msm.stud_id", $sql);

        $query  = $this->db->query($sql);

        $result1 = $query->result_array();
        $result = array_merge($result, $result1);
        return $result;
    }

    function get_count_of_admission_done_yet_for_current_year_date_wise($um_id)
    {

        return $this->db->query("select sum(count) as tc from(
select count(sandipun_ums.enquiry_student_master.enquiry_id) as count from sandipun_ums.enquiry_student_master 
join sandipun_ums.
student_master as msm on enquiry_student_master.enquiry_id=msm.enquiry_id 
where sandipun_ums.enquiry_student_master.created_by='$um_id' and sandipun_ums.enquiry_student_master.is_from_consultant='1' 
UNION
select count(sandipun_ums.enquiry_student_master.enquiry_id) as count from sandipun_ums.enquiry_student_master 
join sandipun_ums_sijoul.
student_master as msm on enquiry_student_master.stude_id=msm.stud_id 
join sandipun_ums_sijoul.fees_challan as fc on msm.stud_id=fc.student_id and (fc.type_id=2)
where sandipun_ums.enquiry_student_master.created_by='$um_id' and sandipun_ums.enquiry_student_master.is_from_consultant='1' 
UNION ALL
select count(" . currentdb . ".student_meet_details.id) as count from " . currentdb . ".student_meet_details 
where " . currentdb . ".student_meet_details.created_by='$um_id' and " . currentdb . ".student_meet_details.remark='Consultant Upload' and " . currentdb . ".student_meet_details.remuneration_status='V' and " . currentdb . ".student_meet_details.remuneration !=0 and " . currentdb . ".student_meet_details.remuneration!='' 


) t")->row()->tc;
    }

    function get_renumeration_amount_for_current_year_date_wise($um_id)
    {


        return $this->db->query("select sum(renumeration) as renumeration_amout from(

select sum(sandipun_ums.enquiry_student_master.renumeration_amount) as renumeration from sandipun_ums.enquiry_student_master 
join sandipun_ums.
student_master as msm on enquiry_student_master.enquiry_id=msm.enquiry_id 
where sandipun_ums.enquiry_student_master.created_by='$um_id'  and sandipun_ums.enquiry_student_master.is_from_consultant='1' 
UNION
select sum(sandipun_ums.enquiry_student_master.renumeration_amount) as renumeration from sandipun_ums.enquiry_student_master 
join sandipun_ums_sijoul.
student_master as msm on enquiry_student_master.stude_id=msm.stud_id 
join sandipun_ums_sijoul.fees_challan as fc on msm.stud_id=fc.student_id and (fc.type_id=2)
where sandipun_ums.enquiry_student_master.created_by='$um_id' and sandipun_ums.enquiry_student_master.is_from_consultant='1' 
UNION ALL
select sum(" . currentdb . ".student_meet_details.remuneration) as renumeration from " . currentdb . ".student_meet_details 
where " . currentdb . ".student_meet_details.created_by='$um_id' and " . currentdb . ".student_meet_details.remark='Consultant Upload' and " . currentdb . ".student_meet_details.remuneration_status='V' and remuneration !=0 and " . currentdb . ".student_meet_details.remuneration!='' 
) t")->row()->renumeration_amout;
    }




    function get_consultant_list_for_dropdown($is_for_fou = '', $year = '')
    {
        $yrc = '';
        if (!empty($year)) {
            $yrc = " and a.academic_year='$year'";
        }

        $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata("role_id");
        $ic_code = $this->session->userdata('ic_code');
        $fou_c = ' and (consultants_call_details.is_fou IS NULL OR consultants_call_details.is_fou=0) ';
        if (!empty($is_for_fou)) {
            $fou_c = ' and (consultants_call_details.is_fou=1  or consultants_call_details.is_fou=2 )';
        }
        if ($role_id == 7) {
            $query = $this->db->query("select (select cmc.contact_person from  sandipun_ic_erp22.consultants_call_details as cmc where cmc.id=consultants_call_details.id 
	and cmc.mobile_no=consultants_call_details.mobile_no
) as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id
left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id

 where user_master.ic_code='$ic_code' $fou_c $yrc
 group by user_master.um_id order by consultants_call_details.contact_person asc ");
        } else {
            $wh = "";
            if ($role_id == 27) {
                $this->db->simple_query("SET GLOBAL group_concat_max_len = 1000000;");
                $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=$c_by and status='Y'")->row()->ic_code;
                $referred_by = $this->db->query("select group_concat(cordinator_id) as cordinator_id
         from consultant_cordinator_mapping where consultant_id=$c_by and status='Y'")->row()->cordinator_id;

                $ss = explode(",", $ss);
                $ss = "'" . implode("', '", $ss) . "'";
                $wh =  " 1=1 and (consultants_call_details.ic_code IN ($ss) OR consultants_call_details.inserted_by='" . $this->session->userdata('uid') . "' OR consultants_call_details.inserted_by IN ($referred_by)  OR consultants_call_details.co_reff_by IN ($referred_by) OR  consultants_call_details.consultant_head= '" . $this->session->userdata('uid') . "') ";

                $query = $this->db->query("select 
		states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,consultants_call_details.* from consultants_call_details join user_master on 
		consultants_call_details.id=user_master.con_id 
		left join states on  consultants_call_details.state_id=states.id
        left join cities on  consultants_call_details.city_id=cities.id
		
		where   $wh $fou_c $yrc
		group by user_master.um_id order by
        coalesce((select count(id) from admission_benefits_and_source where benefit_to =user_master.um_id),0) desc");
            } elseif ($role_id == 1 || $role_id == 30) {
                $con = '';
                if ($role_id == 30) {

                    if ($c_by == 1681 || $c_by == 4823) {
                    } else {
                        $con = ' and is_verified=1';
                    }
                }
                //consultants_call_details.consultant_head='$c_by' and 
                $query = $this->db->query("select (select cmc.contact_person from  sandipun_ic_erp22.consultants_call_details as cmc where cmc.id=consultants_call_details.id and cmc.mobile_no=consultants_call_details.mobile_no) as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id 

left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
where 1=1 $con $fou_c $yrc
 group by user_master.um_id order by consultants_call_details.contact_person asc");
            } elseif ($role_id == 35) {

                if ($c_by == 2105) {
                    $query = $this->db->query("select (select cmc.contact_person from  sandipun_ic_erp22.consultants_call_details as cmc where cmc.id=consultants_call_details.id and cmc.mobile_no=consultants_call_details.mobile_no) as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id

left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
where (consultants_call_details.inserted_by=$c_by or consultants_call_details.co_reff_by=$c_by or consultants_call_details.inserted_by=3379 or consultants_call_details.inserted_by=4004 ) $fou_c $yrc
 group by user_master.um_id order by consultants_call_details.contact_person asc");
                } else {
                    $query = $this->db->query("select (select cmc.contact_person from  sandipun_ic_erp22.consultants_call_details as cmc where cmc.id=consultants_call_details.id and cmc.mobile_no=consultants_call_details.mobile_no) as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id 

left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
where (consultants_call_details.inserted_by=$c_by or consultants_call_details.co_reff_by=$c_by) $fou_c $yrc
 group by user_master.um_id order by consultants_call_details.contact_person asc");
                }
            } else {




                $query = $this->db->query("select (select cmc.contact_person from  sandipun_ic_erp22.consultants_call_details as cmc where cmc.id=consultants_call_details.id and cmc.mobile_no=consultants_call_details.mobile_no) as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id 

left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
where  consultants_call_details.inserted_by=$c_by  $fou_c  $yrc group by user_master.um_id order by consultants_call_details.contact_person asc");
            }
        }



        $result = $query->result_array();

        return $result;
    }



    function get_consultant_list($is_for_fou = '', $year = '')
    {
        $yrc = '';
        if (!empty($year)) {
            $yrc = " and a.academic_year='$year'";
        }

        $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata("role_id");
        $ic_code = $this->session->userdata('ic_code');
        $fou_c = '  ';
        if (!empty($is_for_fou)) {
            $fou_c = ' and (consultants_call_details.is_fou=1 or consultants_call_details.is_fou=2) ';
        }
        if ($role_id == 7) {
            $query = $this->db->query("select consultants_call_details.contact_person as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,CONCAT(iur.fname,' ',iur.lname) as ch,
CASE
    WHEN CONCAT(iu.fname,' ',iu.lname) !='' THEN CONCAT(iu.fname,' ',iu.lname)
    WHEN cr.contact_person!='' THEN cr.contact_person
    
    ELSE '---'
END as cordinator,ir.ic_name,consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id
left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
join user_master as umo on consultants_call_details.inserted_by=umo.um_id
left join ic_user_master as iu on umo.employee_code=iu.employee_code
left join consultants_call_details as cr on umo.con_id=cr.id
join ic_registration as ir on user_master.ic_code=ir.ic_code
left join ic_users as iur on consultants_call_details.consultant_head=iur.um_id
join admission_benefits_and_source as a on user_master.um_id=a.benefit_to and a.belong_to_ic=4 $yrc
 where user_master.ic_code='$ic_code' $fou_c $yrc
 group by user_master.um_id order by consultants_call_details.contact_person asc ");
        } else {
            $wh = "";
            if ($role_id == 27) {
                $this->db->simple_query("SET GLOBAL group_concat_max_len = 1000000;");
                $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=$c_by and status='Y'")->row()->ic_code;
                $referred_by = $this->db->query("select group_concat(cordinator_id) as cordinator_id
         from consultant_cordinator_mapping where consultant_id=$c_by and status='Y'")->row()->cordinator_id;

                $ss = explode(",", $ss);
                $ss = "'" . implode("', '", $ss) . "'";
                $cr = "";
                if (!empty($referred_by)) {
                    $cr = "OR consultants_call_details.inserted_by IN ($referred_by)  OR consultants_call_details.co_reff_by IN ($referred_by)";
                }

                $wh =  " 1=1 and (consultants_call_details.ic_code IN ($ss) OR consultants_call_details.inserted_by='" . $this->session->userdata('uid') . "' $cr OR  consultants_call_details.consultant_head= '" . $this->session->userdata('uid') . "') ";




                $query = $this->db->query("select 
		states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,CONCAT(iur.fname,' ',iur.lname) as ch,
CASE
    WHEN CONCAT(iu.fname,' ',iu.lname) !='' THEN CONCAT(iu.fname,' ',iu.lname)
    WHEN cr.contact_person!='' THEN cr.contact_person
    
    ELSE '---'
END as cordinator,ir.ic_name,consultants_call_details.* from consultants_call_details join user_master on 
		consultants_call_details.id=user_master.con_id 
		left join states on  consultants_call_details.state_id=states.id
        left join cities on  consultants_call_details.city_id=cities.id
		join user_master as umo on consultants_call_details.inserted_by=umo.um_id
left join ic_user_master as iu on umo.employee_code=iu.employee_code
left join consultants_call_details as cr on umo.con_id=cr.id
join ic_registration as ir on user_master.ic_code=ir.ic_code
left join ic_users as iur on consultants_call_details.consultant_head=iur.um_id
		join admission_benefits_and_source as a on user_master.um_id=a.benefit_to and a.belong_to_ic=4 $yrc
		where   $wh $fou_c $yrc
		group by user_master.um_id order by
        coalesce((select count(id) from admission_benefits_and_source where benefit_to =user_master.um_id),0) desc");
            } elseif ($role_id == 1 || $role_id == 30) {
                $con = '';
                if ($role_id == 30) {

                    if ($c_by == 1681 || $c_by = 4823) {
                    } else {
                        $con = ' and is_verified=1';
                    }
                }
                //consultants_call_details.consultant_head='$c_by' and 


                $query = $this->db->query("select consultants_call_details.contact_person as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,CONCAT(iur.fname,' ',iur.lname) as ch,
CASE
    WHEN CONCAT(iu.fname,' ',iu.lname) !='' THEN CONCAT(iu.fname,' ',iu.lname)
    WHEN cr.contact_person!='' THEN cr.contact_person
    
    ELSE '---'
END as cordinator,ir.ic_name,consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id 
left join admission_benefits_and_source as a on user_master.um_id=a.benefit_to and a.belong_to_ic=4 $yrc
left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
join user_master as umo on consultants_call_details.inserted_by=umo.um_id
left join ic_user_master as iu on umo.employee_code=iu.employee_code
left join consultants_call_details as cr on umo.con_id=cr.id
join ic_registration as ir on user_master.ic_code=ir.ic_code
left join ic_users as iur on consultants_call_details.consultant_head=iur.um_id
where 1=1 $con $fou_c $yrc
 group by user_master.um_id order by consultants_call_details.contact_person asc");
            } elseif ($role_id == 35) {

                if ($c_by == 2105) {
                    $query = $this->db->query("select consultants_call_details.contact_person as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,CONCAT(iur.fname,' ',iur.lname) as ch,
CASE
    WHEN CONCAT(iu.fname,' ',iu.lname) !='' THEN CONCAT(iu.fname,' ',iu.lname)
    WHEN cr.contact_person!='' THEN cr.contact_person
    
    ELSE '---'
END as cordinator,ir.ic_name,consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id
join admission_benefits_and_source as a on user_master.um_id=a.benefit_to and a.belong_to_ic=4  $yrc
left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
join user_master as umo on consultants_call_details.inserted_by=umo.um_id
left join ic_user_master as iu on umo.employee_code=iu.employee_code
left join consultants_call_details as cr on umo.con_id=cr.id
join ic_registration as ir on user_master.ic_code=ir.ic_code
left join ic_users as iur on consultants_call_details.consultant_head=iur.um_id
where (consultants_call_details.inserted_by=$c_by or consultants_call_details.co_reff_by=$c_by or consultants_call_details.inserted_by=3379 or consultants_call_details.inserted_by=4004 or consultants_call_details.inserted_by IN (select um_id from consultants_call_details cr join user_master ur on cr.id=ur.con_id where cr.inserted_by=$c_by or cr.co_reff_by=$c_by  )) $fou_c $yrc
 group by user_master.um_id order by consultants_call_details.contact_person asc");
                } else {
                    $query = $this->db->query("select consultants_call_details.contact_person as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,CONCAT(iur.fname,' ',iur.lname) as ch,
CASE
    WHEN CONCAT(iu.fname,' ',iu.lname) !='' THEN CONCAT(iu.fname,' ',iu.lname)
    WHEN cr.contact_person!='' THEN cr.contact_person
    
    ELSE '---'
END as cordinator,ir.ic_name,consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id 
join admission_benefits_and_source as a on user_master.um_id=a.benefit_to and a.belong_to_ic=4 $yrc
left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
join user_master as umo on consultants_call_details.inserted_by=umo.um_id
left join ic_user_master as iu on umo.employee_code=iu.employee_code
left join consultants_call_details as cr on umo.con_id=cr.id
join ic_registration as ir on user_master.ic_code=ir.ic_code
left join ic_users as iur on consultants_call_details.consultant_head=iur.um_id
where (consultants_call_details.inserted_by=$c_by or consultants_call_details.co_reff_by=$c_by or consultants_call_details.inserted_by IN (select um_id from consultants_call_details cr join user_master ur on cr.id=ur.con_id where cr.inserted_by=$c_by or cr.co_reff_by=$c_by )) $fou_c $yrc
 group by user_master.um_id order by consultants_call_details.contact_person asc");
                }
            } else {




                $query = $this->db->query("(select consultants_call_details.contact_person as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,CONCAT(iur.fname,' ',iur.lname) as ch,
CASE
    WHEN CONCAT(iu.fname,' ',iu.lname) !='' THEN CONCAT(iu.fname,' ',iu.lname)
    WHEN cr.contact_person!='' THEN cr.contact_person
    
    ELSE '---'
END as cordinator,ir.ic_name,consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id 
left join admission_benefits_and_source as a on user_master.um_id=a.benefit_to and a.belong_to_ic=4 $yrc
left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
join user_master as umo on consultants_call_details.inserted_by=umo.um_id
left join ic_user_master as iu on umo.employee_code=iu.employee_code
left join consultants_call_details as cr on umo.con_id=cr.id
join ic_registration as ir on user_master.ic_code=ir.ic_code
left join ic_users as iur on consultants_call_details.consultant_head=iur.um_id
where  consultants_call_details.inserted_by=$c_by  $fou_c  $yrc group by user_master.um_id order by consultants_call_details.contact_person asc)
UNION
((select consultants_call_details.contact_person as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,CONCAT(iur.fname,' ',iur.lname) as ch,
CASE
    WHEN CONCAT(iu.fname,' ',iu.lname) !='' THEN CONCAT(iu.fname,' ',iu.lname)
    WHEN cr.contact_person!='' THEN cr.contact_person
    
    ELSE '---'
END as cordinator,ir.ic_name,consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id 
left join admission_benefits_and_source as a on user_master.um_id=a.benefit_to and a.belong_to_ic=4 $yrc
left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
join user_master as umo on consultants_call_details.inserted_by=umo.um_id
left join ic_user_master as iu on umo.employee_code=iu.employee_code
left join consultants_call_details as cr on umo.con_id=cr.id
join ic_registration as ir on user_master.ic_code=ir.ic_code
left join ic_users as iur on consultants_call_details.consultant_head=iur.um_id
where  consultants_call_details.inserted_by IN (select um_id from consultants_call_details c join user_master u on c.id=u.con_id where c.inserted_by=$c_by or c.co_reff_by=$c_by )


  $fou_c  $yrc group by user_master.um_id order by consultants_call_details.contact_person asc))

");
            }
        }


        //echo $this->db->last_query();exit;
        $result = $query->result_array();

        return $result;
    }


    function get_consultant_list_prime($is_only_cordinator = '')
    {

        $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata("role_id");
        $ic_code = $this->session->userdata('ic_code');
        $wh = "";
        if ($role_id == 7) {
            $wh = " and c.ic_code='$ic_code'";
        } elseif ($role_id == 1 || $role_id == 30) {
        } elseif ($role_id == 35) {
            $wh = " and (c.inserted_by ='$c_by'  or c.co_reff_by='$c_by')";
        } elseif ($role_id == 27) {
            $wh = " and (c.consultant_head='$c_by')";
        }

        if (!empty($is_only_cordinator)) {
            $wh .= " and c.is_cordinator='1'";
        }



        $sql = "select contact_person,c.employee_code,um_id from consultants_call_details c
			join user_master as u on c.id=u.con_id where 1=1 $wh group by u.um_id";
        $query = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }

    function get_consultant_list_all($is_for_fou = '', $is_active_for_year = '')
    {



        $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata("role_id");
        $ic_code = $this->session->userdata('ic_code');
        $fou_c = '  ';
        $accc = '  ';
        if (!empty($is_for_fou)) {
            $fou_c = ' and consultants_call_details.is_fou=1 ';
        }
        if (!empty($is_active_for_year)) {
            $accc = ' and user_master.active_for_current_year="Y" ';
        }

        if ($role_id == 7) {
            $query = $this->db->query("select consultants_call_details.contact_person as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,
CONCAT(iur.fname,' ',iur.lname) as ch,
CASE
    WHEN CONCAT(iu.fname,' ',iu.lname) !='' THEN CONCAT(iu.fname,' ',iu.lname)
    WHEN cr.contact_person!='' THEN cr.contact_person
    
    ELSE '---'
END as cordinator,ir.ic_name,
consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id
left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
join user_master as umo on consultants_call_details.inserted_by=umo.um_id
left join ic_user_master as iu on umo.employee_code=iu.employee_code
left join consultants_call_details as cr on umo.con_id=cr.id
join ic_registration as ir on user_master.ic_code=ir.ic_code
left join ic_users as iur on consultants_call_details.consultant_head=iur.um_id
 where user_master.ic_code='$ic_code' $fou_c $accc
 group by user_master.um_id order by consultants_call_details.contact_person asc ");
        } else {
            $wh = "";
            if ($role_id == 27) {
                $this->db->simple_query("SET GLOBAL group_concat_max_len = 1000000;");
                $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=$c_by and status='Y'")->row()->ic_code;
                $referred_by = $this->db->query("select group_concat(cordinator_id) as cordinator_id
         from consultant_cordinator_mapping where consultant_id=$c_by and status='Y'")->row()->cordinator_id;

                $ss = explode(",", $ss);
                $ss = "'" . implode("', '", $ss) . "'";


                $cr = "";
                if (!empty($referred_by)) {
                    $cr = "OR consultants_call_details.inserted_by IN ($referred_by)  OR consultants_call_details.co_reff_by IN ($referred_by)";
                }
                $wh =  " 1=1 and (consultants_call_details.ic_code IN ($ss) OR consultants_call_details.inserted_by='" . $this->session->userdata('uid') . "' $cr  OR  consultants_call_details.consultant_head= '" . $this->session->userdata('uid') . "') ";

                $query = $this->db->query("select consultants_call_details.contact_person as oldconsultant_name,
		states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,
		CASE
    WHEN CONCAT(iu.fname,' ',iu.lname) !='' THEN CONCAT(iu.fname,' ',iu.lname)
    WHEN cr.contact_person!='' THEN cr.contact_person
    
    ELSE '---'
END as cordinator,ir.ic_name,
		CONCAT(iur.fname,' ',iur.lname) as ch,
		consultants_call_details.* from consultants_call_details join user_master on 
		consultants_call_details.id=user_master.con_id 
		left join states on  consultants_call_details.state_id=states.id
		left join cities on  consultants_call_details.city_id=cities.id
		join user_master as umo on consultants_call_details.inserted_by=umo.um_id
		left join ic_user_master as iu on umo.employee_code=iu.employee_code
		left join consultants_call_details as cr on umo.con_id=cr.id
		join ic_registration as ir on user_master.ic_code=ir.ic_code
		left join ic_users as iur on consultants_call_details.consultant_head=iur.um_id
		where   $wh $fou_c $accc
		group by user_master.um_id ");
            } elseif ($role_id == 1 || $role_id == 30) {
                $con = '';
                if ($role_id == 30) {

                    if ($c_by == 1681) {
                    } else {
                        $con = ' and is_verified=1';
                    }
                }
                //consultants_call_details.consultant_head='$c_by' and 
                $query = $this->db->query("select consultants_call_details.contact_person as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,
	CASE
    WHEN CONCAT(iu.fname,' ',iu.lname) !='' THEN CONCAT(iu.fname,' ',iu.lname)
    WHEN cr.contact_person!='' THEN cr.contact_person
    
    ELSE '---'
END as cordinator,ir.ic_name,
	CONCAT(iur.fname,' ',iur.lname) as ch,
	consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id 

left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
join user_master as umo on consultants_call_details.inserted_by=umo.um_id
left join ic_users as iur on consultants_call_details.consultant_head=iur.um_id
		left join ic_user_master as iu on umo.employee_code=iu.employee_code
		left join consultants_call_details as cr on umo.con_id=cr.id
		join ic_registration as ir on user_master.ic_code=ir.ic_code
where 1=1 $con $fou_c $accc
 group by user_master.um_id order by consultants_call_details.contact_person asc");
            } elseif ($role_id == 35) {

                if ($c_by == 2105) {
                    $query = $this->db->query("select consultants_call_details.contact_person as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,CASE
    WHEN CONCAT(iu.fname,' ',iu.lname) !='' THEN CONCAT(iu.fname,' ',iu.lname)
    WHEN cr.contact_person!='' THEN cr.contact_person
    
    ELSE '---'
END as cordinator,ir.ic_name,
CONCAT(iur.fname,' ',iur.lname) as ch,consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id

left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
join user_master as umo on consultants_call_details.inserted_by=umo.um_id
join ic_registration as ir on user_master.ic_code=ir.ic_code
		left join ic_user_master as iu on umo.employee_code=iu.employee_code
		left join consultants_call_details as cr on umo.con_id=cr.id
		left join ic_users as iur on consultants_call_details.consultant_head=iur.um_id
where (consultants_call_details.inserted_by=$c_by or consultants_call_details.co_reff_by=$c_by or consultants_call_details.inserted_by IN (select um_id from consultants_call_details cr join user_master ur on cr.id=ur.con_id where cr.inserted_by=$c_by or cr.co_reff_by=$c_by ) 


) $fou_c $accc
 group by user_master.um_id order by consultants_call_details.contact_person asc");
                } else {

                    $query = $this->db->query("select consultants_call_details.contact_person as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,CASE
    WHEN CONCAT(iu.fname,' ',iu.lname) !='' THEN CONCAT(iu.fname,' ',iu.lname)
    WHEN cr.contact_person!='' THEN cr.contact_person
    
    ELSE '---'
END as cordinator,CONCAT(iur.fname,' ',iur.lname) as ch,ir.ic_name,consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id 

left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
join user_master as umo on consultants_call_details.inserted_by=umo.um_id
join ic_registration as ir on user_master.ic_code=ir.ic_code
		left join ic_user_master as iu on umo.employee_code=iu.employee_code
		left join consultants_call_details as cr on umo.con_id=cr.id
		left join ic_users as iur on consultants_call_details.consultant_head=iur.um_id
where (consultants_call_details.inserted_by=$c_by or consultants_call_details.co_reff_by=$c_by) $fou_c $accc
 group by user_master.um_id order by consultants_call_details.contact_person asc");
                }
            } else {

                $mc = " consultants_call_details.inserted_by=$c_by ";
                if ($role_id == 17) {
                    $get_consultant_is_cordinator = $this->db->query("select is_cordinator from consultants_call_details as cd
		join user_master as um on cd.id=um.con_id where um.um_id=$c_by")->row();
                    if (!empty($get_consultant_is_cordinator)) {
                        if ($get_consultant_is_cordinator->is_cordinator == 1) {
                            $mc = " (consultants_call_details.inserted_by=$c_by or consultants_call_details.inserted_by IN (select um_id from consultants_call_details as cm
				join user_master as umo on cm.id=umo.con_id where cm.inserted_by=$c_by)) ";
                        }
                    }
                }



                $query = $this->db->query("select consultants_call_details.contact_person as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,CONCAT(iur.fname,' ',iur.lname) as ch,user_master.um_id,user_master.employee_code,CASE
    WHEN CONCAT(iu.fname,' ',iu.lname) !='' THEN CONCAT(iu.fname,' ',iu.lname)
    WHEN cr.contact_person!='' THEN cr.contact_person
    
    ELSE '---'
END as cordinator,ir.ic_name,consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id 

left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
join user_master as umo on consultants_call_details.inserted_by=umo.um_id
left join ic_registration as ir on user_master.ic_code=ir.ic_code
left join ic_users as iur on consultants_call_details.consultant_head=iur.um_id
		left join ic_user_master as iu on umo.employee_code=iu.employee_code
		left join consultants_call_details as cr on umo.con_id=cr.id
where  $mc  $fou_c $accc group by user_master.um_id order by consultants_call_details.contact_person asc");
            }
        }



        $result = $query->result_array();

        return $result;
    }



    function get_pendingconsultant_list($is_for_fou = '')
    {



        $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata("role_id");
        $ic_code = $this->session->userdata('ic_code');
        $fou_c = '  ';


        if (!empty($is_for_fou)) {
            $fou_c .= ' and (is_fou IS NULL or is_fou=1 or is_fou=0) ';
        }


        if ($role_id == 7) {
            $query = $this->db->query("select (select cmc.contact_person from  sandipun_ic_erp22.consultants_call_details as cmc where cmc.id=consultants_call_details.id 
	and cmc.mobile_no=consultants_call_details.mobile_no
) as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id
left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
join admission_benefits_and_source as a on user_master.um_id=a.benefit_to and a.belong_to_ic=4
 where user_master.ic_code='$ic_code' $fou_c and consultants_call_details.is_verified !=1
 group by user_master.um_id order by consultants_call_details.contact_person asc ");
        } else {
            $wh = "";
            if ($role_id == 27) {
                $this->db->simple_query("SET GLOBAL group_concat_max_len = 1000000;");
                $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=$c_by and status='Y'")->row()->ic_code;
                $referred_by = $this->db->query("select group_concat(cordinator_id) as cordinator_id
         from consultant_cordinator_mapping where consultant_id=$c_by and status='Y'")->row()->cordinator_id;

                $ss = explode(",", $ss);
                $ss = "'" . implode("', '", $ss) . "'";
                $wh =  " 1=1 and (consultants_call_details.ic_code IN ($ss) OR consultants_call_details.inserted_by='" . $this->session->userdata('uid') . "' OR consultants_call_details.inserted_by IN ($referred_by)  OR consultants_call_details.co_reff_by IN ($referred_by) OR  consultants_call_details.consultant_head= '" . $this->session->userdata('uid') . "') ";

                $query = $this->db->query("select 
		states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,consultants_call_details.* from consultants_call_details join user_master on 
		consultants_call_details.id=user_master.con_id 
		left join states on  consultants_call_details.state_id=states.id
        left join cities on  consultants_call_details.city_id=cities.id
		join admission_benefits_and_source as a on user_master.um_id=a.benefit_to and a.belong_to_ic=4
		where   $wh $fou_c  and (consultants_call_details.is_verified  IS NULL OR  consultants_call_details.is_verified  =0)
		group by user_master.um_id order by
        coalesce((select count(id) from admission_benefits_and_source where benefit_to =user_master.um_id),0) desc");
            } elseif ($role_id == 1 || $role_id == 30) {
                $con = '';
                if ($role_id == 30) {

                    if ($c_by == 1681) {
                    } else {
                        $con = ' and is_verified=1';
                    }
                }
                //consultants_call_details.consultant_head='$c_by' and 
                $query = $this->db->query("select (select cmc.contact_person from  sandipun_ic_erp22.consultants_call_details as cmc where cmc.id=consultants_call_details.id and cmc.mobile_no=consultants_call_details.mobile_no) as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id 
join admission_benefits_and_source as a on user_master.um_id=a.benefit_to and a.belong_to_ic=4
left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
where 1=1 $con $fou_c  and consultants_call_details.is_verified !=1
 group by user_master.um_id order by consultants_call_details.contact_person asc");
            } elseif ($role_id == 35) {

                if ($c_by == 2105) {
                    $query = $this->db->query("select (select cmc.contact_person from  sandipun_ic_erp22.consultants_call_details as cmc where cmc.id=consultants_call_details.id and cmc.mobile_no=consultants_call_details.mobile_no) as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id
join admission_benefits_and_source as a on user_master.um_id=a.benefit_to and a.belong_to_ic=4 
left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
where (consultants_call_details.inserted_by=$c_by or consultants_call_details.co_reff_by=$c_by or consultants_call_details.inserted_by=3379 or consultants_call_details.inserted_by=4004 ) $fou_c  and consultants_call_details.is_verified !=1
 group by user_master.um_id order by consultants_call_details.contact_person asc");
                } else {
                    $query = $this->db->query("select (select cmc.contact_person from  sandipun_ic_erp22.consultants_call_details as cmc where cmc.id=consultants_call_details.id and cmc.mobile_no=consultants_call_details.mobile_no) as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id 
join admission_benefits_and_source as a on user_master.um_id=a.benefit_to and a.belong_to_ic=4
left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
where (consultants_call_details.inserted_by=$c_by or consultants_call_details.co_reff_by=$c_by) $fou_c  and consultants_call_details.is_verified !=1
 group by user_master.um_id order by consultants_call_details.contact_person asc");
                }
            } else {




                $query = $this->db->query("select (select cmc.contact_person from  sandipun_ic_erp22.consultants_call_details as cmc where cmc.id=consultants_call_details.id and cmc.mobile_no=consultants_call_details.mobile_no) as oldconsultant_name,states.name as state_name,cities.name as city_name, consultants_call_details.contact_person,user_master.um_id,user_master.employee_code,consultants_call_details.* from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id 
join admission_benefits_and_source as a on user_master.um_id=a.benefit_to and a.belong_to_ic=4
left join states on  consultants_call_details.state_id=states.id
left join cities on  consultants_call_details.city_id=cities.id
where  consultants_call_details.inserted_by=$c_by  $fou_c  and consultants_call_details.is_verified !=1 group by user_master.um_id order by consultants_call_details.contact_person asc");
            }
        }


        //echo $this->db->last_query();exit;
        $result = $query->result_array();

        return $result;
    }











    function get_consultant_head()
    {

        $sql = "SELECT CONCAT(ium.fname,' ',ium.lname) AS ic_name,um.um_id FROM user_master um JOIN ic_user_master ium ON um.employee_code=ium.employee_code 
    WHERE um.roles_id =27 ";
        $query  = $this->db->query($sql);

        $result1 = $query->result_array();
        return $result1;
    }

    function chek_duplicate_entry($consultant_head, $ic_head)
    {
        $this->db->select('*');
        $this->db->from('ic_mapping');
        $this->db->where('consultant_head', $consultant_head);
        $this->db->where('ic_id', $ic_head);
        $query = $this->db->get();
        $result = $query->result_array();
        ///echo $this->db->last_query();//exit;
        return $result;
    }

    function insert_mapping($row)
    {
        $ic_code =  $this->db->query("select ic_code from ic_registration where ic_id= " . $row['ic_id'])->row();
        if (!empty($ic_code)) {
            $ic_code = $ic_code->ic_code;
        } else {
            $ic_code = '';
        }
        $data['consultant_head'] = $row['consultant_head'];
        $data['ic_id'] = $row['ic_id'];
        $data['ic_code'] = $ic_code;
        $data['created_time'] = date('Y-m-d H:i:s');
        $data['created_by'] = $this->session->userdata('uid');
        $this->db->insert('ic_mapping', $data);
        $insert_id = $this->db->insert_id();
        return $insert_id;
    }

    function mapping_details($d = array())
    {
        $row = $d;
        $cond = '';
        if (isset($row['consultant']) && $row['consultant'] != 'null' && !empty($row['consultant'])) {
            $cond = " where ic_mapping.consultant_head='" . $row['consultant'] . "'";
        }

        return $query = $this->db->query("select *,ic_mapping.status as csstatus from ic_mapping join user_master on ic_mapping.consultant_head=user_master.um_id  join ic_user_master on ic_user_master.employee_code=user_master.employee_code  join ic_registration on ic_registration.ic_code=ic_mapping.ic_code   $cond ")->result_array();
    }

    function update_status($data)
    {
        $r['status'] = $data['status'];
        $this->db->where('id', $data['id']);
        $uid12 = $this->db->update('ic_mapping', $r);

        return $this->db->affected_rows();
    }


    function get_admission_controller_list()
    {
        $uid = $this->session->userdata("uid");
        $role_id = $this->session->userdata("role_id");
        $wh1 = '';
        if ($role_id == 1 || $role_id == 30) {
            $wh = "";
        } elseif ($role_id == 35) {
            $wh = " WHERE consultant_cordinator_mapping.cordinator_id =$uid ";
        } else {
            $wh = " WHERE consultant_cordinator_mapping.consultant_id =$uid ";
            $wh1 = " WHERE c.consultant_head =$uid ";
        }
        $sql = "SELECT CONCAT(ium.fname,' ',ium.lname) AS ic_name,um.um_id FROM
consultant_cordinator_mapping 
join user_master um 
on consultant_cordinator_mapping.cordinator_id=um.um_id
JOIN ic_user_master ium ON um.employee_code=ium.employee_code
	 $wh
UNION 
SELECT staff_name AS ic_name,um.um_id FROM
 consultant_cordinator_mapping join user_master um on 
consultant_cordinator_mapping.cordinator_id=um.um_id JOIN 
inhouse_staff_details ium ON um.staff_id=ium.id
$wh and consultant_cordinator_mapping.status='Y'

UNION
SELECT contact_person AS ic_name,um.um_id FROM
consultants_call_details as c 
join user_master um 
on c.id=um.con_id

	 $wh1 and c.is_cordinator=1


    ";

        //echo $sql;
        //exit;
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        //echo $this->db->last_query();exit;
        return $result;
    }



    function get_consultant_list_data($academic_year)
    {

        $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata("role_id");
        $ic_code = $this->session->userdata('ic_code');
        if ($role_id == 7) {
            $query = $this->db->query("select consultants_call_details.contact_person,user_master.employee_code,user_master.um_id from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id where user_master.ic_code='$ic_code' and consultants_call_details.status='Y'
 group by user_master.um_id order by consultants_call_details.contact_person asc  ");
        } else {
            $wh = "";
            if ($role_id == 27) {
                $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=$c_by and status='Y'")->row()->ic_code;
                $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
         from consultant_cordinator_mapping where consultant_id=$c_by and status='Y'")->row()->cordinator_id;

                $ss = explode(",", $ss);
                $ss = "'" . implode("', '", $ss) . "'";
                $wh =  " and (consultants_call_details.ic_code IN ($ss) OR consultants_call_details.inserted_by='" . $this->session->userdata('uid') . "' OR consultants_call_details.inserted_by IN ($referred_by) ) ";
                $query = $this->db->query("select consultants_call_details.contact_person,user_master.employee_code,user_master.um_id from consultants_call_details join user_master on 
		consultants_call_details.id=user_master.con_id where  consultants_call_details.status='Y' $wh
		group by user_master.um_id order by consultants_call_details.contact_person asc  ");
            } elseif ($role_id == 1) {

                //consultants_call_details.consultant_head='$c_by' and 
                $query = $this->db->query("select consultants_call_details.contact_person,user_master.employee_code,user_master.um_id from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id where consultants_call_details.status='Y'
 group by user_master.um_id order by consultants_call_details.contact_person asc  ");
            } elseif ($role_id == 30) {
                $query = $this->db->query("select consultants_call_details.contact_person,user_master.employee_code,user_master.um_id from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id where consultants_call_details.status='Y'
 group by user_master.um_id order by consultants_call_details.contact_person asc  ");
            } else {
                $query = $this->db->query("select consultants_call_details.contact_person,user_master.employee_code,user_master.um_id from consultants_call_details join user_master on 
consultants_call_details.id=user_master.con_id where consultants_call_details.status='Y' and consultants_call_details.inserted_by=$c_by  group by user_master.um_id order by consultants_call_details.contact_person asc  ");
            }
        }



        $result = $query->result_array();

        return $result;
    }


    public function get_all_consultants_fou_list_for_recent_year_data($year = "")
    {
        $y = $acd1 = $year;
        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';


        if (!empty($data['coid']) && $data['coid'] != '' && $data['coid'] != undefined) {
            $wco = ' and c.country_id = "' . $data['coid'] . '"';
        }
        if (!empty($data['sid']) && $data['sid'] != '' && $data['sid'] != undefined) {
            $ws = ' and c.state_id = "' . $data['sid'] . '"';
        }
        if (!empty($data['cid']) && $data['cid'] != '' && $data['cid'] != undefined) {
            $wc = ' and c.city_id = "' . $data['cid'] . '"';
        }
        if (!empty($data['rid']) && $data['rid'] != '' && $data['rid'] != undefined) {
            $rd = ' and um.roles_id = "' . $data['rid'] . '"';
        }
        if (!empty($data['rfid']) && $data['rfid'] != '' && $data['rfid'] != undefined) {

            $rfd1 = ' and c.co_reff_by = "' . $data['rfid'] . '"';
        }

        if (!empty($data['consultant']) && $data['consultant'] != '' && $data['consultant'] != undefined) {

            $rfd11 = ' and um.um_id = "' . $data['consultant'] . '"';
        }
        if (!empty($data['academic_year']) && $data['academic_year'] != '' && $role_id == '30') {
            $rfd = ' and c.academic_year = "' . $data['academic_year'] . '"';
        }
        /*elseif($cid !=''){
	 $rfd = ' and c.academic_year = "2019-20"';
}
else{
	 $rfd = ' and c.academic_year = "2020-21"';
}*/
        if ($role_id == '1' || $role_id == '30') {

            $wh = "and (c.counselor_type='FOU' or c.counselor_type='CL')";

            if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != 'undefined') {
                $wh1 = " and c.ic_code='" . $data['icfilter'] . "'";
            }
        } else if (($role_id == '8')  && $uid != 429) {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if (($role_id == '8')  && $uid == 429) {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and (c.ic_code='" . $this->session->userdata('ic_code') . "' or c.ic_code='SU_BR_003')";
        } else if ($role_id == 16 || $role_id == 7) {
            $wh = " and ( c.consultant_head='" . $this->session->userdata('uid') . "')  ";
        } else if ($role_id == 17) {
            $wh = " and um.um_id = " . $this->session->userdata('uid');
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;

            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
         from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by) )";
            if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != 'undefined') {
                $wh1 = " and c.ic_code='" . $data['icfilter'] . "'";
            }
        } else {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "'";
        }


        $cii = '';

        if ($cid != '' && $cid != null) {

            $cii = " and um.um_id = $cid ";
        }
        $ac_year = "";
        if ($year != '') {
            $ac_year = " and sandipun_ums.enquiry_student_master.admission_session='$acd'";
        }
        //
        $sql = "select c.*,um.roles_id,rm.roles_name,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id from
consultants_call_details as c 
inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
join sandipun_ums.student_master as msm on sm.enquiry_id=msm.enquiry_id 
inner join roles_master as rm ON rm.roles_id=um.roles_id
left join states as s on c.state_id = s.id
left join cities as ci ON ci.id=c.city_id
where c.status='Y' and  c.counselor_type != 'NULL'   $wco $ws $wc $rd $rfd $rfd1 $wh $wh1 $rfd11 $cii  $ac_year
group by c.id order by c.contact_person";

        $query  = $this->db->query($sql);


        $result = $query->result_array();


        $sql = str_replace("sandipun_ums.student_master", "sandipun_ums_sijoul.student_master", $sql);
        $sql = str_replace("sm.enquiry_id", "sm.stude_id", $sql);
        $sql = str_replace("msm.stude_id", "msm.stud_id", $sql);

        $query  = $this->db->query($sql);

        $result1 = $query->result_array();
        $result = array_merge($result, $result1);
        return $result;
    }



    public function get_all_consultants_fou_list_dropdown($data)
    {

        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';



        $c = "";
        if (!empty($data['academic_year']) && $data['academic_year'] != '') {
            $c = $data['academic_year'];
        }
        $c = explode('-', $c);
        $c = $c[0];
        $ci = ' and sm.admission_session="' . $c . '"';

        if ($role_id == '1' || $role_id == '30') {
            $wh = "and (c.counselor_type='FOU' or c.counselor_type='CL')";
        } else if (($role_id == '7')) {

            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
	from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
	from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;

            $wh = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by) OR c.consultant_head= '" . $this->session->userdata('uid') . "')";
        }

        if ($data['academic_year'] == '2019-20') {
            $sql = ("select consultants_call_details.contact_person,user_master.um_id from consultants_call_details join user_master on consultants_call_details.id=user_master.con_id
join student_meet_details on student_meet_details.created_by=user_master.um_id where student_meet_details.remark='Consultant Upload'
and student_meet_details.academic_year='2019-20'
 group by user_master.um_id order by consultants_call_details.contact_person asc ");
            $query  = $this->db->query($sql);
            $result = $query->result_array();

            return $result;
        } else {



            $sql = "select c.*,um.roles_id,rm.roles_name,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id from
consultants_call_details as c 
inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
join sandipun_ums.student_master as msm on sm.enquiry_id=msm.enquiry_id 
inner join roles_master as rm ON rm.roles_id=um.roles_id
left join states as s on c.state_id = s.id
left join cities as ci ON ci.id=c.city_id
where c.status='Y' and  c.counselor_type != 'NULL' $wh $ci
group by c.id order by c.contact_person";

            $query  = $this->db->query($sql);
            $result = $query->result_array();


            $sql = str_replace("sandipun_ums.student_master", "sandipun_ums_sijoul.student_master", $sql);
            $sql = str_replace("sm.enquiry_id", "sm.stude_id", $sql);
            $sql = str_replace("msm.stude_id", "msm.stud_id", $sql);

            $query  = $this->db->query($sql);
            $result1 = $query->result_array();
            $result = array_merge($result, $result1);
            return $result;
        }
    }


    public function get_all_referres_by_fou_list_dropdown($data)
    {

        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';



        $c = "";
        if (!empty($data['academic_year']) && $data['academic_year'] != '') {
            $c = $data['academic_year'];
        }
        $c = explode('-', $c);
        $c = $c[0];
        $ci = ' and sm.admission_session="' . $c . '"';

        if ($role_id == '1' || $role_id == '30') {
            $wh = "and (c.counselor_type='FOU' or c.counselor_type='CL')";
        } else if (($role_id == '7')) {

            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
	from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
	from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;

            $wh = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by) OR c.consultant_head= '" . $this->session->userdata('uid') . "')";
        }
        if ($data['academic_year'] == '2019-20') {
            $sql = ("SELECT CONCAT(ium.fname,' ',ium.lname) AS ic_name,um.um_id FROM user_master um JOIN ic_user_master ium ON um.employee_code=ium.employee_code join consultants_call_details on consultants_call_details.co_reff_by=user_master.um_id
		join student_meet_details on student_meet_details.created_by=user_master.um_id
		where student_meet_details.remark='Consultant Upload'
		and student_meet_details.academic_year='2019-20'
		group by user_master.um_id order by consultants_call_details.contact_person asc ");
            $query  = $this->db->query($sql);
            $result = $query->result_array();

            return $result;
        } else {
            $sql = "select c.*,um.roles_id,rm.roles_name,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id from
consultants_call_details as c 
inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
join sandipun_ums.student_master as msm on sm.enquiry_id=msm.enquiry_id 
inner join roles_master as rm ON rm.roles_id=um.roles_id
left join states as s on c.state_id = s.id
left join cities as ci ON ci.id=c.city_id
where c.status='Y' and  c.counselor_type != 'NULL' $wh $ci
group by c.co_reff_by order by c.contact_person";

            $query  = $this->db->query($sql);
            $result = $query->result_array();


            $sql = str_replace("sandipun_ums.student_master", "sandipun_ums_sijoul.student_master", $sql);
            $sql = str_replace("sm.enquiry_id", "sm.stude_id", $sql);
            $sql = str_replace("msm.stude_id", "msm.stud_id", $sql);
            $query  = $this->db->query($sql);
            $result1 = $query->result_array();
            $result = array_merge($result, $result1);
            return $result;
        }
    }

    function get_user_name($co_reff_by)
    {
        $sql = "SELECT CONCAT(ium.fname,' ',ium.lname) AS ic_name FROM user_master um JOIN ic_user_master ium ON um.employee_code=ium.employee_code 
    WHERE um.um_id = '" . $co_reff_by . "' ";
        $query  = $this->db->query($sql);
        $result1 = $query->result_array();

        return $result1;
    }

    public function get_expected_admissions($id, $academic_year)
    {
        $sql = "select * from expected_admission 
                             where  consultant_id = '" . $id . "' and academic_year='$academic_year' and status='Y'";
        $query  = $this->db->query($sql);
        $result = $query->row();
        //echo $this->db->last_query();exit;
        return $result;
    }




    function update_cons_call_center_details($data, $pic, $docic, $bank_name)
    {

        $role_id = $this->session->userdata("role_id");
        $carr['dob'] = $data['sdate'];
        $carr['gender'] = $data['gender'];
        $wano = $data['whatsapp_no'];
        if ($wano == 1) {
            $carr['whatsapp_no'] = $data['mob_no'];
        } else if ($wano == 2) {
            $carr['whatsapp_no'] = $data['official_no'];
        }
        $carr['prefered_loc'] = (stripcslashes($data['paddress']));
        if (!empty($pic)) {
            $carr['photo'] = $pic;
        }

        if (!empty($bank_name)) {
            $carr['scan_copy'] = $bank_name;
        }

        $carr['photo'] = $pic;
        $carr['scan_copy'] = $bank_name;
        //$carr['employee_code']= $data['employee_code'];
        $carr['bkname'] = $data['bkname'];
        $carr['acno'] = $data['acno'];
        $carr['acname'] = $data['acname'];
        $carr['ifsc'] = $data['ifsc'];
        $carr['branch'] = $data['branch'];
        $carr['co_reff_by'] = (stripcslashes($data['co_reff_by']));
        $carr['institute_name'] = (stripcslashes($data['institute_name']));
        $carr['contact_person'] = $data['contact_person'] . ' ' . $data['Middle_Name'] . ' ' . $data['Last_Name'];
        $carr['address'] = (stripcslashes($data['address']));
        $carr['isdno'] = (stripcslashes($data['isdno']));
        $carr['mobile_no'] = $data['mob_no'];
        $carr['adharcard'] = $data['Adharcard'];
        $carr['pancard'] = $data['Pancard'];

        $carr['preferablecampus'] = $data['preferablecampus'];
        $carr['official_no'] = $data['official_no'];
        $carr['country_id'] = $data['country_id'];
        $carr['state_id'] = $data['state'];
        $carr['city_id'] = $data['city'];
        $carr['email'] = (($data['email']));
        $carr['official_email'] = (($data['official_email']));
        $carr['website'] = (($data['website']));
        $carr['remark'] = (($data['remark'])); //(stripcslashes($data['remark']));
        $carr['updated_by'] = $this->session->userdata('uid');
        $carr['updated_date'] = date('Y-m-d H:i:s');
        $carr['passport'] = $data['passport'];
        $carr['organisation_type'] = $data['type'];
        $this->db->where('id', $data['cid']);
        $up = $this->db->update('consultants_call_details', $carr);
        $aff = $this->db->affected_rows();
        if (!empty($docic)) {
            $this->db->where('cid', $data['cid']);
            $this->db->delete('consultants_document_list');
            foreach ($docic as $key => $value) {

                $darr['cid'] = $data['cid'];
                $darr['document_name'] = $value['file_name'];
                $darr['inserted_by'] = $this->session->userdata('uid');
                $darr['inserted_date'] = date('Y-m-d h:i:s');
                $this->db->insert('consultants_document_list', $darr);
            }
        }

        if (!empty($data['preferrable_location'])) {
            $this->db->where('consultant_id', $data['cid']);
            $this->db->delete('consultant_preferrable_location');
            foreach ($data['preferrable_location'] as $row) {
                $city_array = $row['city'];
                foreach ($city_array as $row1) {
                    $arrs['consultant_id'] = $data['cid'];
                    $arrs['country'] = $row['country'];
                    $arrs['state'] =  $row['state'];
                    $arrs['city'] =  $row1;
                    $arrs['inserted_by'] = $this->session->userdata('uid');
                    $arrs['inserted_date'] = date('Y-m-d h:i:s');
                    $this->db->insert('consultant_preferrable_location', $arrs);
                }
            }
        }

        return $aff;
    }

    public function Checkaadhar($stateID, $id)
    {

        $this->db->select('count(id) as total');
        $this->db->from('consultants_call_details');
        $this->db->where('adharcard', $stateID);
        if ($id != '') {
            $this->db->where('id !=', $id);
        }
        //  $DB1->limit('1');
        $query = $this->db->get();

        $result = $query->result_array();
        return $result[0]['total'];
    }


    public function total_registered_consultant()
    {

        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        if ($role_id == '1') {
            $wh = " and (c.counselor_type='FOU' or c.counselor_type='CL')";
        } else if ($role_id == 7) {
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
			from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE(group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh =  " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by) OR c.consultant_head='" . $this->session->userdata('uid') . "' ) ";
        } else {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "'";
        }
        $cii = '';

        $sql = "select count(c.id) as counts  from
			consultants_call_details as c 
			inner join user_master as um ON um.con_id = c.id and c.status='Y'
			inner join roles_master as rm ON rm.roles_id=um.roles_id
			left join states as s on c.state_id = s.id
			left join cities as ci ON ci.id=c.city_id
			where c.status='Y' and  c.counselor_type != 'NULL'   $wh  ";
        //echo $sql;
        //exit;
        $query  = $this->db->query($sql);
        $result = $query->row()->counts;

        return $result;
    }


    public function total_registered_consultant_with_admissions($acd1)
    {

        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        if ($role_id == '1') {
            $wh = "and (c.counselor_type='FOU' or c.counselor_type='CL')";
        } else if ($role_id == '7') {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 17) {
            $wh = " and um.um_id = " . $this->session->userdata('uid');
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
		from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
		from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by) OR  c.consultant_head='" . $this->session->userdata('uid') . "' )";
        } else {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "'";
        }
        $cii = '';
        //
        $sql = "select (c.id) from
		consultants_call_details as c 
		inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
		join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
		join sandipun_ums.student_master as msm on sm.enquiry_id=msm.enquiry_id 
		inner join roles_master as rm ON rm.roles_id=um.roles_id
		left join states as s on c.state_id = s.id
		left join cities as ci ON ci.id=c.city_id
		where c.status='Y' and  c.counselor_type != 'NULL'   $wh and sm.admission_session='$acd'
		group by c.id order by c.contact_person";

        $query  = $this->db->query($sql);
        $result = $query->result_array();
        $sql = str_replace("sandipun_ums.student_master", "sandipun_ums_sijoul.student_master", $sql);
        $sql = str_replace("sm.enquiry_id", "sm.stude_id", $sql);
        $sql = str_replace("msm.stude_id", "msm.stud_id", $sql);
        //echo $sql;
        // exit;
        //exit;
        $query  = $this->db->query($sql);
        $result1 = $query->result_array();
        //$result = array_merge($result,$result1);
        $result = array_unique(array_merge($result, $result1), SORT_REGULAR);
        return sizeof($result);
    }


    /*public function total_confirmed_admissions($acd1){
		
		$current_year = explode('-', $acd1);
		$acd =$current_year[0];
		$role_id=$this->session->userdata("role_id");
		$uid=$this->session->userdata("uid");
		$rfd11='';
		$rfd1='';
		$rfd='';
		if($role_id =='1'  )
		{
		$wh="and (c.counselor_type='FOU' or c.counselor_type='CL')";
		}
		else if( $role_id =='7'){
		//  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
		$wh = " and c.ic_code='".$this->session->userdata('ic_code')."'";
		}
		else if($role_id ==17){
		$wh = " and um.um_id = ".$this->session->userdata('uid');
		}
		else if($role_id ==27){
		$ss=$this->db->query("select group_concat(ic_code) as ic_code
		from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
		$ss = explode(",", $ss);
		$ss = "'" . implode("', '", $ss) ."'";
		$referred_by=$this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
		from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
		$wh=" and (c.ic_code IN ($ss) OR c.inserted_by='".$this->session->userdata('uid')."' OR c.inserted_by IN ($referred_by) OR  c.consultant_head='".$this->session->userdata('uid')."' )";

		}
		else{
		$wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
		}
		$cii='';
		//
		$sql = "select sm.enquiry_id as enq from
		consultants_call_details as c 
		inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
		join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
		join sandipun_ums.student_master as msm on sm.enquiry_id=msm.enquiry_id 
		inner join roles_master as rm ON rm.roles_id=um.roles_id
		left join states as s on c.state_id = s.id
		left join cities as ci ON ci.id=c.city_id
		where c.status='Y' and  c.counselor_type != 'NULL'   $wh and sm.admission_session='$acd'
		group by enq";
		
		$query  = $this->db->query($sql);
		$result = $query->result_array();
		$sql =str_replace("sandipun_ums.student_master","sandipun_ums_sijoul.student_master",$sql);
		$sql =str_replace("sm.enquiry_id","sm.stude_id",$sql);
		$sql =str_replace("msm.stude_id","msm.stud_id",$sql);
		
		$query  = $this->db->query($sql);
		$result1 = $query->result_array();
		$result = array_merge($result,$result1); 
		return sizeof($result);
    }*/


    public function total_confirmed_admissions($acd1 = "", $check_for_p = "", $role = "", $cancelled_flag = '')
    {

        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        $wh1 = '';
        $wh = " where 1=1 ";
        if ($role_id == '1') {
        } else if ($role_id == '9') {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            //$wh = " and a.source IN ('website','facebook','google') ";
        } else if ($role_id == '7') {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh .= " and a.ic_code='" . $this->session->userdata('ic_code') . "' and a.belong_to_ic=4 ";
        } else if ($role_id == 17) {
            if ($uid == 3379 || $uid == 4004) {
                $wh .= " and (a.benefit_to = " . $this->session->userdata('uid') . " or a.benefit_to IN  (select um_id
				from sandipun_ic_erp22.consultants_call_details as c join sandipun_ic_erp22.user_master as um on c.id=um.con_id where c.inserted_by=$uid or c.co_reff_by=$uid)) ";
            } else {
                $wh .= " and a.benefit_to = " . $this->session->userdata('uid');
            }
        } else if ($role_id == 27) {

            $ss = $this->db->query("select group_concat(ic_code) as ic_code
		from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
		from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            if ($role == 4) {
                $wh1 = " OR (a.benefit_to IN (select umd.um_id from
			consultants_call_details as cd join user_master as umd on cd.id=umd.con_id
			join consultant_cordinator_mapping as cm on cd.inserted_by=cm.cordinator_id or cd.co_reff_by=cm.cordinator_id
			where cm.consultant_id=" . $this->session->userdata('uid') . "))
			OR a.benefit_to in (select umd.um_id from consultants_call_details as cd join user_master as umd on cd.id=umd.con_id
			where cd.inserted_by=" . $this->session->userdata('uid') . "
			or a.benefit_to in (select umd.um_id from consultants_call_details as cd join user_master as umd on cd.id=umd.con_id where cd.consultant_head=" . $this->session->userdata('uid') . "))";
            }
            $wh .= " and ((a.ic_code in($ss) and a.belong_to_ic=$role) $wh1 )";
        } elseif ($role_id == 35) {

            //$wh = " and a.benefit_to='".$this->session->userdata('uid')."'";
            if ($uid == 2105) {
                $wh .= " and a.benefit_to IN (select um_id from sandipun_ic_erp22.consultants_call_details c join sandipun_ic_erp22.user_master as u on c.id=u.con_id
		where c.inserted_by=$uid or c.co_reff_by=$uid or c.inserted_by=4004 or c.inserted_by=3379)";
            } else {
                $wh .= " and a.benefit_to IN (select um_id from sandipun_ic_erp22.consultants_call_details c join sandipun_ic_erp22.user_master as u on c.id=u.con_id
		where c.inserted_by=$uid or c.co_reff_by=$uid)";
            }
        } elseif ($role_id == 34) {

            if ($uid == '4032') {
                $wh .= " and a.is_affliate=1 and affliate_name='Shiksha'";
            } elseif ($uid == '3437') {
                $wh .= " and a.is_affliate=1 and affliate_name='College Dunia'";
            } elseif ($uid == '4929') {
                $wh .= " and a.is_affliate=1 and affliate_name='Getmyuni'";
            } else {
                $name = $_SESSION['name'];
                $wh .= " and a.is_affliate=1 and affliate_name='$name'";
            }
        } else {
            $wh .= " and ( a.benefit_to='" . $this->session->userdata('uid') . "' 

OR a.benefit_to IN (SELECT um_id FROM sandipun_ic_erp22.consultants_call_details AS c JOIN sandipun_ic_erp22.user_master AS 
um ON c.id=um.con_id WHERE c.inserted_by='" . $this->session->userdata('uid') . "' OR c.co_reff_by='" . $this->session->userdata('uid') . "'

		) ) 
		
		
		
		";
        }
        $con = '';
        if (!empty($check_for_p)) {
            $con = ' and admission_confirm="Y"';
        }

        $ccon = " and sm.cancelled_admission='N' ";
        if (!empty($cancelled_flag)) {
            $ccon = ' and cancelled_admission="Y"';
        }
        $cii = '';
        $sql = "select count(*) as total_count from
		((select sm.stud_id from admission_benefits_and_source a join sandipun_ums.student_master as sm on a.student_id=sm.stud_id  
          and sm.cancelled_admission !='' and sm.enrollment_no !='' and sm.admission_session='$acd'	$wh and a.is_for=1
          $ccon
		  $con 	group by a.student_id)
		UNION 
		(select sm.stud_id from admission_benefits_and_source a join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id
          and sm.cancelled_admission !='' and sm.enrollment_no !='' and sm.admission_session='$acd'	$wh and a.is_for=2
          $ccon
		  $con group by a.student_id)
		  UNION 
		(select sm.id as stud_id  from admission_benefits_and_source a join sf_admission_data as sm on a.student_id=sm.id
          and sm.is_cancelled !='1' and sm.enrollment_no !='' and sm.academic_year='$acd1'
		    
		  $wh and a.is_for=3 and sm.is_cancelled='N' group by a.student_id
		)) a	";



        $query  = $this->db->query($sql)->row()->total_count;
        return $query;
        //
        /*$sql = "select sm.enquiry_id as enq from
		consultants_call_details as c 
		inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
		join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
		join sandipun_ums.student_master as msm on sm.enquiry_id=msm.enquiry_id 
		inner join roles_master as rm ON rm.roles_id=um.roles_id
		left join states as s on c.state_id = s.id
		left join cities as ci ON ci.id=c.city_id
		where c.status='Y' and  c.counselor_type != 'NULL'   $wh and sm.admission_session='$acd'
		group by enq";
		
		$query  = $this->db->query($sql);
		$result = $query->result_array();
		$sql =str_replace("sandipun_ums.student_master","sandipun_ums_sijoul.student_master",$sql);
		$sql =str_replace("sm.enquiry_id","sm.stude_id",$sql);
		$sql =str_replace("msm.stude_id","msm.stud_id",$sql);
		
		$query  = $this->db->query($sql);
		$result1 = $query->result_array();
		$result = array_merge($result,$result1); 
		return sizeof($result);*/
    }

    public function total_confirmed_admissions_rvsd($acd1 = "", $check_for_p = "", $role = "", $cancelled_flag = '')
    {

        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");

        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        $wh1 = '';
        $wh = " where 1=1 ";
        if ($role_id == '1') {
        } else if ($role_id == '9') {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            //$wh = " and a.source IN ('website','facebook','google') ";
        } else if ($role_id == '7') {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh .= " and a.ic_code='" . $this->session->userdata('ic_code') . "' and a.belong_to_ic=4 ";
        } else if ($role_id == 17) {

            $wh .= " and (a.benefit_to = " . $this->session->userdata('uid') . " or a.benefit_to IN  (select um_id
				from sandipun_ic_erp22.consultants_call_details as c join sandipun_ic_erp22.user_master as um on c.id=um.con_id where c.inserted_by=$uid or c.co_reff_by=$uid)) ";
        } else if ($role_id == 27) {

            /*$ss=$this->db->query("select group_concat(ic_code) as ic_code
		from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
		$ss = explode(",", $ss);
		$ss = "'" . implode("', '", $ss) ."'";*/
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
		from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            if ($role == 4) {
                $wh1 = " 
			
			and a.benefit_to in (select umd.um_id from consultants_call_details as cd join user_master as umd on cd.id=umd.con_id where cd.consultant_head=" . $this->session->userdata('uid') . ") ";
                $wh .= " $wh1 ";
            }
            if ($role == 3 || $role == 1) {
                $wh1 = " 	and a.benefit_to in (select um_id from ic_users as um where ic_code IN (select ic_code from ic_mapping where consultant_head=$uid and status='Y') ) and belong_to_ic=$role";
                $wh .= " $wh1 ";
            }
        } elseif ($role_id == 35) {

            //$wh = " and a.benefit_to='".$this->session->userdata('uid')."'";
            if ($uid == 2105) {
                $wh .= " and a.benefit_to IN (select um_id from sandipun_ic_erp22.consultants_call_details c join sandipun_ic_erp22.user_master as u on c.id=u.con_id
		where c.inserted_by=$uid or c.co_reff_by=$uid or c.inserted_by=4004 or c.inserted_by=3379  or 
           c.inserted_by in (select um_id from sandipun_ic_erp22.consultants_call_details c join sandipun_ic_erp22.user_master as u on c.id=u.con_id
		where c.inserted_by=$uid or c.co_reff_by=$uid )

		)";
            } else {
                $wh .= " and a.benefit_to IN (select um_id from sandipun_ic_erp22.consultants_call_details c join sandipun_ic_erp22.user_master as u on c.id=u.con_id
		where c.inserted_by=$uid or c.co_reff_by=$uid)";
            }
        } elseif ($role_id == 34) {

            if ($uid == '4032') {
                $wh .= " and a.is_affliate=1 and affliate_name='Shiksha'";
            } elseif ($uid == '3437') {
                $wh .= " and a.is_affliate=1 and affliate_name='College Dunia'";
            } elseif ($uid == '4929') {
                $wh .= " and a.is_affliate=1 and affliate_name='Getmyuni'";
            } else {
                $name = $_SESSION['name'];
                $wh .= " and a.is_affliate=1 and affliate_name='$name'";
            }
        } else {
            $wh .= " and a.benefit_to='" . $this->session->userdata('uid') . "'";
        }
        $con = '';
        $con1 = ' and sm.admission_status="Provisional"';
        if (!empty($check_for_p)) {
            $con = ' and admission_confirm="Y"';
            $con1 = ' and sm.admission_status="Confirmed"';
        }

        $ccon = " and sm.cancelled_admission='N' ";
        $ccon1 = " and sm.is_cancelled IS NULL ";
        if (!empty($cancelled_flag)) {
            $ccon = ' and cancelled_admission="Y"';
            $ccon1 = " and sm.is_cancelled='1' ";
        }
        $cii = '';
        $sql = "select count(*) as count,type as type,id from
		((select sm.stud_id,'SUN' as type,1 as id from admission_benefits_and_source a join sandipun_ums.student_master as sm on a.student_id=sm.stud_id  
           $ccon and sm.enrollment_no !='' and sm.admission_session='$acd'	$wh and a.is_for=1
          $ccon
		  $con 	group by a.student_id)
		UNION 
		(select sm.stud_id,'SUM' as type,2 as id from admission_benefits_and_source a join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id
           $ccon and sm.enrollment_no !='' and sm.admission_session='$acd'	$wh and a.is_for=2
          $ccon
		  $con group by a.student_id)
		  UNION 
		(select sm.id as stud_id,'SF' as type,3 as id  from admission_benefits_and_source a join sf_admission_data as sm on a.student_id=sm.id
          and a.academic_year='$acd1' $con1 $ccon1
		    
		  $wh and a.is_for=3  group by a.student_id
		)) a group by type	";

        //

        $query  = $this->db->query($sql)->result();


        return $query;
        //
        /*$sql = "select sm.enquiry_id as enq from
		consultants_call_details as c 
		inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
		join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
		join sandipun_ums.student_master as msm on sm.enquiry_id=msm.enquiry_id 
		inner join roles_master as rm ON rm.roles_id=um.roles_id
		left join states as s on c.state_id = s.id
		left join cities as ci ON ci.id=c.city_id
		where c.status='Y' and  c.counselor_type != 'NULL'   $wh and sm.admission_session='$acd'
		group by enq";
		
		$query  = $this->db->query($sql);
		$result = $query->result_array();
		$sql =str_replace("sandipun_ums.student_master","sandipun_ums_sijoul.student_master",$sql);
		$sql =str_replace("sm.enquiry_id","sm.stude_id",$sql);
		$sql =str_replace("msm.stude_id","msm.stud_id",$sql);
		
		$query  = $this->db->query($sql);
		$result1 = $query->result_array();
		$result = array_merge($result,$result1); 
		return sizeof($result);*/
    }



    public function total_renumerations($acd1 = "")
    {
        //$y=$acd1='2020-21';
        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        if ($role_id == '1') {
            $wh = " ";
        } else if ($role_id == '7') {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and a.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 17) {
            $wh = " and  a.benefit_to = " . $this->session->userdata('uid');
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
		from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $wh = " and ((a.ic_code in($ss) and a.belong_to_ic=4) OR (a.benefit_to IN (select umd.um_id from
			consultants_call_details as cd join user_master as umd on cd.id=umd.con_id
			join consultant_cordinator_mapping as cm on cd.inserted_by=cm.cordinator_id or cd.co_reff_by=cm.cordinator_id
			where cm.consultant_id=" . $this->session->userdata('uid') . "))
			OR a.benefit_to in (select umd.um_id from consultants_call_details as cd join user_master as umd on cd.id=umd.con_id
			where cd.inserted_by=" . $this->session->userdata('uid') . "))";
        } else {
            $wh = " and a.benefit_to='" . $this->session->userdata('uid') . "'";
        }
        $cii = '';
        $sql = "select sum(amount) as remuneration from
		((select sm.stud_id,a.amount from admission_benefits_and_source a join sandipun_ums.student_master as sm on a.student_id=sm.stud_id
          and sm.cancelled_admission !='' and sm.enrollment_no !='' and sm.admission_session='$acd'	$wh and sm.admission_confirm='Y' and a.is_for=1	group by a.student_id)
		UNION 
		(select sm.stud_id,a.amount from admission_benefits_and_source a join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id
          and sm.cancelled_admission !='' and sm.enrollment_no !='' and sm.admission_session='$acd'	$wh and sm.admission_confirm='Y' and a.is_for=2 group by a.student_id)
		  UNION 
		(select sm.id as stud_id,a.amount  from admission_benefits_and_source a join sf_admission_data as sm on a.student_id=sm.id
          and sm.is_cancelled !='1' and sm.enrollment_no !='' and sm.academic_year='$acd1'	$wh  and a.is_for=3 group by a.student_id
		)) a	";
        $query  = $this->db->query($sql)->row()->remuneration;
        return $query;
    }


    public function total_registered_admissions($acd1 = "", $is_another_role = '')
    {

        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        $c = '';
        $j = '';
        if ($role_id == 33) {
            $j = 'left ';
        }

        $default_stat = " $j join consultants_call_details as c on um.con_id=c.id";
        if ($role_id == '1') {
            $wh = " ";
        } else if ($role_id == '7') {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 17) {
            $get_consultant_is_cordinator = $this->db->query("select is_cordinator from consultants_call_details as cd
		     join user_master as um on cd.id=um.con_id where um.um_id=$uid")->row();


            if (!empty($get_consultant_is_cordinator)) {
                if ($get_consultant_is_cordinator->is_cordinator == 1) {

                    $get_details_of_underconsultantsql = " SELECT um_id FROM consultants_call_details  csrm
JOIN user_master usrmss ON csrm.id=usrmss.con_id
 WHERE 
csrm.inserted_by IN (
				(SELECT um_id FROM consultants_call_details AS crm JOIN user_master AS urm 
				ON crm.id=urm.con_id WHERE ( crm.inserted_by=$uid OR crm.co_reff_by=$uid) AND is_cordinator=1) ) ";

                    $wh = " and (sm.created_by='" . $uid . "' or sm.created_by IN  (select um_id
				from " . $this->db->database . ".consultants_call_details as c join " . $this->db->database . ".user_master as um on c.id=um.con_id where c.inserted_by=$uid or c.co_reff_by=$uid) or sm.created_by IN ($get_details_of_underconsultantsql)  ) ";
                } else {
                    $wh = " and sm.created_by = " . $this->session->userdata('uid');
                }
                //$wh = " and (sm.created_by = ".$this->session->userdata('uid')." or sm.created_by IN  (select um_id
                //from sandipun_ic_erp22.consultants_call_details as c join sandipun_ic_erp22.user_master as um on c.id=um.con_id where c.inserted_by=$uid or c.co_reff_by=$uid)) " ;	



            } else {
                $wh = " and sm.created_by = " . $this->session->userdata('uid');
            }
        } else if ($role_id == 35) {
            if ($uid == 2105) {
                $wh = " and sm.created_by IN (select um_id from consultants_call_details c join user_master as u on c.id=u.con_id
		where c.inserted_by=$uid or c.co_reff_by=$uid or c.inserted_by=4004 or c.inserted_by=3379 ) ";
            } else {
                $default_stat = "";
                $wh = " and ((sm.created_by IN (select um_id from consultants_call_details c join user_master as u on c.id=u.con_id
		where c.inserted_by=$uid or c.co_reff_by=$uid)) or sm.created_by = $uid) ";
                $c = "left";
            }
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
		from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
		from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by) OR  c.consultant_head='" . $this->session->userdata('uid') . "' )";
        } else {

            $wh = " and (sm.created_by='" . $this->session->userdata('uid') . "'

or sm.created_by IN  (select um_id
				from " . $this->db->database . ".consultants_call_details as c  join " . $this->db->database . ".user_master as um on c.id=um.con_id where c.inserted_by=$uid or c.co_reff_by=$uid) )


		";
        }
        $cii = '';

        $default = ' and (is_from_consultant=1 or  is_from_consultant=2)	';

        /*if(!empty($is_another_role)){
		$default=' and is_from_consultant='.$is_another_role;
		if($is_another_role==2){
			$default_stat="
	        left join inhouse_staff_details as c on um.staff_id=c.id";
		}
	}*/
        $sql = "select count(enquiry_id) as count from  sandipun_ums.enquiry_student_master as sm 
	join user_master as um on sm.created_by=um.um_id $default_stat
where enquiry_id !=0 $default and sm.admission_session='$acd' $wh";
        if ($uid = 4004) {
        }

        #echo $sql;
        #exit;
        $result  = $this->db->query($sql)->row()->count;
        //$result = $query->result_array();


        return ($result);
    }


    public function total_received_renumerations($acd1 = "")
    {
        //$y=$acd1='2020-21';
        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        if ($role_id == '1') {
            $wh = " ";
        } else if ($role_id == '7') {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 17) {
            $wh = " and  um.um_id = " . $this->session->userdata('uid');
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
		from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $wh = " and ((c.ic_code in($ss)) OR (um.um_id IN (select umd.um_id from
			consultants_call_details as cd join user_master as umd on cd.id=umd.con_id
			join consultant_cordinator_mapping as cm on cd.inserted_by=cm.cordinator_id or cd.co_reff_by=cm.cordinator_id
			where cm.consultant_id=" . $this->session->userdata('uid') . "))
			OR um.um_id in (select umd.um_id from consultants_call_details as cd join user_master as umd on cd.id=umd.con_id
			where cd.inserted_by=" . $this->session->userdata('uid') . "))";
        } else {
            $wh = " and  um.um_id = " . $this->session->userdata('uid');
        }
        /*$sql = "select group_concat(um.um_id) as total_consultants from
		consultants_call_details as c 
		inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
		join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
		
		inner join roles_master as rm ON rm.roles_id=um.roles_id
		left join states as s on c.state_id = s.id
		left join cities as ci ON ci.id=c.city_id
		where c.status='Y' and  c.counselor_type != 'NULL'   $wh and sm.admission_session='$acd'
		";

		$query  = $this->db->query($sql)->row()->total_consultants;
		$ss = explode(",", $query);
		$consultant_id = "'" . implode("', '", $ss) ."'";
          
		$sql = "select sum(cp.amount) as renumeration_amount from consultant_payment_details as cp where consultant_id IN($consultant_id)
		";
		//echo $sql;
		$query  = $this->db->query($sql);
		$result = $query->row()->renumeration_amount;*/


        //$result = array_merge($result,$result1); 
        $sql = "select sum(cp.amount+cp.tds) as paid_renum from  consultant_payment_details as cp 
	           join user_master as um on cp.created_by=um.um_id
	           join consultants_call_details as c on um.con_id=c.id
               where cp.fees_id !=0 and cp.academic_year='$acd1' $wh";
        $query  = $this->db->query($sql);
        $result = $query->row()->paid_renum;
        return $result;
    }


    public function total_registered()
    {

        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        if ($role_id == '1') {
            $wh = " and (c.counselor_type='FOU' or c.counselor_type='CL')";
        } else if ($role_id == 7) {
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
			from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE(group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh =  " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by) OR c.consultant_head='" . $this->session->userdata('uid') . "' ) ";
        } else {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "'";
        }
        $cii = '';

        $sql = "select c.*,um.roles_id,rm.roles_name,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id  from
			consultants_call_details as c 
			inner join user_master as um ON um.con_id = c.id and c.status='Y'
			inner join roles_master as rm ON rm.roles_id=um.roles_id
			left join states as s on c.state_id = s.id
			left join cities as ci ON ci.id=c.city_id
			where c.status='Y' and  c.counselor_type != 'NULL'   $wh  ";

        $query  = $this->db->query($sql);
        $result = $query->result_array();

        return $result;
    }


    public function total_registered_with_admissions($acd1 = "")
    {
        // $y=$acd1='2020-21';
        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        if ($role_id == '1') {
            $wh = "and (c.counselor_type='FOU' or c.counselor_type='CL')";
        } else if ($role_id == '7') {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 17) {
            $wh = " and um.um_id = " . $this->session->userdata('uid');
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
		from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
		from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by) OR  c.consultant_head='" . $this->session->userdata('uid') . "' )";
        } else {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "'";
        }
        $cii = '';
        //
        $sql = "select c.*,um.roles_id,rm.roles_name,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id from
		consultants_call_details as c 
		inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
		join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
		join sandipun_ums.student_master as msm on sm.enquiry_id=msm.enquiry_id 
		inner join roles_master as rm ON rm.roles_id=um.roles_id
		left join states as s on c.state_id = s.id
		left join cities as ci ON ci.id=c.city_id
		where c.status='Y' and  c.counselor_type != 'NULL'   $wh and sm.admission_session='$acd'
		group by c.id order by c.contact_person";

        $query  = $this->db->query($sql);
        $result = $query->result_array();
        $sql = str_replace("sandipun_ums.student_master", "sandipun_ums_sijoul.student_master", $sql);
        $sql = str_replace("sm.enquiry_id", "sm.stude_id", $sql);
        $sql = str_replace("msm.stude_id", "msm.stud_id", $sql);

        $query  = $this->db->query($sql);
        $result1 = $query->result_array();

        $result = array_unique(array_merge($result, $result1), SORT_REGULAR);

        //$result = (array_merge($result,$result1)); 
        return ($result);
    }

    public function total_registered_students($acd1 = "", $consultant_id = '')
    {
        //$y=$acd1='2020-21';
        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        if ($role_id == 30) {
            if (!empty($consultant_id)) {
                $uid = $consultant_id;
            }
        }
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        if ($role_id == '1') {
            $wh = "and (c.counselor_type='FOU' or c.counselor_type='CL')";
        } else if ($role_id == '7') {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 17) {
            $wh = " and u.um_id = " . $uid;
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
		from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
		from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $uid . "' OR c.inserted_by IN ($referred_by) OR  c.consultant_head='" . $uid . "' )";
        } else {
            $wh = " and enquiry_student_master.created_by='" . $uid . "'";
        }
        $cii = '';
        //
        $sql = "select enquiry_student_master.admission_type,
		c.contact_person,enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
		enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
		enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
		as remuneration,enquiry_student_master.remark 
		as remark,enquiry_student_master.status 
		as status,enquiry_student_master.Campus_City,
		enquiry_student_master.Campus
		from  sandipun_ums.enquiry_student_master 
		join " . currentdb . ".user_master u on u.um_id=enquiry_student_master.created_by
		join " . currentdb . ".consultants_call_details c on  (u.employee_code = c.employee_code OR u.con_id=c.id ) AND c.status='Y' and c .status=u.status and c .status='Y'
		where enquiry_student_master.admission_session='$acd'
		and enquiry_student_master.is_from_consultant=1 $wh";
        //echo $sql;
        //exit;

        $DB1 = $this->load->database('umsdb', TRUE);
        $query = $DB1->query($sql);
        $result = $query->result();
        $array = array();
        if (!empty($result)) {
            foreach ($result as $row) {
                $row->event_code = 'Consultant';
                $row->student_name = $row->first_name . " " . $row->middle_name . " " . $row->last_name;
                $row->remuneration_status = $row->status;
                $row->remuneration_remark = $row->remark;
                $row->school_code = '';
                $row->course = '';
                $row->state_name = '';
                $row->city_name = '';
                $row->Country = 'India';

                if ($row->Campus_City == 1 && $row->Campus == "SUN") {
                    $school_id = $row->school_id;
                    $course_id = $row->course_id;
                    if ($school_id != '' && $course_id != '') {
                        $get_course_details = "SELECT sandipun_ums.vw_stream_details.* from sandipun_ums.vw_stream_details where sandipun_ums.vw_stream_details.school_id=" . $school_id . " and sandipun_ums.vw_stream_details.course_id=" . $course_id;

                        $query = $this->db->query($get_course_details);
                        $get_course_detailsresult = $query->row();
                        if (!empty($get_course_detailsresult)) {
                            $row->school_code = $get_course_detailsresult->school_short_name;
                            $row->course = $get_course_detailsresult->course_name;
                        }
                    }
                } else if ($row->Campus_City == 2 && $row->Campus == "SIJOUL") {
                    $school_id = $row->school_id;
                    $course_id = $row->course_id;
                    if ($school_id != '' && $course_id != '') {
                        $get_course_details = "SELECT sandipun_ums_sijoul.vw_stream_details.* from sandipun_ums_sijoul.vw_stream_details where sandipun_ums_sijoul.vw_stream_details.school_id=" . $school_id . " and sandipun_ums_sijoul.vw_stream_details.course_id=" . $course_id;

                        $query = $this->db->query($get_course_details);
                        $get_course_detailsresult = $query->row();
                        if (!empty($get_course_detailsresult)) {
                            $row->school_code = $get_course_detailsresult->school_short_name;
                            $row->course = $get_course_detailsresult->course_name;
                        }
                    }
                } else {
                    $course_id = $row->course_id;
                    $Campus_City = $row->Campus_City;
                    if ($course_id != '' && $Campus_City != '') {
                        $get_course_details = "select * from school_course sc where sc.course_id=$course_id and sc.campus_city=$Campus_City";
                        $query = $this->db->query($get_course_details);
                        $get_course_detailsresult = $query->row();
                        if (!empty($get_course_detailsresult)) {
                            $row->school_code = $get_course_detailsresult->school_code;
                            $row->course = $get_course_detailsresult->course;
                        }
                    }
                }
                if ($row->nationality == 1) {

                    $get_add_details = "select states.state_name,taluka_master.taluka_name as city_name from enquiry_student_master join  states 
			on enquiry_student_master.state_id=states.state_id join  taluka_master
			on  enquiry_student_master.city_id=taluka_master.taluka_id where enquiry_student_master.enquiry_id=" . $row->id;
                    $get_add_details = $DB1->query($get_add_details);
                    $get_add_details = $get_add_details->row();
                    if (!empty($get_add_details)) {
                        $row->state_name = $get_add_details->state_name;
                        $row->city_name = $get_add_details->city_name;
                        $row->Country = 'India';
                    }
                } else if ($row->nationality == 2) {

                    $get_add_details = "select  " . currentdb . ".countries.name as country_name,  " . currentdb . ".states.name as state_name, " . currentdb . ".cities.name as city_name from sandipun_ums.enquiry_student_master join  states 
			on sandipun_ums.enquiry_student_master.int_state= " . currentdb . ".states.id join   " . currentdb . ".cities
			on  sandipun_ums.enquiry_student_master.int_city= " . currentdb . ".cities.id join   " . currentdb . ".countries
			on  sandipun_ums.enquiry_student_master.int_country_id= " . currentdb . ".countries.id where sandipun_ums.enquiry_student_master.enquiry_id=" . $row->id;
                    $get_add_details = $this->db->query($get_add_details);
                    $get_add_details = $get_add_details->row();
                    if (!empty($get_add_details)) {
                        $row->state_name = $get_add_details->state_name;
                        $row->city_name = $get_add_details->city_name;
                        $row->Country = $get_add_details->country_name;
                    }
                }
                $array[] = $row;
            }
            $array = json_decode(json_encode($array), TRUE);
        }
        return $array;
    }

    public function total_confirmed_students($acd1 = "")
    {
        //$y=$acd1='2020-21';
        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        if ($role_id == '1') {
            $wh = "and (c.counselor_type='FOU' or c.counselor_type='CL')";
        } else if ($role_id == '7') {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 17) {
            $wh = " and u.um_id = " . $this->session->userdata('uid');
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
		from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
		from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by) OR  c.consultant_head='" . $this->session->userdata('uid') . "' )";
        } else {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "'";
        }
        $cii = '';
        //
        $sql = "select 
		c.contact_person,enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
		enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
		enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
		as remuneration,enquiry_student_master.remark 
		as remark,enquiry_student_master.status 
		as status,enquiry_student_master.Campus_City,
		enquiry_student_master.Campus
		from  sandipun_ums.enquiry_student_master join
        student_master as msm on enquiry_student_master.enquiry_id=msm.enquiry_id		
		join " . currentdb . ".user_master u on u.um_id=enquiry_student_master.created_by
		join " . currentdb . ".consultants_call_details c on  (u.employee_code = c.employee_code OR u.con_id=c.id ) AND c.status='Y' and c .status=u.status and c .status='Y'
		where enquiry_student_master.admission_session='$acd'
		and enquiry_student_master.is_from_consultant=1 $wh UNION
		select 
		c.contact_person,enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
		enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
		enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
		as remuneration,enquiry_student_master.remark 
		as remark,enquiry_student_master.status 
		as status,enquiry_student_master.Campus_City,
		enquiry_student_master.Campus
		from  sandipun_ums.enquiry_student_master join sandipun_ums_sijoul.student_master as msm on enquiry_student_master.stude_id=msm.stud_id 	
		join " . currentdb . ".user_master u on u.um_id=enquiry_student_master.created_by
		join " . currentdb . ".consultants_call_details c on  (u.employee_code = c.employee_code OR u.con_id=c.id ) AND c.status='Y' and c .status=u.status and c .status='Y'
		where enquiry_student_master.admission_session='$acd'
		and enquiry_student_master.is_from_consultant=1 $wh    ";


        //echo $sql;
        //exit;
        $DB1 = $this->load->database('umsdb', TRUE);
        $query = $DB1->query($sql);
        $result = $query->result();
        $array = array();
        if (!empty($result)) {
            foreach ($result as $row) {
                $row->event_code = 'Consultant';
                $row->student_name = $row->first_name . " " . $row->middle_name . " " . $row->last_name;
                $row->remuneration_status = $row->status;
                $row->remuneration_remark = $row->remark;
                $row->school_code = '';
                $row->course = '';
                $row->state_name = '';
                $row->city_name = '';
                $row->Country = 'India';

                if ($row->Campus_City == 1 && $row->Campus == "SUN") {
                    $school_id = $row->school_id;
                    $course_id = $row->course_id;
                    if (!empty($school_id) && !empty($course_id)) {
                        $get_course_details = "SELECT sandipun_ums.vw_stream_details.* from sandipun_ums.vw_stream_details where sandipun_ums.vw_stream_details.school_id=" . $school_id . " and sandipun_ums.vw_stream_details.course_id=" . $course_id;

                        $query = $this->db->query($get_course_details);
                        $get_course_detailsresult = $query->row();
                        if (!empty($get_course_detailsresult)) {
                            $row->school_code = $get_course_detailsresult->school_short_name;
                            $row->course = $get_course_detailsresult->course_name;
                        }
                    }
                } else if ($row->Campus_City == 2 && $row->Campus == "SIJOUL") {
                    $school_id = $row->school_id;
                    $course_id = $row->course_id;
                    if (!empty($school_id) && !empty($course_id)) {
                        $get_course_details = "SELECT sandipun_ums_sijoul.vw_stream_details.* from sandipun_ums_sijoul.vw_stream_details where sandipun_ums_sijoul.vw_stream_details.school_id=" . $school_id . " and sandipun_ums_sijoul.vw_stream_details.course_id=" . $course_id;

                        $query = $this->db->query($get_course_details);
                        $get_course_detailsresult = $query->row();
                        if (!empty($get_course_detailsresult)) {
                            $row->school_code = $get_course_detailsresult->school_short_name;
                            $row->course = $get_course_detailsresult->course_name;
                        }
                    }
                } else {
                    $course_id = $row->course_id;
                    $Campus_City = $row->Campus_City;
                    if (!empty($Campus_City) && !empty($course_id)) {
                        $get_course_details = "select * from school_course sc where sc.course_id=$course_id and sc.campus_city=$Campus_City";
                        $query = $this->db->query($get_course_details);
                        $get_course_detailsresult = $query->row();
                        if (!empty($get_course_detailsresult)) {
                            $row->school_code = $get_course_detailsresult->school_code;
                            $row->course = $get_course_detailsresult->course;
                        }
                    }
                }
                if ($row->nationality == 1) {

                    $get_add_details = "select states.state_name,taluka_master.taluka_name as city_name from enquiry_student_master join  states 
			on enquiry_student_master.state_id=states.state_id join  taluka_master
			on  enquiry_student_master.city_id=taluka_master.taluka_id where enquiry_student_master.enquiry_id=" . $row->id;
                    $get_add_details = $DB1->query($get_add_details);
                    $get_add_details = $get_add_details->row();
                    if (!empty($get_add_details)) {
                        $row->state_name = $get_add_details->state_name;
                        $row->city_name = $get_add_details->city_name;
                        $row->Country = 'India';
                    }
                } else if ($row->nationality == 2) {

                    $get_add_details = "select  " . currentdb . ".countries.name as country_name,  " . currentdb . ".states.name as state_name, " . currentdb . ".cities.name as city_name from sandipun_ums.enquiry_student_master join  states 
			on sandipun_ums.enquiry_student_master.int_state= " . currentdb . ".states.id join   " . currentdb . ".cities
			on  sandipun_ums.enquiry_student_master.int_city= " . currentdb . ".cities.id join   " . currentdb . ".countries
			on  sandipun_ums.enquiry_student_master.int_country_id= " . currentdb . ".countries.id where sandipun_ums.enquiry_student_master.enquiry_id=" . $row->id;
                    $get_add_details = $this->db->query($get_add_details);
                    $get_add_details = $get_add_details->row();
                    if (!empty($get_add_details)) {
                        $row->state_name = $get_add_details->state_name;
                        $row->city_name = $get_add_details->city_name;
                        $row->Country = $get_add_details->country_name;
                    }
                }
                $array[] = $row;
            }
            $array = json_decode(json_encode($array), TRUE);
        }
        return $array;
    }



    public function total_renumeration_received($acd1 = "")
    {
        //$y=$acd1='2020-21';
        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        if ($role_id == '1') {
            $wh = "and (c.counselor_type='FOU' or c.counselor_type='CL')";
        } else if ($role_id == '7') {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 17) {
            $wh = " and um.um_id = " . $this->session->userdata('uid');
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
		from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
		from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;

            $wh = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by) OR  c.consultant_head='" . $this->session->userdata('uid') . "' )";
        } else {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "'";
        }
        $sql = "select group_concat(um.um_id) as total_consultants from
		consultants_call_details as c 
		inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
		join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
		
		inner join roles_master as rm ON rm.roles_id=um.roles_id
		left join states as s on c.state_id = s.id
		left join cities as ci ON ci.id=c.city_id
		where c.status='Y' and  c.counselor_type != 'NULL'   $wh and sm.admission_session='$acd'
		";

        $query  = $this->db->query($sql)->row()->total_consultants;
        $ss = explode(",", $query);
        $consultant_id = "'" . implode("', '", $ss) . "'";

        $sql = "select sum(cp.amount) as renumeration_amount,consultant_id,c.* from consultant_payment_details as cp
join user_master um on cp.consultant_id=um.um_id join consultants_call_details as c 
on (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
		where cp.consultant_id IN($consultant_id) and cp.academic_year='$acd1'
		group by cp.consultant_id";

        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }



    public function ic_wise_data_registered_consultant($acd1 = "")
    {

        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        if ($role_id == '1') {
            $wh = " and (c.counselor_type='FOU' or c.counselor_type='CL')";
        } else if ($role_id == 7) {
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
			from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE(group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh =  " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "'  OR c.consultant_head='" . $this->session->userdata('uid') . "' ) and c.inserted_by NOT IN ($referred_by) ";
        } else {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "'";
        }
        $cii = '';

        $sql = "select count(c.id) as counts,c.ic_code,ic_registration.ic_name  from
			consultants_call_details as c
            join ic_registration on c.ic_code=ic_registration.ic_code			
			inner join user_master as um ON um.con_id = c.id and c.status='Y'
			inner join roles_master as rm ON rm.roles_id=um.roles_id
			left join states as s on c.state_id = s.id
			left join cities as ci ON ci.id=c.city_id
			where c.status='Y' and  c.counselor_type != 'NULL'   $wh  group by c.ic_code ";

        $query  = $this->db->query($sql);
        $result = $query->result_array();


        $result_data = array();
        if (!empty($result)) {
            foreach ($result as $row) {

                $ic_code = $row['ic_code'];

                $row['registered_admissions'] = $registered_admissions = $this->registered_admissions($ic_code, $acd1);
                $row['confirm_admissions'] = $confirm_admissions = $this->confirm_admissions($ic_code, $acd1);
                $row['total_renumerations'] = $total_renumerations = $this->total_renumerations_amount($ic_code, $acd1);
                $row['received_renumerations'] = $received_renumerations = $this->received_renumerations($ic_code, $acd1);
                $row['pending_renumeration'] = round($total_renumerations - 20 / 100 * $total_renumerations - $received_renumerations);

                $result_data[] =    $row;
            }
        }
        return  $result_data;
    }


    public function get_registeration_no($ic_code = "", $acd1 = "")
    {
        //$y=$acd1='2020-21';
        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        if ($role_id == '1') {
            $wh = "and (c.counselor_type='FOU' or c.counselor_type='CL')";
        } else if ($role_id == '7') {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 17) {
            $wh = " and um.um_id = " . $this->session->userdata('uid');
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
		from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
		from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "'  OR  c.consultant_head='" . $this->session->userdata('uid') . "' ) and  c.inserted_by NOT IN ($referred_by) ";
        } else {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "'";
        }
        $cii = '';
        //
        $sql = "select (c.id) from
		consultants_call_details as c 
		inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
		join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
		
		inner join roles_master as rm ON rm.roles_id=um.roles_id
		left join states as s on c.state_id = s.id
		left join cities as ci ON ci.id=c.city_id
		where c.status='Y' and  c.counselor_type != 'NULL'   $wh and sm.admission_session='$acd' and c.ic_code='$ic_code'
		group by sm.enquiry_id";
        //echo $sql;
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return sizeof($result);
    }

    public function registered_admissions($ic_code = '', $acd1 = '')
    {
        //$y=$acd1='2020-21';
        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        if ($role_id == '1') {
            $wh = "and (c.counselor_type='FOU' or c.counselor_type='CL')";
        } else if ($role_id == '7') {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 17) {
            $wh = " and um.um_id = " . $this->session->userdata('uid');
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
		from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
		from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "'  OR  c.consultant_head='" . $this->session->userdata('uid') . "' ) and  c.inserted_by NOT IN ($referred_by) ";
        } else {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "'";
        }
        $cii = '';
        //
        $sql = "select (c.id) from
		consultants_call_details as c 
		inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
		join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
		
		inner join roles_master as rm ON rm.roles_id=um.roles_id
		left join states as s on c.state_id = s.id
		left join cities as ci ON ci.id=c.city_id
		where c.status='Y' and  c.counselor_type != 'NULL'   $wh and sm.admission_session='$acd' and c.ic_code='$ic_code'
		group by sm.enquiry_id";
        //echo $sql;
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return sizeof($result);
    }

    public function confirm_admissions($ic_code = '', $acd1 = '')
    {
        //$y=$acd1='2020-21';
        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        if ($role_id == '1') {
            $wh = "and (c.counselor_type='FOU' or c.counselor_type='CL')";
        } else if ($role_id == '7') {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 17) {
            $wh = " and um.um_id = " . $this->session->userdata('uid');
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
		from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
		from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "'  OR  c.consultant_head='" . $this->session->userdata('uid') . "' ) and  c.inserted_by NOT IN ($referred_by) ";
        } else {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "'";
        }
        $cii = '';
        //
        $sql = "select sm.enquiry_id as enq from
		consultants_call_details as c 
		inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
		join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
		join sandipun_ums.student_master as msm on sm.enquiry_id=msm.enquiry_id 
		inner join roles_master as rm ON rm.roles_id=um.roles_id
		left join states as s on c.state_id = s.id
		left join cities as ci ON ci.id=c.city_id
		where c.status='Y' and  c.counselor_type != 'NULL'   $wh and sm.admission_session='$acd' and c.ic_code='$ic_code'
		group by enq";

        $query  = $this->db->query($sql);
        $result = $query->result_array();
        $sql = str_replace("sandipun_ums.student_master", "sandipun_ums_sijoul.student_master", $sql);
        $sql = str_replace("sm.enquiry_id", "sm.stude_id", $sql);
        $sql = str_replace("msm.stude_id", "msm.stud_id", $sql);

        $query  = $this->db->query($sql);
        $result1 = $query->result_array();
        $result = array_merge($result, $result1);
        return sizeof($result);
    }

    public function total_renumerations_amount($ic_code = '', $acd1 = '')
    {
        //$y=$acd1='2020-21';
        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        if ($role_id == '1') {
            $wh = "and (c.counselor_type='FOU' or c.counselor_type='CL')";
        } else if ($role_id == '7') {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 17) {
            $wh = " and um.um_id = " . $this->session->userdata('uid');
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
		from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
		from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR  c.consultant_head='" . $this->session->userdata('uid') . "' ) and  c.inserted_by NOT IN ($referred_by) ";
        } else {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "'";
        }
        $cii = '';
        //
        $sql = "select sum(sm.renumeration_amount) as renumeration_amount from
		consultants_call_details as c 
		inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
		join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
		join sandipun_ums.student_master as msm on sm.enquiry_id=msm.enquiry_id 
		inner join roles_master as rm ON rm.roles_id=um.roles_id
		left join states as s on c.state_id = s.id
		left join cities as ci ON ci.id=c.city_id
		where c.status='Y' and  c.counselor_type != 'NULL'   $wh and sm.admission_session='$acd' and c.ic_code='$ic_code'
		";
        //echo $sql;
        $query  = $this->db->query($sql);
        $result = $query->row()->renumeration_amount;
        $sql = str_replace("sandipun_ums.student_master", "sandipun_ums_sijoul.student_master", $sql);
        $sql = str_replace("sm.enquiry_id", "sm.stude_id", $sql);
        $sql = str_replace("msm.stude_id", "msm.stud_id", $sql);
        //echo $sql;
        //exit;
        $query  = $this->db->query($sql);
        $result1 = $query->row()->renumeration_amount;
        //$result = array_merge($result,$result1); 
        return $result + $result1;
    }


    public function received_renumerations($ic_code = '', $acd1 = '')
    {
        //$y=$acd1='2020-21';
        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        if ($role_id == '1') {
            $wh = "and (c.counselor_type='FOU' or c.counselor_type='CL')";
        } else if ($role_id == '7') {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 17) {
            $wh = " and um.um_id = " . $this->session->userdata('uid');
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
		from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
		from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR  c.consultant_head='" . $this->session->userdata('uid') . "' ) and  c.inserted_by NOT IN ($referred_by) ";
        } else {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "'";
        }
        $sql = "select group_concat(um.um_id) as total_consultants from
		consultants_call_details as c 
		inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
		join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
		
		inner join roles_master as rm ON rm.roles_id=um.roles_id
		left join states as s on c.state_id = s.id
		left join cities as ci ON ci.id=c.city_id
		where c.status='Y' and  c.counselor_type != 'NULL'   $wh and sm.admission_session='$acd' and c.ic_code='$ic_code'
		";

        $query  = $this->db->query($sql)->row()->total_consultants;
        $ss = explode(",", $query);
        $consultant_id = "'" . implode("', '", $ss) . "'";

        $sql = "select sum(cp.amount) as renumeration_amount from consultant_payment_details as cp where consultant_id IN($consultant_id)
		";
        //echo $sql;
        $query  = $this->db->query($sql);
        $result = $query->row()->renumeration_amount;


        //$result = array_merge($result,$result1); 
        return $result;
    }


    public function ac_wise_data_registered_consultant($acd1 = '')
    {

        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        if ($role_id == '1') {
            $referred_by = $this->db->query("select COALESCE(group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where  status='Y'")->row()->cordinator_id;
            $wh =  " and  c.inserted_by  IN ($referred_by)   ";
        } else if ($role_id == 27) {
            $referred_by = $this->db->query("select COALESCE(group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh =  " and  c.inserted_by  IN ($referred_by)   ";
        }


        $sql = "select CONCAT(ium.fname, '', ium.lname) AS ic_name,count(c.id) as counts,user_master.um_id  from
			consultants_call_details as c
            join user_master on c.inserted_by=user_master.um_id	
            inner join ic_user_master as ium ON ium.employee_code=user_master.employee_code			
			inner join roles_master as rm ON rm.roles_id=user_master.roles_id
			left join states as s on c.state_id = s.id
			left join cities as ci ON ci.id=c.city_id
			where c.status='Y' and  c.counselor_type != 'NULL'   $wh  group by user_master.um_id";

        $query  = $this->db->query($sql);
        $result = $query->result_array();


        $result_data = array();
        if (!empty($result)) {
            foreach ($result as $row) {
                $ic_code = $row['ic_code'];
                $um_id = $row['um_id'];

                $row['registered_admissions'] = $registered_admissions = $this->registered_admissions_cw_wise($um_id, $acd1);
                $row['confirm_admissions'] = $confirm_admissions = $this->confirm_admissions_cw_wise($um_id, $acd1);
                $row['total_renumerations'] = $total_renumerations = $this->total_renumerations_amount_cw_wise($um_id, $acd1);
                $row['received_renumerations'] = $received_renumerations = $this->received_renumerations_cw_wise($um_id, $acd1);
                $row['pending_renumeration'] = round($total_renumerations - 20 / 100 * $total_renumerations - $received_renumerations);
                $result_data[] =    $row;
            }
        }
        return  $result_data;
    }

    public function total_renumerations_amount_cw_wise($ic_code = '', $acd1 = '')
    {
        //$y=$acd1='2020-21';
        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        if ($role_id == '1') {
            $referred_by = $this->db->query("select COALESCE(group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where status='Y'")->row()->cordinator_id;
            $wh =  " and c.inserted_by   = $ic_code    ";
        } else if ($role_id == 27) {

            $referred_by = $this->db->query("select COALESCE(group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh =  " and  c.inserted_by    = $ic_code ";
        }
        $cii = '';
        //
        $sql = "select sum(sm.renumeration_amount) as renumeration_amount from
		consultants_call_details as c 
		inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
		join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
		join sandipun_ums.student_master as msm on sm.enquiry_id=msm.enquiry_id 
		inner join roles_master as rm ON rm.roles_id=um.roles_id
		left join states as s on c.state_id = s.id
		left join cities as ci ON ci.id=c.city_id
		where c.status='Y' and  c.counselor_type != 'NULL'   $wh and sm.admission_session='$acd' 
		";
        //echo $sql;
        $query  = $this->db->query($sql);
        $result = $query->row()->renumeration_amount;
        $sql = str_replace("sandipun_ums.student_master", "sandipun_ums_sijoul.student_master", $sql);
        $sql = str_replace("sm.enquiry_id", "sm.stude_id", $sql);
        $sql = str_replace("msm.stude_id", "msm.stud_id", $sql);
        //echo $sql;
        //exit;
        $query  = $this->db->query($sql);
        $result1 = $query->row()->renumeration_amount;
        //$result = array_merge($result,$result1); 
        return $result + $result1;
    }


    public function received_renumerations_cw_wise($ic_code = '', $acd1 = '')
    {
        //$y=$acd1='2020-21';
        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        if ($role_id == '1') {
            $referred_by = $this->db->query("select COALESCE(group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where  status='Y'")->row()->cordinator_id;
            $wh =  " and  c.inserted_by   = $ic_code  ";
        } else if ($role_id == 27) {

            $referred_by = $this->db->query("select COALESCE(group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh =  " and  c.inserted_by = $ic_code   ";
        }
        $sql = "select group_concat(um.um_id) as total_consultants from
		consultants_call_details as c 
		inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
		join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
		
		inner join roles_master as rm ON rm.roles_id=um.roles_id
		left join states as s on c.state_id = s.id
		left join cities as ci ON ci.id=c.city_id
		where c.status='Y' and  c.counselor_type != 'NULL'   $wh and sm.admission_session='$acd'
		";

        $query  = $this->db->query($sql)->row()->total_consultants;
        $ss = explode(",", $query);
        $consultant_id = "'" . implode("', '", $ss) . "'";

        $sql = "select sum(cp.amount) as renumeration_amount from consultant_payment_details as cp where consultant_id IN($consultant_id)
		";
        //echo $sql;
        $query  = $this->db->query($sql);
        $result = $query->row()->renumeration_amount;


        //$result = array_merge($result,$result1); 
        return $result;
    }


    public function registered_admissions_cw_wise($ic_code = '', $acd1 = '')
    {
        //$y=$acd1='2020-21';
        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        if ($role_id == '1') {
            $referred_by = $this->db->query("select COALESCE(group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where  status='Y'")->row()->cordinator_id;
            $wh =  " and c.inserted_by   = $ic_code ";
        } else if ($role_id == 27) {

            $referred_by = $this->db->query("select COALESCE(group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh =  " and  c.inserted_by   = $ic_code    ";
        }
        $cii = '';
        //
        $sql = "select (c.id) from
		consultants_call_details as c 
		inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
		join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
		
		inner join roles_master as rm ON rm.roles_id=um.roles_id
		left join states as s on c.state_id = s.id
		left join cities as ci ON ci.id=c.city_id
		where c.status='Y' and  c.counselor_type != 'NULL'   $wh and sm.admission_session='$acd'
		group by sm.enquiry_id";

        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return sizeof($result);
    }


    public function confirm_admissions_cw_wise($ic_code = '', $acd1 = '')
    {
        //$y=$acd1='2020-21';
        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        if ($role_id == '1') {
            $referred_by = $this->db->query("select COALESCE(group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where  status='Y'")->row()->cordinator_id;
            $wh =  " and  c.inserted_by   = $ic_code ";
        } else if ($role_id == 27) {

            $referred_by = $this->db->query("select COALESCE(group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh =  " and  c.inserted_by   = $ic_code     ";
        }
        $cii = '';
        //
        $sql = "select sm.enquiry_id as enq from
		consultants_call_details as c 
		inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
		join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 
		join sandipun_ums.student_master as msm on sm.enquiry_id=msm.enquiry_id 
		inner join roles_master as rm ON rm.roles_id=um.roles_id
		left join states as s on c.state_id = s.id
		left join cities as ci ON ci.id=c.city_id
		where c.status='Y' and  c.counselor_type != 'NULL'   $wh and sm.admission_session='$acd' 
		group by enq";

        $query  = $this->db->query($sql);
        $result = $query->result_array();
        $sql = str_replace("sandipun_ums.student_master", "sandipun_ums_sijoul.student_master", $sql);
        $sql = str_replace("sm.enquiry_id", "sm.stude_id", $sql);
        $sql = str_replace("msm.stude_id", "msm.stud_id", $sql);

        $query  = $this->db->query($sql);
        $result1 = $query->result_array();
        $result = array_merge($result, $result1);
        return sizeof($result);
    }

    function get_consultan_head()
    {

        $uid = $this->session->userdata("uid");
        $sql = " SELECT iu.*,CONCAT(iu.fname,' ',iu.lname) AS ic_name,um.um_id,roles_master.roles_type from ic_user_master iu left join user_master um on um.employee_code=iu.employee_code join roles_master on roles_master.roles_id=um.roles_id  where iu.status='Y' and um.status='Y' and um.roles_id =27  ";
        $query = $this->db->query($sql);
        //and um.username not in ('04519','4519','SureshM')
        return $query->result_array();
    }

    public function total_confirmed_students_by_consultnt($acd1 = '')
    {
        //$y=$acd1='2020-21';
        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $rfd = '';
        if ($role_id == '1') {
            $wh = "and (c.counselor_type='FOU' or c.counselor_type='CL')";
        } else if ($role_id == '7') {
            //  $wh = " and c.inserted_by='".$this->session->userdata('uid')."'";
            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if ($role_id == 17) {
            $wh = " and um.um_id = " . $this->session->userdata('uid');
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
		from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
		from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
            $wh = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by) OR  c.consultant_head='" . $this->session->userdata('uid') . "' )";
        } else {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "'";
        }
        $cii = '';
        //
        $sql = "select u.um_id,
		c.contact_person,enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
		enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
		enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
		as remuneration,enquiry_student_master.remark 
		as remark,enquiry_student_master.status 
		as status,enquiry_student_master.Campus_City,
		enquiry_student_master.Campus
		from  sandipun_ums.enquiry_student_master join
        student_master as msm on enquiry_student_master.enquiry_id=msm.enquiry_id		
		join " . currentdb . ".user_master u on u.um_id=enquiry_student_master.created_by
		join " . currentdb . ".consultants_call_details c on  (u.employee_code = c.employee_code OR u.con_id=c.id ) AND c.status='Y' and c .status=u.status and c .status='Y'
		where enquiry_student_master.admission_session='$acd'
		and enquiry_student_master.is_from_consultant=1 $wh UNION
		select u.um_id,
		c.contact_person,enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
		enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
		enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
		as remuneration,enquiry_student_master.remark 
		as remark,enquiry_student_master.status 
		as status,enquiry_student_master.Campus_City,
		enquiry_student_master.Campus
		from  sandipun_ums.enquiry_student_master join sandipun_ums_sijoul.student_master as msm on enquiry_student_master.stude_id=msm.stud_id 	
		join " . currentdb . ".user_master u on u.um_id=enquiry_student_master.created_by
		join " . currentdb . ".consultants_call_details c on  (u.employee_code = c.employee_code OR u.con_id=c.id ) AND c.status='Y' and c .status=u.status and c .status='Y'
		where enquiry_student_master.admission_session='$acd'
		and enquiry_student_master.is_from_consultant=1 $wh group by enquiry_student_master.created_by   ";


        $DB1 = $this->load->database('umsdb', TRUE);
        $query = $DB1->query($sql);
        $result = $query->result_array();


        return $result;
    }

    function total_confirmed_students_by_consultntss($year = '', $id = '')
    {
        $sql = "select COALESCE(sum(cp.amount),0) as renumeration_amount from consultant_payment_details cp where consultant_id=$id and academic_year='$year'";
        $query = $this->db->query($sql);

        return $result = $query->row()->renumeration_amount;
    }

    public function get_all_consultants_fou_list_new_for_erp_report($data, $cid = "")
    {

        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $cs = " c.status='Y'";
        if (!empty($data['coid']) && $data['coid'] != '' && $data['coid'] != undefined) {
            $wco = ' and c.country_id = "' . $data['coid'] . '"';
        }
        if (!empty($data['sid']) && $data['sid'] != ''  && $data['sid'] != undefined) {
            $ws = ' and c.state_id = "' . $data['sid'] . '"';
        }
        if (!empty($data['cid']) && $data['cid'] != ''  && $data['cid'] != undefined) {
            $wc = ' and c.city_id = "' . $data['cid'] . '"';
        }
        if (!empty($data['rid']) && $data['rid'] != ''  && $data['rid'] != undefined) {
            $rd = ' and um.roles_id = "' . $data['rid'] . '"';
        }
        if (!empty($data['rfid']) && $data['rfid'] != ''  && $data['rfid'] != undefined) {

            $rfd1 = ' and c.co_reff_by = "' . $data['rfid'] . '"';
        }

        if (!empty($data['consultant']) && $data['consultant'] != ''  && $data['consultant'] != undefined) {

            $rfd11 = ' and um.um_id = "' . $data['consultant'] . '"';
        }



        if (!empty($data['consultant_status']) && $data['consultant_status'] != ''  && $data['consultant_status'] != undefined) {
            $st = $data['consultant_status'];
            $cs = ' c.status="' . $st . '"';
        }
        $c = "";
        if (!empty($data['academic_year']) && $data['academic_year'] != ''  && $data['academic_year'] != undefined) {
            $rfd = ' and c.academic_year = "' . $data['academic_year'] . '"';
            $c = $data['academic_year'];
            $c1 = $data['academic_year'];
        } elseif ($cid != '') {
            $rfd = ' and c.academic_year = "2019-20"';
            $c = '2019-20';
            $c1 = '2019-20';
        } else {
            $cyear = $this->config->item('current_year');
            $rfd = ' and c.academic_year = "$cyear"';
            $c = $cyear;
            $c1 = $cyear;
        }
        $c = explode('-', $c);
        $c = $c[0];
        $ci = 'sandipun_ums.enquiry_student_master.academic_year="' . $c . '"';
        $counseler_id_in = '';
        if (!empty($data['consultant_is_student_register']) && $data['consultant_is_student_register'] != ''  && $data['consultant_is_student_register'] != undefined) {
            if ($data['consultant_is_student_register'] == 1) {
                $counseler_id_in = " and sms.enquiry_id IS NOT NULL ";
            } else {
                $counseler_id_in = " and sms.enquiry_id IS NULL ";
            }
        }
        if ($role_id == '1' || $role_id == '30') {


            if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != undefined) {

                $wh1 = " and c.ic_code='" . $data['icfilter'] . "'";
            }
        } else if (($role_id == '8' || $role_id == 7)  && $uid != 429) {

            $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
        } else if (($role_id == '8' || $role_id == 7)  && $uid == 429) {
            $wh = " and (c.ic_code='" . $this->session->userdata('ic_code') . "')";
        } else if ($role_id == 27) {
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;

            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";

            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
         from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;



            $wh =  " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by ) OR c.consultant_head=$uid ) ";
            if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != undefined) {

                $wh1 = " and c.ic_code='" . $data['icfilter'] . "'";
            }
        } else if ($role_id == 16) {
            $wh = " and ( c.consultant_head='" . $this->session->userdata('uid') . "')  ";
        } else {
            $wh = " and c.inserted_by='" . $this->session->userdata('uid') . "'";
        }
        $cii = '';
        if ($cid != '') {

            $cii = " and um.um_id = $cid ";
        }
        $ac = '';
        if (!empty($data['ac']) && $data['ac'] != ''  && $data['ac'] != undefined) {

            $ac = ' and c.inserted_by = "' . $data['ac'] . '"';
        }

        if (!empty($data['consultant_head']) && $data['consultant_head'] != ''  && $data['consultant_head'] != undefined) {
            $wh = '';
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=" . $data['consultant_head'] . " and status='Y'")->row()->ic_code;

            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";

            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
         from consultant_cordinator_mapping where consultant_id=" . $data['consultant_head'] . " and status='Y'")->row()->cordinator_id;



            $wh =  " and (c.ic_code IN ($ss) OR c.inserted_by='" . $data['consultant_head'] . "' OR c.inserted_by IN ($referred_by ) OR c.consultant_head=$uid ) ";
        }



        $sql = "select c.*,um.roles_id,rm.roles_name,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id,(select count(sm.enquiry_id) from sandipun_ums.enquiry_student_master as sm where created_by=um.um_id and admission_session='$c' and is_from_consultant=1) as registered_count,(select count(sm.enquiry_id) from sandipun_ums.enquiry_student_master as sm join sandipun_ums.student_master s on sm.enquiry_id=s.enquiry_id where sm.Campus_City=1 and sm.created_by=um.um_id and sm.admission_session='$c' and sm.is_from_consultant=1) as confirmed_nashik,(select count(sm.enquiry_id) from sandipun_ums.enquiry_student_master as sm join sandipun_ums_sijoul.student_master s on sm.stude_id=s.stud_id where sm.Campus_City!=1 and sm.created_by=um.um_id and sm.admission_session='$c' and sm.is_from_consultant=1) as confirmed_sijoul,(select count(*) from expected_admission 
                             where  consultant_id = um.um_id and academic_year='$c' and status='Y') as expected_admission
,(select COALESCE(sum(sm.renumeration_amount),0) from sandipun_ums.enquiry_student_master as sm join sandipun_ums.student_master s on sm.enquiry_id=s.enquiry_id where sm.Campus_City=1 and sm.created_by=um.um_id and sm.admission_session='$c' and sm.is_from_consultant=1) as r_nashik,(select COALESCE(sum(sm.renumeration_amount),0) from sandipun_ums.enquiry_student_master as sm join sandipun_ums_sijoul.student_master s on sm.stude_id=s.stud_id where sm.Campus_City!=1 and sm.created_by=um.um_id and sm.admission_session='$c' and sm.is_from_consultant=1) as r_sijoul,(select COALESCE(sum(amount),0)  from consultant_payment_details where consultant_id=um.um_id and academic_year='$c1') as paid_payment
							 from
		 consultants_call_details as c 
		 
		 
inner join user_master as um ON um.con_id = c.id 
 left join sandipun_ums.enquiry_student_master as sms on sms.created_by=um.um_id and sms.admission_session= '$c'
inner join roles_master as rm ON rm.roles_id=um.roles_id
left join states as s on c.state_id = s.id
left join cities as ci ON ci.id=c.city_id
          where  $cs and  c.counselor_type != 'NULL' $wco $ws $wc $rd  $rfd1 $wh $wh1 $rfd11 $cii $ac  $counseler_id_in  group by c.id order by c.contact_person";

        $query  = $this->db->query($sql);
        $result = $query->result_array();

        return $result;
    }


    function students_report($var = array())
    {

        $userID = $this->session->userdata('uid');
        $ic_code = $this->session->userdata('ic_code');
        $role_id = $this->session->userdata('role_id');
        $uid = $this->session->userdata("uid");

        if (! isset($var)) {
            $var['academic_year'] = $this->config->item('current_year');
        }
        if ($var['academic_year'] == '2019-20') {
            if ($role_id == '17' || $role_id == '18') {
                $whe1 = " and s.created_by='" . $userID . "' ";
            } else if ($role_id == '4') {

                $sql = "SELECT um_id FROM user_master  where inserted_by='$userID'  and status='Y' and roles_id='17'";
                $query = $this->db->query($sql);

                $result = $query->result_array();
                foreach ($result as $resu) {
                    $sava[] = "'" . $resu['um_id'] . "'";
                }

                $dsdd = implode(',', $sava);
                if (!empty($dsdd)) {
                    $whe1 = " and s.created_by  in (" . $dsdd . ")";
                } else {
                    $whe1 = "and s.created_by='" . $userID . "'";
                }
            } else if ($role_id == '8') {



                $result = $query->result_array();
                foreach ($result as $resu) {
                    $sava[] = "'" . $resu['um_id'] . "'";
                }
                $dsdd = implode(',', $sava);
                if (!empty($dsdd)) {
                    $whe = "inserted_by  in (" . $dsdd . ") and";
                } else {
                    $whe = '';
                }


                $sql1 = "SELECT um_id  FROM user_master  where $whe   status='Y' and  roles_id='17' ";

                $query1 = $this->db->query($sql1);

                $result2 = $query1->result_array();

                foreach ($result2 as $resu1) {
                    $savabdm[] = "'" . $resu1['um_id'] . "'";
                }

                $savabdm_data = implode(',', $savabdm);

                $sql2 = "SELECT um_id  FROM user_master  where inserted_by='$userID'   and status='Y' and roles_id='17'";

                $query1 = $this->db->query($sql2);

                $result3 = $query1->result_array();
                foreach ($result3 as $resu3) {
                    $savabdm3[] = "'" . $resu3['um_id'] . "'";
                }

                $merg_with_bdn_bde_consu = array_merge($savabdm, $savabdm3);
                $merg_with_bdn_bde_consultant = implode(',', $merg_with_bdn_bde_consu);

                if (!empty($merg_with_bdn_bde_consultant)) {
                    $whe1 = "and s.created_by  in (" . $merg_with_bdn_bde_consultant . ") and s.ic_code_consultant='" . $ic_code . "'";
                } else {
                    $whe1 = "and s.event_code='Consultant' and s.ic_code_consultant='" . $ic_code . "'"; //"and s.created_by='".$userID."'";
                }
            } else if ($role_id == '1') {

                $whe1 = "and s.event_code='Consultant'";
            } else if ($role_id == '7' && $uid != 429) {

                $whe1 = "and s.event_code='Consultant' and s.ic_code_consultant='" . $ic_code . "' ";
            } else if (($role_id == '7') && $uid == 429) {
                $whe1 = "and s.event_code='Consultant' and (s.ic_code_consultant='" . $ic_code . "' or s.ic_code_consultant='SU_BR_003') ";
                //$wh = " and (c.ic_code='".$this->session->userdata('ic_code')."' or c.ic_code='')";
            } else if (($role_id == '27')) {
                $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;

                $ss = explode(",", $ss);
                $ss = "'" . implode("', '", $ss) . "'";
                $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
         from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
                $whe1 = " and (ccd.ic_code IN ($ss) OR ccd.inserted_by='" . $this->session->userdata('uid') . "' OR ccd.inserted_by IN ($referred_by) )";

                //$wh = " and (c.ic_code='".$this->session->userdata('ic_code')."' or c.ic_code='')";
            } else {
                $whe1 = '';
            }

            if ($role_id == '1') {

                if ($var['icfilter'] != '') {
                    $chekuser = " and s.ic_code_consultant='" . $var['icfilter'] . "' ";
                }
            } else {
                $chekuser = '';
            }




            if ($var['consultantfilter'] != '') {
                $cd = " and s.created_by='" . $var['consultantfilter'] . "' ";
            } else {
                $cd = ' ';
            }
            if ($var['campusfilter'] != '') {
                $camput = " and s.campus_id='" . $var['campusfilter'] . "'";
            } else {
                $camput = '';
            }

            if ($var['statusfilter'] != '') {
                $statusfilter = " and s.remuneration_status='" . $var['statusfilter'] . "'";
            } else {
                $statusfilter = '';
            }



            //$sql = "SELECT * FROM student_meet_details WHERE created_by='" . $userID . "' and status='0' and markForDelete = 0";
            $sql = "SELECT s.id,s.event_code,s.organization ,s.created_by,s.ic_code_consultant,s.student_name,s.mobile1,s.whatsappno,s.email,s.state_name,s.city_name,ir.ic_name,sc.school_code,sc.course,s.remuneration ,s.remuneration_status,s.remuneration_remark,ccd.contact_person,ir.ic_name,ccd.pancard,s.campus_id FROM student_meet_details s 
            left join school_course sc on sc.course_id=s.programme_id and sc.campus_city=s.campus_id
            left join ic_registration ir on s.ic_code_consultant=ir.ic_code 
            left JOIN user_master AS um ON um.`um_id`=s.created_by 
            left JOIN consultants_call_details AS ccd ON ccd.employee_code=um.`employee_code`         
            WHERE s.academic_year='" . $var['academic_year'] . "' $chekuser  $cd $camput $statusfilter  $whe1 ";
            $sql .= " ORDER BY  s.id DESC";

            $query = $this->db->query($sql);

            $result = $query->result_array();


            return $result;
        } else {
            $y = $var['academic_year'];
            if (isset(
                $var['academic_year']
            )) {
                $acd1 = $acd = substr($var['academic_year'], 0, 4);
            } else {
                $y = $acd1 = $this->config->item('current_year');
                $current_year = explode('-', $acd1);
                $acd = $current_year[0];
            }
            $DB1 = $this->load->database('umsdb', TRUE);
            $chekuser = '';
            if ($var['icfilter'] != ''  && $var['icfilter'] != undefined) {
                $chekuser = " and c.ic_code='" . $var['icfilter'] . "' ";
            }

            if ($var['consultant'] != '' && $var['consultant'] != undefined) {
                $cd = " and enquiry_student_master.created_by='" . $var['consultant'] . "' ";
            } else {
                $cd = ' ';
            }

            if ($var['consultant_head'] != '' && $var['consultant_head'] != undefined) {
                $ch = $var['consultant_head'];
                $ss = $this->db->query("select group_concat(ic_code) as ic_code
			from ic_mapping where consultant_head=$ch and status='Y'")->row()->ic_code;
                $ss = explode(",", $ss);
                $ss = "'" . implode("', '", $ss) . "'";
                $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=$ch and status='Y'")->row()->cordinator_id;
                $chd = " and (c.ic_code IN ($ss) OR c.inserted_by='$ch' OR c.consultant_head='$ch' OR c.inserted_by IN ($referred_by) )";
            } else {
                $chd = ' ';
            }


            if ($var['campusfilter'] != '' && $var['campusfilter'] != undefined) {
                $var['campusfilter'] = $var['campusfilter'];
                $camput = " and enquiry_student_master.Campus_City='" . $var['campusfilter'] . "'";
            } else {
                $camput = '';
            }
            $if = '';
            if ($var['icfilter'] != '' && $var['icfilter'] != undefined) {
                $var['icfilter'] = $var['icfilter'];
                $if = " and c.ic_code='" . $var['icfilter'] . "'";
            } else {
                $if = '';
            }


            if ($var['ac'] != '' && $var['ac'] != undefined) {
                $var['ac'] = $var['ac'];
                $ac = " and c.inserted_by='" . $var['ac'] . "'";
            } else {
                $ac = '';
            }


            if ($var['statusfilter'] != '') {
                if ($var['statusfilter'] == "V") {
                    $var['statusfilter'] = "Y";
                } else {
                    $var['statusfilter'] = "N";
                }
                $statusfilter = " and enquiry_student_master.status='" . $var['statusfilter'] . "'";
            } else {
                $statusfilter = '';
            }


            $sql1 = '';
            $sql2 = '';
            if ($role_id == 7) {
                $sql1 = " and  c.ic_code='" . $this->session->userdata('ic_code') . "'";
            } else if ($role_id == 27) {
                $ss = $this->db->query("select group_concat(ic_code) as ic_code
			from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
                $ss = explode(",", $ss);
                $ss = "'" . implode("', '", $ss) . "'";
                $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
                $sql1 = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.consultant_head='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by) )";
            } else if ($role_id != 1) {

                if ($var['consultant'] != '' && $role_id == 35) {
                } else {
                    $sql1 = " and  c.inserted_by='" . $this->session->userdata('uid') . "'";
                }
            }
            $sql = "select 
c.contact_person,enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
as remuneration,enquiry_student_master.remark 
as remark,enquiry_student_master.status 
as status,enquiry_student_master.Campus_City,
enquiry_student_master.Campus
from  sandipun_ums.enquiry_student_master 
join " . currentdb . ".user_master u on u.um_id=enquiry_student_master.created_by
join " . currentdb . ".consultants_call_details c on c.employee_code=u.employee_code 
where enquiry_student_master.admission_session='$acd'
 $sql1 and enquiry_student_master.is_from_consultant=1 $statusfilter $camput $cd $chd $ac $if";

            $sql .= " ORDER BY enquiry_student_master.enquiry_id DESC";

            $query = $DB1->query($sql);
            $result = $query->result();





            $array = array();
            if (!empty($result)) {

                foreach ($result as $row) {
                    $row->event_code = 'Consultant';
                    $row->student_name = $row->first_name . " " . $row->middle_name . " " . $row->last_name;
                    $row->remuneration_status = $row->status;
                    $row->remuneration_remark = $row->remark;
                    $row->school_code = '';
                    $row->course = '';
                    $row->state_name = '';
                    $row->city_name = '';
                    $row->Country = 'India';
                    if ($row->Campus_City == 1 && $row->Campus == "SUN") {
                        $school_id = $row->school_id;
                        $course_id = $row->course_id;
                        if ($course_id != ''  && $school_id != '') {
                            $get_course_details = "SELECT sandipun_ums.vw_stream_details.* from sandipun_ums.vw_stream_details where sandipun_ums.vw_stream_details.school_id=" . $school_id . " and sandipun_ums.vw_stream_details.course_id=" . $course_id;

                            $query = $this->db->query($get_course_details);
                            $get_course_detailsresult = $query->row();
                            if (!empty($get_course_detailsresult)) {
                                $row->school_code = $get_course_detailsresult->school_short_name;
                                $row->course = $get_course_detailsresult->course_name;
                            }
                        }
                    } else if ($row->Campus_City == 2 && $row->Campus == "SIJOUL") {
                        $school_id = $row->school_id;
                        $course_id = $row->course_id;
                        if ($course_id != ''  && $school_id != '') {
                            $get_course_details = "SELECT sandipun_ums_sijoul.vw_stream_details.* from sandipun_ums_sijoul.vw_stream_details where sandipun_ums_sijoul.vw_stream_details.school_id=" . $school_id . " and sandipun_ums_sijoul.vw_stream_details.course_id=" . $course_id;

                            $query = $this->db->query($get_course_details);
                            $get_course_detailsresult = $query->row();
                            if (!empty($get_course_detailsresult)) {
                                $row->school_code = $get_course_detailsresult->school_short_name;
                                $row->course = $get_course_detailsresult->course_name;
                            }
                        }
                    } else {
                        $course_id = $row->course_id;
                        $Campus_City = $row->Campus_City;
                        if ($course_id != ''  && $Campus_City != '') {
                            $get_course_details = "select * from school_course sc where sc.course_id=$course_id and sc.campus_city=$Campus_City";
                            $query = $this->db->query($get_course_details);
                            $get_course_detailsresult = $query->row();
                            if (!empty($get_course_detailsresult)) {
                                $row->school_code = $get_course_detailsresult->school_code;
                                $row->course = $get_course_detailsresult->course;
                            }
                        }
                    }
                    if ($row->nationality == 1) {

                        $get_add_details = "select states.state_name,taluka_master.taluka_name as city_name from enquiry_student_master join  states 
on enquiry_student_master.state_id=states.state_id join  taluka_master
on  enquiry_student_master.city_id=taluka_master.taluka_id where enquiry_student_master.enquiry_id=" . $row->id;
                        $get_add_details = $DB1->query($get_add_details);
                        $get_add_details = $get_add_details->row();
                        if (!empty($get_add_details)) {
                            $row->state_name = $get_add_details->state_name;
                            $row->city_name = $get_add_details->city_name;
                            $row->Country = 'India';
                        }
                    } else if ($row->nationality == 2) {

                        $get_add_details = "select  " . currentdb . ".countries.name as country_name,  " . currentdb . ".states.name as state_name, " . currentdb . ".cities.name as city_name from sandipun_ums.enquiry_student_master join  states 
on sandipun_ums.enquiry_student_master.int_state= " . currentdb . ".states.id join   " . currentdb . ".cities
on  sandipun_ums.enquiry_student_master.int_city= " . currentdb . ".cities.id join   " . currentdb . ".countries
on  sandipun_ums.enquiry_student_master.int_country_id= " . currentdb . ".countries.id where sandipun_ums.enquiry_student_master.enquiry_id=" . $row->id;
                        $get_add_details = $this->db->query($get_add_details);
                        $get_add_details = $get_add_details->row();
                        if (!empty($get_add_details)) {
                            $row->state_name = $get_add_details->state_name;
                            $row->city_name = $get_add_details->city_name;
                            $row->Country = $get_add_details->country_name;
                        }
                    }


                    //print_r($row);exit;


                    $array[] = $row;
                }
            }
            $array = json_decode(json_encode($array), TRUE);
            //exit;
            return $array;
        }
        //

    }


    function cstudents_report($var = array())
    {

        $userID = $this->session->userdata('uid');
        $ic_code = $this->session->userdata('ic_code');
        $role_id = $this->session->userdata('role_id');
        $uid = $this->session->userdata("uid");

        if (! isset($var)) {
            $var['academic_year'] = $this->config->item('current_year');
        }
        if ($var['academic_year'] == '2019-20') {
            if ($role_id == '17' || $role_id == '18') {
                $whe1 = " and s.created_by='" . $userID . "' ";
            } else if ($role_id == '4') {

                $sql = "SELECT um_id FROM user_master  where inserted_by='$userID'  and status='Y' and roles_id='17'";
                $query = $this->db->query($sql);

                $result = $query->result_array();
                foreach ($result as $resu) {
                    $sava[] = "'" . $resu['um_id'] . "'";
                }

                $dsdd = implode(',', $sava);
                if (!empty($dsdd)) {
                    $whe1 = " and s.created_by  in (" . $dsdd . ")";
                } else {
                    $whe1 = "and s.created_by='" . $userID . "'";
                }
            } else if ($role_id == '8') {



                $result = $query->result_array();
                foreach ($result as $resu) {
                    $sava[] = "'" . $resu['um_id'] . "'";
                }
                $dsdd = implode(',', $sava);
                if (!empty($dsdd)) {
                    $whe = "inserted_by  in (" . $dsdd . ") and";
                } else {
                    $whe = '';
                }


                $sql1 = "SELECT um_id  FROM user_master  where $whe   status='Y' and  roles_id='17' ";

                $query1 = $this->db->query($sql1);

                $result2 = $query1->result_array();

                foreach ($result2 as $resu1) {
                    $savabdm[] = "'" . $resu1['um_id'] . "'";
                }

                $savabdm_data = implode(',', $savabdm);

                $sql2 = "SELECT um_id  FROM user_master  where inserted_by='$userID'   and status='Y' and roles_id='17'";

                $query1 = $this->db->query($sql2);

                $result3 = $query1->result_array();
                foreach ($result3 as $resu3) {
                    $savabdm3[] = "'" . $resu3['um_id'] . "'";
                }

                $merg_with_bdn_bde_consu = array_merge($savabdm, $savabdm3);
                $merg_with_bdn_bde_consultant = implode(',', $merg_with_bdn_bde_consu);

                if (!empty($merg_with_bdn_bde_consultant)) {
                    $whe1 = "and s.created_by  in (" . $merg_with_bdn_bde_consultant . ") and s.ic_code_consultant='" . $ic_code . "'";
                } else {
                    $whe1 = "and s.event_code='Consultant' and s.ic_code_consultant='" . $ic_code . "'"; //"and s.created_by='".$userID."'";
                }
            } else if ($role_id == '1') {

                $whe1 = "and s.event_code='Consultant'";
            } else if ($role_id == '7' && $uid != 429) {

                $whe1 = "and s.event_code='Consultant' and s.ic_code_consultant='" . $ic_code . "' ";
            } else if (($role_id == '7') && $uid == 429) {
                $whe1 = "and s.event_code='Consultant' and (s.ic_code_consultant='" . $ic_code . "' or s.ic_code_consultant='SU_BR_003') ";
                //$wh = " and (c.ic_code='".$this->session->userdata('ic_code')."' or c.ic_code='')";
            } else if (($role_id == '27')) {
                $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;

                $ss = explode(",", $ss);
                $ss = "'" . implode("', '", $ss) . "'";
                $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
         from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
                $whe1 = " and (ccd.ic_code IN ($ss) OR ccd.inserted_by='" . $this->session->userdata('uid') . "' OR ccd.inserted_by IN ($referred_by) )";

                //$wh = " and (c.ic_code='".$this->session->userdata('ic_code')."' or c.ic_code='')";
            } else {
                $whe1 = '';
            }

            if ($role_id == '1') {

                if ($var['icfilter'] != '') {
                    $chekuser = " and s.ic_code_consultant='" . $var['icfilter'] . "' ";
                }
            } else {
                $chekuser = '';
            }




            if ($var['consultantfilter'] != '') {
                $cd = " and s.created_by='" . $var['consultantfilter'] . "' ";
            } else {
                $cd = ' ';
            }
            if ($var['campusfilter'] != '') {
                $camput = " and s.campus_id='" . $var['campusfilter'] . "'";
            } else {
                $camput = '';
            }

            if ($var['statusfilter'] != '') {
                $statusfilter = " and s.remuneration_status='" . $var['statusfilter'] . "'";
            } else {
                $statusfilter = '';
            }



            //$sql = "SELECT * FROM student_meet_details WHERE created_by='" . $userID . "' and status='0' and markForDelete = 0";
            $sql = "SELECT s.id,s.event_code,s.organization ,s.created_by,s.ic_code_consultant,s.student_name,s.mobile1,s.whatsappno,s.email,s.state_name,s.city_name,ir.ic_name,sc.school_code,sc.course,s.remuneration ,s.remuneration_status,s.remuneration_remark,ccd.contact_person,ir.ic_name,ccd.pancard,s.campus_id FROM student_meet_details s 
            left join school_course sc on sc.course_id=s.programme_id and sc.campus_city=s.campus_id
            left join ic_registration ir on s.ic_code_consultant=ir.ic_code 
            left JOIN user_master AS um ON um.`um_id`=s.created_by 
            left JOIN consultants_call_details AS ccd ON ccd.employee_code=um.`employee_code`         
            WHERE s.academic_year='" . $var['academic_year'] . "' $chekuser  $cd $camput $statusfilter  $whe1 ";
            $sql .= " ORDER BY  s.id DESC";

            $query = $this->db->query($sql);

            $result = $query->result_array();


            return $result;
        } else {
            $y = $var['academic_year'];
            if (isset(
                $var['academic_year']
            )) {
                $acd1 = $acd = substr($var['academic_year'], 0, 4);
            } else {
                $y = $acd1 = $this->config->item('current_year');
                $current_year = explode('-', $acd1);
                $acd = $current_year[0];
            }
            $DB1 = $this->load->database('umsdb', TRUE);
            $chekuser = '';
            if ($var['icfilter'] != ''  && $var['icfilter'] != undefined) {
                $chekuser = " and c.ic_code='" . $var['icfilter'] . "' ";
            }

            if ($var['consultant'] != '' && $var['consultant'] != undefined) {
                $cd = " and enquiry_student_master.created_by='" . $var['consultant'] . "' ";
            } else {
                $cd = ' ';
            }

            if ($var['consultant_head'] != '' && $var['consultant_head'] != undefined) {
                $ch = $var['consultant_head'];
                $ss = $this->db->query("select group_concat(ic_code) as ic_code
			from ic_mapping where consultant_head=$ch and status='Y'")->row()->ic_code;
                $ss = explode(",", $ss);
                $ss = "'" . implode("', '", $ss) . "'";
                $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=$ch and status='Y'")->row()->cordinator_id;
                $chd = " and (c.ic_code IN ($ss) OR c.inserted_by='$ch' OR c.consultant_head='$ch' OR c.inserted_by IN ($referred_by) )";
            } else {
                $chd = ' ';
            }


            if ($var['campusfilter'] != '' && $var['campusfilter'] != undefined) {
                $var['campusfilter'] = $var['campusfilter'];
                $camput = " and enquiry_student_master.Campus_City='" . $var['campusfilter'] . "'";
            } else {
                $camput = '';
            }
            $if = '';
            if ($var['icfilter'] != '' && $var['icfilter'] != undefined) {
                $var['icfilter'] = $var['icfilter'];
                $if = " and c.ic_code='" . $var['icfilter'] . "'";
            } else {
                $if = '';
            }


            if ($var['ac'] != '' && $var['ac'] != undefined) {
                $var['ac'] = $var['ac'];
                $ac = " and c.inserted_by='" . $var['ac'] . "'";
            } else {
                $ac = '';
            }


            if ($var['statusfilter'] != '') {
                if ($var['statusfilter'] == "V") {
                    $var['statusfilter'] = "Y";
                } else {
                    $var['statusfilter'] = "N";
                }
                $statusfilter = " and enquiry_student_master.status='" . $var['statusfilter'] . "'";
            } else {
                $statusfilter = '';
            }


            $sql1 = '';
            $sql2 = '';
            if ($role_id == 7) {
                $sql1 = " and  c.ic_code='" . $this->session->userdata('ic_code') . "'";
            } else if ($role_id == 27) {
                $ss = $this->db->query("select group_concat(ic_code) as ic_code
			from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
                $ss = explode(",", $ss);
                $ss = "'" . implode("', '", $ss) . "'";
                $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
                $sql1 = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.consultant_head='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by) )";
            } else if ($role_id != 1) {

                if ($var['consultant'] != '' && $role_id == 35) {
                } else {
                    $sql1 = " and  c.inserted_by='" . $this->session->userdata('uid') . "'";
                }
            }
            $sql = "select 
c.contact_person,enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
as remuneration,enquiry_student_master.remark 
as remark,enquiry_student_master.status 
as status,enquiry_student_master.Campus_City,
enquiry_student_master.Campus
from  sandipun_ums.enquiry_student_master 
join student_master sm on sm.enquiry_id=enquiry_student_master.enquiry_id
join " . currentdb . ".user_master u on u.um_id=enquiry_student_master.created_by
join " . currentdb . ".consultants_call_details c on c.employee_code=u.employee_code 
where enquiry_student_master.admission_session='$acd'
 $sql1 and enquiry_student_master.is_from_consultant=1 $statusfilter $camput $cd $chd $ac $if ";

            $sql .= " ORDER BY enquiry_student_master.enquiry_id DESC";

            $query = $DB1->query($sql);
            $result = $query->result();

            $sql = "select 
c.contact_person,enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
as remuneration,enquiry_student_master.remark 
as remark,enquiry_student_master.status 
as status,enquiry_student_master.Campus_City,
enquiry_student_master.Campus
from  sandipun_ums.enquiry_student_master 
join sandipun_ums_sijoul.student_master sm on sm.stud_id=enquiry_student_master.stude_id
join " . currentdb . ".user_master u on u.um_id=enquiry_student_master.created_by
join " . currentdb . ".consultants_call_details c on c.employee_code=u.employee_code 
where enquiry_student_master.admission_session='$acd'
 $sql1 and enquiry_student_master.is_from_consultant=1 $statusfilter $camput $cd $chd $ac $if ";

            $sql .= " ORDER BY enquiry_student_master.enquiry_id DESC";

            $query = $DB1->query($sql);
            $result1 = $query->result();

            $result = array_merge($result, $result1);

            $array = array();
            if (!empty($result)) {

                foreach ($result as $row) {
                    $row->event_code = 'Consultant';
                    $row->student_name = $row->first_name . " " . $row->middle_name . " " . $row->last_name;
                    $row->remuneration_status = $row->status;
                    $row->remuneration_remark = $row->remark;
                    $row->school_code = '';
                    $row->course = '';
                    $row->state_name = '';
                    $row->city_name = '';
                    $row->Country = 'India';
                    if ($row->Campus_City == 1 && $row->Campus == "SUN") {
                        $school_id = $row->school_id;
                        $course_id = $row->course_id;
                        $get_course_details = "SELECT sandipun_ums.vw_stream_details.* from sandipun_ums.vw_stream_details where sandipun_ums.vw_stream_details.school_id=" . $school_id . " and sandipun_ums.vw_stream_details.course_id=" . $course_id;

                        $query = $this->db->query($get_course_details);
                        $get_course_detailsresult = $query->row();
                        if (!empty($get_course_detailsresult)) {
                            $row->school_code = $get_course_detailsresult->school_short_name;
                            $row->course = $get_course_detailsresult->course_name;
                        }
                    } else if ($row->Campus_City == 2 && $row->Campus == "SIJOUL") {
                        $school_id = $row->school_id;
                        $course_id = $row->course_id;
                        $get_course_details = "SELECT sandipun_ums_sijoul.vw_stream_details.* from sandipun_ums_sijoul.vw_stream_details where sandipun_ums_sijoul.vw_stream_details.school_id=" . $school_id . " and sandipun_ums_sijoul.vw_stream_details.course_id=" . $course_id;

                        $query = $this->db->query($get_course_details);
                        $get_course_detailsresult = $query->row();
                        if (!empty($get_course_detailsresult)) {
                            $row->school_code = $get_course_detailsresult->school_short_name;
                            $row->course = $get_course_detailsresult->course_name;
                        }
                    } else {
                        $course_id = $row->course_id;
                        $Campus_City = $row->Campus_City;
                        $get_course_details = "select * from school_course sc where sc.course_id=$course_id and sc.campus_city=$Campus_City";
                        $query = $this->db->query($get_course_details);
                        $get_course_detailsresult = $query->row();
                        if (!empty($get_course_detailsresult)) {
                            $row->school_code = $get_course_detailsresult->school_code;
                            $row->course = $get_course_detailsresult->course;
                        }
                    }
                    if ($row->nationality == 1) {

                        $get_add_details = "select states.state_name,taluka_master.taluka_name as city_name from enquiry_student_master join  states 
on enquiry_student_master.state_id=states.state_id join  taluka_master
on  enquiry_student_master.city_id=taluka_master.taluka_id where enquiry_student_master.enquiry_id=" . $row->id;
                        $get_add_details = $DB1->query($get_add_details);
                        $get_add_details = $get_add_details->row();
                        if (!empty($get_add_details)) {
                            $row->state_name = $get_add_details->state_name;
                            $row->city_name = $get_add_details->city_name;
                            $row->Country = 'India';
                        }
                    } else if ($row->nationality == 2) {

                        $get_add_details = "select  " . currentdb . ".countries.name as country_name,  " . currentdb . ".states.name as state_name, " . currentdb . ".cities.name as city_name from sandipun_ums.enquiry_student_master join  states 
on sandipun_ums.enquiry_student_master.int_state= " . currentdb . ".states.id join   " . currentdb . ".cities
on  sandipun_ums.enquiry_student_master.int_city= " . currentdb . ".cities.id join   " . currentdb . ".countries
on  sandipun_ums.enquiry_student_master.int_country_id= " . currentdb . ".countries.id where sandipun_ums.enquiry_student_master.enquiry_id=" . $row->id;
                        $get_add_details = $this->db->query($get_add_details);
                        $get_add_details = $get_add_details->row();
                        if (!empty($get_add_details)) {
                            $row->state_name = $get_add_details->state_name;
                            $row->city_name = $get_add_details->city_name;
                            $row->Country = $get_add_details->country_name;
                        }
                    }


                    //print_r($row);exit;


                    $array[] = $row;
                }
            }
            $array = json_decode(json_encode($array), TRUE);
            //exit;
            return $array;
        }
        //

    }




    function cstudents_report_with_drcc_payment($var = array())
    {
        $var['academic_year'] = ACADEMIC_YEAR;
        $userID = $this->session->userdata('uid');
        $ic_code = $this->session->userdata('ic_code');
        $role_id = $this->session->userdata('role_id');
        $uid = $this->session->userdata("uid");

        if (! isset($var)) {
            $var['academic_year'] = $this->config->item('current_year');
        }
        if ($var['academic_year'] == '2019-20') {
            if ($role_id == '17' || $role_id == '18') {
                $whe1 = " and s.created_by='" . $userID . "' ";
            } else if ($role_id == '4') {

                $sql = "SELECT um_id FROM user_master  where inserted_by='$userID'  and status='Y' and roles_id='17'";
                $query = $this->db->query($sql);

                $result = $query->result_array();
                foreach ($result as $resu) {
                    $sava[] = "'" . $resu['um_id'] . "'";
                }

                $dsdd = implode(',', $sava);
                if (!empty($dsdd)) {
                    $whe1 = " and s.created_by  in (" . $dsdd . ")";
                } else {
                    $whe1 = "and s.created_by='" . $userID . "'";
                }
            } else if ($role_id == '8') {



                $result = $query->result_array();
                foreach ($result as $resu) {
                    $sava[] = "'" . $resu['um_id'] . "'";
                }
                $dsdd = implode(',', $sava);
                if (!empty($dsdd)) {
                    $whe = "inserted_by  in (" . $dsdd . ") and";
                } else {
                    $whe = '';
                }


                $sql1 = "SELECT um_id  FROM user_master  where $whe   status='Y' and  roles_id='17' ";

                $query1 = $this->db->query($sql1);

                $result2 = $query1->result_array();

                foreach ($result2 as $resu1) {
                    $savabdm[] = "'" . $resu1['um_id'] . "'";
                }

                $savabdm_data = implode(',', $savabdm);

                $sql2 = "SELECT um_id  FROM user_master  where inserted_by='$userID'   and status='Y' and roles_id='17'";

                $query1 = $this->db->query($sql2);

                $result3 = $query1->result_array();
                foreach ($result3 as $resu3) {
                    $savabdm3[] = "'" . $resu3['um_id'] . "'";
                }

                $merg_with_bdn_bde_consu = array_merge($savabdm, $savabdm3);
                $merg_with_bdn_bde_consultant = implode(',', $merg_with_bdn_bde_consu);

                if (!empty($merg_with_bdn_bde_consultant)) {
                    $whe1 = "and s.created_by  in (" . $merg_with_bdn_bde_consultant . ") and s.ic_code_consultant='" . $ic_code . "'";
                } else {
                    $whe1 = "and s.event_code='Consultant' and s.ic_code_consultant='" . $ic_code . "'"; //"and s.created_by='".$userID."'";
                }
            } else if ($role_id == '1') {

                $whe1 = "and s.event_code='Consultant'";
            } else if ($role_id == '7' && $uid != 429) {

                $whe1 = "and s.event_code='Consultant' and s.ic_code_consultant='" . $ic_code . "' ";
            } else if (($role_id == '7') && $uid == 429) {
                $whe1 = "and s.event_code='Consultant' and (s.ic_code_consultant='" . $ic_code . "' or s.ic_code_consultant='SU_BR_003') ";
                //$wh = " and (c.ic_code='".$this->session->userdata('ic_code')."' or c.ic_code='')";
            } else if (($role_id == '27')) {
                $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;

                $ss = explode(",", $ss);
                $ss = "'" . implode("', '", $ss) . "'";
                $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
         from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
                $whe1 = " and (ccd.ic_code IN ($ss) OR ccd.inserted_by='" . $this->session->userdata('uid') . "' OR ccd.inserted_by IN ($referred_by) )";

                //$wh = " and (c.ic_code='".$this->session->userdata('ic_code')."' or c.ic_code='')";
            } else {
                $whe1 = '';
            }

            if ($role_id == '1') {

                if ($var['icfilter'] != '') {
                    $chekuser = " and s.ic_code_consultant='" . $var['icfilter'] . "' ";
                }
            } else {
                $chekuser = '';
            }




            if ($var['consultantfilter'] != '') {
                $cd = " and s.created_by='" . $var['consultantfilter'] . "' ";
            } else {
                $cd = ' ';
            }
            if ($var['campusfilter'] != '') {
                $camput = " and s.campus_id='" . $var['campusfilter'] . "'";
            } else {
                $camput = '';
            }

            if ($var['statusfilter'] != '') {
                $statusfilter = " and s.remuneration_status='" . $var['statusfilter'] . "'";
            } else {
                $statusfilter = '';
            }



            //$sql = "SELECT * FROM student_meet_details WHERE created_by='" . $userID . "' and status='0' and markForDelete = 0";
            $sql = "SELECT s.id,s.event_code,s.organization ,s.created_by,s.ic_code_consultant,s.student_name,s.mobile1,s.whatsappno,s.email,s.state_name,s.city_name,ir.ic_name,sc.school_code,sc.course,s.remuneration ,s.remuneration_status,s.remuneration_remark,ccd.contact_person,ir.ic_name,ccd.pancard,s.campus_id FROM student_meet_details s 
            left join school_course sc on sc.course_id=s.programme_id and sc.campus_city=s.campus_id
            left join ic_registration ir on s.ic_code_consultant=ir.ic_code 
            left JOIN user_master AS um ON um.`um_id`=s.created_by 
            left JOIN consultants_call_details AS ccd ON ccd.employee_code=um.`employee_code`         
            WHERE s.academic_year='" . $var['academic_year'] . "' $chekuser  $cd $camput $statusfilter  $whe1 ";
            $sql .= " ORDER BY  s.id DESC";

            $query = $this->db->query($sql);

            $result = $query->result_array();


            return $result;
        } else {


            $y = $var['academic_year'];
            if (isset(
                $var['academic_year']
            )) {
                $acd1 = $acd = substr($var['academic_year'], 0, 4);
            } else {
                $y = $acd1 = $this->config->item('current_year');
                $current_year = explode('-', $acd1);
                $acd = $current_year[0];
            }
            $DB1 = $this->load->database('umsdb', TRUE);
            $chekuser = '';
            if ($var['icfilter'] != ''  && $var['icfilter'] != undefined) {
                $chekuser = " and c.ic_code='" . $var['icfilter'] . "' ";
            }

            if ($var['consultant'] != '' && $var['consultant'] != undefined) {
                $cd = " and enquiry_student_master.created_by='" . $var['consultant'] . "' ";
            } else {
                $cd = ' ';
            }

            if ($var['consultant_head'] != '' && $var['consultant_head'] != undefined) {
                $ch = $var['consultant_head'];
                $ss = $this->db->query("select group_concat(ic_code) as ic_code
			from ic_mapping where consultant_head=$ch and status='Y'")->row()->ic_code;
                $ss = explode(",", $ss);
                $ss = "'" . implode("', '", $ss) . "'";
                $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=$ch and status='Y'")->row()->cordinator_id;
                $chd = " and (c.ic_code IN ($ss) OR c.inserted_by='$ch' OR c.consultant_head='$ch' OR c.inserted_by IN ($referred_by) )";
            } else {
                $chd = ' ';
            }


            if ($var['campusfilter'] != '' && $var['campusfilter'] != undefined) {
                $var['campusfilter'] = $var['campusfilter'];
                $camput = " and enquiry_student_master.Campus_City='" . $var['campusfilter'] . "'";
            } else {
                $camput = '';
            }
            $if = '';
            if ($var['icfilter'] != '' && $var['icfilter'] != undefined) {
                $var['icfilter'] = $var['icfilter'];
                $if = " and c.ic_code='" . $var['icfilter'] . "'";
            } else {
                $if = '';
            }


            if ($var['ac'] != '' && $var['ac'] != undefined) {
                $var['ac'] = $var['ac'];
                $ac = " and c.inserted_by='" . $var['ac'] . "'";
            } else {
                $ac = '';
            }


            if ($var['statusfilter'] != '') {
                if ($var['statusfilter'] == "V") {
                    $var['statusfilter'] = "Y";
                } else {
                    $var['statusfilter'] = "N";
                }
                $statusfilter = " and enquiry_student_master.status='" . $var['statusfilter'] . "'";
            } else {
                $statusfilter = '';
            }


            $sql1 = '';
            $sql2 = '';
            if ($role_id == 7) {
                $sql1 = " and  c.ic_code='" . $this->session->userdata('ic_code') . "'";
            } else if ($role_id == 27) {
                $ss = $this->db->query("select group_concat(ic_code) as ic_code
			from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
                $ss = explode(",", $ss);
                $ss = "'" . implode("', '", $ss) . "'";
                $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;
                $sql1 = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.consultant_head='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by) )";
            } else if ($role_id != 1) {

                if ($var['consultant'] != '' && $role_id == 35) {
                } else {
                    $sql1 = " and  c.inserted_by='" . $this->session->userdata('uid') . "'";
                }
            }


            $sql = "select vw.stream_short_name,sm.enrollment_no,
c.contact_person,enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
as remuneration,enquiry_student_master.remark 
as remark,enquiry_student_master.status 
as status,enquiry_student_master.Campus_City,
enquiry_student_master.Campus
from  sandipun_ums.enquiry_student_master 
join student_master sm on sm.enquiry_id=enquiry_student_master.enquiry_id
join vw_stream_details vw on sm.admission_stream=vw.stream_id
join " . currentdb . ".user_master u on u.um_id=enquiry_student_master.created_by
join " . currentdb . ".consultants_call_details c on c.employee_code=u.employee_code 
where enquiry_student_master.admission_session='$acd'
 $sql1 and enquiry_student_master.is_from_consultant=1 $statusfilter $camput $cd $chd $ac $if ";

            $sql .= " ORDER BY enquiry_student_master.enquiry_id DESC";

            $query = $DB1->query($sql);
            $result = $query->result();
            $rers = " and (fs.type_id=2 )";
            $sql = "select  vw.stream_short_name,sm.enrollment_no,
c.contact_person,enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
as remuneration,enquiry_student_master.remark 
as remark,enquiry_student_master.status 
as status,enquiry_student_master.Campus_City,
enquiry_student_master.Campus
from  sandipun_ums.enquiry_student_master 
join sandipun_ums_sijoul.student_master sm on sm.stud_id=enquiry_student_master.stude_id
join vw_stream_details vw on sm.admission_stream=vw.stream_id
join  sandipun_ums_sijoul.fees_challan fs on sm.stud_id=fs.student_id
join " . currentdb . ".user_master u on u.um_id=enquiry_student_master.created_by
join " . currentdb . ".consultants_call_details c on ( c.employee_code=u.employee_code OR c.id=u.con_id)
where enquiry_student_master.admission_session='$acd'
 $sql1 and enquiry_student_master.is_from_consultant=1 $statusfilter $camput $cd $chd $ac $if  $rers";

            $sql .= " ORDER BY enquiry_student_master.enquiry_id DESC";
            ##echo $sql;
            ##exit;
            $query = $DB1->query($sql);
            $result1 = $query->result();

            $result = array_merge($result, $result1);

            $array = array();
            if (!empty($result)) {

                foreach ($result as $row) {
                    $row->event_code = 'Consultant';
                    $row->student_name = $row->first_name . " " . $row->middle_name . " " . $row->last_name;
                    $row->remuneration_status = $row->status;
                    $row->remuneration_remark = $row->remark;
                    $row->school_code = '';
                    $row->course = '';
                    $row->state_name = '';
                    $row->city_name = '';
                    $row->Country = 'India';
                    if ($row->Campus_City == 1 && $row->Campus == "SUN") {
                        $school_id = $row->school_id;
                        $course_id = $row->course_id;
                        $get_course_details = "SELECT sandipun_ums.vw_stream_details.* from sandipun_ums.vw_stream_details where sandipun_ums.vw_stream_details.school_id=" . $school_id . " and sandipun_ums.vw_stream_details.course_id=" . $course_id;

                        $query = $this->db->query($get_course_details);
                        $get_course_detailsresult = $query->row();
                        if (!empty($get_course_detailsresult)) {
                            $row->school_code = $get_course_detailsresult->school_short_name;
                            $row->course = $get_course_detailsresult->course_name;
                        }
                    } else if ($row->Campus_City == 2 && $row->Campus == "SIJOUL") {
                        $school_id = $row->school_id;
                        $course_id = $row->course_id;
                        $get_course_details = "SELECT sandipun_ums_sijoul.vw_stream_details.* from sandipun_ums_sijoul.vw_stream_details where sandipun_ums_sijoul.vw_stream_details.school_id=" . $school_id . " and sandipun_ums_sijoul.vw_stream_details.course_id=" . $course_id;

                        $query = $this->db->query($get_course_details);
                        $get_course_detailsresult = $query->row();
                        if (!empty($get_course_detailsresult)) {
                            $row->school_code = $get_course_detailsresult->school_short_name;
                            $row->course = $get_course_detailsresult->course_name;
                        }
                    } else {
                        $course_id = $row->course_id;
                        $Campus_City = $row->Campus_City;
                        $get_course_details = "select * from school_course sc where sc.course_id=$course_id and sc.campus_city=$Campus_City";
                        $query = $this->db->query($get_course_details);
                        $get_course_detailsresult = $query->row();
                        if (!empty($get_course_detailsresult)) {
                            $row->school_code = $get_course_detailsresult->school_code;
                            $row->course = $get_course_detailsresult->course;
                        }
                    }
                    if ($row->nationality == 1) {

                        $get_add_details = "select states.state_name,taluka_master.taluka_name as city_name from enquiry_student_master join  states 
on enquiry_student_master.state_id=states.state_id join  taluka_master
on  enquiry_student_master.city_id=taluka_master.taluka_id where enquiry_student_master.enquiry_id=" . $row->id;
                        $get_add_details = $DB1->query($get_add_details);
                        $get_add_details = $get_add_details->row();
                        if (!empty($get_add_details)) {
                            $row->state_name = $get_add_details->state_name;
                            $row->city_name = $get_add_details->city_name;
                            $row->Country = 'India';
                        }
                    } else if ($row->nationality == 2) {

                        $get_add_details = "select  " . currentdb . ".countries.name as country_name,  " . currentdb . ".states.name as state_name, " . currentdb . ".cities.name as city_name from sandipun_ums.enquiry_student_master join  states 
on sandipun_ums.enquiry_student_master.int_state= " . currentdb . ".states.id join   " . currentdb . ".cities
on  sandipun_ums.enquiry_student_master.int_city= " . currentdb . ".cities.id join   " . currentdb . ".countries
on  sandipun_ums.enquiry_student_master.int_country_id= " . currentdb . ".countries.id where sandipun_ums.enquiry_student_master.enquiry_id=" . $row->id;
                        $get_add_details = $this->db->query($get_add_details);
                        $get_add_details = $get_add_details->row();
                        if (!empty($get_add_details)) {
                            $row->state_name = $get_add_details->state_name;
                            $row->city_name = $get_add_details->city_name;
                            $row->Country = $get_add_details->country_name;
                        }
                    }


                    //print_r($row);exit;


                    $array[] = $row;
                }
            }
            $array = json_decode(json_encode($array), TRUE);
            //exit;
            return $array;
        }
        //

    }



    function get_weventcode_byIc($ic_code = '')
    {

        if (isset($ic_code) && $ic_code != " ") {
            $s = " where EV.academic_year='" . $this->config->item('ic_year') . "' and  EV.`status` = 'Y' ";
        } else {
            $s = '';
        }
        $sql = "select EV.*  from  webiner_event_details EV     $s group by EV.event_code
        ";
        $query = $this->db->query($sql);
        // echo $sql;//exit;
        return $query->result_array();
    }

    function get_webventdetail_byCode($ev_code = '')
    {

        if (isset($ev_code) && $ev_code != " ") {
            $s = " where EV.event_code='" . $ev_code . "' and  EV.`status` = 'Y' ";
        } else {
            $s = '';
        }
        $sql = "select EV.*  from  webiner_event_details EV    $s group by EV.event_code
        ";
        $query = $this->db->query($sql);
        return $query->result_array();
    }


    function get_webventdetail_byCode1($ev_code = '')
    {

        if (isset($ev_code) && $ev_code != " ") {
            $s = " where EV.event_id='" . $ev_code . "' and  EV.`status` = 'Y' ";
        } else {
            $s = '';
        }
        $sql = "select EV.*  from  webiner_event_details EV    $s group by EV.event_code
        ";
        $query = $this->db->query($sql);
        return $query->result_array();
    }


    function insert_web_student_data($data)
    {
        //print_r($data);exit;



        $arr['ic_code'] = $data['ic_code'];
        $arr['event_code'] = $data['event_code'];
        $arr['student_name'] = $data['student_name'];
        $arr['gender'] = $data['gender'];
        $arr['dob'] = $data['dob'];
        $arr['mobile1'] = $data['mobile1'];
        $arr['reference'] = $data['reference'];

        $arr['country_id'] = $data['country_id'];
        $arr['country_name'] = $data['country_name'];
        $arr['state_id'] = $data['state'];
        $arr['state_name'] = $data['state_name'];
        $arr['city_id'] = $data['city'];
        $arr['city_name'] = $data['city_name'];

        $arr['email'] = $data['email'];


        $arr['created_by'] = $this->session->userdata('uid');
        $arr['created_date'] = date('Y-m-d H:i:s');
        $arr['academic_year'] = $data['academic_year'];
        $arr['status'] = 'Y';


        $ins = $this->db->insert('webiner_student_meet_details', $arr);
        $ins_id = $this->db->insert_id();
        if ($data['courseInterested'] != '') {
            foreach ($data['courseInterested'] as $key => $value) {
                $exp = explode("|", $value);

                $arr1['student_id'] = $ins_id;
                $arr1['course_id'] = $exp[0];
                $arr1['course_name'] = $exp[1];
                $arr1['inserted_by'] = $this->session->userdata('uid');
                $arr1['inserted_at'] = date('Y-m-d H:i:s');
                $ins = $this->db->insert('web_smd_interested_course', $arr1);
            }
        }


        return   $ins_id;
    }



    function fetch_web_student_meetdetails($var = array(), $start = '', $limit = '')
    {
        $userID = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');

        if ($role_id == '1') {

            if ($var['icfilter'] != '') {
                $chekuser = " and s.ic_code='" . $var['icfilter'] . "' ";
            } else {
                // $chekuser ="1";
            }
        } elseif ($role_id == '4' || $role_id == '8' || $role_id == '7') {
            $ic_code = $this->session->userdata('ic_code');
            $chekuser = " and s.ic_code='$ic_code' ";
        } else {
            $chekuser = " and s.created_by = '$userID'";
        }
        if ($var['evtfilter'] != '') {
            $ev = " and s.event_code='" . $var['evtfilter'] . "'";
        }


        $sql = "SELECT s.*,ir.ic_name  FROM webiner_student_meet_details s 
        left join webiner_event_details e on e.event_code = s.event_code 
		left join ic_registration ir on s.ic_code=ir.ic_code 
        WHERE s.academic_year='" . $this->config->item('ic_year') . "' $chekuser $ev ";
        $sql .= " ORDER BY  s.id DESC ";
        //$sql .= " LIMIT $start, $limit";
        $query = $this->db->query($sql);
        $result = $query->result_array();
        //echo $this->db->last_query();exit;
        return $result;
    }

    function get_student_interested_courses1($std = '')
    {
        $sql = "select id,course_id,course_name from web_smd_interested_course where student_id='" . $std . "' and status='Y' ";
        // exit;
        $query = $this->db->query($sql);
        // echo $this->db->last_query();
        $res = $query->result_array();

        return $res;
    }

    public function get_student_details_web($studentid = '')
    {
        $sql = "SELECT * FROM webiner_student_meet_details s         
            WHERE s.id='" . $studentid . "'";
        $query = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }


    function update_student_details_web($data = '', $studentId = '')
    {
        // print_r($data);exit;
        $arr['student_name'] = $data['student_name'];
        $arr['gender'] = $data['gender'];
        $arr['dob'] = $data['dob'];
        $arr['mobile1'] = $data['mobile1'];

        $arr['country_id'] = $data['country_id'];
        $arr['country_name'] = $data['country_name'];
        $arr['state_id'] = $data['state'];
        $arr['state_name'] = $data['state_name'];
        $arr['city_id'] = $data['city'];
        $arr['city_name'] = $data['city_name'];
        $arr['reference'] = $data['reference'];
        $arr['email'] = $data['email'];

        $arr['academic_year'] = $data['academic_year'];
        $arr['status'] = 'Y';


        $arr['updated_by'] = $this->session->userdata('uid');
        $arr['updated_date'] = date('Y-m-d H:i:s');

        $this->db->where('id', $studentId);
        $uid = $this->db->update('webiner_student_meet_details', $arr);

        $parr = array();
        $uparr = array();
        $cri = $this->get_student_interested_courses1($studentId = '');
        foreach ($cri as $key => $value) {
            $parr[$value['id']] = $value['course_id'];
        }
        foreach ($data['courseInterested'] as $key => $value) {
            $exp = explode("|", $value);
            $uparr[$exp[1]] = $exp[0];
        }


        $adiff = array_merge($parr, $uparr);
        $farr = array_unique($adiff);
        //print_r($farr);

        foreach ($farr as $key => $value) {
            if (!in_array($value, $parr) && in_array($value, $uparr)) {
                $arr1['student_id'] = $studentId;
                $arr1['course_id'] = $value;
                $arr1['course_name'] = $key;
                $arr1['inserted_by'] = $this->session->userdata('uid');
                $arr1['inserted_at'] = date('Y-m-d H:i:s');
                $ins1 = $this->db->insert('web_smd_interested_course', $arr1);
            } elseif (in_array($value, $parr) && !in_array($value, $uparr)) {
                $cid = array_search($value, $parr);
                $r['status'] = 'N';
                $r['modified_by'] = $this->session->userdata('uid');
                $r['modified_at'] = date('Y-m-d H:i:s');
                $this->db->where('id', $cid);
                $uid1 = $this->db->update('web_smd_interested_course', $r);
                //echo $this->db->last_query();exit;
            }
        }
        //exit;
        // if(!empty($data['exm_pre'])){
        // $pexmarr=$data['exm_pre'];
        // }else{
        //     $pexmarr=array();
        // }

        // foreach ($data['mock_exm'] as $key => $value) {
        //      $ex_typ[$value]='MOCK';
        //  $up_exmarr[]=$value;

        // }
        // foreach ($data['sujee_exm'] as $key => $value) {
        //       $ex_typ[$value]='SUJEE';
        //     $up_exmarr[]=$value;
        // }
        // $final_exam=array_merge($pexmarr,$up_exmarr);
        // $final_examu = array_unique($final_exam);
        //print_r($data['mock_exm']);
        //print_r($data['sujee_exm']);
        //print_r($pexmarr);
        //print_r($ex_typ);
        //print_r($up_exmarr);
        //print_r($final_exam);
        //print_r($final_examu);
        //exit;
        // foreach ($final_examu as $key => $value) {
        //    if(!in_array($value,$pexmarr) && in_array($value, $up_exmarr)){


        //     $exm2['student_id']=$studentId;
        // $exm2['exam_no']=$value;
        // $exm2['exam_type']=$data['exam_type_'.$value];
        // $exm2['exam_name']=$ex_typ[$value];
        // $exm2['exam_date']=$data['exam_date_'.$value];
        //   // $i= $this->insert_student_exam($exm2);

        //    }elseif(in_array($value,$pexmarr) && !in_array($value, $up_exmarr)){
        //     $cid= array_search($value, $pexmarr);

        //     $r['is_active']='N';
        //      $r['updated_by']=$this->session->userdata('uid');
        //           $r['updated_at']= date('Y-m-d H:i:s');
        //     $this->db->where('sujee_id', $cid);
        //      // $uid12= $this->db->update('su_jee_registration', $r);
        //        //echo $this->db->last_query();exit;
        //    }


        //}

        return  $uid;
    }

    function get_leads()
    {
        $cyear = $this->config->item('current_year');
        return $this->db->query(" SELECT distinct(utm_source) as utm_source from student_meet_details where academic_year='$cyear'  
        and utm_source!='ic_data'  group by utm_source")->result_array();
    }


    function get_programs()
    {
        $cyear = $this->config->item('current_year');
        return $this->db->query(" SELECT distinct(sp.sprogramm_name) as course,sp.sp_id  from sandipun_univerdb.school_programs_new as sp 
		join student_meet_details on student_meet_details.programme_id=sp.sp_id
		where student_meet_details.academic_year='$cyear' and student_meet_details.utm_source!='College Duniya' and student_meet_details.utm_source!='Reviewadda' 
        and student_meet_details.utm_source!='ic_data'  group by student_meet_details.utm_source")->result_array();
    }





    function get_data($data)
    {
        if ($data) {


            $sql = '';
            $progm_con = '';
            $pg_com = '';
            if (!empty($data['programme_id']) && $data['programme_id'] != '' && $data['programme_id'] != 'undefined') {
                $progm_con = " and sn.programme_id='" . $data['programme_id'] . "'";
                $pg_com = " and s.programme_id='" . $data['programme_id'] . "'";
            } else {
                $progm_con = " and sn.programme_id=s.programme_id ";
            }
            if (!empty($data['academic_year']) && $data['academic_year'] != '' && $data['academic_year'] != 'undefined') {
                $cyear = $data['academic_year'];
            } else {
                $cyear = $this->config->item('current_year');
            }
            $c = explode('-', $cyear);
            $c = $c[0];
            if ($data['report_type'] == 1) {
                $sql = "SELECT (select count(sm.stud_id) from sandipun_ums.student_master as sm join student_meet_details sn on sm.mobile=sn.mobile1 where sm.academic_year='$c'   $progm_con and
sn.ic_code='digital' and sn.event_code='EV/DG/1' and sn.utm_source=s.utm_source and sn.academic_year='$cyear' and sm.enrollment_no !='' and sm.enrollment_no IS NOT NULL  ) as provisionl_count,
(select count(sm.stud_id) from sandipun_ums.student_master as sm join student_meet_details sn on sm.mobile=sn.mobile1 where sm.academic_year='$c' and 
sn.ic_code='digital' and sn.event_code='EV/DG/1' and sn.utm_source=s.utm_source and sm.admission_confirm='Y' and sn.academic_year='$cyear' and sm.enrollment_no !='' and sm.enrollment_no IS NOT NULL $progm_con ) as confirm_count,s.programme_id,sp.sprogramm_name as course,s.utm_source, COUNT(s.id) AS total, COUNT(max.c_ids) AS CALLDONE,s.utm_campaign,DATE(s.created_date) AS created_date, 
SUM(CASE WHEN s.admission_type ='P' THEN 1 ELSE 0 END) AS PARTIME, SUM(CASE WHEN s.admission_type !='P' THEN 1 ELSE 0 END) AS REGULAR, 
SUM(CASE WHEN max.calling_status='INTERESTED' OR max.calling_status='SUCCESS' THEN 1 ELSE 0 END) AS CALLINTERESTED, SUM(CASE WHEN max.calling_status='CALL-LATER' 
THEN 1 ELSE 0 END) AS call_later, SUM(CASE WHEN max.calling_status='NOT-INTERESTED' THEN 1 ELSE 0 END) AS CALLNOTINTERESTED, 
SUM(CASE WHEN max.calling_status='IN-VALID' THEN 1 ELSE 0 END) AS CALLINVALID, SUM(CASE WHEN max.calling_status='NOT-ELIGIBLE' THEN 1 ELSE 0 END) AS CALLNOTELIGIBLE
, SUM(CASE WHEN max.calling_status='NOT-RECHABLE' THEN 1 ELSE 0 END) AS CALLNOTREACABLE, SUM(CASE WHEN max.calling_status='RINGING' THEN 1 ELSE 0 END) AS CALLRINGING
, SUM(CASE WHEN max.calling_status='CAMPUS-VISIT' THEN 1 ELSE 0 END) AS CALLCAMPUSVISIT, SUM(CASE WHEN max.calling_status='IC_VISIT' THEN 1 ELSE 0 END) AS CALLICVISIT FROM student_meet_details AS s 
left JOIN (SELECT MAX(cs.c_id) AS c_ids,cs.calling_status,cs.student_id FROM calling_log_details as cs GROUP BY mobile_no,student_id) max
 ON s.id = max.student_id
left join sandipun_univerdb.school_programs_new  as sp on s.programme_id=sp.sp_id
 WHERE s.ic_code='digital' and s.event_code='EV/DG/1' and s.academic_year = '$cyear' and s.utm_source !='' and s.programme_id!='' 
$pg_com
 group by s.programme_id order by s.programme_id";
            } elseif ($data['report_type'] == 2) {
                $sql = " SELECT ic.ic_name as ic_name,(select count(sm.stud_id) from sandipun_ums.student_master as sm join student_meet_details sn on sm.mobile=sn.mobile1 where sm.academic_year='$c'  and  sn.programme_id=s.programme_id and
sn.ic_code!='digital'  and sn.ic_code=s.ic_code  and sn.academic_year='$cyear' and sm.enrollment_no !='' and sm.enrollment_no IS NOT NULL  ) as provisionl_count,
(select count(sm.stud_id) from sandipun_ums.student_master as sm join student_meet_details sn on sm.mobile=sn.mobile1 where sm.academic_year='$c' and 
sn.ic_code!='digital'   and  sn.programme_id=s.programme_id and sm.admission_confirm='Y' and sn.academic_year='$cyear' and sm.enrollment_no !='' and sm.enrollment_no IS NOT NULL ) as confirm_count,s.ic_code,s.programme_id,sp.sprogramm_name as course,s.utm_source, COUNT(s.id) AS total, COUNT(max.c_ids) AS CALLDONE,s.utm_campaign,DATE(s.created_date) AS created_date, 
SUM(CASE WHEN s.admission_type ='P' THEN 1 ELSE 0 END) AS PARTIME, SUM(CASE WHEN s.admission_type !='P' THEN 1 ELSE 0 END) AS REGULAR, 
SUM(CASE WHEN max.calling_status='INTERESTED' OR max.calling_status='SUCCESS' THEN 1 ELSE 0 END) AS CALLINTERESTED, SUM(CASE WHEN max.calling_status='CALL-LATER' 
THEN 1 ELSE 0 END) AS call_later, SUM(CASE WHEN max.calling_status='NOT-INTERESTED' THEN 1 ELSE 0 END) AS CALLNOTINTERESTED, 
SUM(CASE WHEN max.calling_status='IN-VALID' THEN 1 ELSE 0 END) AS CALLINVALID, SUM(CASE WHEN max.calling_status='NOT-ELIGIBLE' THEN 1 ELSE 0 END) AS CALLNOTELIGIBLE
, SUM(CASE WHEN max.calling_status='NOT-RECHABLE' THEN 1 ELSE 0 END) AS CALLNOTREACABLE, SUM(CASE WHEN max.calling_status='RINGING' THEN 1 ELSE 0 END) AS CALLRINGING
, SUM(CASE WHEN max.calling_status='CAMPUS-VISIT' THEN 1 ELSE 0 END) AS CALLCAMPUSVISIT, SUM(CASE WHEN max.calling_status='IC_VISIT' THEN 1 ELSE 0 END) AS CALLICVISIT FROM student_meet_details AS s 
left JOIN (SELECT MAX(cs.c_id) AS c_ids,cs.calling_status,cs.student_id FROM calling_log_details as cs GROUP BY mobile_no,student_id) max
 ON s.id = max.student_id
left join sandipun_univerdb.school_programs_new  as sp on s.programme_id=sp.sp_id 
left join ic_registration  ic on ic.ic_code=s.ic_code
 WHERE s.ic_code!='digital' and s.academic_year = '$cyear'  and s.programme_id!='' 

 group by s.programme_id,s.ic_code order by s.programme_id";
            } elseif ($data['report_type'] == 3) {
                $sql = "  SELECT (select count(sm.stud_id) from sandipun_ums.student_master as sm join student_meet_details sn on sm.mobile=sn.mobile1 where sm.academic_year='$c'  and
sn.ic_code='digital' and sn.event_code='EV/DG/1'  and sn.academic_year='$cyear' and sm.enrollment_no !='' and sm.enrollment_no IS NOT NULL and sn.programme_id IS NOT NULL ) as provisionl_count,
(select count(sm.stud_id) from sandipun_ums.student_master as sm join student_meet_details sn on sm.mobile=sn.mobile1 where sm.academic_year='$c' and 
sn.ic_code='digital' and sn.event_code='EV/DG/1' and sm.admission_confirm='Y' and sn.academic_year='$cyear' and sm.enrollment_no !='' and sm.enrollment_no IS NOT NULL  and sn.programme_id IS NOT NULL) as confirm_count,s.programme_id,sp.sprogramm_name as course,s.utm_source, COUNT(s.id) AS total, COUNT(max.c_ids) AS CALLDONE,s.utm_campaign,DATE(s.created_date) AS created_date, 
SUM(CASE WHEN s.admission_type ='P' THEN 1 ELSE 0 END) AS PARTIME, SUM(CASE WHEN s.admission_type !='P' THEN 1 ELSE 0 END) AS REGULAR, 
SUM(CASE WHEN max.calling_status='INTERESTED' OR max.calling_status='SUCCESS' THEN 1 ELSE 0 END) AS CALLINTERESTED, SUM(CASE WHEN max.calling_status='CALL-LATER' 
THEN 1 ELSE 0 END) AS call_later, SUM(CASE WHEN max.calling_status='NOT-INTERESTED' THEN 1 ELSE 0 END) AS CALLNOTINTERESTED, 
SUM(CASE WHEN max.calling_status='IN-VALID' THEN 1 ELSE 0 END) AS CALLINVALID, SUM(CASE WHEN max.calling_status='NOT-ELIGIBLE' THEN 1 ELSE 0 END) AS CALLNOTELIGIBLE
, SUM(CASE WHEN max.calling_status='NOT-RECHABLE' THEN 1 ELSE 0 END) AS CALLNOTREACABLE, SUM(CASE WHEN max.calling_status='RINGING' THEN 1 ELSE 0 END) AS CALLRINGING
, SUM(CASE WHEN max.calling_status='CAMPUS-VISIT' THEN 1 ELSE 0 END) AS CALLCAMPUSVISIT, SUM(CASE WHEN max.calling_status='IC_VISIT' THEN 1 ELSE 0 END) AS CALLICVISIT FROM student_meet_details AS s 
left JOIN (SELECT MAX(cs.c_id) AS c_ids,cs.calling_status,cs.student_id FROM calling_log_details as cs GROUP BY mobile_no,student_id) max
 ON s.id = max.student_id
left join sandipun_univerdb.school_programs_new  as sp on s.programme_id=sp.sp_id
 WHERE s.ic_code='digital' and s.event_code='EV/DG/1' and s.academic_year = '$cyear' and s.utm_source !='' and s.programme_id!=''";
            } elseif ($data['report_type'] == 4) {
                $sql = " SELECT (select count(sm.stud_id) from sandipun_ums.student_master as sm join student_meet_details sn on sm.mobile=sn.mobile1 where sm.academic_year='$c'  and
sn.ic_code!='digital'   and sn.academic_year='$cyear' and sm.enrollment_no !='' and sm.enrollment_no IS NOT NULL  ) as provisionl_count,
(select count(sm.stud_id) from sandipun_ums.student_master as sm join student_meet_details sn on sm.mobile=sn.mobile1 where sm.academic_year='$c' and 
sn.ic_code!='digital'  and sm.admission_confirm='Y' and sn.academic_year='$cyear' and sm.enrollment_no !='' and sm.enrollment_no IS NOT NULL  ) as confirm_count,s.ic_code,s.programme_id,sp.sprogramm_name as course,s.utm_source, COUNT(s.id) AS total, COUNT(max.c_ids) AS CALLDONE,s.utm_campaign,DATE(s.created_date) AS created_date, 
SUM(CASE WHEN s.admission_type ='P' THEN 1 ELSE 0 END) AS PARTIME, SUM(CASE WHEN s.admission_type !='P' THEN 1 ELSE 0 END) AS REGULAR, 
SUM(CASE WHEN max.calling_status='INTERESTED' OR max.calling_status='SUCCESS' THEN 1 ELSE 0 END) AS CALLINTERESTED, SUM(CASE WHEN max.calling_status='CALL-LATER' 
THEN 1 ELSE 0 END) AS call_later, SUM(CASE WHEN max.calling_status='NOT-INTERESTED' THEN 1 ELSE 0 END) AS CALLNOTINTERESTED, 
SUM(CASE WHEN max.calling_status='IN-VALID' THEN 1 ELSE 0 END) AS CALLINVALID, SUM(CASE WHEN max.calling_status='NOT-ELIGIBLE' THEN 1 ELSE 0 END) AS CALLNOTELIGIBLE
, SUM(CASE WHEN max.calling_status='NOT-RECHABLE' THEN 1 ELSE 0 END) AS CALLNOTREACABLE, SUM(CASE WHEN max.calling_status='RINGING' THEN 1 ELSE 0 END) AS CALLRINGING
, SUM(CASE WHEN max.calling_status='CAMPUS-VISIT' THEN 1 ELSE 0 END) AS CALLCAMPUSVISIT, SUM(CASE WHEN max.calling_status='IC_VISIT' THEN 1 ELSE 0 END) AS CALLICVISIT FROM student_meet_details AS s 
left JOIN (SELECT MAX(cs.c_id) AS c_ids,cs.calling_status,cs.student_id FROM calling_log_details as cs GROUP BY mobile_no,student_id) max
 ON s.id = max.student_id
left join sandipun_univerdb.school_programs_new  as sp on s.programme_id=sp.sp_id
 WHERE s.ic_code!='digital' and s.academic_year = '$cyear'  
 ";
            } elseif ($data['report_type'] == 5) {
                $sql = "  SELECT (select count(sm.stud_id) from sandipun_ums.student_master as sm join student_meet_details sn on sm.mobile=sn.mobile1 where sm.academic_year='$c'  and
sn.ic_code='digital' and sn.event_code='EV/DG/1' and sn.utm_source=s.utm_source and sn.academic_year='$cyear' and sm.enrollment_no !='' and sm.enrollment_no IS NOT NULL  ) as provisionl_count,
(select count(sm.stud_id) from sandipun_ums.student_master as sm join student_meet_details sn on sm.mobile=sn.mobile1 where sm.academic_year='$c' and 
sn.ic_code='digital' and sn.event_code='EV/DG/1' and sn.utm_source=s.utm_source and sm.admission_confirm='Y' and sn.academic_year='$cyear' and sm.enrollment_no !='' and sm.enrollment_no IS NOT NULL ) as confirm_count,s.programme_id,sp.stream_name as course,s.utm_source, COUNT(s.id) AS total, COUNT(max.c_ids) AS CALLDONE,s.utm_campaign,DATE(s.created_date) AS created_date, 
SUM(CASE WHEN s.admission_type ='P' THEN 1 ELSE 0 END) AS PARTIME, SUM(CASE WHEN s.admission_type !='P' THEN 1 ELSE 0 END) AS REGULAR, 
SUM(CASE WHEN max.calling_status='INTERESTED' OR max.calling_status='SUCCESS' THEN 1 ELSE 0 END) AS CALLINTERESTED, SUM(CASE WHEN max.calling_status='CALL-LATER' 
THEN 1 ELSE 0 END) AS call_later, SUM(CASE WHEN max.calling_status='NOT-INTERESTED' THEN 1 ELSE 0 END) AS CALLNOTINTERESTED, 
SUM(CASE WHEN max.calling_status='IN-VALID' THEN 1 ELSE 0 END) AS CALLINVALID, SUM(CASE WHEN max.calling_status='NOT-ELIGIBLE' THEN 1 ELSE 0 END) AS CALLNOTELIGIBLE
, SUM(CASE WHEN max.calling_status='NOT-RECHABLE' THEN 1 ELSE 0 END) AS CALLNOTREACABLE, SUM(CASE WHEN max.calling_status='RINGING' THEN 1 ELSE 0 END) AS CALLRINGING
, SUM(CASE WHEN max.calling_status='CAMPUS-VISIT' THEN 1 ELSE 0 END) AS CALLCAMPUSVISIT, SUM(CASE WHEN max.calling_status='IC_VISIT' THEN 1 ELSE 0 END) AS CALLICVISIT FROM student_meet_details AS s 
left JOIN (SELECT MAX(cs.c_id) AS c_ids,cs.calling_status,cs.student_id FROM calling_log_details as cs GROUP BY mobile_no,student_id) max
 ON s.id = max.student_id
left join su_sf_sijoul_stream_details  as sp on s.programme_id=sp.stream_id and sp.belongtocampus=s.campus_id
 WHERE s.ic_code='digital' and s.event_code='EV/DG/1' and s.academic_year = '$cyear' and s.utm_source !='' and s.programme_id!='' 

 group by s.utm_source";
            }


            return $this->db->query($sql)->result_array();
        } else {
            return array();
        }
    }

    function  get_data_utm($data)
    {

        if ($data) {
            $progm_con = '';
            $pg_com = '';
            if (!empty($data['programme_id']) && $data['programme_id'] != '' && $data['programme_id'] != 'undefined') {
                $progm_con = " and sn.programme_id='" . $data['programme_id'] . "'";
                $pg_com = " and s.programme_id='" . $data['programme_id'] . "'";
            }
            if (!empty($data['academic_year']) && $data['academic_year'] != '' && $data['academic_year'] != 'undefined') {
                $cyear = $data['academic_year'];
            } else {
                $cyear = $this->config->item('current_year');
            }
            $c = explode('-', $cyear);
            $c = $c[0];
            $sql = " SELECT DISTINCT(s.utm_source)  FROM student_meet_details AS s 

 WHERE s.ic_code='digital' and s.event_code='EV/DG/1' and s.academic_year = '$cyear' and s.utm_source !='' and s.programme_id!='' $pg_com
group by s.programme_id order by s.programme_id";


            return $this->db->query($sql)->result_array();
        }
    }

    function  get_data_utm_lead($data, $programme_id = '', $utm_source = '')
    {

        if ($data) {
            $progm_con = '';
            $pg_com = '';
            if ($programme_id != '') {
                $progm_con = " and s.programme_id='" . $programme_id . "'";
            }
            if ($utm_source != '') {
                $utm_con = " and s.utm_source='" . $utm_source . "'";
            }
            if (!empty($data['academic_year']) && $data['academic_year'] != '' && $data['academic_year'] != 'undefined') {
                $cyear = $data['academic_year'];
            } else {
                $cyear = $this->config->item('current_year');
            }
            $c = explode('-', $cyear);
            $c = $c[0];
            $sql = " SELECT COALESCE(COUNT(s.id),0) as scount  FROM student_meet_details AS s 
left join sandipun_univerdb.school_programs_new  as sp on s.programme_id=sp.sp_id
 WHERE s.ic_code='digital' and s.event_code='EV/DG/1' and s.academic_year = '$cyear' and s.utm_source !='' and s.programme_id!='' $progm_con $utm_con group by s.programme_id order by s.programme_id";
            return $this->db->query($sql)->row()->scount;
        }
    }


    function get_students_data($year = '', $type = '', $is_ic = '', $ic_code = '', $is_digital_source = '', $utm_source = '', $course_id = '', $data_to_consider = '')

    {

        $cons = "";
        $year = base64_decode($year);
        $type = base64_decode($type);
        $is_ic = base64_decode($is_ic);
        $ic_code = base64_decode($ic_code);
        $is_digital_source = base64_decode($is_digital_source);
        $utm_source = base64_decode($utm_source);


        $course_id = base64_decode($course_id);
        $data_to_consider = base64_decode($data_to_consider);
        $type_con = '';
        $ic_con = '';
        $utm_source_con = '';
        $course_id_con = '';
        $sc_con = "";
        $sc_con1 = "";
        $sc_con2 = "";
        $joinc = "";

        $whr_con_for_prov = "";
        if ($data_to_consider == "DIGITAL") {
            $sc_con = " and s.ic_code='digital' and s.event_code='EV/DG/1' and s.programme_id!=''";
        } elseif ($data_to_consider == "ICWISE") {
            $sc_con = " and s.ic_code!='digital' ";
        }


        if ($is_ic == "1") {
            $sc_con1 = " and s.ic_code='$ic_code' ";
        } elseif ($is_digital_source == "1") {

            if ($utm_source == 'College Duniya') {
                $sc_con1 = " and (s.utm_source = 'College Duniya' or s.utm_source = 'College Dunia') ";
            } else {
                $sc_con1 = " and s.utm_source='$utm_source' ";
            }
            //
        }

        if ($course_id != "0") {
            $course_id_con = " and s.programme_id='$course_id' ";
        }

        if ($type != 0) {
            if ($type != 15 && $type != 14) {
                if ($type != 1) {
                    $joinc = " left JOIN (SELECT MAX(cs.c_id) AS c_ids,cs.calling_status,cs.student_id FROM calling_log_details as cs GROUP BY mobile_no,student_id) max
				ON s.id = max.student_id ";
                }

                if ($type == 2) {

                    $type_con = "  ";
                    $joinc = " JOIN (SELECT MAX(cs.c_id) AS c_ids,cs.calling_status,cs.student_id FROM calling_log_details as cs GROUP BY mobile_no,student_id) max
				ON s.id = max.student_id ";
                } elseif ($type == 3) {
                    $type_con = " and  s.admission_type ='P' ";
                } elseif ($type == 4) {
                    $type_con = " and s.admission_type !='P' ";
                } elseif ($type == 5) {
                    $type_con = " and ( max.calling_status='INTERESTED' OR max.calling_status='SUCCESS') ";
                } elseif ($type == 6) {
                    $type_con = " and  max.calling_status='CALL-LATER' ";
                } elseif ($type == 7) {
                    $type_con = " and  max.calling_status='NOT-INTERESTED' ";
                } elseif ($type == 8) {
                    $type_con = " and  max.calling_status='IN-VALID' ";
                } elseif ($type == 9) {
                    $type_con = " and  max.calling_status='NOT-ELIGIBLE' ";
                } elseif ($type == 10) {
                    $type_con = " and  max.calling_status='NOT-RECHABLE' ";
                } elseif ($type == 11) {
                    $type_con = " and  max.calling_status='RINGING' ";
                } elseif ($type == 12) {
                    $type_con = " and  max.calling_status='CAMPUS-VISIT' ";
                } elseif ($type == 13) {
                    $type_con = " and  max.calling_status='IC_VISIT' ";
                }
            } else {
                $cons = " v.stream_name  as course,";
                $joinc = " join sandipun_ums.student_master as sm on sm.mobile=s.mobile1 join sandipun_ums.vw_stream_details  as v  ON v.stream_id=sm.admission_stream ";
                $c = explode('-', $year);
                $c = $c[0];

                if ($type == '14') {

                    $whr_con_for_prov = ' and sm.enrollment_no !="" and sm.enrollment_no IS NOT NULL and sm.admission_session="' . $c . '" 
					and sm.academic_year="' . $c . '"';
                } else {
                    $whr_con_for_prov = ' and sm.enrollment_no !="" and sm.enrollment_no IS NOT NULL and sm.admission_session="' . $c . '" 
					and sm.academic_year="' . $c . '" and sm.admission_confirm="Y"';
                }
            }
        }

        if ($year != "") {
            $sc_con2 = "  s.academic_year='$year' ";
        }




        $sql = "select $cons CONCAT(iu.fname,' ',iu.lname) as caller_name ,s.*,ld.id as std_id,s.id as student_id,ld.calling_status as lcalling_status,sp.* from student_meet_details as s left join sandipun_univerdb.school_programs_new  as sp on s.programme_id=sp.sp_id  
		LEFT JOIN
 (SELECT  *
            FROM    calling_log_details  
            GROUP BY student_id order by c_id desc)
		 as ld1
         on ld1.student_id=s.id  
		left join ( SELECT  stud_id,id,calling_status,lead_assign
            FROM    lead_assign_details where academic_year='$year' 
            GROUP BY stud_id order by id desc) as ld on ld.stud_id=s.id
        left join ic_users iu on iu.um_id=ld.lead_assign
		$joinc where $sc_con2  $sc_con  $course_id_con  $sc_con1 $whr_con_for_prov $type_con group by s.id ";
        // echo $sql;
        // exit;

        $query = $this->db->query($sql);


        $res = $query->result_array();
        return $res;
    }


    function stream_wise_admission($year = '')
    {
        $umsdb = $this->load->database('umsdb', TRUE);
        $sql = "SELECT v.course_short_name,v.school_name,v.course_name,v.course_id,v.stream_name,s.current_semester,s.current_year,COUNT(s.stud_id) AS student_count,
(select count(s1.stud_id) from student_master as s1
JOIN vw_stream_details v1 ON v1.stream_id=s1.admission_stream
 where  s1.cancelled_admission='N' AND s1.is_detained='N' AND s1.admission_session ='$year' AND  s1.academic_year ='$year' AND s1.enrollment_no !='' and v1.course_short_name= v.course_short_name and  s1.admission_confirm='Y')
 as Confirm_count
FROM student_master s
LEFT JOIN vw_stream_details v ON v.stream_id=s.admission_stream


WHERE s.cancelled_admission='N' AND s.is_detained='N' AND s.admission_session ='$year' AND  s.academic_year ='$year' AND s.enrollment_no !='' AND v.course_id !=15 

#group by v.school_name,v.course_name,v.stream_name,s.current_semester
GROUP BY v.course_id 
ORDER BY v.school_name,v.course_name, v.stream_name,s.current_semester";

        $query = $umsdb->query($sql);

        $res = $query->result_array();
        return $res;
    }

    function enquiries($utm_source = '', $year = '', $campus = '')
    {


        $progm_con = '';
        $pg_com = '';

        if ($utm_source != '' &&  $utm_source == 'College Duniya') {
            $utm_con = " and s.utm_source='College Dunia'";
        } else {
            $utm_con = " and s.utm_source='$utm_source'";
        }

        if (!empty($year) && $year != '' && $year != 'undefined') {
            $cyear = $year;
        } else {
            $cyear = $this->config->item('current_year');
        }

        $camp = '';
        if ($campus != '') {

            $camp = " and s.campus_id=" . $campus . "";
        }




        $c = explode('-', $cyear);
        $c = $c[0];
        $sql = " SELECT COALESCE(COUNT(s.id),0) as scount
FROM student_meet_details AS s 

 WHERE s.ic_code='digital' and s.event_code='EV/DG/1' and s.academic_year = '$cyear' and s.utm_source !=''  $progm_con $utm_con $camp ";


        return $this->db->query($sql)->row();
    }

    function get_entry($entry_id = '')
    {
        $array['ic_name'] = '';
        $array['center_type'] = '';
        //$umsdb = $this->load->database('umsdb', TRUE);
        $sql = "select esm.created_by,esm.created_on,esm.is_from_consultant,esm.enquiry_taken from sandipun_ums.enquiry_student_master as esm where esm.enquiry_id=$entry_id";
        $data = $this->db->query($sql)->row();
        //print_r($data);
        //exit;
        $source = "";
        if (!empty($data->created_by)) {
            if ($data->is_from_consultant == 1) {
                $source .= "Consultant ";
                $get_name = $this->db->query("select consultants_call_details.contact_person,consultants_call_details.institute_name from consultants_call_details
			join user_master on (consultants_call_details.employee_code=user_master.employee_code OR consultants_call_details.id=user_master.con_id) where user_master.um_id=" . $data->created_by)->row();

                $source .= "(" . $get_name->contact_person . "/" . $get_name->institute_name . ")";
            } elseif ($data->is_from_consultant == 2 || $data->is_from_consultant == 0) {
                if ($data->is_from_consultant == 2) {
                    $source .= "Staff ";
                    $get_name = $this->db->query("select inhouse_staff_details.staff_name as name,inhouse_staff_details.institute from inhouse_staff_details
			join user_master on (inhouse_staff_details.staff_id=user_master.employee_code) where user_master.um_id=" . $data->created_by)->row();
                    $source .= "(" . $get_name->name . "/" . $get_name->institute . ")";
                } else {

                    $get_name = $this->db->query("select CONCAT(ic_user_master.fname,'',ic_user_master.lname) as name,ic_registration.ic_name, ic_registration.center_type from ic_user_master
			join user_master on (ic_user_master.employee_code=user_master.employee_code)
            join ic_registration on user_master.ic_code=ic_registration.ic_code
			where user_master.um_id=" . $data->created_by)->row();

                    $source .= 'Offline admission';

                    if (!empty($get_name)) {

                        $source .= " Rgstrd By-(" . $get_name->name . ")";
                        $array['ic_name'] = $get_name->ic_name;
                        $array['center_type'] = $get_name->center_type;
                    } elseif ($data->created_by ==    1111 || $data->created_by ==    1910 || $data->created_by ==    1911) {
                        $source .= " Rgstrd By-(Director Of Admission)";
                    } elseif (($data->created_by >=    1189 && $data->created_by <=    1277) || ($data->created_by == '1591' || $data->created_by == '1732'  || $data->created_by == '1733' || $data->created_by == '1756'  || $data->created_by == '1757' || $data->created_by == '1758'  || $data->created_by == '1759' || $data->created_by == '1760'  || $data->created_by == '1761'  || $data->created_by == '1763'  || $data->created_by == '1764' || $data->created_by == '1765'  || $data->created_by == '1766' || $data->created_by == '1767'  || $data->created_by == '1768' || $data->created_by == '1769'  || $data->created_by == '3372')) {
                        $source .= " Rgstrd By-(Admission Counsellor)";
                    }

                    if (!empty($data->enquiry_taken)) {
                        $source .= '(counselled by- ' . $data->enquiry_taken . ')';
                    }


                    //return $array;

                    //(counselled by'..')' ;	

                }
            }
            //return $source."(".$data->created_on.")";
            $array['source'] = $source . "(" . $data->created_on . ")";

            return $array;
        } else {
            return array();
        }
    }

    function get_webiner_details($mobile = '', $year = '')
    {
        $sql = " SELECT *,sm.created_date as registration_date from webiner_student_meet_details as sm join webiner_event_details sn on sm.event_code=sn.event_code  join 
				user_master on user_master.um_id=sm.created_by join ic_user_master on ic_user_master.employee_code=user_master.employee_code
				where sm.academic_year='$year' and sn.academic_year='$year' and sm.mobile1 ='$mobile' order by sm.id desc";
        return $this->db->query($sql)->result_array();
    }






    function provisional_admission($year = '', $course_id = '', $rowno = '', $rowperpage = '')
    {

        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        if ($course_id != '') {
            $course_cond = " AND v.course_id =$course_id ";
        }

        if ($rowno != '' && $rowperpage != '') {
            $lm = 'limit ' . $rowno . ',' . $rowperpage;
        } else {
            $lm = ' ';
        }
        $umsdb = $this->load->database('umsdb', TRUE);
        $sql = "SELECT s.enrollment_no,s.first_name,s.mobile as mobile1,sm.id as student_id,sm.mobile1_valid,sm.utm_source,s.created_on as pcreated, sm.created_date as lcreated_date,(select enquiry_student_master.is_from_consultant  from enquiry_student_master   where enquiry_student_master.aadhar_card=s.adhar_card_no and enquiry_student_master.admission_session='$c' LIMIT 1) as is_from_reference,(select enquiry_student_master.created_on  from enquiry_student_master   where enquiry_student_master.aadhar_card=s.adhar_card_no and enquiry_student_master.admission_session='$c' LIMIT 1) as is_from_reference_created_on,(select ld.calling_status  from " . currentdb . ".student_meet_details as smd join " . currentdb . ".lead_assign_details as ld
 on ld.stud_id=smd.id where (smd.mobile1=s.mobile) and smd.academic_year='$year' and smd.ic_code!='REF/1' and smd.ic_code!='REF/2'  order by ld.id desc LIMIT 1) as lcalling_status,(select  CONCAT(iu.fname,' ',iu.lname) from " . currentdb . ".student_meet_details as smd join " . currentdb . ".lead_assign_details as ld
 on ld.stud_id=smd.id
left join " . currentdb . ".ic_users iu on iu.um_id=ld.lead_assign
 where (smd.mobile1=s.mobile ) and smd.academic_year='$year' and smd.ic_code!='REF/1' and smd.ic_code!='REF/2' order by ld.id desc LIMIT 1) as caller_name,sm.programme_year,(select ic.ic_name  from " . currentdb . ".student_meet_details as smd join " . currentdb . ".ic_registration as ic
on smd.ic_code=ic.ic_code where (smd.mobile1=s.mobile) and smd.academic_year='$year' and smd.ic_code!='REF/1' and smd.ic_code!='REF/2' LIMIT 1) as ic_name,
(select ic.center_type  from " . currentdb . ".student_meet_details as smd join " . currentdb . ".ic_registration as ic
on smd.ic_code=ic.ic_code where (smd.mobile1=s.mobile ) and smd.academic_year='$year' and smd.ic_code!='REF/1' and smd.ic_code!='REF/2' LIMIT 1) as center_type,states.state_name,taluka_master.taluka_name,
v.school_short_name as school_name,v.course_short_name as course_name,v.stream_name,s.current_semester,s.current_year,s.mobile
 FROM student_master s LEFT JOIN vw_stream_details v ON v.stream_id=s.admission_stream
 LEFT JOIN (SELECT COUNT(stud_id) AS Confirm_count,stud_id FROM student_master LEFT JOIN vw_stream_details vv
 ON vv.stream_id=admission_stream

 WHERE cancelled_admission='N' AND is_detained='N' AND admission_session ='$year' 
AND academic_year ='$year' AND enrollment_no !='' AND admission_confirm='Y' GROUP BY vv.stream_name ) AS p ON p.stud_id=s.stud_id

left join address_details on address_details.student_id=s.stud_id and address_details.adds_of='STUDENT'
join states on address_details.state_id=states.state_id
join taluka_master on address_details.city=taluka_master.taluka_id
 LEFT JOIN " . currentdb . ".student_meet_details sm on (s.mobile=sm.mobile1 ) WHERE s.cancelled_admission='N' AND s.is_detained='N' 
 AND s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !='' $course_cond AND v.course_id !=15 

 group by s.stud_id   $lm";

        // #and sm.ic_code!='REF/1' and sm.ic_code!='REF/2' 

        $query = $umsdb->query($sql);

        $res = $query->result_array();
        return $res;
    }


    function provisional_admission1($year = '', $course_id = '')
    {
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        if ($course_id != '') {
            $course_cond = " AND s.admission_stream =$course_id ";
        }
        $umsdb = $this->load->database('ums_sijoul', TRUE);
        $sql = "SELECT s.*,s.mobile as mobile1,
 (select state_name  from states join address_details on address_details.state_id=states.state_id  where address_details.student_id=s.stud_id LIMIT 1 ) as state_name,(select taluka_name  from taluka_master join address_details on address_details.city=taluka_master.taluka_id  where address_details.student_id=s.stud_id LIMIT 1 ) as city_name,v.school_short_name as school_name,v.course_short_name as course_name,v.stream_name,s.current_semester,s.current_year,s.mobile FROM student_master s LEFT JOIN vw_stream_details v ON v.stream_id=s.admission_stream WHERE s.cancelled_admission='N' AND s.is_detained='N'
 AND s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !='' $course_cond 
group by s.stud_id ";

        $query = $umsdb->query($sql);

        $res = $query->result_array();
        return $res;
    }

    function confirm_admission_ind($year = '', $course_id = '')
    {
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        if ($course_id != '') {
            $course_cond = " AND v.course_id =$course_id ";
        }
        $umsdb = $this->load->database('umsdb', TRUE);
        $sql = "SELECT s.mobile as mobile1
 FROM student_master s  
 JOIN sandipun_ic_erp22.admission_benefits_and_source as  a on s.stud_id=a.student_id and a.is_for=1
 LEFT JOIN vw_stream_details v ON v.stream_id=s.admission_stream WHERE s.cancelled_admission='N' AND s.is_detained='N'
 AND s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !='' AND v.course_id !=15  and s.admission_confirm='Y' and s.nationality='Indian' and s.cancelled_admission='N' $course_cond and s.is_detained='N'
group by s.stud_id ";

        $query = $umsdb->query($sql);

        $res = $query->num_rows();
        return $res;
    }


    function confirm_admission_int($year = '', $course_id = '')
    {
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        if ($course_id != '') {
            $course_cond = " AND v.course_id =$course_id ";
        }
        $umsdb = $this->load->database('umsdb', TRUE);
        $sql = "SELECT s.mobile as mobile1
 FROM student_master s  LEFT JOIN vw_stream_details v ON v.stream_id=s.admission_stream WHERE s.cancelled_admission='N' AND s.is_detained='N'
 AND s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !='' AND v.course_id !=15  and s.admission_confirm='Y' and s.nationality !='Indian' and s.cancelled_admission='N' $course_cond and s.is_detained='N'
group by s.stud_id ";

        $query = $umsdb->query($sql);

        $res = $query->num_rows();
        return $res;
    }

    function prov_admission_int($year = '', $course_id = '')
    {
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        if ($course_id != '') {
            $course_cond = " AND v.course_id =$course_id ";
        }
        $umsdb = $this->load->database('umsdb', TRUE);
        $sql = "SELECT s.mobile as mobile1
FROM student_master s  LEFT JOIN vw_stream_details v ON v.stream_id=s.admission_stream WHERE s.cancelled_admission='N' AND s.is_detained='N'
AND s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !='' $course_cond AND v.course_id !=15  and s.nationality !='Indian' and s.cancelled_admission='N' and s.is_detained='N'
group by s.stud_id ";

        $query = $umsdb->query($sql);

        $res = $query->num_rows();
        return $res;
    }

    function prov_admission_ind($year = '', $course_id = '')
    {
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        if ($course_id != '') {
            $course_cond = " AND v.course_id =$course_id ";
        }
        $umsdb = $this->load->database('umsdb', TRUE);
        $sql = "SELECT s.mobile as mobile1
FROM student_master s  
JOIN sandipun_ic_erp22.admission_benefits_and_source as  a on s.stud_id=a.student_id and a.is_for=1

LEFT JOIN vw_stream_details v ON v.stream_id=s.admission_stream WHERE s.cancelled_admission='N' AND s.is_detained='N'
AND s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !='' $course_cond AND v.course_id !=15  and s.nationality ='Indian' and s.cancelled_admission='N' and s.is_detained='N'
group by s.stud_id ";
        $query = $umsdb->query($sql);
        $res = $query->num_rows();
        return $res;
    }

    function insert_web_student_data1($data)
    {
        //print_r($data);exit;



        $arr['ic_code'] = $data['ic_code'];
        $arr['event_code'] = $data['event_code'];
        $arr['student_name'] = $data['student_name'];
        $arr['gender'] = $data['gender'];
        $arr['dob'] = $data['dob'];
        $arr['mobile1'] = $data['mobile1'];
        $arr['reference'] = $data['reference'];
        $arr['country_id'] = $data['country_id'];
        $arr['country_name'] = $data['country_name'];
        $arr['state_id'] = $data['state'];
        $arr['state_name'] = $data['state_name'];
        $arr['city_id'] = $data['city'];
        $arr['city_name'] = $data['city_name'];
        $arr['email'] = $data['email'];
        $arr['created_by'] = $data['created_by'];
        $arr['created_date'] = date('Y-m-d H:i:s');
        $arr['academic_year'] = $data['academic_year'];
        $arr['status'] = 'Y';


        $ins = $this->db->insert('webiner_student_meet_details', $arr);
        $ins_id = $this->db->insert_id();
        if ($data['courseInterested'] != '') {
            foreach ($data['courseInterested'] as $key => $value) {
                $exp = explode("|", $value);

                $arr1['student_id'] = $ins_id;
                $arr1['course_id'] = $exp[0];
                $arr1['course_name'] = $exp[1];
                $arr1['inserted_by'] = $data['created_by'];
                $arr1['inserted_at'] = date('Y-m-d H:i:s');
                $ins = $this->db->insert('web_smd_interested_course', $arr1);
            }
        }


        return   $ins_id;
    }


    function get_entrire_student_details($enquiry_id)
    {
        $umsdb = $this->load->database('umsdb', TRUE);
        $sql = "select * from enquiry_student_master

left join international_enquiry_details on enquiry_student_master.enquiry_id=international_enquiry_details .enquiry_id
 join vw_stream_details on enquiry_student_master.stream_id = vw_stream_details .stream_id 
join countries on countries.id=enquiry_student_master.int_country_id

where 
enquiry_student_master.enquiry_id=$enquiry_id";

        return $query = $umsdb->query($sql)->row();
    }

    function feesstructure($enquiry_id)
    {
        $umsdb = $this->load->database('umsdb', TRUE);
        $sql = "select * from studentwiseinternational_fees_structure where enquiry_id=$enquiry_id";

        return $query = $umsdb->query($sql)->result_array();
    }


    function stream_wise_admission1($year = '', $academic_year = '')
    {
        $umsdb = $this->load->database('ums_sijoul', TRUE);
        $sql = "SELECT v.stream_id,v.course_short_name,v.school_name,v.course_name,v.course_id,v.stream_name,v.stream_short_name,s.current_semester,s.current_year,COUNT(s.stud_id) AS student_count,(select COALESCE(first_year_intake,0) from  streamwise_intake where stream_id=v.stream_id and academic_year='$academic_year') as intake,(select COALESCE(count(bcd_id),0) from  bonafied_certificates_drcc where Course=v.stream_id and academic_year='$year') as bonafide
FROM student_master s
LEFT JOIN vw_stream_details v ON v.stream_id=s.admission_stream


WHERE s.cancelled_admission='N' AND s.is_detained='N' AND s.admission_session ='$year' AND  s.academic_year ='$year' AND s.enrollment_no !='' 

#group by v.school_name,v.course_name,v.stream_name,s.current_semester
GROUP BY v.stream_id 
ORDER BY v.school_name,v.course_name, v.stream_name,s.current_semester";

        $query = $umsdb->query($sql);

        $res = $query->result_array();
        return $res;
    }


    function prov_admission_ind1($year = '', $course_id = '')
    {
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        if ($course_id != '') {
            $course_cond = " AND v.course_id =$course_id ";
        }
        $umsdb = $this->load->database('ums_sijoul', TRUE);
        $sql = "SELECT s.mobile as mobile1
FROM student_master s  LEFT JOIN vw_stream_details v ON v.stream_id=s.admission_stream WHERE s.cancelled_admission='N' AND s.is_detained='N'
AND s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !='' $course_cond  and s.cancelled_admission='N' and s.is_detained='N'
group by s.stud_id ";
        $query = $umsdb->query($sql);
        $res = $query->num_rows();
        return $res;
    }


    function stream_wise_admission11($year = '', $academic_year = '')
    {
        $umsdb = $this->load->database('ums_sijoul', TRUE);
        /*$sql = "SELECT v.stream_id,v.course_short_name,v.school_name,v.course_name,v.course_id,v.stream_name,v.stream_short_name,s.current_semester,s.current_year,COUNT(s.stud_id) AS student_count,(select COALESCE(first_year_intake,0) from  streamwise_intake where stream_id=v.stream_id and academic_year='$academic_year') as intake,(select COALESCE(count(bcd_id),0) from  bonafied_certificates_drcc where Course=v.stream_id and academic_year='$year') as bonafide
FROM student_master s
LEFT JOIN vw_stream_details v ON v.stream_id=s.admission_stream


WHERE s.cancelled_admission='N' AND s.is_detained='N' AND s.admission_session ='$year' AND  s.academic_year ='$year' AND s.enrollment_no !='' 

#group by v.school_name,v.course_name,v.stream_name,s.current_semester
GROUP BY v.stream_id 
ORDER BY v.school_name,v.course_name, v.stream_name,s.current_semester";*/


        $sql = "select v.stream_id,v.course_short_name,v.school_name,v.course_name,v.course_id,v.stream_name,v.stream_short_name,
(select COALESCE(first_year_intake,0) from  streamwise_intake where stream_id=v.stream_id and academic_year='$academic_year') as intake
,(select COALESCE(count(bcd_id),0) from  bonafied_certificates_drcc where Course=v.stream_id and academic_year='$year') as bonafide,
(select count(s.stud_id) from student_master s where s.cancelled_admission='N' AND s.is_detained='N' AND s.admission_session ='$year' AND  s.academic_year ='$year' AND s.enrollment_no !='' and s.admission_stream=v.stream_id)
 as student_count from 
vw_stream_details v  where active_for_year='$year'";

        $query = $umsdb->query($sql);

        $res = $query->result_array();
        return $res;
    }



    function provisional_admissioncount($year = '', $course_id = '', $rowno = '', $rowperpage = '')
    {

        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        if ($course_id != '') {
            $course_cond = " AND v.course_id =$course_id ";
        }

        if ($rowno != '' && $rowperpage != '') {
            $lm = 'limit ' . $rowno . ',' . $rowperpage;
        } else {
            $lm = '';
        }
        $umsdb = $this->load->database('umsdb', TRUE);
        $sql = "SELECT count(s.stud_id) as scount
 FROM student_master s 
JOIN vw_stream_details v ON v.stream_id=s.admission_stream
 WHERE s.cancelled_admission='N' AND s.is_detained='N'
 AND s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !='' $course_cond AND v.course_id !=15
  $lm";

        $query = $umsdb->query($sql);

        $res = $query->row()->scount;
        return $res;
    }





    function provisional_admissionnew($year = '', $course_id = '', $rowno = '', $rowperpage = '')
    {
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        if ($course_id != '') {
            $course_cond = " AND v.course_id =$course_id ";
        }

        if ($rowno != '' && $rowperpage != '') {
            $lm = 'limit ' . $rowno . ',' . $rowperpage;
        } else {
            $lm = ' limit 0,10 ';
        }
        $umsdb = $this->load->database('umsdb', TRUE);
        $sql = "SELECT s.first_name,s.mobile as mobile1,sm.id as student_id,sm.mobile1_valid,sm.utm_source, sm.created_date as lcreated_date,(select enquiry_student_master.is_from_consultant  from enquiry_student_master   where enquiry_student_master.aadhar_card=s.adhar_card_no and enquiry_student_master.admission_session='$c' LIMIT 1) as is_from_reference,(select enquiry_student_master.created_on  from enquiry_student_master   where enquiry_student_master.aadhar_card=s.adhar_card_no and enquiry_student_master.admission_session='$c' LIMIT 1) as is_from_reference_created_on,(select ld.calling_status  from " . currentdb . ".student_meet_details as smd join " . currentdb . ".lead_assign_details as ld
 on ld.stud_id=smd.id where smd.mobile1=s.mobile and smd.academic_year='$year' order by ld.id desc LIMIT 1) as lcalling_status,(select  CONCAT(iu.fname,' ',iu.lname) from " . currentdb . ".student_meet_details as smd join " . currentdb . ".lead_assign_details as ld
 on ld.stud_id=smd.id
left join " . currentdb . ".ic_users iu on iu.um_id=ld.lead_assign
 where smd.mobile1=s.mobile and smd.academic_year='$year' order by ld.id desc LIMIT 1) as caller_name,sm.programme_year,(select ic.ic_name  from " . currentdb . ".student_meet_details as smd join " . currentdb . ".ic_registration as ic
on smd.ic_code=ic.ic_code where smd.mobile1=s.mobile and smd.academic_year='$year' LIMIT 1) as ic_name,
(select ic.center_type  from " . currentdb . ".student_meet_details as smd join " . currentdb . ".ic_registration as ic
on smd.ic_code=ic.ic_code where smd.mobile1=s.mobile and smd.academic_year='$year' LIMIT 1) as center_type,states.state_name,taluka_master.taluka_name,
v.school_short_name as school_name,v.course_short_name as course_name,v.stream_name,s.current_semester,s.current_year,s.mobile
 FROM student_master s LEFT JOIN vw_stream_details v ON v.stream_id=s.admission_stream
 LEFT JOIN (SELECT COUNT(stud_id) AS Confirm_count,stud_id FROM student_master LEFT JOIN vw_stream_details vv
 ON vv.stream_id=admission_stream

 WHERE cancelled_admission='N' AND is_detained='N' AND admission_session ='$year' 
AND academic_year ='$year' AND enrollment_no !='' AND admission_confirm='Y' GROUP BY vv.stream_name ) AS p ON p.stud_id=s.stud_id

left join address_details on address_details.student_id=s.stud_id and address_details.adds_of='STUDENT'
join states on address_details.state_id=states.state_id
join taluka_master on address_details.city=taluka_master.taluka_id
 LEFT JOIN " . currentdb . ".student_meet_details sm on (s.mobile=sm.mobile1 or s.mobile=sm.whatsappno) WHERE s.cancelled_admission='N' AND s.is_detained='N' and sm.ic_code!='REF/1' and sm.ic_code!='REF/2' 
 AND s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !='' $course_cond AND v.course_id !=15

 group by s.stud_id   $lm";

        $query = $umsdb->query($sql);

        $res = $query->result_array();
        return $res;
    }

    function provisional_admission_new_data($year = '', $course_id = '', $data = array())
    {
        //echo "inside";
        $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');

        $and_condition = '';
        if ($role_id == '9') {

            //$and_condition =' and ( sm.utm_source="website" or sm.utm_source="Facebook" or sm.utm_source="google") ';
        } elseif ($role_id == '33' || $role_id == '17') {
            $c_by = $this->session->userdata('uid');
            $and_condition = "and enquiry_student_master.created_by='$c_by'";
        }
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        if ($course_id != '') {
            $course_cond = " AND v.course_id =$course_id ";
        }

        if ($rowno != '' && $rowperpage != '') {
            $lm = 'limit ' . $rowno . ',' . $rowperpage;
        } else {
            $lm = ' ';
        }
        $ld = '';
        if (!empty($data)) {
            if (($data['duration'] == 'day') || ($data['duration'] == 'month') || ($data['duration'] == 'year')) {

                if (isset($data['search_dt']) && $data['search_dt'] != '') {


                    $ld = " AND STR_TO_DATE(s.created_on,'%Y-%m-%d') = '" . date('Y-m-d', strtotime($data['search_dt'])) . "' ";
                } elseif (isset($data['search_dt1']) && $data['search_dt1'] != '') {

                    // $wdt = "AND month(called_on)='".date('m',strtotime($data['search_dt1']))."' and year(called_on) = '".date('Y',strtotime($data['search_dt1']))."' ";
                    $ld = " AND month(s.created_on)='" . date('m', strtotime($data['search_dt1'])) . "' and year(s.created_on) = '" . date('Y', strtotime($data['search_dt1'])) . "' ";
                } elseif (isset($data['search_dt2']) && $data['search_dt2'] != '') {

                    // $wdt = "AND year(called_on)='" .date('Y',strtotime($data['search_dt2'])). "'";
                    $ld = " AND year(s.created_on)='" . date('Y', strtotime($data['search_dt2'])) . "'";
                }
            } elseif ($data['duration'] == 'durationn') {

                $durationFrom = date('Y-m-d', strtotime($data['durationFrom'])); //date('Y-m-d',strtotime('-1 days'));

                $durationTo = date('Y-m-d', strtotime($data['durationTo'])); //date('Y-m-d', strtotime('-3 days'));



                $ld = "AND s.created_on BETWEEN '" . date('Y-m-d', strtotime($data['durationFrom'])) . " 00:00:00' AND '" . date('Y-m-d', strtotime($data['durationTo'])) . " 23:59:59'";
            }
        }
        $umsdb = $this->load->database('umsdb', TRUE);
        $sql = "SELECT v.course_type,s.email,enquiry_student_master.enquiry_taken,s.enrollment_no,s.first_name,s.mobile as mobile1,sm.ic_code,sm.id as student_id,sm.mobile1_valid,sm.utm_source,sm.event_code,s.created_on as pcreated,sm.programme_year, sm.created_date as lcreated_date, enquiry_student_master.is_from_consultant  as is_from_reference,enquiry_student_master.created_on as is_from_reference_created_on,enquiry_student_master.enquiry_id,s.admission_confirm,s.adhar_card_no,


/*(select enquiry_student_master.is_from_consultant  from enquiry_student_master   where (enquiry_student_master.aadhar_card=s.adhar_card_no  OR enquiry_student_master.mobile=s.mobile  ) and enquiry_student_master.admission_session='$c' LIMIT 1) as is_from_reference,(select enquiry_student_master.created_on  from enquiry_student_master   where enquiry_student_master.aadhar_card=s.adhar_card_no and enquiry_student_master.admission_session='$c' LIMIT 1) as is_from_reference_created_on,(select ld.calling_status  from " . currentdb . ".student_meet_details as smd join " . currentdb . ".lead_assign_details as ld
 on ld.stud_id=smd.id where (smd.mobile1=s.mobile) and smd.academic_year='$year' and smd.ic_code!='REF/1' and smd.ic_code!='REF/2'  order by ld.id desc LIMIT 1) as lcalling_status,(select  CONCAT(iu.fname,' ',iu.lname) from " . currentdb . ".student_meet_details as smd join " . currentdb . ".lead_assign_details as ld
 on ld.stud_id=smd.id
left join " . currentdb . ".ic_users iu on iu.um_id=ld.lead_assign
 where (smd.mobile1=s.mobile ) and smd.academic_year='$year' and smd.ic_code!='REF/1' and smd.ic_code!='REF/2' order by ld.id desc LIMIT 1) as caller_name,sm.programme_year,(select ic.ic_name  from " . currentdb . ".student_meet_details as smd join " . currentdb . ".ic_registration as ic
on smd.ic_code=ic.ic_code where (smd.mobile1=s.mobile) and smd.academic_year='$year' and smd.ic_code!='REF/1' and smd.ic_code!='REF/2' LIMIT 1) as ic_name,
(select ic.center_type  from " . currentdb . ".student_meet_details as smd join " . currentdb . ".ic_registration as ic
on smd.ic_code=ic.ic_code where (smd.mobile1=s.mobile ) and smd.academic_year='$year' and smd.ic_code!='REF/1' and smd.ic_code!='REF/2' LIMIT 1) as center_type,*/states.state_name,taluka_master.taluka_name,district_name.district_name,
v.school_short_name as school_name,v.course_short_name as course_name,v.stream_name,s.current_semester,s.current_year,s.mobile
 FROM student_master s LEFT JOIN vw_stream_details v ON v.stream_id=s.admission_stream
 left join enquiry_student_master on (s.enquiry_id=enquiry_student_master.enquiry_id OR (s.adhar_card_no=enquiry_student_master.aadhar_card and s.adhar_card_no!=0)  OR s.mobile=enquiry_student_master.mobile)
 LEFT JOIN (SELECT COUNT(stud_id) AS Confirm_count,stud_id FROM student_master LEFT JOIN vw_stream_details vv
 ON vv.stream_id=admission_stream

 WHERE cancelled_admission='N' AND is_detained='N' AND admission_session ='$year' 
AND academic_year ='$year' AND enrollment_no !='' AND admission_confirm='Y' GROUP BY vv.stream_name ) AS p ON p.stud_id=s.stud_id

left join address_details on address_details.student_id=s.stud_id and address_details.adds_of='STUDENT'
left join states on address_details.state_id=states.state_id
left join taluka_master on address_details.city=taluka_master.taluka_id
left join district_name on address_details.district_id=district_name.district_id
 LEFT JOIN (select s11.* from " . currentdb . ".student_meet_details s11 where s11.academic_year='$year') as sm
 
 
 
 
  on ((s.mobile=sm.mobile1)  AND sm.academic_year='$year' ) WHERE s.cancelled_admission='N' AND s.is_detained='N' 
 AND s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !='' $course_cond AND v.course_id !=15  $ld   
  $and_condition  
 
 group by s.stud_id desc  $lm  ";

        // # currentdb.student_meet_details sm (select distinct(s11.id) as id,s11.* from currentdb.student_meet_details s11 where s11.academic_year='$year'  ) as sm #
        //echo $sql;

        $query = $umsdb->query($sql);

        $res = $query->result_array();
        return $res;
    }

    function get_caller_name($stud_id)
    {
        //echo "dd";
        //exit;
        $cyear = $this->config->item('current_year');
        return $get_status = $this->db->query("select GROUP_CONCAT(DISTINCT(ld.calling_status) order by ld.c_id desc) as calling_status,GROUP_CONCAT(((CONCAT(ld.called_on,'-',ic_user_master.fname,' ',ic_user_master.lname))) order by ld.c_id desc) as calling_on,GROUP_CONCAT(DISTINCT(CONCAT(ic_user_master.fname,' ',ic_user_master.lname))) as caller_name,GROUP_CONCAT(DISTINCT(CONCAT(UPPER(center_type),'-',ic_name))) as ic_name,GROUP_CONCAT(DISTINCT(center_type)) as center_type,GROUP_CONCAT(DISTINCT(((ic_registration.ic_code)))) as ic_code
from " . currentdb . ".calling_log_details  as ld
join " . currentdb . ".student_meet_details as smd on smd.id=ld.student_id  
join user_master on user_master.um_id=ld.called_by
join ic_registration on user_master.ic_code=ic_registration.ic_code
join ic_user_master on ic_user_master.employee_code=user_master.employee_code
 where ld.student_id =$stud_id  AND smd.academic_year='$cyear' ")->row();
    }

    function get_lead_from($stud_id)
    {
        $cyear = $this->config->item('current_year');
        return $get_lead_from = $this->db->query("select ic.ic_name,ic.center_type,ic.ic_code  from " . currentdb . ".student_meet_details as smd join " . currentdb . ".ic_registration as ic
on smd.ic_code=ic.ic_code where smd.id=$stud_id AND smd.academic_year='$cyear' ")->row();
    }


    function check_with_secondary_no($mobile)
    {
        $cyear = $this->config->item('current_year');
        return $get_lead_from = $this->db->query("select smd.utm_source,ic.ic_name,ic.center_type,ic.ic_code,smd.id,smd.mobile1,smd.created_date  from " . currentdb . ".student_meet_details as smd left join " . currentdb . ".ic_registration as ic
on smd.ic_code=ic.ic_code where smd.whatsappno='$mobile' AND smd.academic_year='$cyear' ")->row();
    }


    function check_with_both_no($mobile)
    {
        $cyear = $this->config->item('current_year');
        return $get_lead_from = $this->db->query("select smd.utm_source,ic.ic_name,ic.center_type,ic.ic_code,smd.id,smd.mobile1,smd.created_date  from " . currentdb . ".student_meet_details as smd left join " . currentdb . ".ic_registration as ic
on smd.ic_code=ic.ic_code where (smd.whatsappno='$mobile' or smd.mobile1='$mobile' ) AND smd.academic_year='$cyear' ")->row();
    }

    function chek_admission_taken_by_adhar($email, $ac = '')
    {
        $academic_year = ACADEMIC_YEAR;

        if (!empty($ac)) {
            $academic_year = $ac;
        }
        $c = explode('-', $academic_year);
        $c = $c[0];
        $sql = "SELECT distinct(s.stud_id) as student_id
                FROM sandipun_ums.student_master  s                     
                WHERE s.admission_session='$c' and (s.adhar_card_no = '" . $email . "') and s.enrollment_no !='' and s.adhar_card_no !='' and s.cancelled_admission='N'
				UNION 
				SELECT distinct(s.stud_id) as student_id
                FROM sandipun_ums_sijoul.student_master  s                     
                WHERE s.admission_session='$c'  and (s.adhar_card_no = '" . $email . "') and s.enrollment_no !=''  and s.adhar_card_no !=''
				and s.cancelled_admission='N'";

        $query = $this->db->query($sql);
        $res = $query->result_array();
        $count = sizeof($res);
        return $count;
    }


    function chek_adhar_exist($adhar = '', $ac = '')
    {
        $academic_year = ACADEMIC_YEAR;
        if (!empty($ac)) {
            $academic_year = $ac;
        }
        $sql = "SELECT * FROM aadhar_car_updation
	where academic_year='$academic_year' and (add_no = '" . $adhar . "') ";
        $query = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }

    function getStudents($offSet = 0, $limit = 1, $streamid = '', $year = '')
    {
        $uId = $this->session->userdata('uid');
        $DB1 = $this->load->database('umsdb', TRUE);
        $DB1->select("sm.*,stm.stream_name,cm.course_name, pd.parent_mobile2");
        $DB1->from('student_master as sm');
        //	$DB1->join('couse_master as scm','d.emp_id = e.emp_id','left');
        $DB1->join('stream_master as stm', 'sm.admission_stream = stm.stream_id', 'left');
        $DB1->join('course_master as cm', 'cm.course_id = stm.course_id', 'left');
        $DB1->join('parent_details as pd', 'pd.student_id = sm.stud_id', 'left');
        $DB1->where("sm.created_by", $uId);
        if ($streamid != '') {
            $DB1->where("sm.admission_stream", $streamid);
        }
        if ($year != '') {
            $DB1->where("sm.admission_year", $year);
        }
        $DB1->order_by("sm.enrollment_no", "asc");
        //$DB1->limit(10); //testing pupose only
        $query = $DB1->get();
        /*  echo $this->db->last_query();
		die();  */
        $result = $query->result_array();
        //echo $this->db->last_query();
        /* die();   */
        //	$result=$query->result_array();
        return $result;
    }


    function getAllStudents()
    {
        $DB1 = $this->load->database('umsdb', TRUE);
        $DB1->select("sm.*,stm.stream_name,stm.course_id");
        $DB1->from('student_master as sm');
        //	$DB1->join('couse_master as scm','d.emp_id = e.emp_id','left');
        $DB1->join('stream_master as stm', 'sm.admission_stream = stm.stream_id', 'left');

        $DB1->order_by("sm.stud_id", "desc");
        $query = $DB1->get();
        // echo $DB1->last_query();
        //	  exit(0);
        //	die();  */ 
        $result = $query->result_array();
        $cnt = count($result);
        return $cnt;
    }

    function searchStudentfeedata1($prn = '')
    {
        $academic_year = ACADEMIC_YEAR;
        $academic_year1 = ACADEMIC_YEAR;
        $c = explode('-', $academic_year);
        $academic_year = $c[0];
        $DB1 = $this->load->database('umsdb', TRUE);
        $DB1->select("sm.*,stm.stream_name,cm.course_name,ad.`adm_id`,af.tution_fees,ad.`student_id`,ad.`batch_cycle`,ad.`school_code`,ad.`stream_id`,ad.`year`,ad.`academic_year`,ad.`actual_fee`,ad.`applicable_fee`,ad.`opening_balance`,ad.`total_fees_paid`,ad.concession_id
,ad.`fees_consession_allowed`,ad.`concession_type`,ad.`duration`,ad.`concession_remark`,ad.`hostel_required`,ad.`hostel_type`,
ad.`transport_required`,ad.`transport_boarding_point`,ad.`remark`,ad.`cancelled_admission`,ad.`fess_update_bybala`,fcd.duration as fduration");
        $DB1->from('student_master as sm');
        $DB1->join('stream_master as stm', 'sm.admission_stream = stm.stream_id', 'left');
        $DB1->join('course_master as cm', 'cm.course_id = stm.course_id', 'left');
        $DB1->join('admission_details as ad', 'sm.stud_id = ad.student_id', 'left');
        $DB1->join('academic_fees as af', 'stm.stream_id = af.stream_id and af.academic_year="' . $academic_year1 . '" and af.admission_year="' . $academic_year . '" and af.year=1', 'left');
        $DB1->join('fees_consession_details as fcd', 'fcd.student_id = ad.student_id and fcd.academic_year=ad.academic_year', 'left');
        if (!empty($prn)) {
            $DB1->where("sm.enrollment_no", $prn);
        }
        $DB1->where("ad.academic_year", $academic_year);
        $DB1->where("sm.admission_session", $academic_year);
        $DB1->where("sm.cancelled_admission", 'N');
        $DB1->order_by("sm.enrollment_no", "asc");
        $query = $DB1->get();

        //echo $DB1->last_query();
        //exit;
        $result = $query->result_array();
        return $result;
    }

    function getCollegeCourse($col_id = 1)
    {
        $DB1 = $this->load->database('umsdb', TRUE);
        $sql = "SELECT DISTINCT(course_id),course_name,course_short_name FROM vw_stream_details";
        if (isset($_SESSION['role_id']) && $_SESSION['role_id'] == 10) {
            $ex = explode("_", $_SESSION['name']);
            $sccode = $ex[1];
            $sql .= " where school_code = $sccode";
        }
        $query = $DB1->query($sql);
        return $query->result_array();
    }

    function fee_exemption()
    {

        $academic_year = ACADEMIC_YEAR;
        $academic_year1 = ACADEMIC_YEAR;
        $c = explode('-', $academic_year);
        $academic_year = $c[0];
        $DB1 = $this->load->database('umsdb', TRUE);
        $uId = $this->session->userdata('uid');


        $sid1 = implode(",", $_POST['lstd']);
        //var_dump($sid);
        $sid = array_map('intval', explode(',', $sid1));


        foreach ($sid as $stuid) {
            $sc = $_POST[$stuid . "_scholarship"];
            $id = explode('-', $sc);

            // echo $stuid.">>".$_POST[$stuid."_actual"]."**".$_POST[$stuid."_exem"]."@".$_POST[$stuid."_scholarship"]."|".$_POST['fayear']; 

            $tempe['actual_fee'] = $_POST[$stuid . "_actual"];
            $tempe['applicable_fee'] = $_POST[$stuid . "_actual"] - $_POST[$stuid . "_exem"];

            $tempe['concession_type'] = $id[0];
            $tempe['concession_id'] = $id[1];
            $tempe['duration'] = $_POST[$stuid . "_duration"];
            $tempe['concession_remark'] = $_POST[$stuid . "_remark"];
            if ($_POST[$stuid . "_scholarship"] != '') {
                $tempe['fees_consession_allowed'] = 'Y';
            }


            $DB1->where('academic_year', $academic_year);
            $DB1->where('student_id', $stuid);
            $DB1->update('admission_details', $tempe);

            $fcd['actual_fees'] = $_POST[$stuid . "_actual"];
            $fcd['fees_paid_required'] = $_POST[$stuid . "_appli"];
            $fcd['exepmted_fees'] = $_POST[$stuid . "_exem"];

            $fcd['concession_type'] = $id[0];
            $fcd['duration'] = $_POST[$stuid . "_duration"];
            $fcd['concession_remark'] = $_POST[$stuid . "_remark"];

            /*$DB1->where('academic_year', $_POST['fayear']);
        $DB1->where('student_id', $stuid);
        $DB1->update('fees_consession_details',$fcd);*/

            $rcnt = $this->check_if_exists_list($academic_year, $stuid);


            if ($rcnt < 1) {
                $fcd['student_id'] = $stuid;
                $fcd['academic_year'] = $academic_year;
                $fcd['created_on'] = date('Y-m-d h:i:s');
                $fcd['created_by'] = $uId;

                $DB1->insert('fees_consession_details', $fcd);

                $DB1->insert('scholarshiplog', $fcd);
            } else {
                $fcd['modified_on'] = date('Y-m-d h:i:s');
                $fcd['modified_by'] = $uId;
                $DB1->where('academic_year', $academic_year);
                $DB1->where('student_id', $stuid);

                $DB1->update('fees_consession_details', $fcd);
                unset($fcd['modified_on']);
                unset($fcd['modified_by']);
                $fcd['created_on'] = date('Y-m-d h:i:s');
                $fcd['created_by'] = $uId;
                $fcd['student_id'] = $stuid;
                $fcd['academic_year'] = $academic_year;
                $DB1->insert('scholarshiplog', $fcd);
            }
        }
        //exit();
        // echo '<script>alert("Fees updated successfully for selected students");<script>';
        //$url="calling/stud_feelist/";
        $url = base_url("calling/stud_feelist/");
        echo '<script>window.location.href = "' . $url . '";</script>';
        //redirect();
        //return 1;
        //   var_dump($sid);
        // exit(0);
    }

    function check_if_exists_list($year, $student_id)
    {


        $DB5 = $this->load->database('umsdb', TRUE);
        $DB5->select("count(*) as ucount");
        $DB5->from('fees_consession_details');
        $DB5->where('academic_year', $year);
        $DB5->where('student_id', $student_id);
        //	$DB1->join('address_details as ad','sm.stud_id = ad.student_id','left');
        //	$DB1->where("adds_of", "STUDENT");
        //	$DB1->where("address_type", "CORS");d.district_name,c.taluka_name,s.state_name
        $query = $DB5->get();
        $cn = $query->row_array();
        return $cn['ucount'];
    }


    function provisional_admission_new_data_aadhar($year = '', $course_id = '', $data = array())
    {
        //provisional_admission_new_data_aadhar
        $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');

        $and_condition = '';
        if ($role_id == '9') {

            //$and_condition =' and ( sm.utm_source="website" or sm.utm_source="Facebook" or sm.utm_source="google") ';
        } elseif ($role_id == '33' || $role_id == '17') {
            $c_by = $this->session->userdata('uid');
            $and_condition = "and enquiry_student_master.created_by='$c_by'";
        }
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        if ($course_id != '') {
            $course_cond = " AND v.course_id =$course_id ";
        }

        if ($rowno != '' && $rowperpage != '') {
            $lm = 'limit ' . $rowno . ',' . $rowperpage;
        } else {
            $lm = ' ';
        }
        $ld = '';
        if (!empty($data)) {
            if (($data['duration'] == 'day') || ($data['duration'] == 'month') || ($data['duration'] == 'year')) {

                if (isset($data['search_dt']) && $data['search_dt'] != '') {


                    $ld = " AND STR_TO_DATE(s.created_on,'%Y-%m-%d') = '" . date('Y-m-d', strtotime($data['search_dt'])) . "' ";
                } elseif (isset($data['search_dt1']) && $data['search_dt1'] != '') {

                    // $wdt = "AND month(called_on)='".date('m',strtotime($data['search_dt1']))."' and year(called_on) = '".date('Y',strtotime($data['search_dt1']))."' ";
                    $ld = " AND month(s.created_on)='" . date('m', strtotime($data['search_dt1'])) . "' and year(s.created_on) = '" . date('Y', strtotime($data['search_dt1'])) . "' ";
                } elseif (isset($data['search_dt2']) && $data['search_dt2'] != '') {

                    // $wdt = "AND year(called_on)='" .date('Y',strtotime($data['search_dt2'])). "'";
                    $ld = " AND year(s.created_on)='" . date('Y', strtotime($data['search_dt2'])) . "'";
                }
            } elseif ($data['duration'] == 'durationn') {
                $durationFrom = date('Y-m-d', strtotime($data['durationFrom'])); //date('Y-m-d',strtotime('-1 days'));
                $durationTo = date('Y-m-d', strtotime($data['durationTo'])); //date('Y-m-d', strtotime('-3 days'));

                $ld = "AND s.created_on BETWEEN '" . date('Y-m-d', strtotime($data['durationFrom'])) . " 00:00:00' AND '" . date('Y-m-d', strtotime($data['durationTo'])) . " 23:59:59'";
            }
        }
        $umsdb = $this->load->database('umsdb', TRUE);
        $sql = "SELECT au.created_by as cd,v.course_type,s.email,enquiry_student_master.enquiry_taken,s.enrollment_no,s.first_name,s.mobile as mobile1,sm.ic_code,sm.id as student_id,sm.mobile1_valid,sm.utm_source,sm.event_code,s.created_on as pcreated,sm.programme_year, sm.created_date as lcreated_date, enquiry_student_master.is_from_consultant  as is_from_reference,enquiry_student_master.created_on as is_from_reference_created_on,enquiry_student_master.enquiry_id,s.admission_confirm,s.adhar_card_no,
states.state_name,taluka_master.taluka_name,district_name.district_name,
v.school_short_name as school_name,v.course_short_name as course_name,v.stream_name,s.current_semester,s.current_year,s.mobile
 FROM student_master s LEFT JOIN vw_stream_details v ON v.stream_id=s.admission_stream
 left join " . currentdb . ".aadhar_car_updation as au on s.adhar_card_no=au.add_no
 left join enquiry_student_master on s.adhar_card_no=enquiry_student_master.aadhar_card and s.adhar_card_no!=0
 LEFT JOIN (SELECT COUNT(stud_id) AS Confirm_count,stud_id FROM student_master LEFT JOIN vw_stream_details vv
 ON vv.stream_id=admission_stream

 WHERE cancelled_admission='N' AND is_detained='N' AND admission_session ='$year' 
AND academic_year ='$year' AND enrollment_no !='' AND admission_confirm='Y' GROUP BY vv.stream_name ) AS p ON p.stud_id=s.stud_id

left join address_details on address_details.student_id=s.stud_id and address_details.adds_of='STUDENT'
left join states on address_details.state_id=states.state_id
left join taluka_master on address_details.city=taluka_master.taluka_id
left join district_name on address_details.district_id=district_name.district_id
left JOIN (select s11.* from " . currentdb . ".student_meet_details s11 where s11.academic_year='$year') as sm
on ((au.student_id=sm.id)  AND sm.academic_year='$year' ) WHERE s.cancelled_admission='N' AND s.is_detained='N' 
 AND s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !='' $course_cond AND v.course_id !=15    $ld    
 
  $and_condition  
group by s.stud_id desc  $lm  ";
        $query = $umsdb->query($sql);
        $res = $query->result_array();
        return $res;
        // 
    }




    function get_empname($id = '')
    {
        $dta = array();
        if ($id ==    1111 || $id ==    1910 || $id ==    1911) {
            $dta['by'] = 'Provisional enquiry';
            $dta['name'] = 'Director Of Admission';
            $dta['ic'] = '--';
            //$source.=" Rgstrd By-(Director Of Admission)";
        } elseif (($id >=    1189 && $id <=    1277) || ($id == '1591' || $id == '1732'  || $id == '1733' || $id == '1756'  || $id == '1757' || $id == '1758'  || $id == '1759' || $id == '1760'  || $id == '1761'  || $id == '1763'  || $id == '1764' || $id == '1765'  || $id == '1766' || $id == '1767'  || $id == '1768' || $id == '1769'  || $id == '3372'  || $id == '478770')) {
            $dta['by'] = 'Provisional enquiry';
            $dta['name'] = 'Admission Counsellor';
            $dta['ic'] = '--';
            //$source.=" Rgstrd By-()";
        } else {
            $data = $this->db->query("	select is_fou as fou,(consultants_call_details.contact_person) as name,'Consultant' as from_done,'Consultant' as belong_to,'--' as IC,ic_registration.ic_name as IC_name,user_master .ic_code as ic_code,'' as type
from 


consultants_call_details join user_master on consultants_call_details .id=user_master .con_id
left join ic_registration on user_master .ic_code=ic_registration.ic_code
 where user_master.um_id=	$id and  user_master.roles_id=17
UNION
select 0 as fou,(inhouse_staff_details.staff_name) as name,'STAFF' as from_done,'STAFF' as belong_to,'--' as IC,'---'as IC_name,user_master .ic_code as ic_code,'' as type
from 
inhouse_staff_details join user_master on inhouse_staff_details.staff_id=user_master .username where user_master.um_id=	$id and user_master.roles_id=33
UNION
select 0 as fou,CONCAT(ic_user_master.fname,' ',ic_user_master.lname) as name,ic_registration.center_type as from_done,ic_registration.ic_name as belong_to,ic_registration.ic_name as IC,ic_registration.ic_name as IC_name,user_master .ic_code as ic_code,ic_registration.center_type as type
from 
ic_user_master join user_master on ic_user_master.employee_code=user_master .employee_code 
join ic_registration on user_master .ic_code=ic_registration.ic_code
where user_master.um_id=	$id ")->row();



            if (!empty($data)) {
                if ($data->from_done == $data->belong_to) {
                    $dta['by'] = $data->from_done;
                    $dta['name'] = $data->name;
                    $dta['ic'] = $data->belong_to;
                    $dta['IC_name'] = $data->IC_name;
                    $dta['ic_code'] = $data->ic_code;
                    $dta['type'] = $data->type;
                    $dta['fou'] = $data->fou;
                } else {
                    $dta['by'] = $data->from_done . "-" . $data->belong_to;
                    $dta['name'] = $data->name;
                    $dta['ic'] = $data->belong_to;
                    $dta['IC_name'] = $data->IC_name;
                    $dta['ic_code'] = $data->ic_code;
                    $dta['type'] = $data->type;
                    $dta['fou'] = $data->fou;
                }
            }
        }

        return $dta;
    }



    function provisional_admission_new_data_aadhar_daily_report($year = '')
    {

        $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');
        $and_condition = '';
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        $lm = ' ';
        $m = date('Y-m-d');
        $md = (date('Y-m-d 18:00:00', strtotime('-1 day', strtotime($m))));

        //$md=date('Y-m-d', strtotime('-1 day',$m));
        $ld = " AND STR_TO_DATE(s.created_on,'%Y-%m-%d %T') >'" . $md . "' AND STR_TO_DATE(s.created_on,'%Y-%m-%d %T') <= '" . date('Y-m-d 18:00:00') . "' ";

        $umsdb = $this->load->database('umsdb', TRUE);
        $sql = "SELECT au.created_by as cd,au.date_time as created_date_of_aadhar,s.email,enquiry_student_master.enquiry_taken,s.enrollment_no,s.first_name,s.mobile as mobile1,sm.ic_code,sm.id as student_id,sm.mobile1_valid,sm.utm_source,sm.event_code,s.created_on as pcreated,sm.programme_year, sm.created_date as lcreated_date, enquiry_student_master.is_from_consultant  as is_from_reference,enquiry_student_master.created_on as is_from_reference_created_on,enquiry_student_master.enquiry_id,s.admission_confirm,s.adhar_card_no,
s.mobile
 FROM student_master s 
 left join " . currentdb . ".aadhar_car_updation as au on s.adhar_card_no=au.add_no
 left join enquiry_student_master on s.adhar_card_no=enquiry_student_master.aadhar_card and s.adhar_card_no!=0
left JOIN (select s11.* from " . currentdb . ".student_meet_details s11 where s11.academic_year='$year') as sm
on ((au.student_id=sm.id)  AND sm.academic_year='$year' ) WHERE s.cancelled_admission='N' AND s.is_detained='N' 
 AND s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !='' and s.nationality='Indian' $course_cond AND s.admission_cycle IS NULL  $ld 
  $and_condition  
group by s.stud_id desc  $lm  ";

        $query = $umsdb->query($sql);
        $res = $query->result();
        return $res;
    }

    function get_cancelled_no($year = '')
    {
        $c = explode('-', $year);
        $c = $c[0];

        $umsdb = $this->load->database('umsdb', TRUE);
        $sql = "SELECT s.stud_id
 FROM student_master s 
  WHERE
  s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !=''   and s.cancelled_admission='Y'  ";

        // and STR_TO_DATE(s.created_on,'%Y-%m-%d') <= '2021-09-29' AND s.admission_cycle IS NULL and s.mobile='8600164090' ,,,,,,,,,,,,,,,,,     
        $query = $umsdb->query($sql);
        $res = $query->result();
        return $res;
    }

    function provisional_admission_new_data_aadhar_daily_cummulative_report($year = '')
    {

        $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');
        $and_condition = '';
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        $lm = ' ';
        $ld = '';
        //$ld=" AND STR_TO_DATE(s.created_on,'%Y-%m-%d') = '".date('Y-m-d')."' ";

        $umsdb = $this->load->database('umsdb', TRUE);
        $sql = "SELECT au.created_by as cd,au.date_time as created_date_of_aadhar,s.email,enquiry_student_master.enquiry_taken,s.enrollment_no as confirmed_prn,s.first_name,s.mobile as mobile1,sm.ic_code,s.email,sm.id as student_id,sm.mobile1_valid,sm.utm_source,sm.event_code,s.created_on as pcreated,sm.programme_year, sm.created_date as lcreated_date, enquiry_student_master.is_from_consultant  as is_from_reference,enquiry_student_master.created_on as is_from_reference_created_on,enquiry_student_master.enquiry_id,s.admission_confirm,s.adhar_card_no,s.enrollment_no_new as enrollment_no,s.enrollment_no_new as enrollment_non,s.stud_id,sm.id as smid,
s.mobile
 FROM student_master s 
 left join " . currentdb . ".aadhar_car_updation as au on s.adhar_card_no=au.add_no
 left join enquiry_student_master on s.adhar_card_no=enquiry_student_master.aadhar_card and s.adhar_card_no!=0
 
left JOIN (select s11.* from " . currentdb . ".student_meet_details s11 where s11.academic_year='$year') as sm
on ((au.student_id=sm.id)  AND sm.academic_year='$year' ) WHERE
  s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !=''  AND s.is_detained='N' and s.cancelled_admission='N'   and s.nationality='Indian'  and STR_TO_DATE(s.created_on,'%Y-%m-%d') > '2021-09-09'  
      
 $course_cond   $ld   
  $and_condition  
group by s.stud_id desc  $lm  ";

        // and STR_TO_DATE(s.created_on,'%Y-%m-%d') <= '2021-09-29' AND s.admission_cycle IS NULL and s.adhar_card_no	='721113834565'  ,,,,,,,,,,,,,,,,,  
        //echo $sql;
        //exit;
        $query = $umsdb->query($sql);
        $res = $query->result();
        return $res;
    }


    function get_belonings($mobile, $email)
    {
        $cyear = $this->config->item('current_year');
        $con = '';
        if (!empty($email)) {
            $con = " or smd.email='$email' ";
        }
        //and smd.ic_code NOT IN ('REF/1','REF/2','REF/3')
        $get_lead_from = $this->db->query("select smd.ic_code as scode,smd.utm_source,ic.ic_name,COALESCE(ic.center_type,icr.center_type) as center_type,icr.center_type as calling_center_type,icr.ic_code,smd.id,smd.mobile1,smd.created_date  from " . currentdb . ".student_meet_details as smd left join " . currentdb . ".ic_registration as ic
on smd.ic_code=ic.ic_code 
left join calling_log_details on smd.id=calling_log_details.student_id
left join user_master on user_master.um_id=calling_log_details.called_by
left join ic_registration as icr on icr.ic_code=user_master.ic_code

where (smd.whatsappno='$mobile' or smd.mobile1='$mobile' or smd.pmobile_no='$mobile' or smd.pwhatsapp_no='$mobile' $con) AND smd.academic_year='$cyear'


group by icr.center_type
")->result();

        if (!empty($get_lead_from)) {
            if (sizeof($get_lead_from) == 1) {
                if (empty($get_lead_from[0]->calling_center_type)) {
                    if (!empty($get_lead_from[0]->center_type)) {
                        $get_lead_from[0]->calling_center_type = $get_lead_from[0]->center_type;
                    }
                }

                if (empty($get_lead_from[0]->scode)) {
                    if (!empty($get_lead_from[0]->ic_code)) {
                        $get_lead_from[0]->scode = $get_lead_from[0]->ic_code;
                    }
                }
            } else {
                if (empty($get_lead_from[0]->calling_center_type)) {
                    if (!empty($get_lead_from[0]->center_type)) {
                        $get_lead_from[0]->calling_center_type = $get_lead_from[0]->center_type;
                    }
                }
                if (empty($get_lead_from[0]->scode)) {
                    if (!empty($get_lead_from[0]->ic_code)) {
                        $get_lead_from[0]->scode = $get_lead_from[0]->ic_code;
                    }
                }
                if (empty($get_lead_from[1]->calling_center_type)) {
                    if (!empty($get_lead_from[1]->center_type)) {
                        $get_lead_from[1]->calling_center_type = $get_lead_from[1]->center_type;
                    }
                }
                if (empty($get_lead_from[1]->scode)) {
                    if (!empty($get_lead_from[1]->ic_code)) {
                        $get_lead_from[1]->scode = $get_lead_from[1]->ic_code;
                    }
                }
            }
            return $get_lead_from;
        } else {
            return array();
        }
    }





    function check_entry_in_eqs($mobile, $email)
    {
        $cyear = ACADEMIC_YEAR;
        $c = explode('-', $cyear);
        $c = $c[0];
        $con = '';
        if (!empty($email)) {
            $con = " or e.email_id='$email' ";
        }
        //and smd.ic_code NOT IN ('REF/1','REF/2','REF/3')
        return $get_lead_from = $this->db->query("select e.enquiry_id from  sandipun_ums.enquiry_student_master as e 
where (e.mobile='$mobile' or e.altarnet_mobile='$mobile'  $con) AND e.admission_session='$c'
")->row();

        return array();
    }

    function get_belonings_based_on_date($mobile, $email)
    {
        $cyear = $this->config->item('current_year');
        $con = '';
        if (!empty($email)) {
            $con = " or smd.email='$email' ";
        }
        //and smd.ic_code NOT IN ('REF/1','REF/2','REF/3')
        //

        $get_lead_from = $this->db->query("select smd.event_code,smd.ic_code as scode,smd.utm_source,ic.ic_name,COALESCE(ic.center_type,icr.center_type) as center_type,icr.center_type as calling_center_type,icr.ic_code,smd.id,smd.mobile1,smd.created_date,calling_log_details.called_on,icr.ic_name as cname  from " . currentdb . ".student_meet_details as smd left join " . currentdb . ".ic_registration as ic
on smd.ic_code=ic.ic_code 
left join calling_log_details on smd.id=calling_log_details.student_id
left join user_master on user_master.um_id=calling_log_details.called_by and STR_TO_DATE(calling_log_details.called_on,'%Y-%m-%d') >='2021-01-01'
left join ic_registration as icr on icr.ic_code=user_master.ic_code

where  smd.academic_year='$cyear' and ( smd.whatsappno='$mobile' or smd.mobile1='$mobile' or smd.pmobile_no='$mobile' or smd.pwhatsapp_no='$mobile' $con)  


group by icr.center_type   order by calling_log_details.called_on
")->result();


        if (!empty($get_lead_from)) {
            if (sizeof($get_lead_from) == 1) {
                if (empty($get_lead_from[0]->calling_center_type)) {
                    if (!empty($get_lead_from[0]->center_type)) {
                        $get_lead_from[0]->calling_center_type = $get_lead_from[0]->center_type;
                    }
                }

                if (empty($get_lead_from[0]->scode)) {
                    if (!empty($get_lead_from[0]->ic_code)) {
                        $get_lead_from[0]->scode = $get_lead_from[0]->ic_code;
                    }
                }
                if (empty($get_lead_from[0]->center_type)) {
                    if (!empty($get_lead_from[0]->calling_center_type)) {
                        $get_lead_from[0]->center_type = $get_lead_from[0]->calling_center_type;
                    }
                }

                if (empty($get_lead_from[0]->ic_code)) {
                    if (!empty($get_lead_from[0]->scode)) {
                        $get_lead_from[0]->ic_code = $get_lead_from[0]->scode;
                    }
                }
            } else {
                if (empty($get_lead_from[0]->calling_center_type)) {
                    if (!empty($get_lead_from[0]->center_type)) {
                        $get_lead_from[0]->calling_center_type = $get_lead_from[0]->center_type;
                    }
                }
                if (empty($get_lead_from[0]->scode)) {
                    if (!empty($get_lead_from[0]->ic_code)) {
                        $get_lead_from[0]->scode = $get_lead_from[0]->ic_code;
                    }
                }
                if (empty($get_lead_from[0]->center_type)) {
                    if (!empty($get_lead_from[0]->calling_center_type)) {
                        $get_lead_from[0]->center_type = $get_lead_from[0]->calling_center_type;
                    }
                }
                if (empty($get_lead_from[0]->ic_code)) {
                    if (!empty($get_lead_from[0]->scode)) {
                        $get_lead_from[0]->ic_code = $get_lead_from[0]->scode;
                    }
                }
                if (empty($get_lead_from[1]->center_type)) {
                    if (!empty($get_lead_from[1]->calling_center_type)) {
                        $get_lead_from[1]->center_type = $get_lead_from[1]->calling_center_type;
                    }
                }
                if (empty($get_lead_from[1]->ic_code)) {
                    if (!empty($get_lead_from[1]->scode)) {
                        $get_lead_from[1]->ic_code = $get_lead_from[1]->scode;
                    }
                }

                if (empty($get_lead_from[1]->calling_center_type)) {
                    if (!empty($get_lead_from[1]->center_type)) {
                        $get_lead_from[1]->calling_center_type = $get_lead_from[1]->center_type;
                    }
                }
                if (empty($get_lead_from[1]->scode)) {
                    if (!empty($get_lead_from[1]->ic_code)) {
                        $get_lead_from[1]->scode = $get_lead_from[1]->ic_code;
                    }
                }
            }
            return $get_lead_from;
        } else {
            return array();
        }
    }



    function provisional_admission_new_data_aadhar_daily_cummulative_reportdata_cu_before_nine($year = '')
    {

        $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');
        $and_condition = '';
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        $lm = ' ';
        $ld = '';
        //$ld=" AND STR_TO_DATE(s.created_on,'%Y-%m-%d') = '".date('Y-m-d')."' ";
        /*ic.center_type,au.created_by as cd,s.email,enquiry_student_master.enquiry_taken,s.enrollment_no,s.first_name,s.mobile as mobile1,sm.ic_code,s.email,sm.id as student_id,sm.mobile1_valid,sm.utm_source,sm.event_code,s.created_on as pcreated,sm.programme_year, sm.created_date as lcreated_date,left JOIN (select s11.* from currentdb.student_meet_details s11 where s11.academic_year='$year') as sm
on ((s.mobile=sm.mobile1)  AND sm.academic_year='$year' ) 
left join currentdb. calling_log_details as cd on cd.student_id=sm.id
left join currentdb. user_master as um on cd.called_by=um.um_id
left join currentdb. ic_registration as ic on um.ic_code=ic.ic_code*/


        $umsdb = $this->load->database('umsdb', TRUE);
        $sql = "SELECT  enquiry_student_master.is_from_consultant  as is_from_reference,enquiry_student_master.created_on as is_from_reference_created_on,enquiry_student_master.enquiry_id,s.admission_confirm,s.adhar_card_no,s.email,
s.mobile,enquiry_student_master.created_by  as refcreated_by,s.mobile as mobile1,s.enrollment_no_new as enrollment_no,s.created_on as admission_created,s.enrollment_no as en
 FROM student_master s 
 left join enquiry_student_master on (s.adhar_card_no=enquiry_student_master.aadhar_card and s.adhar_card_no !='' and s.adhar_card_no !='0' ) 
WHERE
  s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !=''   AND s.is_detained='N' and s.cancelled_admission='N'   and s.nationality='Indian'  and STR_TO_DATE(s.created_on,'%Y-%m-%d') <= '2021-09-09'   
 $course_cond   $ld   and s.enrollment_no_new='21SUN0218'
  $and_condition 
group by s.stud_id desc  ";

        //    

        // and STR_TO_DATE(s.created_on,'%Y-%m-%d') <= '2021-09-29' AND s.admission_cycle IS NULL  ,,,,,,,,,,,,,,,,,    


        $query = $umsdb->query($sql);

        $res = $query->result();
        return $res;
    }


    function get_leads_through_digtal($year = '')
    {
        $umsdb = $this->load->database('umsdb', TRUE);
        $c = explode('-', $year);
        $c = $c[0];
        $sql = "
	 select s.stud_id from student_master s join " . currentdb . ".student_meet_details as sm on s.mobile=sm.mobile1 OR s.mobile=sm.whatsappno 



	 where (sm.utm_source ='website' OR sm.utm_source ='FacebookAds2020'  OR sm.utm_source ='google' OR sm.utm_source ='google_ads2020'  OR sm.utm_source ='Facebook' OR sm.utm_source ='{google}'  OR sm.utm_source ='Adwords' OR sm.utm_source ='insta'  OR sm.utm_source ='Google Ad Lead Extension'
	 OR sm.utm_source ='BtechCloud_Search_Course' OR sm.utm_source ='instagram' OR sm.utm_source ='organic')  and
	 s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !=''  AND s.is_detained='N' and s.cancelled_admission='N'   and s.nationality='Indian'



UNION
select
s.stud_id from student_master s join " . currentdb . ".student_meet_details as sm on s.email=sm.email



	 where (sm.utm_source ='website' OR sm.utm_source ='FacebookAds2020'  OR sm.utm_source ='google' OR sm.utm_source ='google_ads2020'  OR sm.utm_source ='Facebook' OR sm.utm_source ='{google}'  OR sm.utm_source ='Adwords' OR sm.utm_source ='insta'  OR sm.utm_source ='Google Ad Lead Extension'
	 OR sm.utm_source ='BtechCloud_Search_Course' OR sm.utm_source ='instagram' OR sm.utm_source ='organic')  and
	 s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !=''  AND s.is_detained='N' and s.cancelled_admission='N'   and s.nationality='Indian'


and s.email !=''
	 
	 
	 ";

        $query = $umsdb->query($sql);
        $res = $query->result();
        return $res;
    }


    function get_leads_through_digtal_of_sijoul($year = '')
    {
        $umsdb = $this->load->database('ums_sijoul', TRUE);
        $c = explode('-', $year);
        $c = $c[0];
        $sql = "
	 select s.stud_id from student_master s join " . currentdb . ".student_meet_details as sm on s.mobile=sm.mobile1 OR s.mobile=sm.whatsappno 



	 where (sm.utm_source ='website' OR sm.utm_source ='FacebookAds2020'  OR sm.utm_source ='google' OR sm.utm_source ='google_ads2020'  OR sm.utm_source ='Facebook' OR sm.utm_source ='{google}'  OR sm.utm_source ='Adwords' OR sm.utm_source ='insta'  OR sm.utm_source ='Google Ad Lead Extension'
	 OR sm.utm_source ='BtechCloud_Search_Course' OR sm.utm_source ='instagram' OR sm.utm_source ='organic')  and
	 s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !=''  AND s.is_detained='N' and s.cancelled_admission='N'   and s.nationality='Indian'



UNION
select
s.stud_id from student_master s join " . currentdb . ".student_meet_details as sm on s.email=sm.email



	 where (sm.utm_source ='website' OR sm.utm_source ='FacebookAds2020'  OR sm.utm_source ='google' OR sm.utm_source ='google_ads2020'  OR sm.utm_source ='Facebook' OR sm.utm_source ='{google}'  OR sm.utm_source ='Adwords' OR sm.utm_source ='insta'  OR sm.utm_source ='Google Ad Lead Extension'
	 OR sm.utm_source ='BtechCloud_Search_Course' OR sm.utm_source ='instagram' OR sm.utm_source ='organic')  and
	 s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !=''  AND s.is_detained='N' and s.cancelled_admission='N'   and s.nationality='Indian'


and s.email !=''
	 
	 
	 ";

        $query = $umsdb->query($sql);
        $res = $query->result();
        return $res;
    }



    function provisional_admission_new_data_aadhar_daily_report_sijoul($year = '')
    {

        $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');
        $and_condition = '';
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        $lm = ' ';
        $ld = " AND STR_TO_DATE(s.created_on,'%Y-%m-%d') = '" . date('Y-m-d') . "' ";

        $umsdb = $this->load->database('ums_sijoul', TRUE);
        $sql = "SELECT au.created_by as cd,s.email,enquiry_student_master.enquiry_taken,s.enrollment_no,s.first_name,s.mobile as mobile1,sm.ic_code,sm.id as student_id,sm.mobile1_valid,sm.utm_source,sm.event_code,s.created_on as pcreated,sm.programme_year, sm.created_date as lcreated_date, enquiry_student_master.is_from_consultant  as is_from_reference,enquiry_student_master.created_on as is_from_reference_created_on,enquiry_student_master.enquiry_id,s.admission_confirm,s.adhar_card_no,
s.mobile
 FROM student_master s 
 left join " . currentdb . ".aadhar_car_updation as au on s.adhar_card_no=au.add_no
 left join sandipun_ums_sijoul.enquiry_student_master as enquiry_student_master on s.adhar_card_no=enquiry_student_master.aadhar_card and s.adhar_card_no!=0
left JOIN (select s11.* from " . currentdb . ".student_meet_details s11 where s11.academic_year='$year') as sm
on ((au.student_id=sm.id)  AND sm.academic_year='$year' ) WHERE s.cancelled_admission='N' AND s.is_detained='N' 
 AND s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !='' and s.nationality='Indian' $course_cond AND s.admission_cycle IS NULL  $ld 
  $and_condition  
group by s.stud_id desc  $lm  ";

        $query = $umsdb->query($sql);
        $res = $query->result();
        return $res;
    }



    function provisional_admission_new_data_aadhar_daily_cummulative_report_sijoul($year = '')
    {

        $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');
        $and_condition = '';
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        $lm = ' ';
        $ld = '';
        //$ld=" AND STR_TO_DATE(s.created_on,'%Y-%m-%d') = '".date('Y-m-d')."' ";

        $umsdb = $this->load->database('ums_sijoul', TRUE);
        $sql = "SELECT au.created_by as cd,s.email,enquiry_student_master.enquiry_taken,s.enrollment_no,s.first_name,s.mobile as mobile1,sm.ic_code,s.email,sm.id as student_id,sm.mobile1_valid,sm.utm_source,sm.event_code,s.created_on as pcreated,sm.programme_year, sm.created_date as lcreated_date, enquiry_student_master.is_from_consultant  as is_from_reference,enquiry_student_master.created_on as is_from_reference_created_on,enquiry_student_master.enquiry_id,s.admission_confirm,s.adhar_card_no,
s.mobile
 FROM student_master s 
 left join " . currentdb . ".aadhar_car_updation as au on s.adhar_card_no=au.add_no
 left join sandipun_ums_sijoul.enquiry_student_master as enquiry_student_master on s.adhar_card_no=enquiry_student_master.aadhar_card and s.adhar_card_no!=0
 
left JOIN (select s11.* from " . currentdb . ".student_meet_details s11 where s11.academic_year='$year') as sm
on ((au.student_id=sm.id)  AND sm.academic_year='$year' ) WHERE
  s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !=''  AND s.is_detained='N' and s.cancelled_admission='N'   and s.nationality='Indian' 
       
 $course_cond   $ld   
  $and_condition  
group by s.stud_id desc  $lm  ";

        // and STR_TO_DATE(s.created_on,'%Y-%m-%d') <= '2021-09-29' AND s.admission_cycle IS NULL and s.mobile='8600164090' ,,,,,,,,,,,,,,,,,    

        $query = $umsdb->query($sql);
        $res = $query->result();
        return $res;
    }

    function get_cancelled_no_sijoul($year = '')
    {
        $c = explode('-', $year);
        $c = $c[0];

        $umsdb = $this->load->database('ums_sijoul', TRUE);
        $sql = "SELECT s.stud_id
 FROM student_master s 
  WHERE
  s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !=''   and s.cancelled_admission='Y'  ";

        // and STR_TO_DATE(s.created_on,'%Y-%m-%d') <= '2021-09-29' AND s.admission_cycle IS NULL and s.mobile='8600164090' ,,,,,,,,,,,,,,,,,     
        $query = $umsdb->query($sql);
        $res = $query->result();
        return $res;
    }

    function get_empname_sijoul($id = '')
    {
        $dta = array();
        if ($id ==    1111 || $id ==    1910 || $id ==    1911) {
            $dta['by'] = 'Provisional enquiry';
            $dta['name'] = 'Director Of Admission';
            //$source.=" Rgstrd By-(Director Of Admission)";
        } elseif (($id >=    1189 && $id <=    1277) || ($id == '1591' || $id == '1732'  || $id == '1733' || $id == '1756'  || $id == '1757' || $id == '1758'  || $id == '1759' || $id == '1760'  || $id == '1761'  || $id == '1763'  || $id == '1764' || $id == '1765'  || $id == '1766' || $id == '1767'  || $id == '1768' || $id == '1769'  || $id == '3372')) {
            $dta['by'] = 'Provisional enquiry';
            $dta['name'] = 'Admission Counsellor';
            //$source.=" Rgstrd By-()";
        } else {
            $data = $this->db->query("select (consultants_call_details.contact_person) as name,'Consultant' as from_done,'Consultant' as belong_to
from 
consultants_call_details join user_master on consultants_call_details .id=user_master .con_id where user_master.um_id=	$id and  user_master.roles_id=17
UNION
select (inhouse_staff_details.staff_name) as name,'STAFF' as from_done,'STAFF' as belong_to
from 
inhouse_staff_details join user_master on inhouse_staff_details.staff_id=user_master .username where user_master.um_id=	$id and user_master.roles_id=33
UNION
select CONCAT(ic_user_master.fname,' ',ic_user_master.lname) as name,ic_registration.center_type as from_done,ic_registration.ic_name as belong_to
from 
ic_user_master join user_master on ic_user_master.employee_code=user_master .employee_code 
join ic_registration on user_master .ic_code=ic_registration.ic_code
where user_master.um_id=	$id and  user_master.status='Y'")->row();



            if (!empty($data)) {
                if ($data->from_done == $data->belong_to) {
                    $dta['by'] = $data->from_done;
                    $dta['name'] = $data->name;
                } else {
                    $dta['by'] = $data->from_done . "-" . $data->belong_to;
                    $dta['name'] = $data->name;
                }
            }
        }

        return $dta;
    }

    function check_entry_in_eqs_sijoul($mobile, $email, $aadhar)
    {
        //$cyear=$this->config->item('current_year');
        $cyear = ACADEMIC_YEAR;
        $c = explode('-', $cyear);
        $c = $c[0];
        $con = '';
        if (!empty($email)) {
            $con = " or e.email_id='$email' ";
        }
        if (!empty($aadhar)) {
            $con .= " or e.aadhar_card='$aadhar' ";
        }
        //and smd.ic_code NOT IN ('REF/1','REF/2','REF/3')
        return $get_lead_from = $this->db->query("select e.enquiry_id from  sandipun_ums_sijoul.enquiry_student_master as e 
where (e.mobile='$mobile' or e.altarnet_mobile='$mobile'  $con) AND e.admission_session='$c'
")->row();

        return array();
    }


    function check_ic($created_by)
    {
        $cyear = $this->config->item('current_year');
        $con = '';

        //and smd.ic_code NOT IN ('REF/1','REF/2','REF/3')
        //
        if (!empty($created_by)) {
            return $get_lead_from = $this->db->query("select ic_name from user_master join ic_user_master on user_master.employee_code=ic_user_master.employee_code
 join ic_registration on ic_user_master.ic_code=ic_registration.ic_code where user_master.um_id=$created_by
")->row();
        } else {
            return array();
        }
    }





    function final_provisional_admission($year = '', $course_id = '', $data = array())
    {

        $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');

        $and_condition = '';
        if ($role_id == '9') {

            //$and_condition =' and ( sm.utm_source="website" or sm.utm_source="Facebook" or sm.utm_source="google") ';
        } elseif ($role_id == '33' || $role_id == '17') {
            $c_by = $this->session->userdata('uid');
            $and_condition = "and enquiry_student_master.created_by='$c_by'";
        }
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        if ($course_id != '') {
            $course_cond = " AND v.course_id =$course_id ";
        }

        if ($rowno != '' && $rowperpage != '') {
            $lm = 'limit ' . $rowno . ',' . $rowperpage;
        } else {
            $lm = ' ';
        }
        $ld = '';
        if (!empty($data)) {
            if (($data['duration'] == 'day') || ($data['duration'] == 'month') || ($data['duration'] == 'year')) {

                if (isset($data['search_dt']) && $data['search_dt'] != '') {


                    $ld = " AND STR_TO_DATE(s.created_on,'%Y-%m-%d') = '" . date('Y-m-d', strtotime($data['search_dt'])) . "' ";
                } elseif (isset($data['search_dt1']) && $data['search_dt1'] != '') {

                    // $wdt = "AND month(called_on)='".date('m',strtotime($data['search_dt1']))."' and year(called_on) = '".date('Y',strtotime($data['search_dt1']))."' ";
                    $ld = " AND month(s.created_on)='" . date('m', strtotime($data['search_dt1'])) . "' and year(s.created_on) = '" . date('Y', strtotime($data['search_dt1'])) . "' ";
                } elseif (isset($data['search_dt2']) && $data['search_dt2'] != '') {

                    // $wdt = "AND year(called_on)='" .date('Y',strtotime($data['search_dt2'])). "'";
                    $ld = " AND year(s.created_on)='" . date('Y', strtotime($data['search_dt2'])) . "'";
                }
            } elseif ($data['duration'] == 'durationn') {

                $durationFrom = date('Y-m-d', strtotime($data['durationFrom'])); //date('Y-m-d',strtotime('-1 days'));

                $durationTo = date('Y-m-d', strtotime($data['durationTo'])); //date('Y-m-d', strtotime('-3 days'));



                $ld = "AND s.created_on BETWEEN '" . date('Y-m-d', strtotime($data['durationFrom'])) . " 00:00:00' AND '" . date('Y-m-d', strtotime($data['durationTo'])) . " 23:59:59'";
            }
        }
        $umsdb = $this->load->database('umsdb', TRUE);
        //,sm.ic_code,sm.id as student_id,sm.mobile1_valid,sm.utm_source,sm.event_code,s.created_on as pcreated,sm.programme_year, sm.created_date as lcreated_date
        //LEFT JOIN (select s11.* from currentdb.student_meet_details s11 where s11.academic_year='$year') as sm   on ((s.mobile=sm.mobile1)  AND sm.academic_year='$year' )

        $sql = "SELECT v.course_type,s.email,enquiry_student_master.enquiry_taken,s.enrollment_no,s.first_name,s.mobile as mobile1, enquiry_student_master.is_from_consultant  as is_from_reference,enquiry_student_master.created_on as is_from_reference_created_on,enquiry_student_master.enquiry_id,s.admission_confirm,s.adhar_card_no,enquiry_student_master.created_by as eqid,s.created_on as pcreated,
	states.state_name,taluka_master.taluka_name,district_name.district_name,
	v.school_short_name as school_name,v.course_short_name as course_name,v.stream_name,s.current_semester,s.current_year,s.mobile
	FROM student_master s LEFT JOIN vw_stream_details v ON v.stream_id=s.admission_stream
	left join enquiry_student_master on (s.adhar_card_no=enquiry_student_master.aadhar_card and s.adhar_card_no !='' and s.adhar_card_no !='0')
	LEFT JOIN (SELECT COUNT(stud_id) AS Confirm_count,stud_id FROM student_master LEFT JOIN vw_stream_details vv
	ON vv.stream_id=admission_stream
	WHERE cancelled_admission='N' AND is_detained='N' AND admission_session ='$year' 
	AND academic_year ='$year' AND enrollment_no !='' AND admission_confirm='Y' GROUP BY vv.stream_name ) AS p ON p.stud_id=s.stud_id
	left join address_details on address_details.student_id=s.stud_id and address_details.adds_of='STUDENT'
	left join states on address_details.state_id=states.state_id
	left join taluka_master on address_details.city=taluka_master.taluka_id
	left join district_name on address_details.district_id=district_name.district_id
	WHERE s.cancelled_admission='N' AND s.is_detained='N' 
	AND s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !='' $course_cond AND v.course_id !=15  $ld  and STR_TO_DATE(s.created_on,'%Y-%m-%d') <= '2021-09-09' and s.nationality='Indian'
	$and_condition group by s.stud_id desc  ";

        // # currentdb.student_meet_details sm (select distinct(s11.id) as id,s11.* from currentdb.student_meet_details s11 where s11.academic_year='$year'  ) as sm #  and s.mobile='9022804810'
        //echo $sql;
        #exit;
        $query = $umsdb->query($sql);

        $res = $query->result_array();
        return $res;
    }

    function get_belonings_based_on_date_new($mobile, $email, $date = '')
    {
        $cyear = $this->config->item('current_year');
        $con = '';
        $con1 = '';
        if (!empty($email)) {
            $con = " or smd.email='$email' ";
        }
        if (!empty($date)) {
            $con1 = " and  STR_TO_DATE(smd.created_date,'%Y-%m-%d %H:%i:%s')<'$date'  and  STR_TO_DATE(calling_log_details.called_on,'%Y-%m-%d %H:%i:%s')<'$date'";
        }
        //and smd.ic_code NOT IN ('REF/1','REF/2','REF/3')
        //

        return $get_lead_from = $this->db->query("select smd.event_code,smd.ic_code as scode,smd.utm_source,ic.ic_name,COALESCE(ic.center_type,icr.center_type) as center_type,icr.center_type as calling_center_type,icr.ic_code,smd.id,smd.mobile1,smd.created_date,calling_log_details.called_on,icr.ic_name as cname  from " . currentdb . ".student_meet_details as smd left join " . currentdb . ".ic_registration as ic
on smd.ic_code=ic.ic_code 
left join calling_log_details on smd.id=calling_log_details.student_id
left join user_master on user_master.um_id=calling_log_details.called_by
left join ic_registration as icr on icr.ic_code=user_master.ic_code

where  smd.academic_year='$cyear' and ( smd.whatsappno='$mobile' or smd.mobile1='$mobile' or smd.pmobile_no='$mobile' or smd.pwhatsapp_no='$mobile' $con)    $con1 group by calling_log_details.called_by order by calling_log_details.called_on
")->result();
    }



    function check_with_secondary_no_with_no($mobile, $email = '')
    {
        $cyear = $this->config->item('current_year');
        $con = '';
        if (!empty($email)) {
            $con = " or smd.email='$email' ";
        }
        return $get_lead_from = $this->db->query("select smd.utm_source,ic.ic_name,ic.center_type,ic.ic_code,smd.id,smd.mobile1,smd.created_date  from " . currentdb . ".student_meet_details as smd left join " . currentdb . ".ic_registration as ic
on smd.ic_code=ic.ic_code where (smd.whatsappno='$mobile' or smd.mobile1='$mobile' or smd.pmobile_no='$mobile' or smd.pwhatsapp_no='$mobile' $con) AND smd.academic_year='$cyear' ")->row();
    }






    function final_provisional_admission_using_addhar($year = '', $course_id = '', $data = array())
    {

        $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');

        $and_condition = '';
        if ($role_id == '9') {

            //$and_condition =' and ( sm.utm_source="website" or sm.utm_source="Facebook" or sm.utm_source="google") ';
        } elseif ($role_id == '33' || $role_id == '17') {
            $c_by = $this->session->userdata('uid');
            $and_condition = "and enquiry_student_master.created_by='$c_by'";
        }
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        if ($course_id != '') {
            $course_cond = " AND v.course_id =$course_id ";
        }

        if ($rowno != '' && $rowperpage != '') {
            $lm = 'limit ' . $rowno . ',' . $rowperpage;
        } else {
            $lm = '  ';
        }
        $ld = '';
        if (!empty($data)) {
            if (($data['duration'] == 'day') || ($data['duration'] == 'month') || ($data['duration'] == 'year')) {

                if (isset($data['search_dt']) && $data['search_dt'] != '') {


                    $ld = " AND STR_TO_DATE(s.created_on,'%Y-%m-%d') = '" . date('Y-m-d', strtotime($data['search_dt'])) . "' ";
                } elseif (isset($data['search_dt1']) && $data['search_dt1'] != '') {

                    // $wdt = "AND month(called_on)='".date('m',strtotime($data['search_dt1']))."' and year(called_on) = '".date('Y',strtotime($data['search_dt1']))."' ";
                    $ld = " AND month(s.created_on)='" . date('m', strtotime($data['search_dt1'])) . "' and year(s.created_on) = '" . date('Y', strtotime($data['search_dt1'])) . "' ";
                } elseif (isset($data['search_dt2']) && $data['search_dt2'] != '') {

                    // $wdt = "AND year(called_on)='" .date('Y',strtotime($data['search_dt2'])). "'";
                    $ld = " AND year(s.created_on)='" . date('Y', strtotime($data['search_dt2'])) . "'";
                }
            } elseif ($data['duration'] == 'durationn') {

                $durationFrom = date('Y-m-d', strtotime($data['durationFrom'])); //date('Y-m-d',strtotime('-1 days'));

                $durationTo = date('Y-m-d', strtotime($data['durationTo'])); //date('Y-m-d', strtotime('-3 days'));



                $ld = "AND s.created_on BETWEEN '" . date('Y-m-d', strtotime($data['durationFrom'])) . " 00:00:00' AND '" . date('Y-m-d', strtotime($data['durationTo'])) . " 23:59:59'";
            }
        }
        $umsdb = $this->load->database('umsdb', TRUE);
        //,sm.ic_code,sm.id as student_id,sm.mobile1_valid,sm.utm_source,sm.event_code,s.created_on as pcreated,sm.programme_year, sm.created_date as lcreated_date
        //LEFT JOIN (select s11.* from currentdb.student_meet_details s11 where s11.academic_year='$year') as sm   on ((s.mobile=sm.mobile1)  AND sm.academic_year='$year' )

        $sql = "SELECT au.created_by as cd,s.email,enquiry_student_master.enquiry_taken,s.enrollment_no,s.first_name,s.mobile as mobile1,sm.ic_code,s.email,sm.id as student_id,sm.mobile1_valid,sm.utm_source,sm.event_code,s.created_on as pcreated,sm.programme_year, sm.created_date as lcreated_date, enquiry_student_master.is_from_consultant  as is_from_reference,enquiry_student_master.created_on as is_from_reference_created_on,enquiry_student_master.enquiry_id,s.admission_confirm,s.adhar_card_no,s.enrollment_no_new as enrollment_no,states.state_name,taluka_master.taluka_name,district_name.district_name,
	v.school_short_name as school_name,v.course_short_name as course_name,v.stream_name,s.current_semester,s.current_year,s.mobile

 FROM student_master s 
 left join " . currentdb . ".aadhar_car_updation as au on s.adhar_card_no=au.add_no
 left join enquiry_student_master on s.adhar_card_no=enquiry_student_master.aadhar_card and s.adhar_card_no!=0
 LEFT JOIN vw_stream_details v ON v.stream_id=s.admission_stream
 left join address_details on address_details.student_id=s.stud_id and address_details.adds_of='STUDENT'
	left join states on address_details.state_id=states.state_id
	left join taluka_master on address_details.city=taluka_master.taluka_id
	left join district_name on address_details.district_id=district_name.district_id
left JOIN (select s11.* from " . currentdb . ".student_meet_details s11 where s11.academic_year='$year') as sm

on ((au.student_id=sm.id)  AND sm.academic_year='$year' ) WHERE
  s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !=''  AND s.is_detained='N' and s.cancelled_admission='N'   and s.nationality='Indian'  and STR_TO_DATE(s.created_on,'%Y-%m-%d') > '2021-09-09'  
       
 $course_cond   $ld   
  $and_condition  
group by s.stud_id desc  $lm ";

        // # currentdb.student_meet_details sm (select distinct(s11.id) as id,s11.* from currentdb.student_meet_details s11 where s11.academic_year='$year'  ) as sm # and s.adhar_card_no='474667145848'
        //echo $sql;
        #exit;
        $query = $umsdb->query($sql);

        $res = $query->result_array();
        return $res;
    }


    function get_center_type($created_by)
    {
        $cyear = $this->config->item('current_year');
        $con = '';

        //and smd.ic_code NOT IN ('REF/1','REF/2','REF/3')
        //
        if (!empty($created_by)) {
            return $get_lead_from = $this->db->query("select ic_name,center_type from  ic_registration where ic_code='$created_by'
")->row();
        } else {
            return array();
        }
    }

    function role_list()
    {
        return $this->db->query("select * from roles_master where status='Y' and roles_id IN (2,4,7,8,27,33,34,35)")->result_array();
    }



    function get_students_data_for_third_partyList($year = '', $postData = '')
    {


        $response = array();

        ## Read value
        $draw = $postData['draw'];
        $start = $postData['start'];
        $rowperpage = $postData['length']; // Rows display per page
        $columnIndex = $postData['order'][0]['column']; // Column index
        $columnName = $postData['columns'][$columnIndex]['data']; // Column name
        $columnSortOrder = $postData['order'][0]['dir']; // asc or desc
        $searchValue = $postData['search']['value']; // Search value

        ## Search 
        $searchQuery = "";
        if ($searchValue != '') {
            $searchQuery = " and (id like '%" . $searchValue . "%' or 
                emp_name like '%" . $searchValue . "%' or 
                email like '%" . $searchValue . "%' or 
                city like'%" . $searchValue . "%' ) ";
        }


        ## Total number of records without filtering

        $cons = "";
        $sc_con2 = "";
        $source = '';
        $year = base64_decode($year);
        if ($year != "") {
            $sc_con2 = "  s.academic_year='$year' ";
        }

        $c_by = $this->session->userdata('uid');

        if ($c_by == 3437) {
            $source = " and   s.utm_source IN ('College Duniya','College Dunia') ";
        } elseif ($c_by == 3439) {
            $source = " and   s.utm_source IN ('College Search') ";
        } elseif ($c_by == 4032) {
            $source = " and   s.utm_source IN ('Shiksha') ";
        } elseif ($c_by == 3438) {
            $source = " and   s.utm_source IN ('Reviewadda') ";
        }

        $sql = "select asa.add_no,s.email,s.stream_name as smstream_name,std.stream_name,std.school_short_name as school_name,s.student_name,
            s.adhar_no,s.country_name,s.state_name,s.city_name,s.mobile1,s.mobile1_valid,s.whatsappno,s.created_date,
            s.pmobile_no,s.pwhatsapp_no,s.utm_source,s.id as student_id ,c.calling_status,c.called_on
            from 
            student_meet_details as s 
            left join su_sf_sijoul_stream_details as std on s.programme_id=std.stream_id and s.campus_id=std.belongtocampus
            left join lead_assign_details l on l.stud_id=s.id and s.academic_year=l.academic_year and l.academic_year='" . ACADEMIC_YEAR . "'
            left join aadhar_car_updation  asa on s.id=asa.student_id
            left join (select c.* from calling_log_details c 
            where c_id=(select max(c_id) from calling_log_details c1 where c1.student_id=c.student_id)
            )as c on s.id=c.student_id
             where $sc_con2  $source $searchQuery";
        $orderby = "group by s.id  order by s.id desc";
        $sql1 = " $sql $orderby";
        //print_r($sql1); exit;
        $query = $this->db->query($sql1);
        $res = $query->num_rows();
        $totalRecords = $res;


        if ($searchQuery != '') {
            $query1 = $this->db->query($sql1);
            $res = $query1->num_rows();
            $totalRecordwithFilter = $res1;
        }


        $columnOrder = "$sql1 order by $columnName limit 0,10";
        $query2 = $this->db->query($columnOrder);
        $records = $query2->result();


        $data = array();
        $n = 1;
        foreach ($records as $record) {

            $data[] = array(
                // "n"=>$n++,
                "email" => $record->email,
                //"mobile1"=>$record->mobile1,
                //"utm_source"=>$record->utm_source,
                //"last_date"=>$record->last_date
            );
        }

        ## Response
        $response = array(
            "draw" => intval($draw),
            "iTotalRecords" => $totalRecords,
            "iTotalDisplayRecords" => $totalRecordwithFilter,
            "aaData" => $data
        );

        return $response;


        /*$this->db->select('count(*) as allcount');
      $records = $this->db->get('employees')->result();
      $totalRecords = $records[0]->allcount;*/

        ## Total number of record with filtering
        //$this->db->select('count(*) as allcount');
        //if($searchQuery != '')
        //{
        //$this->db->where($searchQuery);
        //}
        //$records = $this->db->get('employees')->result();


        //$totalRecordwithFilter = $records[0]->allcount;


        ## Fetch records
        //$this->db->select('*');
        //if($searchQuery != '')
        // $this->db->where($searchQuery);
        //$this->db->order_by($columnName, $columnSortOrder);
        //$this->db->limit($rowperpage, $start);
        //$records = $this->db->get('employees')->result();


        /*
      $data = array();

      foreach($records as $record ){
         
          $data[] = array( 
             "id"=>$record->id,
              "emp_name"=>$record->emp_name,
              "email"=>$record->email,
              "gender"=>$record->gender,
              "salary"=>$record->salary,
              "city"=>$record->city
          ); 
      }

      ## Response
      $response = array(
          "draw" => intval($draw),
          "iTotalRecords" => $totalRecords,
          "iTotalDisplayRecords" => $totalRecordwithFilter,
          "aaData" => $data
      );

      return $response; 
  
      /*
    $start = '0'; 
    $rowperpage1 = '10'; 
    //print_R($postData); exit;

    $response = array();
     ## Read value
     $draw = $postData['draw'];
     $start =  isset($postData['start'])?$postData['start']:'';
     //$rowperpage =  isset($postData['rowperpage'])?$postData['rowperpage']:'';
     //$rowperpage = $postData['length']; // Rows display per page
     //$rowperpage1 = isset($postData['rowperpage1'])?$postData['rowperpage1']:'';
     $columnIndex = $postData['order'][0]['column']; // Column index
     $columnName = $postData['columns'][$columnIndex]['data']; // Column name
     $columnSortOrder = $postData['order'][0]['dir']; // asc or desc
     $searchValue = $postData['search']['value']; // Search value

     ## Search 
     $searchQuery = "";
     if($searchValue != ''){
        $searchQuery = " where (sm.student_name like '%".$searchValue."%' or sm.mobile1 like '%".$searchValue."%' or ss.utm_source like'%".$searchValue."%' ) ";
     }
     else
    {
        $searchQuery = '';
    }
    


    $cons="";$sc_con2="";$source='';
    $year=base64_decode($year);
    if($year!=""){
        $sc_con2="  s.academic_year='$year' ";
        }
        
        $c_by = $this->session->userdata('uid');
        
        if($c_by==3437){
            $source=" and   s.utm_source IN ('College Duniya','College Dunia') ";
        }
        elseif($c_by==3439){
            $source=" and   s.utm_source IN ('College Search') ";
            
            
        }
        elseif($c_by==4032){
            $source=" and   s.utm_source IN ('Shiksha') ";
            
            
        }
        elseif($c_by==3438){
            $source=" and   s.utm_source IN ('Reviewadda') ";
        }

        $sql="select asa.add_no,s.email,s.stream_name as smstream_name,std.stream_name,std.school_short_name as school_name,s.student_name,
            s.adhar_no,s.country_name,s.state_name,s.city_name,s.mobile1,s.mobile1_valid,s.whatsappno,s.created_date,
            s.pmobile_no,s.pwhatsapp_no,s.utm_source,s.id as student_id ,c.calling_status,c.called_on
            from 
            student_meet_details as s 
            left join su_sf_sijoul_stream_details as std on s.programme_id=std.stream_id and s.campus_id=std.belongtocampus
            left join lead_assign_details l on l.stud_id=s.id and s.academic_year=l.academic_year and l.academic_year='".ACADEMIC_YEAR."'
            left join aadhar_car_updation  asa on s.id=asa.student_id
            left join (select c.* from calling_log_details c 
            where c_id=(select max(c_id) from calling_log_details c1 where c1.student_id=c.student_id)
            )as c on s.id=c.student_id
             where $sc_con2  $source group by s.id  order by s.id desc ";
       // print_r($sql); exit;  
       //$query = $this->db->query($sql);
       // $query = $this->db->query($sql);   
        //$res = $query->result_array();
        

        $sql1=" $sql limit $start, $rowperpage1"; 
        $query = $this->db->query($sql1);
        $records = $query->result();
        $totalRecordwithFilter = $query->num_rows();
        $totalRecords = $this->db->query($sql1)->num_rows();

         $data = array();
         $n = 1;
         foreach($records as $record ){

            $data[] = array( 
              // "n"=>$n++,
               "email"=>$record->email,
               //"mobile1"=>$record->mobile1,
               //"utm_source"=>$record->utm_source,
               //"last_date"=>$record->last_date
            );
           
         }

         ## Response
         $response = array(
            "draw" => intval($draw),
            "iTotalRecords" => $totalRecords,
            "iTotalDisplayRecords" => $totalRecordwithFilter,
            "aaData" => $data
         );

         return $response; 
         */
    }

    function get_students_data_for_third_party($year = '', $campus = '')

    {
        ini_set('memory_limit', '-1');
        $cons = "";
        $sc_con2 = "";
        $source = '';
        $year = base64_decode($year);

        if ($year != "") {
            $sc_con2 = " and  s.academic_year='$year' ";
        }

        $c_by = $this->session->userdata('uid');

        if ($c_by == 3437) {
            $source = " and   s.utm_source ='College Dunia' ";
        } elseif ($c_by == 3439) {
            $source = " and   s.utm_source IN ('College Search') ";
        } elseif ($c_by == 4032) {
            $source = " and   s.utm_source IN ('Shiksha') ";
        } elseif ($c_by == 3438) {
            $source = " and   s.utm_source IN ('Reviewadda') ";
        } elseif ($c_by == 4929) {


            $source = " and   s.utm_source IN ('Getmyuni') ";
        } else {
            //print_r($_SESSION);
            //exit;
            $s = $_SESSION['name'];
            $source = " and   s.utm_source IN ('$s') ";
        }




        //select s.*,s.id as student_id,COALESCE((select calling_status from calling_log_details where student_id=s.id order by c_id desc limit 1),'NA') as call_status,sp.* from student_meet_details as s left join sandipun_univerdb.school_programs_new as sp on s.programme_id=sp.sp_id where s.academic_year='2021-22' and s.utm_source IN ('College Duniya','College Dunia') group by s.id order by s.id desc limit 100 left join lead_assign_details l on l.stud_id=s.id and s.academic_year=l.academic_yearl.calling_status,left join lead_assign_details l on l.stud_id=s.id and s.academic_year=l.academic_year and l.academic_year='".ACADEMIC_YEAR."'
        /*left join (select c.* from calling_log_details c 
where c_id=(select max(c_id) from calling_log_details c1 where c1.student_id=c.student_id)
)as c on s.id=c.student_id&
#left join su_sf_sijoul_stream_details as std on s.programme_id=std.stream_id and #s.campus_id=std.belongtocampus
		std.stream_name,std.school_short_name as school_name,
		
		
		#left join aadhar_car_updation  asa on s.id=asa.student_id

*/
        /* echo $sql="select '' as add_no,s.email,s.stream_name as smstream_name,s.student_name,
		s.adhar_no,s.country_name,s.state_name,s.city_name,s.mobile1,s.mobile1_valid,s.whatsappno,s.created_date,
		s.utm_source,s.id as student_id ,s.latest_calling_status as calling_status, '' as called_on
		from 
		affliatesdata as s 
		
		
		 where $sc_con2  $source group by s.id  order by s.id desc ";
		exit;*/
        $ld = '';
        $cs = '';
        $um = '';
        $cmp = '';
        if (!empty($_POST)) {
            $data = $_POST;
            if (($data['duration'] == 'day') || ($data['duration'] == 'month') || ($data['duration'] == 'year')) {

                if (isset($data['search_dt']) && $data['search_dt'] != '') {


                    $ld = " AND STR_TO_DATE(s.created_date,'%Y-%m-%d') = '" . date('Y-m-d', strtotime($data['search_dt'])) . "' ";
                } elseif (isset($data['search_dt1']) && $data['search_dt1'] != '') {

                    // $wdt = "AND month(called_on)='".date('m',strtotime($data['search_dt1']))."' and year(called_on) = '".date('Y',strtotime($data['search_dt1']))."' ";
                    $ld = " AND month(s.created_date)='" . date('m', strtotime($data['search_dt1'])) . "' and year(s.created_date) = '" . date('Y', strtotime($data['search_dt1'])) . "' ";
                } elseif (isset($data['search_dt2']) && $data['search_dt2'] != '') {

                    // $wdt = "AND year(called_on)='" .date('Y',strtotime($data['search_dt2'])). "'";
                    $ld = " AND year(s.created_date)='" . date('Y', strtotime($data['search_dt2'])) . "'";
                }
            } elseif ($data['duration'] == 'durationn') {

                $durationFrom = date('Y-m-d', strtotime($data['durationFrom'])); //date('Y-m-d',strtotime('-1 days'));

                $durationTo = date('Y-m-d', strtotime($data['durationTo'])); //date('Y-m-d', strtotime('-3 days'));



                $ld = "AND s.created_date BETWEEN '" . date('Y-m-d', strtotime($data['durationFrom'])) . " 00:00:00' AND '" . date('Y-m-d', strtotime($data['durationTo'])) . " 23:59:59'";
            }
            if (isset($_POST['calling_status']) && !empty($_POST['calling_status'])) {
                $cs = " and latest_calling_status='" . $_POST['calling_status'] . "'";
            }



            if (isset($_POST['utm_medium']) && !empty($_POST['utm_medium'])) {
                $um = " and s.utm_medium='" . $_POST['utm_medium'] . "'";
            }

            if (isset($_POST['campus']) && !empty($_POST['campus'])) {
                $cmp = " and s.campus_id='" . $_POST['campus'] . "'";
            }
        }

        if (empty($cmp)) {
            if (isset($campus) && !empty($campus)) {
                $cmp = " and s.campus_id='" . $campus . "'";
            }
        }


        $sql = " select *,a.add_no,s.id as std_id,s.id as student_id,c.called_on from affliatesdata s 
 left join su_sf_sijoul_stream_details as strm on s.programme_id=strm.stream_id and s.campus_id=strm.belongtocampus
left join (select add_no,student_id from aadhar_car_updation  a where a.add_no !='' group by student_id)

a on s.id=a.student_id
left join (SELECT MAX(called_on) as called_on,student_id FROM calling_log_details

 GROUP BY student_id) as c on s.id=c.student_id
 where 1=1 $source $sc_con2 $ld $cs $um $cmp group by s.id  order by s.id desc ";

        if (empty($_POST)) {
            $sql .= " limit 5000 ";
        }

        //echo $sql;
        //exit;

        $query = $this->db->query($sql);
        $res = $query->result_array();
        return $res;
    }

    function get_all_calling_status()
    {
        return $this->db->query("select latest_calling_status from student_meet_details
where latest_calling_status !='' 
 group by latest_calling_status")->result();
    }
    function get_renquired_students_third_party($year = '')

    {

        $cons = "";
        $sc_con2 = "";
        $source = '';
        $year = base64_decode($year);

        if ($year != "") {
            $sc_con2 = "  sm.academic_year='$year' ";
        }

        $c_by = $this->session->userdata('uid');

        if ($c_by == 3437) {
            $source = " and   sm.utm_source IN ('College Duniya','College Dunia') ";
            $utm_source = " and   g.utm_source IN ('College Duniya','College Dunia')";
        } elseif ($c_by == 3439) {
            $source = " and   sm.utm_source IN ('College Search') ";
            $utm_source = " and   g.utm_source IN ('College Search')";
        } elseif ($c_by == 4032) {
            $source = " and   sm.utm_source IN ('Shiksha') ";
            $utm_source = " and   g.utm_source IN ('Shiksha')";
        } elseif ($c_by == 3438) {
            $source = " and   sm.utm_source IN ('Reviewadda') ";
            $utm_source = " and   g.utm_source IN ('Reviewadda')";
        } elseif ($c_by == 4929) {
            $source = " and   sm.utm_source IN ('Getmyuni') ";
            $utm_source = " and   g.utm_source IN ('Getmyuni')";
        } else {
            //print_r($_SESSION);
            //exit;
            $usource = $_SESSION['name'];
            $source = " and   sm.utm_source IN ('$usource') ";
            $utm_source = " and   g.utm_source IN ('$usource')";
        }



        $sql = "select sm.id,sm.student_name,sm.mobile1,sm.email from get_secondary_sources g
		join student_meet_details as sm on g.student_id=sm.id $utm_source
		where $sc_con2 $source group by g.student_id order by g.id desc";

        $query = $this->db->query($sql);

        $res = $query->result_array();
        return $res;
    }



    public function fees_challan_list_byid_nj($id)
    {
        $umsdb = $this->load->database('umsdb', TRUE);
        $umsdb->select("fee.*,sm.current_year,sm.mobile,sm.first_name,sm.middle_name,sm.last_name,sm.academic_year as sacademic_year,sm.enrollment_no,sm.stud_id,
		sm.admission_stream,sm.enquiry_no,vw.stream_name as stream_name,vw.course_short_name as course_name, vw.school_short_name as school_name,
		sandipun_erp.bank_master.bank_id, 
		sandipun_erp.bank_master.bank_name, 
		sandipun_erp.bank_master.account_name,
		sandipun_erp.bank_master.bank_account_no as account_no,
		sandipun_erp.bank_master.clinet_id,
		sandipun_erp.bank_master.branch_name,
		sandipun_erp.bank_master.bank_code,
		sandipun_ums.bank_master.bank_id as ubank_id,
		sandipun_ums.bank_master.bank_name as ubank_name,
		sandipun_erp.user_master.display_name
		");
        $umsdb->from("sandipun_ums.fees_challan fee");

        $umsdb->join("sandipun_ums.student_master sm", "sm.enrollment_no=fee.enrollment_no OR sm.enrollment_no_new=fee.enrollment_no", 'LEFT');
        $umsdb->join("sandipun_ums.vw_stream_details vw", "sm.admission_stream = vw.stream_id", 'LEFT');
        $umsdb->join("sandipun_erp.bank_master", "sandipun_erp.bank_master.bank_id = fee.bank_account_id", 'LEFT');
        $umsdb->join("sandipun_ums.bank_master", "sandipun_ums.bank_master.bank_id = fee.bank_id", 'LEFT');
        $umsdb->join("sandipun_erp.user_master", "sandipun_erp.user_master.um_id = fee.created_by", 'LEFT');
        //$this->db->join("sandipun_erp.sf_bank_account_details","sandipun_erp.sf_bank_account_details.bank_account_id = fee.bank_account_id");
        $umsdb->where('fee.is_deleted', 'N');
        $umsdb->where('fee.fees_id', $id);

        $query1 = $umsdb->get();

        return $query1->row_array();
    }



    public function get_all_consultants_list_on_basis_of_ic($data)
    {

        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $is_fou = ' and (c.is_fou is NULL or c.is_fou=0)  ';

        $wh = '';
        if (isset($data) && !empty($data)) {
            if (isset($data) && !empty($data['icfilter'])) {
                $wh = " and c.ic_code='" . $data['icfilter'] . "' ";
            }


            if (!empty($data['is_fou'])) {
                $is_fou = ' and c.is_fou =1';
            }
        } else {
            if ($role_id == '1' || $role_id == '30') {
                $wh = "and (c.counselor_type='FOU' or c.counselor_type='CL') and status='Y' ";
            } elseif (($role_id == '7')) {
                $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
            } elseif ($role_id == 27) {
                $ss = $this->db->query("select group_concat(ic_code) as ic_code
			from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
                $ss = explode(",", $ss);
                $ss = "'" . implode("', '", $ss) . "'";
                $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;

                $wh = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by) OR c.consultant_head= '" . $this->session->userdata('uid') . "')";
            }
        }

        $sql = "select c.*,um.roles_id,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id from
			consultants_call_details as c 
			inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' 
			left join admission_benefits_and_source as a on a.benefit_to=um.um_id and a.belong_to_ic=4
			left join states as s on c.state_id = s.id
			left join cities as ci ON ci.id=c.city_id
			where c.status='Y' and  c.counselor_type != 'NULL' $wh $is_fou
			group by c.id order by c.contact_person";





        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;

        //left join sandipun_ums.enquiry_student_master as sm on um.um_id=sm.created_by and sm.is_from_consultant=1 left join sandipun_ums.student_master as msm on sm.enquiry_id=msm.enquiry_id inner join roles_master as rm ON rm.roles_id=um.roles_id


    }



    public function get_all_consultants_list_on_basis_of_consultant_head($data)
    {

        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';


        $is_fou = ' and (c.is_fou is NULL or c.is_fou=0)  ';
        $wh = '';
        if (isset($data) && !empty($data)) {
            if (isset($data) && !empty($data['consultant_head'])) {
                $chid = $data['consultant_head'];
                $ss = $this->db->query("select group_concat(ic_code) as ic_code
					from ic_mapping where consultant_head= $chid and status='Y'")->row()->ic_code;
                $ss = explode(",", $ss);
                $ss = "'" . implode("', '", $ss) . "'";
                $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
			           from consultant_cordinator_mapping where consultant_id=$chid and status='Y'")->row()->cordinator_id;
                $wh = " and (c.ic_code IN ($ss) OR c.inserted_by='$chid' OR c.inserted_by IN ($referred_by) OR c.consultant_head= '$chid')";
            }

            if (!empty($data['is_fou'])) {
                $is_fou = ' and c.is_fou =1';
            }
        } else {
            if ($role_id == '1' || $role_id == '30') {
                $wh = "and (c.counselor_type='FOU' or c.counselor_type='CL')";
            } else if (($role_id == '7')) {

                $wh = " and c.ic_code='" . $this->session->userdata('ic_code') . "'";
            } else if ($role_id == 27) {
                $ss = $this->db->query("select group_concat(ic_code) as ic_code
			from ic_mapping where consultant_head=$uid and status='Y'")->row()->ic_code;
                $ss = explode(",", $ss);
                $ss = "'" . implode("', '", $ss) . "'";
                $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=$uid and status='Y'")->row()->cordinator_id;

                $wh = " and (c.ic_code IN ($ss) OR c.inserted_by='" . $this->session->userdata('uid') . "' OR c.inserted_by IN ($referred_by) OR c.consultant_head= '" . $this->session->userdata('uid') . "')";
            }
        }

        $sql = "select c.*,um.roles_id,rm.roles_name,um.um_id from
			consultants_call_details as c 
			inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
			join admission_benefits_and_source as a on a.benefit_to=um.um_id and a.belong_to_ic=4
			
			
			inner join roles_master as rm ON rm.roles_id=um.roles_id
			
			where c.status='Y' and  c.counselor_type != 'NULL' $wh $is_fou
			group by c.id order by c.contact_person";

        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }



    function get_all_cordinators_on_basis_of_consultant_head($data)
    {
        $uid = $this->session->userdata("uid");
        $this->db->select('ic_user_master.*,user_master.um_id');
        $this->db->from('consultant_cordinator_mapping');
        $this->db->join("user_master", "user_master.um_id=consultant_cordinator_mapping.cordinator_id");
        $this->db->join("ic_user_master", "ic_user_master.employee_code=user_master.employee_code");
        $this->db->where('consultant_cordinator_mapping.status', "Y");
        if (isset($data) && !empty($data['consultant_head'])) {
            $this->db->where('consultant_cordinator_mapping.consultant_id', $data['consultant_head']);
        }
        $query = $this->db->get();
        $result = $query->result_array();
        return $result;
    }


    public function get_all_consultants_list_on_basis_of_ac($data)
    {

        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';

        $is_fou = ' and (c.is_fou is NULL or c.is_fou=0)  ';

        $wh = '';
        if (isset($data) && !empty($data)) {
            if (isset($data) && !empty($data['ac'])) {
                $chid = $data['ac'];

                $wh = " and (c.co_reff_by='$chid' OR c.inserted_by='$chid' )";
            }

            if (!empty($data['is_fou'])) {
                $is_fou = ' and c.is_fou =1';
            }
        }


        $sql = "select c.*,um.roles_id,rm.roles_name from
			consultants_call_details as c 
			inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
			join admission_benefits_and_source as a on a.benefit_to=um.um_id and a.belong_to_ic=4		
			inner join roles_master as rm ON rm.roles_id=um.roles_id
			
			where c.status='Y' and  c.counselor_type != 'NULL' $wh $is_fou
			group by c.id order by c.contact_person";


        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }


    public function get_type_wise_consultant($data)
    {

        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';



        $wh = '';
        if (isset($data) && !empty($data)) {


            if (!empty($data['type'])) {
                $is_fou = ' and c.is_fou =' . $data['type'];
            }
        }


        $sql = "select c.*,um.roles_id,rm.roles_name,um.um_id from
			consultants_call_details as c 
			inner join user_master as um ON (um.employee_code = c.employee_code OR um.con_id=c.id ) AND c.status='Y' and c .status=um.status and c .status='Y'
			join admission_benefits_and_source as a on a.benefit_to=um.um_id and a.belong_to_ic=4		
			inner join roles_master as rm ON rm.roles_id=um.roles_id		
			where c.status='Y' and  c.counselor_type != 'NULL' $wh $is_fou
			group by c.id order by c.contact_person";


        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }
















    public function get_all_consultant_payment_report($data, $cid = "")
    {

        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");

        $gtv = "";
        if ($uid == 1741) {
            $gtv = " and c.is_verified=1";
        }
        $rfd11 = '';
        $rfd1 = '';
        $wh1 = "";
        if (!empty($data['consultant']) && $data['consultant'] != ''  && $data['consultant'] != undefined) {
            $rfd11 = ' and um.um_id = "' . $data['consultant'] . '"';
        }
        $c = "";
        $c1 = "";
        if (!empty($data['academic_year']) && $data['academic_year'] != ''  && $data['academic_year'] != undefined) {
            $rfd = '';
            $c1 = $c = $data['academic_year'];
        } else {
            $cyear = $this->config->item('current_year');
            $rfd = '';
            $c1 = $c = $cyear;
        }

        $c = explode('-', $c);
        $c = $c[0];
        $is_fou = ' and (c.is_fou =0 OR c.is_fou IS NULL )';
        if (!empty($data['is_fou']) && $data['is_fou'] == 1) {
            $is_fou = ' and (c.is_fou =1 or c.is_fou =2) ';
        }
        $nc = explode('-', $c1);
        $ACYEAR = $nc[0];
        $ACYEAR2 = $nc[1];
        $ACYEAR = $ACYEAR - 1;
        $ACYEAR2 = $ACYEAR2 - 1;
        $pyear = $ACYEAR . "-" . $ACYEAR2;
        $ci = 'sandipun_ums.enquiry_student_master.academic_year="' . $c . '"';
        if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != undefined) {
            $wh1 = " and c.ic_code='" . $data['icfilter'] . "'";
        }
        $cii = '';
        $ac = '';
        if (!empty($data['ac']) && $data['ac'] != ''  && $data['ac'] != undefined) {

            $ac = ' and c.inserted_by = "' . $data['ac'] . '"';
        }
        $wh = '';

        if (!empty($data['consultant_head']) && $data['consultant_head'] != ''  && $data['consultant_head'] != undefined) {

            $ss = $this->db->query("select group_concat(ic_code) as ic_code
			from ic_mapping where consultant_head=" . $data['consultant_head'] . " and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=" . $data['consultant_head'] . " and status='Y'")->row()->cordinator_id;
            $wh =  " and (c.ic_code IN ($ss) OR c.inserted_by='" . $data['consultant_head'] . "' OR c.inserted_by IN ($referred_by ) OR c.consultant_head=" . $data['consultant_head'] . " ) ";
        }
        //and c.is_verified=1
        $sql = "select CONCAT(ium.fname,' ',ium.lname) as consultanthead,csm.contact_person as cordinator1,
			CONCAT(iumh.fname,' ',iumh.lname) as cordinator,
			ir.ic_name,
			
			
			c.*,um.roles_id,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id,
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
join sandipun_ums.student_master as s on a.student_id=s.stud_id			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and s.cancelled_admission='N' and s.admission_confirm='Y'),0) as nashik_admission,

COALESCE((select count(a.id) from  admission_benefits_and_source as a
join sandipun_ums.student_master as s on a.student_id=s.stud_id			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and s.cancelled_admission='N'),0) as nashik_admissionp,



			COALESCE((select count(a.id) from  admission_benefits_and_source as a 
			join sf_admission_data as s on a.student_id=s.id and a.is_for=3 and s.admission_status='Admission' and s.College='SRP'
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=3
			
			
			),0) as sf_admissions,
			
			
			
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sf_admission_data as s on a.student_id=s.id and a.is_for=3 and s.admission_status='Admission' and s.College!='SRP'

			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=3  ),0) as sf_admissionn,
			
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sandipun_ums_sijoul.fees_challan fs on a.student_id=fs.student_id and a.is_for=2
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2
			and (fs.type_id=2) ),0) as sijoul_admission,
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sandipun_ums_sijoul.student_master sm on a.student_id=sm.stud_id and a.is_for=2
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2   and sm.cancelled_admission='N'
			),0) as sijoul_admissionp,
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join (select student_id,type_id,sum(amount) as amount from  sandipun_ums_sijoul.fees_challan where type_id=2 group by student_id ) as fs on a.student_id=fs.student_id and a.is_for=2			
			join (select distinct(ed.stud_id) from sandipun_ums_sijoul.exam_details ed ) ed on a.student_id=ed.stud_id 
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2
			 and fs.type_id=2 ),0) as sijoul_admission_with_exam_appeared_with_payment,
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            	
			join (select distinct(ed.stud_id) from sandipun_ums_sijoul.exam_details ed ) ed on a.student_id=ed.stud_id 
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2
			),0) as sijoul_admission_with_exam_appeared_without_payment,
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a  join sandipun_ums_sijoul.student_master as s on a.student_id=s.stud_id
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2 and  s.cancelled_admission='N' and s.admission_confirm='Y'),0) as sijoul_proadmission,
			
				
			
			
			
			
			COALESCE((select sum(a.amount) from  admission_benefits_and_source as a 
			join sandipun_ums.student_master as s on a.student_id=s.stud_id
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and s.cancelled_admission='N' and s.admission_confirm='Y'),0) as nashik_admission_amount,
			COALESCE((select sum(a.amount) from  admission_benefits_and_source as a 
			join sandipun_ums.student_master as s on a.student_id=s.stud_id
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and s.cancelled_admission='N' ),0) as nashik_admission_amountp,
			
			COALESCE((select sum(a.amount) from admission_benefits_and_source as a   join sandipun_ums_sijoul.student_master as s on a.student_id=s.stud_id 
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2 and s.cancelled_admission='N' and s.admission_confirm='Y'
			),0) as sijoul_admission_proamount,
			COALESCE((select sum(a.amount) from admission_benefits_and_source as a   join sandipun_ums_sijoul.student_master as s on a.student_id=s.stud_id 
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2 and s.cancelled_admission='N' 
			),0) as sijoul_admission_proamountp,
			
			
			COALESCE((select sum(a.amount) from admission_benefits_and_source as a   join sandipun_ums_sijoul.student_master as s on a.student_id=s.stud_id 
			join (select distinct(ed.stud_id) from sandipun_ums_sijoul.exam_details ed ) ed on a.student_id=ed.stud_id 
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2 and s.cancelled_admission='N' and s.admission_confirm='Y'
			),0) as sijoul_admission_exam_without_payment_amount,
			
			COALESCE((select sum(a.amount) from admission_benefits_and_source as a
            join (select student_id,type_id,sum(amount) as amount from  sandipun_ums_sijoul.fees_challan where type_id=2 group by student_id ) as fs on a.student_id=fs.student_id and a.is_for=2
			join (select distinct(ed.stud_id) from sandipun_ums_sijoul.exam_details ed ) ed on a.student_id=ed.stud_id 
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2
			and (fs.type_id=2)),0) as sijoul_admission_exam_with_payment_amount,
			
			
			
			COALESCE((select sum(a.amount) from admission_benefits_and_source as a
            join sandipun_ums_sijoul.fees_challan fs on a.student_id=fs.student_id and a.is_for=2
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2
			and (fs.type_id=2)),0) as sijoul_admission_amount,
			
			
			
			COALESCE((select sum(a.amount) from  admission_benefits_and_source as a 
			join sf_admission_data as s on a.student_id=s.id and a.is_for=3 and s.admission_status='Admission' and s.College='SRP'
			
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=3 ),0) as sf_admission_amounts,
			
			COALESCE((select sum(a.amount) from  admission_benefits_and_source as a 
			join sf_admission_data as s on a.student_id=s.id and a.is_for=3 and s.admission_status='Admission' and s.College!='SRP'
			
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=3 ),0) as sf_admission_amountn,
			
			
			COALESCE((select sum(a.amount) from  consultant_payment_details as a where  academic_year='$c1' and a.consultant_id=um.um_id ),0) as total_payment,
			
			
			COALESCE((select sum(a.tds) from  consultant_payment_details as a where  academic_year='$c1' and a.consultant_id=um.um_id ),0) as tds,
			COALESCE((select amount from  previous_year_pending as a where academic_year='$pyear' and a.consultant_id=um.um_id ),0) as pp
			
			from
			consultants_call_details as c  
			inner join user_master as um ON um.con_id = c.id 
			left join states as s on c.state_id = s.id
			left join cities as ci ON ci.id=c.city_id
			left join user_master as umo on c.consultant_head=umo.um_id
			left join ic_user_master  as ium on umo.employee_code=ium.employee_code
			left join user_master as umcby on c.inserted_by=umcby.um_id
			left join ic_user_master  as iumh on umcby.employee_code=iumh.employee_code
			
			left join consultants_call_details as csm on umcby.con_id=csm.id
			left join ic_registration as ir on um.ic_code=ir.ic_code
			left join admission_benefits_and_source as am on am.benefit_to=um.um_id and am.academic_year='$c1'
			where c.id !=''  $wh $wh1 $rfd11 $cii $ac $is_fou $gtv group by c.id order by c.contact_person";


        //echo  $sql;
        //exit;
        $drm['uid'] = $uid;
        $drm['query'] = $sql;
        $drm['date'] = date('Y-m-d H:i:s');
        $this->db->insert('testquerytable', $drm);



        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }



    public function get_all_consultant_payment_reporttest($data, $cid = "")
    {

        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $wh1 = "";
        if (!empty($data['consultant']) && $data['consultant'] != ''  && $data['consultant'] != undefined) {
            $rfd11 = ' and um.um_id = "' . $data['consultant'] . '"';
        }
        $c = "";
        $c1 = "";
        if (!empty($data['academic_year']) && $data['academic_year'] != ''  && $data['academic_year'] != undefined) {
            $rfd = '';
            $c1 = $c = $data['academic_year'];
        } else {
            $cyear = $this->config->item('current_year');
            $rfd = '';
            $c1 = $c = $cyear;
        }

        $c = explode('-', $c);
        $c = $c[0];
        $ci = 'sandipun_ums.enquiry_student_master.academic_year="' . $c . '"';
        if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != undefined) {
            $wh1 = " and c.ic_code='" . $data['icfilter'] . "'";
        }
        $cii = '';
        $ac = '';
        if (!empty($data['ac']) && $data['ac'] != ''  && $data['ac'] != undefined) {

            $ac = ' and c.inserted_by = "' . $data['ac'] . '"';
        }
        $wh = '';
        if (!empty($data['consultant_head']) && $data['consultant_head'] != ''  && $data['consultant_head'] != undefined) {

            $ss = $this->db->query("select group_concat(ic_code) as ic_code
			from ic_mapping where consultant_head=" . $data['consultant_head'] . " and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=" . $data['consultant_head'] . " and status='Y'")->row()->cordinator_id;
            $wh =  " and (c.ic_code IN ($ss) OR c.inserted_by='" . $data['consultant_head'] . "' OR c.inserted_by IN ($referred_by ) OR c.consultant_head=" . $data['consultant_head'] . " ) ";
        }
        $Confrmation = " and s.admission_confirm='Y'";
        $Confrmation = '';
        $sql = "select CONCAT(ium.fname,' ',ium.lname) as consultanthead,
			CONCAT(iumh.fname,' ',iumh.lname) as cordinator,
			ir.ic_name,
			
			
			c.*,um.roles_id,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id,
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
join sandipun_ums.student_master as s on a.student_id=s.stud_id			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and s.cancelled_admission='N' $Confrmation),0) as nashik_admission,


			COALESCE((select count(a.id) from  admission_benefits_and_source as a where a.belong_to_ic=4 and academic_year='$c1' and a.benefit_to=um.um_id and is_for=3 and is_cancelled=0),0) as sf_admission,
			
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sandipun_ums_sijoul.fees_challan fs on a.student_id=fs.student_id and a.is_for=2
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2
			and (fs.type_id=2) ),0) as sijoul_admission,
			
			
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a  join sandipun_ums_sijoul.student_master as s on a.student_id=s.stud_id
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2 and  s.cancelled_admission='N' $Confrmation),0) as sijoul_proadmission,
			COALESCE((select sum(a.amount) from  admission_benefits_and_source as a 
			join sandipun_ums.student_master as s on a.student_id=s.stud_id
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and s.cancelled_admission='N' $Confrmation),0) as nashik_admission_amount,
			COALESCE((select sum(a.amount) from admission_benefits_and_source as a   join sandipun_ums_sijoul.student_master as s on a.student_id=s.stud_id 
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2 and s.cancelled_admission='N' $Confrmation),0) as sijoul_admission_proamount,
			COALESCE((select sum(a.amount) from admission_benefits_and_source as a
            join sandipun_ums_sijoul.fees_challan fs on a.student_id=fs.student_id and a.is_for=2
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2
			and (fs.type_id=2')),0) as sijoul_admission_amount,
			COALESCE((select sum(a.amount) from  admission_benefits_and_source as a where a.belong_to_ic=4 and academic_year='$c1' and a.benefit_to=um.um_id and is_for=3),0) as sf_admission_amount,
			COALESCE((select sum(a.amount) from  consultant_payment_details as a where  academic_year='$c1' and a.consultant_id=um.um_id ),0) as total_payment,
			COALESCE((select sum(a.tds) from  consultant_payment_details as a where  academic_year='$c1' and a.consultant_id=um.um_id ),0) as tds
			from
			consultants_call_details as c  
			inner join user_master as um ON um.con_id = c.id 
			left join states as s on c.state_id = s.id
			left join cities as ci ON ci.id=c.city_id
			left join user_master as umo on c.consultant_head=umo.um_id
			left join ic_user_master  as ium on umo.employee_code=ium.employee_code
			left join user_master as umcby on c.inserted_by=umcby.um_id
			left join ic_user_master  as iumh on umcby.employee_code=iumh.employee_code
			left join ic_registration as ir on um.ic_code=ir.ic_code
			where c.id !=''  $wh $wh1 $rfd11 $cii $ac $is_fou group by c.id order by c.contact_person";
        //echo $sql;
        //exit;
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }


    function get_count_of_admission_done_role_wise($um_id, $current_year1 = '')
    {

        if ($current_year1 == '') {
            $current_year1 = $this->config->item('current_year');
        }








        return $this->db->query("select COALESCE(sum(count),0)  as tc from(
select count(*) as count from admission_benefits_and_source a join sandipun_ums.student_master as sm on a.student_id=sm.stud_id
where benefit_to='$um_id' and a.academic_year='$current_year1' and sm.cancelled_admission='N' and sm.admission_confirm='Y' and a.is_for=1

UNION ALL 
select count(*) as count from (select stud_id from admission_benefits_and_source a join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id
left join sandipun_ums_sijoul.fees_challan fs on a.student_id=fs.student_id 
where benefit_to='$um_id' and a.academic_year='$current_year1' and sm.cancelled_admission='N' and sm.admission_confirm='Y' and a.is_for=2 
group by sm.stud_id) d


UNION ALL 
select count(*) as count from admission_benefits_and_source a join sf_admission_data as sm on a.student_id=sm.id
where benefit_to='$um_id' and a.academic_year='$current_year1' and sm.admission_status='Admission' and a.is_for=3 and sm.isconfirmed=1

) t")->row()->tc;
    }


    function get_amount_of_admission_done_role_wise($um_id, $current_year1 = '')
    {

        if ($current_year1 == '') {
            $current_year1 = $this->config->item('current_year');
        }








        return $this->db->query("select COALESCE(sum(count),0)  as tc from(
select amount as count from admission_benefits_and_source a join sandipun_ums.student_master as sm on a.student_id=sm.stud_id
where benefit_to='$um_id' and a.academic_year='$current_year1' and sm.cancelled_admission='N' and sm.admission_confirm='Y' and a.is_for=1

UNION ALL 
select d.amount  as count from (select stud_id,a.amount from admission_benefits_and_source a join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id
left join sandipun_ums_sijoul.fees_challan fs on a.student_id=fs.student_id 
where benefit_to='$um_id' and a.academic_year='$current_year1' and sm.cancelled_admission='N' and sm.admission_confirm='Y' and a.is_for=2 
group by sm.stud_id) d


UNION ALL 
select amount  as count from admission_benefits_and_source a join sf_admission_data as sm on a.student_id=sm.id
where benefit_to='$um_id' and a.academic_year='$current_year1' and sm.admission_status='Admission' and a.is_for=3 and sm.isconfirmed=1

) t")->row()->tc;
    }

    function get_role($um_id)
    {

        return $this->db->query("select roles_id  from user_master where um_id='$um_id'")->row()->roles_id;
    }



    function get_renumeration_amount_role_wise($um_id, $current_year = '')
    {
        $current_year1 = $current_year;
        if ($current_year == '') {
            $current_year = $this->config->item('current_year');
        }

        #    join ( select * from sandipun_ums_sijoul.exam_details group by stud_id) ed on admission_benefits_and_source.student_id=ed.stud_id  
        return $this->db->query("select COALESCE(sum(renumeration),0) as renumeration_amout from(select sum(amount) as renumeration from admission_benefits_and_source a
   join sandipun_ums.student_master as sm on a.student_id=sm.stud_id
	where benefit_to='$um_id' and a.academic_year='$current_year1' and  is_for=1 and sm.cancelled_admission='N' and sm.admission_confirm='Y'
	
	
	union 
	
	select sum(renumeration) as renumeration from ( 
	select (admission_benefits_and_source.amount) as renumeration from admission_benefits_and_source
	join sandipun_ums_sijoul.student_master as sm on admission_benefits_and_source.student_id=sm.stud_id
	 join sandipun_ums_sijoul.fees_challan fs on admission_benefits_and_source.student_id=fs.student_id 

	where benefit_to='$um_id' and admission_benefits_and_source.academic_year='$current_year1' and  is_for=2  and sm.cancelled_admission='N' and sm.admission_confirm='Y' and (fs.type_id=2 ) 
	group by sm.stud_id)  d


	union 
	
	select sum(amount) as renumeration from admission_benefits_and_source a join sf_admission_data as sm on a.student_id=sm.id
	where admission_status ='Admission'  and isconfirmed=1 and a.is_for=3 and a.benefit_to='$um_id' and a.academic_year='$current_year1'
	
	
	
	) t")->row()->renumeration_amout;
    }



    public function get_all_employee_list_on_basis_of_ic($data)
    {
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $wh = '';
        $wh11 = '';
        if (isset($data) && !empty($data)) {
            if (isset($data) && !empty($data['icfilter'])) {
                $wh = " and ic.ic_code='" . $data['icfilter'] . "' ";
            }
        }
        if ($role_id == 8) {
            $wh11 = " and (ic.created_by='" . $uid . "' or um.um_id=$uid) ";
        }


        $sql = "select ic.*,um.roles_id,rm.roles_name,um.um_id from
			ic_user_master as ic 
			inner join user_master as um ON (um.employee_code = ic.employee_code) 
			inner join roles_master as rm ON rm.roles_id=um.roles_id
			join admission_benefits_and_source as a on um.um_id=a.benefit_to 
			where um.status='Y'  $wh $wh11
			group by um.um_id order by ic.fname";

        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }

    public function get_details_of_ic_for_payment($data, $cid = "")
    {
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $wh1 = "";
        if (!empty($data['consultant']) && $data['consultant'] != ''  && $data['consultant'] != undefined) {
            $rfd11 = ' and um.um_id = "' . $data['consultant'] . '"';
        }
        $c = "";
        $c1 = "";
        if (!empty($data['academic_year']) && $data['academic_year'] != ''  && $data['academic_year'] != undefined) {
            $rfd = '';
            $c1 = $c = $data['academic_year'];
        } else {
            $cyear = $this->config->item('current_year');
            $rfd = '';
            $c1 = $c = $cyear;
        }

        $c = explode('-', $c);
        $c = $c[0];
        $ci = 'sandipun_ums.enquiry_student_master.academic_year="' . $c . '"';
        if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != undefined) {
            $wh1 = " and c.ic_code='" . $data['icfilter'] . "'";
        }
        $cii = '';
        $ac = '';
        if (!empty($data['ac']) && $data['ac'] != ''  && $data['ac'] != undefined) {

            $ac = ' and c.inserted_by = "' . $data['ac'] . '"';
        }
        $wh = '';
        $ciii = '';
        if (!empty($data['type']) && $data['type'] != ''  && $data['type'] != undefined) {
            if ($data['type'] == 1) {
                $ciii = " and ir.center_type='ic'";
            } elseif ($data['type'] == 2) {
                $ciii = " and ir.center_type='cc'";
            }
            //$rfd11 = ' and um.um_id = "'.$data['consultant'].'"';
        }

        //
        //

        /*
			
			
			,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id,
			COALESCE((select count(a.id) from  admission_benefits_and_source as a where a.belong_to_ic=4 and academic_year='$c1' and a.benefit_to=um.um_id and is_for=1),0) as nashik_admission,
			COALESCE((select count(a.id) from  admission_benefits_and_source as a where a.belong_to_ic=4 and academic_year='$c1' and a.benefit_to=um.um_id and is_for=2),0) as sijoul_admission,
			COALESCE((select sum(a.amount) from  admission_benefits_and_source as a where a.belong_to_ic=4 and academic_year='$c1' and a.benefit_to=um.um_id and is_for=1),0) as nashik_admission_amount,
			COALESCE((select sum(a.amount) from  admission_benefits_and_source as a where a.belong_to_ic=4 and academic_year='$c1' and a.benefit_to=um.um_id and is_for=2),0) as sijoul_admission_amount,
			COALESCE((select sum(a.amount) from  consultant_payment_details as a where  academic_year='$c1' and a.consultant_id=um.um_id ),0) as total_payment
			
			*/
        $sql = "Select * from(select ir.ic_name,um.roles_id,CONCAT(c.fname,' ',c.lname) as name,c.mobile_personal as mobile,c.email_official as email,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id,
			um.payroll,um.ifsc_code,um.account_no,um.payroll_code,
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sandipun_ums.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and sm.cancelled_admission='N' and sm.admission_confirm='Y'),0) as nashik_admission,
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sandipun_ums.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and sm.cancelled_admission='N' ),0) as pnashik_admission,
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sf_admission_data as sm on a.student_id=sm.id 

			where  a.academic_year='$c1' and sm.admission_session='$c' and a.benefit_to=um.um_id and is_for=3 and sm.admission_status='Admission' and sm.isconfirmed=1 ),0) as sf_admission,
			
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
              join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2 and sm.cancelled_admission='N' and sm.admission_confirm='Y'),0) as sijoul_admission,
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
              join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2 and sm.cancelled_admission='N' ),0) as psijoul_admission,
			COALESCE((select sum(a.amount) from  admission_benefits_and_source as a
             join sandipun_ums.student_master as sm on a.student_id=sm.stud_id 
			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and sm.cancelled_admission='N' and sm.admission_confirm='Y'),0) as nashik_admission_amount,
			COALESCE((select sum(a.amount) from  admission_benefits_and_source as a 
			 join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id
			where a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2 and sm.cancelled_admission='N' and sm.admission_confirm='Y'),0) as sijoul_admission_amount,
			COALESCE((select sum(a.amount) from  admission_benefits_and_source as a
            join sf_admission_data as sm on a.student_id=sm.id 

			where  a.academic_year='$c1' and sm.admission_session='$c' and a.benefit_to=um.um_id and is_for=3 and sm.admission_status='Admission' and sm.isconfirmed=1 ),0) as sf_admission_amount,
			
			
			COALESCE((select sum(a.amount) from  consultant_payment_details as a where  academic_year='$c1' and a.consultant_id=um.um_id ),0) as total_payment,
			COALESCE((select sum(a.tds) from  consultant_payment_details as a where  academic_year='$c1' and a.consultant_id=um.um_id ),0) as tds
			from
			ic_user_master as c  
			inner join user_master as um ON um.employee_code = c.employee_code 
			join ic_registration as ir on um.ic_code=ir.ic_code
			left join states as s on c.state = s.id
			left join cities as ci ON ci.id=c.city
			
			join admission_benefits_and_source as am on am.benefit_to=um.um_id and am.academic_year='$c1'
			where c.user_id !='' $wh $wh1 $rfd11 $cii $ac  $ciii  
              and ir.ic_code !='SU_MH_01'
			group by c.user_id
			) as details  order by details.name
			
			
			";

        //echo $sql;
        //exit;
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }


    public function get_policy_info_for_nashik($adms_cnt, $created_by, $role_id)
    {

        $sql = 'SELECT  (REPLACE(parameter_formula,"$x",' . $adms_cnt . ')) as formula,renumeration_amount
			FROM `consultant_wise_renumeration`
			WHERE `role` = ' . $role_id . '
			LIMIT 50';
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }
    public function get_policy_info_for_nashik_for_ch($adms_cnt, $created_by, $role_id)
    {

        $sql = 'SELECT  (REPLACE(parameter_formula,"$x",' . $adms_cnt . ')) as formula,renumeration_amount
			FROM `consultant_wise_renumeration`
			WHERE `role` = ' . $role_id . ' and is_self=1
			LIMIT 50';
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }



    public function get_policy_for_center_head($role_id)
    {

        $sql = 'SELECT  parameter_formula as formula,renumeration_amount
			FROM `consultant_wise_renumeration`
			WHERE `role` = ' . $role_id . ' and is_self=1';

        $query  = $this->db->query($sql);
        $result = $query->row();
        return $result;
    }

    public function get_ic_wise_centerhead($data = array())
    {
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $wh = '';
        if (isset($data) && !empty($data)) {
            if (isset($data) && !empty($data['icfilter'])) {
                $wh = " and ic.ic_code='" . $data['icfilter'] . "' ";
            }
        }
        $sql = "select ic.*,um.roles_id,rm.roles_name,um.um_id,icm.ic_name from
			ic_user_master as ic 
			inner join user_master as um ON (um.employee_code = ic.employee_code) 
			inner join roles_master as rm ON rm.roles_id=um.roles_id
			inner join ic_registration as icm ON um.ic_code=icm.ic_code
			where um.status='Y'  $wh and um.roles_id=7
			group by um.um_id order by ic.fname";
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }

    public function get_details_of_ch_for_payment($data, $cid = "")
    {
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $wh1 = "";
        $for_consultant_head = '';
        if (!empty($data['consultant']) && $data['consultant'] != ''  && $data['consultant'] != undefined) {
            $rfd11 = ' and um.um_id = "' . $data['consultant'] . '"';
        }
        $c = "";
        $c1 = "";
        if (!empty($data['academic_year']) && $data['academic_year'] != ''  && $data['academic_year'] != undefined) {
            $rfd = '';
            $c1 = $c = $data['academic_year'];
        } else {
            $cyear = $this->config->item('current_year');
            $rfd = '';
            $c1 = $c = $cyear;
        }

        $c = explode('-', $c);
        $c = $c[0];
        $ci = 'sandipun_ums.enquiry_student_master.academic_year="' . $c . '"';
        $ic_code = '';
        if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != undefined) {
            $wh1 = " and c.ic_code='" . $data['icfilter'] . "'";
            $ic_code = $data['icfilter'];
            //$for_consultant_head= " or a.ic_code='".$data['icfilter']."'";
        }
        $cii = '';
        $ac = '';
        if (!empty($data['ac']) && $data['ac'] != ''  && $data['ac'] != undefined) {

            $ac = ' and c.inserted_by = "' . $data['ac'] . '"';
        }
        $wh = '';

        $sql = "Select * from(select um.roles_id,CONCAT(c.fname,' ',c.lname) as name,c.mobile_personal as mobile,c.email_official as email,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id,um.ic_code,
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sandipun_ums.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and sm.cancelled_admission='N' and sm.admission_confirm='Y' and a.remark IS NULL),0) as nashik_admission,
			
			
				COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2 and sm.cancelled_admission='N' and sm.admission_confirm='Y'  and a.remark IS NULL),0) as sijoul_admission,
			
			
				
			
			
			
			
				COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sf_admission_data as sm on a.student_id=sm.id 

			where  a.academic_year='$c1' and sm.admission_session='$c' and a.benefit_to=um.um_id and is_for=3 and sm.admission_status='Admission' and sm.isconfirmed=1 and sm.College='SRP' and a.remark IS NULL),0) as sf_admissionsij,
	
				COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sf_admission_data as sm on a.student_id=sm.id 

			where  a.academic_year='$c1' and sm.admission_session='$c' and a.benefit_to=um.um_id and is_for=3 and sm.admission_status='Admission' and sm.isconfirmed=1 and sm.College!='SRP' and a.remark IS NULL ),0) as sf_admissionnsk,
			
			
			COALESCE((select sum(a.amount) from  admission_benefits_and_source as a
            join sandipun_ums.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and sm.cancelled_admission='N' and sm.admission_confirm='Y' and a.remark IS NULL),0) as nashik_admission_amount,
			
			
			COALESCE((select sum(a.amount) from  admission_benefits_and_source as a
            join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2 and sm.cancelled_admission='N' and sm.admission_confirm='Y'  and a.remark IS NULL),0) as sijoul_admission_amount,
			
			
			
			
			
			
		    COALESCE((select  sum(a.amount) from  admission_benefits_and_source as a
            join sf_admission_data as sm on a.student_id=sm.id 

			where  a.academic_year='$c1' and sm.admission_session='$c' and a.benefit_to=um.um_id and is_for=3 and sm.admission_status='Admission' and sm.isconfirmed=1 and sm.College='SRP' and a.remark IS NULL),0) as sf_admissionsijamount,
	
				COALESCE((select  sum(a.amount) from  admission_benefits_and_source as a
            join sf_admission_data as sm on a.student_id=sm.id 

			where  a.academic_year='$c1' and sm.admission_session='$c' and a.benefit_to=um.um_id and is_for=3 and sm.admission_status='Admission' and sm.isconfirmed=1 and sm.College!='SRP' and a.remark IS NULL ),0) as sf_admissionnskamount,
		
		
		
		
		COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sandipun_ums.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and sm.cancelled_admission='N' and sm.admission_confirm='Y' and a.ic_code='$ic_code' AND a.remark IS NOT NULL),0) as nashik_admissionshare,
			
			
				COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2 and sm.cancelled_admission='N' and sm.admission_confirm='Y'  and a.ic_code='$ic_code' AND a.remark IS NOT NULL),0) as sijoul_admissionshare,
			
			
			
			
			
				COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sf_admission_data as sm on a.student_id=sm.id 

			where  a.academic_year='$c1' and sm.admission_session='$c' and a.benefit_to=um.um_id and is_for=3 and sm.admission_status='Admission' and sm.isconfirmed=1 and sm.College='SRP' and a.ic_code='$ic_code'  AND a.remark IS NOT NULL),0) as sf_admissionsijshare,
	
				COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sf_admission_data as sm on a.student_id=sm.id 

			where  a.academic_year='$c1' and sm.admission_session='$c' and a.benefit_to=um.um_id and is_for=3 and sm.admission_status='Admission' and sm.isconfirmed=1 and sm.College!='SRP' and a.ic_code='$ic_code' AND a.remark IS NOT NULL ),0) as sf_admissionnskshare,
			
			
			COALESCE((select sum(a.amount) from  admission_benefits_and_source as a
            join sandipun_ums.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and sm.cancelled_admission='N' and sm.admission_confirm='Y' and  a.ic_code='$ic_code' AND a.remark IS NOT NULL),0) as nashik_admission_amountshare,
			
			
			COALESCE((select sum(a.amount) from  admission_benefits_and_source as a
            join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2 and sm.cancelled_admission='N' and sm.admission_confirm='Y'  and a.ic_code='$ic_code' AND a.remark IS NOT NULL),0) as sijoul_admission_amountshare,
			
			
			
			
		    COALESCE((select  sum(a.amount) from  admission_benefits_and_source as a
            join sf_admission_data as sm on a.student_id=sm.id 

			where  a.academic_year='$c1' and sm.admission_session='$c' and a.benefit_to=um.um_id and is_for=3 and sm.admission_status='Admission' and sm.isconfirmed=1 and sm.College='SRP' and a.ic_code='$ic_code' AND a.remark IS NOT NULL),0) as sf_admissionsijamountshare,
	
				COALESCE((select  sum(a.amount) from  admission_benefits_and_source as a
            join sf_admission_data as sm on a.student_id=sm.id 

			where  a.academic_year='$c1' and sm.admission_session='$c' and a.benefit_to=um.um_id and is_for=3 and sm.admission_status='Admission' and sm.isconfirmed=1 and sm.College!='SRP' and a.ic_code='$ic_code'  AND a.remark IS NOT NULL),0) as sf_admissionnskamountshare,
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
			
			
			
			
			
			
			
			
			
			
			
			
			
			COALESCE((select sum(a.amount) from  consultant_payment_details as a where  academic_year='$c1' and a.consultant_id=um.um_id ),0) as total_payment
			from
			ic_user_master as c  
			inner join user_master as um ON um.employee_code = c.employee_code 
			left join states as s on c.state = s.id
			left join cities as ci ON ci.id=c.city
			where c.user_id !='' $wh $wh1 $rfd11 $cii $ac
           and um.status='Y' and c.status='Y' and um.roles_id=7
			group by c.user_id
			) as details  order by details.name
			
			
			";




        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }



    public function get_proportionate_sijoul_countdirect($data, $type = "")
    {
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $wh1 = "";
        $for_consultant_head = '';
        $uid = '';
        if (!empty($data['consultant']) && $data['consultant'] != ''  && $data['consultant'] != undefined) {
            $rfd11 = ' and um.um_id = "' . $data['consultant'] . '"';
            $uid = $data['consultant'];
        }
        $c = "";
        $c1 = "";
        if (!empty($data['academic_year']) && $data['academic_year'] != ''  && $data['academic_year'] != undefined) {
            $rfd = '';
            $c1 = $c = $data['academic_year'];
        } else {
            $cyear = $this->config->item('current_year');
            $rfd = '';
            $c1 = $c = $cyear;
        }

        $c = explode('-', $c);
        $c = $c[0];
        $ci = 'sandipun_ums.enquiry_student_master.academic_year="' . $c . '"';
        $ic_code = '';
        if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != undefined) {
            $wh1 = " and c.ic_code='" . $data['icfilter'] . "'";
            $ic_code = $data['icfilter'];
            //$for_consultant_head= " or a.ic_code='".$data['icfilter']."'";
        }
        $cii = '';
        $ac = '';
        if (!empty($data['ac']) && $data['ac'] != ''  && $data['ac'] != undefined) {

            $ac = ' and c.inserted_by = "' . $data['ac'] . '"';
        }


        $f = "";
        $f1 = "";

        if ($type == 1) {
            $f = " count(a.student_id) as number";
            $f1 = " a.student_id";
        } elseif ($type == 2) {
            $f = "  sum(a.amount) as number";
            $f1 = " a.student_id,a.amount";
        }

        $sql = "select $f from 

            (select $f1
			from  admission_benefits_and_source as a
            join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id 
               join sandipun_ums_sijoul.fees_challan fs on a.student_id=fs.student_id and a.is_for=2	  
			where  a.academic_year='$c1' and a.benefit_to=$uid and is_for=2 and sm.cancelled_admission='N' and sm.admission_confirm='Y'  and a.remark IS NULL
			and fs.type_id=2 group by a.student_id ) a";




        $query  = $this->db->query($sql);
        $result = $query->row();
        return $result;
    }




    public function get_proportionate_sijoul_countshare($data, $type = "")
    {
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $wh1 = "";
        $for_consultant_head = '';
        $uid = '';
        if (!empty($data['consultant']) && $data['consultant'] != ''  && $data['consultant'] != undefined) {
            $rfd11 = ' and um.um_id = "' . $data['consultant'] . '"';
            $uid = $data['consultant'];
        }
        $c = "";
        $c1 = "";
        if (!empty($data['academic_year']) && $data['academic_year'] != ''  && $data['academic_year'] != undefined) {
            $rfd = '';
            $c1 = $c = $data['academic_year'];
        } else {
            $cyear = $this->config->item('current_year');
            $rfd = '';
            $c1 = $c = $cyear;
        }

        $c = explode('-', $c);
        $c = $c[0];
        $ci = 'sandipun_ums.enquiry_student_master.academic_year="' . $c . '"';
        $ic_code = '';
        if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != undefined) {
            $wh1 = " and c.ic_code='" . $data['icfilter'] . "'";
            $ic_code = $data['icfilter'];
            //$for_consultant_head= " or a.ic_code='".$data['icfilter']."'";
        }
        $cii = '';
        $ac = '';
        if (!empty($data['ac']) && $data['ac'] != ''  && $data['ac'] != undefined) {

            $ac = ' and c.inserted_by = "' . $data['ac'] . '"';
        }


        $f = "";
        $f1 = "";

        if ($type == 1) {
            $f = " count(a.student_id) as number";
            $f1 = " a.student_id";
        } elseif ($type == 2) {
            $f = "  sum(a.amount) as number";
            $f1 = " a.student_id,a.amount";
        }

        $sql = "
			
			select $f from 
			(select $f1 from  admission_benefits_and_source as a
            join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id 
              join sandipun_ums_sijoul.fees_challan fs on a.student_id=fs.student_id and a.is_for=2
			where  a.academic_year='$c1' and a.benefit_to=$uid and is_for=2 and sm.cancelled_admission='N' and sm.admission_confirm='Y'  and a.ic_code='$ic_code' AND a.remark IS NOT NULL and fs.type_id=2 group by a.student_id) a

			";




        $query  = $this->db->query($sql);
        $result = $query->row();
        return $result;
    }















    function get_belonings_based_on_date_new1($mobile, $email, $date = '')
    {
        $cyear = $this->config->item('current_year');
        $con = '';
        $con1 = '';
        if (!empty($email)) {
            $con = " or smd.email='$email' ";
        }
        if (!empty($date)) {
            $con1 = " and  STR_TO_DATE(smd.created_date,'%Y-%m-%d %H:%i:%s')<'$date'  and  STR_TO_DATE(calling_log_details.called_on,'%Y-%m-%d %H:%i:%s')<'$date'";
        }
        //and smd.ic_code NOT IN ('REF/1','REF/2','REF/3')
        //

        return $get_lead_from = $this->db->query("select (calling_log_details.called_by) as called_by,smd.event_code,smd.ic_code as scode,smd.utm_source,ic.ic_name,COALESCE(ic.center_type,icr.center_type) as center_type,icr.center_type as calling_center_type,icr.ic_code,smd.id,smd.mobile1,smd.created_date,calling_log_details.called_on,icr.ic_name as cname  from " . currentdb . ".student_meet_details as smd left join " . currentdb . ".ic_registration as ic
on smd.ic_code=ic.ic_code 
left join calling_log_details on smd.id=calling_log_details.student_id
left join user_master on user_master.um_id=calling_log_details.called_by
left join ic_registration as icr on icr.ic_code=user_master.ic_code

where  smd.academic_year='$cyear' and ( smd.whatsappno='$mobile' or smd.mobile1='$mobile' or smd.pmobile_no='$mobile' or smd.pwhatsapp_no='$mobile' $con)    $con1 group by calling_log_details.called_by order by calling_log_details.called_on
")->result();
    }



    function get_source($mobile, $email, $date = '')
    {
        $cyear = $this->config->item('current_year');
        $con = '';
        $con1 = '';
        if (!empty($email)) {
            $con = " or smd.email='$email' ";
        }
        if (!empty($date)) {
            $con1 = " and STR_TO_DATE(smd.created_date,'%Y-%m-%d %H:%i:%s')<'$date'";
        }
        return $get_lead_from = $this->db->query("select smd.utm_source,ic.ic_name,smd.id  from " . currentdb . ".student_meet_details as smd left join " . currentdb . ".ic_registration as ic
		on smd.ic_code=ic.ic_code 
		where  smd.academic_year='$cyear' and ( smd.whatsappno='$mobile' or smd.mobile1='$mobile' or smd.pmobile_no='$mobile' or smd.pwhatsapp_no='$mobile' $con) $con1 ")->row();
    }




    function check_ic_belongionh($id)
    {

        $data = $this->db->query("select 17 as role,(consultants_call_details.contact_person) as name,'Consultant' as from_done,'Consultant' as belong_to
from 
consultants_call_details join user_master on consultants_call_details .id=user_master .con_id where user_master.um_id=	$id and  user_master.roles_id=17
UNION
select 33 as role,(inhouse_staff_details.staff_name) as name,'STAFF' as from_done,'STAFF' as belong_to
from 
inhouse_staff_details join user_master on inhouse_staff_details.staff_id=user_master .username where user_master.um_id=	$id and user_master.roles_id=33
UNION
select 1 as role,CONCAT(ic_user_master.fname,' ',ic_user_master.lname) as name,ic_registration.center_type as from_done,ic_registration.ic_name as belong_to
from 
ic_user_master join user_master on ic_user_master.employee_code=user_master .employee_code 
join ic_registration on user_master .ic_code=ic_registration.ic_code
where user_master.um_id=$id ")->row();
        return $data;
    }

    function check_in_enquiry_data($add)
    {
        $umsdb = $this->load->database('umsdb', TRUE);
        $data = $umsdb->query("select enquiry_id from enquiry_student_master where aadhar_card='$add' and admission_session='2021'")->row();
        return $data;
    }


    function provisional_admission_new_data_aadhar_daily_cummulative_report_remaining($year = '')
    {

        $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');
        $and_condition = '';
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        $lm = ' ';
        $ld = '';
        //$ld=" AND STR_TO_DATE(s.created_on,'%Y-%m-%d') = '".date('Y-m-d')."' ";
        $academic_year = ACADEMIC_YEAR;
        $umsdb = $this->load->database('umsdb', TRUE);
        $sql = " (SELECT s.cancelled_admission,au.created_by as cd,au.date_time as created_date_of_aadhar,s.email,enquiry_student_master.enquiry_taken,s.enrollment_no as confirmed_prn,s.first_name,s.mobile as mobile1,sm.ic_code,s.email,sm.id as student_id,sm.mobile1_valid,sm.utm_source,sm.event_code,s.created_on as pcreated,sm.programme_year, sm.created_date as lcreated_date, enquiry_student_master.is_from_consultant  as is_from_reference,enquiry_student_master.created_on as is_from_reference_created_on,enquiry_student_master.enquiry_id,s.admission_confirm,s.adhar_card_no,s.enrollment_no_new as enrollment_no,s.enrollment_no_new as enrollment_non,s.stud_id,sm.id as smid,sm.ic_code as ref_icode,
s.mobile,s.nationality,s.citizenship,cu.created_by as cd1,cu.date_time as created_date_of_cno
 FROM student_master s 
 left join " . currentdb . ".aadhar_car_updation as au on s.adhar_card_no=au.add_no and  au.academic_year='$year'
  left join " . currentdb . ".citizenshipdetails as cu on s.citizenship=cu.citizenship_no and  cu.academic_year='$year'

 left join enquiry_student_master on s.adhar_card_no=enquiry_student_master.aadhar_card and s.adhar_card_no!=0  and enquiry_student_master.admission_session='$c'
 
left JOIN (select s11.* from " . currentdb . ".student_meet_details s11 where s11.academic_year='$year') as sm
on ((au.student_id=sm.id)  AND sm.academic_year='$year' )

 WHERE
  s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !=''  AND s.is_detained='N' and s.cancelled_admission='N'   
      
 $course_cond   $ld   and s.stud_id NOT IN (select student_id from sandipun_ic_erp22.admission_benefits_and_source where academic_year='$year') 
 and s.nationality='Indian'
 
  $and_condition 
  
group by s.stud_id desc  $lm )

UNION
(SELECT s.cancelled_admission,cu.created_by as cd,cu.date_time as created_date_of_aadhar,s.email,enquiry_student_master.enquiry_taken,s.enrollment_no as confirmed_prn,s.first_name,s.mobile as mobile1,sm.ic_code,s.email,sm.id as student_id,sm.mobile1_valid,sm.utm_source,sm.event_code,s.created_on as pcreated,sm.programme_year, sm.created_date as lcreated_date, enquiry_student_master.is_from_consultant  as is_from_reference,enquiry_student_master.created_on as is_from_reference_created_on,enquiry_student_master.enquiry_id,s.admission_confirm,s.adhar_card_no,s.enrollment_no_new as enrollment_no,s.enrollment_no_new as enrollment_non,s.stud_id,sm.id as smid,sm.ic_code as ref_icode,
s.mobile,s.nationality,s.citizenship,cu.created_by as cd1,cu.date_time as created_date_of_cno
 FROM student_master s 

  left join " . currentdb . ".citizenshipdetails as cu on s.citizenship=cu.citizenship_no and  cu.academic_year='$year'

 left join enquiry_student_master on s.adhar_card_no=enquiry_student_master.aadhar_card and s.adhar_card_no!=0  and enquiry_student_master.admission_session='$c'
 
left JOIN (select s11.* from " . currentdb . ".student_meet_details s11 where s11.academic_year='$year') as sm
on ((cu.student_id=sm.id)  AND sm.academic_year='$year' )

 WHERE
  s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !=''  AND s.is_detained='N' and s.cancelled_admission='N'   
      
 $course_cond   $ld   and s.stud_id NOT IN (select student_id from sandipun_ic_erp22.admission_benefits_and_source where academic_year='$year') 
 and s.nationality!='Indian'
 
  $and_condition 
  
group by s.stud_id desc  $lm )

  ";

        //

        // and s.stud_id ='13354' and STR_TO_DATE(s.created_on,'%Y-%m-%d') <= '2021-09-29' AND s.admission_cycle IS NULL and s.adhar_card_no	='721113834565'  ,,,,,,,,,,,,,,,,,  

        // 


        $query = $umsdb->query($sql);
        $res = $query->result();
        #echo $umsdb->last_query();
        #exit;
        return $res;
    }


    function get_admission_students_databkup($type, $academic_year_base, $um_id, $is_direct = '', $is_to_drcc_consider = '', $is_confirm_admission = '', $belong_to = '')
    {

        $userID = $this->session->userdata('uid');
        //$ic_code = $this->session->userdata('ic_code');
        $role_id = $this->session->userdata('role_id');
        $con = '';
        $acdcon = '';
        $belong_to_c = '';

        if (!empty($academic_year_base)) {
        } else {
            $academic_year_base = $this->config->item('current_year');
        }
        $current_year = explode('-', $academic_year_base);
        $acd = $current_year[0];
        $acdcon = " and a.academic_year='" . $academic_year_base . "'";

        if (!empty($type)) {
            $con = " and a.is_for='" . $type . "'";
        }
        $get_role_base_on_id = $this->db->query("select roles_id,ic_code from user_master where um_id=" . $um_id)->row();
        $role_id = $get_role_base_on_id->roles_id;
        $ic_code = $get_role_base_on_id->ic_code;
        $role_con = '';

        if ($role_id == 7) {
            $role_con = " and a.ic_code='$ic_code' ";
        } elseif ($role_id == 27) {
            $consultant_head = $this->session->userdata('uid');
            $this->db->simple_query("SET GLOBAL group_concat_max_len = 1000000;");
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=$consultant_head and status='Y'")->row()->ic_code;
            $referred_by = $this->db->query("select cordinator_id
         from consultant_cordinator_mapping where consultant_id=$consultant_head and status='Y'")->row()->cordinator_id;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";

            //consultants_call_details.inserted_by='".$this->session->userdata('uid')."' OR consultants_call_details.inserted_by IN ($referred_by) OR  consultants_call_details.consultant_head= '".$this->session->userdata('uid')."'
            $get_consultant_id = " a.benefit_to IN ( select u.um_id from consultants_call_details c join user_master u on c.id=u.con_id
		  where c.consultant_head=$consultant_head or c.inserted_by=$consultant_head or c.inserted_by IN ($referred_by) or c.co_reff_by IN ($referred_by) and c.status='Y')";
            $role_con =  " and (a.ic_code IN ($ss) OR $get_consultant_id )  and a.belong_to_ic=4";
            if (!empty($belong_to)) {
                $role_con =  " and (a.ic_code IN ($ss) OR $get_consultant_id )  and a.belong_to_ic=$belong_to";
            }
        } elseif ($role_id == 35) {

            if ($userID == 2105) {
                $role_con = " and a.benefit_to IN (select um_id from consultants_call_details c join user_master as u on c.id=u.con_id
		where c.inserted_by=$userID or c.co_reff_by=$userID or c.inserted_by=4004 or c.inserted_by=3379 ) ";
            } else {
                $role_con = " and a.benefit_to IN (select um_id from consultants_call_details c join user_master as u on c.id=u.con_id
		where c.inserted_by=$userID or c.co_reff_by=$userID) ";
            }
        } elseif ($role_id == 34) {
            if ($userID == 3437) {
                $role_con = " and a.is_affliate=1 and affliate_name='College Dunia' ";
            } elseif ($userID == 4032) {
                $role_con = " and a.is_affliate=1 and affliate_name='Shiksha' ";
            }
        } elseif ($role_id == 1) {
        } else {
            if ($userID == 3677577) {
                $role_con = " and (a.benefit_to = " . $this->session->userdata('uid') . " or a.benefit_to IN  (select um_id
				from sandipun_ic_erp22.consultants_call_details as c join sandipun_ic_erp22.user_master as um on c.id=um.con_id where c.inserted_by=$userID or c.co_reff_by=$userID)) ";
            } else {
                $role_con = " and a.benefit_to='$um_id' ";
            }
        }



        $and_condition = "";
        $fcondition = '';
        if ($type == 2) {
            if ($is_to_drcc_consider == 1) {
            } else {
                $and_condition = " join  sandipun_ums_sijoul.fees_challan fs on s.stud_id=fs.student_id ";
                $fcondition = " and (fs.type_id=2 ) ";
            }
        }
        $fg = " group by s.stud_id order by s.stud_id ";
        if ($type == 3) {

            $fg = " s.id order by s.stud_id";
        }

        $confc = '';
        if ($is_confirm_admission == 1) {
            $confc = ' and s.admission_confirm="Y" ';
        }
        $sql = "(select ad1.actual_fee,ad1.applicable_fee,fees_paid,csw.renumeration_amount,csw.image,
        vc.called_by as callers,vc.icname as icname,vc.center_type as center,vc.name as callername,af.tution_fees,
		s.created_on,s.enrollment_no,s.enrollment_no_new,s.first_name as name,s.email,s.mobile,a.*,vm.course_short_name,vm.stream_name,vm.school_short_name,st.state_name,
		
		dn.district_name,tm.taluka_name
		from admission_benefits_and_source a 
		join sandipun_ums.student_master as s on s.stud_id=a.student_id and a.is_for=1
		$and_condition
        left join view_call_logs as vc on vc.student_id=a.smd_id 
		left join consultant_wise_renumeration as csw on s.admission_stream=csw.stream_id and csw.is_for=1 and csw.consultant_id=a.benefit_to
		left join sandipun_ums.vw_stream_details as vm on s.admission_stream=vm.stream_id
		left join 
		(select sum(fdt.amount) as fees_paid,fdt.student_id from sandipun_ums.fees_details
		as fdt
		where fdt.type_id=2 and fdt.academic_year='$acd' 
		and fdt.chq_cancelled='N' and fdt.is_deleted='N' group by fdt.student_id) as
		fees_details on fees_details.student_id=s.stud_id
		left join sandipun_ums.admission_details ad1 on s.stud_id=ad1.student_id and ad1.academic_year='$acd'
		left join  sandipun_ums.academic_fees as af on s.admission_stream=af.stream_id and af.year=1
           and af.academic_year='$academic_year_base' and af.is_active='Y'
		left join  sandipun_ums.address_details as ad on s.stud_id=ad.student_id and ad.address_type='CORS'
		left join  sandipun_ums.states as st on ad.state_id=st.state_id
		left join  sandipun_ums.district_name as dn on ad.district_id=dn.district_id
		left join  sandipun_ums.taluka_master as tm on ad.city=tm.taluka_id
		where a.id !='' and s.cancelled_admission ='N' $acdcon $con $role_con $fcondition $confc  $fg ) ";


        if ($type == 2) {
            $sql = str_replace("sandipun_ums.student_master", "sandipun_ums_sijoul.student_master", $sql);
            $sql = str_replace("sandipun_ums.vw_stream_details", "sandipun_ums_sijoul.vw_stream_details", $sql);
            $sql = str_replace("sandipun_ums.academic_fees", "sandipun_ums_sijoul.academic_fees", $sql);
            $sql = str_replace("sandipun_ums.address_details", "sandipun_ums_sijoul.address_details", $sql);
            $sql = str_replace("sandipun_ums.states", "sandipun_ums_sijoul.states", $sql);
            $sql = str_replace("sandipun_ums.district_name", "sandipun_ums_sijoul.district_name", $sql);
            $sql = str_replace("sandipun_ums.taluka_master", "sandipun_ums_sijoul.taluka_master", $sql);
            $sql = str_replace("csw.is_for=1", "csw.is_for=2", $sql);
            $sql = str_replace("a.is_for=1", "a.is_for=2", $sql);
            $sql = str_replace("sandipun_ums.fees_details", "sandipun_ums_sijoul.fees_details", $sql);
            $sql = str_replace("sandipun_ums.admission_details", "sandipun_ums_sijoul.admission_details", $sql);
        }

        if ($type == 3) {
            $sql = "select actual_fees as actual_fee,applicable_fees as applicable_fee,paid_fees as fees_paid,csw.renumeration_amount,csw.image,
         vc.called_by as callers,vc.icname as icname,vc.center_type as center,vc.name as callername,actual_fees as tution_fees,
		s.admission_date as created_on,s.enrollment_no,s.enrollment_no as enrollment_no_new,s.student_name as name,s.email_id as email,s.mobile,a.*,Course as course_short_name,Stream as stream_name,Class as school_short_name,'--' as state_name,
		'--' as district_name,'--' as taluka_name
		from admission_benefits_and_source a 
		join sf_admission_data as s on s.id=a.student_id and a.is_for=3
		left join consultant_wise_renumeration as csw on s.Stream=csw.streamname and csw.is_for=3 and csw.consultant_id=a.benefit_to
         left join view_call_logs as vc on vc.student_id=a.smd_id 		
		where a.id !='' $acdcon $con $role_con and is_cancelled !=1 group by s.id order by s.enrollment_no ";
        }

        if ($type == 0) {
            $sql1 = str_replace("sandipun_ums.student_master", "sandipun_ums_sijoul.student_master", $sql);
            $sql1 = str_replace("sandipun_ums.vw_stream_details", "sandipun_ums_sijoul.vw_stream_details", $sql1);
            $sql1 = str_replace("sandipun_ums.academic_fees", "sandipun_ums_sijoul.academic_fees", $sql1);
            $sql1 = str_replace("sandipun_ums.address_details", "sandipun_ums_sijoul.address_details", $sql1);
            $sql1 = str_replace("sandipun_ums.states", "sandipun_ums_sijoul.states", $sql1);
            $sql1 = str_replace("sandipun_ums.district_name", "sandipun_ums_sijoul.district_name", $sql1);
            $sql1 = str_replace("sandipun_ums.taluka_master", "sandipun_ums_sijoul.taluka_master", $sql1);
            $sql1 = str_replace("csw.is_for=1", "csw.is_for=2", $sql1);
            $sql1 = str_replace("a.is_for=1", "a.is_for=2", $sql1);
            $sql1 = str_replace("sandipun_ums.fees_details", "sandipun_ums_sijoul.fees_details", $sql1);
            $sql1 = str_replace("sandipun_ums.admission_details", "sandipun_ums_sijoul.admission_details", $sql1);
            $sql .= " UNION ($sql1) UNION (select actual_fees as actual_fee,applicable_fees as applicable_fee,paid_fees as fees_paid,csw.renumeration_amount,csw.image,
         vc.called_by as callers,vc.icname as icname,vc.center_type as center,vc.name as callername,actual_fees as tution_fees,
		s.admission_date as created_on,s.enrollment_no,s.enrollment_no as enrollment_no_new,s.student_name as name,s.email_id as email,s.mobile,a.*,Course as course_short_name,Stream as stream_name,Class as school_short_name,'--' as state_name,
		'--' as district_name,'--' as taluka_name
		from admission_benefits_and_source a 
		join sf_admission_data as s on s.id=a.student_id and a.is_for=3
		left join consultant_wise_renumeration as csw on s.Stream=csw.streamname and csw.is_for=3 and csw.consultant_id=a.benefit_to
         left join view_call_logs as vc on vc.student_id=a.smd_id 		
		where a.id !='' $acdcon $con $role_con and is_cancelled !=1 group by s.id order by s.enrollment_no)";
        }
        //echo $sql;
        //exit;
        $query = $this->db->query($sql);
        //echo $this->db->last_query();
        //
        $result = $query->result_array();
        return $result;
    }




    function get_cadmission_students_data($type, $academic_year_base, $um_id, $is_direct = '', $is_to_drcc_consider = '', $is_confirm_admission = '', $belong_to = '')
    {

        $userID = $this->session->userdata('uid');
        //$ic_code = $this->session->userdata('ic_code');
        $role_id = $this->session->userdata('role_id');
        $con = '';
        $acdcon = '';
        $belong_to_c = '';

        if (!empty($academic_year_base)) {
        } else {
            $academic_year_base = $this->config->item('current_year');
        }
        $current_year = explode('-', $academic_year_base);
        $acd = $current_year[0];
        $acdcon = " and a.academic_year='" . $academic_year_base . "'";

        if (!empty($type)) {
            $con = " and a.is_for='" . $type . "'";
        }
        $get_role_base_on_id = $this->db->query("select roles_id,ic_code from user_master where um_id=" . $um_id)->row();
        $role_id = $get_role_base_on_id->roles_id;
        $ic_code = $get_role_base_on_id->ic_code;
        $role_con = '';

        if ($role_id == 7) {
            $role_con = " and a.ic_code='$ic_code' ";
        } elseif ($role_id == 27) {
            $consultant_head = $this->session->userdata('uid');
            $this->db->simple_query("SET GLOBAL group_concat_max_len = 1000000;");
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=$consultant_head and status='Y'")->row()->ic_code;
            $referred_by = $this->db->query("select cordinator_id
         from consultant_cordinator_mapping where consultant_id=$consultant_head and status='Y'")->row()->cordinator_id;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";

            //consultants_call_details.inserted_by='".$this->session->userdata('uid')."' OR consultants_call_details.inserted_by IN ($referred_by) OR  consultants_call_details.consultant_head= '".$this->session->userdata('uid')."'
            $get_consultant_id = " a.benefit_to IN ( select u.um_id from consultants_call_details c join user_master u on c.id=u.con_id
		  where c.consultant_head=$consultant_head or c.inserted_by=$consultant_head or c.inserted_by IN ($referred_by) or c.co_reff_by IN ($referred_by) and c.status='Y')";
            $role_con =  " and (a.ic_code IN ($ss) OR $get_consultant_id )  and a.belong_to_ic=4";
            if (!empty($belong_to)) {
                $role_con =  " and (a.ic_code IN ($ss) OR $get_consultant_id )  and a.belong_to_ic=$belong_to";
            }
        } elseif ($role_id == 35) {

            if ($userID == 2105) {
                $role_con = " and a.benefit_to IN (select um_id from consultants_call_details c join user_master as u on c.id=u.con_id
		where c.inserted_by=$userID or c.co_reff_by=$userID or c.inserted_by=4004 or c.inserted_by=3379 ) ";
            } else {
                $role_con = " and a.benefit_to IN (select um_id from consultants_call_details c join user_master as u on c.id=u.con_id
		where c.inserted_by=$userID or c.co_reff_by=$userID) ";
            }
        } elseif ($role_id == 34) {
            if ($userID == 3437) {
                $role_con = " and a.is_affliate=1 and affliate_name='College Dunia' ";
            } elseif ($userID == 4032) {
                $role_con = " and a.is_affliate=1 and affliate_name='Shiksha' ";
            } elseif ($userID == 4929) {
                $role_con = " and a.is_affliate=1 and affliate_name='Getmyuni' ";
            } elseif ($userID == 5168) {
                $role_con = " and a.is_affliate=1 and affliate_name='career360' ";
            }
        } elseif ($role_id == 1) {
        } else {
            if ($userID == 4004 || $userID == 3379) {
                $role_con = " and (a.benefit_to = " . $this->session->userdata('uid') . " or a.benefit_to IN  (select um_id
				from sandipun_ic_erp22.consultants_call_details as c join sandipun_ic_erp22.user_master as um on c.id=um.con_id where c.inserted_by=$userID or c.co_reff_by=$userID)) ";
            } else {
                $role_con = " and a.benefit_to='$um_id' ";
            }
        }



        $and_condition = "";
        $fcondition = '';
        if ($type == 2) {
            if ($is_to_drcc_consider == 1) {
            } else {
                $and_condition = " join  sandipun_ums_sijoul.fees_challan fs on s.stud_id=fs.student_id ";
                $fcondition = " and (fs.type_id=2 ) ";
            }
        }
        $fg = " group by s.stud_id order by s.stud_id ";
        if ($type == 3) {

            $fg = " s.id order by s.stud_id";
        }

        $confc = '';
        if ($is_confirm_admission == 1) {
            $confc = ' and s.admission_confirm="Y" ';
        }
        $sql = "(select ad1.actual_fee,ad1.applicable_fee,fees_paid,csw.renumeration_amount,csw.image,
        vc.called_by as callers,vc.icname as icname,vc.center_type as center,vc.name as callername,af.tution_fees,
		s.created_on,s.enrollment_no,s.enrollment_no_new,s.first_name as name,s.email,s.mobile,a.*,vm.course_short_name,vm.stream_name,vm.school_short_name,st.state_name,
		
		dn.district_name,tm.taluka_name
		from admission_benefits_and_source a 
		join sandipun_ums.student_master as s on s.stud_id=a.student_id and a.is_for=1
		$and_condition
        left join view_call_logs as vc on vc.student_id=a.smd_id 
		left join consultant_wise_renumeration as csw on s.admission_stream=csw.stream_id and csw.is_for=1 and csw.consultant_id=a.benefit_to
		left join sandipun_ums.vw_stream_details as vm on s.admission_stream=vm.stream_id
		left join 
		(select sum(fdt.amount) as fees_paid,fdt.student_id from sandipun_ums.fees_details
		as fdt
		where fdt.type_id=2 and fdt.academic_year='$acd' 
		and fdt.chq_cancelled='N' and fdt.is_deleted='N' group by fdt.student_id) as
		fees_details on fees_details.student_id=s.stud_id
		left join sandipun_ums.admission_details ad1 on s.stud_id=ad1.student_id and ad1.academic_year='$acd'
		left join  sandipun_ums.academic_fees as af on s.admission_stream=af.stream_id and af.year=1
           and af.academic_year='$academic_year_base' and af.is_active='Y'
		left join  sandipun_ums.address_details as ad on s.stud_id=ad.student_id 
		left join  sandipun_ums.states as st on ad.state_id=st.state_id
		left join  sandipun_ums.district_name as dn on ad.district_id=dn.district_id
		left join  sandipun_ums.taluka_master as tm on ad.city=tm.taluka_id
		where a.id !='' and s.cancelled_admission ='Y' $acdcon $con $role_con $fcondition $confc  $fg ) ";


        if ($type == 2) {
            $sql = str_replace("sandipun_ums.student_master", "sandipun_ums_sijoul.student_master", $sql);
            $sql = str_replace("sandipun_ums.vw_stream_details", "sandipun_ums_sijoul.vw_stream_details", $sql);
            $sql = str_replace("sandipun_ums.academic_fees", "sandipun_ums_sijoul.academic_fees", $sql);
            $sql = str_replace("sandipun_ums.address_details", "sandipun_ums_sijoul.address_details", $sql);
            $sql = str_replace("sandipun_ums.states", "sandipun_ums_sijoul.states", $sql);
            $sql = str_replace("sandipun_ums.district_name", "sandipun_ums_sijoul.district_name", $sql);
            $sql = str_replace("sandipun_ums.taluka_master", "sandipun_ums_sijoul.taluka_master", $sql);
            $sql = str_replace("csw.is_for=1", "csw.is_for=2", $sql);
            $sql = str_replace("a.is_for=1", "a.is_for=2", $sql);
            $sql = str_replace("sandipun_ums.fees_details", "sandipun_ums_sijoul.fees_details", $sql);
            $sql = str_replace("sandipun_ums.admission_details", "sandipun_ums_sijoul.admission_details", $sql);
        }

        if ($type == 3) {
            $sql = "select actual_fees as actual_fee,applicable_fees as applicable_fee,paid_fees as fees_paid,csw.renumeration_amount,csw.image,
         vc.called_by as callers,vc.icname as icname,vc.center_type as center,vc.name as callername,actual_fees as tution_fees,
		s.admission_date as created_on,s.enrollment_no,s.enrollment_no as enrollment_no_new,s.student_name as name,s.email_id as email,s.mobile,a.*,Course as course_short_name,Stream as stream_name,Class as school_short_name,'--' as state_name,
		'--' as district_name,'--' as taluka_name
		from admission_benefits_and_source a 
		join sf_admission_data as s on s.id=a.student_id and a.is_for=3
		left join consultant_wise_renumeration as csw on s.Stream=csw.streamname and csw.is_for=3 and csw.consultant_id=a.benefit_to
         left join view_call_logs as vc on vc.student_id=a.smd_id 		
		where a.id !='' $acdcon $con $role_con and is_cancelled !=1 group by s.id order by s.enrollment_no ";
        }

        if ($type == 0) {
            $sql1 = str_replace("sandipun_ums.student_master", "sandipun_ums_sijoul.student_master", $sql);
            $sql1 = str_replace("sandipun_ums.vw_stream_details", "sandipun_ums_sijoul.vw_stream_details", $sql1);
            $sql1 = str_replace("sandipun_ums.academic_fees", "sandipun_ums_sijoul.academic_fees", $sql1);
            $sql1 = str_replace("sandipun_ums.address_details", "sandipun_ums_sijoul.address_details", $sql1);
            $sql1 = str_replace("sandipun_ums.states", "sandipun_ums_sijoul.states", $sql1);
            $sql1 = str_replace("sandipun_ums.district_name", "sandipun_ums_sijoul.district_name", $sql1);
            $sql1 = str_replace("sandipun_ums.taluka_master", "sandipun_ums_sijoul.taluka_master", $sql1);
            $sql1 = str_replace("csw.is_for=1", "csw.is_for=2", $sql1);
            $sql1 = str_replace("a.is_for=1", "a.is_for=2", $sql1);
            $sql1 = str_replace("sandipun_ums.fees_details", "sandipun_ums_sijoul.fees_details", $sql1);
            $sql1 = str_replace("sandipun_ums.admission_details", "sandipun_ums_sijoul.admission_details", $sql1);
            $sql .= " UNION ($sql1) UNION (select actual_fees as actual_fee,applicable_fees as applicable_fee,paid_fees as fees_paid,csw.renumeration_amount,csw.image,
         vc.called_by as callers,vc.icname as icname,vc.center_type as center,vc.name as callername,actual_fees as tution_fees,
		s.admission_date as created_on,s.enrollment_no,s.enrollment_no as enrollment_no_new,s.student_name as name,s.email_id as email,s.mobile,a.*,Course as course_short_name,Stream as stream_name,Class as school_short_name,'--' as state_name,
		'--' as district_name,'--' as taluka_name
		from admission_benefits_and_source a 
		join sf_admission_data as s on s.id=a.student_id and a.is_for=3
		left join consultant_wise_renumeration as csw on s.Stream=csw.streamname and csw.is_for=3 and csw.consultant_id=a.benefit_to
         left join view_call_logs as vc on vc.student_id=a.smd_id 		
		where a.id !='' $acdcon $con $role_con and is_cancelled !=1 group by s.id order by s.enrollment_no)";
        }
        //echo $sql;
        //exit;
        $query = $this->db->query($sql);
        //echo $this->db->last_query();
        //
        $result = $query->result_array();
        return $result;
    }














    function get_staff_list()
    {

        //consultants_call_details.consultant_head='$c_by' and 
        //;


        $query = $this->db->query("select inhouse_staff_details.staff_name,inhouse_staff_details.staff_id,user_master.um_id,user_master.employee_code from inhouse_staff_details join user_master on 
inhouse_staff_details.id=user_master.staff_id where inhouse_staff_details.status='Y'
 and user_master.status='Y' group by user_master.um_id order by inhouse_staff_details.staff_name asc  ");




        $result = $query->result_array();

        return $result;
    }

    public function get_details_of_aff_for_payment($data, $cid = "")
    {
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd2 = '';
        $rfd1 = '';
        $wh1 = "";
        $id = 0;
        if (!empty($data['consultant']) && $data['consultant'] != ''  && $data['consultant'] != undefined) { {
                $get_d = $this->db->get_where('affiliates_sources', array('utm_source' => $data['consultant']))->row();
                $rfd11 = ' and affliate_name = "' . $data['consultant'] . '"';
                $um_id = $get_d->um_id;
                $rfd1 = $um_id . ' as um_id';
                $rfd2 = '"' . $data['consultant'] . '" as source,"' . $data['consultant'] . '" as dp';
                $id = $um_id;
            }
            //$rfd11 = ' and um.um_id = "'.$data['consultant'].'"';
        }
        $c = "";
        $c1 = "";
        if (!empty($data['academic_year']) && $data['academic_year'] != ''  && $data['academic_year'] != undefined) {
            $rfd = '';
            $c1 = $c = $data['academic_year'];
        } else {
            $cyear = $this->config->item('current_year');
            $rfd = '';
            $c1 = $c = $cyear;
        }

        $c = explode('-', $c);
        $c = $c[0];
        $ci = 'sandipun_ums.enquiry_student_master.academic_year="' . $c . '"';


        $cii = '';
        $ac = '';
        $wh = '';

        $sql = "Select * from(select $rfd1,$rfd2,COALESCE((select count(a.id) 
from
 (select a.id from  admission_benefits_and_source as a
join sandipun_ums.student_master as s on a.student_id=s.stud_id			where a.belong_to_ic!=4 and a.academic_year='$c1'  and is_for=1 and s.cancelled_admission='N' and s.admission_confirm='Y'
and a.is_affliate=1 $rfd11

group by student_id)
a


),0) as nashik_admission,
COALESCE((select count(a.id) 
from
 (select a.id from  admission_benefits_and_source as a
join sandipun_ums_sijoul.student_master as s on a.student_id=s.stud_id			where a.belong_to_ic!=4 and a.academic_year='$c1'  and is_for=2 and s.cancelled_admission='N' and s.admission_confirm='Y'
and a.is_affliate=1 $rfd11

group by student_id)
a


),0) as sijoul_admission,

			
			 
			0 as sf_admission,
			COALESCE((select sum(a.amount_for_aff)  from 

(select  a.amount_for_aff
 from  admission_benefits_and_source as a
join sandipun_ums.student_master as s on a.student_id=s.stud_id			where a.belong_to_ic!=4 and a.academic_year='$c1'  and is_for=1 and s.cancelled_admission='N' and s.admission_confirm='Y'
and a.is_affliate=1 $rfd11  group by student_id) a



),0) as nashik_admission_amount1,
	COALESCE((select sum(a.amount_for_aff)  from 

(select  a.amount_for_aff
 from  admission_benefits_and_source as a
join sandipun_ums_sijoul.student_master as s on a.student_id=s.stud_id			where a.belong_to_ic!=4 and a.academic_year='$c1'  and is_for=2 and s.cancelled_admission='N' and s.admission_confirm='Y'
and a.is_affliate=1 $rfd11  group by student_id) a



),0) as sijoul_admission_amount1,		
			
			COALESCE((select sum(a.amount_for_aff) from  admission_benefits_and_source as a
join sandipun_ums.student_master as s on a.student_id=s.stud_id			where a.belong_to_ic!=4 and a.academic_year='$c1' and is_for=1 and s.cancelled_admission='N' and s.admission_confirm='Y'
and a.is_affliate=1 $rfd11
),0) as nashik_admission_amount,
			0 as sf_admission_amount,
			
			
			COALESCE((select sum(a.amount) from  consultant_payment_details as a where  academic_year='$c1' and a.consultant_id=$id ),0) as total_payment,
			COALESCE((select sum(a.tds) from  consultant_payment_details as a where  academic_year='$c1' and a.consultant_id=$id ),0) as tds
			from
			 user_master um
			where um.um_id !='' and um_id=$id  group by um_id
			) as details";



        //echo $sql;
        //exit;

        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }

    function get_count_of_admission_done_role_wise_of_affliate($um_id, $current_year1 = '')
    {

        if ($current_year1 == '') {
            $current_year1 = $this->config->item('current_year');
        }
        $con = '';
        if ($um_id == 3437) {
            $con = ' and affliate_name="College Dunia"';
        } elseif ($um_id == 3965) {
            $con = ' and affliate_name="College Dekho"';
        } elseif ($um_id == 4032) {
            $con = ' and affliate_name="Shiksha"';
        }



        return $this->db->query("select COALESCE(sum(count),0)  as tc from(
select count(*) as count 
 from 
(select a.id
from admission_benefits_and_source a join sandipun_ums.student_master as s on a.student_id=s.stud_id	
where a.id !='' $con and a.academic_year='$current_year1' and is_affliate=1 and s.cancelled_admission='N' and s.admission_confirm='Y'
and a.is_for=1 and a.belong_to_ic !=4 group by a.student_id
UNION ALL
select a.id
from admission_benefits_and_source a join sandipun_ums_sijoul.student_master as s on a.student_id=s.stud_id	
where a.id !='' $con and a.academic_year='$current_year1' and is_affliate=1 and s.cancelled_admission='N' and s.admission_confirm='Y'
and a.is_for=2 and a.belong_to_ic !=4 group by a.student_id
 ) c
) t")->row()->tc;
    }




    function get_rn_of_admission_done_role_wise_of_affliate($um_id, $current_year1 = '')
    {

        if ($current_year1 == '') {
            $current_year1 = $this->config->item('current_year');
        }
        $con = '';
        if ($um_id == 3437) {
            $con = ' and affliate_name="College Dunia"';
        } elseif ($um_id == 3965) {
            $con = ' and affliate_name="College Dekho"';
        } elseif ($um_id == 4032) {
            $con = ' and affliate_name="Shiksha"';
        }
        return $this->db->query("select COALESCE(count,0)  as tc from(
select sum(amount_for_aff) as count from  
(select a.amount_for_aff 
from admission_benefits_and_source a join sandipun_ums.student_master as s on a.student_id=s.stud_id	
where a.id !='' $con and a.academic_year='$current_year1' and is_affliate=1 and s.cancelled_admission='N' and s.admission_confirm='Y'
and a.is_for=1 and a.belong_to_ic !=4 group by student_id

UNION ALL
select a.amount_for_aff 
from admission_benefits_and_source a join sandipun_ums_sijoul.student_master as s on a.student_id=s.stud_id	
where a.id !='' $con and a.academic_year='$current_year1' and is_affliate=1 and s.cancelled_admission='N' and s.admission_confirm='Y'
and a.is_for=2 and a.belong_to_ic !=4 group by student_id

) d



) t")->row()->tc;
    }




    function get_tds_done_for_current_year($um_id, $current_year1 = '')
    {

        return $this->db->query("select COALESCE(sum(tds),0)  as amount from sandipun_ic_erp22.consultant_payment_details 
where sandipun_ic_erp22.consultant_payment_details.consultant_id='$um_id'  and academic_year='$current_year1'
")->row()->amount;
    }



    /* staff new data*/
    function fetch_student_meetdetails_staff($id = "", $checkIdInIc)
    {
        $userID = $checkIdInIc;

        $y = $acd1 = ADMISSION_SESSION_YEAR;
        $current_year = explode('-', $acd1);
        $acd = $current_year[0];

        $sql = "select enquiry_student_master.aadhar_card,enquiry_student_master.stream_id,states.state_name,district_name.district_name,taluka_master.taluka_name,enquiry_student_master.nationality, enquiry_student_master.email_id,
		c.staff_name as contact_person,enquiry_student_master.enquiry_id as id,enquiry_student_master.created_by,enquiry_student_master.mobile as mobile1,enquiry_student_master.course_id,enquiry_student_master.nationality,
		enquiry_student_master.first_name,enquiry_student_master.middle_name,enquiry_student_master.school_id,
		enquiry_student_master.last_name,enquiry_student_master.renumeration_amount 
		as remuneration,enquiry_student_master.remark 
		as remark,enquiry_student_master.status 
		as status,enquiry_student_master.Campus_City,
		enquiry_student_master.Campus,enquiry_student_master.enquiry_no,enquiry_student_master.created_by as creator
		from  sandipun_ums.enquiry_student_master 
		join sandipun_ic_erp22.user_master u on u.um_id=enquiry_student_master.created_by
		left join sandipun_ic_erp22.inhouse_staff_details c on c.id=u.staff_id 
		left join states on enquiry_student_master.state_id=states.state_id
		left join district_name on enquiry_student_master.district_id=district_name.district_id
		left join taluka_master on enquiry_student_master.city_id=taluka_master.taluka_id
		where enquiry_student_master.admission_session='$acd'
		";

        if ($role_id != 1) {
            $sql .= " and (enquiry_student_master.created_by='" . $userID . "'    or    enquiry_student_master.created_by IN (SELECT um_id FROM sandipun_ic_erp22.consultants_call_details AS c JOIN sandipun_ic_erp22.user_master AS 
                um ON c.id=um.con_id WHERE c.inserted_by='" . $userID . "' OR c.co_reff_by='" . $userID . "') )";
        }

        $sql .= " group by enquiry_student_master.enquiry_id  ORDER BY enquiry_student_master.enquiry_id DESC";

        $DB1 = $this->load->database('umsdb', TRUE);
        $ICDB = $this->load->database('icdb', TRUE);
        $query = $DB1->query($sql);
        $result = $query->result();
        // print_r($result);exit;
        $array = array();
        if (!empty($result)) {
            foreach ($result as $row) {
                $campus = $row->Campus;
                $Campus_City = $row->Campus_City;
                $row->school_code = '';
                $row->course = '';

                if ($campus == 'SUN') {
                    if ($Campus_City == 1) {

                        $course_details = $DB1->query('select vw_stream_details.school_short_name,vw_stream_details.stream_name
                    from vw_stream_details where stream_id=' . $row->stream_id)->row();

                        if (!empty($course_details)) {
                            $row->school_code = $course_details->school_short_name;
                            $row->course = $course_details->stream_name;
                        }
                    } else {
                        $course_details = $DB1->query('select vw_stream_details.school_short_name,vw_stream_details.stream_name
                    from sandipun_ums_sijoul.vw_stream_details as vw_stream_details where stream_id=
                    ' . $row->stream_id)->row();
                        if (!empty($course_details)) {
                            $row->school_code = $course_details->school_short_name;
                            $row->course = $course_details->stream_name;
                        }
                    }
                } else {
                    $course_details = $ICDB->query("SELECT * FROM `sandipun_ic_erp22`.`vw_stream_details` WHERE stream_id=" . $row->stream_id)->row();
                    if (!empty($course_details)) {
                        $row->school_code = $course_details->school_short_name;
                        $row->course = $course_details->stream_name;
                    }
                }
                $array[] = $row;
            }
        }

        return $array;
    }


    public function secondary_lead($utm_source, $year, $type)
    {
        return    $this->db->query("select * from (select *,
        CASE when (select utm_source from get_secondary_sources  where student_id=g.student_id and g.academic_year='$year' LIMIT 1 )='$utm_source' then 2
            else 3
        end as source_sequence

        from get_secondary_sources g where g.utm_source='$utm_source' and g.academic_year='$year'
        and g.student_id NOT IN (select id from student_meet_details where utm_source='$utm_source')
        
        ) a where source_sequence=$type")->num_rows();
    }

    public function reenquired_lead($utm_source, $year = '')
    {
        $sql = "select g.id from get_secondary_sources g
		join student_meet_details as sm on g.student_id=sm.id and g.utm_source='$utm_source'
		where sm.utm_source='$utm_source' and  g.academic_year='$year' and sm.campus_id='1'  group by g.student_id";
        return    $this->db->query($sql)->num_rows();
    }

    public function reenquired_lead_s($utm_source, $year = '')
    {
        return    $this->db->query("select g.id from get_secondary_sources g
		join student_meet_details as sm on g.student_id=sm.id and g.utm_source='$utm_source'
		where sm.utm_source='$utm_source' and  g.academic_year='$year' and sm.campus_id='2' group by g.student_id")->num_rows();
    }

    function upload_fbdata_sunpet($data = array())
    {
        $this->db->insert('student_meet_details', $data);
        $stud_id = $this->db->insert_id();
        // echo $this->db->last_query();exit;
        $data_sunpet['student_id'] = $stud_id;
        $data_sunpet['exam_no'] = $data['stream'];
        $data_sunpet['academic_year'] = $data['academic_year'];
        $data_sunpet['slot_id'] = 10;
        $data_sunpet['exam_date'] = '2022-04-17';
        $data_sunpet['inserted_at'] = date('Y-m-d h:i:s');
        $data_sunpet['is_active'] = 'Y';

        $data_sunpet1['student_id'] = $stud_id;
        $data_sunpet1['exam_no'] = 27;
        $data_sunpet1['academic_year'] = $data['academic_year'];
        $data_sunpet1['slot_id'] = 9;
        $data_sunpet1['exam_date'] = '2022-04-17';
        $data_sunpet1['inserted_at'] = date('Y-m-d h:i:s');
        $data_sunpet1['is_active'] = 'Y';

        $this->db->insert('su_jee_registration', $data_sunpet);
        $this->db->insert('su_jee_registration', $data_sunpet1);
        return true;
    }

    function new_provisional_admission($year = '', $course_id = '', $data = array(), $get_val = '', $is_for = "", $belong_to = '', $benefit_to = '', $is_fou = '', $is_confirm = '')
    {
        $consultant_head = $userID = $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');
        $ic_code = $this->session->userdata('ic_code');
        if (empty($year)) {
            $ACYEAR = ACYEAR;
        } else {
            $nc = explode('-', $year);
            $ACYEAR = $nc[0];
        }
        $and_condition = '';
        if ($role_id == 1 || $role_id == 30  || $consultant_head == 3964) {
        } elseif ($role_id == 9) {
            $and_condition = " and a.source IN (select utm_source from sandipun_ic_erp22.inhouse_digital_source where academic_year='$year' and status='Y') ";
        } elseif ($role_id == 7 || $role_id == 15) {

            if ($consultant_head == 3414) {
                $and_condition = " and a.ic_code IN ('$ic_code','SU_MH_122','SU_BR_124') and a.belong_to_ic =3";
            } else {
                $and_condition = " and a.ic_code='$ic_code'";
            }
        } elseif ($role_id == 27) {
            $this->db->simple_query("SET GLOBAL group_concat_max_len = 1000000;");
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
		        from sandipun_ic_erp22.ic_mapping where consultant_head=$consultant_head and status='Y'")->row()->ic_code;
            $referred_by = $this->db->query("select cordinator_id
		        from sandipun_ic_erp22.consultant_cordinator_mapping where consultant_id=$consultant_head and status='Y'")->row()->cordinator_id;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $get_consultant_id = " a.benefit_to IN ( select u.um_id from sandipun_ic_erp22.consultants_call_details c join sandipun_ic_erp22.user_master u on c.id=u.con_id
		        where c.consultant_head=$consultant_head or c.inserted_by=$consultant_head or c.inserted_by IN ($referred_by) or c.co_reff_by IN ($referred_by) and c.status='Y')";
            $and_condition =  " and (a.ic_code IN ($ss) OR $get_consultant_id )";
        } elseif ($role_id == 35) {
            if ($c_by == 2105) {
                $and_condition = " and a.benefit_to IN (select um_id from sandipun_ic_erp22.consultants_call_details c join sandipun_ic_erp22.user_master as u on c.id=u.con_id
		        where c.inserted_by=$userID or c.co_reff_by=$userID or c.inserted_by=4004 or c.inserted_by=3379 ) ";
            } else {
                $and_condition = " and a.benefit_to IN (select um_id from sandipun_ic_erp22.consultants_call_details c join sandipun_ic_erp22.user_master as u on c.id=u.con_id
		        where c.inserted_by=$userID or c.co_reff_by=$userID) ";
            }
        } elseif ($role_id == 34) {
            if ($userID == 3437) {
                $and_condition = " and a.is_affliate=1 and a.affliate_name='College Dunia' ";
            } elseif ($userID == 4032) {
                $and_condition = " and a.is_affliate=1 and a.affliate_name='Shiksha' ";
            }
        } else {
            if ($userID == 4004 || $userID == 3379) {
                $and_condition = " and (a.benefit_to = " . $this->session->userdata('uid') . " or a.benefit_to IN  (select um_id
				from sandipun_ic_erp22.consultants_call_details as c join sandipun_ic_erp22.user_master as um on c.id=um.con_id where c.inserted_by=$userID or c.co_reff_by=$userID)) ";
            } else {
                $and_condition = " and a.benefit_to='$userID' ";
            }
        }
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        if ($course_id != '') {
            $course_cond = " AND v.course_id =$course_id ";
        }

        if ($rowno != '' && $rowperpage != '') {
            $lm = 'limit ' . $rowno . ',' . $rowperpage;
        } else {
            $lm = ' ';
        }
        $ld = '';
        if (!empty($data)) {
            if (($data['duration'] == 'day') || ($data['duration'] == 'month') || ($data['duration'] == 'year')) {

                if (isset($data['search_dt']) && $data['search_dt'] != '') {


                    $ld = " AND STR_TO_DATE(s.created_on,'%Y-%m-%d') = '" . date('Y-m-d', strtotime($data['search_dt'])) . "' ";
                } elseif (isset($data['search_dt1']) && $data['search_dt1'] != '') {

                    // $wdt = "AND month(called_on)='".date('m',strtotime($data['search_dt1']))."' and year(called_on) = '".date('Y',strtotime($data['search_dt1']))."' ";
                    $ld = " AND month(s.created_on)='" . date('m', strtotime($data['search_dt1'])) . "' and year(s.created_on) = '" . date('Y', strtotime($data['search_dt1'])) . "' ";
                } elseif (isset($data['search_dt2']) && $data['search_dt2'] != '') {

                    // $wdt = "AND year(called_on)='" .date('Y',strtotime($data['search_dt2'])). "'";
                    $ld = " AND year(s.created_on)='" . date('Y', strtotime($data['search_dt2'])) . "'";
                }
            } elseif ($data['duration'] == 'durationn') {

                $durationFrom = date('Y-m-d', strtotime($data['durationFrom'])); //date('Y-m-d',strtotime('-1 days'));

                $durationTo = date('Y-m-d', strtotime($data['durationTo'])); //date('Y-m-d', strtotime('-3 days'));



                $ld = "AND s.created_on BETWEEN '" . date('Y-m-d', strtotime($data['durationFrom'])) . " 00:00:00' AND '" . date('Y-m-d', strtotime($data['durationTo'])) . " 23:59:59'";
            }
        }
        $cs = " and  s.cancelled_admission='N' ";
        if (isset($data['is_cancel']) && !empty($data['is_cancel'])) {
            $cs = " and  s.cancelled_admission='Y' ";
        }

        $crm = '';
        $mc = "'---' as cordinator_name,";
        $cons = '';

        $cons = " LEFT join sandipun_ic_erp22.user_master as u on a.benefit_to=u.um_id
        left join sandipun_ic_erp22.consultants_call_details as c on u.con_id=c.id
        left join sandipun_ic_erp22.user_master as ium on c.inserted_by=ium.um_id or c.co_reff_by=ium.um_id
        left join sandipun_ic_erp22.ic_user_master as ieum on ium.employee_code=ieum.employee_code
        left join sandipun_ic_erp22.consultants_call_details as cm on cm.id=ium.con_id
        
        ";
        $mc = "CASE
        WHEN CONCAT(ieum.fname,' ',ieum.lname) !='' THEN CONCAT(ieum.fname,' ',ieum.lname)
        WHEN cm.contact_person !='' THEN cm.contact_person
    
            ELSE '---'
        END as cordinator_name,";
        if (!empty($belong_to) && $belong_to == 4) {
            $crm = " and a.belong_to_ic=$belong_to ";
        }
        if (!empty($get_val) && $get_val == 1) {
            if (!empty($belong_to) || $belong_to == 0) {

                $crm = " and a.belong_to_ic=$belong_to ";
            }

            /*$cons='';
        if(!empty($belong_to) && $belong_to==4){
            $cons=" join sandipun_ic_erp22.user_master as u on a.benefit_to=u.um_id
            join sandipun_ic_erp22.consultants_call_details as c on u.con_id=c.id
            
            ";
            if(!empty($is_fou) && $is_fou==1){
                $crm.=" and c.is_fou IN (1,2) ";
            }
            else{
                $crm.=" and (c.is_fou IS NULL or  c.is_fou =0)  ";
            }
        }*/


            if (!empty($is_fou) && $is_fou == 1) {
                $crm .= " and c.is_fou IN (1,2) ";
            } else {
                $crm .= " and (c.is_fou IS NULL or  c.is_fou =0)  ";
            }

            if ((!empty($benefit_to) || $benefit_to == 0) && $crm != '' && $belong_to != 2 && $belong_to != 3 && $belong_to != 4 && $belong_to != 1) {
                $crm .= " and a.benefit_to=$benefit_to ";
            }
        }

        $is_confirmc = '';
        if (!empty($is_confirm) && $is_confirm == 1) {
            $is_confirmc = ' and s.admission_confirm="Y"';
        }
        $umsdb = $this->load->database('umsdb', TRUE);
        $sql = "SELECT s.stud_id,s.nationality,'SUN' as campus,a.*,ad1.actual_fee,ad1.applicable_fee,fees_paid,v.course_type,s.email,s.enrollment_no,s.first_name,s.mobile as mobile1,a.ic_code,a.smd_id as student_id,sm.mobile1_valid,sm.mobile1_valid,a.source,s.created_on as pcreated,sm.programme_year, a.smd_date as lcreated_date,s.adhar_card_no,sm.contact_source,sm.othr_ref,sm.utm_campaign,e.event_name,sm.utm_source,sm.ic_code,
        
        states.state_name,taluka_master.taluka_name,district_name.district_name,
        v.school_short_name as school_name,v.course_short_name as course_name,v.stream_name,s.current_semester,s.current_year,s.mobile,$mc s.admission_confirm,af.total_fees as finalfees,s.father_fname as father_name
        FROM  sandipun_ic_erp22.admission_benefits_and_source as a
        join  student_master s  on a.student_id=s.stud_id
        LEFT JOIN vw_stream_details v ON v.stream_id=s.admission_stream
        left join sandipun_ums.admission_details ad1 on s.stud_id=ad1.student_id and ad1.academic_year='$ACYEAR'
        left join  sandipun_ums.academic_fees as af on s.admission_stream=af.stream_id and af.year=1
                and af.academic_year='$year' and af.is_active='Y'
            left join 
                (select sum(fdt.amount) as fees_paid,fdt.student_id from sandipun_ums.fees_details
                as fdt
                where fdt.type_id=2 and fdt.academic_year='$ACYEAR' 
                and fdt.chq_cancelled='N' and fdt.is_deleted='N' group by fdt.student_id) as
                fees_details on fees_details.student_id=s.stud_id	   
        left join address_details on address_details.student_id=s.stud_id and address_details.address_type='PERMNT'
        left join states on address_details.state_id=states.state_id
        left join taluka_master on address_details.city=taluka_master.taluka_id
        left join district_name on address_details.district_id=district_name.district_id 
        LEFT JOIN (select s11.utm_source,s11.ic_code,s11.event_code,s11.id,s11.mobile1,s11.mobile1_valid,s11.programme_year,s11.contact_source,s11.othr_ref,s11.utm_campaign from " . currentdb . ".student_meet_details s11 where s11.academic_year='$year') as sm on a.smd_id=sm.id
        left join " . currentdb . ".event_details  e on sm.event_code=e.event_code
        $cons
        WHERE 1=1 AND s.is_detained='N'  $cs $crm
        AND s.admission_session ='$c'  AND s.enrollment_no !='' $course_cond   $ld   
        $and_condition  $is_confirmc  group by s.stud_id desc order by s.created_on desc  $lm ";

        // # currentdb.student_meet_details sm (select distinct(s11.id) as id,s11.* from currentdb.student_meet_details s11 where s11.academic_year='$year'  ) as sm #

        $query = $umsdb->query($sql);

        $res = $query->result_array();

        if ($is_for == 0) {
            $is_confirmcsf = '';
            if (!empty($is_confirm) && $is_confirm == 1) {
                $is_confirmcsf = ' and   (isconfirmed=1 and s.admission_status="Admission")';
            }

            $umsdb = $this->load->database('ums_sijoul', TRUE);
            $sql = str_replace("1=1", "1=1 and a.is_for=2", $sql);
            $sql = str_replace("SUN", "SUM", $sql);

            $query = $umsdb->query($sql);
            $res1 = $query->result_array();

            $FullACYEAR = FullACYEAR;
            if (empty($year)) {
                $ACYEAR = ACYEAR;
            } else {
                $nc = explode('-', $year);
                $ACYEAR = $nc[0];
                $ACYEARn = $ACYEAR + 1;
                $FullACYEAR = $ACYEAR . "-" . $ACYEARn;
            }
            $cs = '';
            $sql = "SELECT 'Indian' as nationality,
            CASE
                WHEN s.College='SRP' OR s.College='SSJPITI'     THEN 'SF-SIJ'
            
                ELSE 'SF-NSK'
            END as campus,

            a.*, CASE
                WHEN isconfirmed=1   THEN 'Y'
            
                ELSE 'N'
            END as admission_confirm,actual_fees as actual_fee,applicable_fees as applicable_fee,paid_fees as fees_paid,'' as course_type,email_id as email,enrollment_no as enrollment_no,

            student_name as first_name,mobile as mobile1,a.ic_code,a.smd_id as student_id,sm.mobile1_valid,sm.mobile1_valid,a.source,admission_date as pcreated,sm.programme_year, a.smd_date as lcreated_date,aadhar_card as adhar_card_no,sm.contact_source,sm.othr_ref,sm.utm_campaign,e.event_name,sm.utm_source,sm.ic_code,
            
            s.state as state_name,TqName as taluka_name,localdistrict as district_name,
            College as school_name,Class as course_name,Stream as stream_name,'' as current_semester,s.academic_year as current_year,mobile,$mc s.admission_status as admission_confirmd,s.FathersName as father_name
            FROM  sandipun_ic_erp22.admission_benefits_and_source as a
            join  sf_admission_data s  on a.student_id=s.id

            LEFT JOIN (select s11.utm_source,s11.ic_code,s11.event_code,s11.id,s11.mobile1,s11.mobile1_valid,s11.programme_year,s11.contact_source,s11.othr_ref,s11.utm_campaign from " . currentdb . ".student_meet_details s11 where s11.academic_year='$year') as sm on a.smd_id=sm.id
            left join " . currentdb . ".event_details  e on sm.event_code=e.event_code
            $cons
            WHERE 1=1   $cs $crm $is_confirmcsf and s.admission_status not in ('Cancelled','DROP','Pending')
            AND s.academic_year ='$FullACYEAR'   $ld   and a.is_for=3
            $and_condition  group by s.id desc  $lm ";

            $query = $this->db->query($sql);
            $res2 = $query->result_array();
            $res = array_merge($res1, $res, $res2);
        }
        return $res;
    }


    /* end staff */

    function new_provisional_admission_sijoul($year = '', $course_id = '', $data = array(), $get_val = '', $is_for = "", $belong_to = '', $benefit_to = '', $is_fou = '')
    {
        //echo "inside";exit;
        $consultant_head = $userID = $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');
        $ic_code = $this->session->userdata('ic_code');
        if (empty($year)) {
            $ACYEAR = ACYEAR;
        } else {
            $nc = explode('-', $year);
            $ACYEAR = $nc[0];
        }
        $and_condition = '';
        if ($role_id == 1 || $role_id == 30 || $userID == 3964) {
        } elseif ($role_id == 9) {
            $and_condition = " and a.source IN (select utm_source from sandipun_ic_erp22.inhouse_digital_source where academic_year='$year' and status='Y') ";
        } elseif ($role_id == 7 || $role_id == 15 && $userID != 3964) {
            if ($consultant_head == 3414) {
                $and_condition = " and a.ic_code IN ('$ic_code','SU_MH_122','SU_BR_124') and a.belong_to_ic =3";
            } else {
                $and_condition = " and a.ic_code='$ic_code'";
            }
        } elseif ($role_id == 27) {
            $this->db->simple_query("SET GLOBAL group_concat_max_len = 1000000;");
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
		from sandipun_ic_erp22.ic_mapping where consultant_head=$consultant_head and status='Y'")->row()->ic_code;
            $referred_by = $this->db->query("select cordinator_id
		from sandipun_ic_erp22.consultant_cordinator_mapping where consultant_id=$consultant_head and status='Y'")->row()->cordinator_id;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $get_consultant_id = " a.benefit_to IN ( select u.um_id from sandipun_ic_erp22.consultants_call_details c join sandipun_ic_erp22.user_master u on c.id=u.con_id
		where c.consultant_head=$consultant_head or c.inserted_by=$consultant_head or c.inserted_by IN ($referred_by) or c.co_reff_by IN ($referred_by) and c.status='Y')";
            $and_condition =  " and (a.ic_code IN ($ss) OR $get_consultant_id )";
        } elseif ($role_id == 35) {
            if ($c_by == 2105) {
                $and_condition = " and a.benefit_to IN (select um_id from sandipun_ic_erp22.consultants_call_details c join sandipun_ic_erp22.user_master as u on c.id=u.con_id
		where c.inserted_by=$userID or c.co_reff_by=$userID or c.inserted_by=4004 or c.inserted_by=3379 ) ";
            } else if ($c_by == 2102 && $get_val == 1) {
                $and_condition = "";
            } else {
                $and_condition = " and a.benefit_to IN (select um_id from sandipun_ic_erp22.consultants_call_details c join sandipun_ic_erp22.user_master as u on c.id=u.con_id
		where c.inserted_by=$userID or c.co_reff_by=$userID) ";
            }
        } elseif ($role_id == 34) {
            if ($userID == 3437) {
                $and_condition = " and a.is_affliate=1 and a.affliate_name='College Dunia' ";
            } elseif ($userID == 4032) {
                $and_condition = " and a.is_affliate=1 and a.affliate_name='Shiksha' ";
            }
        } else {
            if ($userID == 4004 || $userID == 3379) {
                $and_condition = " and (a.benefit_to = " . $this->session->userdata('uid') . " or a.benefit_to IN  (select um_id
				from sandipun_ic_erp22.consultants_call_details as c join sandipun_ic_erp22.user_master as um on c.id=um.con_id where c.inserted_by=$userID or c.co_reff_by=$userID)) ";
            } else {
                $and_condition = " and a.benefit_to='$userID' ";
            }
        }
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        if ($course_id != '') {
            $course_cond = " AND v.course_id =$course_id ";
        }

        if ($rowno != '' && $rowperpage != '') {
            $lm = 'limit ' . $rowno . ',' . $rowperpage;
        } else {
            $lm = ' ';
        }
        $ld = '';
        if (!empty($data)) {
            if (($data['duration'] == 'day') || ($data['duration'] == 'month') || ($data['duration'] == 'year')) {

                if (isset($data['search_dt']) && $data['search_dt'] != '') {


                    $ld = " AND STR_TO_DATE(s.created_on,'%Y-%m-%d') = '" . date('Y-m-d', strtotime($data['search_dt'])) . "' ";
                } elseif (isset($data['search_dt1']) && $data['search_dt1'] != '') {

                    // $wdt = "AND month(called_on)='".date('m',strtotime($data['search_dt1']))."' and year(called_on) = '".date('Y',strtotime($data['search_dt1']))."' ";
                    $ld = " AND month(s.created_on)='" . date('m', strtotime($data['search_dt1'])) . "' and year(s.created_on) = '" . date('Y', strtotime($data['search_dt1'])) . "' ";
                } elseif (isset($data['search_dt2']) && $data['search_dt2'] != '') {

                    // $wdt = "AND year(called_on)='" .date('Y',strtotime($data['search_dt2'])). "'";
                    $ld = " AND year(s.created_on)='" . date('Y', strtotime($data['search_dt2'])) . "'";
                }
            } elseif ($data['duration'] == 'durationn') {

                $durationFrom = date('Y-m-d', strtotime($data['durationFrom'])); //date('Y-m-d',strtotime('-1 days'));

                $durationTo = date('Y-m-d', strtotime($data['durationTo'])); //date('Y-m-d', strtotime('-3 days'));




                $ld = "AND s.created_on BETWEEN '" . date('Y-m-d', strtotime($data['durationFrom'])) . " 00:00:00' AND '" . date('Y-m-d', strtotime($data['durationTo'])) . " 23:59:59'";
            }
        }

        $cs = " and  s.cancelled_admission='N' ";
        if (isset($data['is_cancel']) && !empty($data['is_cancel'])) {
            $cs = " and  s.cancelled_admission='Y' ";
        }

        $crm = '';
        $mc = "'---' as cordinator_name,";
        $cons = '';
        /*if(!empty($belong_to) && $belong_to==4){*/

        $cons = "left join sandipun_ic_erp22.user_master as u on a.benefit_to=u.um_id
	   left join sandipun_ic_erp22.consultants_call_details as c on u.con_id=c.id
	   left join sandipun_ic_erp22.user_master as ium on c.inserted_by=ium.um_id or c.co_reff_by=ium.um_id
	   left join sandipun_ic_erp22.ic_user_master as ieum on ium.employee_code=ieum.employee_code
	   left join sandipun_ic_erp22.consultants_call_details as cm on cm.id=ium.con_id
	   
	   ";
        if (!empty($is_fou) && $is_fou == 1) {
            $crm .= " and c.is_fou IN (1,2) ";
        } else {
            $crm .= "   ";
        }

        $mc = "CASE
                WHEN CONCAT(ieum.fname,' ',ieum.lname) !='' THEN CONCAT(ieum.fname,' ',ieum.lname)
                WHEN cm.contact_person !='' THEN cm.contact_person
                
                ELSE '---'
            END as cordinator_name,";

        /* }*/

        if (!empty($get_val) && $get_val == 1) {
            if (!empty($belong_to) || $belong_to == 0) {

                $crm .= " and a.belong_to_ic=$belong_to ";
            }

            if ((!empty($benefit_to) || $benefit_to == 0) && $crm != '' && $belong_to != 2 && $belong_to != 3 && $belong_to != 4 && $belong_to != 1) {
                $crm .= " and a.benefit_to=$benefit_to ";
            }
        }
        $connn = '';
        if (!empty($is_for)) {
            $connn .= " and a.is_for=$is_for ";
        }

        $umsdb = $this->load->database('ums_sijoul', TRUE);
        $sql = "SELECT a.*,s.nationality,s.stud_id,ad1.actual_fee,ad1.applicable_fee,fees_paid,v.course_type,s.email,s.enrollment_no,s.first_name,s.mobile as mobile1,a.ic_code,a.smd_id as student_id,sm.mobile1_valid,sm.mobile1_valid,a.source,s.created_on as pcreated,sm.programme_year, a.smd_date as lcreated_date,s.adhar_card_no,sm.contact_source,sm.othr_ref,sm.utm_campaign,e.event_name,sm.utm_source,sm.ic_code,
            states.state_name,taluka_master.taluka_name,district_name.district_name,
            v.school_short_name as school_name,v.course_short_name as course_name,v.stream_name,s.current_semester,s.current_year,s.mobile,$mc s.admission_confirm, sbk.Payment_type,s.father_fname as father_name,exd.stud_id as exam_stud_id
            FROM  sandipun_ic_erp22.admission_benefits_and_source as a
            join  student_master s  on a.student_id=s.stud_id

            LEFT JOIN vw_stream_details v ON v.stream_id=s.admission_stream
            left join sandipun_ums_sijoul.admission_details ad1 on s.stud_id=ad1.student_id and ad1.academic_year='$ACYEAR'
            left join  sandipun_ums_sijoul.academic_fees as af on s.admission_stream=af.stream_id and af.year=1
                    and af.academic_year='$year' and af.is_active='Y'
                    left join student_bank_details as sbk on s.stud_id=sbk.student_id
                left join 
                    (select sum(fdt.amount) as fees_paid,fdt.student_id from sandipun_ums_sijoul.fees_details
                    as fdt
                    where fdt.type_id=2 and fdt.academic_year='$ACYEAR' 
                    and fdt.chq_cancelled='N' and fdt.is_deleted='N' group by fdt.student_id) as
                    fees_details on fees_details.student_id=s.stud_id	 
            left join address_details on address_details.student_id=s.stud_id and address_details.adds_of='STUDENT'
            left join states on address_details.state_id=states.state_id
            left join taluka_master on address_details.city=taluka_master.taluka_id
            left join district_name on address_details.district_id=district_name.district_id 
            LEFT JOIN (select s11.utm_source,s11.ic_code,s11.event_code,s11.id,s11.mobile1,s11.mobile1_valid,s11.programme_year,s11.contact_source,s11.othr_ref,s11.utm_campaign from " . currentdb . ".student_meet_details s11 where s11.academic_year='$year') as sm on a.smd_id=sm.id
            left join " . currentdb . ".event_details  e on sm.event_code=e.event_code

            left join (select stud_id from sandipun_ums_sijoul.exam_details group by stud_id ) as   exd on s.stud_id=exd.stud_id
            $cons
            WHERE 1=1 AND s.is_detained='N'  $cs $crm
            AND s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !='' $course_cond AND v.course_id !=15  $ld   $connn
            $and_condition  group by s.stud_id desc  $lm ";

        // # currentdb.student_meet_details sm (select distinct(s11.id) as id,s11.* from currentdb.student_meet_details s11 where s11.academic_year='$year'  ) as sm #

        //echo $sql;
        //exit;

        $query = $umsdb->query($sql);

        $res = $query->result_array();
        return $res;
    }

    function get_consultant_list_ic_wise()
    {
        $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata("role_id");
        $ic_code = $this->session->userdata('ic_code');


        $wh = "";
        if ($role_id == 27) {
            $this->db->simple_query("SET GLOBAL group_concat_max_len = 1000000;");
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
         from ic_mapping where consultant_head=$c_by and status='Y'")->row()->ic_code;
            $referred_by = $this->db->query("select group_concat(cordinator_id) as cordinator_id
         from consultant_cordinator_mapping where consultant_id=$c_by and status='Y'")->row()->cordinator_id;

            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $wh =  " and (consultants_call_details.ic_code IN ($ss) OR consultants_call_details.inserted_by='" . $this->session->userdata('uid') . "' OR consultants_call_details.inserted_by IN ($referred_by)  OR consultants_call_details.co_reff_by IN ($referred_by) OR  consultants_call_details.consultant_head= '" . $this->session->userdata('uid') . "') ";

            $query = $this->db->query("select 
		count(*) as count,ir.ic_name  from consultants_call_details join user_master on 
		consultants_call_details.id=user_master.con_id 
		join ic_registration as ir on user_master.ic_code=ir.ic_code
		where  consultants_call_details.status='Y' $wh
		group by user_master.ic_code order by count desc");
        }

        $result = $query->result_array();

        return $result;
    }


    function display_reenquired_leads()
    {
        $role_id = $this->session->userdata("role_id");
        $con = '';
        $where = '';

        $academic_year = ACADEMIC_YEAR;
        if ($role_id == 2 || $role_id == 4 || $role_id == 8) {
            $c_by = $this->session->userdata('uid');

            $con = " join lead_assign_details as lg on sm.id=lg.stud_id and lg.active='Y'
		";
            $where = ' and  lg.lead_assign=' . $c_by;
        } elseif ($role_id == 15) {
            $ic_code = $this->session->userdata('ic_code');
            //$get_data=$this->db->

            $con = ' join  (select lead_assign,stud_id
            from lead_assign_details group by stud_id

            ) as lg on sm.id=lg.stud_id';
            $where = ' and  lg.lead_assign IN (select um_id from user_master 
                    where ic_code="' . $ic_code . '" and status="Y")';
        }
        //(select created_date from get_secondary_sources where student_id=g.student_id
        //order by id desc limit 1

        // ) As last_date
        /*echo  "select sf.stream_name,sf.school_short_name as schoolname,sm.student_name,sm.mobile1,sm.email,g.utm_source,g.utm_campaign,g.utm_medium,sm.created_date,sm.id,
                (select created_date from get_secondary_sources where student_id=g.student_id order by id desc limit 1) As last_date
                
                from get_secondary_sources g join student_meet_details sm on g.student_id=sm.id 
                left join su_sf_sijoul_stream_details sf on sm.programme_id=sf.stream_id and sf.belongtocampus=1

                $con $where group by student_id order by g.id desc";
                exit;*/

        $ld = '';

        if (isset($_POST) && !empty($_POST['duration'])) {

            $data = $_POST;

            if (($data['duration'] == 'day') || ($data['duration'] == 'month') || ($data['duration'] == 'year')) {

                if (isset($data['search_dt']) && $data['search_dt'] != '') {


                    $ld = " AND STR_TO_DATE(g.created_date,'%Y-%m-%d') = '" . date('Y-m-d', strtotime($data['search_dt'])) . "' ";
                } elseif (isset($data['search_dt1']) && $data['search_dt1'] != '') {

                    // $wdt = "AND month(called_on)='".date('m',strtotime($data['search_dt1']))."' and year(called_on) = '".date('Y',strtotime($data['search_dt1']))."' ";
                    $ld = " AND month(g.created_date)='" . date('m', strtotime($data['search_dt1'])) . "' and year(g.created_date) = '" . date('Y', strtotime($data['search_dt1'])) . "' ";
                } elseif (isset($data['search_dt2']) && $data['search_dt2'] != '') {

                    // $wdt = "AND year(called_on)='" .date('Y',strtotime($data['search_dt2'])). "'";
                    $ld = " AND year(g.created_date)='" . date('Y', strtotime($data['search_dt2'])) . "'";
                }
            } elseif ($data['duration'] == 'durationn') {

                $durationFrom = date('Y-m-d H:m:00', strtotime($data['durationFrom'])); //date('Y-m-d',strtotime('-1 days'));

                $durationTo = date('Y-m-d H:m:00', strtotime($data['durationTo'])); //date('Y-m-d', strtotime('-3 days'));



                $ld = "AND STR_TO_DATE(g.created_date,'%Y-%m-%d %H:%i:%s') >= '" . date('Y-m-d H:m:00', strtotime($data['durationFrom'])) . "' AND 
                STR_TO_DATE(g.created_date,'%Y-%m-%d %H:%i:%s') <=

                '" . date('Y-m-d H:m:00', strtotime($data['durationTo'])) . "'";
            }
        }
        $conn = '';

        if (empty($_POST)) {
            $data['durationFrom'] = date('Y-m-d');
            $data['durationTo'] = date('Y-m-d');
            $conn = " AND STR_TO_DATE(g.created_date,'%Y-%m-%d') >= '" . date('Y-m-d', strtotime($data['durationFrom'])) . "' AND 
                STR_TO_DATE(g.created_date,'%Y-%m-%d') <=

                '" . date('Y-m-d', strtotime($data['durationTo'])) . "'";
        }
        return $this->db->query("select sf.stream_name,sf.school_short_name as schoolname,sm.student_name,sm.mobile1,sm.email,g.utm_source,g.utm_campaign,g.utm_medium,sm.created_date,sm.id
	  
	   from get_secondary_sources g join student_meet_details sm on g.student_id=sm.id 
      left join su_sf_sijoul_stream_details sf on sm.programme_id=sf.stream_id and sf.belongtocampus=1

	   $con where 1=1 $where $ld  $conn and sm.academic_year='$academic_year' group by student_id order by g.id desc")->result_array();
    }



    function provisional_admission_new_data_aadhar_daily_cummulative_report_remaining_sijoul($year = '')
    {

        $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');
        $and_condition = '';
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        $lm = ' ';
        $ld = '';


        $umsdb = $this->load->database('ums_sijoul', TRUE);
        $sql = "SELECT s.cancelled_admission,au.created_by as cd,au.date_time as created_date_of_aadhar,s.email,enquiry_student_master.enquiry_taken,s.enrollment_no as confirmed_prn,s.first_name,s.mobile as mobile1,sm.ic_code,s.email,sm.id as student_id,sm.mobile1_valid,sm.utm_source,sm.event_code,s.created_on as pcreated,sm.programme_year, sm.created_date as lcreated_date, enquiry_student_master.is_from_consultant  as is_from_reference,enquiry_student_master.created_on as is_from_reference_created_on,enquiry_student_master.enquiry_id,s.admission_confirm,s.adhar_card_no,s.enrollment_no_new as enrollment_no,s.enrollment_no_new as enrollment_non,s.stud_id,sm.id as smid,sm.utm_source,
        s.mobile,s.citizenship,cu.created_by as cd1,cu.date_time as created_date_of_cno,s.nationality
        FROM student_master s 
        left join " . currentdb . ".aadhar_car_updation as au on s.adhar_card_no=au.add_no and au.academic_year='$year'
        left join sandipun_ums.enquiry_student_master as enquiry_student_master on s.adhar_card_no=enquiry_student_master.aadhar_card 
        left join " . currentdb . ".citizenshipdetails as cu on s.citizenship=cu.citizenship_no and  cu.academic_year='$year'
        left JOIN (select s11.* from " . currentdb . ".student_meet_details s11 where s11.academic_year='$year') as sm
        on ((au.student_id=sm.id)  AND sm.academic_year='$year' )

        WHERE
        s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !=''  AND s.is_detained='N' and s.cancelled_admission='N'   
            
        $course_cond   $ld 
        $and_condition 
        and s.stud_id NOT IN (select student_id from sandipun_ic_erp22.admission_benefits_and_source where is_for=2)   
        group by s.stud_id desc  $lm  ";


        // and STR_TO_DATE(s.created_on,'%Y-%m-%d') <= '2021-09-29' AND s.admission_cycle IS NULL and s.adhar_card_no	='721113834565'  ,,,,,,,,,,,,,,,,,  

        $query = $umsdb->query($sql);
        $res = $query->result();
        return $res;
    }



    function confirm_admission_ind_sijoul($year = '', $course_id = '')
    {
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        if ($course_id != '') {
            $course_cond = " AND v.course_id =$course_id ";
        }
        $umsdb = $this->load->database('ums_sijoul', TRUE);
        $sql = "SELECT s.mobile as mobile1
        FROM student_master s  
        JOIN sandipun_ic_erp22.admission_benefits_and_source as  a on s.stud_id=a.student_id and a.is_for=2
        LEFT JOIN vw_stream_details v ON v.stream_id=s.admission_stream WHERE s.cancelled_admission='N' AND s.is_detained='N'
        AND s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !=''   and s.admission_confirm='Y' and s.cancelled_admission='N' $course_cond and s.is_detained='N'
        group by s.stud_id ";

        $query = $umsdb->query($sql);

        $res = $query->num_rows();
        return $res;
    }

    function prov_admission_ind_sijoul($year = '', $course_id = '')
    {
        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        if ($course_id != '') {
            $course_cond = " AND v.course_id =$course_id ";
        }
        $umsdb = $this->load->database('ums_sijoul', TRUE);
        $sql = "SELECT s.mobile as mobile1
FROM student_master s  
JOIN sandipun_ic_erp22.admission_benefits_and_source as  a on s.stud_id=a.student_id and a.is_for=2

LEFT JOIN vw_stream_details v ON v.stream_id=s.admission_stream WHERE s.cancelled_admission='N' AND s.is_detained='N'
AND s.admission_session ='$c' AND s.academic_year ='$c' AND s.enrollment_no !='' $course_cond   and s.cancelled_admission='N' and s.is_detained='N'
group by s.stud_id ";
        $query = $umsdb->query($sql);
        $res = $query->num_rows();
        return $res;
    }

    function get_renumeration_amount_campus_wise($um_id, $current_year = '')
    {
        $current_year1 = $current_year;
        if ($current_year == '') {
            $current_year = $this->config->item('current_year');
        }
        /*select COALESCE(sum(amount),0) as renumeration_amout,is_for 
    from admission_benefits_and_source as a  where a.benefit_to='$um_id'
	group by is_for
     */



        return $this->db->query("
	select sum(a.amount) as renumeration_amout,is_for from admission_benefits_and_source a join sandipun_ums.student_master as sm on a.student_id=sm.stud_id
	where sm.cancelled_admission='N' and sm.admission_confirm='Y' and a.is_for=1 and a.benefit_to='$um_id' and a.academic_year='$current_year'
	UNION 
	
	select sum(renumeration_amout)  as renumeration_amout,is_for from (
	select (a.amount) as renumeration_amout,is_for from admission_benefits_and_source a join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id
	 join sandipun_ums_sijoul.fees_challan fs on a.student_id=fs.student_id 
	where sm.cancelled_admission='N' and sm.admission_confirm='Y' and a.is_for=2 and a.benefit_to='$um_id' and a.academic_year='$current_year' and fs.type_id=2 group by sm.stud_id
	) a
	
	
	UNION 
	select sum(a.amount) as renumeration_amout,is_for from admission_benefits_and_source a join sf_admission_data as sm on a.student_id=sm.id
	where admission_status ='Admission'  and isconfirmed=1 and a.is_for=3 and a.benefit_to='$um_id' and a.academic_year='$current_year'
	
	
	
	
	
	")->result();
    }


    function make_query()
    {
        $year = '2022-23';


        if ($year != "") {
            $sc_con2 = "  s.academic_year='$year' ";
        }

        $c_by = $this->session->userdata('uid');

        if ($c_by == 3437) {
            $source = " and   s.utm_source IN ('College Duniya','College Dunia') ";
        } elseif ($c_by == 3439) {
            $source = " and   s.utm_source IN ('College Search') ";
        } elseif ($c_by == 4032) {
            $source = " and   s.utm_source IN ('Shiksha') ";
        } elseif ($c_by == 3438) {
            $source = " and   s.utm_source IN ('Reviewadda') ";
        }
        if ($_POST["length"] != -1) {
            $start =  $_POST['start'];
            $length =  $_POST['length'];
            $sqllimit = "limit $start , $length";
        }
        $searchQuery = "";
        $searchValue = array();
        if (isset($_POST["search"]["value"])) {

            $searchValue =  $_POST["search"]["value"];
            //echo $searchValue; exit;
            $searchQuery = " and (s.email like '%" . $searchValue . "%' or
                 s.mobile1 like '%" . $searchValue . "%' or
                 s.student_name like '%" . $searchValue . "%')";
        }

        //select c.* from calling_log_details c where c_id=(select max(c_id) from calling_log_details c1 where c1.student_id=c.student_id)
        // left join lead_assign_details l on l.stud_id=s.id and s.academic_year=l.academic_year and l.academic_year='".ACADEMIC_YEAR."'

        $sql1 = "select asa.add_no,s.email,s.stream_name as smstream_name,std.stream_name,std.school_short_name as    school_name,s.student_name,
                s.adhar_no,s.country_name,s.state_name,s.city_name,s.mobile1,s.mobile1_valid,s.whatsappno,s.created_date,
                s.pmobile_no,s.pwhatsapp_no,s.utm_source,s.id as student_id ,c.calling_status,c.called_on
                from 
                student_meet_details as s 
                left join su_sf_sijoul_stream_details as std on s.programme_id=std.stream_id and s.campus_id=std.belongtocampus
               
                left join aadhar_car_updation  asa on s.id=asa.student_id
                left join (select student_id,calling_status,called_on from calling_log_details group by student_id ) as c on s.id=c.student_id
                where $sc_con2  $source  $searchQuery group by s.id  order by s.id desc ";
        $sql = "$sql1 $sqllimit";

        return  [$sql, $sql1];
    }

    function make_datatables()
    {
        $sql = $this->make_query();
        $query = $this->db->query($sql[0]);
        return $query->result();
    }
    function get_filtered_data()
    {
        $searchQuery = "";
        if ($searchValue != '') {
            $searchQuery = " and (s.email like '%" . $searchValue . "%' ) ";
        }
        $sql =  $this->make_query();
        $query = $this->db->query($sql[0]);



        return $query->num_rows();
        /*$query = $this->db->get();  
           return $query->num_rows();*/
    }
    function get_all_data()
    {
        $sql =  $this->make_query();
        // echo $sql; exit;
        $query = $this->db->query($sql[1]);
        return $query->num_rows();
    }

    function get_admission_done_but_not_verified()
    {
        $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata("role_id");
        $ic_code = $this->session->userdata('ic_code');




        $query = $this->db->query("SELECT c.*,benefit_to,contact_person,c.id as consultant_id,c.mobile_no,is_verified,c.address
FROM `admission_benefits_and_source` a
join user_master as um on a.benefit_to=um.um_id
join consultants_call_details as c on um.con_id=c.id
WHERE belong_to_ic=4 and (is_verified IS NULL OR is_verified=0) 
and (consultant_head=$c_by or um.ic_code IN (select ic_code from ic_mapping where consultant_head=$c_by and status='Y')
or c.inserted_by IN ( select cordinator_id from consultant_cordinator_mapping where   consultant_id=$c_by and status='Y') or
co_reff_by IN ( select cordinator_id from consultant_cordinator_mapping where   consultant_id=$c_by and status='Y'))
group by benefit_to order by contact_person asc ");



        $result = $query->result_array();

        return $result;
    }


    function new_provisional_admission_sf($year = '', $course_id = '', $data = array(), $get_val = '', $is_for = "", $belong_to = '', $benefit_to = '', $is_fou = '', $is_confirm = '', $is_srp = '')
    {



        $consultant_head = $userID = $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');
        $ic_code = $this->session->userdata('ic_code');
        $FullACYEAR = FullACYEAR;
        if (empty($year)) {
            $ACYEAR = ACYEAR;
        } else {
            $nc = explode('-', $year);
            $ACYEAR = $nc[0];
            $ACYEARn = $ACYEAR + 1;
            $FullACYEAR = $ACYEAR . "-" . $ACYEARn;
        }





        $and_condition = '';
        if ($role_id == 1 || $role_id == 30) {
        } elseif ($role_id == 9) {
            $and_condition = " and a.source IN ('website','Facebook','google','Website chatbot','Whatsapp chatbot','Simba','GOOGLE_GUJARAT','GOOGLE_UP','FACEBOOK_UP','FACEBOOK_BIHAR','GOOGLE_BR') ";
        } elseif ($role_id == 7 || $role_id == 15) {

            if ($consultant_head == 3964) {
                $and_condition = " and a.ic_code IN ('$ic_code','SU_BR_124') ";
            } elseif ($consultant_head == 3414) {
                $and_condition = " and a.ic_code IN ('$ic_code','SU_MH_122','SU_BR_124') and a.belong_to_ic =3";
            } else {

                $and_condition = " and a.ic_code='$ic_code'";
            }
        } elseif ($role_id == 27) {
            $this->db->simple_query("SET GLOBAL group_concat_max_len = 1000000;");
            $ss = $this->db->query("select group_concat(ic_code) as ic_code
		from sandipun_ic_erp22.ic_mapping where consultant_head=$consultant_head and status='Y'")->row()->ic_code;
            $referred_by = $this->db->query("select cordinator_id
		from sandipun_ic_erp22.consultant_cordinator_mapping where consultant_id=$consultant_head and status='Y'")->row()->cordinator_id;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $get_consultant_id = " a.benefit_to IN ( select u.um_id from sandipun_ic_erp22.consultants_call_details c join sandipun_ic_erp22.user_master u on c.id=u.con_id
		where c.consultant_head=$consultant_head or c.inserted_by=$consultant_head or c.inserted_by IN ($referred_by) or c.co_reff_by IN ($referred_by) and c.status='Y')";
            $and_condition =  " and (a.ic_code IN ($ss) OR $get_consultant_id )";
        } elseif ($role_id == 35) {
            if ($c_by == 2105) {
                $and_condition = " and a.benefit_to IN (select um_id from sandipun_ic_erp22.consultants_call_details c join sandipun_ic_erp22.user_master as u on c.id=u.con_id
		where c.inserted_by=$userID or c.co_reff_by=$userID or c.inserted_by=4004 or c.inserted_by=3379 ) ";
            } else {
                $and_condition = " and a.benefit_to IN (select um_id from sandipun_ic_erp22.consultants_call_details c join sandipun_ic_erp22.user_master as u on c.id=u.con_id
		where c.inserted_by=$userID or c.co_reff_by=$userID) ";
            }
        } elseif ($role_id == 34) {
            if ($userID == 3437) {
                $and_condition = " and a.is_affliate=1 and a.affliate_name='College Dunia' ";
            } elseif ($userID == 4032) {
                $and_condition = " and a.is_affliate=1 and a.affliate_name='Shiksha' ";
            }
        } else {


            if ($userID == 4004 || $userID == 3379) {
                $and_condition = " and (a.benefit_to = " . $this->session->userdata('uid') . " or a.benefit_to IN  (select um_id
				from sandipun_ic_erp22.consultants_call_details as c join sandipun_ic_erp22.user_master as um on c.id=um.con_id where c.inserted_by=$userID or c.co_reff_by=$userID)) ";
            } else {
                $and_condition = " and a.benefit_to='$userID' ";
            }
        }

        $c = explode('-', $year);
        $c = $c[0];
        $course_cond = '';
        if ($course_id != '') {
            //$course_cond=" AND v.course_id =$course_id ";

        }


        if ($rowno != '' && $rowperpage != '') {

            $lm = 'limit ' . $rowno . ',' . $rowperpage;
        } else {

            $lm = ' ';
        }




        $ld = '';


        if (!empty($data)) {
            /* if(($data['duration']=='day')||($data['duration']=='month')||($data['duration']=='year')){

        if (isset($data['search_dt']) && $data['search_dt'] != '') {

          
			$ld=" AND STR_TO_DATE(s.created_on,'%Y-%m-%d') = '".date('Y-m-d',strtotime($data['search_dt']))."' ";

        } elseif (isset($data['search_dt1']) && $data['search_dt1'] != '') {

           // $wdt = "AND month(called_on)='".date('m',strtotime($data['search_dt1']))."' and year(called_on) = '".date('Y',strtotime($data['search_dt1']))."' ";
			 $ld = " AND month(s.created_on)='".date('m',strtotime($data['search_dt1']))."' and year(s.created_on) = '".date('Y',strtotime($data['search_dt1']))."' ";

        } elseif (isset($data['search_dt2']) && $data['search_dt2'] != '') {

           // $wdt = "AND year(called_on)='" .date('Y',strtotime($data['search_dt2'])). "'";
			 $ld = " AND year(s.created_on)='" .date('Y',strtotime($data['search_dt2'])). "'";

        } 
  }
  elseif($data['duration']=='durationn'){

        $durationFrom = date('Y-m-d',strtotime($data['durationFrom']));//date('Y-m-d',strtotime('-1 days'));

        $durationTo = date('Y-m-d',strtotime($data['durationTo']));//date('Y-m-d', strtotime('-3 days'));

 

$ld ="AND s.created_on BETWEEN '".date('Y-m-d',strtotime($data['durationFrom']))." 00:00:00' AND '".date('Y-m-d',strtotime($data['durationTo'])). " 23:59:59'";
        }*/
        };

        $umsdb = $this->load->database('umsdb', TRUE);
        $crm = '';
        $mc = "'---' as cordinator_name,";
        $cons = '';
        $cons = " LEFT join sandipun_ic_erp22.user_master as u on a.benefit_to=u.um_id
	   left join sandipun_ic_erp22.consultants_call_details as c on u.con_id=c.id
	   left join sandipun_ic_erp22.user_master as ium on c.inserted_by=ium.um_id or c.co_reff_by=ium.um_id
	   left join sandipun_ic_erp22.ic_user_master as ieum on ium.employee_code=ieum.employee_code
	   left join sandipun_ic_erp22.consultants_call_details as cm on cm.id=ium.con_id
	   
	   ";
        $mc = "CASE
    WHEN CONCAT(ieum.fname,' ',ieum.lname) !='' THEN CONCAT(ieum.fname,' ',ieum.lname)
    WHEN cm.contact_person !='' THEN cm.contact_person
    
    ELSE '---'
END as cordinator_name,";
        if (!empty($belong_to) && $belong_to == 4) {
            $crm = " and a.belong_to_ic=$belong_to ";
        }
        if (!empty($get_val) && $get_val == 1) {
            if (!empty($belong_to) || $belong_to == 0) {

                $crm = " and a.belong_to_ic=$belong_to ";
            }




            if (!empty($is_fou) && $is_fou == 1) {
                $crm .= " and c.is_fou IN (1,2) ";
            } else {
                $crm .= " and (c.is_fou IS NULL or  c.is_fou =0)  ";
            }



            if ((!empty($benefit_to) || $benefit_to == 0) && $crm != '' && $belong_to != 2 && $belong_to != 3 && $belong_to != 4 && $belong_to != 1) {
                $crm .= " and a.benefit_to=$benefit_to ";
            }
        }

        $sff_condition = " and s.College NOT IN ('SSJPITI','SRP')";

        if ($is_srp == 1) {
            $sff_condition = " and s.College  IN ('SSJPITI','SRP')";
        }
        if ($is_srp == 2) {
            $sff_condition = " ";
        }
        $cs = '';

        $sql = "SELECT 
   

 a.*,s.Allotmentdate,Reportingdate,CapRound,CASE
    WHEN isconfirmed=1   THEN 'Y'
  
    ELSE 'N'
END as admission_confirm,actual_fees as actual_fee,applicable_fees as applicable_fee,paid_fees as fees_paid,'' as course_type,email_id as email,enrollment_no as enrollment_no,

student_name as first_name,mobile as mobile1,a.ic_code,a.smd_id as student_id,sm.mobile1_valid,sm.mobile1_valid,a.source,admission_date as pcreated,sm.programme_year, a.smd_date as lcreated_date,aadhar_card as adhar_card_no,sm.contact_source,sm.othr_ref,sm.utm_campaign,e.event_name,sm.utm_source,sm.ic_code,
 
s.state as state_name,TqName as taluka_name,localdistrict as district_name,
College as school_name,Class as course_name,Stream as stream_name,'' as current_semester,s.academic_year as current_year,mobile,$mc s.admission_status as admission_confirmd,ad.date_time as aadhar_card_createddate
FROM  sandipun_ic_erp22.admission_benefits_and_source as a
join  sf_admission_data s  on a.student_id=s.id
left join aadhar_car_updation as ad on s.aadhar_card=ad.add_no

LEFT JOIN (select s11.utm_source,s11.ic_code,s11.event_code,s11.id,s11.mobile1,s11.mobile1_valid,s11.programme_year,s11.contact_source,s11.othr_ref,s11.utm_campaign from " . currentdb . ".student_meet_details s11 where s11.academic_year='$year') as sm on a.smd_id=sm.id
left join " . currentdb . ".event_details  e on sm.event_code=e.event_code
$cons
WHERE 1=1 and ( (isconfirmed=0  and s.admission_status!='Cancel' and s.admission_status!='Drop') or  (isconfirmed=1 and s.admission_status='Admission') ) $cs $crm $sff_condition
AND s.academic_year ='$FullACYEAR'   $ld   and a.is_for=3
$and_condition  group by s.id desc  $lm ";





        // # currentdb.student_meet_details sm (select distinct(s11.id) as id,s11.* from currentdb.student_meet_details s11 where s11.academic_year='$year'  ) as sm #


        $query = $this->db->query($sql);

        $res = $query->result_array();
        return $res;
    }




    function assign_lead_to_members_new_for_ic($data)
    {
        // print_r($data);exit;

        $esid = explode(',', $data['sid']);
        foreach ($esid as $sid) {
            $arr['academic_year'] = $this->config->item('ic_year');
            $arr['calling_event'] = $data['calling_event'];
            $arr['stud_id'] = $sid;
            $arr['lead_assign'] = $data['memid'];
            $arr['lead_assign_on'] = date('Y-m-d H:i:s');
            $arr['lead_assign_by'] = $this->session->userdata('uid');
            //$get_bdm_ids="lead_assign Not IN (select distinct user_id from citymappingwitusers )  ";
            //$get_tcaller_ids="lead_assign Not IN (3414 )  ";
            $this->db->select('*');
            $this->db->from('lead_assign_details');
            $this->db->where('stud_id', $arr['stud_id']);
            $this->db->where('active', 'Y');

            $this->db->where('lead_assign', $arr['lead_assign']);
            //$this->db->where($get_tcaller_ids);
            $is_already_assign = $this->db->get()->row();
            //$this->db->where('');

            /* $is_already_assign= $this->db->get_where('lead_assign_details',
		  array('stud_id'=>$arr['stud_id'],'lead_assign !='=>3414,'active'=>'Y'
		  
		  
		  ))->row();*/
            //echo $this->db->last_query();


            if (empty($is_already_assign)) {

                $arrs_ses['active'] = 'N';
                $this->db->where('stud_id', $arr['stud_id']);
                $upd = $this->db->update('lead_assign_details', $arrs_ses);



                $ins = $this->db->insert('lead_assign_details', $arr);
                $arrs['lead_assign_status'] = 'Y';
                $this->db->where('id', $sid);
                $upd = $this->db->update('student_meet_details', $arrs);
            }
        }

        return $ins;
    }



    function get_admission_students_data($type, $academic_year_base, $um_id, $is_direct = '', $is_to_drcc_consider = '', $is_exam_appeared = '', $is_confirm_admisiion = '', $belong_to = '', $sf_segragation = '')
    {
        //echo "fff";
        //exit;
        $userID = $this->session->userdata('uid');
        //$ic_code = $this->session->userdata('ic_code');
        $role_id = $this->session->userdata('role_id');
        $con = '';
        $acdcon = '';
        $sf_sg = '';

        if (!empty($academic_year_base)) {
        } else {
            $academic_year_base = $this->config->item('current_year');
        }

        if (!empty($sf_segragation)) {

            if ($sf_segragation == 1) {
                $sf_sg = ' and College !="SRP"';
            } elseif ($sf_segragation == 2) {
                $sf_sg = ' and College ="SRP"';
            }
        }

        $current_year = explode('-', $academic_year_base);
        $acd = $current_year[0];
        $acdcon = " and a.academic_year='" . $academic_year_base . "'";

        if (!empty($type)) {
            $con = " and a.is_for='" . $type . "'";
        }
        $cac = '';
        if (!empty($is_confirm_admisiion) && $is_confirm_admisiion == 1) {
            $cac = " and s.admission_confirm='Y'";
        }

        $get_role_base_on_id = $this->db->query("select roles_id,ic_code from user_master where um_id=" . $um_id)->row();
        $role_id = $get_role_base_on_id->roles_id;
        $ic_code = $get_role_base_on_id->ic_code;
        $role_con = '';

        if ($role_id == 7) {

            $role_con = " and a.ic_code='$ic_code' and a.benefit_to=$um_id ";
        } elseif ($role_id == 27) {


            if ($belong_to == 4) {
                $get_consultant_id = " a.benefit_to IN ( select u.um_id from sandipun_ic_erp22.consultants_call_details c join sandipun_ic_erp22.user_master u on c.id=u.con_id
		where c.consultant_head=$userID ) ";
                $role_con =  "  and ( $get_consultant_id )";
            } elseif ($belong_to == 3 || $belong_to == 1) {
                $role_con = " 	and a.benefit_to in (select um_id from ic_users as um where ic_code IN (select ic_code from ic_mapping where consultant_head=$um_id and status='Y') ) and belong_to_ic=$belong_to";
            }
        } elseif ($role_id == 35) {
            $role_con = " and (a.benefit_to IN (select um_id from consultants_call_details as c join user_master as umo on c.id=umo.con_id where c.inserted_by=$um_id or c.co_reff_by=$um_id) OR a.benefit_to IN (
			select um_id from consultants_call_details as c join user_master as umo on c.id=umo.con_id where c.inserted_by IN (
			select um_id from consultants_call_details c1 join user_master as umo on c1.id=umo.con_id where c1.inserted_by=$um_id or c1.co_reff_by=$um_id
			)
			
			)) ";
        } elseif ($role_id == 1 || $role_id == 30) {
        } elseif ($role_id == 17) {

            //	$role_con=" and a.benefit_to='$um_id' ";	
            $role_con = " and ( a.benefit_to='$um_id' or benefit_to IN  (select COALESCE
		(um_id,0) from consultants_call_details as cr join user_master as umo on cr.id=umo.con_id where cr.inserted_by=$um_id or cr.co_reff_by=$um_id ) 
		or benefit_to IN (
		select COALESCE
		(um_id,0) from consultants_call_details as cr join user_master as umo on cr.id=umo.con_id where cr.inserted_by IN (select um_id from 
		consultants_call_details cr join user_master u on cr.id=u.con_id where cr.inserted_by=$um_id or cr.co_reff_by=$um_id))) ";
        } else {
            //or a.benefit_to 
            //IN (SELECT um_id FROM sandipun_ic_erp22.consultants_call_details AS c JOIN sandipun_ic_erp22.user_master AS 
            //um ON c.id=um.con_id WHERE c.inserted_by='$um_id' OR c.co_reff_by='$um_id' ) 
            $role_con = " and (   a.benefit_to='$um_id' )


			";
        }



        $and_condition = "";
        $fcondition = '';
        $eand_condition = "";
        $efcondition = '';
        if ($type == 2) {
            if ($is_to_drcc_consider == 1) {
            } elseif ($is_to_drcc_consider == 2) {

                $and_condition = " join  sandipun_ums_sijoul.fees_challan fs on s.stud_id=fs.student_id ";
                $fcondition = " and (fs.type_id=2 ) ";
            } elseif ($is_to_drcc_consider == 3) {

                $and_condition = "left join  sandipun_ums_sijoul.fees_challan fs on s.stud_id=fs.student_id ";
                $fcondition = " and (fs.student_id IS NULL ) ";
            } else {

                $and_condition = " join  sandipun_ums_sijoul.fees_challan fs on s.stud_id=fs.student_id ";
                $fcondition = " and (fs.type_id=2 ) ";
            }
            if (!empty($is_exam_appeared)) {
                if ($is_exam_appeared == 1) {
                    $eand_condition = " left join sandipun_ums_sijoul.exam_details as exd on s.stud_id=exd.stud_id";
                    $efcondition = " and exd.stud_id IS NOT NULL ";
                } elseif ($is_exam_appeared == 2) {
                    $eand_condition = " left join sandipun_ums_sijoul.exam_details as exd on s.stud_id=exd.stud_id";
                    $efcondition = " and exd.stud_id IS NULL ";
                }
            }
        }
        $fg = " group by s.stud_id order by s.stud_id ";

        if ($type == 3) {

            $fg = " s.id order by s.stud_id";
        }


        $is_affliate = $this->db->query("select * from affiliates_sources where um_id=$um_id and is_cpl=1")->row();

        if (empty($is_affliate)) {

            //left join consultant_wise_renumeration as csw on s.admission_stream=csw.stream_id and csw.is_for=1 and csw.consultant_id=a.benefit_tocsw.image,
            $sql = " select (@row_number := @row_number + 1) AS row_index,s.* from  (select 
		  CASE WHEN a.benefit_to=$um_id and (a.remark IS null or a.remark='')  then 'Direct' else 'Indirect' end as admission_type,
		  s.stud_id,ad1.actual_fee,ad1.applicable_fee,fees_paid,a.amount as renumeration_amount,
        vc.called_by as callers,vc.icname as icname,'' as center,vc.name as callername,af.tution_fees,
		s.created_on,s.enrollment_no,s.enrollment_no_new,s.first_name as name,s.email,s.mobile,a.*,vm.course_short_name,vm.stream_name,vm.school_short_name,st.state_name,
		
		dn.district_name,tm.taluka_name,'Nashik' as Campus
		from admission_benefits_and_source a 
		join sandipun_ums.student_master as s on s.stud_id=a.student_id and a.is_for=1
		$and_condition $eand_condition
        left join view_call_logs as vc on vc.student_id=a.smd_id 
		
		 join sandipun_ums.vw_stream_details as vm on s.admission_stream=vm.stream_id
		left join 
		(select sum(fdt.amount) as fees_paid,fdt.student_id from sandipun_ums.fees_details
		as fdt
		where fdt.type_id=2 
		and fdt.chq_cancelled='N' and fdt.is_deleted='N' group by fdt.student_id) as
		fees_details on fees_details.student_id=s.stud_id
		 join sandipun_ums.admission_details ad1 on s.stud_id=ad1.student_id and ad1.academic_year='$acd'
		 left join  sandipun_ums.academic_fees as af on s.admission_stream=af.stream_id 
           and af.academic_year='$academic_year_base' 
		 left join  sandipun_ums.address_details as ad on s.stud_id=ad.student_id 
		 left join  sandipun_ums.states as st on ad.state_id=st.state_id
		 left join  sandipun_ums.district_name as dn on ad.district_id=dn.district_id
		left  join  sandipun_ums.taluka_master as tm on ad.city=tm.taluka_id
		where a.id !='' and s.cancelled_admission='N' $cac $efcondition $acdcon $con $role_con $fcondition order by  CASE WHEN a.benefit_to=$um_id  THEN 1  ELSE 2 END )
          s

		$fg  ";
            /*group by s.stud_id
		*/
            if ($type == 2) {
                $sql = str_replace("sandipun_ums.student_master", "sandipun_ums_sijoul.student_master", $sql);
                $sql = str_replace("sandipun_ums.vw_stream_details", "sandipun_ums_sijoul.vw_stream_details", $sql);
                $sql = str_replace("sandipun_ums.academic_fees", "sandipun_ums_sijoul.academic_fees", $sql);
                $sql = str_replace("sandipun_ums.address_details", "sandipun_ums_sijoul.address_details", $sql);
                $sql = str_replace("sandipun_ums.states", "sandipun_ums_sijoul.states", $sql);
                $sql = str_replace("sandipun_ums.district_name", "sandipun_ums_sijoul.district_name", $sql);
                $sql = str_replace("sandipun_ums.taluka_master", "sandipun_ums_sijoul.taluka_master", $sql);
                $sql = str_replace("csw.is_for=1", "csw.is_for=2", $sql);
                $sql = str_replace("a.is_for=1", "a.is_for=2", $sql);
                $sql = str_replace("sandipun_ums.fees_details", "sandipun_ums_sijoul.fees_details", $sql);
                $sql = str_replace("sandipun_ums.admission_details", "sandipun_ums_sijoul.admission_details", $sql);
                $sql = str_replace("Nashik", "Sijoul", $sql);
            } elseif ($type == 3) {
                $sql = "select actual_fees as actual_fee,applicable_fees as applicable_fee,paid_fees as fees_paid,a.amount as renumeration_amount,csw.image,
         vc.called_by as callers,vc.icname as icname,'' as center,vc.name as callername,actual_fees as tution_fees,
		s.admission_date as created_on,s.enrollment_no,s.enrollment_no as enrollment_no_new,s.student_name as name,s.email_id as email,s.mobile,a.*,Course as course_short_name,Stream as stream_name,College as school_short_name,'--' as state_name,
		'--' as district_name,'--' as taluka_name,'SF' as Campus
		from admission_benefits_and_source a 
		join sf_admission_data as s on s.id=a.student_id and a.is_for=3 and s.admission_status IN ('Admission','Provisional') 
		left join consultant_wise_renumeration as csw on s.Stream=csw.streamname and csw.is_for=3 and csw.consultant_id=a.benefit_to
         left join view_call_logs as vc on vc.student_id=a.smd_id 		
		where a.id !='' $acdcon $con $role_con $sf_sg group by s.id order by s.enrollment_no ";
            } else {
            }
        } else {

            $affliate_name = $is_affliate->utm_source;



            $sql = "select ad1.actual_fee,ad1.applicable_fee,fees_paid,a.amount_for_aff as renumeration_amount,csw.image,
        vc.called_by as callers,vc.icname as icname,'' as center,vc.name as callername,af.tution_fees,
		s.created_on,s.enrollment_no,s.enrollment_no_new,s.first_name as name,s.email,s.mobile,a.*,vm.course_short_name,vm.stream_name,vm.school_short_name,st.state_name,
		a.amount_for_aff as amount,
		dn.district_name,tm.taluka_name,'Nashik' as Campus
		from admission_benefits_and_source a 
		join sandipun_ums.student_master as s on s.stud_id=a.student_id and a.is_for=1
		$and_condition $eand_condition
        left join view_call_logs as vc on vc.student_id=a.smd_id 
		left join consultant_wise_renumeration as csw on s.admission_stream=csw.stream_id and csw.is_for=1 and csw.consultant_id=a.benefit_to
		left join sandipun_ums.vw_stream_details as vm on s.admission_stream=vm.stream_id
		left join 
		(select sum(fdt.amount) as fees_paid,fdt.student_id from sandipun_ums.fees_details
		as fdt
		where fdt.type_id=2 and fdt.academic_year='$acd' 
		and fdt.chq_cancelled='N' and fdt.is_deleted='N' group by fdt.student_id) as
		fees_details on fees_details.student_id=s.stud_id
		left join sandipun_ums.admission_details ad1 on s.stud_id=ad1.student_id and ad1.academic_year='$acd'
		left join  sandipun_ums.academic_fees as af on s.admission_stream=af.stream_id 
           and af.academic_year='$academic_year_base' 
		left join  sandipun_ums.address_details as ad on s.stud_id=ad.student_id 
		left join  sandipun_ums.states as st on ad.state_id=st.state_id
		left join  sandipun_ums.district_name as dn on ad.district_id=dn.district_id
		left join  sandipun_ums.taluka_master as tm on ad.city=tm.taluka_id
		where a.id !='' and s.cancelled_admission='N' $cac $acdcon $con $efcondition and is_affliate=1 and affliate_name='$affliate_name'
          and belong_to_ic !=4 
		$fcondition  $fg  ";


            if ($type == 2) {
                $sql = str_replace("sandipun_ums.student_master", "sandipun_ums_sijoul.student_master", $sql);
                $sql = str_replace("sandipun_ums.vw_stream_details", "sandipun_ums_sijoul.vw_stream_details", $sql);
                $sql = str_replace("sandipun_ums.academic_fees", "sandipun_ums_sijoul.academic_fees", $sql);
                $sql = str_replace("sandipun_ums.address_details", "sandipun_ums_sijoul.address_details", $sql);
                $sql = str_replace("sandipun_ums.states", "sandipun_ums_sijoul.states", $sql);
                $sql = str_replace("sandipun_ums.district_name", "sandipun_ums_sijoul.district_name", $sql);
                $sql = str_replace("sandipun_ums.taluka_master", "sandipun_ums_sijoul.taluka_master", $sql);
                $sql = str_replace("csw.is_for=1", "csw.is_for=2", $sql);
                $sql = str_replace("a.is_for=1", "a.is_for=2", $sql);
                $sql = str_replace("sandipun_ums.fees_details", "sandipun_ums_sijoul.fees_details", $sql);
                $sql = str_replace("sandipun_ums.admission_details", "sandipun_ums_sijoul.admission_details", $sql);
                $sql = str_replace("Nashik", "Sijoul", $sql);
            }
        }





        if (!empty($type)) {
            ////echo $sql;
            // exit;
            $query = $this->db->query($sql);

            $result = $query->result_array();
        } else {

            $query = $this->db->query($sql);
            $result = $query->result_array();

            $sql = str_replace("sandipun_ums.student_master", "sandipun_ums_sijoul.student_master", $sql);
            $sql = str_replace("sandipun_ums.vw_stream_details", "sandipun_ums_sijoul.vw_stream_details", $sql);
            $sql = str_replace("sandipun_ums.academic_fees", "sandipun_ums_sijoul.academic_fees", $sql);
            $sql = str_replace("sandipun_ums.address_details", "sandipun_ums_sijoul.address_details", $sql);
            $sql = str_replace("sandipun_ums.states", "sandipun_ums_sijoul.states", $sql);
            $sql = str_replace("sandipun_ums.district_name", "sandipun_ums_sijoul.district_name", $sql);
            $sql = str_replace("sandipun_ums.taluka_master", "sandipun_ums_sijoul.taluka_master", $sql);
            $sql = str_replace("csw.is_for=1", "csw.is_for=2", $sql);
            $sql = str_replace("a.is_for=1", "a.is_for=2", $sql);
            $sql = str_replace("sandipun_ums.fees_details", "sandipun_ums_sijoul.fees_details", $sql);
            $sql = str_replace("sandipun_ums.admission_details", "sandipun_ums_sijoul.admission_details", $sql);
            $sql = str_replace("Nashik", "Sijoul", $sql);
            $query = $this->db->query($sql);
            $result1 = $query->result_array();

            $sql = "select actual_fees as actual_fee,applicable_fees as applicable_fee,paid_fees as fees_paid,a.amount as renumeration_amount,csw.image,
         vc.called_by as callers,vc.icname as icname,'' as center,vc.name as callername,actual_fees as tution_fees,
		s.admission_date as created_on,s.enrollment_no,s.enrollment_no as enrollment_no_new,s.student_name as name,s.email_id as email,s.mobile,a.*,Course as course_short_name,Stream as stream_name,College as school_short_name,'--' as state_name,
		'--' as district_name,'--' as taluka_name,'SF' as Campus
		from admission_benefits_and_source a 
		join sf_admission_data as s on s.id=a.student_id and a.is_for=3 and s.admission_status='Admission' and s.is_cancelled=0
		left join consultant_wise_renumeration as csw on s.Stream=csw.streamname and csw.is_for=3 and csw.consultant_id=a.benefit_to
         left join view_call_logs as vc on vc.student_id=a.smd_id 		
		where a.id !='' $acdcon $con $role_con $sf_sg group by s.id order by s.enrollment_no ";
            $query = $this->db->query($sql);
            $result2 = $query->result_array();
            $result = array_merge($result, $result1, $result2);
        }










        return $result;
    }


    public function get_details_of_staff_for_payment($data, $cid = "")
    {
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $wh1 = "";
        if (!empty($data['consultant']) && $data['consultant'] != ''  && $data['consultant'] != undefined) {
            $rfd11 = ' and um.um_id = "' . $data['consultant'] . '"';
        }
        $c = "";
        $c1 = "";
        if (!empty($data['academic_year']) && $data['academic_year'] != ''  && $data['academic_year'] != undefined) {
            $rfd = '';
            $c1 = $c = $data['academic_year'];
        } else {
            $cyear = $this->config->item('current_year');
            $rfd = '';
            $c1 = $c = $cyear;
        }

        $c = explode('-', $c);
        $c = $c[0];
        $ci = 'sandipun_ums.enquiry_student_master.academic_year="' . $c . '"';

        $cii = '';
        $ac = '';

        $wh = '';

        $sql = "Select * from(select um.roles_id,c.staff_name as name,c.mobile as mobile,c.email as email,c.id ,um.password,um.username,um.um_id,
			um.payroll,um.payroll_code,um.ifsc_code,um.account_no,
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
join sandipun_ums.student_master as s on a.student_id=s.stud_id			where a.belong_to_ic=2 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and s.cancelled_admission='N' and s.admission_confirm='Y'),0) as nashik_admission,
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
join sandipun_ums.student_master as s on a.student_id=s.stud_id			where a.belong_to_ic=2 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and s.cancelled_admission='N' ),0) as nashik_admissionp,
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
join sandipun_ums_sijoul.student_master as s on a.student_id=s.stud_id		

			where  a.academic_year='$c1' and  a.belong_to_ic=2
and s.cancelled_admission='N' and s.admission_confirm='Y'


			and a.benefit_to=um.um_id and is_for=2),0) as sijoul_admission,
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
join sandipun_ums_sijoul.student_master as s on a.student_id=s.stud_id		

			where  a.academic_year='$c1' and  a.belong_to_ic=2
and s.cancelled_admission='N' 


			and a.benefit_to=um.um_id and is_for=2),0) as sijoul_admissionp,
			
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a 
			join sf_admission_data as s on a.student_id=s.id and a.is_for=3 and s.admission_status='Admission' and s.College='SRP'
			
			where a.belong_to_ic=2 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=3 and (s.isconfirmed=1 or s.admission_status='Admission') ),0) as sf_admission_sj,
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a 
			join sf_admission_data as s on a.student_id=s.id and a.is_for=3 and s.admission_status='Admission' and s.College!='SRP'
			
			where a.belong_to_ic=2 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=3 and (s.isconfirmed=1 or s.admission_status='Admission')  ),0) as sf_admission_n,
			
			
			
			
			
			
			
			
			
			
			COALESCE((select sum(a.amount) from  consultant_payment_details as a where  academic_year='$c1' and a.consultant_id=um.um_id ),0) as total_payment
			from
			inhouse_staff_details as c  
			inner join user_master as um ON um.staff_id = c.id 
			join admission_benefits_and_source as a on a.benefit_to=um.um_id and a.belong_to_ic=2  and a.academic_year='$c1'
			where c.id !='' $wh $wh1 $rfd11 $cii $ac  group by c.id
			) as details  order by details.name
			
			
			";

        //echo $sql;
        //exit;

        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }


    function get_count_of_admission_done_role_wise_ic_head($um_id, $current_year1 = '')
    {

        if ($current_year1 == '') {
            $current_year1 = $this->config->item('current_year');
        }

        $rfd111 = '(select user_master.um_id from  user_master
				 where ic_code=(select ic_code from user_master um where um.um_id=' . $um_id . ' ) )';

        return $this->db->query("select COALESCE(sum(count),0)  as tc from(
select count(*) as count from admission_benefits_and_source
where benefit_to IN $rfd111 and academic_year='$current_year1'
) t")->row()->tc;
    }


    function check_cordinator($check_cordinator = '')
    {


        return  $this->db->query("select id from consultants_call_details c 
	  join user_master as u on c.id=u.con_id where u.um_id=$check_cordinator and is_cordinator=1 ")->row();
    }




    function get_all_lead_count($evt)
    {
        $academic_year = ACADEMIC_YEAR;
        $user_id = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');
        $ic_code = $this->session->userdata('ic_code');
        $ic_con = '';
        /*if($ic_code !='SU_MH_080'){
		 $ic_con=" and s.id NOT in (select stud_id  from lead_assign_details where lead_assign_by=$user_id
		  and lead_assign !='$user_id' and lead_assign_details.active='Y') ";	
		}*/
        if ($user_id == "superadmin" || $user_id == "admin") {
            $cond = " ";
        } else {
            // $cond="and c.called_by='". $user_id ."'";
            $cond = "and ld.lead_assign='" . $user_id . "'";
        }
        //$stconsd=" and s.latest_calling_status ='$status' ";
        /*if($status=="CAMPUS-VISIT"){
			$stconsd=" and s.latest_calling_status IN ('CAMPUS-VISIT','IC_VISIT','IC_REVISIT','CAMPUS-REVISIT') ";
		}
		else if($status=="CALL-DISCONNECTED"){
			$stconsd=" and s.latest_calling_status IN ('CALL DISCONNECTED','MOBILE SERVICE DISCONNECTED','NO OUT OF SERVICE','ROUTE BUSY/ ENGAGED','WRONG_NUMBER') ";
		}
		else if($status=="IN-VALID"){
			$stconsd=" and s.latest_calling_status IN ('IN-VALID','INVALID OPTION') ";
		}
		*/



        $sql = "SELECT count(distinct s.id) as cnt,calling_status
		FROM lead_assign_details as ld
		JOIN student_meet_details s on ld.stud_id=s.id     
		left join event_details ed on s.event_code=ed.event_code
		left join institute_master im on ed.institue_id=im.institue_id
		LEFT JOIN standard_master sm ON s.standard=sm.standard_id        
		inner join ic_users iu on iu.um_id=ld.lead_assign
		where s.academic_year='$academic_year' and ld.calling_event='" . $evt . "'  " . $cond . "
		and ld.active='Y' $ic_con
		AND s.student_name IS NOT NULL 
		group by s.latest_calling_status";
        $query = $this->db->query($sql);
        $res = $query->result_array();
        return $res;
    }



    function newleads($evt, $rowno = '', $rowperpage = '')
    {
        $user_id = $this->session->userdata('uid');
        $academic_year = ACADEMIC_YEAR;
        $ic_code = $ic = $this->session->userdata('ic_code');


        if ($rowno != '' && $rowperpage != '') {
            $lm = 'limit ' . $rowno . ',' . $rowperpage;
        } else {
            $lm = '';
        }

        $ic_con = '';


        $sql = "SELECT s.created_date as lead_date
		FROM  lead_assign_details as ld
		JOIN student_meet_details as s ON ld.stud_id = s.id and ld.academic_year=s.academic_year
		LEFT JOIN ic_registration i ON i.ic_code=s.ic_code
		left join event_details ed on s.event_code=ed.event_code
		left join institute_master im on ed.institue_id=im.institue_id
		WHERE (ld.calling_status IS NULL OR ld.calling_status='NA') and ld.active='Y' and ld.calling_event='" . $evt . "'  and ld.academic_year='" . $this->config->item('ic_year') . "' and ld.lead_assign = '" . $user_id . "' and ld.stud_id NOT IN(select smd_id from callingstudentsid) $ic_con   
		group by ld.stud_id $lm";
        $query = $this->db->query($sql);
        $res = $query->num_rows();
        return $res;
    }


    public function getallpendingdetails($utm_source = '', $acyear = '')
    {

        if (empty($acyear)) {
            $acyear = ACADEMIC_YEAR;
        }
        $nts = ' and (smd.nts IS NULL or smd.nts=0)';
        $utms = '';
        $campus_id = $_REQUEST['campus_id'];
        $campus_c = '';
        if (!empty($campus_id)) {

            if ($campus_id != 1) {

                $campus_c = " and smd.campus_id IN ($campus_id)";
            } else {
                $campus_c = " and (smd.campus_id IN (1,0) or smd.campus_id is NULL or smd.campus_id=''  )";
            }
        }


        if (!empty($utm_source)) {

            $utm_source = base64_decode($utm_source);
            $utms = " and utm_source='$utm_source' ";

            if ($utm_source == 'Sijoul Website chatbot') {
                $utms = "  and utm_source='Website chatbot' and campus_id=2 ";
            } elseif ($utm_source == 'Sijoul whatsapp chatbot') {
                $utms = "  and utm_source='Whatsapp chatbot' and campus_id=2 ";
            }
        }

        if ($utm_source == 'College Dunia' || $utm_source == 'CAREER360') {
            $sql = "(select student_name,mobile1,email,CONCAT(i.fname,' ',i.lname) as leadassignedto,utm_source,smd.created_date,sd.stream_name,smd.campus_id,sr.exam_no  from student_meet_details smd
            join (select * from lead_assign_details where active='Y') as ld on smd.id=ld.stud_id
		    join su_sf_sijoul_stream_details as sd on smd.programme_id=sd.stream_id and sd.belongtocampus=smd.campus_id
		    join ic_users as i on ld.lead_assign=i.um_id
		   left join su_jee_registration  as sr on smd.id=sr.student_id
		   where smd.academic_year='$acyear' 
		   AND TRIM(smd.latest_calling_status)='' $utms $nts $campus_c  group by smd.id)
		   UNION 
		   (select student_name,mobile1,email,'' as leadassignedto,utm_source,smd.created_date,sd.stream_name,smd.campus_id,sr.exam_no  from student_meet_details smd
		   join su_sf_sijoul_stream_details as sd on smd.programme_id=sd.stream_id and sd.belongtocampus=smd.campus_id
		    left join su_jee_registration  as sr on smd.id=sr.student_id
			where smd.academic_year='$acyear' 
		   AND TRIM(smd.latest_calling_status)='' $utms $nts $campus_c AND lead_assign_status='N'  group by smd.id) ";
        } else {
            $sql = "select student_name,mobile1,email,CONCAT(i.fname,' ',i.lname) as leadassignedto,utm_source,smd.created_date,sd.stream_name,smd.campus_id,sr.exam_no  from student_meet_details smd
           left join (select * from lead_assign_details where active='Y') as ld on smd.id=ld.stud_id
		   left join su_sf_sijoul_stream_details as sd on smd.programme_id=sd.stream_id and sd.belongtocampus=smd.campus_id
		   left join ic_users as i on ld.lead_assign=i.um_id
		   left join su_jee_registration  as sr on smd.id=sr.student_id
		where smd.academic_year='$acyear' 
		AND TRIM(smd.latest_calling_status)='' $utms $nts $campus_c  group by smd.id";
        }

        $data = $this->db->query($sql)->result_array();
        return $data;
    }





    function  fetch_students_details()
    {
        $ac = ACADEMIC_YEAR;
        $sql = "SELECT student_name,mobile1,sm.email,em.exam_name, CASE WHEN CONCAT(ium.fname, ' ' ,ium.lname) !='' THEN CONCAT(ium.fname, ' ' ,ium.lname) WHEN c.contact_person !='' THEN c.contact_person ELSE '' end as registerby, ir.ic_name,st.name as state,
    ct.name as city_name FROM sandipun_ic_erp22.student_meet_details sm join su_jee_registration as sr on sm.id=sr.student_id join exam_master as em on sr.exam_no=em.exam_id left join user_master as um on sr.inserted_by=um.um_id left join ic_user_master as ium on um.employee_code=ium.employee_code left join ic_registration as ir on um.ic_code=ir.ic_code left join consultants_call_details as c on um.con_id=c.id left join states as st on sm.state_id=st.id
left join cities as ct on sm.city_id=ct.id where sm.academic_year='$ac' order by student_id";
        $row = $this->db->query($sql);
        return $row->result_array();
    }


    function get_all_cordinator_list()
    {

        $role_id = $this->session->userdata('role_id');
        $uid = $this->session->userdata('uid');


        $this->db->select('um_id, CONCAT(iu.fname, ' . ', iu.lname) AS cname', FALSE);
        $this->db->from('consultant_cordinator_mapping as c');
        $this->db->join('user_master as u', 'c.cordinator_id=u.um_id');
        $this->db->join('ic_user_master as iu', 'u.employee_code=iu.employee_code');
        $this->db->where('c.status', 'Y');
        $this->db->where('u.status', 'Y');
        if ($role_id == 27) {
            $this->db->where('c.consultant_id', $uid);
        }
        return $this->db->get()->result_array();
    }



    public function get_details_of_coc_for_payment($data, $cid = "")
    {
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $wh1 = "";
        $for_consultant_head = '';
        $rfd111 = '';
        if (!empty($data['consultant']) && $data['consultant'] != ''  && $data['consultant'] != undefined) {
            $rfd11 = ' and a.benefit_to  IN (select um_id from user_master as ums join consultants_call_details as csd on ums.con_id=csd.id where csd.co_reff_by=' . $data['consultant'] . ' OR csd.inserted_by=' . $data['consultant'] . ' )';

            $rfd111 = ' and um.um_id = "' . $data['consultant'] . '"';
        }
        $c = "";
        $c1 = "";
        if (!empty($data['academic_year']) && $data['academic_year'] != ''  && $data['academic_year'] != undefined) {
            $rfd = '';
            $c1 = $c = $data['academic_year'];
        } else {
            $cyear = $this->config->item('current_year');
            $rfd = '';
            $c1 = $c = $cyear;
        }

        $c = explode('-', $c);
        $c = $c[0];
        $ci = 'sandipun_ums.enquiry_student_master.academic_year="' . $c . '"';
        $ic_code = '';
        $cii = '';
        $ac = '';

        $wh = '';

        $sql = "Select * from(select um.roles_id,CONCAT(c.fname,' ',c.lname) as name,c.mobile_personal as mobile,c.email_official as email,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id,um.ic_code,c.ifsc_code,c.branch_name,c.account_no,c.bank_name,c.acc_holder_name,c.scan_copy,c.Pancard,
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sandipun_ums.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id  and is_for=1 and sm.cancelled_admission='N' and sm.admission_confirm='Y' ),0) as nashik_admission,
			
			
				COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id  and is_for=2 and sm.cancelled_admission='N' and sm.admission_confirm='Y'  ),0) as sijoul_admission,
			
			
				
			
			
			
			
				COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sf_admission_data as sm on a.student_id=sm.id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and sm.admission_session='$c'  and is_for=3 and sm.admission_status='Admission' and sm.isconfirmed=1 and sm.College='SRP' ),0) as sf_admissionsij,
	
				COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sf_admission_data as sm on a.student_id=sm.id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and sm.admission_session='$c'  and is_for=3 and sm.admission_status='Admission' and sm.isconfirmed=1 and sm.College!='SRP'  ),0) as sf_admissionnsk,
			
			
			COALESCE((select sum(a.amount) from  admission_benefits_and_source as a
            join sandipun_ums.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id  and is_for=1 and sm.cancelled_admission='N' and sm.admission_confirm='Y'),0) as nashik_admission_amount,
			
			
			COALESCE((select sum(a.amount) from  admission_benefits_and_source as a
            join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id  and is_for=2 and sm.cancelled_admission='N' and sm.admission_confirm='Y' ),0) as sijoul_admission_amount,
			
			
			
			
			
			
		    COALESCE((select  sum(a.amount) from  admission_benefits_and_source as a
            join sf_admission_data as sm on a.student_id=sm.id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and sm.admission_session='$c'  and is_for=3 and sm.admission_status='Admission' and sm.isconfirmed=1 and sm.College='SRP' ),0) as sf_admissionsijamount,
	
				COALESCE((select  sum(a.amount) from  admission_benefits_and_source as a
            join sf_admission_data as sm on a.student_id=sm.id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and sm.admission_session='$c'  and is_for=3 and sm.admission_status='Admission' and sm.isconfirmed=1 and sm.College!='SRP' ),0) as sf_admissionnskamount,
		
		
		
			
			
			COALESCE((select sum(a.amount) from  consultant_payment_details as a where  academic_year='$c1' and a.consultant_id=um.um_id ),0) as total_payment,
			COALESCE((select sum(a.tds) from  consultant_payment_details as a where  academic_year='$c1' and a.consultant_id=um.um_id ),0) as tds
			from
			ic_user_master as c  
			inner join user_master as um ON um.employee_code = c.employee_code 
			left join states as s on c.state = s.id
			left join cities as ci ON ci.id=c.city
			where c.user_id !='' $wh $wh1 $rfd111  $cii $ac  group by c.user_id
			) as details  order by details.name
			
			
			";




        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }

    public function get_details_of_cc_for_payment($data, $cid = "")
    {
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $wh1 = "";
        $for_consultant_head = '';
        if (!empty($data['consultant']) && $data['consultant'] != ''  && $data['consultant'] != undefined) {
            $rfd11 = ' and um.um_id = "' . $data['consultant'] . '"';
        }
        $c = "";
        $c1 = "";
        if (!empty($data['academic_year']) && $data['academic_year'] != ''  && $data['academic_year'] != undefined) {
            $rfd = '';
            $c1 = $c = $data['academic_year'];
        } else {
            $cyear = $this->config->item('current_year');
            $rfd = '';
            $c1 = $c = $cyear;
        }

        $c = explode('-', $c);
        $c = $c[0];
        $ci = 'sandipun_ums.enquiry_student_master.academic_year="' . $c . '"';
        $ic_code = '';
        if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != undefined) {
            $wh1 = " ";
            //$ic_code=$data['icfilter'];
            //$for_consultant_head= " or a.ic_code='".$data['icfilter']."'";
        }
        $cii = '';
        $ac = '';
        if (!empty($data['ac']) && $data['ac'] != ''  && $data['ac'] != undefined) {

            $ac = ' and c.inserted_by = "' . $data['ac'] . '"';
        }
        $wh = '';

        $sql = "Select * from(select um.roles_id,CONCAT(c.fname,' ',c.lname) as name,c.mobile_personal as mobile,c.email_official as email,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id,um.ic_code,
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sandipun_ums.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and sm.cancelled_admission='N' and sm.admission_confirm='Y' ),0) as nashik_admission,
			
			
				COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2 and sm.cancelled_admission='N' and sm.admission_confirm='Y' ),0) as sijoul_admission,
			
			
				
			
			
			
			
				COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sf_admission_data as sm on a.student_id=sm.id 

			where  a.academic_year='$c1' and sm.admission_session='$c' and a.benefit_to=um.um_id and is_for=3 and sm.admission_status='Admission' and sm.isconfirmed=1 and sm.College='SRP'),0) as sf_admissionsij,
	
				COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sf_admission_data as sm on a.student_id=sm.id 

			where  a.academic_year='$c1' and sm.admission_session='$c' and a.benefit_to=um.um_id and is_for=3 and sm.admission_status='Admission' and sm.isconfirmed=1 and sm.College!='SRP' ),0) as sf_admissionnsk,
			
			
			COALESCE((select sum(a.amount) from  admission_benefits_and_source as a
            join sandipun_ums.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and sm.cancelled_admission='N' and sm.admission_confirm='Y' ),0) as nashik_admission_amount,
			
			
			COALESCE((select sum(a.amount) from  admission_benefits_and_source as a
            join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2 and sm.cancelled_admission='N' and sm.admission_confirm='Y'  ),0) as sijoul_admission_amount,
			
			
			
			
			
			
		    COALESCE((select  sum(a.amount) from  admission_benefits_and_source as a
            join sf_admission_data as sm on a.student_id=sm.id 

			where  a.academic_year='$c1' and sm.admission_session='$c' and a.benefit_to=um.um_id and is_for=3 and sm.admission_status='Admission' and sm.isconfirmed=1 and sm.College='SRP' ),0) as sf_admissionsijamount,
	
				COALESCE((select  sum(a.amount) from  admission_benefits_and_source as a
            join sf_admission_data as sm on a.student_id=sm.id 

			where  a.academic_year='$c1' and sm.admission_session='$c' and a.benefit_to=um.um_id and is_for=3 and sm.admission_status='Admission' and sm.isconfirmed=1 and sm.College!='SRP' ),0) as sf_admissionnskamount,
		
		
		
		
	
			
			
			
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
		
			
			
			
			
			
			
			
			
			
			
			
			
			
			COALESCE((select sum(a.amount) from  consultant_payment_details as a where  academic_year='$c1' and a.consultant_id=um.um_id ),0) as total_payment
			from
			ic_user_master as c  
			inner join user_master as um ON um.employee_code = c.employee_code 
			left join states as s on c.state = s.id
			left join cities as ci ON ci.id=c.city
			where c.user_id !='' $wh $wh1 $rfd11 $cii $ac  group by c.user_id
			) as details  order by details.name
			
			
			";




        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }



    function get_digital_list()
    {
        $ac = ACADEMIC_YEAR;
        return $digital = $this->db->query("select utm_source from student_meet_details where academic_year='$ac' and utm_source !='' group by utm_source")->result();
    }

    function update_data_of_fou($data = array())
    {
        $um_id = $data['um_id'];
        $is_exists = $this->db->get_where('fou_pending_details', array('um_id' => $um_id))->row();

        if (!empty($is_exists)) {
            $this->db->where('um_id', $um_id);
            $this->db->update('fou_pending_details', $data['um_id']);
        } else {
            $this->db->insert('fou_pending_details', $data);
        }
    }

    function get_all_utm_medium()
    {
        $username = $this->session->userdata("name");
        return $this->db->query("select utm_medium from student_meet_details
 where utm_medium !='' and utm_source='$username' 
 group by utm_medium")->result();
    }

    public function fetch_aadhar_fifdays()
    {
        $um_id = $this->session->userdata['uid'];
        $date = date('Y-m-d', strtotime('-16 days', time()));
        $role_id = $this->session->userdata("role_id");
        $dc = " STR_TO_DATE(ap.date_time,'%Y-%m-%d') <= '$date' ";
        $this->db->select('ap.add_no,s.student_name,s.mobile1,s.email,ap.date_time');
        $this->db->from('aadhar_car_updation as ap');
        $this->db->join('student_meet_details as s', 's.id=ap.student_id', 'left');
        if ($role_id != 1) {
            $this->db->where('ap.created_by', $um_id);
        }
        $this->db->where('ap.academic_year', ACADEMIC_YEAR);
        $this->db->where($dc);
        $this->db->order_by('ap.date_time', 'desc');
        return $this->db->get()->result_array();
    }


    public function aadhar_released()
    {
        $um_id = $this->session->userdata['uid'];
        $role_id = $this->session->userdata("role_id");
        $this->db->select('ap.add_no,s.student_name,s.mobile1,s.email,ap.date_time');
        $this->db->from('aadhar_car_updation as ap');
        $this->db->join('student_meet_details as s', 's.id=ap.student_id', 'left');
        if ($role_id != 1) {
            $this->db->where('ap.created_by', $um_id);
        }
        $this->db->where('ap.remark !=""');
        $this->db->where('ap.academic_year', ACADEMIC_YEAR);
        $this->db->order_by('ap.date_time', 'desc');
        return $this->db->get()->result_array();
    }


    public function aadhar_transferred()
    {
        $um_id = $this->session->userdata['uid'];
        $role_id = $this->session->userdata("role_id");
        $this->db->select('ap.aadhar_card,ap.operation,ap.release_on,ap.transfer_from_name,ap.transferto_name');
        $this->db->from('aadhar_card_transfered as ap');
        if ($role_id != 1) {
            $this->db->where('ap.transfer_to', $um_id);
            $this->db->where('ap.is_active', "Y");
        }
        $this->db->where('ap.academic_year', ACADEMIC_YEAR);
        $this->db->order_by('ap.id', 'desc');
        return $this->db->get()->result_array();
    }




    public function get_all_admissions($acd1 = '', $campus = '', $confirm = '', $is_srp = '')

    {

        //$acd1="",$check_for_p="",$role="",$cancelled_flag=''

        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");

        $uid = $this->session->userdata("uid");
        $wh = " where 1=1 ";
        $cc = '';
        if (!empty($campus) && $campus != 0) {
            $cc = "  AND a.is_for=$campus ";
        }

        $con = "";
        if (!empty($confirm)) {
            $con = "  AND sm.admission_confirm='Y' ";
            if (!empty($campus) && $campus == 3) {
                $con = '';
            }
        }



        /* $sql=" SELECT COALESCE(COUNT(belong_to_ic),0) as cnt,
		CASE
		WHEN benefit_to=0 AND belong_to_ic=0  THEN 'ONLINE' 
		WHEN benefit_to=1 AND belong_to_ic=0 THEN 'CAMPUS VISIT|DIRECT'
		WHEN belong_to_ic=1 THEN 'IC'
		WHEN belong_to_ic=2 THEN 'STAFF'
		WHEN belong_to_ic=3 THEN 'CC'
		WHEN belong_to_ic=4 THEN 'CONSULTANT'
		END AS belong_to_ic
		,
		CASE
		WHEN benefit_to=0 AND belong_to_ic=0  THEN 0 
		WHEN benefit_to=1 AND belong_to_ic=0 THEN  5
		WHEN belong_to_ic=1 THEN 1
		WHEN belong_to_ic=2 THEN 2
		WHEN belong_to_ic=3 THEN 3
		WHEN belong_to_ic=4 THEN 4
		END AS belong_to_ic
		FROM admission_benefits_and_source a JOIN sandipun_ums.student_master AS sm ON a.student_id=sm.stud_id  
		WHERE
		sm.cancelled_admission ='N' AND sm.enrollment_no !='' AND sm.admission_session='$acd' $cc AND is_second_benefit=0 $con
		GROUP BY a.belong_to_ic	";

		
		//$query  = $this->db->query($sql)->result();
		*/


        //exit;

        //return $query;
        $sff_condition = '';
        if ($campus == 3) {

            $sff_condition = " and sm.College NOT IN ('SSJPITI','SRP')";

            if ($is_srp == 1) {
                $sff_condition = " and sm.College  IN ('SSJPITI','SRP')";
            }
        }

        $sql = " SELECT COALESCE(COUNT(belong_to_ic),0) as cnt,'CAMPUS VISIT|DIRECT' as belong_to_ic,5 as type
		FROM admission_benefits_and_source a JOIN sandipun_ums.student_master AS sm ON a.student_id=sm.stud_id  
		WHERE
		sm.cancelled_admission ='N' AND sm.enrollment_no !='' AND sm.admission_session='$acd' $cc $sff_condition AND is_second_benefit=0 and benefit_to=1 $con and (a.remark is NULL OR a.remark='')
		GROUP BY a.belong_to_ic	";

        if ($campus == 2) {
            $sql = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
        } else if ($campus == 3) {
            $sql = str_replace("sandipun_ums.student_master", "sf_admission_data", $sql);
            $sql = str_replace("stud_id", "id", $sql);

            if (!empty($confirm)) {

                $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1)) ", $sql);
            } else {

                $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql);
            }





            $sql = str_replace("AND sm.enrollment_no !=''", "", $sql);
            // $sql =str_replace("AND sm.admission_confirm='Y'","",$sql);	




        }


        /*if(!empty($confirm)){
		echo $sql;
		echo "<br>";}
		*/





        if (empty($campus)) {
            //echo "Working on itg ";

            $a_s = $sql = str_replace("benefit_to=1", "benefit_to=1 and is_for=1", $sql);
            $query_of  = $this->db->query($sql)->result();

            //print_r($query_of);
            $sql = str_replace("is_for=1", "is_for=2", $sql);
            $sql = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
            $query_of1  = $this->db->query($sql)->result();

            $sql = str_replace("sandipun_ums_sijoul.student_master", "sf_admission_data", $sql);
            $sql = str_replace("stud_id", "id", $sql);
            if (!empty($confirm)) {

                $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1)) ", $sql);
            } else {
                //echo $sql;

                $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql);
                //echo $sql;
                //exit;
            }
            $sql = str_replace("AND sm.enrollment_no !=''", "", $sql);
            $sql = str_replace("is_for=2", "is_for=3", $sql);
            $sql = str_replace("AND sm.admission_confirm='Y'", "", $sql);
            $query_of2  = $this->db->query($sql)->result();


            $query_of = array_merge($query_of1, $query_of2, $query_of);
            $aggregated = new stdClass();
            $aggregated->cnt = 0;
            $aggregated->belong_to_ic = '';
            $aggregated->type = '';

            // Iterate over each item in the array and sum the 'cnt' values
            foreach ($query_of as $item) {
                if ($aggregated->belong_to_ic === '') {
                    $aggregated->belong_to_ic = $item->belong_to_ic;
                    $aggregated->type = $item->type;
                }
                $aggregated->cnt += $item->cnt;
            }
            $query_of = array($aggregated);
        } else {
            $query_of  = $this->db->query($sql)->result();
        }




        if (empty($campus)) {
            $sql = str_replace("and benefit_to=1", "and benefit_to=0", $a_s);
            $sql = str_replace("CAMPUS VISIT|DIRECT", "ONLINE", $sql);
            $sql = str_replace("5 as type", "0 as type", $sql);
            $query_on  = $this->db->query($sql)->result();

            $sql = str_replace("is_for=1", "is_for=2", $sql);
            $sql = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
            $query_on1  = $this->db->query($sql)->result();


            $sql = str_replace("sandipun_ums_sijoul.student_master", "sf_admission_data", $sql);
            $sql = str_replace("stud_id", "id", $sql);
            if (!empty($confirm)) {

                $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1)) ", $sql);
            } else {
                //echo $sql;

                $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql);
                //echo $sql;
                //exit;
            }
            $sql = str_replace("AND sm.enrollment_no !=''", "", $sql);
            $sql = str_replace("is_for=2", "is_for=3", $sql);
            $sql = str_replace("AND sm.admission_confirm='Y'", "", $sql);
            $query_on2  = $this->db->query($sql)->result();


            $query_on = array_merge($query_on, $query_on1, $query_on2);

            $aggregated = new stdClass();
            $aggregated->cnt = 0;
            $aggregated->belong_to_ic = '';
            $aggregated->type = '';

            // Iterate over each item in the array and sum the 'cnt' values
            foreach ($query_on as $item) {
                if ($aggregated->belong_to_ic === '') {
                    $aggregated->belong_to_ic = $item->belong_to_ic;
                    $aggregated->type = $item->type;
                }
                $aggregated->cnt += $item->cnt;
            }
            $query_on = array($aggregated);
        } else {

            $sql = str_replace("and benefit_to=1", "and benefit_to=0", $sql);
            $sql = str_replace("CAMPUS VISIT|DIRECT", "ONLINE", $sql);
            $sql = str_replace("5 as type", "0 as type", $sql);
            $query_on  = $this->db->query($sql)->result();
        }





        if (empty($campus)) {
            $sql = str_replace("and benefit_to=1", "and belong_to_ic=2", $a_s);
            $sql = str_replace("CAMPUS VISIT|DIRECT", "STAFF", $sql);
            $sql = str_replace("5 as type", "2 as type", $sql);
            $query_st  = $this->db->query($sql)->result();

            $sql = str_replace("is_for=1", "is_for=2", $sql);
            $sql = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
            $query_st1  = $this->db->query($sql)->result();


            $sql = str_replace("sandipun_ums_sijoul.student_master", "sf_admission_data", $sql);
            $sql = str_replace("stud_id", "id", $sql);
            if (!empty($confirm)) {
                $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1)) ", $sql);
            } else {
                //echo $sql;
                $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql);
                //echo $sql;
                //exit;
            }
            $sql = str_replace("AND sm.enrollment_no !=''", "", $sql);
            $sql = str_replace("is_for=2", "is_for=3", $sql);
            $sql = str_replace("AND sm.admission_confirm='Y'", "", $sql);
            $query_st2  = $this->db->query($sql)->result();
            $query_st = array_merge($query_st, $query_st1, $query_st2);
            //echo "<pre>";
            //print_r($query_st);
            $aggregated = new stdClass();
            $aggregated->cnt = 0;
            $aggregated->belong_to_ic = '';
            $aggregated->type = '';

            // Iterate over each item in the array and sum the 'cnt' values
            foreach ($query_st as $item) {
                if ($aggregated->belong_to_ic === '') {
                    $aggregated->belong_to_ic = $item->belong_to_ic;
                    $aggregated->type = $item->type;
                }
                $aggregated->cnt += $item->cnt;
            }
            $query_st = array($aggregated);
        } else {
            $sql = str_replace("and benefit_to=0", "and belong_to_ic=2", $sql);
            $sql = str_replace("ONLINE", "STAFF", $sql);
            $sql = str_replace("0 as type", "2 as type", $sql);
            $query_st  = $this->db->query($sql)->result();
        }




        if (empty($campus)) {
            $sql = str_replace("and benefit_to=1", "and belong_to_ic=3", $a_s);
            $sql = str_replace("CAMPUS VISIT|DIRECT", "CC", $sql);
            $sql = str_replace("5 as type", "3 as type", $sql);
            $query_cc  = $this->db->query($sql)->result();

            $sql = str_replace("is_for=1", "is_for=2", $sql);
            $sql = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
            $query_cc1  = $this->db->query($sql)->result();


            $sql = str_replace("sandipun_ums_sijoul.student_master", "sf_admission_data", $sql);
            $sql = str_replace("stud_id", "id", $sql);
            if (!empty($confirm)) {
                $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1)) ", $sql);
            } else {
                //echo $sql;
                $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql);
                //echo $sql;
                //exit;
            }
            $sql = str_replace("AND sm.enrollment_no !=''", "", $sql);
            $sql = str_replace("is_for=2", "is_for=3", $sql);
            $sql = str_replace("AND sm.admission_confirm='Y'", "", $sql);
            $query_cc2  = $this->db->query($sql)->result();
            $query_cc = array_merge($query_cc, $query_cc1, $query_cc2);

            $aggregated = new stdClass();
            $aggregated->cnt = 0;
            $aggregated->belong_to_ic = '';
            $aggregated->type = '';

            // Iterate over each item in the array and sum the 'cnt' values
            foreach ($query_cc as $item) {
                if ($aggregated->belong_to_ic === '') {
                    $aggregated->belong_to_ic = $item->belong_to_ic;
                    $aggregated->type = $item->type;
                }
                $aggregated->cnt += $item->cnt;
            }
            $query_cc = array($aggregated);
        } else {

            $sql = str_replace("and belong_to_ic=2", "and belong_to_ic=3", $sql);
            $sql = str_replace("STAFF", "CC", $sql);
            $sql = str_replace("2 as type", "3 as type", $sql);

            $query_cc  = $this->db->query($sql)->result();
        }






        if (empty($campus)) {


            $sql = str_replace("and benefit_to=1", "and belong_to_ic=1", $a_s);
            $sql = str_replace("CAMPUS VISIT|DIRECT", "IC", $sql);
            $sql = str_replace("5 as type", "1 as type", $sql);

            $query  = $this->db->query($sql)->result();

            $sql = str_replace("is_for=1", "is_for=2", $sql);
            $sql = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
            $query1  = $this->db->query($sql)->result();


            $sql = str_replace("sandipun_ums_sijoul.student_master", "sf_admission_data", $sql);
            $sql = str_replace("stud_id", "id", $sql);
            if (!empty($confirm)) {
                $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1)) ", $sql);
            } else {
                //echo $sql;
                $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql);
                //echo $sql;
                //exit;
            }
            $sql = str_replace("AND sm.enrollment_no !=''", "", $sql);
            $sql = str_replace("is_for=2", "is_for=3", $sql);
            $sql = str_replace("AND sm.admission_confirm='Y'", "", $sql);
            $query2  = $this->db->query($sql)->result();
            $query = array_merge($query, $query1, $query2);

            $aggregated = new stdClass();
            $aggregated->cnt = 0;
            $aggregated->belong_to_ic = '';
            $aggregated->type = '';

            // Iterate over each item in the array and sum the 'cnt' values
            foreach ($query as $item) {
                if ($aggregated->belong_to_ic === '') {
                    $aggregated->belong_to_ic = $item->belong_to_ic;
                    $aggregated->type = $item->type;
                }
                $aggregated->cnt += $item->cnt;
            }
            $query = array($aggregated);
        } else {
            $sql = str_replace("and belong_to_ic=3", "and belong_to_ic=1", $sql);
            $sql = str_replace("CC", "IC", $sql);
            $sql = str_replace("3 as type", "1 as type", $sql);

            $query  = $this->db->query($sql)->result();

            //echo $this->db->last_query();
            //exit;
        }










        $asc1 = $sql1 = " SELECT COALESCE(COUNT(belong_to_ic),0) as cnt,'CONSULTANT' as belong_to_ic,4 as type
		FROM admission_benefits_and_source a JOIN sandipun_ums.student_master AS sm ON a.student_id=sm.stud_id  
		JOIN user_master as u on a.benefit_to=u.um_id
		JOIN consultants_call_details as c on u.con_id=c.id
		WHERE
		sm.cancelled_admission ='N' AND sm.enrollment_no !='' AND sm.admission_session='$acd' $cc AND is_second_benefit=0 and belong_to_ic=4 and (c.is_fou =0 OR c.is_fou IS NULL) $con  $sff_condition and (a.remark IS NULL or a.remark ='')
		GROUP BY a.belong_to_ic	";

        if (!empty($campus)) {
            if ($campus == 2) {
                $sql1 = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql1);
            } else if ($campus == 3) {
                $sql1 = str_replace("sandipun_ums.student_master", "sf_admission_data", $sql1);
                $sql1 = str_replace("stud_id", "id", $sql1);
                if (!empty($confirm)) {

                    $sql1 = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1)) ", $sql1);
                } else {
                    $sql1 = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql1);
                }
                $sql1 = str_replace("AND sm.enrollment_no !=''", "", $sql1);
                //echo $sql1;
                // exit;
            }



            $queryc  = $this->db->query($sql1)->result();
        } else {
            $sql1 = str_replace("is_second_benefit=0", "is_second_benefit=0 and is_for=1", $sql1);

            $queryc  = $this->db->query($sql1)->result();
            $sql1 = str_replace("is_for=1", "is_for=2", $sql1);
            $sql1 = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql1);
            $queryc1  = $this->db->query($sql1)->result();
            $sql1 = str_replace("sandipun_ums_sijoul.student_master", "sf_admission_data", $sql1);
            $sql1 = str_replace("stud_id", "id", $sql1);
            if (!empty($confirm)) {

                $sql1 = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1)) ", $sql1);
            } else {
                $sql1 = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql1);
            }
            $sql1 = str_replace("AND sm.enrollment_no !=''", "", $sql1);
            $sql1 = str_replace("AND sm.admission_confirm='Y'", "", $sql1);
            $sql1 = str_replace("is_for=2", "is_for=3", $sql1);

            $queryc2  = $this->db->query($sql1)->result();

            $queryc = array_merge($queryc, $queryc1, $queryc2);

            $aggregated = new stdClass();
            $aggregated->cnt = 0;
            $aggregated->belong_to_ic = '';
            $aggregated->type = '';

            // Iterate over each item in the array and sum the 'cnt' values
            foreach ($queryc as $item) {
                if ($aggregated->belong_to_ic === '') {
                    $aggregated->belong_to_ic = $item->belong_to_ic;
                    $aggregated->type = $item->type;
                }
                $aggregated->cnt += $item->cnt;
            }
            $queryc = array($aggregated);
        }




        if (!empty($campus)) {
            $sql1 = str_replace("(c.is_fou =0 OR c.is_fou IS NULL)", "c.is_fou IN (1,2)", $sql1);
            $sql1 = str_replace("CONSULTANT", "FOU", $sql1);
            $sql1 = str_replace("4 as type", "6 as type", $sql1);

            $queryf  = $this->db->query($sql1)->result();
        } else {
            $sql1 = str_replace("(c.is_fou =0 OR c.is_fou IS NULL)", "c.is_fou IN (1,2)", $asc1);
            $sql1 = str_replace("is_second_benefit=0", "is_second_benefit=0 and is_for=1", $sql1);
            $sql1 = str_replace("CONSULTANT", "FOU", $sql1);
            $sql1 = str_replace("4 as type", "6 as type", $sql1);
            $queryf  = $this->db->query($sql1)->result();
            $sql1 = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql1);
            $sql1 = str_replace("is_for=1", "is_for=2", $sql1);
            $queryf1  = $this->db->query($sql1)->result();

            $sql1 = str_replace("sandipun_ums_sijoul.student_master", "sf_admission_data", $sql1);
            $sql1 = str_replace("stud_id", "id", $sql1);
            if (!empty($confirm)) {

                $sql1 = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1)) ", $sql1);
            } else {
                $sql1 = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql1);
            }
            $sql1 = str_replace("AND sm.enrollment_no !=''", "", $sql1);
            $sql1 = str_replace("AND sm.admission_confirm='Y'", "", $sql1);
            $sql1 = str_replace("is_for=2", "is_for=3", $sql1);
            $queryf2  = $this->db->query($sql1)->result();

            $queryf = array_merge($queryf, $queryf1, $queryf2);

            $aggregated = new stdClass();
            $aggregated->cnt = 0;
            $aggregated->belong_to_ic = '';
            $aggregated->type = '';

            // Iterate over each item in the array and sum the 'cnt' values
            foreach ($queryf as $item) {
                if ($aggregated->belong_to_ic === '') {
                    $aggregated->belong_to_ic = $item->belong_to_ic;
                    $aggregated->type = $item->type;
                }
                $aggregated->cnt += $item->cnt;
            }
            $queryf = array($aggregated);
        }




        $result = array_merge($query_of, $query_on, $query_st, $query_cc, $query, $queryc, $queryf);

        if (empty($campus)) {
        }


        //echo $this->db->last_query();
        //exit;

        return $result;
    }


    public function get_top_admissions($acd1 = '', $campus = '', $is_role = '', $is_affiliates = '', $is_srp = '')
    {

        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");

        $uid = $this->session->userdata("uid");
        $wh = " where 1=1 ";
        $cc = '';
        $af = '';
        if (!empty($campus)) {
            $cc = "  AND a.is_for=$campus ";
        }
        if (!empty($is_role)) {
            $cc .= "  and belong_to_ic=$is_role ";
        }


        $mc = "";
        $joinc = "";
        $joinmc = "";
        $mc1 = "";

        if ($is_role == 4) {
            $mc = ",c.contact_person as user";
            $mc1 = ",CASE WHEN CONCAT(iumo.fname,' ',iumo.lname) !='' THEN CONCAT(iumo.fname,' ',iumo.lname)
			WHEN cmo.contact_person !='' THEN cmo.contact_person
            ELSE '----' END AS cordinator";
            $joinc = "JOIN consultants_call_details as c on u.con_id=c.id";
            $joinmc .= "JOIN user_master as umo on c.inserted_by=umo.um_id
			left join ic_user_master as iumo on umo.employee_code=iumo.employee_code
			left join consultants_call_details as cmo on umo.con_id=cmo.id";
        } elseif ($is_role == 2) {
            $mc = ",c.staff_name as user";
            $mc1 = ",CONCAT(c.institute,'(',c.department,')') as cordinator";
            $joinc = "JOIN inhouse_staff_details as c on u.staff_id=c.id";
        } elseif ($is_role == 3) {
            $mc = " ,CONCAT(c.fname,' ',c.lname) as user ";
            $mc1 = ",ir.ic_name as cordinator";
            $joinc = "JOIN ic_user_master as c on u.employee_code=c.employee_code";
            $joinmc = "JOIN ic_registration as ir  on u.ic_code=ir.ic_code";
        } elseif ($is_role == 1) {
            $mc = " ,CONCAT(c.fname,' ',c.lname) as user ";
            $mc1 = ",ir.ic_name as cordinator";
            $joinc = "JOIN ic_user_master as c on u.employee_code=c.employee_code";
            $joinmc = "JOIN ic_registration as ir  on u.ic_code=ir.ic_code";
        }

        $condition = ' GROUP BY a.benefit_to order by COUNT(belong_to_ic) desc';

        if ($is_affiliates == 1) {

            $mc = " ,a.affliate_name as user";
            $mc1 = "";
            $joinc = "";
            $joinmc = "";
            $af = "  AND a.is_affliate=1 and affliate_name!='' ";
            $condition = ' GROUP BY a.affliate_name order by COUNT(a.affliate_name) desc ';
        }




        if (!empty($campus)) {

            $sff_condition = '';
            if ($campus == 3) {

                $sff_condition = " and sm.College NOT IN ('SSJPITI','SRP')";

                if ($is_srp == 1) {
                    $sff_condition = " and sm.College  IN ('SSJPITI','SRP')";
                }
            }


            $sql = " SELECT COUNT(belong_to_ic) as count $mc $mc1
		FROM admission_benefits_and_source a JOIN sandipun_ums.student_master AS sm ON a.student_id=sm.stud_id  
		JOIN user_master as u on a.benefit_to=u.um_id
		$joinc $joinmc
		WHERE a.remark IS NULL and
		sm.cancelled_admission ='N' AND sm.enrollment_no !='' AND sm.admission_session='$acd' $cc $sff_condition $af
		AND is_second_benefit=0
		$condition  limit 5	";


            if ($campus == 2) {
                $sql = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
            } else if ($campus == 3) {
                $sql = str_replace("sandipun_ums.student_master", "sf_admission_data", $sql);
                $sql = str_replace("stud_id", "id", $sql);
                $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql);
                $sql = str_replace("AND sm.enrollment_no !=''", "", $sql);
            }
            $query  = $this->db->query($sql)->result();
        } else {
            //echo "<pre>";
            $msql = $sql = " SELECT COUNT(belong_to_ic) as count $mc $mc1
		FROM admission_benefits_and_source a JOIN sandipun_ums.student_master AS sm ON a.student_id=sm.stud_id  
		JOIN user_master as u on a.benefit_to=u.um_id
		$joinc $joinmc 
		WHERE
		sm.cancelled_admission ='N' AND sm.enrollment_no !='' AND sm.admission_session='$acd' $cc  $af and a.is_for=1
		AND is_second_benefit=0
		$condition  limit 5	";
            //$query  = $this->db->query($sql)->result();

            //print_r( $query);

            $sql1 = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
            $sql1 = str_replace("is_for=1", "is_for=2", $sql1);
            // $query1  = $this->db->query($sql)->result();	
            $sql2 = str_replace("sandipun_ums.student_master", "sf_admission_data", $msql);
            $sql2 = str_replace("stud_id", "id", $sql2);
            $sql2 = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql2);
            $sql2 = str_replace("AND sm.enrollment_no !=''", "", $sql2);
            $sql2 = str_replace("is_for=1", "is_for=3", $sql2);


            $mq = " select *,sum(count) as count from ( ($sql) UNION ($sql1) UNION  ($sql2) ) s group by  user order by count desc limit 5";

            $query  = $this->db->query($mq)->result();



            //$query2  = $this->db->query($sql)->result();	

            //$query  = array_merge($query,$query1,$query2);	


            // print_r( $query1);
            //print_r( $query2);
            // exit;
        }






        return $query;
    }



    public function get_top_schools($acd1 = '', $campus = '')
    {

        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");

        $uid = $this->session->userdata("uid");
        $wh = " where 1=1 ";
        $cc = '';
        if (!empty($campus)) {
            //$cc="  AND a.is_for=$campus ";
        }

        $mc = "";
        $joinc = "";



        $sql = " SELECT COUNT(sm.stud_id) as count,vw.school_name,vw.school_short_name
		FROM sandipun_ums.student_master AS sm   
		JOIN sandipun_ums.vw_stream_details as vw on sm.admission_stream=vw.stream_id
		WHERE
		sm.cancelled_admission ='N' AND sm.enrollment_no !='' AND sm.admission_session='$acd' 
		GROUP BY vw.school_id order by COUNT(sm.stud_id) desc limit 5	";



        $query  = $this->db->query($sql)->result();


        return $query;
    }

    public function get_top_streams($acd1 = '', $campus = '')
    {

        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");

        $uid = $this->session->userdata("uid");
        $wh = " where 1=1 ";
        $cc = '';
        if (!empty($campus)) {
            //$cc="  AND a.is_for=$campus ";
        }

        $mc = "";
        $joinc = "";



        $sql = " SELECT COUNT(sm.stud_id) as count,vw.stream_name,vw.stream_short_name,vw.school_short_name
		FROM sandipun_ums.student_master AS sm   
		JOIN sandipun_ums.vw_stream_details as vw on sm.admission_stream=vw.stream_id
		WHERE
		sm.cancelled_admission ='N' AND sm.enrollment_no !='' AND sm.admission_session='$acd' 
		GROUP BY vw.stream_id order by COUNT(sm.stud_id) desc limit 3	";
        if ($campus == 2) {
            $sql = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
        }


        $query  = $this->db->query($sql)->result();


        return $query;
    }

    public function monthly_admissions($acd1 = '', $campus = '', $is_srp = '')
    {

        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");

        $uid = $this->session->userdata("uid");
        $wh = " where 1=1 ";
        $cc = '';
        $sff_condition = '';
        if (!empty($campus)) {
            $cc = "  AND a.is_for=$campus ";


            if ($campus == 3) {

                $sff_condition = " and sm.College NOT IN ('SSJPITI','SRP')";

                if ($is_srp == 1) {
                    $sff_condition = " and sm.College  IN ('SSJPITI','SRP')";
                }
            }
        }

        $mc = "";
        $joinc = "";



        /* $sql=" SELECT COUNT(sm.stud_id) as count,MONTHNAME(sm.created_on) as month
		FROM sandipun_ums.student_master AS sm   
		
		WHERE
		sm.cancelled_admission ='N' AND sm.enrollment_no !='' AND sm.admission_session='$acd'  $cc
			";*/


        $sql = " SELECT COUNT(sm.stud_id) as count ,MONTHNAME(sm.created_on) as month,year(sm.created_on) as year,MONTH(sm.created_on) AS MONTH_NUM
		FROM admission_benefits_and_source a JOIN sandipun_ums.student_master AS sm ON a.student_id=sm.stud_id  
		WHERE		
		sm.cancelled_admission ='N' AND sm.enrollment_no !='' AND sm.admission_session='$acd' $cc  $sff_condition 
		GROUP BY month(sm.created_on)  order by year(sm.created_on),month(sm.created_on)
";
        if (!empty($campus)) {
            if ($campus == 2) {
                $sql = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
            } else if ($campus == 3) {
                $sql = str_replace("sandipun_ums.student_master", "sf_admission_data", $sql);
                $sql = str_replace("stud_id", "id", $sql);
                $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql);
                $sql = str_replace("AND sm.enrollment_no !=''", "", $sql);
                $sql = str_replace("sm.created_on", "sm.ChallanDate", $sql);
            }
        } else {
            $nsql = $sql;


            $sql = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
            $sql = str_replace("sm.enrollment_no !=''", "sm.enrollment_no !='' and a.is_for=2", $sql);
            $ssql = $sql;

            $sql = str_replace("sandipun_ums.student_master", "sf_admission_data", $nsql);
            $sql = str_replace("stud_id", "id", $sql);
            $sql = str_replace("created_on", "ChallanDate", $sql);
            $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql);
            $sql = str_replace("AND sm.enrollment_no !=''", "", $sql);


            $sfql = $sql;


            $sql = " SELECT SUM(COUNT) AS count, month, year  from ( ($nsql) UNION ($ssql)  UNION ($sfql) ) a GROUP BY year, month, MONTH_NUM
ORDER BY year, MONTH_NUM    ";
        }




        $query  = $this->db->query($sql)->result();


        return $query;
    }



    public function get_coursewiseadmissions($acd1 = '', $campus = '', $is_role = '')
    {

        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");

        $uid = $this->session->userdata("uid");
        $wh = " where 1=1 ";
        $cc = '';
        if (!empty($campus)) {
            $cc = "  AND a.is_for=$campus ";
        }

        $mc = "";
        $joinc = "";

        $sql = " SELECT COUNT(belong_to_ic) as count,course_short_name,course_id
		FROM admission_benefits_and_source a JOIN sandipun_ums.student_master AS sm ON a.student_id=sm.stud_id  
		join sandipun_ums.vw_stream_details as vw on sm.admission_stream=vw.stream_id		
		WHERE
		sm.cancelled_admission ='N' AND sm.enrollment_no !='' AND sm.admission_session='$acd' $cc  AND a.remark IS NULL

		
		GROUP BY vw.course_id order by COUNT(vw.course_id)";

        if ($campus == 2) {
            $sql = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
        } elseif ($campus == 3) {
            $sql = " SELECT COUNT(id) as count,college as course_short_name,college as course_id
		FROM sf_admission_data  vw
		
		WHERE
		 vw.admission_session='$acd' and 
		 (vw.admission_status ='Admission' and vw.isconfirmed=1 or vw.isconfirmed=0  and vw.admission_status!='Cancel' and vw.admission_status!='Drop')
		GROUP BY vw.college order by COUNT(college)";
        }

        $query  = $this->db->query($sql)->result();

        //echo $sql;


        return $query;
    }



    public function get_streamwiseadmissions($acd1 = '', $campus = '', $is_role = '', $course_id = '')
    {

        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");

        $uid = $this->session->userdata("uid");
        $wh = " where 1=1 ";
        $cc = '';
        $cc1 = '';
        if (!empty($campus)) {

            $cc1 = "  AND a.is_for=$campus ";
        }

        if (!empty($course_id)) {
            $cc = "  AND vw.course_id='$course_id' ";
            if (!empty($campus) && $campus == 3) {
            }
        }

        $mc = "";
        $joinc = "";

        $sql = " SELECT COUNT(belong_to_ic) as count,stream_short_name,stream_id
		FROM admission_benefits_and_source a JOIN sandipun_ums.student_master AS sm ON a.student_id=sm.stud_id  
		join sandipun_ums.vw_stream_details as vw on sm.admission_stream=vw.stream_id		
		WHERE
		sm.cancelled_admission ='N' AND sm.enrollment_no !='' AND sm.admission_session='$acd' $cc $cc1   AND a.academic_year='$acd1'
		
		GROUP BY vw.stream_id order by COUNT(vw.stream_id)";
        if ($campus == 2) {
            $sql = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
        } elseif ($campus == 3) {
            //$sql =str_replace("sandipun_ums","sandipun_ums_sijoul",$sql);
            $sql = str_replace("sandipun_ums.student_master", "sf_admission_data", $sql);
            $sql = str_replace("sandipun_ums.student_master", "sf_admission_data", $sql);
            $sql = str_replace("join sandipun_ums.vw_stream_details as vw on sm.admission_stream=vw.stream_id", "", $sql);
            $sql = str_replace("stud_id", "id", $sql);
            $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql);
            $sql = str_replace("AND sm.enrollment_no !=''", "", $sql);
            $sql = str_replace("vw.stream_id", "Stream", $sql);
            $sql = str_replace("stream_short_name", "Stream as stream_short_name", $sql);
            $sql = str_replace("stream_id", "Stream as stream_id", $sql);
            $sql = str_replace("vw.course_id", "College", $sql);
        }


        $query  = $this->db->query($sql)->result();




        return $query;
    }


    public function get_streamwiseadmissionsc($acd1 = '', $campus = '', $is_role = '', $course_id = '')
    {

        $current_year = explode('-', $acd1);
        $acd = $current_year[0];
        $role_id = $this->session->userdata("role_id");

        $uid = $this->session->userdata("uid");
        $wh = " where 1=1 ";
        $cc = '';
        $cc1 = '';
        if (!empty($campus)) {

            $cc1 = "  AND a.is_for=$campus ";
        }

        if (!empty($course_id)) {
            $cc = "  AND vw.course_id='$course_id' ";
            if (!empty($campus) && $campus == 3) {
            }
        }

        $mc = "";
        $joinc = "";

        $sql = " SELECT COUNT(belong_to_ic) as count,stream_short_name,stream_id
		FROM admission_benefits_and_source a JOIN sandipun_ums.student_master AS sm ON a.student_id=sm.stud_id  
		join sandipun_ums.vw_stream_details as vw on sm.admission_stream=vw.stream_id		
		WHERE
		sm.cancelled_admission ='N' AND sm.enrollment_no !='' AND sm.admission_session='$acd' $cc $cc1  and sm.admission_confirm='Y'  AND a.academic_year='$acd1'
		
		GROUP BY vw.stream_id order by COUNT(vw.stream_id)";
        if ($campus == 2) {
            $sql = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
        } elseif ($campus == 3) {
            //$sql =str_replace("sandipun_ums","sandipun_ums_sijoul",$sql);
            $sql = str_replace("sandipun_ums.student_master", "sf_admission_data", $sql);
            $sql = str_replace("sandipun_ums.student_master", "sf_admission_data", $sql);
            $sql = str_replace("join sandipun_ums.vw_stream_details as vw on sm.admission_stream=vw.stream_id", "", $sql);
            $sql = str_replace("stud_id", "id", $sql);
            $sql = str_replace("sm.cancelled_admission ='N'", " (sm.admission_status ='Admission' and sm.isconfirmed=1) ", $sql);
            $sql = str_replace("AND sm.enrollment_no !=''", "", $sql);
            $sql = str_replace("and sm.admission_confirm='Y'", "", $sql);
            $sql = str_replace("vw.stream_id", "Stream", $sql);
            $sql = str_replace("stream_short_name", "Stream as stream_short_name", $sql);
            $sql = str_replace("stream_id", "Stream as stream_id", $sql);
            $sql = str_replace("vw.course_id", "College", $sql);
        }

        //echo $sql;
        //exit;
        $query  = $this->db->query($sql)->result();




        return $query;
    }




    function fetch_coursewise_schoolwise_admission($year = '', $data = array())
    {
        $consultant_head = $userID = $c_by = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');
        $ic_code = $this->session->userdata('ic_code');
        $name = $this->session->userdata('name');


        if (empty($year)) {
            $ac_year = ACYEAR;
        } else {
            $nc = explode('-', $year);
            $ac_year = $nc[0];
        }

        if ($rowno != '' && $rowperpage != '') {
            $lm = 'limit ' . $rowno . ',' . $rowperpage;
        } else {
            $lm = ' ';
        }
        $ld = '';
        if (!empty($data)) {
            if (($data['duration'] == 'day') || ($data['duration'] == 'month') || ($data['duration'] == 'year')) {

                if (isset($data['search_dt']) && $data['search_dt'] != '') {
                    $ld = " STR_TO_DATE(s.created_on,'%Y-%m-%d') = '" . date('Y-m-d', strtotime($data['search_dt'])) . "' ";
                } elseif (isset($data['search_dt1']) && $data['search_dt1'] != '') {

                    $ld = "  month(s.created_on)='" . date('m', strtotime($data['search_dt1'])) . "' and year(s.created_on) = '" . date('Y', strtotime($data['search_dt1'])) . "' ";
                } elseif (isset($data['search_dt2']) && $data['search_dt2'] != '') {

                    $ld = "  year(s.created_on)='" . date('Y', strtotime($data['search_dt2'])) . "'";
                }
            } elseif ($data['duration'] == 'durationn') {

                $durationFrom = date('Y-m-d', strtotime($data['durationFrom'])); //date('Y-m-d',strtotime('-1 days'));

                $durationTo = date('Y-m-d', strtotime($data['durationTo'])); //date('Y-m-d', strtotime('-3 days'));

                $ld = " s.created_on BETWEEN '" . date('Y-m-d', strtotime($data['durationFrom'])) . " 00:00:00' AND '" . date('Y-m-d', strtotime($data['durationTo'])) . " 23:59:59'";
            }
        }

        $nwhere = array(
            'a.is_for' => 1,
            's.cancelled_admission' => 'N',
            's.is_detained' => 'N',
            's.enrollment_no !=' => '',
            'a.academic_year' => $year,
            's.admission_session' => $ac_year,
            'vm.course_id !=' => 15,
        );
        $this->db->select("vm.school_name,vm.stream_name,vm.course_short_name,COALESCE(count(student_id),'0') as counts,'Nashik' as campus");
        $this->db->from('admission_benefits_and_source as a');
        $this->db->join('sandipun_ums.student_master as s', 'a.student_id=s.stud_id');
        $this->db->join('sandipun_ums.vw_stream_details as vm', 's.admission_stream=vm.stream_id', 'left');
        $this->db->where($nwhere);
        if (!empty($ld)) {
            $this->db->where($ld);
        }

        $and_condition = '';
        if ($role_id == 1 || $role_id == 30 || $role_id == 27) {
        } elseif ($role_id == 9) {
            $and_condition = "a.source IN ('website','Facebook','google','Website chatbot','Whatsapp chatbot','Simba','GOOGLE_GUJARAT','GOOGLE_UP','FACEBOOK_UP','FACEBOOK_BIHAR','GOOGLE_BR') ";
            $this->db->where($and_condition);
        } elseif ($role_id == 7 || $role_id == 15) {

            if ($consultant_head == 3414) {
                $and_condition = "a.ic_code IN ('$ic_code','SU_MH_122') and a.belong_to_ic =3";
            } else {
                $and_condition = "a.ic_code='$ic_code'";
            }

            $this->db->where($and_condition);
        } elseif ($role_id == 35) {
            if ($c_by == 2105) {
                $and_condition = "a.benefit_to IN (select um_id from sandipun_ic_erp22.consultants_call_details c join sandipun_ic_erp22.user_master as u on c.id=u.con_id
		where c.inserted_by=$userID or c.co_reff_by=$userID or c.inserted_by=4004 or c.inserted_by=3379 ) ";
            } else {
                $and_condition = "a.benefit_to IN (select um_id from sandipun_ic_erp22.consultants_call_details c join sandipun_ic_erp22.user_master as u on c.id=u.con_id
		where c.inserted_by=$userID or c.co_reff_by=$userID) ";
            }
            $this->db->where($and_condition);
        } elseif ($role_id == 34) {
            $and_condition = "a.is_affliate=1 and a.affliate_name='$name' ";
            $this->db->where($and_condition);
        } else {
            if ($role_id == 17) {
                $and_condition = "(a.benefit_to = " . $this->session->userdata('uid') . " or a.benefit_to IN  (select um_id
			from sandipun_ic_erp22.consultants_call_details as c join sandipun_ic_erp22.user_master as um on c.id=um.con_id where c.inserted_by=$userID or c.co_reff_by=$userID)) ";
            } else {
                $and_condition = "a.benefit_to='$userID' ";
            }
            $this->db->where($and_condition);
        }

        $this->db->where("a.remark IS NULL and a.is_second_benefit=0");

        $this->db->group_by('vm.school_id,vm.course_id,vm.stream_id');
        $nquery = $this->db->get();
        $nres = $nquery->result_array();


        /*
			$swhere=array(
			'a.is_for'=>1,
			's.cancelled_admission'=>'N',
			's.is_detained'=>'N',
			's.enrollment_no !='=>'',
			'a.academic_year'=>$year,
			's.admission_session'=>$ac_year,
			'vm.course_id !='=>15, 	  
			);
			$this->db->select("vm.school_name,vm.stream_name,vm.course_short_name,COALESCE(count(student_id),'0') as counts,'Sijoul' as campus");
			$this->db->from('admission_benefits_and_source as a');
			$this->db->join('sandipun_ums_sijoul.student_master as s','a.student_id=s.stud_id');
			$this->db->join('sandipun_ums_sijoul.vw_stream_details as vm','s.admission_stream=vm.stream_id','left');
			$this->db->where($swhere);
			if(!empty($ld)){
			$this->db->where($ld);
			}
			$this->db->group_by('vm.school_id,vm.course_id,vm.stream_id');
			$squery=$this->db->get();
			$sres=$squery->result_array();
*/
        $sres = array();
        $result[] = array_merge($nres, $sres);

        return $result;
    }

    public function get_top_campaigns($year = '', $campus = '', $is_srp = '')
    {

        $cam_c = '';
        if (!empty($campus)) {
            if ($campus == 1) {
                $cam_c = " and (campus_id =1 or  campus_id is null or campus_id='') ";
            } else {
                $cam_c = " and (campus_id =$campus)";
            }
        }


        $sql = " SELECT COUNT(id) as count,utm_campaign
		from student_meet_details s		
		WHERE
		utm_source  like '%google%' and s.academic_year='$year' and utm_campaign != 'INBOUND'  $cam_c and created_by=0
		GROUP BY utm_campaign order by COUNT(id) desc limit 5";

        $query  = $this->db->query($sql)->result();




        return $query;
    }

    public function admissions_digital($year, $campus = '', $is_srp = '')
    {


        $current_year = explode('-', $year);
        $acd = $current_year[0];

        $cam_c = '';
        $sff_condition = '';
        if (!empty($campus)) {
            if ($campus == 1) {
                $cam_c = " and (campus_id =1 or  campus_id is null or campus_id='') ";
            } else {
                $cam_c = "  ";
            }

            if ($campus == 3) {

                $sff_condition = " and sm.College NOT IN ('SSJPITI','SRP')";

                if ($is_srp == 1) {
                    $sff_condition = " and sm.College  IN ('SSJPITI','SRP')";
                }
            }
        }




        $sql = "SELECT s.utm_source,COUNT(belong_to_ic) AS COUNT
FROM admission_benefits_and_source a 
JOIN sandipun_ums.student_master AS sm ON a.student_id=sm.stud_id  
JOIN student_meet_details AS s ON a.smd_id=s.id
JOIN sandipun_ums.vw_stream_details AS vw ON sm.admission_stream=vw.stream_id		
WHERE sm.cancelled_admission ='N' AND sm.enrollment_no !='' AND sm.admission_session='$acd' 
AND s.academic_year='$year'   AND s.utm_source IS NOT NULL 
    AND EXISTS (select utm_source from inhouse_digital_source where academic_year='$year' and status='Y') $cam_c   $sff_condition
GROUP BY s.utm_source order by  COUNT(belong_to_ic) desc limit 7";
        if (!empty($campus)) {

            if ($campus == 2) {

                $sql = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
                $sql = str_replace("sm.enrollment_no !=''", "sm.enrollment_no !='' and a.is_for=2", $sql);
            } else if ($campus == 3) {

                //
                $sql = str_replace("sandipun_ums.student_master", "sf_admission_data", $sql);
                $sql = str_replace("stud_id", "id", $sql);
                $sql = str_replace("JOIN sandipun_ums.vw_stream_details AS vw ON sm.admission_stream=vw.stream_id", "", $sql);
                $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql);
                $sql = str_replace("AND sm.enrollment_no !=''", "", $sql);
                //$sql1 =str_replace("AND sm.admission_confirm='Y'","",$sql1);	
                //echo $sql;
                //exit;		 
            }
        } else {
            $nsql = $sql;


            $sql = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
            $sql = str_replace("sm.enrollment_no !=''", "sm.enrollment_no !='' and a.is_for=2", $sql);
            $ssql = $sql;

            $sql = str_replace("sandipun_ums.student_master", "sf_admission_data", $nsql);
            $sql = str_replace("stud_id", "id", $sql);

            $sql = str_replace("JOIN sandipun_ums.vw_stream_details AS vw ON sm.admission_stream=vw.stream_id", "", $sql);
            $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql);
            $sql = str_replace("AND sm.enrollment_no !=''", "", $sql);

            $sfql = $sql;

            $sql = "select * from ( ($nsql) UNION ($ssql)  UNION ($sfql) ) a group by  utm_source order by COUNT desc limit 7  ";
        }

        $query  = $this->db->query($sql)->result();




        return $query;
    }

    public function course_wise_digital($year, $campus = '', $is_srp = '')
    {


        $current_year = explode('-', $year);
        $acd = $current_year[0];
        $cam_c = '';
        $sff_condition = '';
        if (!empty($campus)) {
            if ($campus == 1) {
                $cam_c = " and a.is_for=1 ";
            } else {
                //$cam_c= " and (campus_id =$campus)  ";
            }

            if ($campus == 3) {

                $sff_condition = " and sm.College NOT IN ('SSJPITI','SRP')";

                if ($is_srp == 1) {
                    $sff_condition = " and sm.College  IN ('SSJPITI','SRP')";
                }
            }
        }
        $sql = "SELECT vw.school_short_name,COUNT(belong_to_ic) AS COUNT
FROM admission_benefits_and_source a 
JOIN sandipun_ums.student_master AS sm ON a.student_id=sm.stud_id  
JOIN student_meet_details AS s ON a.smd_id=s.id
JOIN sandipun_ums.vw_stream_details AS vw ON sm.admission_stream=vw.stream_id		
WHERE sm.cancelled_admission ='N' AND sm.enrollment_no !='' AND sm.admission_session='$acd' 
AND s.academic_year='$year' AND s.utm_source IS NOT NULL 
    AND EXISTS (select utm_source from inhouse_digital_source where academic_year='$year' and status='Y') $cam_c $sff_condition



GROUP BY vw.school_id ORDER BY COUNT(belong_to_ic) DESC";
        if (!empty($campus)) {

            if ($campus == 2) {

                $sql = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
                $sql = str_replace("sm.enrollment_no !=''", "sm.enrollment_no !='' and a.is_for=2", $sql);

                //echo $sql;
                //exit;
            } else if ($campus == 3) {

                //
                $sql = str_replace("sandipun_ums.student_master", "sf_admission_data", $sql);
                $sql = str_replace("stud_id", "id", $sql);
                $sql = str_replace("vw.school_short_name", "sm.College as school_short_name", $sql);
                $sql = str_replace("JOIN sandipun_ums.vw_stream_details AS vw ON sm.admission_stream=vw.stream_id", "", $sql);
                $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql);
                $sql = str_replace("AND sm.enrollment_no !=''", "", $sql);
                $sql = str_replace("vw.school_id", "sm.College", $sql);
                //$sql1 =str_replace("AND sm.admission_confirm='Y'","",$sql1);	

            }
        } else {

            $nsql = $sql;


            $sql = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
            $sql = str_replace("sm.enrollment_no !=''", "sm.enrollment_no !='' and a.is_for=2", $sql);
            $ssql = $sql;

            $sql = str_replace("sandipun_ums.student_master", "sf_admission_data", $nsql);
            $sql = str_replace("stud_id", "id", $sql);
            $sql = str_replace("vw.school_short_name", "s.College as school_short_name", $sql);
            $sql = str_replace("JOIN sandipun_ums.vw_stream_details AS vw ON sm.admission_stream=vw.stream_id", "", $sql);
            $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql);
            $sql = str_replace("AND sm.enrollment_no !=''", "", $sql);
            $sql = str_replace("vw.school_id", "s.College", $sql);
            $sfql = $sql;

            $sql = "select * from ( ($nsql) UNION ($ssql)  UNION ($sfql) ) a group by  school_short_name order by COUNT desc limit 7  ";
            //exit;


        }

        //echo $sql;
        //exit;
        $query  = $this->db->query($sql)->result();




        return $query;
    }


    public function monthly_digital_admissions($year, $campus = '', $is_srp = '')
    {


        $current_year = explode('-', $year);
        $acd = $current_year[0];

        $cam_c = '';
        $sff_condition = '';
        if (!empty($campus)) {
            if ($campus == 1) {
                $cam_c = "  ";
            } else {
                $cam_c = " ";
            }
            if ($campus == 3) {

                $sff_condition = " and sm.College NOT IN ('SSJPITI','SRP')";

                if ($is_srp == 1) {
                    $sff_condition = " and sm.College  IN ('SSJPITI','SRP')";
                }
            }
        }

        $sql = "SELECT MONTHNAME(sm.created_on) as monthname,COUNT(belong_to_ic) AS COUNT
FROM admission_benefits_and_source a 
JOIN sandipun_ums.student_master AS sm ON a.student_id=sm.stud_id  
JOIN student_meet_details AS s ON a.smd_id=s.id
WHERE sm.cancelled_admission ='N' AND sm.enrollment_no !='' AND sm.admission_session='$acd' 
AND s.academic_year='$year' AND s.utm_source IS NOT NULL 
    AND EXISTS (select utm_source from inhouse_digital_source where academic_year='$year' and status='Y' ) $cam_c $sff_condition
GROUP BY MONTH(sm.created_on) ";
        if (!empty($campus)) {

            if ($campus == 2) {

                $sql = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
                $sql = str_replace("sm.enrollment_no !=''", "sm.enrollment_no !='' and a.is_for=2", $sql);

                //echo $sql;
                //exit;
            } else if ($campus == 3) {

                //


                $sql = str_replace("sandipun_ums.student_master", "sf_admission_data", $sql);
                $sql = str_replace("stud_id", "id", $sql);
                $sql = str_replace("created_on", "ChallanDate", $sql);
                $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql);
                $sql = str_replace("AND sm.enrollment_no !=''", "", $sql);
            }
        } else {

            $nsql = $sql;


            $sql = str_replace("sandipun_ums", "sandipun_ums_sijoul", $sql);
            $sql = str_replace("sm.enrollment_no !=''", "sm.enrollment_no !='' and a.is_for=2", $sql);
            $ssql = $sql;

            $sql = str_replace("sandipun_ums.student_master", "sf_admission_data", $nsql);
            $sql = str_replace("stud_id", "id", $sql);
            $sql = str_replace("created_on", "ChallanDate", $sql);
            $sql = str_replace("sm.cancelled_admission ='N'", " ((sm.admission_status ='Admission' and sm.isconfirmed=1) or (sm.isconfirmed=0  and sm.admission_status!='Cancel' and sm.admission_status!='Drop')) ", $sql);
            $sql = str_replace("AND sm.enrollment_no !=''", "", $sql);


            $sfql = $sql;


            $sql = "select * from ( ($nsql) UNION ($ssql)  UNION ($sfql) ) a group by  monthname   ";
        }





        $query  = $this->db->query($sql)->result();




        return $query;
    }

    public function get_all_consultant_admission_report($data)
    {
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");

        $rfd11 = '';
        $rfd1 = '';
        $wh1 = "";
        if (!empty($data['consultant']) && $data['consultant'] != ''  && $data['consultant'] != undefined) {
            $rfd11 = ' and um.um_id = "' . $data['consultant'] . '"';
        }
        $c = "";
        $c1 = "";
        if (!empty($data['academic_year']) && $data['academic_year'] != ''  && $data['academic_year'] != undefined) {
            $rfd = '';
            $c1 = $c = $data['academic_year'];
        } else {
            $cyear = $this->config->item('current_year');
            $rfd = '';
            $c1 = $c = $cyear;
        }

        $c = explode('-', $c);
        $c = $c[0];
        /* $is_fou=' and (c.is_fou =0 OR c.is_fou IS NULL )';
			if(!empty($data['is_fou']) && $data['is_fou']==1){
				$is_fou=' and c.is_fou =1';
			} */


        $ci = 'sandipun_ums.enquiry_student_master.academic_year="' . $c . '"';
        if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != undefined) {
            $wh1 = " and um.ic_code='" . $data['icfilter'] . "'";
        }
        $cii = '';
        $ac = '';
        if (!empty($data['ac']) && $data['ac'] != ''  && $data['ac'] != undefined) {

            $ac = ' and c.inserted_by = "' . $data['ac'] . '"';
        }
        $wh = '';

        if (!empty($data['consultant_head']) && $data['consultant_head'] != ''  && $data['consultant_head'] != undefined) {

            $ss = $this->db->query("select group_concat(ic_code) as ic_code
			from ic_mapping where consultant_head=" . $data['consultant_head'] . " and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=" . $data['consultant_head'] . " and status='Y'")->row()->cordinator_id;
            $wh =  " and (c.ic_code IN ($ss) OR c.inserted_by='" . $data['consultant_head'] . "' OR c.inserted_by IN ($referred_by ) OR c.consultant_head=" . $data['consultant_head'] . " ) ";
        }

        /*$sql = "select c.contact_person as consultant,
			CONCAT(iumc.fname,' ',iumc.lname) as cordinator2,
			ir.ic_name,
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sandipun_ums.student_master as s on a.student_id=s.stud_id			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and s.cancelled_admission='N' and s.admission_confirm='Y'),0) as nashik_admission,

			COALESCE((select count(a.id) from  admission_benefits_and_source as a 
			join sf_admission_data as s on a.student_id=s.id and a.is_for=3 and s.admission_status='Admission'
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=3
			and s.isconfirmed=1 and s.is_cancelled=0),0) as sf_admissions,
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sandipun_ums_sijoul.student_master fs on a.student_id=fs.stud_id and a.is_for=2
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2
			and fs.cancelled_admission='N' and fs.admission_confirm='Y'),0) as sijoul_admission			
			from admission_benefits_and_source am
			inner join user_master as um ON am.benefit_to = um.um_id and am.academic_year='$c1'
			join consultants_call_details as c  ON um.con_id = c.id 
			join user_master as umc on c.inserted_by=umc.um_id 	
			join ic_user_master as iumc on umc.employee_code=iumc.employee_code
			join ic_registration as ir on um.ic_code=ir.ic_code
			 
			where c.id !=''  $wh $wh1 $rfd11 $ac group by c.id order by c.contact_person limit 1";

            echo  $sql;
			exit;*/


        $sql = "SELECT c.contact_person AS consultant, CONCAT(iumc.fname,' ',iumc.lname) AS cordinator2,nsk.ncount AS nashik_admission,sijoul.SCOUNT AS sijoul_admission,sf.count AS sf_admissions,um.um_id,am.academic_year
			FROM admission_benefits_and_source am
			JOIN user_master AS um ON am.benefit_to = um.um_id AND am.academic_year='$c1' 
			JOIN consultants_call_details AS c ON um.con_id = c.id 
			#join (select iu.um_id from ic_users iu where status='Y') as iu 
			#on c.inserted_by=iu.um_id
			JOIN user_master AS umc ON c.inserted_by=umc.um_id
			LEFT JOIN ((SELECT COUNT(a.id) AS NCOUNT,benefit_to,'SUN' AS campus FROM admission_benefits_and_source AS a JOIN sandipun_ums.student_master AS s ON a.student_id=s.stud_id WHERE a.belong_to_ic=4 
			AND a.academic_year='$c1'  AND is_for=1 AND s.cancelled_admission='N'  AND s.admission_session='$c' GROUP BY a.benefit_to)) AS nsk
			ON am.benefit_to=nsk.benefit_to
			LEFT JOIN ((SELECT  COUNT(a.id) AS SCOUNT,benefit_to,'SIJOUL' AS campus FROM admission_benefits_and_source AS a JOIN sandipun_ums_sijoul.student_master fs 
			ON a.student_id=fs.stud_id AND a.is_for=2 WHERE a.belong_to_ic=4 AND a.academic_year='$c1'
			AND is_for=2 AND fs.cancelled_admission='N'  AND fs.admission_session='$c' GROUP BY a.benefit_to)) AS sijoul
			ON am.benefit_to=sijoul.benefit_to

			LEFT JOIN
			(SELECT COUNT(a.id) AS COUNT,benefit_to,'SF' AS campus FROM admission_benefits_and_source AS a JOIN sf_admission_data AS s ON a.student_id=s.id AND
			a.is_for=3  WHERE a.belong_to_ic=4 AND a.academic_year='$c1'  AND is_for=3 
			AND s.is_cancelled=0 GROUP BY a.benefit_to)
			AS sf ON am.benefit_to=sf.benefit_to

			JOIN (SELECT fname,employee_code,lname FROM ic_user_master WHERE STATUS='Y') AS iumc ON umc.employee_code=iumc.employee_code

			WHERE c.id !='' $wh $wh1 $rfd11 $ac GROUP BY c.id order by cordinator2";

        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }
    /* codes by sid*/
    public function fetch_ic_users_forsijoul()
    {
        $um_id = $this->session->userdata('uid');
        $roles_id = $this->session->userdata('role_id');

        $this->db->select('um_id');
        $this->db->select('fname');
        $this->db->select('lname');
        $this->db->from('ic_users');
        $this->db->where('roles_id IN(4,8,7)');
        $this->db->where('ic_code', 'SU_BR_102');
        $this->db->where('status', 'Y');
        $this->db->where('fname IS NOT NULL');
        $query = $this->db->get();
        return $query->result_array();
    }
    public function get_eventcode_byumid($acad_year = '', $um_id = '')
    {
        $this->db->select('i.institute_name');
        $this->db->select('e.event_code');
        $this->db->from('institute_master as i');
        $this->db->join('event_details as e', 'i.institue_id=e.institue_id', 'left');
        $this->db->where('e.academic_year', $acad_year);
        $this->db->where('i.created_by', $um_id);
        $this->db->where('i.status', 'Y');
        $query = $this->db->get();
        //echo $this->db->last_query();exit;
        return $query->result_array();
    }
    public function fetch_leadsource()
    {
        $academic_year = ACADEMIC_YEAR;
        $this->db->select('utm_source');
        $this->db->from('student_meet_details');
        $this->db->where('utm_source !=', '');
        $this->db->where('academic_year', $academic_year);
        $this->db->where('event_code', 'EV/DG/1');
        $this->db->group_by('utm_source');
        $this->db->where('campus_id', '2');
        $query = $this->db->get();
        return $query->result_array();
    }

    public function fetch_sijoul_overall_data($val = '', $off = '')
    {
        $ud = '';
        $ld = '';
        $ev = '';
        $wdt = '';
        $ic = '';
        $result = '';
        $lim = '';
        $srch_val = '';
        $srch = '';
        $len = '';
        $academic_year = NEXTACADEMIC_YEAR;
        //$academic_year='2024-25';
        if ($val['start'] > 0) {
            $lim = "offset " . $val['start'] . "";
        }
        if ($val['length'] != '') {
            if ($val['length'] == -1) {
            } else {

                $len = "limit " . $val['length'] . "";
            }
        } else {
            $len = "limit 10 ";
        }

        if ($_POST['search']['value'] != '') {
            $srch_val = $_POST['search']['value'];
            $srch = "and s.student_name LIKE '" . $srch_val . "%'";
        }
        if ($val['acd_year'] != '') {
            $academic_year = $val['acd_year'];
        }

        if ($val['duration'] == 'day') {
            if (isset($val['search_dt']) && $val['search_dt'] != '') {
                $wdt = "AND date(s.created_date)='" . date('Y-m-d', strtotime($val['search_dt'])) . "'";
            }
        } elseif ($val['duration'] == 'durationn') {
            $yday = date('Y-m-d', strtotime($val['durationFrom']));
            $tdays = date('Y-m-d', strtotime($val['durationTo']));
            $wdt = 'and date(s.created_date) BETWEEN "' . $yday . '" AND "' . $tdays . '" ';
        }

        if ($val['ic_code'] != '') {
            if ($val['ic_code'] == 'digital') {
                $ic = "and s.campus_id='2' and s.ic_code='digital'";

                if ($val['lead_src'] != '') {
                    $ld = "and s.utm_source='" . $val['lead_src'] . "'";
                }
            } else {
                $ic = "and s.ic_code='SU_BR_102'";

                if ($val['um_id'] != '') {
                    $ud = " and ((s.created_by='" . $val['um_id'] . "' and e.created_by='" . $val['um_id'] . "') or   e.created_by='" . $val['um_id'] . "'  or (s.created_by='" . $val['um_id'] . "' and s.event_code=''))";
                }
                if ($val['sevent'] != '') {
                    $ev = " and s.event_code='" . $val['sevent'] . "'";
                }
            }
            $sql = "SELECT s.id,s.student_name,s.mobile1,s.latest_calling_status,s.created_by,s.ic_code,i.institute_name,ir.ic_name,s.mobile1_valid,s.utm_source,s.utm_campaign,s.utm_medium,CONCAT(iu.fname,' ',iu.lname) as added_by,s.created_date FROM student_meet_details s 
			 left join event_details e on e.event_code = s.event_code 
			 left join ic_users as iu on s.created_by = iu.um_id 
			 left join ic_registration ir on s.ic_code=ir.ic_code           
			 left join institute_master i on i.institue_id = e.institue_id WHERE   s.academic_year='" . $academic_year . "' $ic $ld $ud $ev $wdt $srch ";
            $sql .= "  group by s.id ORDER BY s.id DESC";
            if ($off == '') {
                $sql .= " $len $lim";
            }
            //echo $sql;exit;
            $query = $this->db->query($sql);
            //$result = $query->result_array();		
            //return $result;				 
        } else {
            $sql = " select * from ((SELECT s.id,s.student_name,s.mobile1,s.latest_calling_status,s.created_by,s.ic_code, '' as institute_name,'' as ic_name,s.mobile1_valid,s.utm_source,s.utm_campaign,s.utm_medium,CONCAT(iu.fname,' ',iu.lname) as added_by,s.created_date FROM student_meet_details s 
			 
			 left join ic_users as iu on s.created_by = iu.um_id 
			          
			 WHERE  s.academic_year='" . $academic_year . "' and s.campus_id='2' and s.ic_code='digital' $wdt $srch )
			 Union
			 (SELECT s.id,s.student_name,s.mobile1,s.latest_calling_status,s.created_by,s.ic_code,i.institute_name,ir.ic_name,s.mobile1_valid,s.utm_source,s.utm_campaign,s.utm_medium,CONCAT(iu.fname,' ',iu.lname) as added_by,s.created_date FROM student_meet_details s 
			 left join event_details e on e.event_code = s.event_code 
			 left join ic_users as iu on s.created_by = iu.um_id 
			 left join ic_registration ir on s.ic_code=ir.ic_code           
			 left join institute_master i on i.institue_id = e.institue_id WHERE  s.academic_year='" . $academic_year . "' and 
			 (s.ic_code='SU_BR_102' or s.campus_id=2) $wdt $srch ) ) s";
            $sql .= " group by s.id  ORDER BY  s.id DESC ";
            if ($off == '') {
                $sql .= " $len $lim";
            }


            $query = $this->db->query($sql);
            //echo $this->db->last_query();exit;
            //$result = $query->result_array();		
            //return $result;			 
        }
        if ($off == 1) {
            $result = $this->db->query($sql)->num_rows();
        } else {
            $result = $query->result_array();
        }
        return $result;
    }


    public function fetch_ic_users()
    {
        $um_id = $this->session->userdata('uid');
        $roles_id = $this->session->userdata('role_id');
        $ic_code = $this->session->userdata('ic_code');
        $this->db->select('um_id');
        $this->db->select('fname');
        $this->db->select('lname');
        $this->db->from('ic_users');
        $this->db->where('roles_id IN(4,8,7)');
        if ($roles_id != 1) {

            if ($roles_id == 7) {
                $this->db->where('ic_code', $ic_code);
            } else {
                $this->db->where('um_id', $um_id);
            }
        }
        $this->db->where('status', 'Y');
        $this->db->where('fname IS NOT NULL');
        $query = $this->db->get();
        return $query->result_array();
    }

    public function fetch_updated_marks_det($acad_year = '', $um_id = '', $event_code = '')
    {

        $ic_um = '';
        $ev = '';

        if ($um_id != '') {
            $ic_um = "and e.created_by=$um_id";
        }
        if ($event_code != '') {
            $ev = " and s.event_code='" . $event_code . "'";
        }

        $academic_year = NEXTACADEMIC_YEAR;

        if ($acad_year != '') {
            $academic_year = $acad_year;
        }

        $sql = "SELECT bd.obt_marks,bd.tot_marks,bd.academic_year, s.id,s.cast_category,s.event_code,s.created_by,s.ic_code,s.student_name,s.mobile1,s.whatsappno,s.email,s.state_name,s.city_name,s.standard,s.stream,s.sujee_interested,s.jee_interested,s.mock_interested,i.institute_name,sm.standard_name,st.stream_name,ir.ic_name,s.mobile1_valid,CONCAT(iu.fname,' ',iu.lname) as added_by FROM bd_marks_updation bd  join student_meet_details s on bd.student_id=s.id
		 left join event_details e on e.event_code = s.event_code 
		 left join ic_users as iu on s.created_by = iu.um_id 
         left join standard_master sm on s.standard=sm.standard_id
         LEFT JOIN stream_master st ON s.stream=st.stream_id
         left join ic_registration ir on s.ic_code=ir.ic_code           
         left join institute_master i on i.institue_id = e.institue_id  WHERE bd.academic_year='" . $academic_year . "'  $ev $ic_um";
        $query = $this->db->query($sql);
        $result = $query->result_array();
        //echo $this->db->last_query();exit;
        return $result;
    }


    /* codee by sid*/



    /* code by vrs*/

    public function get_all_performance_report($data, $cid = "")
    {

        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");

        $gtv = "";
        if ($uid == 1741) {
            $gtv = " and c.is_verified=1";
        }
        $rfd11 = '';
        $rfd1 = '';
        $wh1 = "";
        if (!empty($data['consultant']) && $data['consultant'] != ''  && $data['consultant'] != undefined) {
            $rfd11 = ' and um.um_id = "' . $data['consultant'] . '"';
        }
        $c = "";
        $c1 = "";
        if (!empty($data['academic_year']) && $data['academic_year'] != ''  && $data['academic_year'] != undefined) {
            $rfd = '';
            $c1 = $c = $data['academic_year'];
        } else {
            $cyear = $this->config->item('current_year');
            $rfd = '';
            $c1 = $c = $cyear;
        }

        $c = explode('-', $c);
        $c = $c[0];
        $is_fou = ' and (c.is_fou =0 OR c.is_fou IS NULL )';
        if (!empty($data['is_fou']) && $data['is_fou'] == 1) {
            $is_fou = ' and c.is_fou =1';
        }
        $nc = explode('-', $c1);
        $ACYEAR = $nc[0];
        $ACYEAR2 = $nc[1];
        $ACYEAR = $ACYEAR - 1;
        $ACYEAR2 = $ACYEAR2 - 1;
        $pyear = $ACYEAR . "-" . $ACYEAR2;
        $ci = 'sandipun_ums.enquiry_student_master.academic_year="' . $c . '"';
        if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != undefined) {
            $wh1 = " and c.ic_code='" . $data['icfilter'] . "'";
        }
        $cii = '';
        $ac = '';
        if (!empty($data['ac']) && $data['ac'] != ''  && $data['ac'] != undefined) {

            $ac = ' and c.inserted_by = "' . $data['ac'] . '"';
        }
        $wh = '';

        if (!empty($data['consultant_head']) && $data['consultant_head'] != ''  && $data['consultant_head'] != undefined) {

            $ss = $this->db->query("select group_concat(ic_code) as ic_code
			from ic_mapping where consultant_head=" . $data['consultant_head'] . " and status='Y'")->row()->ic_code;
            $ss = explode(",", $ss);
            $ss = "'" . implode("', '", $ss) . "'";
            $referred_by = $this->db->query("select COALESCE (group_concat(cordinator_id),0) as cordinator_id
			from consultant_cordinator_mapping where consultant_id=" . $data['consultant_head'] . " and status='Y'")->row()->cordinator_id;
            $wh =  " and (c.ic_code IN ($ss) OR c.inserted_by='" . $data['consultant_head'] . "' OR c.inserted_by IN ($referred_by ) OR c.consultant_head=" . $data['consultant_head'] . " ) ";
        }
        //and c.is_verified=1
        $sql = "select 'CONSULTANT/FOU/COUNSELLING CENTER' as role,CONCAT(ium.fname,' ',ium.lname) as consultanthead,csm.contact_person as cordinator1,
			CONCAT(iumh.fname,' ',iumh.lname) as cordinator,
			ir.ic_name,
			c.contact_person,um.roles_id,ci.name as city_name,s.name as state_name,um.password,um.username,um.um_id,c.employee_code,
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
join sandipun_ums.student_master as s on a.student_id=s.stud_id			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and s.cancelled_admission='N' and s.admission_confirm='Y'),0) as nashik_admission,

COALESCE((select count(a.id) from  admission_benefits_and_source as a
join sandipun_ums.student_master as s on a.student_id=s.stud_id			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and s.cancelled_admission='N'),0) as nashik_admissionp,



			COALESCE((select count(a.id) from  admission_benefits_and_source as a 
			join sf_admission_data as s on a.student_id=s.id and a.is_for=3 and s.admission_status='Admission' and s.College='SRP'
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=3
			and s.isconfirmed=1 and s.is_cancelled=0
			
			),0) as sf_admissions,
			
			
			
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sf_admission_data as s on a.student_id=s.id and a.is_for=3 and s.admission_status='Admission' and s.College!='SRP'

			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=3  and s.isconfirmed=1 and s.is_cancelled=0),0) as sf_admissionn,
			
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sandipun_ums_sijoul.student_master as s on a.student_id=s.stud_id
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2
			and s.cancelled_admission='N' and s.admission_confirm='Y' ),0) as sijoul_admission,
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sandipun_ums_sijoul.student_master sm on a.student_id=sm.stud_id and a.is_for=2
			where a.belong_to_ic=4 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2   and sm.cancelled_admission='N'
			),0) as sijoul_admissionp
			
			from
			consultants_call_details as c  
			inner join user_master as um ON um.con_id = c.id 
			left join states as s on c.state_id = s.id
			left join cities as ci ON ci.id=c.city_id
			left join user_master as umo on c.consultant_head=umo.um_id
			left join ic_user_master  as ium on umo.employee_code=ium.employee_code
			left join user_master as umcby on c.inserted_by=umcby.um_id
			left join ic_user_master  as iumh on umcby.employee_code=iumh.employee_code
			
			left join consultants_call_details as csm on umcby.con_id=csm.id
			left join ic_registration as ir on um.ic_code=ir.ic_code
			left join admission_benefits_and_source as am on am.benefit_to=um.um_id and am.academic_year='$c1'
			where c.id !=''  $wh $wh1 $rfd11 $cii $ac $is_fou $gtv group by c.id order by c.contact_person";


        //echo  $sql;
        //exit;



        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }


    public function get_all_performance_report_department($data, $cid = "")
    {
        $role_id = $this->session->userdata("role_id");
        $uid = $this->session->userdata("uid");
        $rfd11 = '';
        $rfd1 = '';
        $wh1 = "";

        $c = "";
        $c1 = "";
        if (!empty($data['academic_year']) && $data['academic_year'] != ''  && $data['academic_year'] != undefined) {
            $rfd = '';
            $c1 = $c = $data['academic_year'];
        } else {
            $cyear = $this->config->item('current_year');
            $rfd = '';
            $c1 = $c = $cyear;
        }

        $c = explode('-', $c);
        $c = $c[0];

        if (!empty($data['icfilter']) && $data['icfilter'] != '' && $data['icfilter'] != undefined) {
            $wh1 = " and c.ic_code='" . $data['icfilter'] . "'";
        }
        $cii = '';
        $ac = '';
        if (!empty($data['ac']) && $data['ac'] != ''  && $data['ac'] != undefined) {

            $ac = ' and c.inserted_by = "' . $data['ac'] . '"';
        }
        $wh = '';
        $ciii = '';
        if (!empty($data['type']) && $data['type'] != ''  && $data['type'] != undefined) {
            if ($data['type'] == 1) {
                $ciii = " and ir.center_type='ic'";
            } elseif ($data['type'] == 2) {
                $ciii = " and ir.center_type='cc'";
            }
        }


        $sql = "Select * from(select ir.ic_name,um.roles_id,rl.roles_type as role,CONCAT(c.fname,' ',c.lname) as contact_person,CONCAT(iuh.fname,' ',iuh.lname) as consultanthead,CONCAT(iuch.fname,' ',iuch.lname) as cordinator1,um.employee_code,
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sandipun_ums.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and sm.cancelled_admission='N' and sm.admission_confirm='Y' and is_second_benefit=0 and a.remark is NULL),0) as nashik_admission,
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sandipun_ums.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=1 and sm.cancelled_admission='N' and is_second_benefit=0 and a.remark  is NULL ),0) as nashik_admissionp,
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
            join sf_admission_data as sm on a.student_id=sm.id 

			where  a.academic_year='$c1' and sm.admission_session='$c' and a.benefit_to=um.um_id and is_for=3 and sm.admission_status='Admission' and sm.isconfirmed=1 and sm.College!='SRP' and is_second_benefit=0 and a.remark  is NULL ),0) as sf_admission,
			
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a 
			join sf_admission_data as s on a.student_id=s.id and a.is_for=3 and s.admission_status='Admission' 
			where a.belong_to_ic=1 and a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=3
			and s.isconfirmed=1 and s.is_cancelled=0 and is_second_benefit=0 and a.remark  is NULL and s.College='SRP'
			
			),0) as sf_admissions,
			
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
              join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2 and sm.cancelled_admission='N' and sm.admission_confirm='Y' and is_second_benefit=0 and a.remark  is NULL),0) as sijoul_admission,
			COALESCE((select count(a.id) from  admission_benefits_and_source as a
              join sandipun_ums_sijoul.student_master as sm on a.student_id=sm.stud_id 

			where  a.academic_year='$c1' and a.benefit_to=um.um_id and is_for=2 and sm.cancelled_admission='N'  and is_second_benefit=0 and a.remark  is NULL),0) as sijoul_admissionp
			
			from
			ic_user_master as c  
			inner join user_master as um ON um.employee_code = c.employee_code 
			join ic_registration as ir on um.ic_code=ir.ic_code
			join roles_master as rl on um.roles_id=rl.roles_id
			left join states as s on c.state = s.id
			left join cities as ci ON ci.id=c.city
			left join ic_mapping as im on um.ic_code=im.ic_code and im.status='Y'
			left join ic_users as iuh on im.consultant_head=iuh.um_id
			join user_master  as cum on um.ic_code=cum.ic_code and cum.status='Y' and cum.roles_id=7
			left join ic_users as iuch on cum.um_id=iuch.um_id
			
			
			join admission_benefits_and_source as am on am.benefit_to=um.um_id and am.academic_year='$c1'
			where c.user_id !='' $wh $wh1 $rfd11 $cii $ac  $ciii  
              and ir.ic_code !='SU_MH_01'
			group by c.user_id
			) as details  order by details.contact_person
			
			
			";
        //echo $sql;
        //exit;

        $query  = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }

    function get_affialiates()
    {
        $sql = "select * from affiliates_sources where is_active='Y' ";
        $query  = $this->db->query($sql);
        $result = $query->result_array();
        //echo $this->db->last_query();exit;
        return $result;
    }

    function get_admission_campus_all($ac = '', $campus = '', $admission_status = '')
    {
        if (empty($ac)) {
            $ac = ACADEMIC_YEAR;
        }
        $cam = '';
        if (!empty($campus)) {
            //$campus=campus;

            $cam = " and Campus='$campus'";
        }

        $as = '';
        if (!empty($admission_status)) {
            //$campus=campus;

            $as = " and admission_status='$admission_status'";
        }
        return $campus = $this->db->query("SELECT Campus FROM consolidated_admission_details	where academic_year='$ac' $cam $as GROUP BY Campus")->result();
    }

    function get_admission_rolewise($ac = '', $campus = '')
    {
        if (empty($ac)) {
            $ac = ACADEMIC_YEAR;
        }
        $cam = '';
        if (!empty($campus)) {
            //$campus=campus;

            $cam = " and Campus='$campus'";
        }
        return $this->db->query("SELECT 
    Role,
    SUM(CASE WHEN campus = 'SUN' THEN 1 ELSE 0 END) AS 'NASHIK',
    SUM(CASE WHEN campus = 'SIJOUL' THEN 1 ELSE 0 END) AS 'SIJOUL',
     SUM(CASE WHEN campus = 'SF-SIJ' THEN 1 ELSE 0 END) AS 'SF_SIJ',
    SUM(CASE WHEN campus = 'SF-NSK' THEN 1 ELSE 0 END) AS 'SF_NSK',
	
	
	SUM(CASE WHEN campus = 'SUN' THEN Remuneration ELSE 0 END) AS 'NASHIK_AMOUNT',
    SUM(CASE WHEN campus = 'SIJOUL' THEN Remuneration ELSE 0 END) AS 'SIJOUL_AMOUNT',
    SUM(CASE WHEN campus = 'SF-SIJ' THEN Remuneration ELSE 0 END) AS 'SF_SIJ_AMOUNT',
    SUM(CASE WHEN campus = 'SF-NSK' THEN Remuneration ELSE 0 END) AS 'SF_NSK_AMOUNT'
   
FROM 
    consolidated_admission_details WHERE academic_year='$ac'  $cam
GROUP BY 
    Role ORDER BY Role ASC")->result();
    }





    function get_admission_roles_all($ac = '', $admission_status = '')
    {
        if (empty($ac)) {
            $ac = ACADEMIC_YEAR;
        }

        $as = '';
        if (!empty($admission_status)) {
            //$campus=campus;

            $as = " and admission_status='$admission_status'";
        }
        return $role = $this->db->query("SELECT Role FROM consolidated_admission_details	where academic_year='$ac' $as GROUP BY Role")->result();
    }

    function get_admission_cnt($ac = '', $camp = '', $role = '', $admission_status = '')
    {
        if (empty($ac)) {
            $ac = ACADEMIC_YEAR;
        }
        $w = '';
        if (!empty($camp)) {
            $w .= ' and Campus="' . $camp . '"';
        }
        if (!empty($role)) {
            $w .= ' and Role="' . $role . '"';
        }

        $as = '';
        if (!empty($admission_status)) {
            //$campus=campus;

            $as = " and admission_status='$admission_status'";
        }
        $sql = "SELECT COALESCE(count(id),0) as cnt FROM consolidated_admission_details	where academic_year='$ac' $as
		$w
		
		";

        return $cnt = $this->db->query($sql)->row()->cnt;
    }


    function get_admission_cnt_sijoul($ac = '', $camp = '', $role = '', $admission_status = '')
    {
        if (empty($ac)) {
            $ac = ACADEMIC_YEAR;
        }
        $w = '';
        if (!empty($camp)) {
            $w .= ' and Campus="' . $camp . '"';
        }
        if (!empty($role)) {
            $w .= ' and Role="' . $role . '"';
        }

        $as = '';
        if (!empty($admission_status)) {
            //$campus=campus;

            $as = " and admission_status='$admission_status'";
        }
        $sql = "SELECT COALESCE(count(id),0) as cnt FROM consolidated_admission_details	where academic_year='$ac' $as
		$w and exam_status='Y'
		
		";

        return $cnt = $this->db->query($sql)->row()->cnt;
    }

    function get_admission_renum_sijoul($ac = '', $camp = '', $role = '', $admission_status = '')
    {
        if (empty($ac)) {
            $ac = ACADEMIC_YEAR;
        }
        $w = '';
        if (!empty($camp)) {
            $w .= ' and Campus="' . $camp . '"';
        }
        if (!empty($role)) {
            $w .= ' and Role="' . $role . '"';
        }
        $as = '';
        if (!empty($admission_status)) {
            //$campus=campus;

            $as = " and admission_status='$admission_status'";
        }
        return $cnt = $this->db->query("SELECT COALESCE(sum(Remuneration),0) as Remuneration FROM consolidated_admission_details	where academic_year='$ac' $as
		$w and exam_status='Y'
		
		")->row()->Remuneration;
    }

    function get_admission_renum($ac = '', $camp = '', $role = '', $admission_status = '')
    {
        if (empty($ac)) {
            $ac = ACADEMIC_YEAR;
        }
        $w = '';
        if (!empty($camp)) {
            $w .= ' and Campus="' . $camp . '"';
        }
        if (!empty($role)) {
            $w .= ' and Role="' . $role . '"';
        }
        $as = '';
        if (!empty($admission_status)) {
            //$campus=campus;

            $as = " and admission_status='$admission_status'";
        }
        return $cnt = $this->db->query("SELECT COALESCE(sum(Remuneration),0) as Remuneration FROM consolidated_admission_details	where academic_year='$ac' $as
		$w 
		
		")->row()->Remuneration;
    }


    function get_count_of_data($ac = '', $role = '', $campus = '', $admission_status = '')
    {
        if (empty($ac)) {
            $ac = ACADEMIC_YEAR;
        }
        $w = '';

        if (!empty($role)) {
            $w .= ' and Role="' . $role . '"';
        }

        if (!empty($campus)) {
            $w .= ' and c.Campus="' . $campus . '"';
        }
        $as = '';
        if (!empty($admission_status)) {
            //$campus=campus;

            $as = " and admission_status='$admission_status'";
        }

        $sql = "SELECT COALESCE(SUM(Remuneration),0) AS Remuneration,COUNT(c.id) as cnt,Admission_Given_By,Role,iu.ic_name,c.tpcolumn as iname ,
		crm.acno,crm.ifsc,crm.branch as branchname,payroll,account_no,ifsc_code,payroll_code,um.username,cp.payment_done,um.bankname,um.branch,um.employee_code,bkname,um.staff_id,
		CASE
    WHEN crm.acno !='' THEN crm.acno
    ELSE um.account_no
END as useraccount,
CASE
    WHEN crm.ifsc !='' THEN crm.ifsc
    ELSE um.ifsc_code
END as userifsc_code,
	CASE
    WHEN crm.acname !='' THEN crm.acname
    ELSE um.account_name
END as acname,	

CASE
    WHEN crm.pancard !='' THEN crm.pancard
    ELSE um.pancard_no
END as pnd,COALESCE(SUM(CASE WHEN Applicable_fees IS NULL OR Applicable_fees = '' THEN 0 ELSE Applicable_fees END), 0) AS Applicable_fees,
    COALESCE(SUM(CASE 
        WHEN Paid_Fees IS NULL OR Paid_Fees = '' THEN 0 
        ELSE CASE WHEN Paid_Fees > Applicable_fees THEN Applicable_fees ELSE Paid_Fees END 
    END), 0) AS Paid_Fees,
    COALESCE(SUM(
        CASE 
            -- If PRN is blank and campus is SF-NSK or SF-SIJ, and both fees are 0/null, set Remuneration to 0
            WHEN (c.PRN IS NULL OR c.PRN = '') 
                AND (c.campus IN ('SF-NSK', 'SF-SIJ')) 
                AND (COALESCE(Applicable_fees, 0) = 0) 
                AND (COALESCE(Paid_Fees, 0) = 0) 
            THEN 0

            -- Otherwise, apply the normal proportionate calculation
            WHEN COALESCE(Applicable_fees, 0) > 0 
            THEN LEAST(
                (COALESCE(
                    CASE 
                        WHEN Paid_Fees > Applicable_fees THEN Applicable_fees 
                        ELSE Paid_Fees 
                    END, 0) 
                / COALESCE(Applicable_fees, 1)), 1) * COALESCE(Remuneration, 0)

            ELSE COALESCE(Remuneration, 0) 
        END), 0) AS Proportionate_Remuneration
		
		
		FROM consolidated_admission_details c
		LEFT JOIN user_master AS um ON 
		
		
		
		
		c.benefit_to=um.um_id
		
		
		

		LEFT JOIN ic_registration AS iu ON um.ic_code=iu.ic_code
		left join consultants_call_details as crm on um.con_id=crm.id
		left join (SELECT SUM(amount+tds) AS payment_done,consultant_id FROM `consultant_payment_details`
WHERE academic_year='$ac'
GROUP BY consultant_id) cp on um.um_id=cp.consultant_id
		
		WHERE c.academic_year='$ac'
		AND Role='$role' $w $as

		GROUP BY benefit_to order by Remuneration desc


		";
        //echo $sql;
        //exit;
        return $cnt = $this->db->query($sql)->result();
    }



    function get_count_of_data_sijoul($ac = '', $role = '', $campus = '', $admission_status = '')
    {
        if (empty($ac)) {
            $ac = ACADEMIC_YEAR;
        }
        $w = '';

        if (!empty($role)) {
            $w .= ' and Role="' . $role . '"';
        }

        if (!empty($campus)) {
            $w .= ' and c.Campus="' . $campus . '"';
        }
        $as = '';
        if (!empty($admission_status)) {
            //$campus=campus;

            $as = " and admission_status='$admission_status'";
        }

        $sql = "SELECT COALESCE(SUM(Remuneration),0) AS Remuneration,COUNT(c.id) as cnt,Admission_Given_By,Role,iu.ic_name,c.tpcolumn as iname ,
		crm.acno,crm.ifsc,crm.branch as branchname,payroll,account_no,ifsc_code,payroll_code,um.username,cp.payment_done,um.bankname,um.branch,um.employee_code,bkname,um.staff_id,
		CASE
    WHEN crm.acno !='' THEN crm.acno
    ELSE um.account_no
END as useraccount,
CASE
    WHEN crm.ifsc !='' THEN crm.ifsc
    ELSE um.ifsc_code
END as userifsc_code,
	CASE
    WHEN crm.acname !='' THEN crm.acname
    ELSE um.account_name
END as acname,	

CASE
    WHEN crm.pancard !='' THEN crm.pancard
    ELSE um.pancard_no
END as pnd,COALESCE(SUM(CASE WHEN Applicable_fees IS NULL OR Applicable_fees = '' THEN 0 ELSE Applicable_fees END), 0) AS Applicable_fees,
    COALESCE(SUM(CASE 
        WHEN Paid_Fees IS NULL OR Paid_Fees = '' THEN 0 
        ELSE CASE WHEN Paid_Fees > Applicable_fees THEN Applicable_fees ELSE Paid_Fees END 
    END), 0) AS Paid_Fees,
    COALESCE(SUM(
        CASE 
            -- If PRN is blank and campus is SF-NSK or SF-SIJ, and both fees are 0/null, set Remuneration to 0
            WHEN (c.PRN IS NULL OR c.PRN = '') 
                AND (c.campus IN ('SF-NSK', 'SF-SIJ')) 
                AND (COALESCE(Applicable_fees, 0) = 0) 
                AND (COALESCE(Paid_Fees, 0) = 0) 
            THEN 0

            -- Otherwise, apply the normal proportionate calculation
            WHEN COALESCE(Applicable_fees, 0) > 0 
            THEN LEAST(
                (COALESCE(
                    CASE 
                        WHEN Paid_Fees > Applicable_fees THEN Applicable_fees 
                        ELSE Paid_Fees 
                    END, 0) 
                / COALESCE(Applicable_fees, 1)), 1) * COALESCE(Remuneration, 0)

            ELSE COALESCE(Remuneration, 0) 
        END), 0) AS Proportionate_Remuneration
		
		
		FROM consolidated_admission_details c
		LEFT JOIN user_master AS um ON 
		
		
		
		
		c.benefit_to=um.um_id
		
		
		

		LEFT JOIN ic_registration AS iu ON um.ic_code=iu.ic_code
		left join consultants_call_details as crm on um.con_id=crm.id
		left join (SELECT SUM(amount+tds) AS payment_done,consultant_id FROM `consultant_payment_details`
WHERE academic_year='$ac'
GROUP BY consultant_id) cp on um.um_id=cp.consultant_id
		
		WHERE c.academic_year='$ac' and c.exam_status='Y'
		AND Role='$role' $w $as

		GROUP BY benefit_to order by Remuneration desc


		";
        //echo $sql;
        //exit;
        return $cnt = $this->db->query($sql)->result();
    }


    function get_admission_roles_id($ac = '')
    {
        if (empty($ac)) {
            $ac = ACADEMIC_YEAR;
        }
        return $role = $this->db->query("SELECT Role FROM consolidated_admission_details	where academic_year='$ac'  and Role  NOT in ('online','offline') GROUP BY Role")->result();
    }



    function get_payments_done($ac = '', $role = '')
    {


        $c = '';
        if (empty($ac)) {
            $ac = ACADEMIC_YEAR;
        }


        if (!empty($role)) {

            if ($role == 'offline' || $role == 'online') {
                return 0;
            } else {
                $lg = "";
                $w1 = '';
                if ($role == 'BDE/BDM' || $role == 'BDM/BDE') {
                    $w = " and cs.Role IN ('BDE/BDM') ";
                } else if ($role == 'CC') {
                    $w = " and cs.Role IN ('CC')";
                } else if ($role == 'CC Head') {
                    $w = " and cs.Role IN ('CC Head')";
                    //$w=" and um.roles_id IN (15)";
                } else if ($role == 'Consultant') {
                    $w = " and cs.Role IN ('Consultant')";
                    //$w1=" and um.roles_id IN (17) and (cd.is_fou =0 or cd.is_fou IS NULL) and um.um_id NOT IN (select um_id from affiliates_sources ) ";
                    $lg = " join consultants_call_details as cd on um.con_id=cd.id ";
                } else if ($role == 'Counselling Center') {
                    //$w1=$w=" and um.roles_id IN (17) and (cd.is_fou =2) and um.um_id NOT IN (select um_id from affiliates_sources ) ";

                    $w = " and cs.Role IN ('Counselling Center')";
                    $lg = " join consultants_call_details as cd on um.con_id=cd.id ";
                } else if ($role == 'FOU') {
                    //$w1=$w=" and um.roles_id IN (17) and (cd.is_fou =1)  and um.um_id NOT IN (select um_id from affiliates_sources ) ";
                    $w = " and cs.Role IN ('FOU')";
                    $lg = " join consultants_call_details as cd on um.con_id=cd.id ";
                } else if ($role == 'IC HEAD') {
                    //$w1=$w=" and um.roles_id IN (7) ";
                    $w = " and cs.Role IN ('IC HEAD')";
                } else if ($role == 'Publishers') {
                    //$w1=$w=" and um.um_id IN (select um_id from affiliates_sources ) ";
                    $w = " and cs.Role IN ('Publishers')";
                    $c = " UNION
SELECT consultant_id,amount*-1,0 AS tds,'$ac' as academic_year FROM previous_year_pending";
                } else if ($role == 'STAFF') {
                    $w = " and cs.Role IN ('STAFF')";
                    //$w=" and um.roles_id IN (33) ";

                }

                $sql = "SELECT COALESCE(sum(amount+tds),0) as total_paid FROM 
		 
		 
		 (SELECT consultant_id,amount,tds,academic_year FROM consultant_payment_details  
)
		 
		  c
		 
         join user_master as um on c.consultant_id=um.um_id
		 
          $lg    
		where c.academic_year='$ac'  and um.um_id in (SELECT benefit_to FROM(
SELECT benefit_to FROM consolidated_admission_details cs
                  


		WHERE cs.academic_year='$ac' $w
		
				
		
		)
		s
		GROUP BY benefit_to) 
		";

                if ($role == 'Publishers') {
                    //echo $sql;
                    //exit;
                }

                return $cnt = $this->db->query($sql)->row()->total_paid;
            }
        }
    }


    function all_list()
    {
        return $this->db->query("select um.um_id,CONCAT('CONS-',contact_person) as contact_person,um.employee_code,um.roles_id from consultants_call_details cs join user_master as um on cs.id=um.con_id where um.status='Y'
		 UNION
		select um.um_id,CONCAT('STAFF-',fname,' ',lname) as contact_person,um.employee_code,um.roles_id from ic_user_master cs join user_master as um on cs.employee_code=um.employee_code where um.status='Y'
		UNION
		select um.um_id,CONCAT('STAFF-',staff_name) as contact_person,um.employee_code,um.roles_id from inhouse_staff_details cs join user_master as um on cs.staff_id=um.username where um.status='Y'
		
		
		")->result_array();
    }

    public function consultant_renum_details($conid = '')
    {
        $this->db->select('u.employee_code');
        $this->db->select('c.contact_person');
        $this->db->select('c.address');
        $this->db->from('user_master u');
        $this->db->join('consultants_call_details c', 'u.con_id=c.id', 'left');
        $this->db->where('u.con_id', $conid);
        $query = $this->db->get();
        return $query->result_array();
    }


    function get_inbound_listd($uid)
    {


        $cond = "and sd.created_by='" . $uid . "'";
        $ac = ACADEMIC_YEAR;
        $sql = "SELECT sd.lead_type,vw.stream_name,vw.school_short_name,sd.id,sd.student_name,sd.mobile1,sd.email,sd.standard,sm.standard_name,
		latest_calling_status as calling_status,sd.enquiry_by,sd.created_date,sd.walkin_remark FROM student_meet_details as sd 
		LEFT JOIN standard_master sm ON sd.standard=sm.standard_id
		left join su_sf_sijoul_stream_details as vw on sd.programme_id=vw.stream_id and sd.campus_id=vw.belongtocampus    
		where sd.id!='' $cond and sd.academic_year='$ac' group by sd.id order by sd.created_date DESC ";

        $query = $this->db->query($sql);
        return $query->result_array();
    }


    function get_count_of_data_yoy($ac = '', $role = '', $pyear = '')
    {
        if (empty($ac)) {
            $ac = ACADEMIC_YEAR;
        }
        $w = '';

        if (!empty($role)) {
            $w .= ' and Role="' . $role . '"';
        }

        if (!empty($campus)) {
            $w .= ' and c.Campus="' . $campus . '"';
        }
        $acf = explode('-', $ac);
        $acf = $acf[0];
        $pcf = explode('-', $pyear);
        $pcf = $pcf[0];

        $sql = "SELECT 
		    COALESCE(SUM(Remuneration),0) AS Remuneration,COUNT(c.id) as cnt,		   
			COALESCE(SUM(CASE WHEN c.academic_year = '$ac' THEN Remuneration ELSE 0 END), 0) AS Remunerationn,
			COALESCE(SUM(CASE WHEN c.academic_year = '$pyear' THEN Remuneration ELSE 0 END), 0) AS Remunerationp,
			COUNT(CASE WHEN c.academic_year = '$ac' THEN c.id END) AS cntn,
			COUNT(CASE WHEN c.academic_year = '$pyear' THEN c.id END) AS cntp,
		   
		   
		   
		   
		   Admission_Given_By,Role,iu.ic_name,c.tpcolumn as iname ,
		crm.acno,crm.ifsc,crm.branch as branchname,payroll,account_no,ifsc_code,payroll_code,um.username,cp.payment_done,um.bankname,um.branch,um.employee_code,crm.pancard as pnd,bkname,cpp.payment_done as ppayment_done,
		CASE
    WHEN crm.acno !='' THEN crm.acno
    ELSE um.account_no
END as useraccount,
CASE
    WHEN crm.ifsc !='' THEN crm.ifsc
    ELSE um.ifsc_code
END as userifsc_code,
	CASE
    WHEN crm.acname !='' THEN crm.acname
    ELSE um.account_name
END as acname	
		
		
		FROM consolidated_admission_details c
		LEFT JOIN user_master AS um ON 
		
		
		
		
		c.benefit_to=um.um_id
		
		
		

		LEFT JOIN ic_registration AS iu ON um.ic_code=iu.ic_code
		left join consultants_call_details as crm on um.con_id=crm.id
		left join (SELECT SUM(amount+tds) AS payment_done,consultant_id FROM `consultant_payment_details`
WHERE academic_year='$ac'
GROUP BY consultant_id) cp on um.um_id=cp.consultant_id
			left join (SELECT SUM(amount+tds) AS payment_done,consultant_id FROM `consultant_payment_details`
WHERE academic_year='$pyear'
GROUP BY consultant_id) cpp on um.um_id=cpp.consultant_id
		
		
		WHERE c.academic_year IN ('$ac','$pyear')
		AND Role='$role' $w

		GROUP BY benefit_to order by Remuneration desc


		";

        return $cnt = $this->db->query($sql)->result();
    }


    /* cend by vrs */


    function get_renum_admission_students_data($type, $academic_year_base, $um_id, $is_direct = '', $is_to_drcc_consider = '', $is_exam_appeared = '', $is_confirm_admisiion = '', $belong_to = '', $sf_segragation = '')
    {

        $userID = $this->session->userdata('uid');
        $con = '';
        $acdcon = '';
        $sf_sg = '';

        if (!empty($academic_year_base)) {
        } else {
            $academic_year_base = $this->config->item('current_year');
        }
        $current_year = explode('-', $academic_year_base);
        $acd = $current_year[0];
        $acdcon = " and a.academic_year='" . $academic_year_base . "'";

        if (!empty($type)) {
            $con = " and a.is_for='" . $type . "'";
        }
        $cac = '';
        if (!empty($is_confirm_admisiion) && $is_confirm_admisiion == 1) {
            $cac = " and s.admission_confirm='Y'";
        }



        //	$role_con=" and a.benefit_to='$um_id' ";
        $pi = 'Hostel_admission_new';
        if ($academic_year_base == ACADEMIC_YEAR || $academic_year_base == '2024-25') {
            $role_con = " and  a.benefit_to in (5229,478080,478081,478126,478138,478158,478177,478178,478198,478325,478334,478386,478447,478523,4015,4101,4856,5019,5025,5026,5028,478255,478256,478288,478290,478791,478807,478076) ";
        } else {
            $role_con = " and  a.benefit_to in (4015,5229,4856) ";
            $pi = 'Hostel_Pending_fees';
        }


        $and_condition = "";
        $fcondition = '';
        $eand_condition = "";
        $efcondition = '';
        $sql = " select s.* from  (select 
			
			s.stud_id,ad1.actual_fee,ad1.applicable_fee,fees_details.fees_paid,a.amount as renumeration_amount,
			'' as center,af.tution_fees,
			s.created_on,s.enrollment_no,s.enrollment_no_new,s.first_name as name,s.email,s.mobile,a.*,vm.course_short_name,vm.stream_name,vm.school_short_name,st.state_name,s.lateral_entry,s.admission_date,		
			dn.district_name,tm.taluka_name,'Nashik' as Campus,s.admission_confirm,opfh.payment_status as hstatus,opfhm.payment_status as ustatus,CASE WHEN vm.course_short_name='B.Sc' THEN 10000
WHEN vm.course_short_name='B.Tech' OR vm.course_short_name='BBAHONS' OR vm.course_short_name='LLBHONS'  THEN 25000

WHEN vm.course_short_name='BBA' THEN 10000
WHEN vm.course_short_name='BCA' THEN 15000
ELSE applicable_fee
END AS amounttocinsider,r.hostel_fees,r.uniform_fees,r.continue
			from admission_benefits_and_source a 
			join sandipun_ums.student_master as s on s.stud_id=a.student_id and a.is_for=1
					
			join sandipun_ums.vw_stream_details as vm on s.admission_stream=vm.stream_id
			left join 
			(select sum(fdt.amount) as fees_paid,fdt.student_id from sandipun_ums.fees_details
			as fdt
			where fdt.type_id=2 
			and fdt.chq_cancelled='N' and fdt.is_deleted='N' group by fdt.student_id) as
			fees_details on fees_details.student_id=s.stud_id
			join sandipun_ums.admission_details ad1 on s.stud_id=ad1.student_id and ad1.academic_year='$acd'
			left join  (SELECT * FROM sandipun_ums.academic_fees WHERE academic_year='$academic_year_base' ) as af on s.admission_stream=af.stream_id 
			and af.academic_year='$academic_year_base' AND  af.year =s.current_year
			 left join  (SELECT opfh.payment_status,opfh.student_id  FROM sandipun_erp.online_payment_facilities as opfh WHERE opfh.org_frm IN ('SU-NASHIK','SU') AND opfh.productinfo ='$pi' AND opfh.payment_status='success') as opfh on s.stud_id=opfh.student_id
 left join  (SELECT opfh.payment_status,opfh.student_id  FROM sandipun_erp.online_payment_facilities as opfh WHERE opfh.org_frm IN ('SU-NASHIK','SU') AND opfh.productinfo ='UNIFORM' AND opfh.payment_status='success') as opfhm on s.stud_id=opfhm.student_id
			
			left join  sandipun_ums.address_details as ad on s.stud_id=ad.student_id 
			left join  sandipun_ums.states as st on ad.state_id=st.state_id
			left join  sandipun_ums.district_name as dn on ad.district_id=dn.district_id
			left join  sandipun_ums.taluka_master as tm on ad.city=tm.taluka_id
			left join reddy r on a.academic_year=r.academic_year
			where a.id !='' and s.cancelled_admission='N' $cac  $acdcon $role_con  order by  a.remark ) 
			s  group by s.id order by s.enrollment_no";



        $query = $this->db->query($sql);
        $result = $query->result_array();

        $sql = str_replace("sandipun_ums.student_master", "sandipun_ums_sijoul.student_master", $sql);
        $sql = str_replace("sandipun_ums.vw_stream_details", "sandipun_ums_sijoul.vw_stream_details", $sql);
        $sql = str_replace("sandipun_ums.academic_fees", "sandipun_ums_sijoul.academic_fees", $sql);
        $sql = str_replace("sandipun_ums.address_details", "sandipun_ums_sijoul.address_details", $sql);
        $sql = str_replace("sandipun_ums.states", "sandipun_ums_sijoul.states", $sql);
        $sql = str_replace("sandipun_ums.district_name", "sandipun_ums_sijoul.district_name", $sql);
        $sql = str_replace("sandipun_ums.taluka_master", "sandipun_ums_sijoul.taluka_master", $sql);
        $sql = str_replace("csw.is_for=1", "csw.is_for=2", $sql);
        $sql = str_replace("a.is_for=1", "a.is_for=2", $sql);
        $sql = str_replace("sandipun_ums.fees_details", "sandipun_ums_sijoul.fees_details", $sql);
        $sql = str_replace("sandipun_ums.admission_details", "sandipun_ums_sijoul.admission_details", $sql);
        $sql = str_replace("Nashik", "Sijoul", $sql);
        $query = $this->db->query($sql);
        $result1 = $query->result_array();
        $sql = "select actual_fees as actual_fee,applicable_fees as applicable_fee,paid_fees as fees_paid,a.amount as renumeration_amount,csw.image,
			vc.called_by as callers,vc.icname as icname,'' as center,vc.name as callername,actual_fees as tution_fees,
			s.admission_date as created_on,s.enrollment_no,s.enrollment_no as enrollment_no_new,s.student_name as name,s.email_id as email,s.mobile,a.*,Course as course_short_name,Stream as stream_name,College as school_short_name,'--' as state_name,
			'--' as district_name,'--' as taluka_name,'SF' as Campus
			from admission_benefits_and_source a 
			join sf_admission_data as s on s.id=a.student_id and a.is_for=3 and s.admission_status='Admission' and s.is_cancelled=0
			left join consultant_wise_renumeration as csw on s.Stream=csw.streamname and csw.is_for=3 and csw.consultant_id=a.benefit_to
			left join view_call_logs as vc on vc.student_id=a.smd_id 		
			where a.id !='' $acdcon $con $role_con group by s.id order by s.enrollment_no ";
        $query = $this->db->query($sql);
        $result2 = $query->result_array();

        /*$DB1 = $this->load->database('erpdb', TRUE);

$sql = "SELECT * FROM online_payment_facilities WHERE org_frm='SU-NASHIK' AND productinfo ='Hostel_admission_new' AND payment_status='success' AND student_id IN (SELECT stud_id FROM sandipun_ums.student_master WHERE cancelled_admission='N'
            AND stud_id IN (SELECT student_id FROM sandipun_ic_erp22.admission_benefits_and_source WHERE is_for=1 AND academic_year='2024-25'
            AND benefit_to IN ('5229','478080','478081','478126','478138','478158','478177','478178','478198','478325','478334','478386','478447','478523','4015','4101','4856','5019','5025','5026','5028','478255','478256','478288','478290','478424','478791','478807','478076')))";
                        $query = $DB1->query($sql);                                                
                        $result3 = $query->result_array();
                        /////////for Uniform
                        $sql = "SELECT * FROM online_payment_facilities WHERE org_frm='SU' AND productinfo ='UNIFORM' AND payment_status='success' AND student_id IN (SELECT stud_id FROM sandipun_ums.student_master WHERE cancelled_admission='N' AND stud_id IN (SELECT student_id FROM sandipun_ic_erp22.admission_benefits_and_source WHERE is_for=1 AND academic_year='$academic_year_base'AND benefit_to IN ('5229','478080','478081','478126','478138','478158','478177','478178','478198','478325','478334','478386','478447','478523','4015','4101','4856','5019','5025','5026','5028','478255','478256','478288','478290','478424','478791','478807','478076')))";
                        $query = $DB1->query($sql);                                                
                        $result4 = $query->result_array();*/

        $result = array_merge($result, $result1, $result2);

        //$result = array_merge($result,$result1,$result2);		
        return $result;
    }



    function update_data_reddy($data)
    {
        $this->db->where('academic_year', $data['academic_year']);
        $this->db->update('reddy', $data);
    }

    function update_uploaded_fbdata($data = array())
    {
        $uid = $this->session->userdata('uid');
        $updata = array(
            'event_code' => $data['event_code'],
            'ic_code' => $data['ic_code'],
            'utm_campaign' => '',
            'utm_medium' => '',
            'utm_source' => '',
            'created_by' => $uid,
            'updated_by' => $uid,
            'updated_date' => date('Y-m-d H:i:s'),
        );
        $this->db->where('id', $data['stud_id']);
        $this->db->update('student_meet_details', $updata);
        $insert_id = $this->db->insert_id();
        return  $insert_id;
    }


    function fetch_sijoul_student_meetdetails($acad_year = '', $todate = '')
    {
        $userID = $this->session->userdata('uid');
        $role_id = $this->session->userdata('role_id');
        $td = '';
        if ($role_id == '1') {

            if ($var['icfilter'] != '') {
                $chekuser = " and s.ic_code='" . $var['icfilter'] . "' ";
            } else {
            }
        } elseif ($role_id == '4' || $role_id == '8' || $role_id == '7') {
            $ic_code = $this->session->userdata('ic_code');
            $chekuser = " and s.ic_code='$ic_code' ";
        } elseif ($role_id == 27) {
            $ic_code = $this->session->userdata('ic_code');
            $chekuser = " and s.ic_code IN (
		select ic_code
		from ic_mapping where consultant_head='$userID' and status='Y' 
		) ";
        } else {
            $chekuser = " and s.created_by = '$userID'";
        }
        if (!empty($todate)) {
            $todate = date('Y-m-d', strtotime($todate));
            $td = "And STR_TO_DATE(s.created_date,'%Y-%m-%d')<='$todate'";
        }
        $academic_year = NEXTACADEMIC_YEAR;

        if ($acad_year != '') {
            $academic_year = $acad_year;
        }

        $sql = "SELECT  s.id,s.cast_category,s.event_code,s.created_by,s.ic_code,s.student_name,s.mobile1,s.whatsappno, s.email,s.state_name,s.city_name,s.standard,s.stream,s.sujee_interested,s.jee_interested,s.mock_interested,i.institute_name,sm.standard_name,st.stream_name,ir.ic_name,s.mobile1_valid,CONCAT(iu.fname,' ',iu.lname) as added_by FROM student_meet_details s 
         LEFT JOIN event_details e on e.event_code = s.event_code 
		 LEFT JOIN ic_users as iu on s.created_by = iu.um_id 
         LEFT JOIN standard_master sm on s.standard=sm.standard_id
         LEFT JOIN stream_master st ON s.stream=st.stream_id
         LEFT JOIN ic_registration ir on s.ic_code=ir.ic_code           
         LEFT JOIN institute_master i on i.institue_id = e.institue_id 
		 WHERE s.academic_year='" . $academic_year . "' $chekuser $td";
        $sql .= "ORDER BY i.institute_name, s.id DESC ";
        $query = $this->db->query($sql);
        $result = $query->result_array();
        return $result;
    }


    function get_yearwise_admission_reconcilation_data()
    {
        $this->db->select('*');
        $this->db->from('reddy');
        $this->db->order_by('id', 'desc');
        $query = $this->db->get();
        return $query->result_array();
    }

    function get_payable_amount($academic_year = '')
    {
        return $this->db->query("SELECT COALESCE(SUM(amount),0) AS amount FROM (

SELECT COALESCE(SUM(a.amount),0) AS amount FROM sandipun_ums.student_master AS s JOIN admission_benefits_and_source AS a ON s.stud_id=a.student_id AND a.is_for=1 
AND s.`cancelled_admission`='N' AND a.benefit_to IN (SELECT um_id FROM user_master WHERE con_id IN (SELECT id FROM consultants_call_details WHERE (inserted_by =478076 OR co_reff_by=478076 OR id =4015  OR id=4015 OR id= 1265
 OR id=1703 OR id =2076))) AND a.academic_year='$academic_year' AND s.admission_confirm='Y'
 
 UNION ALL
 
 SELECT COALESCE(SUM(a.amount),0) AS amount FROM sandipun_ums_sijoul.student_master AS s JOIN admission_benefits_and_source AS a ON s.stud_id=a.student_id AND a.is_for=2 
AND s.`cancelled_admission`='N' AND a.benefit_to IN (SELECT um_id FROM user_master WHERE con_id IN (SELECT id FROM consultants_call_details WHERE (inserted_by =478076 OR co_reff_by=478076 OR id =4015  OR id=4015 OR id= 1265
 OR id=1703 OR id =2076))) AND a.academic_year='$academic_year' AND s.admission_confirm='Y'
 
 UNION ALL
 
  SELECT COALESCE(SUM(a.amount),0) AS amount FROM sf_admission_data AS s JOIN admission_benefits_and_source AS a ON s.id=a.student_id AND a.is_for=3
AND s.`admission_status`='Admission' AND a.benefit_to IN (SELECT um_id FROM user_master WHERE con_id IN (SELECT id FROM consultants_call_details WHERE (inserted_by =478076 OR co_reff_by=478076 OR id =4015  OR id=4015 OR id= 1265
 OR id=1703 OR id =2076))) AND a.academic_year='$academic_year' ) s
 ")->row()->amount;
    }


    function get_paid_amount($academic_year = '')
    {
        return $this->db->query("SELECT COALESCE(SUM(amount+tds),0) as amount FROM consultant_payment_details WHERE consultant_id IN (SELECT um_id FROM user_master WHERE con_id IN (SELECT id FROM consultants_call_details WHERE (inserted_by =478076 OR co_reff_by=478076 OR id =4015  OR id=4015 OR id= 1265
 OR id=1703 OR id =2076))) AND academic_year='$academic_year'")->row()->amount;
    }




    public function phd_listing()
    {
        $DB1 = $this->load->database('pc', TRUE);

        //$cp =explode('_',$username);
        //$campus=ucwords($cp[1]);
        //$adm_batch=PHD_ADMISSION_BATCH; SUM, JAN25
        $DB1->select("psd.*,op.amount,verification_status,payment_id,op.payment_status");
        $DB1->from('phd_student_details psd');
        $DB1->join('online_payment op', 'op.registration_no = psd.phd_id', 'left');
        $DB1->where("psd.admission_batch", 'JAN-25');
        $DB1->where("psd.fees_paid", 'Y');
        $DB1->where("campus", 'SUM');
        $DB1->group_by("psd.phd_id");
        $DB1->order_by("psd.phd_id", "desc");

        $query = $DB1->get();
        $result = $query->result_array();
        return $result;
    }
}
